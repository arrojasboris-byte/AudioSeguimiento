<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control Center Audio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg-main: radial-gradient(circle at top left, #111827, #020617 55%);
      --bg-card: #020617;
      --bg-card-soft: #0b1120;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --accent-red: #ff2440;
      --accent-blue: #38bdf8;
      --accent-green: #22c55e;
      --accent-orange: #f97316;
      --chip-pendiente: #facc15;
      --chip-enproceso: #4ade80;
      --chip-finalizada: #22c55e;
    }

    body.light {
      --bg-main: #f3f4f6;
      --bg-card: #ffffff;
      --bg-card-soft: #f9fafb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
    html, body { width: 100%; min-height: 100vh; overflow-x: hidden; }
    body { background: var(--bg-main); color: var(--text-main); display: flex; overflow-x: hidden; }

    /* SIDEBAR */
    .sidebar { width: 250px; background: #020617; border-right: 1px solid #020617; padding: 18px 18px 24px; display: flex; flex-direction: column; gap: 24px; color: #e5e7eb; flex-shrink: 0; }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-badge { width: 34px; height: 34px; border-radius: 999px; background: radial-gradient(circle at 30% 20%, #fee2e2, var(--accent-red)); }
    .logo-text { display: flex; flex-direction: column; }
    .logo-title { font-weight: 700; font-size: 1.05rem; }
    .logo-subtitle { font-size: .7rem; color: #9ca3af; }
    .section-title { font-size: .75rem; text-transform: uppercase; color: #6b7280; letter-spacing: .12em; margin-bottom: 8px; }
    .nav-list { display: flex; flex-direction: column; gap: 4px; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 999px; font-size: .88rem; color: #9ca3af; cursor: pointer; transition: all .18s ease; }
    .nav-item span.icon { width: 22px; height: 22px; border-radius: 999px; background: #020617; display: inline-flex; align-items: center; justify-content: center; font-size: .75rem; }
    .nav-item.active { background: linear-gradient(90deg, #ff2440, #fb7185); color: #111827; font-weight: 600; }
    .nav-item.active span.icon { background: rgba(15,23,42,.2); }
    .nav-item:hover:not(.active) { background: rgba(31,41,55,0.7); color: #e5e7eb; }
    body.light .nav-item:hover:not(.active) { background: rgba(15,23,42,0.2); }
    .sidebar-footer { margin-top: auto; font-size: .78rem; color: #9ca3af; }

    /* MAIN LAYOUT */
    .main { flex: 1; padding: 10px 18px 12px; display: flex; flex-direction: column; gap: 8px; max-width: 1600px; margin: 0 auto; box-sizing: border-box; }
    .topbar { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; flex-wrap: wrap; }
    .topbar-search { flex: 1 1 260px; position: relative; min-width: 220px; }
    .topbar-search input { width: 100%; border-radius: 999px; padding: 8px 14px 8px 30px; border: 1px solid var(--border-soft); background: var(--bg-card); color: var(--text-main); font-size: .86rem; outline: none; }
    .topbar-search span { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: .8rem; color: var(--text-muted); }
    .topbar-buttons { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
    .btn { border-radius: 999px; padding: 6px 12px; border: 1px solid var(--border-soft); font-size: .8rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; background: var(--bg-card); color: var(--text-main); white-space: nowrap; box-shadow: none; }
    .btn-cta { background: linear-gradient(90deg, #ff2440, #fb7185); color: #111827; font-weight: 600; border-color: transparent; }
    .btn span.icon { font-size: .85rem; }
    
    .radio-group { display: flex; align-items: center; gap: 15px; height: 28px; }
    .radio-group label { display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: .8rem; }
    .radio-group input[type="radio"] { accent-color: var(--accent-blue); transform: scale(1.2); cursor: pointer; }

    /* PAGES */
    .pages { flex: 1; overflow: hidden; display: flex; flex-direction: column; gap: 8px; max-width: 100%; }
    .page { flex: 1; display: none; overflow-y: auto; overflow-x: hidden; max-width: 100%; }
    .page.active { display: flex; flex-direction: column; gap: 8px; }

    .card { background: var(--bg-card); border-radius: 14px; padding: 10px; border: 1px solid var(--border-soft); display: flex; flex-direction: column; min-width: 0; }
    .card-title { font-size: .9rem; font-weight: 600; }
    .card-sub { font-size: .72rem; color: var(--text-muted); margin-top: 2px; }
    .card-header-row { display: flex; align-items: baseline; justify-content: space-between; gap: 6px; margin-bottom: 4px; }
    .badge-small { font-size: .7rem; padding: 2px 6px; border-radius: 999px; background: #111827; color: #9ca3af; border: 1px solid var(--border-soft); }
    body.light .badge-small { background: #e5e7eb; }

    .chip-estado { display: inline-flex; align-items: center; justify-content: center; padding: 2px 8px; border-radius: 999px; font-size: .7rem; font-weight: 500; color: #111827; background: #9ca3af; }
    .chip-estado.pendiente { background: var(--chip-pendiente); }
    .chip-estado.enproceso { background: var(--chip-enproceso); }
    .chip-estado.finalizada { background: var(--chip-finalizada); }
    .btn-chip { border-radius: 999px; border: 1px solid var(--border-soft); background: transparent; font-size: .72rem; padding: 2px 6px; cursor: pointer; color: var(--accent-blue); }

    /* DASHBOARD */
    .dashboard-grid { display: grid; grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.3fr); gap: 10px; min-height: 0; align-items: flex-start; width: 100%; box-sizing: border-box; }
    .dashboard-right-column { display: flex; flex-direction: column; gap: 10px; min-height: 0; }
    .kpi-grid { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 6px; margin-bottom: 6px; }
    .kpi-card { background: var(--bg-card-soft); border-radius: 10px; padding: 6px 8px; border: 1px solid var(--border-soft); display: flex; flex-direction: column; gap: 2px; }
    .kpi-label { font-size: .72rem; color: var(--text-muted); }
    .kpi-value { font-size: .98rem; font-weight: 600; }
    .kpi-caption { font-size: .7rem; color: var(--text-muted); }
    .dashboard-charts { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 8px; min-height: 0; }
    .chart-container { position: relative; width: 100%; min-height: 160px; max-height: 240px; }
    .chart-container.centered { display:flex; align-items:center; justify-content:center; }
    .chart-container canvas { position: relative; width: 100% !important; height: 100% !important; display: block; }
    .criterios-container { min-height: 300px; max-height: 450px; overflow-y: auto; }

    /* RANKING */
    .ranking-list { font-size: .78rem; margin-top: 4px; display: flex; flex-direction: column; gap: 4px; }
    .ranking-row { display: flex; align-items: center; gap: 6px; justify-content: space-between; padding:3px 0; border-bottom: 1px dashed rgba(148,163,184,0.3); }
    .ranking-main { display:flex; align-items:center; gap:6px; }
    .ranking-bar { height: 5px; border-radius:999px; background: var(--bg-card-soft); flex: 1; overflow:hidden; }
    .ranking-bar span { display:block; height:100%; background: linear-gradient(90deg,#22c55e,#38bdf8); }
    .ranking-row.extra-hidden { display:none; }
    .ranking-toggle { margin-top:6px; font-size:.76rem; color:var(--accent-blue); cursor:pointer; text-align:right; }
    .ranking-summary { margin-top: 8px; padding-top: 6px; border-top: 1px dashed rgba(148,163,184,0.4); font-size: .76rem; color: var(--text-muted); display: flex; flex-direction: column; gap: 2px; }
    .ranking-summary-item span { font-weight: 600; color: var(--text-main); }

    /* CENTROS */
    .centros-top { display: grid; grid-template-columns: 1.2fr 1.2fr 1fr; gap: 10px; min-height: 210px; }
    .delegados-list { margin-top: 6px; display: flex; flex-direction: column; gap: 4px; max-height: 160px; overflow: auto; }
    .delegado-card { background: var(--bg-card-soft); border-radius: 10px; padding: 4px 6px; border: 1px solid var(--border-soft); cursor: pointer; }
    .delegado-header { display:flex; align-items:center; justify-content:space-between; gap:6px; }
    .delegado-main { display:flex; align-items:center; gap:6px; font-size:.8rem; }
    .delegado-color { width:8px; height:8px; border-radius:999px; }
    .delegado-count { font-size:.72rem; color:var(--text-muted); }
    .delegado-bar { margin-top:3px; height:4px; border-radius:999px; background:var(--border-soft); overflow:hidden; }
    .delegado-bar span { display:block; height:100%; width:100%; background:linear-gradient(90deg,#38bdf8,#fb7185); }
    .delegado-card.active { outline:1px solid var(--accent-blue); }

    /* CALENDARIO & TABLA */
    .calendar-wrapper { display:flex; flex-direction:column; gap:4px; height:100%; }
    .calendar-header { display:flex; align-items:center; justify-content:space-between; font-size:.85rem; font-weight:700; }
    .calendar-header button { border-radius:999px; width:24px; height:24px; border:1px solid var(--border-soft); background:transparent; color:var(--text-main); cursor:pointer; font-size:.8rem; }
    .calendar-weekdays { display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); font-size:.7rem; margin-top:4px; color:var(--text-muted); text-align:center; }
    .calendar-grid { margin-top:4px; display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); grid-template-rows: repeat(6, 42px); gap:4px; flex:1; }
    .cal-cell { border-radius:10px; border:1px solid var(--border-soft); background:var(--bg-card-soft); font-size:.8rem; display:flex; flex-direction:column; align-items:flex-start; justify-content:flex-start; padding:3px 4px; cursor:pointer; position:relative; }
    .cal-cell.empty { background:transparent; border-style:dashed; cursor:default; }
    .cal-day { font-size:.78rem; }
    .cal-event { position:absolute; bottom:4px; left:4px; display:flex; align-items:center; gap:3px; font-size:.7rem; }
    .cal-dot { width:6px; height:6px; border-radius:999px; background:#facc15; }
    .cal-letter { font-weight:600; }

    .visitas-list { flex:1; overflow:auto; font-size:.78rem; display:flex; flex-direction:column; gap:4px; }
    .visita-row { border-radius:10px; border:1px solid var(--border-soft); padding:4px 6px; background:var(--bg-card-soft); display:flex; flex-direction:column; gap:2px; }
    .visita-row-line { display:flex; align-items:center; justify-content:space-between; gap:4px; }
    .visita-row-main { font-weight:500; }
    .visita-row-secondary { color:var(--text-muted); font-size:.72rem; }
    .visita-actions { margin-top:2px; display:flex; justify-content:flex-end; gap:4px; }

    .table-wrapper { flex:1; background: var(--bg-card); border-radius: 14px; border: 1px solid var(--border-soft); display: flex; flex-direction: column; min-height: 0; }
    .table-header { padding: 8px 10px 6px; display: flex; justify-content: space-between; align-items: baseline; }
    .table-header h3 { font-size: .9rem; }
    .table-header span { font-size: .72rem; color: var(--text-muted); }
    .table-scroll { flex: 1; overflow: auto; border-top: 1px solid var(--border-soft); }
    table { width: 100%; border-collapse: collapse; font-size: .78rem; }
    thead { position: sticky; top: 0; background: var(--bg-card); z-index: 2; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #0b1120; text-align: left; white-space: nowrap; }
    th { font-weight: 600; font-size: .75rem; color: var(--text-muted); }
    tbody tr:nth-child(even) { background: var(--bg-card-soft); }
    tbody tr:hover { background: rgba(15,23,42,0.8); }
    body.light tbody tr:nth-child(even) { background:#f3f4f6; }
    body.light tbody tr:hover { background:#e5e7eb; }

    .tag { border-radius: 999px; padding: 2px 6px; font-size: .7rem; border: 1px solid var(--border-soft); background: #0b1120; }
    .tag.exclusivo { background: rgba(22,163,74,0.15); color: var(--accent-green); border-color: rgba(22,163,74,0.7); }
    .tag.corner { background: rgba(37,99,235,0.15); color: var(--accent-blue); border-color: rgba(37,99,235,0.7); }
    .tag-aar { background: rgba(148,163,184,0.15); border-color: rgba(148,163,184,0.7); color: var(--text-muted); }
    .tag-aar.si { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.7); color: var(--accent-green); }
    .btn-link { border: none; background: transparent; color: var(--accent-blue); cursor: pointer; font-size: .74rem; text-decoration: underline; }

    /* INFORME LAYOUT */
    .informe-layout { display:flex; flex-direction:column; gap:8px; min-height:0; }
    .informe-top { display:grid; grid-template-columns: 1.3fr 1fr; gap:10px; min-height:190px; }
    .datos-grid { display:grid; grid-template-columns: 1fr 1fr; gap:6px 12px; font-size:.8rem; margin-top:6px; }
    .dato-label { font-size:.72rem; color:var(--text-muted); }
    .dato-value { font-size:.82rem; font-weight:500; }
    .dato-full { grid-column:1 / -1; }
    .field-input { width:100%; padding:4px 6px; border-radius:8px; border:1px solid var(--border-soft); background:var(--bg-card-soft); color:var(--text-main); font-size:.8rem; outline:none; }

    /* PANEL COMBINADO */
    .panel-combined { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; min-height: 260px; }
    .panel-listado { font-size: .75rem; border-right: 1px dashed var(--border-soft); padding-right: 8px; overflow-y: auto; max-height: 240px; }
    .panel-listado ul { padding-left:15px; margin:0; }
    .panel-listado li { margin-bottom: 4px; color: #ef4444; }

    .panel-graficos { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:8px; min-height:0; overflow:visible; }
    .panel-inferior { display: grid; grid-template-columns: 1.1fr 1.9fr; gap: 10px; }

    /* CHECKLIST COMPLETO */
    .checklist-visita { font-size: .78rem; max-height: 260px; overflow: auto; display:flex; flex-direction:column; gap:2px; padding: 5px; border: 1px solid var(--border-soft); border-radius: 8px; }
    .checklist-visita label { display:flex; align-items:center; gap:4px; }
    .checklist-visita::-webkit-scrollbar { width:6px; }
    .checklist-visita::-webkit-scrollbar-thumb { background:var(--border-soft); border-radius:4px; }
    .checklist-heading { margin-top:6px; font-size:.8rem; font-weight:600; color:var(--text-main); }

    .imagenes-grid { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 10px; font-size: .78rem; }
    .imagen-item-title { font-size:.78rem; margin-bottom:3px; }
    .imagen-preview { width: 100%; aspect-ratio: 16 / 9; border-radius: 10px; border: 1px dashed var(--border-soft); display: flex; align-items: center; justify-content: center; font-size: .7rem; color: var(--text-muted); overflow: hidden; background:var(--bg-card-soft); cursor:pointer; }
    .imagen-preview img { width:100%; height:100%; object-fit:cover; }

    .observaciones-grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; margin-top:4px; }
    .obs-item textarea { width:100%; height:80px; resize:vertical; border-radius:10px; border:1px solid var(--border-soft); background:var(--bg-card-soft); color:var(--text-main); padding:6px; font-size:.78rem; outline:none; }
    .obs-label { font-size:.78rem; margin-bottom:2px; }
    .acciones-informe { margin-top:6px; display:flex; justify-content:flex-end; gap:8px; }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(15,23,42,0.75); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal { background: var(--bg-card); border-radius: 14px; padding: 14px; width: 420px; max-width: 95%; border: 1px solid var(--border-soft); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .modal-close { cursor: pointer; font-size: 1rem; color: var(--text-muted); }
    .modal-body { display: flex; flex-direction: column; gap: 8px; font-size: .78rem; }
    .modal-field { display: flex; flex-direction: column; gap: 2px; }
    .modal-field label { font-size: .74rem; color: var(--text-muted); }
    .modal-field input, .modal-field select { padding: 5px 7px; border-radius: 8px; border: 1px solid var(--border-soft); background: var(--bg-card-soft); color: var(--text-main); font-size: .78rem; outline: none; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; }

    input[type="file"] { font-size:.75rem; }
    body.light .btn { background:#ffffff; }
    body.light .card { background:#ffffff; }

    /* ESTILOS IMPRESI√ìN */
    #printChecklistContainer { display: none; }
    @page { size: A4 portrait; margin: 10mm; }
    @media print {
      body { background: white !important; color: black !important; display: block; }
      .sidebar, .topbar, .acciones-informe, #themeToggle, .btn, .btn-cta, .modal-backdrop { display: none !important; }
      .main { padding: 0; margin: 0; max-width: none; overflow: visible; }
      .pages { overflow: visible !important; height: auto !important; display: block !important; }
      .page { display: none !important; }
      .page.active { display: flex !important; overflow: visible !important; height: auto !important; }
      
      .card { border: 1px solid #ccc !important; box-shadow: none !important; background: white !important; color: black !important; break-inside: avoid; margin-bottom: 10px; }
      input, textarea, select { background: white !important; color: black !important; border: 1px solid #ccc !important; }
      .checklist-visita { max-height: none; overflow: visible; border: 1px solid #ccc; }
      .dashboard-grid { grid-template-columns: 1fr !important; }
      .informe-top { grid-template-columns: 1.4fr 1fr !important; }
      .panel-graficos { grid-template-columns: 1fr 1fr 1fr !important; height: auto; }
      .panel-combined { grid-template-columns: 1fr 1fr; }
      
      /* P√ÅGINA 2 */
      #printChecklistContainer { display: block !important; break-before: page; margin-top: 20px; }
      .print-header { font-size: 16px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid black; padding-bottom: 5px; }
      .print-table { width: 100%; border-collapse: collapse; font-size: 11px; }
      .print-table th, .print-table td { border: 1px solid #ccc; padding: 5px; text-align: left; }
      .print-table th { background: #f0f0f0; font-weight: bold; }
    }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-badge"></div>
      <div class="logo-text">
        <span class="logo-title">Control Center Audio</span>
        <span class="logo-subtitle">Gesti√≥n de centros y delegados</span>
      </div>
    </div>
    <nav class="nav-list">
      <div class="nav-item active" data-page="dashboard"><span class="icon">üè†</span> Dashboard</div>
      <div class="nav-item" data-page="centros"><span class="icon">üè¢</span> Centros</div>
      <div class="nav-item" data-page="informe"><span class="icon">üìã</span> Informe de la visita</div>
      <div class="nav-item" data-page="servicios"><span class="icon">üõ†</span> Servicios</div>
      <div class="nav-item" data-page="ventas"><span class="icon">üí≥</span> Ventas</div>
      <div class="nav-item" data-page="proyectos"><span class="icon">üìä</span> Proyectos</div>
    </nav>
    <div class="sidebar-footer">Versi√≥n demo ¬∑ Datos ficticios</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="topbar-search">
        <span>üîç</span><input id="searchGlobal" placeholder="Buscar por centro, propietario o delegado...">
      </div>
      <div style="font-size: .8rem; color: var(--text-muted); margin-left:15px;">
         <span id="headerVisitsCount">Visitas procesadas: 0</span>
      </div>
      <div class="topbar-buttons">
        <button class="btn" id="themeToggle"><span class="icon">üåì</span> Tema</button>
        <button class="btn" id="btnImprimir"><span class="icon">üñ®</span> Imprimir</button>
        <button class="btn btn-cta" id="btnActualizarNube"><span class="icon">‚òÅÔ∏è</span> Nube</button>
      </div>
    </div>

    <div class="pages">
      <section class="page active" data-page="dashboard">
        <div class="dashboard-grid">
          <article class="card">
            <div class="card-header-row"><span class="card-title">Resumen general</span><span class="badge-small">Datos Globales</span></div>
            <div class="kpi-grid">
              <div class="kpi-card"><div class="kpi-label">% Procesos</div><div class="kpi-value" id="kpiProcesos">-</div></div>
              <div class="kpi-card"><div class="kpi-label">Conv. Prueba</div><div class="kpi-value" id="kpiConvPrueba">-</div></div>
              <div class="kpi-card"><div class="kpi-label">Conv. Venta</div><div class="kpi-value" id="kpiConvVenta">-</div></div>
              <div class="kpi-card"><div class="kpi-label">HIT</div><div class="kpi-value" id="kpiHIT">-</div><div class="kpi-caption">% Centros</div></div>
              <div class="kpi-card"><div class="kpi-label">Formaciones</div><div class="kpi-value" id="kpiFormaciones">-</div></div>
              <div class="kpi-card"><div class="kpi-label">Ayuda</div><div class="kpi-value" id="kpiAyuda">-</div></div>
              <div class="kpi-card"><div class="kpi-label">AAR</div><div class="kpi-value" id="kpiAar">-</div><div class="kpi-caption">% Centros</div></div>
              <div class="kpi-card"><div class="kpi-label">1os Aux</div><div class="kpi-value" id="kpiPrimeros">-</div></div>
            </div>
            <div class="dashboard-charts">
              <div class="card"><div class="card-header-row"><span class="card-title">Radar</span></div><div class="chart-container"><canvas id="chartRadarGeneral"></canvas></div></div>
              <div class="card"><div class="card-header-row"><span class="card-title">Procesos Mes</span></div><div class="chart-container"><canvas id="chartProcesosMes"></canvas></div></div>
              <div class="card"><div class="card-header-row"><span class="card-title">√Åreas Mes</span></div><div class="chart-container"><canvas id="chartAreasMes"></canvas></div></div>
              <div class="card"><div class="card-header-row"><span class="card-title">1os Aux Mes</span></div><div class="chart-container"><canvas id="chartPrimerosMes"></canvas></div></div>
              <div class="card"><div class="card-header-row"><span class="card-title">Top √Åreas</span></div><div class="chart-container"><canvas id="chartTopAreas"></canvas></div></div>
              <div class="card"><div class="card-header-row"><span class="card-title">AAR / HIT</span></div><div class="chart-container"><canvas id="chartAarHitDonut"></canvas></div></div>
            </div>
          </article>
          <div class="dashboard-right-column">
            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Evaluaci√≥n 80 criterios (Promedio Global %)</span>
                <span class="badge-small">Acumulado</span>
              </div>
              <div class="chart-container criterios-container"><canvas id="chartCriteriosDetalle"></canvas></div>
            </article>
            <article class="card">
              <div class="card-header-row"><span class="card-title">Ranking</span></div>
              <div class="ranking-list" id="rankingDelegados"></div>
            </article>
          </div>
        </div>
      </section>

      <section class="page" data-page="centros">
        <div class="centros-top">
          <article class="card">
            <div class="card-header-row"><span class="card-title">Centros</span><span class="badge-small"><span id="numDelegados">0</span> delegados</span></div>
            <div class="delegados-list" id="delegadosList"></div>
            <div style="margin-top:8px; display:flex; gap:5px;">
               <button class="btn btn-cta" id="btnAddCentro">‚ûï Nuevo</button>
               <button class="btn" id="btnAdjuntarExcel">üì§ Carga Masiva (Excel)</button>
               <input type="file" id="inputExcel" hidden>
            </div>
          </article>
          <article class="card">
            <div class="calendar-wrapper">
              <div class="calendar-header"><button id="calPrev">&lt;</button><div id="calTitulo"></div><button id="calNext">&gt;</button></div>
              <div class="calendar-grid" id="calendarGrid"></div>
            </div>
          </article>
          <article class="card">
            <div class="card-header-row"><span class="card-title">Visitas</span></div>
            <div class="visitas-list" id="visitasList"></div>
          </article>
        </div>
        <section class="table-wrapper">
          <div class="table-header"><h3>Listado</h3><span class="badge-small" id="totalCentrosLabel">0 / 0</span></div>
          <div class="table-scroll">
            <table><thead><tr><th>C√≥digo</th><th>Propietario</th><th>Centro</th><th>Provincia</th><th>Delegado</th><th>Tipo</th><th>Acci√≥n</th><th>AAR</th></tr></thead><tbody id="tablaCentrosBody"></tbody></table>
          </div>
        </section>
      </section>

      <section class="page" data-page="informe">
        <div class="informe-layout">
          <div class="informe-top">
            <article class="card">
              <div class="card-header-row"><span class="card-title">Datos Centro</span></div>
              <div class="datos-grid">
                <div><div class="dato-label">Centro</div><input id="infCentro" class="field-input" readonly></div>
                <div><div class="dato-label">Delegado</div><input id="infDelegado" class="field-input" readonly></div>
                <div class="dato-full">
                   <div class="dato-label" style="margin-bottom:2px;">Tipo de Centro</div>
                   <div class="radio-group">
                      <label><input type="radio" name="tipoCentro" value="Exclusivo" id="radExclusivo"> Exclusivo</label>
                      <label><input type="radio" name="tipoCentro" value="Corner" id="radCorner"> Corner</label>
                   </div>
                </div>
                <div><div class="dato-label">Responsable</div><input id="infRespAudio" class="field-input"></div>
                <div><div class="dato-label">Fecha</div><input id="infFecha" class="field-input"></div>
                <div class="dato-full" style="margin-top:4px;">
                  <button class="btn btn-cta" id="btnAdjuntarChecklist">üìé Adjuntar Checklist (Excel)</button>
                  <input type="file" id="inputChecklist" hidden>
                  <span id="nombreChecklist" style="margin-left:8px; font-size:.74rem; color:var(--text-muted);"></span>
                </div>
              </div>
            </article>
            
            <article class="card">
              <div class="card-header-row"><span class="card-title">KPIs Calidad</span></div>
              <div style="font-size:.78rem; margin-top:4px;">
                <div>% Procesos: <strong id="kpiCentroProcesos">0%</strong></div>
                <div>C. Prueba: <strong id="kpiCentroPrueba">0%</strong></div>
                <div>C. Venta: <strong id="kpiCentroVenta">0%</strong></div>
                <div>HIT: <strong id="kpiCentroHit" style="color:var(--accent-blue);">No</strong></div>
              </div>
              <div class="chart-container centered" style="height:180px;"><canvas id="chartCentroKPIsBar"></canvas></div>
            </article>
          </div>

          <div class="panel-combined card">
             <div class="panel-listado">
                <div class="card-title" style="margin-bottom:5px;">√Åreas Mejora (F=0)</div>
                <ul id="listaMejorasTexto"><li>Sin datos...</li></ul>
             </div>
             <div class="chart-container">
                <canvas id="chartCentroCombo"></canvas>
             </div>
          </div>

          <div class="panel-graficos">
             <article class="card"><span class="card-title">Palancas</span><div class="chart-container"><canvas id="chartCentroPalancas"></canvas></div></article>
             <article class="card"><span class="card-title">Procesos (Global)</span><div class="chart-container"><canvas id="chartCentroProcesosStack"></canvas></div></article>
          </div>

          <div class="panel-inferior">
            <article class="card">
              <div class="card-header-row"><span class="card-title">Checklist Completo</span></div>
              <div class="checklist-visita">
                <div class="checklist-heading">Formaciones y Habilidades</div>
                <label><input type="checkbox" id="chkHit"> HIT</label>
                <label><input type="checkbox" id="chkAar"> AAR</label>
                <label><input type="checkbox"> Financiaci√≥n Infinity</label>
                <label><input type="checkbox"> Venta Seguro</label>
                <label><input type="checkbox"> Primeros Auxilios (Equipo)</label>
                <label><input type="checkbox"> Formaci√≥n WSA</label>
                <label><input type="checkbox"> Formaci√≥n Starkey</label>
                <label><input type="checkbox"> Neuroventas</label>
                <label><input type="checkbox"> Telecare</label>
                <label><input type="checkbox"> PIA</label>
                <label><input type="checkbox"> Telehear</label>
                
                <div class="checklist-heading">Producto y Comunicaci√≥n</div>
                <label><input type="checkbox"> Audiometr√≠a RT</label>
                <label><input type="checkbox"> Test Lectura Audio</label>
                <label><input type="checkbox"> Screening Audio</label>
                <label><input type="checkbox"> Manteleta Audio</label>
                <label><input type="checkbox"> Escaparate Visible Audio</label>
                <label><input type="checkbox"> Salud Auditiva en PDV</label>
                <label><input type="checkbox"> Elementos Renove</label>
                <label><input type="checkbox"> Elementos MGM</label>
                <label><input type="checkbox"> Stock</label>
                <label><input type="checkbox"> Tchin Tchin</label>
              </div>
            </article>
            <article class="card">
              <div class="card-header-row"><span class="card-title">Im√°genes</span></div>
              <div class="imagenes-grid">
                <div class="imagen-preview" onclick="$('#f1').click()">Exterior<input id="f1" type="file" hidden onchange="prev(this)"></div>
                <div class="imagen-preview" onclick="$('#f2').click()">Interior<input id="f2" type="file" hidden onchange="prev(this)"></div>
                <div class="imagen-preview" onclick="$('#f3').click()">Gabinete<input id="f3" type="file" hidden onchange="prev(this)"></div>
              </div>
            </article>
          </div>

          <article class="card">
            <span class="card-title">Conclusiones</span>
            <div class="observaciones-grid">
              <div class="obs-item"><div class="obs-label">Observaciones</div><textarea></textarea></div>
              <div class="obs-item"><div class="obs-label">Recomendaciones</div><textarea></textarea></div>
              <div class="obs-item"><div class="obs-label">Compromisos</div><textarea></textarea></div>
            </div>
            <div class="acciones-informe"><button class="btn btn-cta" id="btnGuardarInforme">üíæ Guardar Informe</button></div>
          </article>
        </div>
      </section>

      <section class="page" data-page="servicios"><article class="card"><div class="card-title">Servicios</div></article></section>
      <section class="page" data-page="ventas"><article class="card"><div class="card-title">Ventas</div></article></section>
      <section class="page" data-page="proyectos"><article class="card"><div class="card-title">Proyectos</div></article></section>
    </div>
  </main>

  <div id="printChecklistContainer">
    <div class="print-header">ANEXO: DETALLE EVALUACI√ìN (80 CRITERIOS)</div>
    <table class="print-table" id="tablaPrint">
      <thead><tr><th>Criterio</th><th>Resultado</th></tr></thead>
      <tbody id="tbodyPrint"></tbody>
    </table>
  </div>

  <div class="modal-backdrop" id="modalVisita">
    <div class="modal">
      <div class="modal-header"><h3>Agendar</h3><span class="modal-close" data-close="modalVisita">‚úï</span></div>
      <div class="modal-body">
        <div class="modal-field"><label>Fecha</label><input id="visitaFecha" readonly></div>
        <div class="modal-field"><label>Responsable</label><select id="visitaResp"><option>Ariannys Rojas</option><option>Sonia Guasque</option></select></div>
        <div class="modal-field"><label>Centro</label><input id="visitaCentro"></div>
      </div>
      <div class="modal-footer"><button class="btn btn-cta" id="btnGuardarVisita">Guardar</button></div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalCentro">
    <div class="modal">
      <div class="modal-header"><h3>Nuevo Centro</h3><span class="modal-close" data-close="modalCentro">‚úï</span></div>
      <div class="modal-body">
         <div class="modal-field"><label>Centro</label><input id="nuevoCentro"></div>
         <div class="modal-field"><label>Delegado</label><input id="nuevoDelegado"></div>
      </div>
      <div class="modal-footer"><button class="btn btn-cta" id="guardarCentro">Guardar</button></div>
    </div>
  </div>

  <script>
    Chart.register(ChartDataLabels);
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    function prev(i){if(i.files[0]){const r=new FileReader();r.onload=e=>i.parentElement.innerHTML=`<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`;r.readAsDataURL(i.files[0]);}}
    function formatDateISO(d){return d.toISOString().split('T')[0];}
    function formatDateHuman(iso){const [y,m,d]=iso.split('-');return `${d}-${m}-${y}`;}

    // ESTADO
    const centros = [
       { codigo:"4ABB", centro:"PAMPLONA C. Exclusivo", provincia:"NAVARRA", delegado:"Sonia Godino", hit:true, aar:false },
       { codigo:"4MRM", centro:"REINA DE MERCEDES", provincia:"Madrid", delegado:"Sergio Per√°n", hit:false, aar:true },
       { codigo:"4AXF", centro:"SANTIAGO DE COMPOSTELA", provincia:"A Coru√±a", delegado:"Daniel Chazo", hit:true, aar:true },
       { codigo:"4PEC", centro:"SANTANDER CC", provincia:"Santander", delegado:"Sergio Per√°n", hit:false, aar:false }
    ];
    // Acumulador Global de Criterios { "NombreCriterio": { total:0, ok:0 } }
    let globalCriteriaStats = {};
    let totalInformesCargados = 0;

    let centroActual = null;
    let visitaActual = null; const visitas = [];
    let centroChartsCreated = false;
    let centroCharts = {}, globalCharts = {};
    
    // Variables para el informe actual
    let itemsFallidos = [];
    let conteoOk = 0, conteoNo = 0;

    // NAV
    $$(".nav-item").forEach(i => i.addEventListener("click", () => {
       $$(".nav-item").forEach(n=>n.classList.remove("active")); i.classList.add("active");
       $$(".page").forEach(p=>p.classList.remove("active")); 
       $(`.page[data-page='${i.dataset.page}']`).classList.add("active");
    }));
    $("#themeToggle").addEventListener("click", ()=> { document.body.classList.toggle("light"); updateChartsTheme(); });
    $("#btnImprimir").addEventListener("click", ()=> window.print());

    // CALCULO GLOBAL 80 CRITERIOS
    function actualizarGraficoGlobalCriterios() {
       const labels = Object.keys(globalCriteriaStats);
       const data = labels.map(k => {
          const s = globalCriteriaStats[k];
          return s.total ? Math.round((s.ok / s.total) * 100) : 0;
       });
       
       // Ordenar de mayor a menor cumplimiento
       const combined = labels.map((l,i) => ({l, d: data[i]}));
       combined.sort((a,b) => b.d - a.d);
       
       const sortedLabels = combined.map(c => c.l);
       const sortedData = combined.map(c => c.d);
       const colors = sortedData.map(v => v >= 85 ? '#22c55e' : (v >= 50 ? '#facc15' : '#ef4444'));

       const ctx = document.getElementById("chartCriteriosDetalle").getContext("2d");
       if(!globalCharts.criteriosDetalle) {
          globalCharts.criteriosDetalle = new Chart(ctx, {
             type: 'bar',
             data: { labels: sortedLabels, datasets: [{ label:'% Cumplimiento Global', data: sortedData, backgroundColor: colors }] },
             options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: {display:false} } }
          });
       } else {
          globalCharts.criteriosDetalle.data.labels = sortedLabels;
          globalCharts.criteriosDetalle.data.datasets[0].data = sortedData;
          globalCharts.criteriosDetalle.data.datasets[0].backgroundColor = colors;
          globalCharts.criteriosDetalle.update();
       }
       
       // Ajustar altura canvas si hay muchos items
       if(sortedLabels.length > 20) {
          document.querySelector(".criterios-container canvas").style.height = (sortedLabels.length * 20) + "px";
       }
    }

    // RECALCULO DASHBOARD
    function recalcularKPIsGlobales() {
       $("#headerVisitsCount").textContent = `Visitas procesadas: ${totalInformesCargados}`;
       
       const total = centros.length || 1;
       const hitCount = centros.filter(c => c.hit).length;
       const hitPct = Math.round((hitCount/total)*100);
       $("#kpiHIT").textContent = hitPct + "%";
       
       if(globalCharts.radarGeneral) globalCharts.radarGeneral.update();
       if(globalCharts.aarHit) {
          globalCharts.aarHit.data.datasets[0].data = [hitCount, total-hitCount];
          globalCharts.aarHit.update();
       }
       actualizarGraficoGlobalCriterios();
       renderTablaCentros();
    }

    // LECTURA EXCEL
    $("#btnAdjuntarChecklist").addEventListener("click", ()=> $("#inputChecklist").click());
    $("#inputChecklist").addEventListener("change", e => {
       const file = e.target.files[0];
       if(file) { $("#nombreChecklist").textContent = file.name; leerChecklist(file); }
    });

    function leerChecklist(file) {
       const reader = new FileReader();
       reader.onload = evt => {
          const wb = XLSX.read(new Uint8Array(evt.target.result), {type:"array"});
          const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
          
          const isExclusivo = file.name.toUpperCase().includes("EXCLUSIVO");
          if(isExclusivo) $("#radExclusivo").checked=true; else $("#radCorner").checked=true;

          // Rango dummy aproximado
          let rStart = isExclusivo ? 7 : 6;
          let rEnd = isExclusivo ? 101 : 87;

          itemsFallidos = []; conteoOk=0; conteoNo=0;
          let listaPrint = "";

          // Procesar Criterios Fila a Fila
          for(let r=rStart; r<=rEnd; r++) {
             const row = rows[r] || [];
             const crit = row[1]; // Nombre Criterio (Col B)
             const val = row[5];  // Valor (Col F) 1 o 0
             
             if(crit) {
                // Actualizar Global Accumulator
                if(!globalCriteriaStats[crit]) globalCriteriaStats[crit] = { total:0, ok:0 };
                globalCriteriaStats[crit].total++;
                if(val == 1) globalCriteriaStats[crit].ok++;

                // L√≥gica Local (Informe actual)
                if(val == 1) conteoOk++;
                else { conteoNo++; itemsFallidos.push(crit); }
                
                listaPrint += `<tr><td>${crit}</td><td style="color:${val==1?'green':'red'}">${val==1?'CUMPLE':'NO CUMPLE'}</td></tr>`;
             }
          }
          $("#tbodyPrint").innerHTML = listaPrint;
          
          // Leer KPIs unitarios (coords dummy)
          let fHit = isExclusivo ? 64 : 62;
          let valHit = (rows[fHit]||[])[5] == 1;
          const procPct = Math.round((conteoOk / (conteoOk+conteoNo))*100) || 0;

          if(centroActual) centroActual.hit = valHit;
          $("#chkHit").checked = valHit;

          alert(`Checklist procesado. Criterios OK: ${conteoOk}, Fallidos: ${conteoNo}`);
          actualizarVisualesCentro(valHit, $("#chkAar").checked, procPct, 80, 75);
       }
       reader.readAsArrayBuffer(file);
    }

    // CHARTS CENTRO RENOVADOS
    function crearChartsCentro() {
       centroChartsCreated = true;
       const textColor = getComputedStyle(document.body).getPropertyValue('--text-muted');

       // 1. HORIZONTAL BAR (Reemplaza Radar)
       centroCharts.kpiBar = new Chart(document.getElementById("chartCentroKPIsBar").getContext("2d"), {
          type: 'bar',
          data: {
             labels: ['Procesos', 'C. Prueba', 'C. Venta', 'Formaci√≥n (x10)'],
             datasets: [{ 
                label: '%', 
                data: [0,0,0,0], 
                backgroundColor: ['#38bdf8', '#818cf8', '#34d399', '#fbbf24'],
                borderRadius: 4
             }]
          },
          options: {
             indexAxis: 'y',
             responsive: true,
             maintainAspectRatio: false,
             scales: { x: { max: 100, display:false }, y: { ticks: {color: textColor, font:{size:11, weight:'bold'}} } },
             plugins: { legend: {display:false}, datalabels: { color:'#fff', anchor:'end', align:'start', formatter: Math.round } }
          }
       });

       // 2. PALANCAS
       centroCharts.palancas = new Chart(document.getElementById("chartCentroPalancas").getContext("2d"), {
          type: 'bar',
          data: { labels: ['HIT','AAR','Primeros Aux','Infinity','Seguro','Stock'], datasets: [{ data:[1,1,1,1,1,1], backgroundColor:[], borderRadius:4 }] },
          options: { indexAxis:'y', scales:{x:{display:false}, y:{grid:{display:false}, ticks:{color:textColor}}}, plugins:{legend:{display:false}} }
       });

       // 3. COMBO CHART (Lista Mejora + Curva Procesos)
       // NOTA: Chart.js no soporta HTML nativo dentro del canvas. Usamos el panel "panel-combined"
       // Aqu√≠ renderizamos solo la parte gr√°fica (Curva + Barras de Fallo)
       centroCharts.combo = new Chart(document.getElementById("chartCentroCombo").getContext("2d"), {
          type: 'bar',
          data: {
             labels: [], // Se llenar√°n con los nombres de items fallidos
             datasets: [
                { type: 'line', label: 'Tendencia Procesos', data: [], borderColor: '#38bdf8', tension: 0.4, yAxisID: 'y1' },
                { type: 'bar', label: 'Item Fallido (1)', data: [], backgroundColor: '#ef4444', borderRadius: 4, yAxisID: 'y' }
             ]
          },
          options: {
             maintainAspectRatio: false,
             scales: { 
                y: { display:false }, 
                y1: { display:false, min:0, max:100 },
                x: { display:false } // Ocultamos etiquetas x para limpieza, ya est√°n en la lista izquierda
             },
             plugins: { legend: {display:false} }
          }
       });

       // 4. PROCESOS STACKED
       centroCharts.stack = new Chart(document.getElementById("chartCentroProcesosStack").getContext("2d"), {
          type: 'bar',
          data: { labels: ['Estado'], datasets: [
             { label:'Cumple', data:[0], backgroundColor:'#22c55e', borderRadius:4 },
             { label:'No Cumple', data:[0], backgroundColor:'#ef4444', borderRadius:4 }
          ]},
          options: { indexAxis:'y', scales:{x:{display:false, stacked:true}, y:{display:false, stacked:true}}, plugins:{legend:{position:'bottom', labels:{color:textColor}}} }
       });
    }

    function actualizarVisualesCentro(hit, aar, proc, pru, ven) {
       if(!centroChartsCreated) crearChartsCentro();
       
       // KPIs Texto
       $("#kpiCentroProcesos").textContent = proc + "%"; 
       $("#kpiCentroHit").textContent = hit?"S√≠":"No"; $("#kpiCentroHit").style.color = hit?"#22c55e":"#ef4444";
       
       // 1. KPI Bar
       const formVal = $("#inpFormaciones").value || 5;
       centroCharts.kpiBar.data.datasets[0].data = [proc, pru, ven, formVal*10];
       centroCharts.kpiBar.update();

       // 2. Palancas
       const sts = [hit, aar, $("#chk1os").checked, $("#chkInfinity").checked, $("#chkSeguro").checked, $("#chkStock").checked];
       centroCharts.palancas.data.datasets[0].backgroundColor = sts.map(s=>s?'#22c55e':'#ef4444');
       centroCharts.palancas.update();

       // 3. Combo (Lista + Chart)
       // Llenar lista texto izquierda
       const ul = document.getElementById("listaMejorasTexto");
       ul.innerHTML = "";
       const topFallos = itemsFallidos.slice(0, 8); // Top 8
       if(topFallos.length === 0) ul.innerHTML = "<li style='color:#22c55e'>¬°Todo Correcto!</li>";
       else topFallos.forEach(f => ul.innerHTML += `<li>${f}</li>`);

       // Llenar gr√°fico derecha
       // Simulamos una curva que sube hacia el objetivo
       const trendData = topFallos.map((_, i) => proc - (topFallos.length - i)); 
       centroCharts.combo.data.labels = topFallos;
       centroCharts.combo.data.datasets[0].data = trendData; // Linea
       centroCharts.combo.data.datasets[1].data = topFallos.map(()=>1); // Barras
       centroCharts.combo.update();

       // 4. Stack
       centroCharts.stack.data.datasets[0].data = [conteoOk];
       centroCharts.stack.data.datasets[1].data = [conteoNo];
       centroCharts.stack.update();
    }

    // LISTENERS INPUTS
    $("#inpFormaciones").addEventListener("input", ()=> actualizarVisualesCentro($("#chkHit").checked, $("#chkAar").checked, 85, 80, 75));
    
    // NAVEGACION INFORME
    function irAInforme(nombre, iso, resp) {
       centroActual = centros.find(c=>c.centro===nombre);
       if(!centroActual) return;
       
       $$(".nav-item").forEach(n=>n.classList.remove("active")); $(`.nav-item[data-page='informe']`).classList.add("active");
       $$(".page").forEach(p=>p.classList.remove("active")); $(`.page[data-page='informe']`).classList.add("active");

       $("#infCentro").value = centroActual.centro; $("#infProvincia").value = centroActual.provincia; $("#infDelegado").value = centroActual.delegado;
       $("#infRespAudio").value = resp || "Ariannys Rojas";
       $("#infFecha").value = iso;
       
       if(centroActual.centro.includes("Exclusivo")) $("#radExclusivo").checked=true; else $("#radCorner").checked=true;
       
       // Reset datos visuales
       itemsFallidos = []; conteoOk=0; conteoNo=0;
       actualizarVisualesCentro(centroActual.hit, centroActual.aar, 0, 0, 0);
    }

    $("#btnGuardarInforme").addEventListener("click", ()=> {
       if(centroActual) {
          centroActual.hit = $("#chkHit").checked; centroActual.aar = $("#chkAar").checked;
          totalInformesCargados++;
          recalcularKPIsGlobales();
       }
       alert("Informe guardado. Globales actualizados.");
    });

    // INICIALIZACION
    function initGlobalCharts() {
       // Radar Global (Si se mantiene por petici√≥n, aunque el del centro se quit√≥)
       const ctxR = document.getElementById("chartRadarGeneral").getContext("2d");
       globalCharts.radarGeneral = new Chart(ctxR, {
          type: 'radar',
          data: { labels: ['Procesos','Prueba','Venta','HIT','Form','AAR'], datasets: [{ label: 'Global %', data: [85,80,78,0,60,0], backgroundColor: 'rgba(56,189,248,0.2)', borderColor: '#38bdf8' }] },
          options: { scales: { r: { min:0, max:100, ticks:{display:false} } }, plugins:{legend:{display:false}} }
       });
       
       const ctxDonut = document.getElementById("chartAarHitDonut").getContext("2d");
       globalCharts.aarHit = new Chart(ctxDonut, {
          type:'doughnut', data:{ labels:['S√≠','No'], datasets:[{ data:[1,1], backgroundColor:['#22c55e','#ef4444'] }] }, options:{cutout:'60%', plugins:{legend:{position:'bottom'}}}
       });
       // Dummys Mes
       new Chart(document.getElementById("chartProcesosMes"), { type:"line", data:{labels:["E","F","M"],datasets:[{data:[80,82,85],borderColor:"#3b82f6"}]}, options:{maintainAspectRatio:false} });
       new Chart(document.getElementById("chartAreasMes"), { type:"bar", data:{labels:["E","F"],datasets:[{data:[5,3],backgroundColor:"#ef4444"}]}, options:{maintainAspectRatio:false} });
       new Chart(document.getElementById("chartPrimerosMes"), { type:"bar", data:{labels:["E","F"],datasets:[{data:[40,60],backgroundColor:"#22c55e"}]}, options:{maintainAspectRatio:false} });
       new Chart(document.getElementById("chartTopAreas"), { type:"bar", data:{labels:["Stock","Limpieza"],datasets:[{data:[10,5],backgroundColor:"#3b82f6"}]}, options:{indexAxis:"y",maintainAspectRatio:false} });
    }

    function renderTablaCentros() {
       const b = $("#tablaCentrosBody"); b.innerHTML="";
       centros.forEach(c => {
          b.innerHTML += `<tr><td>${c.codigo}</td><td>Owner</td><td>${c.centro}</td><td>${c.provincia}</td><td>${c.delegado}</td><td><span class="tag ${c.centro.includes('Exclusivo')?'exclusivo':'corner'}">Tipo</span></td><td><button class="btn-link" onclick="irAInforme('${c.centro}', '${new Date().toISOString().split('T')[0]}')">Informe</button></td><td>${c.aar?'S√≠':'No'}</td></tr>`;
       });
    }

    function renderDelegados() {
       $("#delegadosList").innerHTML = `<div class="delegado-card"><div class="delegado-header"><span>Delegado 1</span><span class="badge-small">2 centros</span></div></div>`;
    }

    // EVENTOS AGENDA
    $("#btnGuardarVisita").addEventListener("click", ()=> {
       const f = $("#visitaFecha").value; const r = $("#visitaResp").value; const c = $("#visitaCentro").value;
       const vList = $("#visitasList");
       vList.innerHTML += `<div class="visita-row"><div class="visita-row-line"><span>${f} ¬∑ ${c}</span><span class="chip-estado pendiente">Pendiente</span></div><div class="visita-row-secondary">Resp: ${r}</div><div class="visita-actions"><button class="btn-chip" onclick="irAInforme('${c}', '${f}', '${r}')">Informe</button></div></div>`;
       cerrarModal("modalVisita");
    });

    window.addEventListener("load", () => {
       renderTablaCentros(); renderDelegados(); initGlobalCharts();
       // Chart vac√≠o criterios global
       const ctx = document.getElementById("chartCriteriosDetalle").getContext("2d");
       globalCharts.criteriosDetalle = new Chart(ctx, { type: "bar", data: { labels: ["Cargando data..."], datasets: [{ label: "%", data: [0] }] }, options: { indexAxis: "y", maintainAspectRatio: false } });
    });
  </script>
</body>
</html>
