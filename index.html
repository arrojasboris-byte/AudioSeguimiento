<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n Audio - Dashboard General</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #050816;
      --bg-sidebar: #020617;
      --bg-card: #0f172a;
      --bg-card-soft: #111827;
      --accent: #ef4444;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --radius-xl: 18px;
      --shadow-soft: 0 14px 30px rgba(0,0,0,.45);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    
    body {
      background: radial-gradient(circle at top left, #1f2937, #020617 45%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
    }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.4); border-radius: 99px; }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-soft);
      padding: 20px 18px;
      display: flex; flex-direction: column; gap: 18px;
      flex-shrink: 0;
    }
    .logo { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .logo-icon { width: 40px; height: 40px; border-radius: 50%; background: #ef4444; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
    .logo-title { font-weight: 800; font-size: 1.1rem; }
    .logo-title-gestion { color: #f97316; } .logo-title-audio { color: #38bdf8; }
    
    .side-nav-item {
      width: 100%; text-align: left; background: transparent; border: 1px solid #334155;
      padding: 10px; border-radius: 99px; color: var(--text-muted); cursor: pointer;
      display: flex; gap: 10px; align-items: center; margin-bottom: 6px;
      transition: all 0.2s;
    }
    .side-nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .side-nav-item.active { background: rgba(239,68,68,0.15); border-color: #ef4444; color: #fff; }

    /* Main */
    .main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-x: hidden; }
    
    .topbar { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
    .btn {
      background: #ef4444; color: white; border: none; padding: 6px 14px; border-radius: 99px;
      cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;
      transition: transform 0.1s;
    }
    .btn:hover { transform: translateY(-1px); background: #dc2626; }

    .view { display: none; animation: fadeIn 0.3s ease; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Cards & Grids */
    .card {
      background: var(--bg-card); border: 1px solid var(--border-soft);
      border-radius: var(--radius-xl); padding: 16px; position: relative;
      box-shadow: var(--shadow-soft);
    }
    .grid-main { display: grid; grid-template-columns: 2fr 1.4fr; gap: 16px; margin-top: 10px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 10px; }
    
    /* Inputs gen√©ricos */
    .input-dark {
      background: #020617; border: 1px solid var(--border-soft); color: white;
      padding: 6px 10px; border-radius: 8px; width: 100%; font-size: 0.8rem; outline: none;
    }
    .input-dark:focus { border-color: #ef4444; }

    /* KPI Pills (Dashboard) */
    .kpi-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
    .kpi-pill {
      background: #ef4444; color: white; padding: 8px 14px; border-radius: 99px;
      min-width: 140px; display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 4px 10px rgba(239,68,68,0.3); font-size: 0.8rem; flex-shrink: 0;
    }
    .kpi-val { font-weight: bold; font-size: 0.95rem; }

    /* ---- GESTOR VISITAS / INFORME ESTILOS ESPEC√çFICOS ---- */
    
    /* Layout Informe */
    .visit-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 0.8rem; }
    .visit-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .visit-label { color: var(--text-muted); font-size: 0.7rem; margin-bottom: 2px; display: block; }
    
    /* Secci√≥n Im√°genes */
    .images-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .image-slot {
      border: 1px dashed #475569; border-radius: 12px; height: 120px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-align: center; overflow: hidden; position: relative; background: #0f172a;
    }
    .image-slot img { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; z-index: 1; }
    .image-slot input { position: absolute; width: 100%; height: 100%; opacity: 0; z-index: 2; cursor: pointer; }
    .image-placeholder { z-index: 0; padding: 10px; pointer-events: none; }

    /* Centros List con Scroll */
    .centros-container { margin-top: 10px; }
    .centros-list {
      list-style: none; max-height: 150px; overflow-y: auto; overflow-x: auto;
      white-space: nowrap; border: 1px solid var(--border-soft); border-radius: 8px;
    }
    .centros-item {
      padding: 6px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.75rem;
      display: flex; gap: 15px;
    }
    .centros-item span { display: inline-block; min-width: 100px; }

    /* Check Interno */
    .check-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 250px; overflow-y: auto; font-size: 0.75rem; }
    .check-item { display: flex; gap: 6px; align-items: center; margin-bottom: 4px; }
    
    /* Calendario simple */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-size: 0.7rem; margin-top: 10px; }
    .cal-cell { padding: 6px; text-align: center; border-radius: 4px; cursor: pointer; }
    .cal-cell:hover { background: rgba(255,255,255,0.1); }
    .cal-today { border: 1px solid #ef4444; color: #ef4444; font-weight: bold; }

    /* PRINT STYLES - A4 Ajuste */
    @media print {
      @page { size: A4; margin: 5mm; }
      body { background: white; color: black; display: block; }
      .sidebar, .topbar, .no-print, .btn { display: none !important; }
      .main { padding: 0 !important; overflow: visible; }
      .card { border: 1px solid #ccc; box-shadow: none; break-inside: avoid; page-break-inside: avoid; margin-bottom: 10px; background: white; color: black; }
      .input-dark, select, textarea { border: 1px solid #ccc; background: white; color: black; }
      .kpi-pill { border: 1px solid #000; color: black; background: #eee; box-shadow: none; }
      
      /* Forzar ajuste a una p√°gina por m√≥dulo */
      .view { display: block !important; }
      /* Si solo queremos imprimir la vista activa, usamos JS para ocultar las otras, 
         pero aqu√≠ asumiremos que el usuario imprime lo que ve */
      
      /* Reducir escala para que quepa todo */
      body { zoom: 0.65; } 
      
      .image-slot { border: 1px solid #000; }
      .visit-layout, .grid-main, .grid-3 { display: grid; } /* Mantener grid */
    }

    /* Helper ocultar */
    .hidden { display: none; }
  </style>
</head>
<body>

  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon">üéß</div>
      <div>
        <div class="logo-title"><span class="logo-title-gestion">Gesti√≥n</span><span class="logo-title-audio"> Audio</span></div>
        <div style="font-size: 0.7rem; color: #94a3b8;">Plataforma de Seguimiento</div>
      </div>
    </div>

    <nav>
      <button class="side-nav-item" onclick="switchView('dashboard')">
        <span>üìà</span> Dashboard General
      </button>
      <button class="side-nav-item active" onclick="switchView('informes')">
        <span>üóÇÔ∏è</span> Gestor & Informes
      </button>
    </nav>
  </aside>

  <main class="main">
    
    <div class="topbar">
      <button class="btn" onclick="saveAndExportHTML()"><span>üíæ</span> Guardar y Exportar HTML (Portable)</button>
      <button class="btn" onclick="window.print()"><span>üñ®Ô∏è</span> Imprimir</button>
    </div>

    <section id="view-dashboard" class="view">
      <div class="card" style="margin-bottom: 10px;">
        <h2 style="font-size: 1.1rem; margin-bottom: 5px;">Resumen General KPIs</h2>
        <div class="kpi-row">
          <div class="kpi-pill"><div>% Procesos</div><div class="kpi-val" id="dashProcesos">--%</div></div>
          <div class="kpi-pill"><div>HIT Global</div><div class="kpi-val" id="dashHit">--%</div></div>
          <div class="kpi-pill"><div>Conv. Prueba</div><div class="kpi-val" id="dashPrueba">--%</div></div>
          <div class="kpi-pill"><div>Conv. Venta</div><div class="kpi-val" id="dashVenta">--%</div></div>
        </div>
      </div>

      <div class="grid-main">
        <div class="card">
          <h3>Evoluci√≥n Mensual</h3>
          <div style="height: 200px;"><canvas id="chartEvolucion"></canvas></div>
        </div>
        <div class="card">
          <h3>Estado Visitas</h3>
          <div style="height: 200px;"><canvas id="chartVisitas"></canvas></div>
        </div>
      </div>
    </section>

    <section id="view-informes" class="view active">
      
      <div class="grid-main" style="margin-bottom: 20px;">
        <div class="card">
          <h3>Planificaci√≥n de Visitas</h3>
          <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin: 10px 0;">
            <button class="btn" style="padding: 2px 8px;" onclick="prevMonth()">&lt;</button>
            <span id="calLabel">Diciembre 2025</span>
            <button class="btn" style="padding: 2px 8px;" onclick="nextMonth()">&gt;</button>
          </div>
          <div class="calendar-grid" id="calendarGrid">
            </div>
          <div style="margin-top: 15px; border-top: 1px solid #334155; padding-top: 10px;">
            <h4 style="font-size: 0.8rem; margin-bottom: 5px;">Visitas Pendientes</h4>
            <div id="pendingVisitsList" style="font-size: 0.75rem; color: #cbd5e1; max-height: 80px; overflow-y: auto;">
              </div>
          </div>
        </div>

        <div class="card">
          <h3>Base de Datos Centros</h3>
          <div style="margin-bottom: 10px;">
            <label class="visit-label">Adjuntar Excel Centros (para listado)</label>
            <input type="file" id="inputExcelCentros" class="input-dark" accept=".xlsx, .xls">
          </div>
          <div class="centros-list" id="listaCentros">
            <div style="padding:10px; color:#64748b; text-align:center;">Carga un Excel para ver datos (con scroll horizontal)</div>
          </div>
        </div>
      </div>

      <div class="card" id="informeSection">
        <h2 style="font-size: 1.1rem; border-bottom: 1px solid #334155; padding-bottom: 8px; margin-bottom: 15px;">Informe de Visita</h2>

        <div class="visit-layout">
          <div>
            <div class="visit-row">
              <div>
                <span class="visit-label">Centro</span>
                <input id="infCentro" class="input-dark" placeholder="Nombre Centro">
              </div>
              <div>
                <span class="visit-label">Delegado</span>
                <input id="infDelegado" class="input-dark" placeholder="Delegado">
              </div>
            </div>
            <div class="visit-row">
              <div>
                <span class="visit-label">Responsable Audio</span>
                <input id="infResp" class="input-dark">
              </div>
              <div>
                <span class="visit-label">Fecha</span>
                <input type="date" id="infFecha" class="input-dark">
              </div>
            </div>
            <div class="visit-row">
              <div>
                <span class="visit-label" style="color:#38bdf8; font-weight:bold;">Audi√≥logo</span>
                <input id="infAudiologo" class="input-dark" placeholder="Nombre audi√≥logo">
              </div>
              <div>
                <span class="visit-label" style="color:#38bdf8; font-weight:bold;">Horas de servicio</span>
                <input id="infHoras" type="number" class="input-dark" placeholder="Ej: 8">
              </div>
            </div>
          </div>

          <div style="background: rgba(15,23,42,0.5); padding: 10px; border-radius: 12px; border: 1px dashed #334155;">
            <h4 style="font-size: 0.9rem; margin-bottom: 10px; color: #f97316;">Evaluaci√≥n y KPIs (Excel)</h4>
            
            <div class="visit-row">
              <div>
                <span class="visit-label">Tipo Centro (Activa L√≥gica)</span>
                <select id="infTipo" class="input-dark">
                  <option value="">Seleccionar...</option>
                  <option value="Corner">CORNER</option>
                  <option value="Exclusivo">EXCLUSIVO</option>
                </select>
              </div>
              <div>
                <span class="visit-label">Adjuntar Checklist Excel</span>
                <input type="file" id="infChecklistFile" class="input-dark" accept=".xlsx, .xls">
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;">
              <div class="kpi-pill" style="min-width: auto; padding: 4px 8px; background: #1e293b; border: 1px solid #334155;">
                <span style="font-size:0.7rem;">% Procesos</span>
                <strong id="resProcesos" style="color:#ef4444;">-</strong>
              </div>
              <div class="kpi-pill" style="min-width: auto; padding: 4px 8px; background: #1e293b; border: 1px solid #334155;">
                <span style="font-size:0.7rem;">HIT</span>
                <strong id="resHit" style="color:#ef4444;">-</strong>
              </div>
              <div class="kpi-pill" style="min-width: auto; padding: 4px 8px; background: #1e293b; border: 1px solid #334155;">
                <span style="font-size:0.7rem;">Conv. Prueba</span>
                <strong id="resPrueba" style="color:#38bdf8;">-</strong>
              </div>
              <div class="kpi-pill" style="min-width: auto; padding: 4px 8px; background: #1e293b; border: 1px solid #334155;">
                <span style="font-size:0.7rem;">Conv. Venta</span>
                <strong id="resVenta" style="color:#22c55e;">-</strong>
              </div>
            </div>
          </div>
        </div>

        <div class="grid-3">
          <div class="card" style="padding: 10px;">
            <h4 style="font-size: 0.8rem; text-align: center;">Radar Resultados</h4>
            <div style="height: 150px;"><canvas id="chartRadar"></canvas></div>
          </div>
          <div class="card" style="padding: 10px;">
            <h4 style="font-size: 0.8rem; text-align: center;">KPIs Negocio</h4>
            <div style="height: 150px;"><canvas id="chartKpiNegocio"></canvas></div>
          </div>
          <div class="images-grid" style="margin-top:0; grid-column: span 1;">
            <div class="image-slot">
              <div class="image-placeholder">IMG 1</div>
              <img id="preview1">
              <input type="file" accept="image/*" onchange="previewImage(this, 'preview1')">
            </div>
            <div class="image-slot">
              <div class="image-placeholder">IMG 2</div>
              <img id="preview2">
              <input type="file" accept="image/*" onchange="previewImage(this, 'preview2')">
            </div>
            <div class="image-slot">
              <div class="image-placeholder">IMG 3</div>
              <img id="preview3">
              <input type="file" accept="image/*" onchange="previewImage(this, 'preview3')">
            </div>
          </div>
        </div>

        <div class="grid-main" style="margin-top: 15px;">
          <div class="card">
            <h3>Check Interno (Manual)</h3>
            <div class="check-grid">
              <label class="check-item"><input type="checkbox"> WSA</label>
              <label class="check-item"><input type="checkbox"> Starkey</label>
              <label class="check-item"><input type="checkbox"> Habilidades Comerciales</label>
              <label class="check-item"><input type="checkbox"> HIT</label>
              <label class="check-item"><input type="checkbox"> Telecare / Telehear</label>
              <label class="check-item"><input type="checkbox"> Financiaci√≥n Infinity</label>
              <label class="check-item"><input type="checkbox"> Venta Seguro</label>
              <label class="check-item"><input type="checkbox"> Primeros Auxilios</label>
              <label class="check-item"><input type="checkbox"> Audiometr√≠a RT</label>
              <label class="check-item"><input type="checkbox"> Stock</label>
              <label class="check-item"><input type="checkbox"> Tchin Tchin</label>
              <label class="check-item"><input type="checkbox"> Escaparate / PDV</label>
            </div>
            </div>

          <div class="card">
            <h3>Observaciones y Compromisos</h3>
            <textarea id="infObs" class="input-dark" style="height: 200px; resize: none;" placeholder="Escribe aqu√≠ las observaciones, acuerdos y pr√≥ximos pasos..."></textarea>
          </div>
        </div>

      </div>

      <div class="card no-print" style="margin-top: 20px;">
        <h3>Historial de Informes Generados (Sesi√≥n actual)</h3>
        <ul id="historialList" style="list-style: none; font-size: 0.8rem; margin-top: 10px; color: var(--text-muted);">
          </ul>
      </div>

    </section>

  </main>

  <script>
    // ==========================================
    // 1. ESTADO GLOBAL (Datos que se guardar√°n)
    // ==========================================
    // Si venimos de un archivo exportado, usamos window.exportedData, si no, inicializamos
    const loadedData = window.exportedData || {};

    let appState = {
      visitasPendientes: loadedData.visitasPendientes || [],
      historialInformes: loadedData.historialInformes || [],
      centrosData: loadedData.centrosData || [], // Datos crudos del Excel de centros
      kpiData: loadedData.kpiData || { procesos: 0, hit: 0, prueba: 0, venta: 0 }
    };

    // ==========================================
    // 2. L√ìGICA EXCEL (CHECKLIST)
    // ==========================================
    const inputFile = document.getElementById('infChecklistFile');
    const selectTipo = document.getElementById('infTipo');

    function readChecklistExcel() {
      const file = inputFile.files[0];
      const tipo = selectTipo.value;

      if (!file || !tipo) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

        // Helper para leer celda segura
        const getVal = (addr) => {
          const cell = firstSheet[addr];
          return cell ? cell.v : 0;
        };

        let proc=0, hit=0, prueba=0, venta=0;

        // --- L√ìGICA SOLICITADA ---
        if (tipo === 'Corner') {
          // Corner Logic: Criterios B7-B88, Resultados F7-F88
          // KPIs:
          proc = getVal('F90');    // % Procesos
          hit = getVal('F63');     // Aplica HIT
          prueba = getVal('B92');  // Conv Prueba
          venta = getVal('B93');   // Conv Venta

        } else if (tipo === 'Exclusivo') {
          // Exclusivo Logic: Criterios B8-B102, Resultados F8-F102
          // KPIs:
          proc = getVal('F104');   // % Procesos
          prueba = getVal('I126'); // Conv Prueba
          venta = getVal('I127');  // Conv Venta
          hit = getVal('F65');     // Aplica HIT
        }

        // Normalizar a porcentaje (si viene 0.8 -> 80, si viene 80 -> 80)
        // Asumimos que Excel trae decimales (0.5) para porcentajes o enteros.
        const fmt = (v) => v <= 1 ? (v*100).toFixed(0) : v;
        
        appState.kpiData = { 
          procesos: fmt(proc), 
          hit: fmt(hit), 
          prueba: fmt(prueba), 
          venta: fmt(venta) 
        };

        updateReportUI();
      };
      reader.readAsArrayBuffer(file);
    }

    inputFile.addEventListener('change', readChecklistExcel);
    selectTipo.addEventListener('change', readChecklistExcel);

    function updateReportUI() {
      // Actualizar textos
      document.getElementById('resProcesos').textContent = appState.kpiData.procesos + '%';
      document.getElementById('resHit').textContent = appState.kpiData.hit + '%';
      document.getElementById('resPrueba').textContent = appState.kpiData.prueba + '%';
      document.getElementById('resVenta').textContent = appState.kpiData.venta + '%';

      // Actualizar gr√°ficas del informe
      updateCharts(appState.kpiData);
    }

    // ==========================================
    // 3. PREVISUALIZACI√ìN DE IM√ÅGENES
    // ==========================================
    window.previewImage = function(input, imgId) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById(imgId).src = e.target.result;
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    // ==========================================
    // 4. LECTURA EXCEL CENTROS (Scroll horizontal)
    // ==========================================
    document.getElementById('inputExcelCentros').addEventListener('change', function(e){
      const file = e.target.files[0];
      if(!file) return;
      
      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, {type: 'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        // Convertir a JSON array de arrays
        const json = XLSX.utils.sheet_to_json(ws, {header: 1});
        
        appState.centrosData = json; // Guardar estado
        renderCentrosList();
      };
      reader.readAsArrayBuffer(file);
    });

    function renderCentrosList() {
      const container = document.getElementById('listaCentros');
      container.innerHTML = '';
      
      if (!appState.centrosData || appState.centrosData.length === 0) {
        container.innerHTML = '<div style="padding:10px;">Sin datos</div>';
        return;
      }

      appState.centrosData.forEach((row, idx) => {
        // Omitir cabecera opcionalmente o renderizar todo
        if (row.length === 0) return;
        
        const div = document.createElement('div');
        div.className = 'centros-item';
        // Crear spans para cada celda
        row.forEach(cell => {
          const span = document.createElement('span');
          span.textContent = cell;
          div.appendChild(span);
        });
        container.appendChild(div);
      });
    }

    // ==========================================
    // 5. GR√ÅFICOS (Chart.js)
    // ==========================================
    let radarChart, kpiChart, evoChart, visChart;

    function initCharts() {
      // 1. Radar Informe
      const ctxRadar = document.getElementById('chartRadar').getContext('2d');
      radarChart = new Chart(ctxRadar, {
        type: 'radar',
        data: {
          labels: ['Procesos', 'HIT', 'Prueba', 'Venta'],
          datasets: [{
            label: 'Resultados Visita',
            data: [0,0,0,0],
            backgroundColor: 'rgba(239, 68, 68, 0.2)',
            borderColor: '#ef4444',
            pointBackgroundColor: '#fff'
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { r: { suggestedMin: 0, suggestedMax: 100, grid: { color: '#334155' }, angleLines: { color: '#334155' }, pointLabels: { color: '#cbd5e1', font: {size: 10} }, ticks: { display: false } } },
          plugins: { legend: { display: false } }
        }
      });

      // 2. Barras KPI Negocio
      const ctxKpi = document.getElementById('chartKpiNegocio').getContext('2d');
      kpiChart = new Chart(ctxKpi, {
        type: 'bar',
        data: {
          labels: ['Conv. Prueba', 'Conv. Venta'],
          datasets: [{
            label: '%',
            data: [0, 0],
            backgroundColor: ['#38bdf8', '#22c55e']
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, max: 100, grid: { color: '#334155' } }, x: { grid: { display: false } } },
          plugins: { legend: { display: false } }
        }
      });

      // 3. Dashboard Evoluci√≥n (Demo data static)
      const ctxEvo = document.getElementById('chartEvolucion').getContext('2d');
      evoChart = new Chart(ctxEvo, {
        type: 'line',
        data: {
          labels: ['Ene','Feb','Mar','Abr','May','Jun'],
          datasets: [{ label: 'HIT', data: [65, 70, 80, 81, 85, 90], borderColor: '#ef4444', tension: 0.3 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: 'white' } } }, scales: { y: { grid: { color: '#334155' } }, x: { grid: { color: '#334155' } } } }
      });

      // 4. Dashboard Visitas
      const ctxVis = document.getElementById('chartVisitas').getContext('2d');
      visChart = new Chart(ctxVis, {
        type: 'doughnut',
        data: {
          labels: ['Realizadas', 'Pendientes'],
          datasets: [{ data: [80, 20], backgroundColor: ['#22c55e', '#f97316'], borderWidth: 0 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: 'white' } } } }
      });
    }

    function updateCharts(data) {
      // Radar
      radarChart.data.datasets[0].data = [data.procesos, data.hit, data.prueba, data.venta];
      radarChart.update();
      // KPI Barras
      kpiChart.data.datasets[0].data = [data.prueba, data.venta];
      kpiChart.update();
    }

    // ==========================================
    // 6. UTILIDADES & EXPORTACI√ìN PORTABLE
    // ==========================================
    
    function switchView(viewName) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.side-nav-item').forEach(b => b.classList.remove('active'));
      
      document.getElementById('view-' + viewName).classList.add('active');
      // Update button active state manually or via event delegation
      event.currentTarget.classList.add('active');
    }

    // CALENDARIO SIMPLE
    const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    let currDate = new Date();
    
    function renderCalendar() {
      const y = currDate.getFullYear();
      const m = currDate.getMonth();
      document.getElementById('calLabel').textContent = `${months[m]} ${y}`;
      
      const firstDay = new Date(y, m, 1).getDay(); // 0 Dom
      const daysInMonth = new Date(y, m+1, 0).getDate();
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      
      // Headers
      ['D','L','M','X','J','V','S'].forEach(d => grid.innerHTML += `<div style="color:#94a3b8">${d}</div>`);
      
      // Empty slots
      for(let i=0; i<firstDay; i++) { grid.innerHTML += `<div></div>`; }
      
      // Days
      for(let i=1; i<=daysInMonth; i++) {
        const dDiv = document.createElement('div');
        dDiv.className = 'cal-cell';
        dDiv.textContent = i;
        if(i === new Date().getDate() && m === new Date().getMonth()) dDiv.classList.add('cal-today');
        
        dDiv.onclick = () => {
          const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
          const centro = prompt("Centro para la visita:");
          if(centro) {
            appState.visitasPendientes.push({date: dateStr, centro: centro});
            renderPendingVisits();
          }
        };
        grid.appendChild(dDiv);
      }
    }
    
    function prevMonth() { currDate.setMonth(currDate.getMonth()-1); renderCalendar(); }
    function nextMonth() { currDate.setMonth(currDate.getMonth()+1); renderCalendar(); }

    function renderPendingVisits() {
      const list = document.getElementById('pendingVisitsList');
      list.innerHTML = '';
      appState.visitasPendientes.forEach(v => {
        const div = document.createElement('div');
        div.style.padding = "4px 0"; borderBottom = "1px solid #333";
        div.textContent = `üìÖ ${v.date} - ${v.centro}`;
        list.appendChild(div);
      });
    }

    // --- FUNCI√ìN CLAVE: GUARDAR Y EXPORTAR (PORTABILIDAD) ---
    function saveAndExportHTML() {
      // 1. Serializar el estado actual a JSON
      const jsonState = JSON.stringify(appState);

      // 2. Obtener todo el HTML actual
      let htmlContent = document.documentElement.outerHTML;

      // 3. Inyectar el estado en el script de inicio
      // Buscamos donde definimos 'window.exportedData' o lo creamos
      const scriptInjection = `<script>window.exportedData = ${jsonState};<\/script>`;
      
      // Insertar justo antes del cierre del body
      const newHtml = htmlContent.replace('</body>', `${scriptInjection}</body>`);

      // 4. Descargar
      const blob = new Blob([newHtml], {type: 'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Gestion_Audio_Backup_${new Date().toISOString().slice(0,10)}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // INICIALIZACI√ìN
    window.onload = function() {
      initCharts();
      renderCalendar();
      renderPendingVisits();
      renderCentrosList(); // Si hay datos cargados previamente
      if(appState.kpiData.procesos !== 0) updateReportUI(); // Restaurar KPIs si existen
    };

  </script>
</body>
</html>
