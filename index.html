<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SEGUIMIENTO AUDIO · Cloud</title>
<meta name="theme-color" content="#c82727">

<!-- ==== ESTILOS (compacto, tipografía pequeña, tablas tipo Excel) ==== -->
<style>
:root{
  --rojo:#c82727;--rojo2:#a71f1f;--bg:#f6f7fb;--line:#e6e7ee;--sh:0 4px 14px rgba(0,0,0,.06);
  --col-ex:#fde2e4;--col-fl:#e2f0cb;--col-va:#cde7f0;--col-fm:#f9e5c9;--col-ta:#eadcf8;--col-eq:#e8f1ff;
  --fs:11.2px;--fs-sm:10.2px;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;font-size:var(--fs);color:#222;line-height:1.18;overflow-x:auto}
button,input,select,textarea{font-family:inherit;font-size:inherit}

/* Topbar */
.topbar{position:sticky;top:0;z-index:99;width:100%;background:linear-gradient(180deg,var(--rojo),var(--rojo2));color:#fff;box-shadow:var(--sh)}
.bar{padding:.8rem 10px;display:grid;grid-template-columns:1fr auto 1fr;gap:.5rem;align-items:center}
.left,.right{display:flex;gap:.35rem;align-items:center}
.brand{justify-self:center;text-align:center}
.brand h1{margin:0;font-size:22px;letter-spacing:.4px}
.brand small{display:block;font-size:10.5px;opacity:.9}
.btn{border:0;border-radius:9px;padding:.34rem .66rem;cursor:pointer;box-shadow:var(--sh);font-weight:800;font-size:10.6px}
.btn-w{background:#fff;color:#7b0e0e}
.btn-g{background:transparent;border:1px solid #ffffff5c;color:#fff}
.pill{border:1px solid #ffffff25;background:#ffffff1c;border-radius:999px;padding:.12rem .46rem;font-size:10.4px}

/* Layout */
.main{display:grid;grid-template-columns:190px minmax(0,1fr);gap:6px;padding:6px}
@media (max-width:1100px){.main{grid-template-columns:1fr}}
.sidebar{display:flex;flex-direction:column;gap:6px}
.card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--sh)}
.side-head{display:flex;justify-content:space-between;align-items:center;padding:.34rem .42rem;border-bottom:1px solid var(--line);font-weight:900;font-size:11px}
.side-list{padding:.32rem;max-height:180px;overflow:auto}
.side-btn{width:26px;height:22px;border:1px solid var(--line);background:#fff;border-radius:6px;cursor:pointer;font-size:10px}
.item{display:flex;justify-content:space-between;gap:.35rem;align-items:center;border:1px solid var(--line);border-radius:8px;padding:.26rem .32rem;margin:.2rem 0}
.item .name{font-weight:800}

/* Detalle */
.detail{background:#fff;border:1px solid var(--line);border-radius:8px;min-height:66vh;padding:.5rem;box-shadow:var(--sh)}
.hdr{display:flex;align-items:center;gap:.6rem;margin-bottom:.25rem}
.hdr h2{margin:0;font-size:18px} .hdr .big{font-weight:900;font-size:20px}
.badge{background:#00000010;padding:.1rem .5rem;border-radius:999px;font-size:10.8px}
.save-mini{margin-left:auto;background:#1f6feb;color:#fff;border:0;border-radius:999px;padding:.38rem .7rem;box-shadow:var(--sh);cursor:pointer;font-size:11px}

/* Forms */
.row{display:flex;gap:.35rem;flex-wrap:wrap;align-items:flex-end}
.field{display:grid;gap:.12rem;flex:1;min-width:140px;margin:.14rem 0}
.field label{font-weight:700;opacity:.9;font-size:10.3px}
.field input,.field select,.field textarea{border:1px solid var(--line);border-radius:7px;padding:.18rem .26rem;font-size:var(--fs-sm);background:#fff}

/* Tablas */
.table{border:1px solid var(--line);border-radius:8px;background:#fff;box-shadow:var(--sh);padding:.22rem;margin-top:.18rem}
.xscroll{overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;padding-bottom:4px}
.grid{display:grid;gap:.12rem;align-items:center}
.scroll{max-height:62vh;overflow:auto}
.tool{border:1px solid var(--line);background:#fff;border-radius:7px;padding:.16rem .4rem;font-size:10.3px;cursor:pointer}
.tools{display:flex;justify-content:flex-end;gap:.25rem;margin:.12rem 0}

/* Columnas */
.acc-h,.acc-r{grid-template-columns:36px 90px 70px 220px 80px 70px 70px 1fr 36px}
.frm-h,.frm-r{grid-template-columns:36px 1.1fr .45fr .45fr 2fr 36px}
.proc-h,.proc-r{grid-template-columns:36px 110px 110px 58px 70px 82px 82px 150px 1.1fr 90px 36px}
.va-h,.va-r{grid-template-columns:36px .9fr 100px 100px 110px 105px 88px 52px 100px 100px}
.fm-h,.fm-r{grid-template-columns:36px 78px 160px 110px 78px 90px 90px 90px 90px 78px 78px}
.ta-h,.ta-r{grid-template-columns:36px 1fr 120px 110px 150px 44px 44px 44px 44px 44px 1.2fr}
.eq-h,.eq-r{grid-template-columns:36px 120px 98px 140px 100px 120px 40px 40px 120px 40px 40px 120px 40px 40px}

/* Estados */
.pscore{border:2px solid transparent}
.pscore.good{background:#eaf9f0;border-color:#2ecc71aa}
.pscore.bad{background:#ffe8e8;border-color:#e74c3caa}
.conv{border:2px solid transparent}
.conv.good{background:#eaf9f0;border-color:rgba(46,204,113,.6)}
.conv.bad{background:#ffe8e8;border-color:rgba(231,76,60,.6)}
.hitcell{background:#ffe5e5;border:1px solid #f5c2c2;border-radius:5px;display:flex;justify-content:center;align-items:center;padding:.06rem}
.hitcell.on{background:#e6f6ed;border-color:#bfe7cc}

/* Widget visitas lateral */
.va-right{position:fixed;right:12px;top:120px;width:210px;display:flex;flex-direction:column;gap:.25rem;z-index:50}
.va-right .card{background:#fff;border:1px solid var(--line);border-radius:8px;box-shadow:var(--sh);padding:.32rem}
.va-right .bar{height:6px;background:#e9ecef;border-radius:999px;overflow:hidden}
.va-right .bar>div{height:100%;background:#1f6feb;width:0%}

/* PIN */
.gate{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:1000}
.gcard{background:#111;color:#fff;border:1px solid #2a2a2a;border-radius:10px;box-shadow:var(--sh);padding:16px 14px;min-width:260px}
.pin{letter-spacing:.3rem;text-align:center;background:#000;color:#fff;border:1px solid #444;border-radius:7px;padding:.36rem}
body.locked header, body.locked main{pointer-events:none;user-select:none;filter:blur(.8px)}
body.locked #gate{pointer-events:auto;filter:none}
</style>
</head>
<body class="locked">

<!-- ==================== TOPBAR ==================== -->
<header class="topbar">
  <div class="bar">
    <div class="left">
      <button id="btnFetch" class="btn btn-w" title="Leer última versión de la nube">Actualizar (nube)</button>
      <button id="btnSave"  class="btn btn-w" title="Guardar cambios en la nube">Guardar (nube)</button>
      <button id="btnReset" class="btn btn-g" title="Descartar cambios sin guardar y recargar">Resetear</button>
    </div>
    <div class="brand">
      <h1>🎧 SEGUIMIENTO AUDIO</h1>
      <small>Control de centros, visitas, formaciones, teleaudiología y equipos</small>
    </div>
    <div class="right">
      <span class="pill" id="stamp">vCloud · Cargando…</span>
    </div>
  </div>
</header>

<!-- ==================== LAYOUT ==================== -->
<main class="main">
  <!-- -------- SIDEBAR -------- -->
  <aside class="sidebar">
    <section class="card" data-section="CENTROS EXCLUSIVOS" style="background:var(--col-ex)">
      <div class="side-head">📒 CENTROS EXCLUSIVOS <div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </section>
    <section class="card" data-section="CENTROS FLOP" style="background:var(--col-fl)">
      <div class="side-head">📒 CENTROS FLOP <div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </section>
    <section class="card" data-section="VISITAS AUDIO" style="background:var(--col-va)">
      <div class="side-head">📋 VISITAS AUDIO <div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </section>
    <section class="card" data-section="FORMACIONES Y MENTORING" style="background:var(--col-fm)">
      <div class="side-head">🎓 FORMACIONES Y MENTORING <div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </section>
    <section class="card" data-section="TELEAUDIOLOGIA" style="background:var(--col-ta)">
      <div class="side-head">📡 TELEAUDIOLOGIA <div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </section>
    <section class="card" data-section="EQUIPOS" style="background:var(--col-eq)">
      <div class="side-head">🧰 EQUIPOS <div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </section>
  </aside>

  <!-- -------- DETALLE -------- -->
  <section class="detail" id="detail">
    <div class="hdr">
      <h2>Detalle — <span id="hdrName" class="big">—</span></h2>
      <span id="hdrTag" class="badge">—</span>
      <button id="btnSavePanel" class="save-mini" title="Guardar panel">💾 Guardar</button>
    </div>
    <p id="hint" style="opacity:.7;margin:.1rem 0 .2rem">Selecciona algo a la izquierda (doble clic o ✏️) o crea con ＋.</p>

    <!-- === CENTROS (EXCLUSIVOS / FLOP) === -->
    <div id="detCentro" style="display:none">
      <div class="row">
        <div class="field"><label>Nombre</label><input id="cNombre"></div>
        <div class="field"><label>Delegado</label><input id="cDelegado"></div>
        <div class="field"><label>Audiólogo</label><input id="cAudiologo"></div>
        <div class="field"><label>Franquicia o Sucursal</label><select id="cTipo"><option>Franquicia</option><option>Sucursal</option></select></div>
      </div>

      <h3 style="margin:.32rem 0 .08rem;font-size:11.6px">ACCIONES</h3>
      <div class="tools"><button id="accAdd" class="tool">＋ Añadir fila</button></div>
      <div class="table"><div class="xscroll"><div class="grid acc-h"><div>#</div><div>Fecha</div><div>Paquete</div><div>Tipo de acción</div><div>Derivación</div><div>Citas</div><div>Ventas</div><div>Observaciones</div><div></div></div><div id="accionesRows" class="scroll"></div></div></div>
      <div class="field" style="margin-top:.2rem"><small>Paquete: <b>1</b> Tráfico · <b>2</b> Formación y comercial · <b>3</b> Equipo</small></div>

      <h3 style="margin:.32rem 0 .08rem;font-size:11.6px">FORMACIÓN</h3>
      <div class="tools"><button id="frmAdd" class="tool">＋ Añadir fila</button></div>
      <div class="table"><div class="xscroll"><div class="grid frm-h"><div>#</div><div>Curso</div><div>Realizado</div><div>Aplica</div><div>Observaciones</div><div></div></div><div id="formacionesRows"></div></div></div>

      <h3 style="margin:.32rem 0 .08rem;font-size:11.6px">PROCESOS</h3>
      <div class="tools"><button id="procAdd" class="tool">＋ Añadir fila</button></div>
      <div class="table"><div class="xscroll"><div class="grid proc-h">
        <div>#</div><div>Fecha de visita</div><div>Puntuación procesos (%)</div><div>HIT</div><div>Pruebas RT</div><div>% Pruebas</div><div>% Venta</div><div>Colaboraciones locales</div><div>Observaciones</div><div>Adjunto</div><div></div>
      </div><div id="procesosRows"></div></div></div>
    </div>

    <!-- === VISITAS === -->
    <div id="detVisitas" style="display:none">
      <div class="va-right">
        <div class="card">
          <div style="font-weight:800;font-size:11px;margin-bottom:.2rem">Avance de visitas</div>
          <div id="vaRightCount" style="font-size:11px;margin-bottom:.16rem">0 registradas</div>
          <div class="bar"><div id="vaRightBar"></div></div>
        </div>
      </div>
      <div class="row">
        <div class="field"><label>Rol</label><select id="vaRol"><option>Delegado audio</option><option>Responsable AAR</option></select></div>
        <div class="field"><label>Nombre</label><input id="vaResp"></div>
        <div class="field"><label>Buscar centro</label><input id="vaSearch" placeholder="Filtrar…"></div>
      </div>
      <div id="vaTabs" style="margin:.06rem 0 .18rem"></div>
      <div class="table">
        <div class="xscroll">
          <div class="grid va-h"><div>#</div><div>Centro</div><div>Delegado</div><div>Audiólogo</div><div>Sucursal/Franquicia</div><div>Fecha visita</div><div>Puntuación (%)</div><div>HIT</div><div>% Conv. prueba</div><div>% Conv. venta</div></div>
          <div id="vaRows" class="scroll"></div>
        </div>
      </div>
    </div>

    <!-- === FORMACIONES (global) === -->
    <div id="detFormaciones" style="display:none">
      <div class="row"><div class="field"><label>Delegado regional</label><input id="fmDelegado"></div><div class="field"><label>Buscar</label><input id="fmSearch" placeholder="Filtrar…"></div></div>
      <div class="table"><div class="xscroll"><div class="grid fm-h"><div>#</div><div>Fecha</div><div>Tema</div><div>Audiólogo</div><div>Duración (sem.)</div><div>% Prueba ini</div><div>% Venta ini</div><div>% Prueba 3m</div><div>% Venta 3m</div><div>Evo. prueba</div><div>Evo. venta</div></div><div id="fmRows" class="scroll"></div></div></div>
    </div>

    <!-- === TELEAUDIOLOGIA === -->
    <div id="detTele" style="display:none">
      <div class="row"><div class="field"><label>Buscar</label><input id="taSearch" placeholder="Centro o persona…"></div><div class="field"><label>Persona</label><select id="taPerson"><option value="">Todos</option></select></div></div>
      <div class="table"><div class="xscroll"><div class="grid ta-h"><div>#</div><div>Centro</div><div>Delegado</div><div>Rol</div><div>Persona</div><div>Form.</div><div>Prác.</div><div>Cert.</div><div>Pruebas</div><div>Ventas</div><div>Observaciones</div></div><div id="taRows" class="scroll"></div></div></div>
    </div>

    <!-- === EQUIPOS === -->
    <div id="detEquipos" style="display:none">
      <div class="row">
        <div class="field"><label>Buscar</label><input id="eqSearch" placeholder="Equipo, serie, centro o persona…"></div>
        <div class="field"><label>&nbsp;</label><div style="display:flex;gap:.3rem"><button id="btnAddParCols" class="btn">＋ Añadir par</button><button id="btnAddFila" class="btn">＋ Añadir fila</button></div></div>
      </div>
      <div class="table"><div class="xscroll"><div class="grid eq-h"><div>#</div><div>Equipo</div><div>Nº serie</div><div>Persona que envía</div><div>Fecha</div><div>Centro 1</div><div>C1</div><div>S1</div><div>Centro 2</div><div>C2</div><div>S2</div><div>Centro 3</div><div>C3</div><div>S3</div></div><div id="eqBody" class="scroll"></div></div></div>
    </div>

  </section>
</main>

<!-- ==================== PIN ==================== -->
<div id="gate" class="gate" aria-modal="true" role="dialog">
  <div class="gcard">
    <h3 style="margin:.1rem 0 .4rem">Acceso</h3>
    <p style="opacity:.8">Introduce el PIN para editar:</p>
    <input id="pin" class="pin" type="password" inputmode="numeric" maxlength="6" placeholder="••••">
    <div style="display:flex;gap:.35rem;margin-top:10px">
      <button id="enter" class="btn btn-w" style="flex:1">Entrar</button>
      <button id="clearPin" class="btn btn-g" style="flex:.8">Limpiar</button>
    </div>
    <p id="pinMsg" style="color:#ff7b7b;margin:.45rem 0 0;display:none">PIN incorrecto</p>
  </div>
</div>

<!-- ==================== SCRIPT ==================== -->
<script>
/* ========= CONFIGURA AQUI TU BACKEND =========
   Pega la URL del despliegue WebApp de Apps Script (Code.gs)
   (Debe terminar en /exec) */
const CLOUD_URL = 'PEGAR_AQUI_TU_WEB_APP_URL';   // <-- REEMPLAZA ESTO
const EDITOR_NAME = 'AROJAS';                     // quién aparece en el bloqueo
/* ============================================= */

/* PIN (SHA-256 de '4321') */
const PIN_SHA256='fe2592b42a727e977f055947385b709cc82b16b9a87f88c6abf3900d65d0cdc3';
const APP_VERSION='vCloud';

/* ====== utils ====== */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const now=()=>new Date().toLocaleString();
async function sha256Hex(str){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(str));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}
function toast(m){const t=document.createElement('div');t.textContent=m;Object.assign(t.style,{position:'fixed',bottom:'10px',left:'50%',transform:'translateX(-50%)',background:'#111',color:'#fff',padding:'6px 9px',borderRadius:'8px',zIndex:90,opacity:.95,fontSize:'11px'});document.body.appendChild(t);setTimeout(()=>t.remove(),1200);}

/* ====== datos base ====== */
function sheetVA(n){const rows=Array.from({length:300},()=>({centro:'',delegado:'',audiologo:'',tipo:'Sucursal',fecha:'',puntuacion:null,hit:false,conv_prueba:null,conv_venta:null}));return{nombre:n,rows};}
function rowsFM(){return Array.from({length:300},()=>({fecha:'',tema:'',audiologo:'',duracion:1,p_ini:null,v_ini:null,p_3m:null,v_3m:null}));}
function sheetTA(n){const rows=Array.from({length:300},()=>({centro:'',delegado:'',rol:'Audiólogo',persona:'',formacion:false,practicas:false,certificado:false,pruebas:false,ventas:false,obs:''}));return{nombre:n,rows};}
function equiposInit(){const filas=Array.from({length:25},()=>({equipo:'',serie:'',persona:'',fecha:'',pares:[{centro:'',en:false,sede:false},{centro:'',en:false,sede:false},{centro:'',en:false,sede:false}]}));return{columnas:3,filas};}
let data={
 "CENTROS EXCLUSIVOS":[{nombre:"Reina Mercedes",delegado:"",audiologo:"",tipo:"Franquicia",
   acciones:Array.from({length:12},()=>({fecha:'',paquete:'1',tipo:'Azafata/Buzoneo',derivacion:null,citas:null,venta:null,obs:''})),
   formaciones:Array.from({length:5},()=>({curso:'',realizado:false,aplica:false,obs:''})),
   procesos:Array.from({length:4},()=>({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null}))}],
 "CENTROS FLOP":[],
 "VISITAS AUDIO":[{rol:"Delegado audio",responsable:"",hojas:[sheetVA("Visita 1")]}],
 "FORMACIONES Y MENTORING":[{delegado:"",filas:rowsFM()}],
 "TELEAUDIOLOGIA":[{hojas:[sheetTA("Tele 1")]}],
 "EQUIPOS":[equiposInit()]
};
let state={selected:{section:null,index:null},vaSheet:0,vaFilter:'',fmFilter:'',taFilter:'',taPerson:'',eqFilter:''};

/* ====== CLOUD API (no localStorage) ====== */
async function cloudLoad(){
  if(!CLOUD_URL||!/^https?:\/\//.test(CLOUD_URL)) { toast('Configura CLOUD_URL'); return; }
  const r = await fetch(CLOUD_URL+'?action=load',{cache:'no-store'});
  if(!r.ok) throw new Error('Carga fallida');
  const txt = await r.text();
  if(txt) data = JSON.parse(txt);
  renderAll(); $('#stamp').textContent=APP_VERSION+' · Cargado: '+now();
}
async function cloudSave(){
  const r = await fetch(CLOUD_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'save',data})});
  if(!r.ok) throw new Error('Guardado fallido');
  const res=await r.json();
  $('#stamp').textContent=APP_VERSION+' · Guardado: '+(res.updated_at||now());
  toast('Guardado en la nube');
}
async function cloudLock(mode='lock'){
  const r=await fetch(CLOUD_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'lock',mode,user:EDITOR_NAME})});
  return r.json();
}
async function cloudStatus(){
  const r=await fetch(CLOUD_URL+'?action=status',{cache:'no-store'});
  return r.json();
}

/* ====== sidebar/render ====== */
const SECTIONS=["CENTROS EXCLUSIVOS","CENTROS FLOP","VISITAS AUDIO","FORMACIONES Y MENTORING","TELEAUDIOLOGIA","EQUIPOS"];
const esc=s=>(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
function renderLeft(){
  SECTIONS.forEach(name=>{
    const box=document.querySelector(`.card[data-section="${name}"]`);
    const list=box.querySelector('.side-list'); list.innerHTML='';
    (data[name]||[]).forEach((it,i)=>{
      const div=document.createElement('div');div.className='item';div.dataset.index=i;
      let html='';
      if(name.includes('CENTROS')) html=`<div><div class="name">${esc(it.nombre||'—')}</div><small>Delegado: ${esc(it.delegado||'—')} · Aud.: ${esc(it.audiologo||'—')}</small></div>`;
      else if(name==="VISITAS AUDIO") html=`<div><div class="name">(${esc(it.rol||'Rol')}) ${esc(it.responsable||'—')}</div><small>Visitas</small></div>`;
      else if(name==="FORMACIONES Y MENTORING") html=`<div><div class="name">${esc(it.delegado||'(Delegado regional)')}</div></div>`;
      else if(name==="TELEAUDIOLOGIA") html=`<div><div class="name">Teleaudiología</div></div>`;
      else html=`<div><div class="name">Inventario de equipos</div></div>`;
      div.innerHTML=html+`<div><button class="side-btn" data-role="edit">✏️</button><button class="side-btn" data-role="del">🗑️</button></div>`;
      div.addEventListener('dblclick',()=>{state.selected={section:name,index:i}; renderDetail();});
      div.querySelector('[data-role="edit"]').onclick=(e)=>{e.stopPropagation();state.selected={section:name,index:i};renderDetail();};
      div.querySelector('[data-role="del"]').onclick=(e)=>{e.stopPropagation();if(confirm('¿Eliminar?')){data[name].splice(i,1);renderAll();}};
      list.appendChild(div);
    });
    box.querySelector('[data-act="toggle"]').onclick=()=>{list.style.display=list.style.display==='none'?'':'none'; if(list.style.display==='none'&&name.includes('CENTROS')){state.selected={section:null,index:null}; renderDetailBlank();}};
    box.querySelector('[data-act="add"]').onclick=()=>{
      let nuevo;
      if(name.includes('CENTROS')) nuevo={nombre:'(nuevo centro)',delegado:'',audiologo:'',tipo:'Franquicia',
        acciones:Array.from({length:12},()=>({fecha:'',paquete:'1',tipo:'Azafata/Buzoneo',derivacion:null,citas:null,venta:null,obs:''})),
        formaciones:Array.from({length:5},()=>({curso:'',realizado:false,aplica:false,obs:''})),
        procesos:Array.from({length:4},()=>({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null}))};
      else if(name==="VISITAS AUDIO") nuevo={rol:'Delegado audio',responsable:'',hojas:[sheetVA('Visita 1')]};
      else if(name==="FORMACIONES Y MENTORING") nuevo={delegado:'(Delegado regional)',filas:rowsFM()};
      else if(name==="TELEAUDIOLOGIA") nuevo={hojas:[sheetTA('Tele 1')]};
      else nuevo=equiposInit();
      data[name].push(nuevo); renderAll();
    };
  });
}
function renderDetailBlank(){
  $('#hint').style.display='block'; $('#hdrTag').textContent='—'; $('#hdrName').textContent='—';
  $('#detCentro,#detVisitas,#detFormaciones,#detTele,#detEquipos').forEach?.(()=>{}) // noop
  $('#detCentro').style.display='none'; $('#detVisitas').style.display='none'; $('#detFormaciones').style.display='none'; $('#detTele').style.display='none'; $('#detEquipos').style.display='none';
}
function tone(s){const d=$('#detail'); d.style.background = s==="CENTROS EXCLUSIVOS"?'var(--col-ex)': s==="CENTROS FLOP"?'var(--col-fl)': s==="VISITAS AUDIO"?'var(--col-va)': s==="FORMACIONES Y MENTORING"?'var(--col-fm)': s==="TELEAUDIOLOGIA"?'var(--col-ta)':'var(--col-eq)';}
function cur(){return data[state.selected.section]?.[state.selected.index];}
function renderDetail(){
  $('#hint').style.display='none';
  const s=state.selected.section; tone(s); $('#hdrTag').textContent=s||'—';
  $('#btnSavePanel').onclick = s?.includes('CENTROS') ? saveCentro : cloudSave;
  $('#hdrName').textContent = (s && s.includes('CENTROS'))?(cur()?.nombre||'—'):'—';
  $('#detCentro').style.display = s?.includes('CENTROS')?'block':'none';
  $('#detVisitas').style.display = s==='VISITAS AUDIO'?'block':'none';
  $('#detFormaciones').style.display = s==='FORMACIONES Y MENTORING'?'block':'none';
  $('#detTele').style.display = s==='TELEAUDIOLOGIA'?'block':'none';
  $('#detEquipos').style.display = s==='EQUIPOS'?'block':'none';
  if(s?.includes('CENTROS')) fillCentro();
  if(s==='VISITAS AUDIO') fillVA();
  if(s==='FORMACIONES Y MENTORING') fillFM();
  if(s==='TELEAUDIOLOGIA') fillTA();
  if(s==='EQUIPOS') fillEQ();
}

/* ===== Centros ===== */
function fillCentro(){const it=cur(); $('#cNombre').value=it.nombre||''; $('#cDelegado').value=it.delegado||''; $('#cAudiologo').value=it.audiologo||''; $('#cTipo').value=it.tipo||'Franquicia'; renderAcc(); renderFrm(); renderProc();}
function saveCentro(){const it=cur(); it.nombre=$('#cNombre').value.trim(); it.delegado=$('#cDelegado').value.trim(); it.audiologo=$('#cAudiologo').value.trim(); it.tipo=$('#cTipo').value; $('#hdrName').textContent=it.nombre||'—'; cloudSave();}
function accRow(r,i){return `<div>${i+1}</div><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}"><select data-i="${i}" data-k="paquete"><option ${r.paquete==='1'?'selected':''}>1</option><option ${r.paquete==='2'?'selected':''}>2</option><option ${r.paquete==='3'?'selected':''}>3</option></select><select data-i="${i}" data-k="tipo"><option ${r.tipo==='Azafata/Buzoneo'?'selected':''}>Azafata/Buzoneo</option><option ${r.tipo==='Stand'?'selected':''}>Stand</option><option ${r.tipo==='Mailing/Cashback'?'selected':''}>Mailing/Cashback</option><option ${r.tipo==='Otros'?'selected':''}>Otros</option></select><input type="number" min="0" step="1" data-i="${i}" data-k="derivacion" value="${r.derivacion??''}"><input type="number" min="0" step="1" data-i="${i}" data-k="citas" value="${r.citas??''}"><input type="number" min="0" step="1" data-i="${i}" data-k="venta" value="${r.venta??''}"><input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}"><button class="side-btn" data-del="${i}">🗑️</button>`;}
function renderAcc(){const it=cur(); const c=$('#accionesRows'); c.innerHTML=''; it.acciones.forEach((r,i)=>{const d=document.createElement('div');d.className='grid acc-r';d.innerHTML=accRow(r,i);c.appendChild(d);});}
$('#accAdd').onclick=()=>{cur().acciones.push({fecha:'',paquete:'1',tipo:'Azafata/Buzoneo',derivacion:null,citas:null,venta:null,obs:''});renderAcc();};
$('#accionesRows').addEventListener('click',e=>{if(e.target.dataset.del!=null){cur().acciones.splice(+e.target.dataset.del,1);renderAcc();}});
$('#accionesRows').addEventListener('input',e=>{const i=e.target.dataset.i,k=e.target.dataset.k;if(i==null||!k)return;const r=cur().acciones[+i];r[k]=e.target.type==='number'?(e.target.value===''?null:Number(e.target.value)):e.target.value;});

function frmRow(r,i){return `<div>${i+1}</div><input data-i="${i}" data-k="curso" value="${esc(r.curso||'')}"><input type="checkbox" data-i="${i}" data-k="realizado" ${r.realizado?'checked':''}><input type="checkbox" data-i="${i}" data-k="aplica" ${r.aplica?'checked':''}><input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}"><button class="side-btn" data-fdel="${i}">🗑️</button>`;}
function renderFrm(){const it=cur(); const c=$('#formacionesRows'); c.innerHTML=''; it.formaciones.forEach((r,i)=>{const d=document.createElement('div');d.className='grid frm-r';d.innerHTML=frmRow(r,i);c.appendChild(d);});}
$('#frmAdd').onclick=()=>{cur().formaciones.push({curso:'',realizado:false,aplica:false,obs:''});renderFrm();};
$('#formacionesRows').addEventListener('click',e=>{if(e.target.dataset.fdel!=null){cur().formaciones.splice(+e.target.dataset.fdel,1);renderFrm();}});
$('#formacionesRows').addEventListener('input',e=>{const i=e.target.dataset.i,k=e.target.dataset.k;if(i==null||!k)return;const r=cur().formaciones[+i];r[k]=e.target.type==='checkbox'?e.target.checked:e.target.value;});

function class95(v){const n=Number(v);if(!Number.isFinite(n))return'';return n>=95?'good':'bad'}
function class80(v){const n=Number(v);if(!Number.isFinite(n))return'';return n>=80?'good':'bad'}
function procRow(r,i){const has=r.adjunto&&r.adjunto.data;return `<div>${i+1}</div><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}"><input class="pscore ${class95(r.puntuacion)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="puntuacion" value="${r.puntuacion??''}"><div class="hitcell ${r.hit?'on':''}"><input type="checkbox" data-i="${i}" data-k="hit" ${r.hit?'checked':''}></div><input type="checkbox" data-i="${i}" data-k="rt" ${r.rt?'checked':''}><input class="conv ${class80(r.pruebas)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="pruebas" value="${r.pruebas??''}"><input class="conv ${class80(r.venta)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="venta" value="${r.venta??''}"><input data-i="${i}" data-k="colab" value="${esc(r.colab||'')}"><input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}"><span><button class="side-btn" data-adj="${i}">📎</button>${has?`<a class="side-btn" style="text-decoration:none;text-align:center" href="${r.adjunto.data}" download="${esc(r.adjunto.name||'adjunto')}" target="_blank">🔗</a>`:''}<input type="file" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" data-file="${i}" style="display:none"></span><button class="side-btn" data-pdel="${i}">🗑️</button>`;}
function renderProc(){const it=cur(); const c=$('#procesosRows'); c.innerHTML=''; it.procesos.forEach((r,i)=>{const d=document.createElement('div');d.className='grid proc-r';d.innerHTML=procRow(r,i);c.appendChild(d);});}
$('#procAdd').onclick=()=>{cur().procesos.push({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null});renderProc();};
$('#procesosRows').addEventListener('click',e=>{
  if(e.target.dataset.pdel!=null){cur().procesos.splice(+e.target.dataset.pdel,1);renderProc();return;}
  if(e.target.dataset.adj!=null){$(`[data-file="${e.target.dataset.adj}"]`,$('#procesosRows')).click();}
});
$('#procesosRows').addEventListener('change',e=>{
  const i=e.target.dataset.file; if(i==null) return; const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=()=>{cur().procesos[+i].adjunto={name:f.name,data:rd.result}; renderProc();}; rd.readAsDataURL(f);
});
$('#procesosRows').addEventListener('input',e=>{
  const i=e.target.dataset.i,k=e.target.dataset.k;if(i==null||!k)return;const r=cur().procesos[+i];
  if(e.target.type==='checkbox'){r[k]=e.target.checked; if(k==='hit') e.target.closest('.hitcell')?.classList.toggle('on',e.target.checked);}
  else if(e.target.type==='number'){r[k]=e.target.value===''?null:Number(e.target.value); if(k==='puntuacion') e.target.className='pscore '+class95(r[k]); if(k==='pruebas'||k==='venta') e.target.className='conv '+class80(r[k]);}
  else r[k]=e.target.value;
});

/* ===== Visitas ===== */
function fillVA(){const it=cur(); $('#vaRol').value=it.rol||'Delegado audio'; $('#vaResp').value=it.responsable||''; $('#vaSearch').value=state.vaFilter||''; vaTabs(); vaRender();}
$('#vaRol').onchange=e=>{cur().rol=e.target.value;};
$('#vaResp').oninput=e=>{cur().responsable=e.target.value;};
$('#vaSearch').oninput=e=>{state.vaFilter=e.target.value.trim(); vaRender();};
function vaTabs(){const it=cur(); const t=$('#vaTabs'); t.innerHTML=''; it.hojas=it.hojas||[sheetVA('Visita 1')];
  it.hojas.forEach((h,idx)=>{const b=document.createElement('button');b.className='side-btn';b.textContent=h.nombre||('Visita '+(idx+1)); if(idx===state.vaSheet) b.style.background='#f1f1f1'; b.onclick=()=>{state.vaSheet=idx; vaRender();}; t.appendChild(b);});
  const add=document.createElement('button'); add.className='side-btn'; add.textContent='＋'; add.onclick=()=>{it.hojas.push(sheetVA('Visita '+(it.hojas.length+1))); state.vaSheet=it.hojas.length-1; vaTabs(); vaRender();}; t.appendChild(add);
}
function vaSummary(h){const visited=h.rows.filter(r=>(r.fecha||'').trim()!==''); const unique=new Set(visited.map(r=>(r.centro||'').trim()).filter(Boolean)); const p=Math.min(100,Math.round(visited.length*100/h.rows.length)); $('#vaRightBar').style.width=p+'%'; $('#vaRightCount').textContent=`${visited.length} registradas`;}
function v80(v){const n=Number(v);return Number.isFinite(n)&&n>=80?'good':(Number.isFinite(n)?'bad':'')}
function v85(v){const n=Number(v);return Number.isFinite(n)&&n>=85?'good':(Number.isFinite(n)?'bad':'')}
function vaRender(){const it=cur(); const h=it.hojas[state.vaSheet]||it.hojas[0]; const f=(state.vaFilter||'').toLowerCase(); const c=$('#vaRows'); c.innerHTML=''; vaSummary(h);
  h.rows.forEach((r,i)=>{if(f && !(r.centro||'').toLowerCase().includes(f)) return; const d=document.createElement('div'); d.className='grid va-r';
    d.innerHTML=`<div>${i+1}</div><input data-i="${i}" data-k="centro" value="${esc(r.centro||'')}"><input data-i="${i}" data-k="delegado" value="${esc(r.delegado||'')}"><input data-i="${i}" data-k="audiologo" value="${esc(r.audiologo||'')}"><select data-i="${i}" data-k="tipo"><option ${r.tipo==='Sucursal'?'selected':''}>Sucursal</option><option ${r.tipo==='Franquicia'?'selected':''}>Franquicia</option></select><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}"><input class="pscore ${v85(r.puntuacion)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="puntuacion" value="${r.puntuacion??''}"><div class="hitcell ${r.hit?'on':''}"><input type="checkbox" data-i="${i}" data-k="hit" ${r.hit?'checked':''}></div><input class="conv ${v80(r.conv_prueba)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="conv_prueba" value="${r.conv_prueba??''}"><input class="conv ${v80(r.conv_venta)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="conv_venta" value="${r.conv_venta??''}">`; c.appendChild(d);
  });
}
$('#vaRows').addEventListener('input',e=>{const i=+e.target.dataset.i,k=e.target.dataset.k;if(!k)return;const h=cur().hojas[state.vaSheet]; if(e.target.type==='number')h.rows[i][k]=e.target.value===''?null
