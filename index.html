<script>
  // =========================
  // CONFIG
  // =========================
  const PIN_MASTER = "AR4321";
  const pinInput = document.getElementById("pinInput");
  const pinBtn = document.getElementById("pinBtn");
  const editStatus = document.getElementById("editStatus");
  const contentWrap = document.getElementById("contentWrap");
  const contentHolder = document.getElementById("contentHolder");
  const leftPanel = document.getElementById("leftPanel");
  const badgeColor = document.getElementById("badgeColor");
  const sectionTitle = document.getElementById("sectionTitle");
  const addBlock = document.getElementById("addBlock");

  let editable = false;

  // =========================
  // DATOS INICIALES
  // =========================
  let blocks =
    JSON.parse(localStorage.getItem("audioar_blocks") || "null") || {
      "OBJETIVOS": {
        color: "var(--obj)",
        items: [
          {
            titulo: "Ventas Q4",
            detalle: "Objetivo 140% sobre 2024",
            fecha: "2025-11-02",
          },
        ],
      },
      "CENTROS EXCLUSIVOS": {
        color: "var(--cex)",
        selected: 0,
        view: "acciones",
        centers: [
          {
            nombre: "Centro 1",
            delegado: "",
            audiologo: "",
            tipo: "Sucursal",
            acciones: [
              {
                tipo: "Seguimiento aud√≠fonos",
                fecha: "2025-11-03",
                derivaciones: "2",
                citas: "3",
                ventas: "1",
                obs: "Potencial en ORL",
              },
            ],
            formaciones: [
              {
                curso: "Teleaudiometr√≠a avanzada",
                superado: "S√≠",
                aplicado: "S√≠",
                mentoring: "No",
              },
            ],
            visitas: [
              {
                fecha: "2025-11-02",
                checklist: "90",
                convPrueba: "85",
                convVenta: "80",
              },
            ],
          },
        ],
      },
      "CENTROS FLOP": {
        color: "var(--cflop)",
        selected: 0,
        view: "acciones",
        centers: [
          {
            nombre: "Centro Tetu√°n",
            delegado: "",
            audiologo: "",
            tipo: "Franquicia",
            acciones: [
              {
                tipo: "Alerta baja conversi√≥n",
                fecha: "2025-11-05",
                derivaciones: "0",
                citas: "1",
                ventas: "0",
                obs: "Revisar argumentario",
              },
            ],
            formaciones: [
              {
                curso: "ACE / Rehabilitaci√≥n",
                superado: "No",
                aplicado: "No",
                mentoring: "S√≠",
              },
            ],
            visitas: [
              {
                fecha: "2025-11-05",
                checklist: "70",
                convPrueba: "60",
                convVenta: "50",
              },
            ],
          },
        ],
      },
      "FORMACIONES Y MENTORING": {
        color: "var(--form)",
        items: [
          {
            titulo: "Mentoring MED-EL + Starkey",
            detalle: "DualSync / streaming bimodal",
            fecha: "2025-11-04",
          },
        ],
      },
      "VISITAS": {
        color: "var(--vis)",
        items: [
          {
            titulo: "Visita ORL Dr. L√≥pez",
            detalle: "Presentar dossier colaboraci√≥n",
            fecha: "2025-11-06",
          },
        ],
      },
    };

  let currentBlock = "OBJETIVOS";

  // =========================
  // HELPERS
  // =========================
  function persist() {
    localStorage.setItem("audioar_blocks", JSON.stringify(blocks));
  }

  function setEditable(on) {
    editable = on;
    editStatus.textContent = on ? "Edici√≥n activada" : "Solo lectura";
    editStatus.style.background = on
      ? "rgba(11,160,72,0.1)"
      : "rgba(0,0,0,0.2)";
    renderCurrentBlock();
  }

  // =========================
  // RENDER OBJETIVOS
  // =========================
  function renderObjectives(data) {
    contentHolder.innerHTML = "";
    const list = document.createElement("div");
    list.className = "list";

    data.items.forEach((item, idx) => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="item-header">
          <strong>${item.titulo}</strong>
          ${
            editable
              ? `<div class="item-actions">
                  <button class="ghost-icon" data-act="edit-obj" data-idx="${idx}">‚úè</button>
                  <button class="ghost-icon" data-act="add-obj" data-idx="${idx}">Ôºã</button>
                  <button class="ghost-icon" data-act="del-obj" data-idx="${idx}">‚àí</button>
                </div>`
              : ""
          }
        </div>
        <small>${item.detalle}</small>
        <small>üìÖ ${item.fecha || ""}</small>
      `;
      list.appendChild(div);
    });

    if (editable) {
      const addBtn = document.createElement("button");
      addBtn.textContent = "+ A√±adir objetivo";
      addBtn.className = "tiny-btn";
      addBtn.onclick = () => {
        data.items.push({ titulo: "Nuevo objetivo", detalle: "", fecha: "" });
        persist();
        renderCurrentBlock();
      };
      list.appendChild(addBtn);
    }

    contentHolder.appendChild(list);
  }

  // =========================
  // RENDER CENTROS (EXCLUSIVOS / FLOP)
  // =========================
  function renderCentersBlock(blockName, data) {
    contentHolder.innerHTML = "";

    const wrap = document.createElement("div");
    wrap.className = "flex-split";

    // panel de centros (izquierda)
    const left = document.createElement("div");
    left.className = "centers-list";
    left.innerHTML = `
      <div class="centers-list-header">
        <strong>Centros</strong>
        <div>
          <button class="centers-toggle" data-act="toggle-centers">‚ñº</button>
          ${editable ? `<button class="tiny-btn" data-act="add-center">+ A√±adir</button>` : ""}
        </div>
      </div>
    `;
    const centersBox = document.createElement("div");
    (data.centers || []).forEach((c, idx) => {
      const ci = document.createElement("div");
      ci.className =
        "center-item" + (idx === (data.selected || 0) ? " active" : "");
      ci.dataset.idx = idx;
      ci.innerHTML = `
        <span>${c.nombre}</span>
        ${
          editable
            ? `<span>
                <button class="ghost-icon" data-act="edit-center" data-idx="${idx}">‚úè</button>
                <button class="ghost-icon" data-act="del-center" data-idx="${idx}">‚àí</button>
               </span>`
            : ""
        }
      `;
      centersBox.appendChild(ci);
    });
    left.appendChild(centersBox);
    wrap.appendChild(left);

    // derecha (detalle)
    const right = document.createElement("div");
    right.className = "center-right";

    const sel = data.selected || 0;
    const center =
      data.centers[sel] || {
        nombre: "",
        delegado: "",
        audiologo: "",
        tipo: "Sucursal",
        acciones: [],
        formaciones: [],
        visitas: [],
      };

    if (!data.view) data.view = "acciones";

    // submen√∫ negro
    const subnav = document.createElement("div");
    subnav.className = "center-subnav";
    subnav.innerHTML = `
      <button data-sub="acciones" class="${
        data.view === "acciones" ? "active" : ""
      }">üìã Acciones</button>
      <button data-sub="formaciones" class="${
        data.view === "formaciones" ? "active" : ""
      }">üìö Formaciones y refuerzo</button>
      <button data-sub="visitas" class="${
        data.view === "visitas" ? "active" : ""
      }">üóìÔ∏è Visitas</button>
    `;
    right.appendChild(subnav);

    const mainContent = document.createElement("div");
    mainContent.className = "center-content";

    // datos fijos
    const info = document.createElement("div");
    info.className = "grid-3";
    info.innerHTML = `
      <div class="field">
        <label>Nombre del centro</label>
        <input ${editable ? "" : "disabled"} data-field="nombre" value="${
      center.nombre || ""
    }">
      </div>
      <div class="field">
        <label>Delegado</label>
        <input ${editable ? "" : "disabled"} data-field="delegado" value="${
      center.delegado || ""
    }">
      </div>
      <div class="field">
        <label>Audi√≥logo</label>
        <input ${editable ? "" : "disabled"} data-field="audiologo" value="${
      center.audiologo || ""
    }">
      </div>
      <div class="field">
        <label>Sucursal / Franquicia</label>
        <select ${editable ? "" : "disabled"} data-field="tipo">
          <option value="Sucursal" ${
            center.tipo === "Sucursal" ? "selected" : ""
          }>Sucursal</option>
          <option value="Franquicia" ${
            center.tipo === "Franquicia" ? "selected" : ""
          }>Franquicia</option>
        </select>
      </div>
    `;
    mainContent.appendChild(info);

    // vista din√°mica
    if (data.view === "acciones") {
      const box = document.createElement("div");
      box.innerHTML = `
        <div class="table-toolbar">
          <strong>Acciones</strong>
          ${
            editable
              ? `<button class="tiny-btn" data-act="add-accion">+ Acci√≥n</button>`
              : ""
          }
        </div>
      `;
      const t = document.createElement("table");
      t.className = "table-like";
      t.innerHTML = `
        <thead>
          <tr>
            <th>Tipo de acci√≥n</th>
            <th>Fecha</th>
            <th>Derivaciones</th>
            <th>Citas</th>
            <th>Ventas</th>
            <th>Observaciones</th>
            ${editable ? `<th></th>` : ""}
          </tr>
        </thead>
        <tbody>
          ${(center.acciones || [])
            .map((a, i) => {
              return `
                <tr data-row="${i}" data-table="acciones">
                  <td contenteditable="${editable}">${a.tipo || ""}</td>
                  <td contenteditable="${editable}">${a.fecha || ""}</td>
                  <td contenteditable="${editable}">${a.derivaciones || ""}</td>
                  <td contenteditable="${editable}">${a.citas || ""}</td>
                  <td contenteditable="${editable}">${a.ventas || ""}</td>
                  <td contenteditable="${editable}">${a.obs || ""}</td>
                  ${
                    editable
                      ? `<td><button class="ghost-icon" data-act="del-row">‚àí</button></td>`
                      : ""
                  }
                </tr>
              `;
            })
            .join("")}
        </tbody>
      `;
      box.appendChild(t);
      mainContent.appendChild(box);
    } else if (data.view === "formaciones") {
      const box = document.createElement("div");
      box.innerHTML = `
        <div class="table-toolbar">
          <strong>Formaciones y refuerzo</strong>
          ${
            editable
              ? `<button class="tiny-btn" data-act="add-forma">+ Formaci√≥n</button>`
              : ""
          }
        </div>
      `;
      const t = document.createElement("table");
      t.className = "table-like";
      t.innerHTML = `
        <thead>
          <tr>
            <th>Curso relevante</th>
            <th>Superado</th>
            <th>Aplicado</th>
            <th>Mentoring-Coaching</th>
            ${editable ? `<th></th>` : ""}
          </tr>
        </thead>
        <tbody>
          ${(center.formaciones || [])
            .map((f, i) => {
              return `
                <tr data-row="${i}" data-table="formaciones">
                  <td contenteditable="${editable}">${f.curso || ""}</td>
                  <td contenteditable="${editable}">${f.superado || "No"}</td>
                  <td contenteditable="${editable}">${f.aplicado || "No"}</td>
                  <td contenteditable="${editable}">${f.mentoring || "No"}</td>
                  ${
                    editable
                      ? `<td><button class="ghost-icon" data-act="del-row">‚àí</button></td>`
                      : ""
                  }
                </tr>
              `;
            })
            .join("")}
        </tbody>
      `;
      box.appendChild(t);
      mainContent.appendChild(box);
    } else if (data.view === "visitas") {
      const box = document.createElement("div");
      box.innerHTML = `
        <div class="table-toolbar">
          <strong>Visitas</strong>
          ${
            editable
              ? `<button class="tiny-btn" data-act="add-visita">+ Visita</button>`
              : ""
          }
        </div>
      `;
      const t = document.createElement("table");
      t.className = "table-like";
      t.innerHTML = `
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Checklist %</th>
            <th>Estado</th>
            <th>Conv. prueba %</th>
            <th>Conv. venta %</th>
            ${editable ? `<th></th>` : ""}
          </tr>
        </thead>
        <tbody>
          ${(center.visitas || [])
            .map((v, i) => {
              const estado =
                Number(v.checklist || 0) < 85
                  ? '<span class="badge-bad">ROJO</span>'
                  : '<span class="badge-ok">VERDE</span>';
              const clasePrueba =
                Number(v.convPrueba || 0) < 80 ? "text-red" : "text-green";
              const claseVenta =
                Number(v.convVenta || 0) < 80 ? "text-red" : "text-green";
              return `
                <tr data-row="${i}" data-table="visitas">
                  <td contenteditable="${editable}">${v.fecha || ""}</td>
                  <td contenteditable="${editable}">${v.checklist || ""}</td>
                  <td>${estado}</td>
                  <td contenteditable="${editable}" class="${clasePrueba}">${
                v.convPrueba || ""
              }</td>
                  <td contenteditable="${editable}" class="${claseVenta}">${
                v.convVenta || ""
              }</td>
                  ${
                    editable
                      ? `<td><button class="ghost-icon" data-act="del-row">‚àí</button></td>`
                      : ""
                  }
                </tr>
              `;
            })
            .join("")}
        </tbody>
      `;
      box.appendChild(t);
      mainContent.appendChild(box);
    }

    right.appendChild(mainContent);
    wrap.appendChild(right);
    contentHolder.appendChild(wrap);
  }

  // =========================
  // RENDER BLOQUES SIMPLES
  // =========================
  function renderSimple(data) {
    contentHolder.innerHTML = "";
    const list = document.createElement("div");
    list.className = "list";

    (data.items || []).forEach((item, idx) => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="item-header">
          <strong ${
            editable
              ? `contenteditable="true" data-idx="${idx}" data-field="titulo"`
              : ""
          }>${item.titulo}</strong>
          ${
            editable
              ? `<div class="item-actions">
                  <button class="tiny-btn" data-act="del-simple" data-idx="${idx}">‚úñ</button>
                 </div>`
              : ""
          }
        </div>
        <small ${
          editable
            ? `contenteditable="true" data-idx="${idx}" data-field="detalle"`
            : ""
        }>${item.detalle}</small>
        <small>üìÖ <span ${
          editable
            ? `contenteditable="true" data-idx="${idx}" data-field="fecha"`
            : ""
        }>${item.fecha || ""}</span></small>
      `;
      list.appendChild(div);
    });

    if (editable) {
      const addBtn = document.createElement("button");
      addBtn.textContent = "+ A√±adir elemento";
      addBtn.className = "tiny-btn";
      addBtn.onclick = () => {
        data.items.push({ titulo: "Nuevo", detalle: "", fecha: "" });
        persist();
        renderCurrentBlock();
      };
      list.appendChild(addBtn);
    }

    contentHolder.appendChild(list);
  }

  // =========================
  // RENDER GENERAL
  // =========================
  function renderCurrentBlock() {
    const data = blocks[currentBlock];
    if (!data) return;
    badgeColor.style.background = data.color || "#fff";
    sectionTitle.textContent = currentBlock;
    if (!editable) contentWrap.classList.add("locked");
    else contentWrap.classList.remove("locked");

    if (currentBlock === "OBJETIVOS") renderObjectives(data);
    else if (
      currentBlock === "CENTROS EXCLUSIVOS" ||
      currentBlock === "CENTROS FLOP"
    )
      renderCentersBlock(currentBlock, data);
    else renderSimple(data);
  }

  // =========================
  // EVENTOS PIN
  // =========================
  pinBtn.addEventListener("click", () => {
    const val = pinInput.value.trim();
    if (val === PIN_MASTER) setEditable(true);
    else {
      alert("PIN incorrecto. Usa AR4321");
      setEditable(false);
    }
  });

  pinInput.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter") {
      const val = pinInput.value.trim();
      if (val === PIN_MASTER) setEditable(true);
      else {
        alert("PIN incorrecto. Usa AR4321");
        setEditable(false);
      }
    }
  });

  // =========================
  // EVENTOS LADO IZQUIERDO
  // =========================
  leftPanel.addEventListener("click", (e) => {
    const btn = e.target.closest(".block-btn");
    if (!btn) return;
    document.querySelectorAll(".block-btn").forEach((b) => {
      b.classList.remove("active");
    });
    btn.classList.add("active");
    currentBlock = btn.dataset.type;
    renderCurrentBlock();
  });

  // a√±adir bloque nuevo
  addBlock.addEventListener("click", () => {
    if (!editable) return alert("Primero desbloquea edici√≥n con el PIN AR4321.");
    const name = prompt("Nombre del nuevo bloque:");
    if (!name) return;
    blocks[name] = { color: "#fff5d9", items: [] };
    persist();
    const btn = document.createElement("button");
    btn.className = "block-btn";
    btn.dataset.type = name;
    btn.dataset.color = "#fff5d9";
    btn.innerHTML = `
      <div class="tag" style="background: rgba(0,0,0,0.04);">üÜï</div>
      <div>
        <div>${name}</div>
        <small>Nuevo bloque</small>
      </div>
    `;
    leftPanel.appendChild(btn);
  });

  // =========================
  // EVENTOS CONTENIDO (CLICK)
  // =========================
  contentHolder.addEventListener("click", (e) => {
    const t = e.target;

    // OBJETIVOS
    if (t.dataset.act === "edit-obj") {
      const idx = +t.dataset.idx;
      const item = blocks["OBJETIVOS"].items[idx];
      const nt = prompt("T√≠tulo del objetivo", item.titulo || "");
      if (nt !== null) item.titulo = nt;
      const nd = prompt("Detalle / KPI", item.detalle || "");
      if (nd !== null) item.detalle = nd;
      const nf = prompt("Fecha", item.fecha || "");
      if (nf !== null) item.fecha = nf;
      persist();
      renderCurrentBlock();
      return;
    }
    if (t.dataset.act === "add-obj") {
      blocks["OBJETIVOS"].items.splice(+t.dataset.idx + 1, 0, {
        titulo: "Nuevo objetivo",
        detalle: "",
        fecha: "",
      });
      persist();
      renderCurrentBlock();
      return;
    }
    if (t.dataset.act === "del-obj") {
      blocks["OBJETIVOS"].items.splice(+t.dataset.idx, 1);
      persist();
      renderCurrentBlock();
      return;
    }

    // desplegar/plegar lista de centros
    if (t.dataset.act === "toggle-centers") {
      const panel = t.closest(".centers-list");
      panel.classList.toggle("collapsed");
      return;
    }

    // seleccionar centro
    if (
      t.closest(".center-item") &&
      (currentBlock === "CENTROS EXCLUSIVOS" ||
        currentBlock === "CENTROS FLOP")
    ) {
      const ci = t.closest(".center-item");
      const data = blocks[currentBlock];
      data.selected = +ci.dataset.idx;
      persist();
      renderCurrentBlock();
      return;
    }

    // cambiar subvista (acciones / formaciones / visitas)
    if (
      t.closest(".center-subnav") &&
      (currentBlock === "CENTROS EXCLUSIVOS" ||
        currentBlock === "CENTROS FLOP")
    ) {
      const btn = t.closest("button[data-sub]");
      if (btn) {
        const data = blocks[currentBlock];
        data.view = btn.dataset.sub;
        persist();
        renderCurrentBlock();
      }
      return;
    }

    // a√±adir centro
    if (t.dataset.act === "add-center") {
      const data = blocks[currentBlock];
      data.centers.push({
        nombre: "Centro nuevo",
        delegado: "",
        audiologo: "",
        tipo: "Sucursal",
        acciones: [],
        formaciones: [],
        visitas: [],
      });
      data.selected = data.centers.length - 1;
      persist();
      renderCurrentBlock();
      return;
    }

    // editar nombre centro
    if (t.dataset.act === "edit-center") {
      const data = blocks[currentBlock];
      const c = data.centers[+t.dataset.idx];
      const nn = prompt("Nombre del centro", c.nombre || "");
      if (nn !== null) c.nombre = nn;
      persist();
      renderCurrentBlock();
      return;
    }

    // borrar centro
    if (t.dataset.act === "del-center") {
      const data = blocks[currentBlock];
      data.centers.splice(+t.dataset.idx, 1);
      data.selected = 0;
      persist();
      renderCurrentBlock();
      return;
    }

    // a√±adir fila en tablas
    if (t.dataset.act === "add-accion") {
      const data = blocks[currentBlock];
      const c = data.centers[data.selected || 0];
      c.acciones.push({
        tipo: "",
        fecha: "",
        derivaciones: "",
        citas: "",
        ventas: "",
        obs: "",
      });
      persist();
      renderCurrentBlock();
      return;
    }
    if (t.dataset.act === "add-forma") {
      const data = blocks[currentBlock];
      const c = data.centers[data.selected || 0];
      c.formaciones.push({
        curso: "",
        superado: "No",
        aplicado: "No",
        mentoring: "No",
      });
      persist();
      renderCurrentBlock();
      return;
    }
    if (t.dataset.act === "add-visita") {
      const data = blocks[currentBlock];
      const c = data.centers[data.selected || 0];
      c.visitas.push({
        fecha: "",
        checklist: "",
        convPrueba: "",
        convVenta: "",
      });
      persist();
      renderCurrentBlock();
      return;
    }

    // borrar fila en tablas
    if (t.dataset.act === "del-row") {
      const tr = t.closest("tr");
      const data = blocks[currentBlock];
      const c = data.centers[data.selected || 0];
      const tableName = tr.dataset.table;
      const idx = +tr.dataset.row;
      c[tableName].splice(idx, 1);
      persist();
      renderCurrentBlock();
      return;
    }

    // borrar item simple (formaciones / visitas general)
    if (t.dataset.act === "del-simple") {
      const data = blocks[currentBlock];
      data.items.splice(+t.dataset.idx, 1);
      persist();
      renderCurrentBlock();
      return;
    }
  });

  // =========================
  // EVENTOS CONTENIDO (INPUT)
  // =========================
  contentHolder.addEventListener("input", (e) => {
    const t = e.target;

    // edici√≥n de campos fijos del centro
    if (
      (currentBlock === "CENTROS EXCLUSIVOS" ||
        currentBlock === "CENTROS FLOP") &&
      t.dataset.field
    ) {
      const data = blocks[currentBlock];
      const c = data.centers[data.selected || 0];
      c[t.dataset.field] = t.value;
      persist();
      return;
    }

    // edici√≥n de tablas
    const tr = t.closest("tr[data-table]");
    if (
      tr &&
      (currentBlock === "CENTROS EXCLUSIVOS" ||
        currentBlock === "CENTROS FLOP")
    ) {
      const data = blocks[currentBlock];
      const c = data.centers[data.selected || 0];
      const tableName = tr.dataset.table;
      const idx = +tr.dataset.row;
      const cells = tr.querySelectorAll("td[contenteditable='true']");

      if (tableName === "acciones") {
        const [tipo, fecha, derivaciones, citas, ventas, obs] = Array.from(
          cells
        ).map((x) => x.textContent.trim());
        c.acciones[idx] = {
          tipo,
          fecha,
          derivaciones,
          citas,
          ventas,
          obs,
        };
      } else if (tableName === "formaciones") {
        const [curso, superado, aplicado, mentoring] = Array.from(
          cells
        ).map((x) => x.textContent.trim());
        c.formaciones[idx] = {
          curso,
          superado,
          aplicado,
          mentoring,
        };
      } else if (tableName === "visitas") {
        // aqu√≠ la tabla tiene una celda fija de estado, por eso se salta
        const arr = Array.from(cells).map((x) => x.textContent.trim());
        const fecha = arr[0] || "";
        const checklist = arr[1] || "";
        const convPrueba = arr[2] || "";
        const convVenta = arr[3] || "";
        c.visitas[idx] = {
          fecha,
          checklist,
          convPrueba,
          convVenta,
        };
      }
      persist();
      return;
    }

    // edici√≥n de bloques simples
    if (t.dataset && typeof t.dataset.idx !== "undefined") {
      const idx = +t.dataset.idx;
      const field = t.dataset.field;
      const data = blocks[currentBlock];
      if (data && data.items && data.items[idx]) {
        data.items[idx][field] = t.textContent.trim();
        persist();
      }
    }
  });

  // =========================
  // DESCARGAS
  // =========================
  document.getElementById("btnHTML").addEventListener("click", () => {
    const blob = new Blob([document.documentElement.outerHTML], {
      type: "text/html",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "seguimiento-audio-ar.html";
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById("btnPDF").addEventListener("click", () => {
    alert("Exportar a PDF: usa Imprimir > Guardar como PDF.");
  });

  document.getElementById("btnXLS").addEventListener("click", () => {
    const rows = [["Bloque", "Campo1", "Campo2", "Campo3", "Campo4"]];
    Object.keys(blocks).forEach((bn) => {
      const b = blocks[bn];
      if (bn === "CENTROS EXCLUSIVOS" || bn === "CENTROS FLOP") {
        (b.centers || []).forEach((c) => {
          rows.push([bn, c.nombre, c.delegado, c.audiologo, c.tipo]);
        });
      } else {
        (b.items || []).forEach((it) => {
          rows.push([bn, it.titulo, it.detalle, it.fecha || "", ""]);
        });
      }
    });
    const csv = rows
      .map((r) =>
        r.map((v) => `"${(v || "").replace(/"/g, '""')}"`).join(",")
      )
      .join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "seguimiento-audio-ar.csv";
    a.click();
    URL.revokeObjectURL(url);
  });

  // =========================
  // TESTS R√ÅPIDOS
  // =========================
  function runSmokeTests() {
    console.log("[TEST] estructura b√°sica cargada");
    console.assert(
      !!document.getElementById("leftPanel"),
      "leftPanel no existe"
    );
    console.assert(
      !!document.getElementById("contentHolder"),
      "contentHolder no existe"
    );
  }

  // INICIO
  renderCurrentBlock();
  runSmokeTests();
</script>
