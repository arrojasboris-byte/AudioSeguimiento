<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control Center Audio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      /* PALETA DE COLORES */
      --bg-main: radial-gradient(circle at top left, #111827, #020617 55%);
      --bg-card: #020617;
      --bg-card-soft: #0b1120;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      
      /* ACENTOS */
      --accent-red: #ff2440;
      --accent-blue: #38bdf8;
      --accent-green: #22c55e;
      --accent-orange: #f97316;
      
      /* ESTADOS */
      --chip-pendiente: #facc15;
      --chip-enproceso: #4ade80;
      --chip-finalizada: #22c55e;
    }

    body.light {
      --bg-main: #f3f4f6;
      --bg-card: #ffffff;
      --bg-card-soft: #f9fafb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
    html, body { width: 100%; min-height: 100vh; overflow-x: hidden; }
    body { background: var(--bg-main); color: var(--text-main); display: flex; }

    /* --- SIDEBAR --- */
    .sidebar {
      width: 250px; background: #020617; border-right: 1px solid #020617;
      padding: 18px 18px 24px; display: flex; flex-direction: column; gap: 24px; color: #e5e7eb;
    }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-badge { width: 34px; height: 34px; border-radius: 999px; background: radial-gradient(circle at 30% 20%, #fee2e2, var(--accent-red)); }
    .logo-title { font-weight: 700; font-size: 1.05rem; }
    .logo-subtitle { font-size: .7rem; color: #9ca3af; }
    .section-title { font-size: .75rem; text-transform: uppercase; color: #6b7280; letter-spacing: .12em; margin-bottom: 8px; }
    
    .nav-list { display: flex; flex-direction: column; gap: 4px; }
    .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 8px 10px;
      border-radius: 999px; font-size: .88rem; color: #9ca3af; cursor: pointer; transition: all .18s ease;
    }
    .nav-item span.icon {
      width: 22px; height: 22px; border-radius: 999px; background: #020617;
      display: inline-flex; align-items: center; justify-content: center; font-size: .75rem;
    }
    .nav-item.active { background: linear-gradient(90deg, #ff2440, #fb7185); color: #111827; font-weight: 600; }
    .nav-item:hover:not(.active) { background: rgba(31,41,55,0.7); color: #e5e7eb; }
    body.light .nav-item:hover:not(.active) { background: rgba(15,23,42,0.2); }
    .sidebar-footer { margin-top: auto; font-size: .78rem; color: #9ca3af; }

    /* --- MAIN LAYOUT --- */
    .main { flex: 1; padding: 10px 18px 12px; display: flex; flex-direction: column; gap: 8px; max-width: 1600px; margin: 0 auto; }
    
    .topbar { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; flex-wrap: wrap; }
    .topbar-search { flex: 1 1 260px; position: relative; min-width: 220px; }
    .topbar-search input {
      width: 100%; border-radius: 999px; padding: 8px 14px 8px 30px;
      border: 1px solid var(--border-soft); background: var(--bg-card); color: var(--text-main); font-size: .86rem; outline: none;
    }
    .topbar-search span { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: .8rem; color: var(--text-muted); }
    
    .topbar-buttons { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
    .btn {
      border-radius: 999px; padding: 6px 12px; border: 1px solid var(--border-soft); font-size: .8rem;
      cursor: pointer; display: inline-flex; align-items: center; gap: 6px; background: var(--bg-card); color: var(--text-main);
    }
    .btn-cta { background: linear-gradient(90deg, #ff2440, #fb7185); color: #111827; font-weight: 600; border-color: transparent; }
    
    /* --- PAGES & CARDS --- */
    .pages { flex: 1; overflow: hidden; display: flex; flex-direction: column; gap: 8px; }
    .page { flex: 1; display: none; overflow-y: auto; overflow-x: hidden; }
    .page.active { display: flex; flex-direction: column; gap: 8px; }

    .card {
      background: var(--bg-card); border-radius: 14px; padding: 10px;
      border: 1px solid var(--border-soft); display: flex; flex-direction: column; min-width: 0;
    }
    .card-title { font-size: .9rem; font-weight: 600; }
    .card-sub { font-size: .72rem; color: var(--text-muted); margin-top: 2px; }
    .card-header-row { display: flex; align-items: baseline; justify-content: space-between; gap: 6px; margin-bottom: 4px; }
    
    .badge-small { font-size: .7rem; padding: 2px 6px; border-radius: 999px; background: #111827; color: #9ca3af; border: 1px solid var(--border-soft); }
    body.light .badge-small { background: #e5e7eb; }

    /* --- DASHBOARD GRID --- */
    .dashboard-grid { display: grid; grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.3fr); gap: 10px; align-items: flex-start; }
    .dashboard-right-column { display: flex; flex-direction: column; gap: 10px; }

    .kpi-grid { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 6px; margin-bottom: 6px; }
    .kpi-card { background: var(--bg-card-soft); border-radius: 10px; padding: 6px 8px; border: 1px solid var(--border-soft); }
    .kpi-label { font-size: .72rem; color: var(--text-muted); }
    .kpi-value { font-size: .98rem; font-weight: 600; }
    .kpi-caption { font-size: .7rem; color: var(--text-muted); }

    .dashboard-charts { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 8px; }
    .chart-container { position: relative; width: 100%; min-height: 160px; max-height: 240px; }
    .chart-container.centered { display:flex; align-items:center; justify-content:center; }
    .criterios-container { min-height: 260px; max-height: 320px; overflow-y: auto; }

    /* --- RANKING DELEGADOS --- */
    .ranking-list { font-size: .78rem; margin-top: 4px; display: flex; flex-direction: column; gap: 4px; }
    .ranking-row { display: flex; align-items: center; gap: 6px; justify-content: space-between; padding:3px 0; border-bottom: 1px dashed rgba(148,163,184,0.3); }
    .ranking-bar { height: 5px; border-radius:999px; background: var(--bg-card-soft); flex: 1; overflow:hidden; }
    .ranking-bar span { display:block; height:100%; }
    .ranking-toggle { margin-top:6px; font-size:.76rem; color:var(--accent-blue); cursor:pointer; text-align:right; }
    .ranking-summary { margin-top: 8px; padding-top: 6px; border-top: 1px dashed rgba(148,163,184,0.4); font-size: .76rem; color: var(--text-muted); }

    /* --- SECCI√ìN CENTROS --- */
    .centros-top { display: grid; grid-template-columns: 1.2fr 1.2fr 1fr; gap: 10px; min-height: 210px; }
    .delegados-list { margin-top: 6px; display: flex; flex-direction: column; gap: 4px; max-height: 160px; overflow: auto; }
    .delegado-card { background: var(--bg-card-soft); border-radius: 10px; padding: 4px 6px; border: 1px solid var(--border-soft); cursor: pointer; }
    .delegado-header { display:flex; align-items:center; justify-content:space-between; gap:6px; }
    .delegado-color { width:8px; height:8px; border-radius:999px; }
    .delegado-card.active { outline:1px solid var(--accent-blue); }

    /* Calendario simple */
    .calendar-wrapper { display:flex; flex-direction:column; gap:4px; height:100%; }
    .calendar-header { display:flex; align-items:center; justify-content:space-between; font-size:.85rem; font-weight:700; }
    .calendar-grid { margin-top:4px; display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:4px; flex:1; }
    .cal-cell { border-radius:10px; border:1px solid var(--border-soft); background:var(--bg-card-soft); font-size:.8rem; padding:3px 4px; cursor:pointer; position:relative; min-height: 30px;}
    .cal-cell.empty { background:transparent; border-style:dashed; cursor:default; }
    .cal-event { position:absolute; bottom:4px; left:4px; display:flex; align-items:center; gap:3px; }
    .cal-dot { width:6px; height:6px; border-radius:999px; background:#facc15; }

    /* Tabla */
    .table-wrapper { flex:1; background: var(--bg-card); border-radius: 14px; border: 1px solid var(--border-soft); display: flex; flex-direction: column; }
    .table-scroll { flex: 1; overflow: auto; border-top: 1px solid var(--border-soft); }
    table { width: 100%; border-collapse: collapse; font-size: .78rem; }
    thead { position: sticky; top: 0; background: var(--bg-card); z-index: 2; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #0b1120; text-align: left; white-space: nowrap; }
    tbody tr:nth-child(even) { background: var(--bg-card-soft); }
    
    .tag { border-radius: 999px; padding: 2px 6px; font-size: .7rem; border: 1px solid var(--border-soft); background: #0b1120; }
    .tag.exclusivo { background: rgba(22,163,74,0.15); color: var(--accent-green); border-color: rgba(22,163,74,0.7); }
    .tag.corner { background: rgba(37,99,235,0.15); color: var(--accent-blue); border-color: rgba(37,99,235,0.7); }
    .btn-link { border: none; background: transparent; color: var(--accent-blue); cursor: pointer; font-size: .74rem; text-decoration: underline; }

    /* --- INFORME --- */
    .informe-layout { display:flex; flex-direction:column; gap:8px; }
    .informe-top { display:grid; grid-template-columns: 1.3fr 1fr; gap:10px; }
    .datos-grid { display:grid; grid-template-columns: 1fr 1fr; gap:6px 12px; font-size:.8rem; margin-top:6px; }
    .field-input { width:100%; padding:4px 6px; border-radius:8px; border:1px solid var(--border-soft); background:var(--bg-card-soft); color:var(--text-main); font-size:.8rem; outline:none; }
    .panel-graficos { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:8px; max-height:340px; overflow:auto; }
    .panel-inferior { display: grid; grid-template-columns: 1.1fr 1.9fr; gap: 10px; }
    
    .checklist-visita { font-size: .78rem; max-height: 260px; overflow: auto; display:flex; flex-direction:column; gap:2px; }
    .imagenes-grid { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 10px; font-size: .78rem; }
    .imagen-preview { width: 100%; aspect-ratio: 16 / 9; border-radius: 10px; border: 1px dashed var(--border-soft); display: flex; align-items: center; justify-content: center; background:var(--bg-card-soft); cursor:pointer; overflow:hidden; }
    .imagen-preview img { width: 100%; height: 100%; object-fit: cover; }
    .observaciones-grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; margin-top:4px; }
    .obs-item textarea { width:100%; height:80px; resize:vertical; border-radius:10px; border:1px solid var(--border-soft); background:var(--bg-card-soft); color:var(--text-main); padding:6px; }

    /* MODAL */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(15,23,42,0.75); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal { background: var(--bg-card); border-radius: 14px; padding: 14px; width: 420px; border: 1px solid var(--border-soft); }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; }
    .modal-field { display: flex; flex-direction: column; gap: 2px; margin-bottom: 8px; }
    .modal-field input, .modal-field select { padding: 5px 7px; border-radius: 8px; border: 1px solid var(--border-soft); background: var(--bg-card-soft); color: var(--text-main); }
    
    /* Responsive simple */
    @media (max-width: 1400px) { .dashboard-grid { grid-template-columns: 1fr; } }
    @media (max-width: 1100px) { .centros-top, .informe-top, .panel-graficos, .panel-inferior { grid-template-columns: 1fr; } .dashboard-charts { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-badge"></div>
      <div class="logo-text">
        <span class="logo-title">Control Center Audio</span>
        <span class="logo-subtitle">Gesti√≥n de centros y delegados</span>
      </div>
    </div>
    <nav class="nav-list">
      <div class="nav-item active" data-page="dashboard"><span class="icon">üè†</span> Dashboard</div>
      <div class="nav-item" data-page="centros"><span class="icon">üè¢</span> Centros</div>
      <div class="nav-item" data-page="informe"><span class="icon">üìã</span> Informe visita</div>
    </nav>
    <div class="sidebar-footer">Versi√≥n demo v1.0</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="topbar-search">
        <span>üîç</span>
        <input id="searchGlobal" placeholder="Buscar por centro, propietario o delegado...">
      </div>
      <div class="topbar-buttons">
        <button class="btn" id="themeToggle"><span class="icon">üåì</span> Tema</button>
        <button class="btn btn-cta" id="btnActualizarNube"><span class="icon">‚òÅÔ∏è</span> Sync Nube</button>
      </div>
    </div>

    <div class="pages">
      <section class="page active" data-page="dashboard">
        <div class="dashboard-grid">
          <article class="card">
            <div class="card-header-row"><span class="card-title">Resumen general (KPIs)</span></div>
            <div class="kpi-grid">
              <div class="kpi-card"><div class="kpi-label">Procesos</div><div class="kpi-value" id="kpiProcesos">-</div></div>
              <div class="kpi-card"><div class="kpi-label">Conv. Prueba</div><div class="kpi-value" id="kpiConvPrueba">-</div></div>
              <div class="kpi-card"><div class="kpi-label">Conv. Venta</div><div class="kpi-value" id="kpiConvVenta">-</div></div>
              <div class="kpi-card"><div class="kpi-label">HIT</div><div class="kpi-value" id="kpiHIT">-</div></div>
            </div>
            <div class="dashboard-charts">
              <div class="card"><span class="card-title">Radar Global</span><div class="chart-container"><canvas id="chartRadarGeneral"></canvas></div></div>
              <div class="card"><span class="card-title">Procesos Mes</span><div class="chart-container"><canvas id="chartProcesosMes"></canvas></div></div>
              <div class="card"><span class="card-title">Top √Åreas Mejora</span><div class="chart-container"><canvas id="chartTopAreas"></canvas></div></div>
            </div>
          </article>

          <div class="dashboard-right-column">
            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Evaluaci√≥n Detallada (80 Criterios)</span>
              </div>
              <div class="card-sub" id="criteriosEmptyMsg">Adjunta un checklist en informe para ver detalle.</div>
              <div class="chart-container criterios-container">
                <canvas id="chartCriteriosDetalle"></canvas>
              </div>
            </article>
            <article class="card">
              <div class="card-header-row"><span class="card-title">Ranking Delegados</span></div>
              <div class="ranking-list" id="rankingDelegados"></div>
            </article>
          </div>
        </div>
      </section>

      <section class="page" data-page="centros">
        <div class="centros-top">
          <article class="card">
            <div class="card-header-row"><span class="card-title">Delegados</span></div>
            <div class="delegados-list" id="delegadosList"></div>
            <div style="margin-top:8px;">
              <button class="btn btn-cta" id="btnAddCentro"><span class="icon">‚ûï</span> Nuevo Centro</button>
            </div>
          </article>
          <article class="card">
            <div class="calendar-wrapper">
              <div class="calendar-header">
                <button id="calPrev">&lt;</button> <span id="calTitulo">Mes</span> <button id="calNext">&gt;</button>
              </div>
              <div class="calendar-grid" id="calendarGrid"></div>
            </div>
          </article>
          <article class="card">
            <div class="card-header-row"><span class="card-title">Pr√≥ximas Visitas</span></div>
            <div id="visitasList" style="overflow:auto; max-height:160px;"></div>
          </article>
        </div>
        <section class="table-wrapper">
          <div class="table-scroll">
            <table>
              <thead>
                <tr><th>C√≥digo</th><th>Propietario</th><th>Centro</th><th>Provincia</th><th>Delegado</th><th>Tipo</th><th>Acci√≥n</th></tr>
              </thead>
              <tbody id="tablaCentrosBody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <section class="page" data-page="informe">
        <div class="informe-layout">
          <div class="informe-top">
            <article class="card">
              <div class="card-header-row"><span class="card-title">Datos Visita / Centro</span></div>
              <div class="datos-grid">
                <div><div class="dato-label">Centro</div><input id="infCentro" class="field-input" readonly></div>
                <div><div class="dato-label">Tipo</div><input id="infTipo" class="field-input" readonly></div>
                <div><div class="dato-label">Fecha</div><input id="infFecha" class="field-input"></div>
                <div><div class="dato-label">Delegado</div><input id="infDelegado" class="field-input" readonly></div>
                <div class="dato-full" style="grid-column: 1 / -1; margin-top:8px;">
                  <button class="btn btn-cta" id="btnAdjuntarChecklist">üìé Adjuntar Checklist (Excel)</button>
                  <input type="file" id="inputChecklist" accept=".xlsx,.xls" style="display:none">
                  <span id="nombreChecklist" style="margin-left:8px; font-size:.75rem; color:var(--text-muted);"></span>
                </div>
              </div>
            </article>
            <article class="card">
              <div class="card-header-row"><span class="card-title">KPIs Centro (Calculado)</span></div>
              <div style="font-size:.85rem; margin-top:10px;">
                <div>% Procesos: <strong id="kpiCentroProcesos">0%</strong></div>
                <div>Conv. Prueba: <strong id="kpiCentroPrueba">0%</strong></div>
                <div>Conv. Venta: <strong id="kpiCentroVenta">0%</strong></div>
                <div>HIT: <strong id="kpiCentroHit">No</strong></div>
              </div>
              <div class="chart-container centered" style="height:140px;">
                 <canvas id="chartCentroRadar"></canvas>
              </div>
            </article>
          </div>

          <div class="panel-graficos">
            <article class="card"><span class="card-title">Palancas (Barras)</span><div class="chart-container"><canvas id="chartCentroSiNoBarras"></canvas></div></article>
            <article class="card"><span class="card-title">Evoluci√≥n Procesos</span><div class="chart-container"><canvas id="chartCentroProcesosMes"></canvas></div></article>
            <article class="card"><span class="card-title">Resumen Conv.</span><div class="chart-container"><canvas id="chartCentroConversionResumen"></canvas></div></article>
          </div>
          
          <div class="panel-inferior">
             <article class="card">
                <span class="card-title">Formaciones y Producto</span>
                <div class="checklist-visita">
                   <label><input type="checkbox" data-kpi="wsa"> WSA</label>
                   <label><input type="checkbox" data-kpi="starkey"> Starkey</label>
                   <label><input type="checkbox" data-kpi="telecare"> Telecare / PIA</label>
                   <label><input type="checkbox" data-kpi="rt"> Audiometr√≠a RT</label>
                   <label><input type="checkbox" data-kpi="stock"> Stock</label>
                </div>
             </article>
             <article class="card">
               <span class="card-title">Fotos Evidencia</span>
               <div class="imagenes-grid">
                 <div><div class="imagen-preview" data-target="ext">Exterior</div><input type="file" data-input-img="ext" hidden></div>
                 <div><div class="imagen-preview" data-target="int">Interior</div><input type="file" data-input-img="int" hidden></div>
                 <div><div class="imagen-preview" data-target="gab">Gabinete</div><input type="file" data-input-img="gab" hidden></div>
               </div>
             </article>
          </div>

          <article class="card">
             <span class="card-title">Conclusiones</span>
             <div class="observaciones-grid">
               <div class="obs-item"><textarea placeholder="Observaciones..."></textarea></div>
               <div class="obs-item"><textarea placeholder="Recomendaciones..."></textarea></div>
               <div class="obs-item"><textarea placeholder="Compromisos..."></textarea></div>
             </div>
             <div style="display:flex; justify-content:flex-end; margin-top:10px;">
               <button class="btn btn-cta" id="btnGuardarInforme">üíæ Guardar Informe</button>
             </div>
          </article>
        </div>
      </section>
    </div>
  </main>

  <div class="modal-backdrop" id="modalCentro">
    <div class="modal">
      <div class="modal-header"><h3>Nuevo Centro</h3><span class="modal-close" data-close="modalCentro">‚úï</span></div>
      <div class="modal-body">
         <div class="modal-field"><label>Centro</label><input id="nuevoCentro"></div>
         <div class="modal-field"><label>Delegado</label><input id="nuevoDelegado"></div>
         <div class="modal-field"><label>Tipo</label><select id="nuevoTipo"><option value="Corner">Corner</option><option value="Exclusivo">Exclusivo</option></select></div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
        <button class="btn btn-cta" id="guardarCentro">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    
    // ESTADO
    const centros = [
      { codigo:"4ABB", propietario:"MAZA Oriol", centro:"PAMPLONA C. Exclusivo", provincia:"NAVARRA", delegado:"Sonia Godino", tipo:"Exclusivo" },
      { codigo:"4MRM", propietario:"AAO", centro:"REINA DE MERCEDES", provincia:"Madrid", delegado:"Sergio Per√°n", tipo:"Exclusivo" },
      { codigo:"4COR", propietario:"TEST", centro:"CORNER DE PRUEBA", provincia:"Madrid", delegado:"Daniel Chazo", tipo:"Corner" }
    ];
    let centroActual = null;
    let globalCharts = {}, centroCharts = {};
    let criteriosGlobal = new Map();

    /* --- NAVEGACI√ìN --- */
    $$(".nav-item").forEach(item => {
      item.addEventListener("click", () => {
        $$(".nav-item").forEach(i => i.classList.remove("active"));
        $$(".page").forEach(p => p.classList.remove("active"));
        item.classList.add("active");
        $(`.page[data-page="${item.dataset.page}"]`).classList.add("active");
      });
    });
    $("#themeToggle").addEventListener("click", ()=> document.body.classList.toggle("light"));

    /* --- RENDER TABLA CENTROS --- */
    function renderCentros() {
      const tbody = $("#tablaCentrosBody");
      tbody.innerHTML = "";
      centros.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.codigo}</td><td>${c.propietario}</td><td>${c.centro}</td><td>${c.provincia}</td>
          <td>${c.delegado}</td>
          <td><span class="tag ${c.tipo.toLowerCase()}">${c.tipo}</span></td>
          <td><button class="btn-link btn-informe" data-centro="${c.centro}">A√±adir informe</button></td>
        `;
        tbody.appendChild(tr);
      });
      // Listeners din√°micos
      $$(".btn-informe").forEach(btn => btn.addEventListener("click", e => irAInforme(e.target.dataset.centro)));
      renderDelegados();
    }

    function renderDelegados() {
       const list = $("#delegadosList");
       list.innerHTML = "";
       const counts = {};
       centros.forEach(c => counts[c.delegado] = (counts[c.delegado]||0)+1);
       Object.keys(counts).forEach(del => {
         const div = document.createElement("div");
         div.className = "delegado-card";
         div.innerHTML = `<div class="delegado-header"><span>${del}</span> <span class="badge-small">${counts[del]} centros</span></div>`;
         list.appendChild(div);
       });
    }

    /* --- IR A INFORME --- */
    function irAInforme(nombre) {
      centroActual = centros.find(c => c.centro === nombre);
      if(!centroActual) return;
      
      // Rellenar datos
      $("#infCentro").value = centroActual.centro;
      $("#infTipo").value = centroActual.tipo;
      $("#infDelegado").value = centroActual.delegado;
      $("#infFecha").value = new Date().toISOString().slice(0,10);
      
      // Cambiar p√°gina
      $$(".nav-item").forEach(i => i.classList.remove("active"));
      $$(".page").forEach(p => p.classList.remove("active"));
      $('[data-page="informe"]').classList.add("active");
      $('.nav-item[data-page="informe"]').classList.add("active");
      
      initCentroCharts(); 
    }

    /* -------------------------------------------------------------------------- */
    /* L√ìGICA DE LECTURA DE CHECKLISTS (CORNER VS EXCLUSIVO)            */
    /* -------------------------------------------------------------------------- */
    
    // Adjuntar archivo
    $("#btnAdjuntarChecklist").addEventListener("click", () => $("#inputChecklist").click());
    
    $("#inputChecklist").addEventListener("change", e => {
      const file = e.target.files[0];
      if(!file) return;
      $("#nombreChecklist").textContent = file.name;
      leerChecklist(file);
    });

    function leerChecklist(file) {
      const reader = new FileReader();
      reader.onload = evt => {
         try {
           const data = new Uint8Array(evt.target.result);
           const workbook = XLSX.read(data, { type: "array" });
           const sheetName = workbook.SheetNames[0];
           const sheet = workbook.Sheets[sheetName];
           const rows = XLSX.utils.sheet_to_json(sheet, { header:1 }); // Leer como array de arrays
           
           // DETECTAR TIPO POR NOMBRE DE ARCHIVO
           const nameUpper = file.name.toUpperCase();
           let tipo = "CORNER"; // Default
           if (nameUpper.includes("EXCLUSIVO")) tipo = "EXCLUSIVO";
           else if (nameUpper.includes("CORNER")) tipo = "CORNER";

           console.log("Procesando Checklist tipo:", tipo);
           procesarFilas(rows, tipo);

         } catch (err) {
           console.error(err);
           alert("Error al leer el Excel. Aseg√∫rate de que es un archivo v√°lido.");
         }
      };
      reader.readAsArrayBuffer(file);
    }

    function procesarFilas(rows, tipo) {
      // DEFINICI√ìN DE COORDENADAS SEG√öN TIPO
      // Nota: Los √≠ndices de array empiezan en 0. (Fila Excel 8 = √≠ndice 7)
      
      let rStart, rEnd, colCrit, colRes;     // Para leer los 80 criterios
      let filaProc, colProc;                 // % Procesos
      let filaHit, colHit;                   // HIT
      let filaPrueba, colPrueba;             // % Conv Prueba
      let filaVenta, colVenta;               // % Conv Venta

      if (tipo === "EXCLUSIVO") {
        // --- CONFIGURACI√ìN EXCLUSIVO ---
        rStart = 7;  rEnd = 101;  // Filas donde est√°n los criterios (aprox)
        colCrit = 1; colRes = 5;  // Columna B (√≠ndice 1) Nombre, F (√≠ndice 5) Resultado (1/0)
        
        filaProc = 103; colProc = 5; // F104
        filaHit  = 64;  colHit  = 5; // F65
        filaPrueba = 125; colPrueba = 8; // I126
        filaVenta  = 126; colVenta  = 8; // I127
        
      } else {
        // --- CONFIGURACI√ìN CORNER ---
        rStart = 6;  rEnd = 87;
        colCrit = 1; colRes = 5; 
        
        filaProc = 89; colProc = 5; // F90
        filaHit  = 62; colHit  = 5; // F63
        filaPrueba = 91; colPrueba = 1; // B92
        filaVenta  = 92; colVenta  = 1; // B93
      }

      // 1. LEER CRITERIOS
      criteriosGlobal.clear();
      const labels = [];
      const dataVals = [];
      
      for(let r = rStart; r <= rEnd && r < rows.length; r++) {
         const row = rows[r] || [];
         const nombre = row[colCrit];
         const val = row[colRes];
         if(nombre) {
            labels.push(nombre);
            // Si es 1 es "S√≠", si es 0 es "No". Convertimos a % para el gr√°fico
            dataVals.push(val == 1 ? 100 : 0); 
         }
      }

      // 2. LEER KPIS PRINCIPALES
      // Funci√≥n auxiliar para limpiar %
      const cleanPct = (v) => {
         if(!v) return 0;
         if(typeof v === 'number') return v <= 1 ? Math.round(v*100) : v;
         // Si viene como string "85%"
         let s = String(v).replace('%','').replace(',','.');
         return parseFloat(s) || 0;
      };

      const valProc = cleanPct((rows[filaProc]||[])[colProc]);
      const valHit  = (rows[filaHit]||[])[colHit] == 1 ? "S√≠" : "No";
      const valPrueba = cleanPct((rows[filaPrueba]||[])[colPrueba]);
      const valVenta  = cleanPct((rows[filaVenta]||[])[colVenta]);

      // 3. ACTUALIZAR INTERFAZ
      $("#kpiCentroProcesos").textContent = valProc + "%";
      $("#kpiCentroHit").textContent = valHit;
      $("#kpiCentroPrueba").textContent = valPrueba + "%";
      $("#kpiCentroVenta").textContent = valVenta + "%";

      // 4. ACTUALIZAR GR√ÅFICOS DEL INFORME
      updateCentroCharts(valProc, valPrueba, valVenta);
      updateCriteriosChart(labels, dataVals); // Gr√°fico detalle 80 criterios
      
      alert(`Checklist ${tipo} cargado correctamente.\nProcesos: ${valProc}% | HIT: ${valHit}`);
    }

    /* -------------------------------------------------------------------------- */
    /* CHARTS HELPERS                                */
    /* -------------------------------------------------------------------------- */

    function initCentroCharts() {
       if(centroCharts.radar) return; // Ya creados
       
       // Radar Centro
       const ctxR = document.getElementById("chartCentroRadar");
       centroCharts.radar = new Chart(ctxR, {
         type: 'radar',
         data: {
           labels: ['Procesos', 'Prueba', 'Venta', 'Formaci√≥n', 'Auditor√≠a'],
           datasets: [{ label: 'Centro Actual', data: [0,0,0,0,0], borderColor: '#38bdf8', backgroundColor: 'rgba(56,189,248,0.2)' }]
         },
         options: { scales: { r: { min: 0, max: 100, ticks: { display: false } } }, plugins: { legend: { display: false } } }
       });
       
       // Barras Centro
       const ctxB = document.getElementById("chartCentroSiNoBarras");
       centroCharts.barras = new Chart(ctxB, {
         type: 'bar',
         data: { labels: ['AAR','HIT','Infinity'], datasets: [{ label: '1=S√≠', data:[1,0,1], backgroundColor: ['#22c55e','#ef4444','#22c55e'] }] },
         options: { plugins: { legend: { display: false } }, scales: { y: { display:false } } }
       });

       // Criterios Detalle (El grande del dashboard)
       const ctxDet = document.getElementById("chartCriteriosDetalle");
       globalCharts.criterios = new Chart(ctxDet, {
         type: 'bar',
         data: { labels: [], datasets: [{ label: '% Cumplimiento', data: [], backgroundColor: '#38bdf8' }] },
         options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display:false } } }
       });
    }

    function updateCentroCharts(proc, prueba, venta) {
       // Actualizamos el radar con los datos le√≠dos
       if(centroCharts.radar) {
         centroCharts.radar.data.datasets[0].data = [proc, prueba, venta, 80, 90]; // 80 y 90 son placeholders
         centroCharts.radar.update();
       }
    }

    function updateCriteriosChart(labels, data) {
       // Actualizamos el gr√°fico de barras grande
       if(globalCharts.criterios) {
         globalCharts.criterios.data.labels = labels;
         globalCharts.criterios.data.datasets[0].data = data;
         // Ajustar altura canvas seg√∫n cantidad de datos
         document.getElementById("chartCriteriosDetalle").parentNode.style.height = (labels.length * 20 + 50) + "px";
         globalCharts.criterios.resize();
         globalCharts.criterios.update();
         
         // Ocultar mensaje vac√≠o
         $("#criteriosEmptyMsg").style.display = "none";
       }
    }

    /* --- INICIALIZACI√ìN --- */
    window.addEventListener("load", () => {
       renderCentros();
       // Inicializar gr√°ficos dummy del dashboard home
       new Chart(document.getElementById("chartRadarGeneral"), {
         type:'radar', data: { labels:['Procesos','Ventas','HIT'], datasets:[{data:[80,75,90], label:'Global'}] }
       });
    });
    
    // Listeners Modal Nuevo Centro
    $("#btnAddCentro").addEventListener("click", ()=> $("#modalCentro").style.display="flex");
    $$(".modal-close").forEach(el => el.addEventListener("click", ()=> $(".modal-backdrop").style.display="none"));
    
    $("#guardarCentro").addEventListener("click", ()=> {
       centros.push({
         codigo: "NEW", propietario: "Nuevo",
         centro: $("#nuevoCentro").value,
         provincia: "N/D", delegado: $("#nuevoDelegado").value,
         tipo: $("#nuevoTipo").value
       });
       $("#modalCentro").style.display="none";
       renderCentros();
    });

    // Im√°genes preview
    $$(".imagen-preview").forEach(div => div.addEventListener("click", e => {
       const t = e.target.dataset.target;
       $(`input[data-input-img="${t}"]`).click();
    }));
    $$('input[data-input-img]').forEach(inp => inp.addEventListener("change", e => {
       if(e.target.files[0]) {
          const url = URL.createObjectURL(e.target.files[0]);
          const div = $(`.imagen-preview[data-target="${e.target.dataset.inputImg}"]`);
          div.innerHTML = `<img src="${url}">`;
       }
    }));

  </script>
</body>
</html>
