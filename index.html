<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SEGUIMIENTO AUDIO ¬∑ Local</title>
<meta name="theme-color" content="#c82727"/>
<style>
:root{
  --rojo:#c82727; --rojo2:#a71f1f; --line:#e8e8ee; --bg:#f6f7fb; --sh:0 4px 14px rgba(0,0,0,.06);
  --col-ex:#fde2e4; --col-fl:#e2f0cb; --col-va:#cde7f0; --col-fm:#f9e5c9; --col-ta:#eadcf8; --col-eq:#e8f1ff; --col-sv:#ffe9cc;
  --fs:12px; --fs-sm:11px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#222;font-size:var(--fs);line-height:1.18}

/* Topbar */
.topbar{position:sticky;top:0;z-index:30;width:100%;
  background:linear-gradient(180deg,var(--rojo),var(--rojo2)); box-shadow:var(--sh)}
.topbar .inner{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:.6rem;padding:.9rem .8rem}
.brand{justify-self:center;display:flex;align-items:center;gap:.6rem;color:#fff;font-weight:900;letter-spacing:.2px}
.brand i{font-style:normal;font-size:20px}
.brand span{font-size:22px}
.actions{justify-self:start;display:flex;gap:.35rem}
.actions button{background:#fff;border:0;border-radius:9px;padding:.42rem .75rem;cursor:pointer;box-shadow:var(--sh);font-weight:800}
.meta{justify-self:end;color:#fff;font-weight:700;opacity:.9}

/* Layout */
.wrapper{display:grid;grid-template-columns:210px minmax(0,1fr);gap:8px;padding:8px}
.sidebar{display:flex;flex-direction:column;gap:8px}
.side-card{border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--sh);overflow:hidden}
.side-card .head{display:flex;justify-content:space-between;align-items:center;padding:.48rem .6rem;font-weight:900;font-size:12px}
.side-card .list{padding:.25rem .45rem .5rem;max-height:210px;overflow:auto}
.side-card .item{display:flex;justify-content:space-between;align-items:center;gap:.35rem;padding:.32rem .38rem;margin:.22rem 0;border:1px solid var(--line);border-radius:9px;background:#fff}
.side-card .item .name{font-weight:750}
.side-card .btn{width:26px;height:22px;border-radius:7px;border:1px solid var(--line);background:#fff;cursor:pointer}

/* Detail */
.detail{border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--sh);min-height:70vh;padding:.6rem}
.detail .hdr{display:flex;align-items:center;gap:.6rem;margin:.2rem 0 .4rem}
.detail .hdr h2{margin:0;font-size:18px}
.badge{padding:.12rem .52rem;border-radius:999px;background:#00000010}

.tools{display:flex;gap:.35rem;align-items:center;margin:.2rem 0}
.tools .btn{background:#eef1ff;border:1px solid #d6daf7;padding:.24rem .5rem;border-radius:8px;font-weight:700;cursor:pointer}

.table{border:1px solid var(--line);border-radius:10px;overflow:auto}
.grid{display:grid;gap:1px;background:var(--line)}
.grid > div{background:#fff;padding:.35rem .4rem}
.grid .head{background:#f7f8ff;font-weight:800}
.xscroll{overflow:auto}
.num{width:100%;border:1px solid var(--line);border-radius:6px;padding:.28rem .35rem;font-size:var(--fs-sm)}
.txt{width:100%;border:1px solid var(--line);border-radius:6px;padding:.28rem .35rem;font-size:var(--fs-sm)}
.date{width:100%;border:1px solid var(--line);border-radius:6px;padding:.25rem .3rem;font-size:var(--fs-sm)}
.sel{width:100%;border:1px solid var(--line);border-radius:6px;padding:.25rem .3rem;font-size:var(--fs-sm)}

.ok{background:#eaf9f0!important;border:1px solid #bfe3cd}
.bad{background:#ffe9e9!important;border:1px solid #f4c7c7}

/* PIN */
.gate{position:fixed;inset:0;background:#000a;display:flex;align-items:center;justify-content:center;z-index:100}
.card{background:#111;color:#fff;min-width:280px;border-radius:12px;border:1px solid #2a2a2a;padding:14px 12px;box-shadow:var(--sh)}
.card h3{margin:.1rem 0 .5rem}
.pin{width:100%;letter-spacing:.35rem;font-size:1rem;text-align:center;background:#000;color:#fff;border:1px solid #444;border-radius:8px;padding:.42rem}
.btnRow{display:flex;gap:.45rem;margin-top:10px}
.btnDark{flex:1;background:#fff;border:0;color:#111;font-weight:900;border-radius:10px;padding:.45rem .8rem;cursor:pointer}
.btnGhost{flex:.9;background:transparent;color:#fff;border:1px solid #ffffff55;border-radius:10px;padding:.45rem .8rem;cursor:pointer}
.msg{color:#ff8080;display:none;margin-top:.4rem}
</style>
</head>
<body>

<header class="topbar">
  <div class="inner">
    <div class="actions">
      <button id="btnLoad">Actualizar (local)</button>
      <button id="btnSave">Guardar (local)</button>
    </div>
    <div class="brand"><i>üéß</i><span>SEGUIMIENTO AUDIO</span></div>
    <div class="meta" id="stamp">Listo</div>
  </div>
</header>

<main class="wrapper">
  <!-- ====== CIFRA DE VENTAS ====== -->
  <aside class="sidebar">
    <div class="side-card" style="background:var(--col-sv)">
      <div class="head">üìä CIFRA DE VENTAS
        <div>
          <button class="btn" id="svShowCompany" title="Ver compa√±√≠a">üè¢</button>
          <button class="btn" id="svAddCenter" title="A√±adir centro">Ôºã</button>
        </div>
      </div>
      <div class="list" id="svCentersList"></div>
    </div>

    <div class="side-card" style="background:var(--col-ex)">
      <div class="head">üìí CENTROS EXCLUSIVOS <div><button class="btn" title="‚Äî">‚ñæ</button></div></div>
      <div class="list" id="ceList"></div>
    </div>

    <div class="side-card" style="background:var(--col-fl)">
      <div class="head">üìí CENTROS FLOP <div><button class="btn" title="‚Äî">‚ñæ</button></div></div>
      <div class="list" id="flList"></div>
    </div>

    <div class="side-card" style="background:var(--col-va)">
      <div class="head">üìã VISITAS AUDIO <div><button class="btn" title="‚Äî">‚ñæ</button></div></div>
      <div class="list" id="vaList">
        <div class="item"><div class="name">(Responsable Tec. Audio) ‚Äî</div></div>
      </div>
    </div>

    <div class="side-card" style="background:var(--col-fm)">
      <div class="head">üéì FORMACIONES Y MENTORING
        <div><button class="btn" id="btnShowMent" title="Mentoring general">üß≠</button></div>
      </div>
      <div class="list" id="fmList"></div>
    </div>

    <div class="side-card" style="background:var(--col-ta)">
      <div class="head">üì° TELEAUDIOLOGIA <div><button class="btn" title="‚Äî">‚ñæ</button></div></div>
      <div class="list" id="taList"></div>
    </div>

    <div class="side-card" style="background:var(--col-eq)">
      <div class="head">üß∞ EQUIPOS <div><button class="btn" id="eqAdd" title="A√±adir fila">Ôºã</button></div></div>
      <div class="list" id="eqList"><div class="item"><div class="name">Inventario de equipos</div></div></div>
    </div>
  </aside>

  <!-- ====== DETALLE ====== -->
  <section class="detail">
    <div class="hdr">
      <h2 id="detTitle">Detalle</h2>
      <span id="detTag" class="badge">‚Äî</span>
      <div class="tools" id="detTools"></div>
    </div>

    <!-- Panel: CIFRA VENTAS ¬∑ Compa√±√≠a -->
    <div id="panelSalesCompany" style="display:none">
      <div class="table xscroll">
        <div class="grid" id="gridSalesCompany"></div>
      </div>
    </div>

    <!-- Panel: CIFRA VENTAS ¬∑ Centros exclusivos -->
    <div id="panelSalesCenters" style="display:none">
      <div class="tools"><button class="btn" id="svCentersAdd">A√±adir fila</button></div>
      <div class="table xscroll">
        <div class="grid" id="gridSalesCenters"></div>
      </div>
    </div>

    <!-- Panel: Mentoring general -->
    <div id="panelMentoring" style="display:none">
      <div class="tools"><button class="btn" id="mentAdd">A√±adir fila</button></div>
      <div class="table xscroll">
        <div class="grid" id="gridMentoring"></div>
      </div>
    </div>

    <!-- Placeholder otros paneles -->
    <div id="panelPlaceholder" style="opacity:.75">Selecciona una secci√≥n en el lateral para empezar.</div>
  </section>
</main>

<!-- ====== PIN ====== -->
<div class="gate" id="gate">
  <div class="card">
    <h3>Acceso</h3>
    <p>Introduce el PIN para editar:</p>
    <input id="pin" class="pin" type="password" inputmode="numeric" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
    <div class="btnRow">
      <button class="btnDark" id="enter">Entrar</button>
      <button class="btnGhost" id="clearPin">Limpiar</button>
    </div>
    <p id="pinMsg" class="msg">PIN incorrecto</p>
  </div>
</div>

<script>
/* ======== Utilidades ======== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const money = v => isFinite(+v) ? (+v).toLocaleString('es-ES') : '';
const MONTHS_25_26 = [
  'Ago-2025','Sep-2025','Oct-2025','Nov-2025','Dic-2025',
  'Ene-2026','Feb-2026','Mar-2026','Abr-2026','May-2026','Jun-2026','Jul-2026'
];
const LSKEY='seguimiento_audio_vlocal';

/* ======== Estado ======== */
let state = {
  sales:{
    company: MONTHS_25_26.map(m=>({mes:m,previsto:null,cv:null})),
    centers: [/* {centro:'Reina Mercedes', previsto:null, mes:null} */],
    centersNames: ['Reina Mercedes']
  },
  mentoring: [
    /* {fecha:'',tema:'',asistencia:'',obs:''} */
  ]
};

/* ======== Persistencia ======== */
function loadLocal(){
  try{
    const raw = localStorage.getItem(LSKEY);
    if(raw){ state = JSON.parse(raw); }
    render();
    stamp('Cargado local');
  }catch(e){ console.warn(e); }
}
function saveLocal(){
  localStorage.setItem(LSKEY, JSON.stringify(state));
  stamp('Guardado local');
}
function stamp(t){ $('#stamp').textContent = t+' ¬∑ '+ new Date().toLocaleString(); }

/* ======== Render general ======== */
function render(){
  renderSalesSidebar();
  renderSalesCompany();
  renderSalesCenters();
  renderMentoring();
}

/* ---------------- CIFRA DE VENTAS ---------------- */
function renderSalesSidebar(){
  const list = $('#svCentersList');
  list.innerHTML='';
  // bot√≥n Compa√±√≠a
  const cmp = document.createElement('div');
  cmp.className='item';
  cmp.innerHTML = `<div class="name">üè¢ Compa√±√≠a</div>
    <div><button class="btn" title="Abrir">‚û°Ô∏è</button></div>`;
  cmp.querySelector('button').onclick=()=>openPanel('company');
  list.appendChild(cmp);

  // lista centros + a√±adir
  state.sales.centersNames = state.sales.centersNames||[];
  state.sales.centersNames.forEach((n,idx)=>{
    const it=document.createElement('div');
    it.className='item';
    it.innerHTML=`<div class="name">${n}</div>
      <div>
        <button class="btn" title="Renombrar">‚úèÔ∏è</button>
        <button class="btn" title="Eliminar">üóëÔ∏è</button>
      </div>`;
    it.querySelectorAll('button')[0].onclick=()=>{
      const nuevo=prompt('Nombre del centro', n)||n;
      state.sales.centersNames[idx]=nuevo;
      // Asegura fila en tabla si no existe
      const row=state.sales.centers.find(r=>r.centro===n);
      if(row) row.centro=nuevo;
      renderSalesSidebar(); renderSalesCenters();
    };
    it.querySelectorAll('button')[1].onclick=()=>{
      if(!confirm('¬øEliminar centro de la lista?')) return;
      state.sales.centersNames.splice(idx,1);
      state.sales.centers = state.sales.centers.filter(r=>r.centro!==n);
      renderSalesSidebar(); renderSalesCenters();
    };
    list.appendChild(it);
  });

  $('#svAddCenter').onclick=()=>{
    const n = prompt('Nuevo centro exclusivo');
    if(!n) return;
    if(!state.sales.centersNames.includes(n)) state.sales.centersNames.push(n);
    // a√±ade fila si no estuviera
    if(!state.sales.centers.find(r=>r.centro===n)){
      state.sales.centers.push({centro:n, previsto:null, mes:null});
    }
    renderSalesSidebar(); renderSalesCenters();
  };
  $('#svShowCompany').onclick=()=>openPanel('company');
}

function openPanel(which){
  // oculta todo
  $('#panelPlaceholder').style.display='none';
  $('#panelSalesCompany').style.display = (which==='company')?'block':'none';
  $('#panelSalesCenters').style.display = (which==='centers')?'block':'none';
  $('#panelMentoring').style.display = (which==='mentoring')?'block':'none';

  if(which==='company'){ $('#detTitle').textContent='Detalle ‚Äî Cifra de ventas (Compa√±√≠a)'; $('#detTag').textContent='CIFRA DE VENTAS'; }
  if(which==='centers'){ $('#detTitle').textContent='Detalle ‚Äî Cifra de ventas (Centros exclusivos)'; $('#detTag').textContent='CIFRA DE VENTAS'; }
  if(which==='mentoring'){ $('#detTitle').textContent='Detalle ‚Äî Mentoring general'; $('#detTag').textContent='FORMACIONES Y MENTORING'; }
}

/* ---- panel: compa√±√≠a ---- */
function renderSalesCompany(){
  const g = $('#gridSalesCompany'); g.innerHTML='';
  const cols = ['Mes','Previsto (‚Ç¨)','CV mes (‚Ç¨)','Dif.','Estado'];
  g.style.gridTemplateColumns='180px 140px 140px 120px 120px';

  cols.forEach(h=>{const d=document.createElement('div');d.className='head';d.textContent=h;g.appendChild(d);});
  let totPrev=0, totCV=0;

  state.sales.company.forEach((r,i)=>{
    const dMes=document.createElement('div'); dMes.textContent=r.mes; g.appendChild(dMes);

    const inPrev=document.createElement('input'); inPrev.className='num'; inPrev.type='number'; inPrev.step='0.01'; inPrev.value = r.previsto??''; 
    inPrev.oninput=()=>{ r.previsto = inPrev.value===''?null:+inPrev.value; paintRow(); };
    g.appendChild(inPrev);

    const inCV=document.createElement('input'); inCV.className='num'; inCV.type='number'; inCV.step='0.01'; inCV.value = r.cv??''; 
    inCV.oninput=()=>{ r.cv = inCV.value===''?null:+inCV.value; paintRow(); };
    g.appendChild(inCV);

    const dDif=document.createElement('div'); g.appendChild(dDif);
    const dEst=document.createElement('div'); g.appendChild(dEst);

    function paintRow(){
      const pv=+r.previsto||0, cv=+r.cv||0;
      dDif.textContent = money(cv-pv);
      dEst.textContent = (cv>=pv)?'OK':'Bajo';
      [inCV].forEach(el=>{
        el.classList.remove('ok','bad');
        if(!isNaN(cv)&&!isNaN(pv)){
          el.classList.add(cv>=pv?'ok':'bad');
        }
      });
      totPrev=state.sales.company.reduce((s,x)=>s+(+x.previsto||0),0);
      totCV=state.sales.company.reduce((s,x)=>s+(+x.cv||0),0);
      drawTotals();
    }
    paintRow();
  });

  // Totales
  function drawTotals(){
    // borra totales si exist√≠an
    const old=$$('#gridSalesCompany .totline'); old.forEach(n=>n.remove());
    ['TOTAL','', '', money(totCV-totPrev), (totCV>=totPrev?'OK':'Bajo')].forEach((t,ix)=>{
      const d=document.createElement('div'); d.className='totline head'; 
      if(ix===1){ d.textContent = money(totPrev); }
      else if(ix===2){ d.textContent = money(totCV); }
      else d.textContent=t;
      g.appendChild(d);
    });
  }
}

/* ---- panel: centros ---- */
function renderSalesCenters(){
  const g = $('#gridSalesCenters'); g.innerHTML='';
  g.style.gridTemplateColumns='1.5fr 140px 140px 120px 120px';
  ['Centro','Previsto (‚Ç¨)','Mes (‚Ç¨)','Dif.','Estado'].forEach(h=>{const d=document.createElement('div');d.className='head';d.textContent=h;g.appendChild(d);});

  // asegura que exista 1 fila por centro de la lista
  state.sales.centersNames.forEach(n=>{
    if(!state.sales.centers.find(r=>r.centro===n)){
      state.sales.centers.push({centro:n, previsto:null, mes:null});
    }
  });

  state.sales.centers.forEach((r,idx)=>{
    const dC=document.createElement('div'); dC.textContent=r.centro; g.appendChild(dC);

    const inP=document.createElement('input'); inP.type='number'; inP.step='0.01'; inP.className='num'; inP.value=r.previsto??''; 
    inP.oninput=()=>{ r.previsto=inP.value===''?null:+inP.value; paint(); };
    g.appendChild(inP);

    const inM=document.createElement('input'); inM.type='number'; inM.step='0.01'; inM.className='num'; inM.value=r.mes??''; 
    inM.oninput=()=>{ r.mes=inM.value===''?null:+inM.value; paint(); };
    g.appendChild(inM);

    const dDif=document.createElement('div'); g.appendChild(dDif);
    const dEst=document.createElement('div'); g.appendChild(dEst);

    function paint(){
      const pv=+r.previsto||0, mv=+r.mes||0;
      dDif.textContent = money(mv-pv);
      dEst.textContent = (mv>=pv)?'OK':'Bajo';
      inM.classList.remove('ok','bad');
      if(!isNaN(mv)&&!isNaN(pv)) inM.classList.add(mv>=pv?'ok':'bad');
    }
    paint();
  });

  $('#svCentersAdd').onclick=()=>{
    const n=prompt('Nombre del centro'); if(!n) return;
    if(!state.sales.centersNames.includes(n)) state.sales.centersNames.push(n);
    if(!state.sales.centers.find(r=>r.centro===n)) state.sales.centers.push({centro:n,previsto:null,mes:null});
    renderSalesSidebar(); renderSalesCenters();
  };

  openPanel('centers');
}

/* ---------------- Mentoring general ---------------- */
function renderMentoring(){
  const g = $('#gridMentoring'); g.innerHTML='';
  g.style.gridTemplateColumns='140px 1.1fr 120px 1.6fr';
  ['Fecha','Tema','Asistencia','Observaciones'].forEach(h=>{const d=document.createElement('div');d.className='head';d.textContent=h;g.appendChild(d);});

  state.mentoring.forEach((r,idx)=>{
    const inF=document.createElement('input'); inF.type='date'; inF.className='date'; inF.value=r.fecha||''; inF.oninput=()=>{r.fecha=inF.value}; g.appendChild(inF);
    const inT=document.createElement('input'); inT.className='txt'; inT.value=r.tema||''; inT.oninput=()=>{r.tema=inT.value}; g.appendChild(inT);
    const inA=document.createElement('input'); inA.className='txt'; inA.placeholder='N¬∫ / lista'; inA.value=r.asistencia||''; inA.oninput=()=>{r.asistencia=inA.value}; g.appendChild(inA);
    const inO=document.createElement('input'); inO.className='txt'; inO.value=r.obs||''; inO.oninput=()=>{r.obs=inO.value}; g.appendChild(inO);
  });

  $('#mentAdd').onclick=()=>{ state.mentoring.push({fecha:'',tema:'',asistencia:'',obs:''}); renderMentoring(); };
}

$('#btnShowMent').onclick=()=>openPanel('mentoring');

/* ======== Botones top ======== */
$('#btnSave').onclick=saveLocal;
$('#btnLoad').onclick=loadLocal;

/* ======== PIN ======== */
function enter(){
  const v=$('#pin').value.trim();
  if(v==='4321' || /^AR4321$/i.test(v)){
    $('#gate').style.display='none';
    render();
  }else{
    $('#pinMsg').style.display='block';
  }
}
$('#enter').onclick=enter;
$('#clearPin').onclick=()=>{$('#pin').value='';$('#pinMsg').style.display='none';};
$('#pin').addEventListener('keydown',e=>{ if(e.key==='Enter') enter(); });

/* ======== Inicio ======== */
window.addEventListener('load',()=>{
  // intenta cargar estado previo
  loadLocal();
  openPanel('company'); // abre por defecto compa√±√≠a
});
</script>
</body>
</html>
