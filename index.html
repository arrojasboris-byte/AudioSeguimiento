<!DOCTYPE html>
<html lang="es"><head>
  <meta charset="UTF-8">
  <title>Control Center Audio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg-main: radial-gradient(circle at top left, #111827, #020617 55%);
      --bg-card: #020617;
      --bg-card-soft: #0b1120;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --accent-red: #ff2440;
      --accent-blue: #38bdf8;
      --accent-green: #22c55e;
      --accent-orange: #f97316;
      --chip-pendiente: #facc15;
      --chip-enproceso: #4ade80;
      --chip-finalizada: #22c55e;
    }

    body.light {
      --bg-main: #f3f4f6;
      --bg-card: #ffffff;
      --bg-card-soft: #f9fafb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    html, body {
      width: 100%;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body {
      background: var(--bg-main);
      color: var(--text-main);
      display: flex;
      overflow-x: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 250px;
      background: #020617;
      border-right: 1px solid #020617;
      padding: 18px 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      color: #e5e7eb;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fee2e2, var(--accent-red));
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-title {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .logo-subtitle {
      font-size: .7rem;
      color: #9ca3af;
    }

    .section-title {
      font-size: .75rem;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: .12em;
      margin-bottom: 8px;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: .88rem;
      color: #9ca3af;
      cursor: pointer;
      transition: all .18s ease;
    }

    .nav-item span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #020617;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
    }

    .nav-item.active {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      color: #111827;
      font-weight: 600;
    }

    .nav-item.active span.icon {
      background: rgba(15,23,42,.2);
    }

    .nav-item:hover:not(.active) {
      background: rgba(31,41,55,0.7);
      color: #e5e7eb;
    }

    body.light .nav-item:hover:not(.active) {
      background: rgba(15,23,42,0.2);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: .78rem;
      color: #9ca3af;
    }

    /* MAIN LAYOUT */
    .main {
      flex: 1;
      padding: 10px 18px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 1600px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .topbar-search {
      flex: 1 1 260px;
      position: relative;
      min-width: 220px;
    }

    .topbar-search input {
      width: 100%;
      border-radius: 999px;
      padding: 8px 14px 8px 30px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card);
      color: var(--text-main);
      font-size: .86rem;
      outline: none;
    }

    .topbar-search span {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: .8rem;
      color: var(--text-muted);
    }

    .topbar-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-soft);
      font-size: .8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--bg-card);
      color: var(--text-main);
      white-space: nowrap;
      box-shadow: none;
    }

    .btn-cta {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      color: #111827;
      font-weight: 600;
      border-color: transparent;
    }

    .btn span.icon {
      font-size: .85rem;
    }

    #themeToggle {
      min-width: 120px;
      justify-content: center;
    }

    #btnGuardarVista {
      background: linear-gradient(90deg, #3b82f6, #22c55e);
      color: #0b1120;
      border-color: transparent;
      font-weight: 600;
    }

    #btnExportarHTML {
      background: linear-gradient(90deg, #8b5cf6, #ec4899);
      color: #0b1120;
      border-color: transparent;
      font-weight: 600;
    }

    #btnImprimir {
      background: linear-gradient(90deg, #14b8a6, #0ea5e9);
      color: #0b1120;
      border-color: transparent;
      font-weight: 600;
    }

    body.light #btnGuardarVista,
    body.light #btnExportarHTML,
    body.light #btnImprimir {
      color:#111827;
    }

    /* PAGES */
    .pages {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 100%;
    }

    .page {
      flex: 1;
      display: none;
      overflow-y: auto;
      overflow-x: hidden;
      max-width: 100%;
    }

    .page.active {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 10px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .card-title {
      font-size: .9rem;
      font-weight: 600;
    }

    .card-sub {
      font-size: .72rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .card-header-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .badge-small {
      font-size: .7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111827;
      color: #9ca3af;
      border: 1px solid var(--border-soft);
    }

    body.light .badge-small {
      background: #e5e7eb;
    }

    .chip-estado {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .7rem;
      font-weight: 500;
      color: #111827;
      background: #9ca3af;
    }

    .chip-estado.pendiente    { background: var(--chip-pendiente); }
    .chip-estado.enproceso    { background: var(--chip-enproceso); }
    .chip-estado.finalizada   { background: var(--chip-finalizada); }

    .btn-chip {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: transparent;
      font-size: .72rem;
      padding: 2px 6px;
      cursor: pointer;
      color: var(--accent-blue);
    }

    /* DASHBOARD PAGE */
    .dashboard-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.3fr);
      gap: 10px;
      min-height: 0;
      align-items: flex-start;
      width: 100%;
      box-sizing: border-box;
    }

    .dashboard-right-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 6px;
      margin-bottom: 6px;
    }

    .kpi-card {
      background: var(--bg-card-soft);
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .kpi-label {
      font-size: .72rem;
      color: var(--text-muted);
    }

    .kpi-value {
      font-size: .98rem;
      font-weight: 600;
    }

    .kpi-caption {
      font-size: .7rem;
      color: var(--text-muted);
    }

    .dashboard-charts {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
      min-height: 0;
    }

    .chart-container {
      position: relative;
      width: 100%;
      min-height: 160px;
      max-height: 240px;
    }

    .chart-container.centered {
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .chart-container canvas {
      position: relative;
      inset: auto !important;
      width: 100% !important;
      height: 100% !important;
      display: block;
      box-sizing: border-box;
    }

    /* contenedor espec√≠fico para los 80 criterios */
    .criterios-container {
      min-height: 260px;
      max-height: 320px;
      overflow-y: auto; /* scroll vertical para ver todos los criterios */
    }

    .ranking-list {
      font-size: .78rem;
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .ranking-row {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: space-between;
      padding:3px 0;
      border-bottom: 1px dashed rgba(148,163,184,0.3);
    }

    .ranking-main {
      display:flex;
      align-items:center;
      gap:6px;
    }

    .ranking-bar {
      height: 5px;
      border-radius:999px;
      background: var(--bg-card-soft);
      flex: 1;
      overflow:hidden;
    }

    .ranking-bar span {
      display:block;
      height:100%;
      background: linear-gradient(90deg,#22c55e,#38bdf8);
    }

    .ranking-row.extra-hidden {
      display:none;
    }

    .ranking-toggle {
      margin-top:6px;
      font-size:.76rem;
      color:var(--accent-blue);
      cursor:pointer;
      text-align:right;
    }

    .ranking-summary {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed rgba(148,163,184,0.4);
      font-size: .76rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .ranking-summary-item span {
      font-weight: 600;
      color: var(--text-main);
    }

    /* CENTROS PAGE Y DEM√ÅS */
    .centros-top {
      display: grid;
      grid-template-columns: 1.2fr 1.2fr 1fr;
      gap: 10px;
      min-height: 210px;
    }

    .delegados-list {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 160px;
      overflow: auto;
    }

    .delegado-card {
      background: var(--bg-card-soft);
      border-radius: 10px;
      padding: 4px 6px;
      border: 1px solid var(--border-soft);
      cursor: pointer;
    }

    .delegado-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }

    .delegado-main {
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.8rem;
    }

    .delegado-color {
      width:8px;
      height:8px;
      border-radius:999px;
    }

    .delegado-count {
      font-size:.72rem;
      color:var(--text-muted);
    }

    .delegado-bar {
      margin-top:3px;
      height:4px;
      border-radius:999px;
      background:var(--border-soft);
      overflow:hidden;
    }

    .delegado-bar span {
      display:block;
      height:100%;
      width:100%;
      background:linear-gradient(90deg,#38bdf8,#fb7185);
    }

    .delegado-card.active {
      outline:1px solid var(--accent-blue);
    }

    .calendar-wrapper {
      display:flex;
      flex-direction:column;
      gap:4px;
      height:100%;
    }

    .calendar-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:.85rem;
      font-weight:700;
    }

    .calendar-header button {
      border-radius:999px;
      width:24px;
      height:24px;
      border:1px solid var(--border-soft);
      background:transparent;
      color:var(--text-main);
      cursor:pointer;
      font-size:.8rem;
    }

    .calendar-weekdays {
      display:grid;
      grid-template-columns: repeat(7, minmax(0,1fr));
      font-size:.7rem;
      margin-top:4px;
      color:var(--text-muted);
      text-align:center;
    }

    .calendar-grid {
      margin-top:4px;
      display:grid;
      grid-template-columns: repeat(7, minmax(0,1fr));
      grid-template-rows: repeat(6, 42px);
      gap:4px;
      flex:1;
    }

    .cal-cell {
      border-radius:10px;
      border:1px solid var(--border-soft);
      background:var(--bg-card-soft);
      font-size:.8rem;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:flex-start;
      padding:3px 4px;
      cursor:pointer;
      position:relative;
    }

    .cal-cell.empty {
      background:transparent;
      border-style:dashed;
      cursor:default;
    }

    .cal-day {
      font-size:.78rem;
    }

    .cal-event {
      position:absolute;
      bottom:4px;
      left:4px;
      display:flex;
      align-items:center;
      gap:3px;
      font-size:.7rem;
    }

    .cal-dot {
      width:6px;
      height:6px;
      border-radius:999px;
      background:#facc15;
    }

    .cal-letter {
      font-weight:600;
    }

    .visitas-list {
      flex:1;
      overflow:auto;
      font-size:.78rem;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .visita-row {
      border-radius:10px;
      border:1px solid var(--border-soft);
      padding:4px 6px;
      background:var(--bg-card-soft);
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .visita-row-line {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
    }

    .visita-row-main {
      font-weight:500;
    }

    .visita-row-secondary {
      color:var(--text-muted);
      font-size:.72rem;
    }

    .visita-actions {
      margin-top:2px;
      display:flex;
      justify-content:flex-end;
      gap:4px;
    }

    .table-wrapper {
      flex:1;
      background: var(--bg-card);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .table-header {
      padding: 8px 10px 6px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .table-header h3 {
      font-size: .9rem;
    }

    .table-header span {
      font-size: .72rem;
      color: var(--text-muted);
    }

    .table-scroll {
      flex: 1;
      overflow: auto;
      border-top: 1px solid var(--border-soft);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .78rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: var(--bg-card);
      z-index: 2;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #0b1120;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: .75rem;
      color: var(--text-muted);
    }

    tbody tr:nth-child(even) {
      background: var(--bg-card-soft);
    }

    tbody tr:hover {
      background: rgba(15,23,42,0.8);
    }

    body.light tbody tr:nth-child(even) {
      background:#f3f4f6;
    }
    body.light tbody tr:hover {
      background:#e5e7eb;
    }

    .tag {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: .7rem;
      border: 1px solid var(--border-soft);
      background: #0b1120;
    }

    .tag.exclusivo {
      background: rgba(22,163,74,0.15);
      color: var(--accent-green);
      border-color: rgba(22,163,74,0.7);
    }

    .tag.corner {
      background: rgba(37,99,235,0.15);
      color: var(--accent-blue);
      border-color: rgba(37,99,235,0.7);
    }

    .tag-aar {
      background: rgba(148,163,184,0.15);
      border-color: rgba(148,163,184,0.7);
      color: var(--text-muted);
    }

    .tag-aar.si {
      background: rgba(34,197,94,0.15);
      border-color: rgba(34,197,94,0.7);
      color: var(--accent-green);
    }

    .tag-aar.formacion {
      background: rgba(234,179,8,0.15);
      border-color: rgba(234,179,8,0.7);
      color: #eab308;
    }

    .btn-link {
      border: none;
      background: transparent;
      color: var(--accent-blue);
      cursor: pointer;
      font-size: .74rem;
      text-decoration: underline;
    }

    .informe-layout {
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }

    .informe-top {
      display:grid;
      grid-template-columns: 1.3fr 1fr;
      gap:10px;
      min-height:190px;
    }

    .datos-grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px 12px;
      font-size:.8rem;
      margin-top:6px;
    }

    .dato-label {
      font-size:.72rem;
      color:var(--text-muted);
    }

    .dato-value {
      font-size:.82rem;
      font-weight:500;
    }

    .dato-full {
      grid-column:1 / -1;
    }

    .field-input {
      width:100%;
      padding:4px 6px;
      border-radius:8px;
      border:1px solid var(--border-soft);
      background:var(--bg-card-soft);
      color:var(--text-main);
      font-size:.8rem;
      outline:none;
    }

    .panel-graficos {
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:8px;
      min-height:0;
      max-height:340px;
      overflow:auto;
    }

    .panel-inferior {
      display: grid;
      grid-template-columns: 1.1fr 1.9fr;
      gap: 10px;
    }

    .checklist-visita {
      font-size: .78rem;
      max-height: 260px;
      overflow: auto;
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .checklist-visita label {
      display:flex;
      align-items:center;
      gap:4px;
    }

    .checklist-heading {
      margin-top:6px;
      font-size:.8rem;
      font-weight:600;
      color:var(--text-main);
    }

    .imagenes-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
      font-size: .78rem;
    }

    .imagen-item-title {
      font-size:.78rem;
      margin-bottom:3px;
    }

    .imagen-preview {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 10px;
      border: 1px dashed var(--border-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .7rem;
      color: var(--text-muted);
      overflow: hidden;
      background:var(--bg-card-soft);
      cursor:pointer;
    }

    .imagen-preview img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .observaciones-grid {
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top:4px;
    }

    .obs-item textarea {
      width:100%;
      height:80px;
      resize:vertical;
      border-radius:10px;
      border:1px solid var(--border-soft);
      background:var(--bg-card-soft);
      color:var(--text-main);
      padding:6px;
      font-size:.78rem;
      outline:none;
    }

    .obs-label {
      font-size:.78rem;
      margin-bottom:2px;
    }

    .acciones-informe {
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 14px;
      width: 420px;
      max-width: 95%;
      border: 1px solid var(--border-soft);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h3 {
      font-size: .95rem;
    }

    .modal-close {
      cursor: pointer;
      font-size: 1rem;
      color: var(--text-muted);
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: .78rem;
    }

    .modal-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .modal-field label {
      font-size: .74rem;
      color: var(--text-muted);
    }

    .modal-field input,
    .modal-field select {
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card-soft);
      color: var(--text-main);
      font-size: .78rem;
      outline: none;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    input[type="file"] {
      font-size:.75rem;
    }

    body.light .btn {
      background:#ffffff;
    }

    body.light .card {
      background:#ffffff;
    }

    /* RESPONSIVE */
    @media (max-width: 1400px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      .centros-top {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 1100px) {
      .topbar {
        flex-direction: column;
        align-items: stretch;
      }
      .topbar-buttons {
        justify-content: flex-start;
      }
      .centros-top {
        grid-template-columns: 1fr;
      }
      .informe-top {
        grid-template-columns: 1fr;
      }
      .panel-graficos {
        grid-template-columns: 1fr 1fr;
      }
      .panel-inferior {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 800px) {
      .dashboard-charts {
        grid-template-columns: 1fr;
      }
      .panel-graficos {
        grid-template-columns: 1fr;
      }
      .observaciones-grid {
        grid-template-columns: 1fr;
      }
      .imagenes-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-badge"></div>
      <div class="logo-text">
        <span class="logo-title">Control Center Audio</span>
        <span class="logo-subtitle">Gesti√≥n de centros y delegados</span>
      </div>
    </div>

    <div>
      <div class="section-title">Secciones</div>
      <nav class="nav-list">
        <div class="nav-item" data-page="dashboard">
          <span class="icon">üè†</span> Dashboard
        </div>
        <div class="nav-item" data-page="centros">
          <span class="icon">üè¢</span> Centros
        </div>
        <div class="nav-item active" data-page="informe">
          <span class="icon">üìã</span> Informe de la visita
        </div>
        <div class="nav-item" data-page="servicios">
          <span class="icon">üõ†</span> Servicios
        </div>
        <div class="nav-item" data-page="ventas">
          <span class="icon">üí≥</span> Ventas
        </div>
        <div class="nav-item" data-page="proyectos">
          <span class="icon">üìä</span> Proyectos
        </div>
      </nav>
    </div>

    <div class="sidebar-footer">
      Versi√≥n demo ¬∑ Datos ficticios
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="topbar-search">
        <span>üîç</span>
        <input id="searchGlobal" placeholder="Buscar por centro, propietario o delegado...">
      </div>
      <div class="topbar-buttons">
        <button class="btn" id="themeToggle">
          <span class="icon">üåì</span> Oscuro / Claro
        </button>
        <button class="btn" id="btnGuardarVista">
          <span class="icon">üíæ</span> Guardar vista
        </button>
        <button class="btn" id="btnExportarHTML">
          <span class="icon">‚¨áÔ∏è</span> Exportar HTML
        </button>
        <button class="btn" id="btnImprimir">
          <span class="icon">üñ®</span> Imprimir
        </button>
        <button class="btn btn-cta" id="btnActualizarNube">
          <span class="icon">‚òÅÔ∏è</span> Actualizar datos nube
        </button>
      </div>
    </div>

    <div class="pages">
      <section class="page" data-page="dashboard">
        <div class="dashboard-grid">
          <article class="card">
            <div class="card-header-row">
              <span class="card-title">Resumen general</span>
              <span class="badge-small">Demo ¬∑ Promedios sobre visitas guardadas</span>
            </div>

            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-label">% de aplicaci√≥n de procesos</div>
                <div class="kpi-value" id="kpiProcesos">‚Äì</div>
                <div class="kpi-caption">Objetivo 85‚Äì100%</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Conv. a prueba</div>
                <div class="kpi-value" id="kpiConvPrueba">‚Äì</div>
                <div class="kpi-caption">Objetivo 80%</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Conv. a venta</div>
                <div class="kpi-value" id="kpiConvVenta">‚Äì</div>
                <div class="kpi-caption">Objetivo 80%</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Aplicaci√≥n HIT</div>
                <div class="kpi-value" id="kpiHIT">‚Äì</div>
                <div class="kpi-caption">Objetivo 85‚Äì100%</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Formaciones %</div>
                <div class="kpi-value" id="kpiFormaciones">‚Äì</div>
                <div class="kpi-caption">Media de m√≥dulos formativos</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Ayuda</div>
                <div class="kpi-value" id="kpiAyuda">‚Äì</div>
                <div class="kpi-caption">Telecare / PIA / Telehear</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">AAR</div>
                <div class="kpi-value" id="kpiAar">‚Äì</div>
                <div class="kpi-caption">Centros con AAR</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Primeros auxilios</div>
                <div class="kpi-value" id="kpiPrimeros">‚Äì</div>
                <div class="kpi-caption">Centros con formaci√≥n</div>
              </div>
            </div>

            <div class="dashboard-charts">
              <div class="card">
                <div class="card-header-row">
                  <span class="card-title">Radar general</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartRadarGeneral" width="360" height="360" style="display: block; box-sizing: border-box; height: 240px; width: 240px;"></canvas>
                </div>
              </div>

              <div class="card">
                <div class="card-header-row">
                  <span class="card-title">Procesos y √°reas de mejora por mes</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartProcesosMes" width="438" height="240" style="display: block; box-sizing: border-box; height: 160px; width: 292px;"></canvas>
                </div>
              </div>

              <div class="card">
                <div class="card-header-row">
                  <span class="card-title">√Åreas de mejora por mes</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartAreasMes" width="438" height="240" style="display: block; box-sizing: border-box; height: 160px; width: 292px;"></canvas>
                </div>
              </div>

              <div class="card">
                <div class="card-header-row">
                  <span class="card-title">Primeros auxilios por mes</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartPrimerosMes" width="438" height="240" style="display: block; box-sizing: border-box; height: 160px; width: 292px;"></canvas>
                </div>
              </div>

              <div class="card">
                <div class="card-header-row">
                  <span class="card-title">Top 10 √°reas de mejora</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartTopAreas" width="438" height="240" style="display: block; box-sizing: border-box; height: 160px; width: 292px;"></canvas>
                </div>
              </div>

              <div class="card">
                <div class="card-header-row">
                  <span class="card-title">Aplicaci√≥n AAR / HIT</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartAarHitDonut" width="438" height="360" style="display: block; box-sizing: border-box; height: 240px; width: 292px;"></canvas>
                </div>
              </div>
            </div>
          </article>

          <div class="dashboard-right-column">
            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Evaluaci√≥n detallada de procesos (80 criterios)</span>
                <span class="badge-small">Se actualiza con los checklists CORNER / EXCLUSIVO</span>
              </div>
              <div class="card-sub" id="criteriosEmptyMsg" style="display: none;">
                Adjunta un checklist en el informe de la visita para ver el detalle por criterios.
              </div>
              <div class="chart-container criterios-container">
                <canvas id="chartCriteriosDetalle" width="1435" style="height: 260px; display: block; box-sizing: border-box; width: 957px;" height="390"></canvas>
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Ranking de delegados</span>
              </div>
              <div class="ranking-list" id="rankingDelegados"></div>
              <div class="ranking-toggle" id="rankingToggle" style="display: block;">
                Mostrar todos
              </div>
              <div class="ranking-summary" id="rankingResumen">
                <div class="ranking-summary-item">
                  Top delegado: <span id="rankingTopDelegado">ENERITZ ARANGUREN</span>
                </div>
                <div class="ranking-summary-item">
                  Media procesos delegados: <span id="rankingMediaProcesos">87%</span>
                </div>
              </div>
            </article>
          </div>
        </div>
      </section>

      <section class="page" data-page="centros">
        <div class="centros-top">
          <article class="card">
            <div class="card-header-row">
              <span class="card-title">Centros y delegados</span>
              <span class="badge-small"><span id="numDelegados">6</span> delegados</span>
            </div>
            <div class="delegados-list" id="delegadosList"></div>
            <div style="display:flex; gap:8px; margin-top:6px;">
              <button class="btn btn-cta" id="btnAddCentro">
                <span class="icon">‚ûï</span> A√±adir centro
              </button>
              <button class="btn" id="btnAdjuntarExcel">
                <span class="icon">üì§</span> Adjuntar centros (Excel)
              </button>
              <input type="file" id="inputExcel" accept=".xlsx,.xls" style="display:none">
            </div>

            <div style="margin-top:4px; font-size:.74rem; color:var(--text-muted);">
              Centros mostrados: <span id="centrosMostrados">10</span> / <span id="centrosTotal">10</span>
            </div>
          </article>

          <article class="card">
            <div class="calendar-wrapper">
              <div class="calendar-header">
                <button id="calPrev">&lt;</button>
                <div class="calendar-month" id="calTitulo" style="font-weight:700;">Diciembre de 2025</div>
                <button id="calNext">&gt;</button>
              </div>
              <div class="calendar-weekdays">
                <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
              </div>
              <div class="calendar-grid" id="calendarGrid"></div>
              <div style="font-size:.72rem; color:var(--text-muted); margin-top:2px;">
                Clic en un d√≠a para agendar visita.
              </div>
            </div>
          </article>

          <article class="card">
            <div class="card-header-row">
              <span class="card-title">Visitas agendadas</span>
            </div>
            <div class="visitas-list" id="visitasList"></div>
          </article>
        </div>

        <section class="table-wrapper">
          <div class="table-header">
            <div>
              <h3>Listado de centros</h3>
            </div>
            <span class="badge-small" id="totalCentrosLabel">Centros mostrados: 10 / 10</span>
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Propietario</th>
                  <th>Centro</th>
                  <th>Provincia</th>
                  <th>Delegado</th>
                  <th>Tipo</th>
                  <th>Informes</th>
                  <th>Centro AAR</th>
                </tr>
              </thead>
              <tbody id="tablaCentrosBody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <section class="page active" data-page="informe">
        <div class="informe-layout">
          <div class="informe-top">
            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Datos del centro</span>
              </div>
              <div class="datos-grid">
                <div>
                  <div class="dato-label">Centro</div>
                  <input id="infCentro" class="field-input" readonly="">
                </div>
                <div>
                  <div class="dato-label">Provincia</div>
                  <input id="infProvincia" class="field-input" readonly="">
                </div>
                <div>
                  <div class="dato-label">Delegado</div>
                  <input id="infDelegado" class="field-input" readonly="">
                </div>
                <div>
                  <div class="dato-label">Tipo</div>
                  <input id="infTipo" class="field-input" readonly="">
                </div>
                <div>
                  <div class="dato-label">Responsable audio</div>
                  <input id="infRespAudio" class="field-input" readonly="">
                </div>
                <div>
                  <div class="dato-label">Fecha visita</div>
                  <input id="infFecha" class="field-input" readonly="">
                </div>
                <div>
                  <div class="dato-label">Audi√≥logo</div>
                  <input id="infAudiologo" class="field-input">
                </div>
                <div>
                  <div class="dato-label">Horas de servicio</div>
                  <input id="infHoras" class="field-input">
                </div>
                <div class="dato-full" style="margin-top:4px;">
                  <button class="btn btn-cta" id="btnAdjuntarChecklist">
                    <span class="icon">üìé</span> Adjuntar checklist
                  </button>
                  <input type="file" id="inputChecklist" accept=".xlsx,.xls" style="display:none">
                  <span id="nombreChecklist" style="margin-left:8px; font-size:.74rem; color:var(--text-muted);"></span>
                </div>
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">KPIs del centro</span>
              </div>
              <div style="font-size:.78rem; margin-top:4px;">
                <div>% de aplicaci√≥n de procesos: <strong id="kpiCentroProcesos">0%</strong></div>
                <div>Conv. a prueba: <strong id="kpiCentroPrueba">0%</strong></div>
                <div>Conv. a cierre: <strong id="kpiCentroVenta">0%</strong></div>
                <div>Aplicaci√≥n HIT: <strong id="kpiCentroHit">No</strong></div>
              </div>
              <div class="chart-container centered" style="margin-top:6px; max-height:180px;">
                <canvas id="chartCentroRadar" width="270" height="270" style="display: block; box-sizing: border-box; height: 180px; width: 180px;"></canvas>
              </div>
            </article>
          </div>

          <div class="panel-graficos">
            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Palancas SI / NO (barras)</span>
              </div>
              <div class="chart-container">
                <canvas id="chartCentroSiNoBarras" width="441" height="240" style="display: block; box-sizing: border-box; height: 160px; width: 294px;"></canvas>
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Palancas SI / NO (donut)</span>
              </div>
              <div class="chart-container">
                <canvas id="chartCentroSiNoDonut" width="441" height="360" style="display: block; box-sizing: border-box; height: 240px; width: 294px;"></canvas>
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Procesos y √°reas de mejora (centro)</span>
              </div>
              <div class="chart-container">
                <canvas id="chartCentroProcesosMes" width="441" height="240" style="display: block; box-sizing: border-box; height: 160px; width: 294px;"></canvas>
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">HIT por mes (centro)</span>
              </div>
              <div class="chart-container">
                <canvas id="chartCentroHitMes" width="441" height="240" style="display: block; box-sizing: border-box; height: 160px; width: 294px;"></canvas>
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">√Åreas de mejora por mes</span>
              </div>
              <div class="chart-container">
                <canvas id="chartCentroAreasMes" width="441" height="240" style="display: block; box-sizing: border-box; height: 160px; width: 294px;"></canvas>
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Top 10 √°reas de mejora</span>
              </div>
              <div class="chart-container">
                <canvas id="chartCentroTopAreas" width="441" height="240" style="display: block; box-sizing: border-box; height: 160px; width: 294px;"></canvas>
              </div>
            </article>
          </div>

          <div class="panel-inferior">
            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Formaciones y habilidades</span>
              </div>
              <div class="checklist-visita" style="margin-top:6px;">
                <label><input type="checkbox" data-kpi="wsa"> WSA</label>
                <label><input type="checkbox" data-kpi="starkey"> Starkey</label>
                <label><input type="checkbox" data-kpi="neuroventas"> Habilidades comerciales / Neuroventas</label>
                <label><input type="checkbox" data-kpi="hit"> HIT</label>
                <label><input type="checkbox" data-kpi="telecare"> Telecare</label>
                <label><input type="checkbox" data-kpi="pia"> PIA</label>
                <label><input type="checkbox" data-kpi="telehear"> Telehear</label>
                <label><input type="checkbox" data-kpi="infinity"> Financiaci√≥n Infinity</label>
                <label><input type="checkbox" data-kpi="seguros"> Venta de seguro</label>
                <label><input type="checkbox" data-kpi="primeros"> Primeros auxilios (equipo)</label>
                <div class="checklist-heading">Producto y comunicaci√≥n</div>
                <label><input type="checkbox" data-kpi="rt"> Audiometr√≠a RT</label>
                <label><input type="checkbox" data-kpi="audio_test"> Test de lectura audio</label>
                <label><input type="checkbox" data-kpi="audio_screening"> Screening audio</label>
                <label><input type="checkbox" data-kpi="audio_manteleta"> Manteleta audio</label>
                <label><input type="checkbox" data-kpi="audio_escaparate"> Escaparate visible audio</label>
                <label><input type="checkbox" data-kpi="audio_salud"> Salud auditiva en PDV</label>
                <label><input type="checkbox" data-kpi="audio_renove"> Elementos Renove</label>
                <label><input type="checkbox" data-kpi="mgm"> Elementos MGM</label>
                <label><input type="checkbox" data-kpi="stock"> Stock</label>
                <label><input type="checkbox" data-kpi="tchin"> Tchin Tchin</label>
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Im√°genes del centro</span>
              </div>
              <div class="imagenes-grid" style="margin-top:4px;">
                <div>
                  <div class="imagen-item-title">Centro exterior</div>
                  <div class="imagen-preview" data-target="ext">
                    Adjuntar imagen
                  </div>
                  <input type="file" accept="image/*" data-input-img="ext" style="display:none">
                </div>
                <div>
                  <div class="imagen-item-title">Centro interior</div>
                  <div class="imagen-preview" data-target="int">
                    Adjuntar imagen
                  </div>
                  <input type="file" accept="image/*" data-input-img="int" style="display:none">
                </div>
                <div>
                  <div class="imagen-item-title">Gabinete</div>
                  <div class="imagen-preview" data-target="gab">
                    Adjuntar imagen
                  </div>
                  <input type="file" accept="image/*" data-input-img="gab" style="display:none">
                </div>
              </div>
            </article>
          </div>

          <article class="card">
            <div class="card-header-row">
              <span class="card-title">Resumen de la visita</span>
            </div>
            <div class="panel-graficos" style="max-height:none;">
              <article class="card">
                <div class="card-header-row">
                  <span class="card-title">Procesos aplicados</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartCentroProcesosResumen" width="438" height="360" style="display: block; box-sizing: border-box; height: 240px; width: 292px;"></canvas>
                </div>
              </article>
              <article class="card">
                <div class="card-header-row">
                  <span class="card-title">√Åreas de mejora</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartCentroAreasResumen" width="438" height="240" style="display: block; box-sizing: border-box; height: 160px; width: 292px;"></canvas>
                </div>
              </article>
              <article class="card">
                <div class="card-header-row">
                  <span class="card-title">Conv. prueba / venta</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartCentroConversionResumen" width="438" height="240" style="display: block; box-sizing: border-box; height: 160px; width: 292px;"></canvas>
                </div>
              </article>
            </div>
          </article>

          <article class="card">
            <div class="card-header-row">
              <span class="card-title">Observaciones ¬∑ Recomendaciones ¬∑ Compromisos</span>
            </div>
            <div class="observaciones-grid" style="margin-top:6px;">
              <div class="obs-item">
                <div class="obs-label">Observaciones</div>
                <textarea id="obsObservaciones"></textarea>
              </div>
              <div class="obs-item">
                <div class="obs-label">Recomendaciones</div>
                <textarea id="obsRecomendaciones"></textarea>
              </div>
              <div class="obs-item">
                <div class="obs-label">Compromisos</div>
                <textarea id="obsCompromisos"></textarea>
              </div>
            </div>
            <div class="acciones-informe">
              <button class="btn btn-cta" id="btnGuardarInforme">
                <span class="icon">üíæ</span> Guardar informe
              </button>
            </div>
          </article>
        </div>
      </section>

      <section class="page" data-page="servicios">
        <article class="card">
          <div class="card-title">Servicios</div>
          <div class="card-sub">M√≥dulo placeholder para futuras funcionalidades.</div>
        </article>
      </section>

      <section class="page" data-page="ventas">
        <article class="card">
          <div class="card-title">Ventas</div>
          <div class="card-sub">M√≥dulo placeholder para futuras funcionalidades.</div>
        </article>
      </section>

      <section class="page" data-page="proyectos">
        <article class="card">
          <div class="card-title">Proyectos</div>
          <div class="card-sub">M√≥dulo placeholder para futuras funcionalidades.</div>
        </article>
      </section>
    </div>
  </main>

  <div class="modal-backdrop" id="modalVisita" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3>Agendar visita</h3>
        <span class="modal-close" data-close="modalVisita">‚úï</span>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <label>Fecha</label>
          <input id="visitaFecha" readonly="" data-iso="2025-12-09">
        </div>
        <div class="modal-field">
          <label>Responsable audio</label>
          <select id="visitaResp">
            <option value="Ariannys Rojas">Ariannys Rojas</option>
            <option value="Sonia Guasque">Sonia Guasque</option>
          </select>
        </div>
        <div class="modal-field">
          <label>Centro</label>
          <input id="visitaCentro" list="listaCentros">
          <datalist id="listaCentros"></datalist>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modalVisita">Cancelar</button>
        <button class="btn btn-cta" id="btnGuardarVisita">Guardar visita</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalCentro">
    <div class="modal">
      <div class="modal-header">
        <h3>Nuevo centro</h3>
        <span class="modal-close" data-close="modalCentro">‚úï</span>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <label>C√≥digo</label>
          <input id="nuevoCodigo">
        </div>
        <div class="modal-field">
          <label>Propietario</label>
          <input id="nuevoPropietario">
        </div>
        <div class="modal-field">
          <label>Centro</label>
          <input id="nuevoCentro">
        </div>
        <div class="modal-field">
          <label>Provincia</label>
          <input id="nuevoProvincia">
        </div>
        <div class="modal-field">
          <label>Delegado</label>
          <input id="nuevoDelegado">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modalCentro">Cancelar</button>
        <button class="btn btn-cta" id="guardarCentro">Guardar centro</button>
      </div>
    </div>
  </div>

  <script>
    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    /* UTILS */
    function formatDateISO(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function formatDateHuman(iso) {
      const [y,m,d] = iso.split("-");
      return `${d}-${m}-${y}`;
    }

    /* NAV */
    const pages = $$(".page");
    $$(".nav-item").forEach(item => {
      item.addEventListener("click", () => {
        const page = item.dataset.page;
        $$(".nav-item").forEach(i => i.classList.toggle("active", i === item));
        pages.forEach(p => p.classList.toggle("active", p.dataset.page === page));
      });
    });

    /* TEMA */
    $("#themeToggle").addEventListener("click", () => {
      document.body.classList.toggle("light");
      Object.values(globalCharts).forEach(ch => ch && ch.resize());
      if (centroChartsCreated) Object.values(centroCharts).forEach(ch => ch && ch.resize());
    });

    /* BOTONES */
    $("#btnGuardarVista").addEventListener("click", () => alert("Vista guardada (demo)."));
    $("#btnActualizarNube").addEventListener("click", () => alert("Sincronizando con nube (demo)..."));
    $("#btnImprimir").addEventListener("click", () => window.print());
    $("#btnExportarHTML").addEventListener("click", () => {
      const content = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
      const blob = new Blob([content], {type:"text/html"});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      a.href = url; a.download = "control-center-audio.html";
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });

    /* DATOS */
    const exclusivosSet = new Set([
      "CC LOS VALLES", "FUENLABRADA Calle Leganes", "PAMPLONA C. Exclusivo",
      "PAMPLONA Calle Sancho el Mayor", "PAMPLONA Carlos III", "REINA DE MERCEDES",
      "SANTANDER CC PE√ëACASTILLO", "SANTIAGO DE COMPOSTELA RUA DA ROSA",
      "TORRELAVEGA CARREFOUR CC", "ZARAGOZA CALLE DELICIAS"
    ]);

    const centros = [];
    const informesPorCentro = {};
    const aarPorCentro = {};
    const delegadosColores = {};
    const colorPalette = ["#22c55e","#2563eb","#14b8a6","#a855f7","#f97316","#0ea5e9","#ef4444","#eab308","#ec4899"];

    function getColorForDelegado(nombre) {
      if (!delegadosColores[nombre]) {
        const idx = Object.keys(delegadosColores).length % colorPalette.length;
        delegadosColores[nombre] = colorPalette[idx];
      }
      return delegadosColores[nombre];
    }

    function tipoCentro(nombreCentro) {
      return exclusivosSet.has(nombreCentro) ? "Exclusivo" : "Corner";
    }

    /* RENDER TABLA */
    let filtroDelegadoActual = null;
    let filtroTextoActual = "";

    function renderTablaCentros() {
      const tbody = $("#tablaCentrosBody");
      tbody.innerHTML = "";
      const filtrados = centros.filter(c => {
        const cad = (c.centro+" "+c.propietario+" "+c.delegado).toLowerCase();
        return cad.includes(filtroTextoActual.toLowerCase()) && (!filtroDelegadoActual || c.delegado === filtroDelegadoActual);
      });

      filtrados.forEach(c => {
        const tr = document.createElement("tr");
        const t  = tipoCentro(c.centro);
        const informes = informesPorCentro[c.centro] || 0;
        const aarEstado = aarPorCentro[c.centro] || "No";
        tr.innerHTML = `
          <td>${c.codigo}</td>
          <td>${c.propietario}</td>
          <td>${c.centro}</td>
          <td>${c.provincia}</td>
          <td>${c.delegado}</td>
          <td><span class="tag ${t === 'Exclusivo' ? 'exclusivo' : 'corner'}">${t}</span></td>
          <td><button class="btn-link btn-informe-centro" data-centro="${c.centro}">${informes ? `Ver (${informes})` : "A√±adir informe"}</button></td>
          <td><span class="tag tag-aar ${aarEstado==='S√≠'?'si':''}">${aarEstado}</span></td>
        `;
        tbody.appendChild(tr);
      });
      $("#totalCentrosLabel").textContent = `Centros mostrados: ${filtrados.length} / ${centros.length}`;
      $("#centrosMostrados").textContent = filtrados.length;
      $("#centrosTotal").textContent = centros.length;
    }

    /* DELEGADOS */
    function renderDelegados() {
      const map = new Map();
      centros.forEach(c => {
        if (!map.has(c.delegado)) map.set(c.delegado, []);
        map.get(c.delegado).push(c);
      });
      const list = $("#delegadosList");
      list.innerHTML = "";
      Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([nombre, lista]) => {
        const card = document.createElement("div");
        card.className = "delegado-card";
        const color = getColorForDelegado(nombre);
        card.innerHTML = `
          <div class="delegado-header">
            <div class="delegado-main"><span class="delegado-color" style="background:${color}"></span><span>${nombre}</span></div>
            <span class="delegado-count">${lista.length} centros</span>
          </div>
          <div class="delegado-bar"><span style="background:${color}"></span></div>
        `;
        card.addEventListener("click", () => {
          if (filtroDelegadoActual === nombre) { filtroDelegadoActual = null; card.classList.remove("active"); }
          else { filtroDelegadoActual = nombre; $$(".delegado-card").forEach(c=>c.classList.remove("active")); card.classList.add("active"); }
          renderTablaCentros();
        });
        list.appendChild(card);
      });
      $("#numDelegados").textContent = map.size;
      renderRankingDelegados(map);
    }

    function renderRankingDelegados(map) {
      const div = $("#rankingDelegados");
      div.innerHTML = "";
      const arr = Array.from(map.entries()).map(([nombre]) => ({
        nombre, score: Math.floor(80 + Math.random()*15)
      })).sort((a,b)=>b.score-a.score);
      
      arr.forEach((d, idx) => {
        const row = document.createElement("div");
        row.className = "ranking-row";
        if (idx >= 5) row.classList.add("extra-hidden");
        const color = getColorForDelegado(d.nombre);
        row.innerHTML = `
          <div class="ranking-main">
             <span style="font-size:.75rem; color:var(--text-muted);">${idx+1}.</span>
             <span class="delegado-color" style="background:${color}"></span>
             <span>${d.nombre}</span>
          </div>
          <div style="flex:1; display:flex; align-items:center; gap:4px; margin-left:6px;">
            <div class="ranking-bar"><span style="width:${d.score}%; background:${color}"></span></div>
            <span style="font-size:.72rem;">${d.score}</span>
          </div>
        `;
        div.appendChild(row);
      });
      $("#rankingTopDelegado").textContent = arr.length ? arr[0].nombre : "-";
    }

    $("#searchGlobal").addEventListener("input", e => {
      filtroTextoActual = e.target.value || "";
      renderTablaCentros();
    });

    /* CALENDARIO & VISITAS */
    const visitas = [];
    let visitaActual = null;
    let calYear, calMonth;

    function initCalendar() {
      const now = new Date();
      calYear = now.getFullYear(); calMonth = now.getMonth();
      drawCalendar();
    }
    function drawCalendar() {
      const grid = $("#calendarGrid");
      grid.innerHTML = "";
      const first = new Date(calYear, calMonth, 1);
      const dow = (first.getDay()+6)%7;
      const last = new Date(calYear, calMonth+1, 0).getDate();
      
      const formatter = new Intl.DateTimeFormat("es-ES", {month:"long", year:"numeric"});
      $("#calTitulo").textContent = formatter.format(first).replace(/^\w/, c=>c.toUpperCase());

      for (let i=0; i<42; i++) {
        const dayNum = i - dow + 1;
        const cell = document.createElement("div");
        if (dayNum < 1 || dayNum > last) {
          cell.className = "cal-cell empty";
        } else {
          cell.className = "cal-cell";
          const dateIso = formatDateISO(new Date(calYear, calMonth, dayNum));
          cell.innerHTML = `<div class="cal-day">${dayNum}</div>`;
          const v = visitas.find(v=>v.fecha===dateIso);
          if (v) cell.innerHTML += `<div class="cal-event"><span class="cal-dot"></span><span class="cal-letter">V</span></div>`;
          cell.addEventListener("click", ()=> abrirModalVisita(dateIso));
        }
        grid.appendChild(cell);
      }
    }
    $("#calPrev").addEventListener("click", ()=>{ calMonth--; if(calMonth<0){calMonth=11;calYear--;} drawCalendar(); });
    $("#calNext").addEventListener("click", ()=>{ calMonth++; if(calMonth>11){calMonth=0;calYear++;} drawCalendar(); });

    function abrirModalVisita(iso) {
      $("#visitaFecha").value = formatDateHuman(iso);
      $("#visitaFecha").dataset.iso = iso;
      $("#visitaCentro").value = "";
      abrirModal("modalVisita");
    }
    $("#btnGuardarVisita").addEventListener("click", ()=> {
      const centro = $("#visitaCentro").value;
      if(!centro) return alert("Elige centro");
      visitas.push({ fecha: $("#visitaFecha").dataset.iso, centro, estado: "pendiente" });
      cerrarModal("modalVisita"); drawCalendar(); renderVisitas();
    });

    function renderVisitas() {
      const list = $("#visitasList");
      list.innerHTML = "";
      visitas.sort((a,b)=>a.fecha.localeCompare(b.fecha));
      visitas.forEach((v, idx) => {
        const row = document.createElement("div");
        row.className = "visita-row";
        row.innerHTML = `
          <div class="visita-row-line">
            <span class="visita-row-main">${formatDateHuman(v.fecha)} ¬∑ ${v.centro}</span>
            <span class="chip-estado ${v.estado}">${v.estado}</span>
          </div>
          <div class="visita-actions">
            <button class="btn-chip btn-ir-informe" data-centro="${v.centro}" data-idx="${idx}">Informe</button>
          </div>
        `;
        list.appendChild(row);
      });
    }

    /* MODALES */
    function abrirModal(id){ document.getElementById(id).style.display = "flex"; }
    function cerrarModal(id){ document.getElementById(id).style.display = "none"; }
    $$(".modal-close").forEach(el => el.addEventListener("click", ()=> cerrarModal(el.dataset.close)));

    /* -------------------------------------------------------------------------- */
    /* LOGICA CHECKLIST EXCEL + INTEGRACI√ìN CON GR√ÅFICOS RESTAURADOS              */
    /* -------------------------------------------------------------------------- */
    
    let centroChartsCreated = false;
    let globalCharts = {};
    let centroCharts = {};
    let centroActual = null;
    let ultimoChecklistData = null; // Almacena datos parseados del excel para este centro

    // 1. Adjuntar Excel
    $("#btnAdjuntarChecklist").addEventListener("click", () => $("#inputChecklist").click());
    
    $("#inputChecklist").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        $("#nombreChecklist").textContent = file.name;
        leerChecklist(file); // Nueva funci√≥n l√≥gica
      }
    });

    function leerChecklist(file) {
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          
          // Detectar tipo
          const nameUpper = file.name.toUpperCase();
          let tipo = "CORNER";
          if (nameUpper.includes("EXCLUSIVO")) tipo = "EXCLUSIVO";

          procesarFilas(rows, tipo); // Nueva l√≥gica de parseo
          
        } catch (err) {
          console.error(err);
          alert("Error al leer Excel. Aseg√∫rate de usar un Checklist v√°lido.");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function procesarFilas(rows, tipo) {
      // Coordenadas basadas en tu l√≥gica anterior
      let rStart, rEnd, colCrit, colRes, filaProc, colProc, filaHit, colHit, filaPrueba, colPrueba, filaVenta, colVenta;

      if (tipo === "EXCLUSIVO") {
        rStart = 7; rEnd = 101; colCrit = 1; colRes = 5; // B & F
        filaProc = 103; colProc = 5; // F104
        filaHit  = 64;  colHit  = 5; // F65
        filaPrueba = 125; colPrueba = 8; // I126
        filaVenta  = 126; colVenta  = 8; // I127
      } else { // CORNER
        rStart = 6; rEnd = 87; colCrit = 1; colRes = 5;
        filaProc = 89; colProc = 5; // F90
        filaHit  = 62; colHit  = 5; // F63
        filaPrueba = 91; colPrueba = 1; // B92
        filaVenta  = 92; colVenta  = 1; // B93
      }

      // 1. Extraer los 80 criterios para el gr√°fico de detalle
      const labels = [];
      const dataVals = [];
      for (let r=rStart; r<=rEnd && r<rows.length; r++) {
        const row = rows[r] || [];
        const nombre = row[colCrit];
        const val = row[colRes];
        if (nombre) {
          labels.push(nombre);
          dataVals.push(val == 1 ? 100 : 0);
        }
      }

      // 2. Extraer KPIs
      const cleanPct = (v) => {
         if (v == null) return 0;
         if (typeof v === 'number') return v <= 1 ? Math.round(v*100) : v;
         return parseFloat(String(v).replace(',','.')) || 0;
      };

      const procPct = cleanPct((rows[filaProc]||[])[colProc]);
      const hitVal  = (rows[filaHit]||[])[colHit] == 1;
      const pruebaPct = cleanPct((rows[filaPrueba]||[])[colPrueba]);
      const ventaPct  = cleanPct((rows[filaVenta]||[])[colVenta]);

      // Guardamos en variable global para usar en actualizarChartsCentro
      ultimoChecklistData = {
        procesos: procPct,
        hit: hitVal,
        prueba: pruebaPct,
        venta: ventaPct,
        labels,
        dataVals
      };

      alert(`Checklist ${tipo} procesado.\nProcesos: ${procPct}% | HIT: ${hitVal?'S√≠':'No'}`);
      
      // Actualizamos UI inmediatamente
      actualizarGraficoCriterios(labels, dataVals);
      actualizarChartsCentro(); 
    }

    function actualizarGraficoCriterios(labels, dataVals) {
      if (!globalCharts.criteriosDetalle) {
        // Inicializar si no existe
        const ctx = document.getElementById("chartCriteriosDetalle").getContext("2d");
        globalCharts.criteriosDetalle = new Chart(ctx, {
          type: "bar",
          data: { labels: labels, datasets: [{ label: "%", data: dataVals, backgroundColor: "#38bdf8" }] },
          options: { indexAxis: "y", maintainAspectRatio: false, plugins: { legend: { display:false } } }
        });
      } else {
        const ch = globalCharts.criteriosDetalle;
        ch.data.labels = labels;
        ch.data.datasets[0].data = dataVals;
        ch.update();
      }
      // Ajustar altura
      const container = document.querySelector(".criterios-container");
      // document.getElementById("chartCriteriosDetalle").style.height = (labels.length * 20) + "px";
      $("#criteriosEmptyMsg").style.display = "none";
    }

    /* CHARTS CENTRO (CREACI√ìN Y ACTUALIZACI√ìN) */
    function crearChartsCentro() {
      if (centroChartsCreated) return;
      centroChartsCreated = true;

      // Radar
      const radarCtx = document.getElementById("chartCentroRadar").getContext("2d");
      centroCharts.radar = new Chart(radarCtx, {
        type: "radar",
        data: {
          labels: ["Formaciones","1os aux","Procesos","Prueba","Venta"],
          datasets: [{ label: "%", data: [0,0,0,0,0], backgroundColor: "rgba(56,189,248,0.2)", borderColor: "#38bdf8" }]
        },
        options: { plugins: { legend: {display:false} }, scales: { r: { min:0, max:100, ticks:{display:false} } } }
      });

      // Barras Si/No
      centroCharts.barras = new Chart(document.getElementById("chartCentroSiNoBarras").getContext("2d"), {
        type: "bar",
        data: { labels: ["AAR","HIT","Infinity"], datasets: [{ label: "Estado", data: [0,0,0], backgroundColor: ["#22c55e","#3b82f6","#f97316"] }] },
        options: { plugins: {legend:{display:false}}, scales: { y: {display:false} } }
      });
      
      // Donut
      centroCharts.donut = new Chart(document.getElementById("chartCentroSiNoDonut").getContext("2d"), {
        type: "doughnut", data: { labels: ["S√≠","No"], datasets: [{ data: [5,5], backgroundColor: ["#22c55e","#ef4444"] }] },
        options: { cutout: "60%", plugins: { legend: {position:"bottom"} } }
      });

      // Linea Procesos
      centroCharts.procMes = new Chart(document.getElementById("chartCentroProcesosMes").getContext("2d"), {
        type:"line", data:{ labels:["Ene","Feb","Mar"], datasets:[{ data:[80,85,90], borderColor:"#3b82f6", tension:0.4 }] },
        options:{ plugins:{legend:{display:false}}, maintainAspectRatio:false }
      });

      // Otros placeholders para mantener dise√±o
      centroCharts.hitMes = new Chart(document.getElementById("chartCentroHitMes").getContext("2d"), {
        type:"bar", data:{ labels:["Ene","Feb"], datasets:[{ data:[1,1], backgroundColor:"#f97316" }] }, options:{plugins:{legend:{display:false}}}
      });
      centroCharts.areasMes = new Chart(document.getElementById("chartCentroAreasMes").getContext("2d"), {
        type:"bar", data:{ labels:["Ene","Feb"], datasets:[{ data:[5,4], backgroundColor:"#ef4444" }] }, options:{plugins:{legend:{display:false}}}
      });
      centroCharts.topAreas = new Chart(document.getElementById("chartCentroTopAreas").getContext("2d"), {
        type:"bar", data:{ labels:["Stock","Orden"], datasets:[{ data:[2,1], backgroundColor:"#3b82f6" }] }, options:{indexAxis:'y', plugins:{legend:{display:false}}}
      });
    }

    function actualizarChartsCentro() {
      if (!centroChartsCreated) crearChartsCentro();
      
      let procesos = 0, prueba = 0, venta = 0, hit = false;
      
      if (ultimoChecklistData) {
        // Usar datos del Excel
        procesos = ultimoChecklistData.procesos;
        prueba   = ultimoChecklistData.prueba;
        venta    = ultimoChecklistData.venta;
        hit      = ultimoChecklistData.hit;
      } else {
        // Fallback datos dummy o checkboxes manuales
        procesos = 85; prueba = 80; venta = 75;
      }

      // Actualizar DOM
      $("#kpiCentroProcesos").textContent = procesos + "%";
      $("#kpiCentroPrueba").textContent = prueba + "%";
      $("#kpiCentroVenta").textContent = venta + "%";
      $("#kpiCentroHit").textContent = hit ? "S√≠" : "No";

      // Actualizar Charts
      centroCharts.radar.data.datasets[0].data = [80, 50, procesos, prueba, venta];
      centroCharts.radar.update();

      centroCharts.barras.data.datasets[0].data = [1, hit?1:0, 1]; // Ejemplo AAR fijo en 1
      centroCharts.barras.update();
      
      // Resumenes finales
      // ... se pueden a√±adir m√°s actualizaciones aqu√≠
    }

    /* INICIALIZACI√ìN DASHBOARD GLOBAL (Mantener dise√±o original) */
    function initGlobalCharts() {
      new Chart(document.getElementById("chartRadarGeneral"), {
        type:"radar",
        data:{ labels:["Procesos","Prueba","Venta","HIT","Form","1os Aux"], datasets:[{ label:"%", data:[85,80,78,82,60,40], backgroundColor:"rgba(96,165,250,0.2)", borderColor:"#60a5fa" }] },
        options:{ plugins:{legend:{display:false}}, scales:{r:{min:0, max:100, ticks:{display:false}}} }
      });
      new Chart(document.getElementById("chartProcesosMes"), {
        type:"bar",
        data:{ labels:["Ene","Feb","Mar","Abr","May","Jun"], datasets:[{ type:"line", label:"Proc %", data:[80,82,85,87,88,90], borderColor:"#38bdf8" }, { type:"bar", label:"√Åreas", data:[7,6,5,4,3,2], backgroundColor:"rgba(239,68,68,0.5)" }] },
        options:{ maintainAspectRatio:false }
      });
      // ... resto de charts globales dummy ...
      new Chart(document.getElementById("chartAreasMes"), { type:"bar", data:{labels:["Ene","Jun"], datasets:[{data:[7,3], backgroundColor:"#ef4444"}]}, options:{plugins:{legend:{display:false}}} });
      new Chart(document.getElementById("chartPrimerosMes"), { type:"bar", data:{labels:["Ene","Jun"], datasets:[{data:[40,60], backgroundColor:"#22c55e"}]}, options:{plugins:{legend:{display:false}}} });
      new Chart(document.getElementById("chartTopAreas"), { type:"bar", data:{labels:["Stock","Limpieza","Orden"], datasets:[{data:[10,8,5], backgroundColor:"#3b82f6"}]}, options:{indexAxis:'y', plugins:{legend:{display:false}}} });
      new Chart(document.getElementById("chartAarHitDonut"), { type:"doughnut", data:{labels:["S√≠","No"], datasets:[{data:[3,2], backgroundColor:["#22c55e","#ef4444"]}]}, options:{cutout:"60%"} });
    }

    /* NAVEGACI√ìN A INFORME */
    document.addEventListener("click", e => {
       if(e.target.matches(".btn-informe-centro, .btn-ir-informe")) {
         const centroName = e.target.dataset.centro;
         centroActual = centros.find(c=>c.centro===centroName);
         if(centroActual) {
           $("#infCentro").value = centroActual.centro;
           $("#infProvincia").value = centroActual.provincia;
           $("#infDelegado").value = centroActual.delegado;
           $("#infTipo").value = tipoCentro(centroActual.centro);
           $("#infFecha").value = formatDateHuman(formatDateISO(new Date()));
           ultimoChecklistData = null; // Resetear datos excel al cambiar de centro
           $("#nombreChecklist").textContent = "";
           
           $$(".nav-item").forEach(i=>i.classList.toggle("active", i.dataset.page==="informe"));
           pages.forEach(p=>p.classList.toggle("active", p.dataset.page==="informe"));
           
           crearChartsCentro();
           actualizarChartsCentro();
         }
       }
    });

    /* CARGA INICIAL */
    window.addEventListener("load", () => {
      // Centros Demo
      const demo = [
        { codigo:"4ABB", propietario:"MAZA Oriol", centro:"PAMPLONA C. Exclusivo", provincia:"NAVARRA", delegado:"Sonia Godino" },
        { codigo:"4MRM", propietario:"AAO", centro:"REINA DE MERCEDES", provincia:"Madrid", delegado:"Sergio Per√°n" },
        { codigo:"4COR", propietario:"TEST", centro:"CORNER EJEMPLO", provincia:"Madrid", delegado:"Daniel Chazo" },
        // ... m√°s centros ...
      ];
      demo.forEach(c => centros.push(c));
      
      initCalendar();
      renderTablaCentros();
      renderDelegados();
      initGlobalCharts();
      
      // Chart vac√≠o inicial para los 80 criterios
      const ctx = document.getElementById("chartCriteriosDetalle").getContext("2d");
      globalCharts.criteriosDetalle = new Chart(ctx, {
          type: "bar",
          data: { labels: ["Sin datos"], datasets: [{ label: "%", data: [0], backgroundColor: "#38bdf8" }] },
          options: { indexAxis: "y", maintainAspectRatio: false, plugins: { legend: { display:false } } }
      });
    });

    /* Guardar Informe Dummy */
    $("#btnGuardarInforme").addEventListener("click", () => {
       if(centroActual) informesPorCentro[centroActual.centro] = (informesPorCentro[centroActual.centro]||0)+1;
       alert("Informe guardado y KPIs actualizados.");
       renderTablaCentros();
    });

  </script>
</body>
</html>
