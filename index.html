<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SEGUIMIENTO AUDIO ¬∑ Cloud</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#c82727">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23c82727'/%3E%3Ctext x='50%' y='54%' font-family='Arial,Helvetica,sans-serif' font-size='36' font-weight='900' text-anchor='middle' fill='white'%3EAR%3C/text%3E%3C/svg%3E">

<style>
  :root{
    --rojo:#c82727; --rojo-osc:#a71f1f;
    --bg:#f6f7fb; --card:#ffffff; --shadow:0 8px 22px rgba(0,0,0,.08);
    --col-exclusivos:#fde2e4; --col-flop:#e2f0cb; --col-visitas:#cde7f0; --col-formaciones:#f9e5c9; --col-tele:#eadcf8; --col-equip:#e8f1ff;
    --line:#e6e7ee;
    --contentW: 1380px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;color:#222}

  /* Topbar alineada con el contenido */
  .topbar{position:sticky;top:0;left:0;right:0;width:100%;z-index:50;background:linear-gradient(180deg,var(--rojo),var(--rojo-osc));color:#fff;box-shadow:var(--shadow)}
  .bar-inner{max-width:var(--contentW);margin:0 auto;display:flex;align-items:center;gap:.75rem;padding:.8rem 1rem}
  .brand{font-weight:900;letter-spacing:.35px}
  .spacer{flex:1}
  .btn{border:0;border-radius:12px;padding:.55rem .9rem;cursor:pointer;box-shadow:var(--shadow);font-weight:700}
  .btn-lite{background:#fff;color:#9b1010}
  .btn-save{background:#fff;color:#7e0e0e}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .6rem;border-radius:999px;border:1px solid #ffffff3d;background:#ffffff17;white-space:nowrap}
  .pill.ok{background:#28c76f2a;border-color:#28c76f66}
  .pill.warn{background:#ffd1662e;border-color:#ffd16666}
  .ar{min-width:32px;height:32px;border-radius:9px;background:#fff;color:#b30000;font-weight:900;border:0;box-shadow:var(--shadow);cursor:pointer}

  /* Layout */
  .app{max-width:var(--contentW);margin:0 auto}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:1rem;padding:1rem}
  .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow)}
  .title{font-weight:900;font-size:1.05rem;padding:.8rem 1rem;border-bottom:1px solid var(--line)}
  .section{margin:12px;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#fff}
  .sec-head{display:flex;align-items:center;justify-content:space-between;padding:.75rem .9rem;font-weight:900}
  .sec-list{padding:.4rem .6rem 1rem}
  .sec-btn{width:36px;height:32px;border-radius:9px;border:1px solid var(--line);background:#fff;cursor:pointer}

  .item{display:flex;align-items:center;justify-content:space-between;gap:.6rem;background:#fff;border:1px solid var(--line);border-radius:12px;padding:.6rem .7rem;margin:.5rem 0}
  .item .name{font-weight:750}
  .acts{display:flex;gap:.25rem}
  .ico-btn{min-width:30px;height:30px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .ico-btn:hover{background:#fafafa}

  .bg-exclusivos{background:var(--col-exclusivos)}
  .bg-flop{background:var(--col-flop)}
  .bg-visitas{background:var(--col-visitas)}
  .bg-formaciones{background:var(--col-formaciones)}
  .bg-tele{background:var(--col-tele)}
  .bg-equip{background:var(--col-equip)}

  .detail{padding:1rem 1.1rem 1.2rem;min-height:520px;border-radius:18px;border:1px solid var(--line);background:#fff}
  .detail h2{margin:0 0 .4rem 0}
  .hint{opacity:.7;margin:.2rem 0 1rem}
  .badge{padding:.15rem .5rem;border-radius:999px;background:#00000010}
  .row{display:flex;gap:.8rem;align-items:flex-end;flex-wrap:wrap}
  .field{display:grid;gap:.3rem;margin:.5rem 0;flex:1;min-width:200px}
  .field label{font-weight:700;opacity:.9}
  .field input,.field select{border:1px solid var(--line);border-radius:10px;padding:.5rem .6rem;font-size:1rem;background:#fff;outline:none}
  .bar-right{display:flex;gap:.5rem;justify-content:flex-end}
  .bar-split{display:flex;justify-content:space-between;align-items:center;margin:.4rem 0}

  /* Tablas: scroll horizontal robusto (barra inferior visible) */
  .table-wrap{border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--shadow);padding:.5rem}
  .xscroll{overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;padding-bottom:14px} /* <- deja espacio para la barra */
  .table-inner{display:block;width:max-content;min-width:1800px} /* fuerza scroll X (en m√≥viles tambi√©n) */
  .scroll{max-height:58vh;overflow:auto;padding-right:.3rem}

  /* Grids por m√≥dulo */
  .va-head,.va-row{display:grid;gap:.35rem;align-items:center;margin:.2rem .1rem}
  .va-cols{grid-template-columns:52px 1.1fr 140px 140px 160px 130px 120px 70px 170px 170px}
  .fm-head,.fm-row{display:grid;gap:.35rem;align-items:center;margin:.2rem .1rem;grid-template-columns:52px 120px 220px 160px 140px 140px 140px 140px 140px 120px 120px}
  .ta-head,.ta-row{display:grid;gap:.35rem;align-items:center;margin:.2rem .1rem;grid-template-columns:52px 1.2fr 160px 150px 180px 110px 110px 130px 130px 140px}

  /* Colores de celdas por % */
  .pscore{border:2px solid transparent}
  .pscore.good{background:#eaf9f0;border-color:#2ecc71aa}
  .pscore.bad{background:#ffe8e8;border-color:#e74c3caa}
  .conv{border:2px solid transparent}
  .conv.good{background:#eaf9f0;border-color:rgba(46,204,113,.6)}
  .conv.bad{background:#fff4e1;border-color:rgba(243,156,18,.7)}

  @media (max-width:1200px){ .wrap{grid-template-columns:1fr} .scroll{max-height:52vh} }
</style>
</head>
<body>

<header class="topbar">
  <div class="bar-inner">
    <button class="ar" title="Men√∫">AR</button>
    <div class="brand">SEGUIMIENTO AUDIO ¬∑ Cloud</div>
    <div class="spacer"></div>

    <span id="viewMode" class="pill warn" style="display:none">üëÅÔ∏è Solo lectura ‚Äî pulsa <b>Editar</b></span>
    <span id="lockInfo" class="pill warn" style="display:none">üîí En uso‚Ä¶</span>

    <button class="btn btn-lite" id="btnEdit" title="Pedir bloqueo y habilitar edici√≥n">Editar</button>
    <button class="btn btn-lite" id="btnRefresh" title="Leer la √∫ltima versi√≥n desde la nube (no guarda)">Actualizar</button>
    <button class="btn btn-save" id="btnSaveTop" title="Guardar cambios en la nube" disabled>Guardar</button>

    <span class="pill ok" id="pillOk" style="display:none">‚úì Guardado</span>
    <span class="pill" id="stamp">Conectando‚Ä¶</span>
  </div>
</header>

<main class="app">
  <section class="wrap">
    <!-- IZQUIERDA -->
    <aside class="card">
      <div class="title">SEGUIMIENTO</div>

      <section class="section bg-exclusivos" data-section="CENTROS EXCLUSIVOS">
        <div class="sec-head">
          <div>üìí CENTROS EXCLUSIVOS <span class="badge">(m√°x. 10)</span></div>
          <div><button class="sec-btn" data-act="toggle">‚ñæ</button> <button class="sec-btn" data-act="add">Ôºã</button></div>
        </div>
        <div class="sec-list"></div>
      </section>

      <section class="section bg-flop" data-section="CENTROS FLOP">
        <div class="sec-head">
          <div>üìí CENTROS FLOP</div>
          <div><button class="sec-btn" data-act="toggle">‚ñæ</button> <button class="sec-btn" data-act="add">Ôºã</button></div>
        </div>
        <div class="sec-list"></div>
      </section>

      <section class="section bg-visitas" data-section="VISITAS AUDIO">
        <div class="sec-head">
          <div>üìã VISITAS AUDIO</div>
          <div><button class="sec-btn" data-act="toggle">‚ñæ</button> <button class="sec-btn" data-act="add">Ôºã</button></div>
        </div>
        <div class="sec-list"></div>
      </section>

      <section class="section bg-formaciones" data-section="FORMACIONES Y MENTORING">
        <div class="sec-head">
          <div>üéì FORMACIONES Y MENTORING</div>
          <div><button class="sec-btn" data-act="toggle">‚ñæ</button> <button class="sec-btn" data-act="add">Ôºã</button></div>
        </div>
        <div class="sec-list"></div>
      </section>

      <section class="section bg-tele" data-section="TELEAUDIOLOGIA">
        <div class="sec-head">
          <div>üì° TELEAUDIOLOGIA</div>
          <div><button class="sec-btn" data-act="toggle">‚ñæ</button> <button class="sec-btn" data-act="add">Ôºã</button></div>
        </div>
        <div class="sec-list"></div>
      </section>

      <!-- NUEVO BLOQUE -->
      <section class="section bg-equip" data-section="EQUIPOS">
        <div class="sec-head">
          <div>üß∞ EQUIPOS</div>
          <div><button class="sec-btn" data-act="toggle">‚ñæ</button> <button class="sec-btn" data-act="add">Ôºã</button></div>
        </div>
        <div class="sec-list"></div>
      </section>
    </aside>

    <!-- DERECHA -->
    <section class="detail card" id="detail">
      <div class="row" style="align-items:center">
        <h2 id="detTitle">Detalle</h2>
        <span id="detTag" class="badge">‚Äî</span>
        <button id="collapseDetail" class="sec-btn" style="margin-left:.6rem;display:none" title="Ocultar">‚Äî</button>
      </div>
      <div class="hint" id="detHint">Selecciona un item a la izquierda o crea uno con Ôºã.</div>

      <!-- CENTROS -->
      <div id="detFormCentro" style="display:none">
        <div class="bar-split">
          <strong>Centro</strong>
          <div class="bar-right">
            <button class="btn" id="btnCancelCTop">Cancelar</button>
            <button class="btn btn-save" id="btnSaveCTop" title="Guardar cambios del centro">üíæ Guardar centro</button>
          </div>
        </div>
        <div class="row">
          <div class="field"><label>Nombre</label><input id="cNombre" type="text"></div>
          <div class="field"><label>Delegado</label><input id="cDelegado" type="text"></div>
        </div>
        <div class="row">
          <div class="field"><label>Audi√≥logo</label><input id="cAudiologo" type="text"></div>
          <div class="field"><label>Franquicia o Sucursal</label><select id="cTipo"><option>Franquicia</option><option>Sucursal</option></select></div>
        </div>

        <!-- ACCIONES -->
        <div class="table-wrap">
          <div class="xscroll">
            <div class="table-inner">
              <div class="va-head" style="grid-template-columns:52px 130px 1fr 110px 110px 110px 150px 52px">
                <div>#</div><div>Fecha</div><div>Tipo de acci√≥n</div><div>Paquete</div><div>Derivaci√≥n</div><div>Citas</div><div>Venta</div><div></div>
              </div>
              <div id="accionesRows"></div>
            </div>
          </div>
        </div>

        <!-- FORMACIONES RELEVANTES -->
        <div class="table-wrap">
          <div class="xscroll">
            <div class="table-inner">
              <div class="va-head" style="grid-template-columns:52px 1.2fr .7fr .7fr 1.4fr 52px">
                <div>#</div><div>Curso</div><div>Realizado</div><div>Aplica</div><div>Observaciones</div><div></div>
              </div>
              <div id="formacionesRows"></div>
            </div>
          </div>
        </div>

        <!-- PROCESOS -->
        <div class="table-wrap">
          <div class="xscroll">
            <div class="table-inner">
              <div class="va-head" style="grid-template-columns:52px 220px 120px 160px 52px">
                <div>#</div><div>Puntuaci√≥n checklist (0‚Äì100 %)</div><div>HIT</div><div>Colaboraciones</div><div></div>
              </div>
              <div id="procesosRows"></div>
            </div>
          </div>
        </div>

        <div class="bar-right">
          <button class="btn" id="btnCancelC">Cancelar</button>
          <button class="btn btn-save" id="btnSaveC" title="Guardar cambios del centro">üíæ Guardar centro</button>
        </div>
      </div>

      <!-- VISITAS -->
      <div id="detFormVisitas" style="display:none">
        <div class="bar-split">
          <strong>Visitas audio</strong>
          <div class="bar-right">
            <button class="btn" id="btnCancelVATop">Cancelar</button>
            <button class="btn btn-save" id="btnSaveVATop" title="Guardar visitas">üíæ Guardar visitas</button>
          </div>
        </div>
        <div class="row">
          <div class="field"><label>Rol</label><select id="vaRol"><option>Delegado audio</option><option>Responsable AAR</option></select></div>
          <div class="field"><label>Nombre</label><input id="vaResp" type="text" placeholder="Nombre"></div>
          <div class="field"><label>Buscar centro</label><input id="vaSearchTop" type="text" placeholder="Filtrar‚Ä¶"></div>
        </div>
        <div class="tabs" id="vaTabs"></div>

        <div class="table-wrap">
          <div class="xscroll">
            <div class="table-inner">
              <div class="va-head va-cols">
                <div>#</div><div>Centro</div><div>Delegado</div><div>Audi√≥logo</div><div>Sucursal/Franquicia</div><div>Fecha visita</div><div>Puntuaci√≥n (%)</div><div>HIT</div><div>% Conversi√≥n prueba</div><div>% Conversi√≥n venta</div>
              </div>
              <div id="vaRows" class="scroll"></div>
            </div>
          </div>
        </div>

        <div class="bar-right" style="margin-top:.7rem">
          <button class="btn" id="btnCancelVA">Cancelar</button>
          <button class="btn btn-save" id="btnSaveVA" title="Guardar visitas">üíæ Guardar visitas</button>
        </div>
      </div>

      <!-- FORMACIONES -->
      <div id="detFormMentoring" style="display:none">
        <div class="bar-split">
          <strong>Formaciones y Mentoring</strong>
          <div class="bar-right">
            <button class="btn" id="btnCancelFMTop">Cancelar</button>
            <button class="btn btn-save" id="btnSaveFMTop" title="Guardar formaciones">üíæ Guardar</button>
          </div>
        </div>
        <div class="row">
          <div class="field"><label>Delegado regional</label><input id="fmDelegado" type="text"></div>
          <div class="field"><label>Buscar</label><input id="fmSearchTop" type="text" placeholder="Filtrar‚Ä¶"></div>
        </div>

        <div class="table-wrap">
          <div class="xscroll">
            <div class="table-inner">
              <div class="fm-head">
                <div>#</div><div>Fecha</div><div>Tema</div><div>Audi√≥logo</div>
                <div>Duraci√≥n (semanas)</div><div>% Prueba inicial</div><div>% Venta inicial</div>
                <div>% Prueba 3m</div><div>% Venta 3m</div><div>Evo. prueba</div><div>Evo. venta</div>
              </div>
              <div id="fmRows" class="scroll"></div>
            </div>
          </div>
        </div>

        <div class="bar-right" style="margin-top:.7rem">
          <button class="btn" id="btnCancelFM">Cancelar</button>
          <button class="btn btn-save" id="btnSaveFM" title="Guardar formaciones">üíæ Guardar</button>
        </div>
      </div>

      <!-- TELEAUDIOLOG√çA -->
      <div id="detFormTele" style="display:none">
        <div class="bar-split">
          <strong>Teleaudiolog√≠a</strong>
          <div class="bar-right">
            <button class="btn" id="btnCancelTATop">Cancelar</button>
            <button class="btn btn-save" id="btnSaveTATop" title="Guardar tele">üíæ Guardar tele</button>
          </div>
        </div>
        <div class="row">
          <div class="field"><label>Buscar</label><input id="taSearchTop" type="text" placeholder="Centro o persona‚Ä¶"></div>
          <div class="field"><label>Persona</label><select id="taPersonSelect"><option value="">Todos</option></select></div>
        </div>

        <div class="table-wrap">
          <div class="xscroll">
            <div class="table-inner">
              <div class="ta-head">
                <div>#</div><div>Centro</div><div>Delegado</div><div>Rol</div><div>Persona</div><div>Formaci√≥n</div><div>Pr√°cticas</div><div>Certificado</div><div>Pruebas reales</div><div>Ventas</div>
              </div>
              <div id="taRows" class="scroll"></div>
            </div>
          </div>
        </div>

        <div class="bar-right" style="margin-top:.7rem">
          <button class="btn" id="btnCancelTA">Cancelar</button>
          <button class="btn btn-save" id="btnSaveTA" title="Guardar tele">üíæ Guardar tele</button>
        </div>
      </div>

      <!-- EQUIPOS -->
      <div id="detFormEquipos" style="display:none">
        <div class="bar-split">
          <strong>Equipos</strong>
          <div class="bar-right">
            <button class="btn" id="btnAddParCols" title="A√±adir un par de columnas Centro/Sede">Ôºã A√±adir par</button>
            <button class="btn" id="btnCancelEQTop">Cancelar</button>
            <button class="btn btn-save" id="btnSaveEQTop" title="Guardar inventario">üíæ Guardar equipos</button>
          </div>
        </div>

        <div class="row">
          <div class="field"><label>Buscar</label><input id="eqSearchTop" type="text" placeholder="Equipo, serie, centro o persona‚Ä¶"></div>
          <div class="field"><label>&nbsp;</label><button class="btn" id="btnAddFila" title="A√±adir una fila (25 iniciales)">Ôºã A√±adir fila</button></div>
        </div>

        <div class="table-wrap">
          <div class="xscroll">
            <div class="table-inner" id="eqTable"></div>
          </div>
        </div>

        <div class="bar-right" style="margin-top:.7rem">
          <button class="btn" id="btnCancelEQ">Cancelar</button>
          <button class="btn btn-save" id="btnSaveEQ" title="Guardar inventario">üíæ Guardar equipos</button>
        </div>
      </div>

    </section>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
/* ======= Rellena tus claves ======= */
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_DOMINIO.firebaseapp.com",
  databaseURL: "https://TU_ID_PROYECTO-default-rtdb.firebaseio.com",
  projectId: "TU_ID_PROYECTO",
  storageBucket: "TU_ID_PROYECTO.appspot.com",
  messagingSenderId: "TUSENDERID",
  appId: "TU_APP_ID"
};
/* ======= RUTA de datos y lock ======= */
const DB_PATH='audioseguimiento/v5h';
const LOCK_PATH=DB_PATH+'/__lock__';
const LOCK_TIMEOUT_MS=5*60*1000;
/* ================================== */

let cloud={ready:false,ref:null,db:null};
let state={selected:{section:null,index:null},vaSheet:0,vaFilter:'',fmFilter:'',taFilter:'',taPerson:'',eqFilter:'',canEdit:false,myLock:false};
let sessionId=localStorage.getItem('aas_session')||('S'+Math.random().toString(36).slice(2)); localStorage.setItem('aas_session',sessionId);
let editorName=localStorage.getItem('aas_name')||'';

let data={
  "CENTROS EXCLUSIVOS":[{ nombre:"Reina Mercedes", delegado:"", audiologo:"", tipo:"Franquicia", acciones:[], formaciones:[], procesos:[] }],
  "CENTROS FLOP":[],
  "VISITAS AUDIO":[{ rol:"Delegado audio", responsable:"", hojas:[ makeSheetVA("Visita 1") ] }],
  "FORMACIONES Y MENTORING":[{ delegado:"", filas: makeRowsFM() }],
  "TELEAUDIOLOGIA":[{ hojas:[ makeSheetTA("Tele 1") ] }],
  "EQUIPOS":[ makeEquipos() ]
};

/* ===== util ===== */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const esc=s=>(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const now=()=>new Date().toLocaleString();

function makeSheetVA(n){const rows=Array.from({length:300},()=>({centro:'',delegado:'',audiologo:'',tipo:'Sucursal',fecha:'',puntuacion:null,hit:false,conv_prueba:null,conv_venta:null}));return{nombre:n,rows};}
function makeRowsFM(){return Array.from({length:300},()=>({fecha:'',tema:'',audiologo:'',duracion:1,p_ini:null,v_ini:null,p_3m:null,v_3m:null}));}
function makeSheetTA(n){const rows=Array.from({length:300},()=>({centro:'',delegado:'',rol:'Audi√≥logo',persona:'',formacion:false,practicas:false,certificado:false,pruebas_reales:null,ventas:null}));return{nombre:n,rows};}
function makeEquipos(){ const rows=Array.from({length:25},()=>({equipo:'',serie:'',persona:'',fecha:'',pares:[{centro:'',sede:''},{centro:'',sede:''},{centro:'',sede:''}]})); return { columnas:3, filas: rows }; }

function setDetailTone(s){const d=$('#detail');d.style.background = s==="CENTROS EXCLUSIVOS"?'var(--col-exclusivos)':s==="CENTROS FLOP"?'var(--col-flop)':s==="VISITAS AUDIO"?'var(--col-visitas)':s==="FORMACIONES Y MENTORING"?'var(--col-formaciones)':s==="TELEAUDIOLOGIA"?'var(--col-tele)':s==="EQUIPOS"?'var(--col-equip)':'#fff';}
function currentItem(){return data[state.selected.section]?.[state.selected.index];}

/* ===== Firebase + lock ===== */
function initFirebase(){
  try{firebase.initializeApp(firebaseConfig);}catch(e){}
  cloud.db=firebase.database();
  firebase.auth().signInAnonymously().then(()=>{
    cloud.ref=cloud.db.ref(DB_PATH);
    cloud.ref.on('value',snap=>{
      const v=snap.val(); if(v) data=v;
      cloud.ready=true; $('#btnSaveTop').disabled=false;
      $('#stamp').textContent='Actualizado: '+now();
      renderAll();
    });
    watchLock();
  });
}
function save(){
  if(!cloud.ready) return;
  if(!state.canEdit){ alert('Solo lectura. Pulsa Editar.'); return; }
  cloud.ref.set(data).then(()=>{
    $('#pillOk').style.display='inline-flex';
    setTimeout(()=>$('#pillOk').style.display='none',1800);
    $('#stamp').textContent='Guardado: '+now();
  });
}
function watchLock(){
  const lref=cloud.db.ref(LOCK_PATH);
  lref.on('value',snap=>{
    const lock=snap.val(); const n=Date.now(); const active=lock&&(n-lock.at)<=LOCK_TIMEOUT_MS;
    if(active && lock.by!==sessionId){
      state.canEdit=false; state.myLock=false;
      $('#viewMode').style.display='inline-flex';
      $('#lockInfo').style.display='inline-flex';
      $('#lockInfo').textContent=`üîí En uso por ${lock.name||'otro usuario'}`;
    }else{
      $('#lockInfo').style.display='none';
      if(!state.myLock) $('#viewMode').style.display='inline-flex';
    }
    toggleEditability();
  });
}
function requestEdit(){
  if(!editorName){ const n=prompt('Tu nombre para mostrar (ej.: Sergio)')||''; if(n){editorName=n;localStorage.setItem('aas_name',n);} }
  const lref=cloud.db.ref(LOCK_PATH);
  lref.transaction(curr=>{
    const t=Date.now();
    if(!curr || (t-curr.at)>LOCK_TIMEOUT_MS || curr.by===sessionId){ return {by:sessionId,name:editorName||'Usuario',at:t}; }
    return;
  },(err,ok,snap)=>{
    if(err){alert('Error al pedir edici√≥n.');return;}
    const lock=snap.val();
    if(ok && lock.by===sessionId){
      state.canEdit=true; state.myLock=true;
      $('#viewMode').style.display='none'; $('#lockInfo').style.display='inline-flex'; $('#lockInfo').textContent='üîì Edici√≥n habilitada';
      keepAlive(); window.addEventListener('beforeunload',releaseLock); toggleEditability();
    }else{ alert(`En uso por ${lock?.name||'otro usuario'}.`); }
  });
}
let hb=null;
function keepAlive(){ clearInterval(hb); hb=setInterval(()=>{ if(!state.myLock) return; cloud.db.ref(LOCK_PATH).update({by:sessionId,name:editorName||'Usuario',at:Date.now()}); }, 30*1000); }
function releaseLock(){ if(!state.myLock) return; cloud.db.ref(LOCK_PATH).remove(); state.myLock=false; state.canEdit=false; $('#viewMode').style.display='inline-flex'; toggleEditability(); }
function toggleEditability(){
  const dis=!state.canEdit;
  $$("input,select,textarea").forEach(el=>el.disabled=dis);
  $$("button").forEach(b=>{
    const id=b.id||'';
    const always=['btnEdit','btnRefresh','btnCancelC','btnCancelCTop','btnCancelVA','btnCancelVATop','btnCancelFM','btnCancelFMTop','btnCancelTA','btnCancelTATop','btnCancelEQ','btnCancelEQTop','btnAddParCols','btnAddFila'];
    if(always.includes(id)){ b.disabled=false; return; }
    if(id.startsWith('btnSave')){ b.disabled=dis; return; }
    if(!id) b.disabled=dis;
  });
}

/* ===== IZQUIERDA ===== */
const SECTIONS=["CENTROS EXCLUSIVOS","CENTROS FLOP","VISITAS AUDIO","FORMACIONES Y MENTORING","TELEAUDIOLOGIA","EQUIPOS"];
function renderLeft(){
  SECTIONS.forEach(name=>{
    const cont=document.querySelector(`.section[data-section="${name}"] .sec-list`); cont.innerHTML='';
    (data[name]||[]).forEach((it,i)=>{
      const div=document.createElement('div'); div.className='item'; div.dataset.index=i;
      if(name.includes('CENTROS')){
        div.innerHTML=`<div><div class="name">${esc(it.nombre||'‚Äî')}</div><small>Delegado: ${esc(it.delegado||'‚Äî')} ¬∑ Aud.: ${esc(it.audiologo||'‚Äî')}</small></div>
        <div class="acts"><button class="ico-btn btn-edit" title="Editar">‚úèÔ∏è</button><button class="ico-btn btn-del" title="Eliminar">üóëÔ∏è</button></div>`;
      }else if(name==="VISITAS AUDIO"){
        div.innerHTML=`<div><div class="name">(${esc(it.rol||'Rol')}) ${esc(it.responsable||'‚Äî')}</div><small>Visitas</small></div>
        <div class="acts"><button class="ico-btn btn-edit" title="Editar">‚úèÔ∏è</button><button class="ico-btn btn-del" title="Eliminar">üóëÔ∏è</button></div>`;
      }else if(name==="FORMACIONES Y MENTORING"){
        div.innerHTML=`<div><div class="name">${esc(it.delegado||'(Delegado regional)')}</div></div>
        <div class="acts"><button class="ico-btn btn-edit" title="Editar">‚úèÔ∏è</button><button class="ico-btn btn-del" title="Eliminar">üóëÔ∏è</button></div>`;
      }else if(name==="TELEAUDIOLOGIA"){
        div.innerHTML=`<div><div class="name">Teleaudiolog√≠a</div></div>
        <div class="acts"><button class="ico-btn btn-edit" title="Editar">‚úèÔ∏è</button><button class="ico-btn btn-del" title="Eliminar">üóëÔ∏è</button></div>`;
      }else{ // EQUIPOS
        div.innerHTML=`<div><div class="name">Inventario de equipos</div></div>
        <div class="acts"><button class="ico-btn btn-edit" title="Editar">‚úèÔ∏è</button></div>`;
      }
      cont.appendChild(div);
    });

    const sec=document.querySelector(`.section[data-section="${name}"]`);
    sec.querySelector('[data-act="toggle"]').onclick=()=>{cont.style.display=cont.style.display==='none'?'':'none'; if(cont.style.display==='none' && name.includes('CENTROS')){state.selected={section:null,index:null};renderDetailBlank();}};
    sec.querySelector('[data-act="add"]').onclick=()=>{
      if(!state.canEdit){alert('Pulsa Editar para crear.');return;}
      let nuevo;
      if(name.includes('CENTROS')) nuevo={nombre:'(nuevo centro)',delegado:'',audiologo:'',tipo:'Franquicia',acciones:[],formaciones:[],procesos:[]};
      else if(name==="VISITAS AUDIO") nuevo={rol:'Delegado audio',responsable:'',hojas:[makeSheetVA('Visita 1')]};
      else if(name==="FORMACIONES Y MENTORING") nuevo={delegado:'(delegado regional)',filas:makeRowsFM()};
      else if(name==="TELEAUDIOLOGIA") nuevo={hojas:[makeSheetTA('Tele 1')]};
      else nuevo=makeEquipos();
      data[name].push(nuevo); save(); renderAll();
    };

    cont.onclick=e=>{
      const item=e.target.closest('.item'); if(!item) return; const idx=+item.dataset.index;
      if(e.target.closest('.btn-del')){ if(!state.canEdit){alert('Solo lectura.');return;} if(confirm('¬øEliminar este item?')){ data[name].splice(idx,1); save(); renderAll(); } return; }
      state.selected={section:name,index:idx}; renderDetail();
    };
  });
}

/* ===== Detalle switch ===== */
function renderDetailBlank(){ $('#detHint').style.display='block'; $('#collapseDetail').style.display='none'; setDetailTone(null);
  $('#detFormCentro').style.display='none'; $('#detFormVisitas').style.display='none'; $('#detFormMentoring').style.display='none'; $('#detFormTele').style.display='none'; $('#detFormEquipos').style.display='none'; $('#detTag').textContent='‚Äî'; }
function renderDetail(){ $('#detHint').style.display='none'; $('#collapseDetail').style.display='inline-flex'; $('#detTag').textContent=state.selected.section; setDetailTone(state.selected.section);
  const s=state.selected.section;
  $('#detFormCentro').style.display= s.includes('CENTROS')?'block':'none';
  $('#detFormVisitas').style.display= s==='VISITAS AUDIO'?'block':'none';
  $('#detFormMentoring').style.display= s==='FORMACIONES Y MENTORING'?'block':'none';
  $('#detFormTele').style.display= s==='TELEAUDIOLOGIA'?'block':'none';
  $('#detFormEquipos').style.display= s==='EQUIPOS'?'block':'none';
  if(s.includes('CENTROS')) fillCentro();
  if(s==='VISITAS AUDIO') fillVisitas();
  if(s==='FORMACIONES Y MENTORING') fillFM();
  if(s==='TELEAUDIOLOGIA') fillTele();
  if(s==='EQUIPOS') fillEquipos();
}
$('#collapseDetail').onclick=()=>{ state.selected={section:null,index:null}; renderDetailBlank(); };

/* ===== CENTROS ===== */
function fillCentro(){const it=currentItem(); if(!it) return;
  $('#cNombre').value=it.nombre||''; $('#cDelegado').value=it.delegado||''; $('#cAudiologo').value=it.audiologo||''; $('#cTipo').value=it.tipo||'Franquicia';
  renderAcciones(); renderFormaciones(); renderProcesos(); toggleEditability();
}
function saveCentro(){ if(!state.canEdit){alert('Solo lectura.');return;} const it=currentItem(); it.nombre=$('#cNombre').value.trim(); it.delegado=$('#cDelegado').value.trim(); it.audiologo=$('#cAudiologo').value.trim(); it.tipo=$('#cTipo').value; save(); renderLeft(); }
$('#btnSaveC').onclick=saveCentro; $('#btnSaveCTop').onclick=saveCentro; $('#btnCancelC').onclick=()=>{state.selected={section:null,index:null};renderDetailBlank();}; $('#btnCancelCTop').onclick=()=>{state.selected={section:null,index:null};renderDetailBlank();};

function renderAcciones(){const it=currentItem(); it.acciones=it.acciones||[]; const cont=$('#accionesRows'); cont.innerHTML='';
  it.acciones.forEach((r,i)=>{const row=document.createElement('div'); row.className='va-row'; row.style.gridTemplateColumns='52px 130px 1fr 110px 110px 110px 150px 52px';
    row.innerHTML=`<div>${i+1}</div><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}"><input data-i="${i}" data-k="tipo" value="${esc(r.tipo||'')}">
    <select data-i="${i}" data-k="paquete"><option ${r.paquete==='1'?'selected':''}>1</option><option ${r.paquete==='2'?'selected':''}>2</option><option ${r.paquete==='3'?'selected':''}>3</option></select>
    <input type="number" min="0" step="1" data-i="${i}" data-k="derivacion" value="${r.derivacion??''}">
    <input type="number" min="0" step="1" data-i="${i}" data-k="citas" value="${r.citas??''}">
    <input type="number" min="0" step="1" data-i="${i}" data-k="venta" value="${r.venta??''}">
    <button class="ico-btn row-del" data-i="${i}">üóëÔ∏è</button>`; cont.appendChild(row);});
}
$('#accionesRows').addEventListener('click',e=>{const i=e.target.closest('.row-del')?.dataset.i; if(i!=null){ if(!state.canEdit){alert('Solo lectura.');return;} const it=currentItem(); it.acciones.splice(+i,1); renderAcciones(); save(); }});
$('#accionesRows').addEventListener('input',e=>{if(!state.canEdit){e.preventDefault();return;}const it=currentItem(); const i=+e.target.dataset.i; const k=e.target.dataset.k; if(!k) return; const r=it.acciones[i]; r[k]=e.target.type==='number'?(e.target.value===''?null:Number(e.target.value)):e.target.value; save();});

function renderFormaciones(){const it=currentItem(); it.formaciones=it.formaciones||[]; const cont=$('#formacionesRows'); cont.innerHTML='';
  it.formaciones.forEach((r,i)=>{const row=document.createElement('div'); row.className='va-row'; row.style.gridTemplateColumns='52px 1.2fr .7fr .7fr 1.4fr 52px';
    row.innerHTML=`<div>${i+1}</div><input data-i="${i}" data-k="curso" value="${esc(r.curso||'')}"><input type="checkbox" data-i="${i}" data-k="realizado" ${r.realizado?'checked':''}><input type="checkbox" data-i="${i}" data-k="aplica" ${r.aplica?'checked':''}><input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}"><button class="ico-btn row-del" data-i="${i}">üóëÔ∏è</button>`; cont.appendChild(row);});
}
$('#formacionesRows').addEventListener('click',e=>{const i=e.target.closest('.row-del')?.dataset.i; if(i!=null){ if(!state.canEdit){alert('Solo lectura.');return;} const it=currentItem(); it.formaciones.splice(+i,1); renderFormaciones(); save(); }});
$('#formacionesRows').addEventListener('input',e=>{if(!state.canEdit){e.preventDefault();return;}const it=currentItem(); const i=+e.target.dataset.i; const k=e.target.dataset.k; const r=it.formaciones[i]; r[k]=e.target.type==='checkbox'?e.target.checked:e.target.value; save();});

function renderProcesos(){const it=currentItem(); it.procesos=it.procesos||[]; const cont=$('#procesosRows'); cont.innerHTML='';
  function color(v){const n=Number(v); if(!Number.isFinite(n)) return ''; return n>=95?'good':(n>=85?'':'bad');}
  it.procesos.forEach((r,i)=>{const row=document.createElement('div'); row.className='va-row'; row.style.gridTemplateColumns='52px 220px 120px 160px 52px';
    row.innerHTML=`<div>${i+1}</div><input class="pscore ${color(r.puntuacion)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="puntuacion" value="${r.puntuacion??''}"><input type="checkbox" data-i="${i}" data-k="hit" ${r.hit?'checked':''}><input type="checkbox" data-i="${i}" data-k="colaboraciones" ${r.colaboraciones?'checked':''}><button class="ico-btn row-del" data-i="${i}">üóëÔ∏è</button>`; cont.appendChild(row);});
}
$('#procesosRows').addEventListener('click',e=>{const i=e.target.closest('.row-del')?.dataset.i; if(i!=null){ if(!state.canEdit){alert('Solo lectura.');return;} const it=currentItem(); it.procesos.splice(+i,1); renderProcesos(); save(); }});
$('#procesosRows').addEventListener('input',e=>{if(!state.canEdit){e.preventDefault();return;}const it=currentItem(); const i=+e.target.dataset.i; const k=e.target.dataset.k; const r=it.procesos[i]; r[k]=e.target.type==='checkbox'?e.target.checked:(e.target.value===''?null:Number(e.target.value)); save();});

/* ===== VISITAS ===== */
function fillVisitas(){const it=currentItem(); if(!it) return; $('#vaRol').value=it.rol||'Delegado audio'; $('#vaResp').value=it.responsable||''; $('#vaSearchTop').value=state.vaFilter||''; renderVaTabs(); renderVA(); toggleEditability();}
$('#vaRol').onchange=e=>{if(!state.canEdit){e.preventDefault();return;}currentItem().rol=e.target.value; save(); renderLeft();};
$('#vaResp').oninput=e=>{if(!state.canEdit){e.preventDefault();return;}currentItem().responsable=e.target.value; save(); renderLeft();};
$('#vaSearchTop').oninput=e=>{state.vaFilter=e.target.value.trim(); renderVA();};

function renderVaTabs(){const it=currentItem(); const tabs=$('#vaTabs'); tabs.innerHTML=''; it.hojas=it.hojas||[makeSheetVA('Visita 1')];
  it.hojas.forEach((h,idx)=>{const b=document.createElement('button'); b.className='sec-btn '+(idx===state.vaSheet?'':''); b.textContent=h.nombre||('Visita '+(idx+1)); b.onclick=()=>{state.vaSheet=idx; renderVA();}; tabs.appendChild(b);});
  const add=document.createElement('button'); add.className='sec-btn'; add.textContent='Ôºã'; add.title='A√±adir visita'; add.onclick=()=>{if(!state.canEdit){alert('Solo lectura.');return;} it.hojas.push(makeSheetVA('Visita '+(it.hojas.length+1))); state.vaSheet=it.hojas.length-1; save(); renderVaTabs(); renderVA();}; tabs.appendChild(add);
}
function vClass80(v){const n=Number(v); if(!Number.isFinite(n)) return ''; return n>=80?'good':'bad';}
function vScore85(v){const n=Number(v); if(!Number.isFinite(n)) return ''; return n>=85?'good':'bad';}
function renderVA(){const it=currentItem(); const hoja=it.hojas[state.vaSheet]||it.hojas[0]; const f=(state.vaFilter||'').toLowerCase(); const cont=$('#vaRows'); cont.innerHTML='';
  hoja.rows.forEach((r,i)=>{if(f && !(r.centro||'').toLowerCase().includes(f)) return; const row=document.createElement('div'); row.className='va-row va-cols';
    row.innerHTML=`<div>${i+1}</div><input data-i="${i}" data-k="centro" value="${esc(r.centro||'')}"><input data-i="${i}" data-k="delegado" value="${esc(r.delegado||'')}"><input data-i="${i}" data-k="audiologo" value="${esc(r.audiologo||'')}"><select data-i="${i}" data-k="tipo"><option ${r.tipo==='Sucursal'?'selected':''}>Sucursal</option><option ${r.tipo==='Franquicia'?'selected':''}>Franquicia</option></select><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}"><input class="pscore ${vScore85(r.puntuacion)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="puntuacion" value="${r.puntuacion??''}"><input type="checkbox" data-i="${i}" data-k="hit" ${r.hit?'checked':''}><input class="conv ${vClass80(r.conv_prueba)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="conv_prueba" value="${r.conv_prueba??''}"><input class="conv ${vClass80(r.conv_venta)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="conv_venta" value="${r.conv_venta??''}">`; cont.appendChild(row);});
}
$('#vaRows').addEventListener('input',e=>{if(!state.canEdit){e.preventDefault();return;}const h=currentItem().hojas[state.vaSheet]; const i=+e.target.dataset.i; const k=e.target.dataset.k; if(!k) return; if(e.target.type==='checkbox') h.rows[i][k]=e.target.checked; else if(e.target.type==='number') h.rows[i][k]=e.target.value===''?null:Number(e.target.value); else h.rows[i][k]=e.target.value; save();});
$('#btnSaveVA').onclick=save; $('#btnSaveVATop').onclick=save; $('#btnCancelVA').onclick=()=>{state.selected={section:null,index:null};renderDetailBlank();}; $('#btnCancelVATop').onclick=()=>{state.selected={section:null,index:null};renderDetailBlank();};

/* ===== FORMACIONES ===== */
function fillFM(){const it=currentItem(); if(!it) return; $('#fmDelegado').value=it.delegado||''; $('#fmSearchTop').value=state.fmFilter||''; renderFM(); toggleEditability();}
$('#fmSearchTop').oninput=e=>{state.fmFilter=e.target.value.trim(); renderFM();};
function renderFM(){const it=currentItem(); it.filas=it.filas||makeRowsFM(); const f=(state.fmFilter||'').toLowerCase(); const cont=$('#fmRows'); cont.innerHTML='';
  it.filas.forEach((r,i)=>{const ok=!f||(r.tema||'').toLowerCase().includes(f)||(r.audiologo||'').toLowerCase().includes(f); if(!ok) return; const evoP=(Number.isFinite(+r.p_ini)&&Number.isFinite(+r.p_3m))?(Number(r.p_3m)-Number(r.p_ini)):null; const evoV=(Number.isFinite(+r.v_ini)&&Number.isFinite(+r.v_3m))?(Number(r.v_3m)-Number(r.v_ini)):null; const row=document.createElement('div'); row.className='fm-row';
    row.innerHTML=`<div>${i+1}</div><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}"><input data-i="${i}" data-k="tema" value="${esc(r.tema||'')}"><input data-i="${i}" data-k="audiologo" value="${esc(r.audiologo||'')}"><select data-i="${i}" data-k="duracion">${[1,2,3,4].map(n=>`<option ${Number(r.duracion)===n?'selected':''}>${n}</option>`).join('')}</select><input class="conv ${(Number(r.p_ini)>=80)?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="p_ini" value="${r.p_ini??''}"><input class="conv ${(Number(r.v_ini)>=80)?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="v_ini" value="${r.v_ini??''}"><input class="conv ${(Number(r.p_3m)>=80)?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="p_3m" value="${r.p_3m??''}"><input class="conv ${(Number(r.v_3m)>=80)?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="v_3m" value="${r.v_3m??''}"><div style="text-align:center;font-weight:700">${evoP==null?'‚Äî':(evoP>0?'‚Üë ':'')+(evoP<0?'‚Üì ':'')+Math.abs(Math.round(evoP))}</div><div style="text-align:center;font-weight:700">${evoV==null?'‚Äî':(evoV>0?'‚Üë ':'')+(evoV<0?'‚Üì ':'')+Math.abs(Math.round(evoV))}</div>`; cont.appendChild(row);});
}
$('#fmRows').addEventListener('input',e=>{if(!state.canEdit){e.preventDefault();return;}const it=currentItem(); const i=+e.target.dataset.i; const k=e.target.dataset.k; if(!k) return; if(e.target.type==='number') it.filas[i][k]=e.target.value===''?null:Number(e.target.value); else if(e.target.tagName==='SELECT') it.filas[i][k]=Number(e.target.value); else it.filas[i][k]=e.target.value; save();});
$('#btnSaveFM').onclick=save; $('#btnSaveFMTop').onclick=save; $('#btnCancelFM').onclick=()=>{state.selected={section:null,index:null};renderDetailBlank();}; $('#btnCancelFMTop').onclick=()=>{state.selected={section:null,index:null};renderDetailBlank();};

/* ===== TELE ===== */
function fillTele(){ $('#taSearchTop').value=state.taFilter||''; populateTaPersonSelect(); renderTA(); toggleEditability(); }
function populateTaPersonSelect(){ const it=currentItem(); const hoja=(it.hojas&&it.hojas[0])||makeSheetTA('Tele 1'); it.hojas=it.hojas||[hoja]; const names=Array.from(new Set(hoja.rows.map(r=>(r.persona||'').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b)); const sel=$('#taPersonSelect'); const prev=state.taPerson||''; sel.innerHTML='<option value=\"\">Todos</option>'+names.map(n=>`<option ${n===prev?'selected':''}>${esc(n)}</option>`).join(''); }
$('#taSearchTop').oninput=e=>{ state.taFilter=e.target.value.trim(); renderTA(); }; $('#taPersonSelect').onchange=e=>{ state.taPerson=e.target.value; renderTA(); };
function renderTA(){ const it=currentItem(); const hoja=it.hojas[0]; const f=(state.taFilter||'').toLowerCase(); const per=state.taPerson||''; const cont=$('#taRows'); cont.innerHTML=''; hoja.rows.forEach((r,i)=>{ const okTxt=!f||(r.centro||'').toLowerCase().includes(f)||(r.persona||'').toLowerCase().includes(f); const okPer=!per||(r.persona||'')===per; if(!okTxt||!okPer) return; const row=document.createElement('div'); row.className='ta-row';
    row.innerHTML=`<div>${i+1}</div><input data-i="${i}" data-k="centro" value="${esc(r.centro||'')}"><input data-i="${i}" data-k="delegado" value="${esc(r.delegado||'')}"><select data-i="${i}" data-k="rol"><option ${r.rol!=='T√©cnico'?'selected':''}>Audi√≥logo</option><option ${r.rol==='T√©cnico'?'selected':''}>T√©cnico</option></select><input data-i="${i}" data-k="persona" value="${esc(r.persona||'')}" placeholder="Nombre"><input type="checkbox" data-i="${i}" data-k="formacion" ${r.formacion?'checked':''}><input type="checkbox" data-i="${i}" data-k="practicas" ${r.practicas?'checked':''}><input type="checkbox" data-i="${i}" data-k="certificado" ${r.certificado?'checked':''}><input type="number" min="0" step="1" data-i="${i}" data-k="pruebas_reales" value="${r.pruebas_reales??''}"><input type="number" min="0" step="1" data-i="${i}" data-k="ventas" value="${r.ventas??''}">`; cont.appendChild(row); });
}
$('#taRows').addEventListener('input',e=>{ if(!state.canEdit){e.preventDefault();return;} const it=currentItem(); const h=it.hojas[0]; const i=+e.target.dataset.i; const k=e.target.dataset.k; if(!k) return; if(e.target.type==='checkbox') h.rows[i][k]=e.target.checked; else if(e.target.type==='number') h.rows[i][k]=e.target.value===''?null:Number(e.target.value); else h.rows[i][k]=e.target.value; save(); });
$('#btnSaveTA').onclick=save; $('#btnSaveTATop').onclick=save; $('#btnCancelTA').onclick=()=>{state.selected={section:null,index:null};renderDetailBlank();}; $('#btnCancelTATop').onclick=()=>{state.selected={section:null,index:null};renderDetailBlank();};

/* ===== EQUIPOS ===== */
function fillEquipos(){ const it=currentItem(); if(!it) return; $('#eqSearchTop').value=state.eqFilter||''; renderEquipos(); toggleEditability(); }
$('#eqSearchTop')?.addEventListener('input',e=>{state.eqFilter=e.target.value.trim(); renderEquipos();});
$('#btnAddFila').onclick=()=>{ if(!state.canEdit){alert('Solo lectura.');return;} const it=currentItem(); it.filas.push({equipo:'',serie:'',persona:'',fecha:'',pares:Array.from({length:it.columnas},()=>({centro:'',sede:''}))}); renderEquipos(); save(); };
$('#btnAddParCols').onclick=()=>{ if(!state.canEdit){alert('Solo lectura.');return;} const it=currentItem(); it.columnas=(it.columnas||3)+1; it.filas.forEach(r=>r.pares.push({centro:'',sede:''})); renderEquipos(); save(); };

function renderEquipos(){
  const it=currentItem(); const cols=Math.max(1, it.columnas||3);
  const f=(state.eqFilter||'').toLowerCase();
  const root=$('#eqTable'); root.innerHTML='';

  const template = ['52px','220px','160px','180px','130px'].concat(
    Array.from({length:cols},()=>['180px','140px']).flat()
  ).join(' ');

  const head=document.createElement('div'); head.className='va-head'; head.style.gridTemplateColumns=template;
  head.innerHTML = `<div>#</div><div>Equipo</div><div>N¬∫ serie</div><div>Persona que env√≠a</div><div>Fecha</div>` +
    Array.from({length:cols},(_,i)=>`<div>Centro ${i+1}</div><div>Sede ${i+1}</div>`).join('');
  root.appendChild(head);

  const body=document.createElement('div'); body.className='scroll';
  root.appendChild(body);

  it.filas.forEach((r,i)=>{
    const txt = (r.equipo||'')+' '+(r.serie||'')+' '+(r.persona||' ')+' '+(r.pares||[]).map(p=>(p.centro||'')+' '+(p.sede||'')).join(' ');
    if(f && !txt.toLowerCase().includes(f)) return;

    const row=document.createElement('div'); row.className='va-row'; row.style.gridTemplateColumns=template;
    row.innerHTML = `<div>${i+1}</div>
      <input data-i="${i}" data-k="equipo" value="${esc(r.equipo||'')}">
      <input data-i="${i}" data-k="serie" value="${esc(r.serie||'')}">
      <input data-i="${i}" data-k="persona" value="${esc(r.persona||'')}">
      <input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">` +
      Array.from({length:cols},(_,c)=>`
        <input data-i="${i}" data-k="centro" data-c="${c}" value="${esc(r.pares?.[c]?.centro||'')}">
        <input data-i="${i}" data-k="sede" data-c="${c}" value="${esc(r.pares?.[c]?.sede||'')}">
      `).join('');
    body.appendChild(row);
  });

  body.addEventListener('input',e=>{
    if(!state.canEdit){ e.preventDefault(); return; }
    const i=+e.target.dataset.i; const k=e.target.dataset.k;
    if(k==='centro'||k==='sede'){ const c=+e.target.dataset.c; it.filas[i].pares[c][k]=e.target.value; }
    else it.filas[i][k]=e.target.value;
    save();
  });
}
$('#btnSaveEQ').onclick=save; $('#btnSaveEQTop').onclick=save;
$('#btnCancelEQ').onclick=()=>{state.selected={section:null,index:null};renderDetailBlank();};
$('#btnCancelEQTop').onclick=()=>{state.selected={section:null,index:null};renderDetailBlank();};

/* ===== Topbar ===== */
$('#btnEdit').onclick=requestEdit;
$('#btnRefresh').onclick=()=>{ if(!cloud.ready) return; cloud.ref.once('value').then(s=>{ const v=s.val(); if(v) data=v; $('#stamp').textContent='Actualizado: '+now(); renderAll();}); };
$('#btnSaveTop').onclick=save;

/* ===== Boot ===== */
function renderAll(){ renderLeft(); if(state.selected.section) renderDetail(); else renderDetailBlank(); toggleEditability(); }
window.addEventListener('load',()=>{ if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); } initFirebase(); renderAll(); });
</script>
</body>
</html>
