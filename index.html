<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SEGUIMIENTO AUDIO ¬∑ Cloud</title>
<meta name="theme-color" content="#c82727"/>
<style>
:root{
  --rojo:#c82727; --rojo-osc:#a71f1f;
  --bg:#f6f7fb; --line:#e6e7ee; --shadow:0 4px 14px rgba(0,0,0,.06);
  --col-ex:#fde2e4; --col-fl:#e2f0cb;
  --fs:11.5px; --fs-sm:10.3px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#222;font-size:var(--fs);line-height:1.18;overflow-x:auto}
button,input,select,textarea{font-family:inherit}

/* Lock */
body.locked header, body.locked main{pointer-events:none;user-select:none;filter:blur(.8px)}
body.locked #gate{pointer-events:auto;filter:none}

/* Topbar */
.topbar{position:sticky;top:0;z-index:99;width:100%;background:linear-gradient(180deg,var(--rojo),var(--rojo-osc));color:#fff;box-shadow:var(--shadow)}
.bar-inner{padding:.45rem 6px;display:flex;align-items:center;gap:.35rem}
.brand{font-weight:900;letter-spacing:.28px;font-size:12.2px}
.spacer{flex:1}
.btn{border:0;border-radius:8px;padding:.28rem .5rem;cursor:pointer;box-shadow:var(--shadow);font-weight:800;font-size:10.8px}
.btn-lite{background:#fff;color:#861212}
.btn-save{background:#fff;color:#7b0e0e}
.btn-ghost{background:transparent;border:1px solid #ffffff66;color:#fff}
.pill{display:inline-flex;gap:.28rem;align-items:center;border:1px solid #ffffff2f;background:#ffffff1c;padding:.15rem .42rem;border-radius:999px;white-space:nowrap;font-size:10.6px}

/* Layout */
.main{display:grid;grid-template-columns:190px minmax(0,1fr);gap:6px;padding:0 0 6px}
@media (max-width:1100px){.main{grid-template-columns:1fr}}
.sidebar{display:flex;flex-direction:column;gap:6px}
.side-card{border:1px solid var(--line);border-radius:10px;background:#fff;box-shadow:var(--shadow);display:flex;flex-direction:column}
.side-head{display:flex;justify-content:space-between;align-items:center;padding:.34rem .42rem;font-weight:900;border-bottom:1px solid var(--line);font-size:11.2px}
.side-list{padding:.3rem .35rem .4rem;overflow:auto;max-height:180px}
.side-btn{width:26px;height:22px;border-radius:6px;border:1px solid var(--line);background:#fff;cursor:pointer;font-size:10.5px}
.item{display:flex;justify-content:space-between;gap:.35rem;align-items:center;background:#fff;border:1px solid var(--line);border-radius:8px;padding:.28rem .34rem;margin:.22rem 0}
.item .name{font-weight:750;font-size:11.2px}
.item small{font-size:10.2px;opacity:.82}
.item.selected{outline:2px solid #a1c4fd}
.acts{display:flex;gap:.14rem}
.ico-btn{min-width:20px;height:20px;border-radius:5px;border:1px solid #e3e3ea;background:#fff;cursor:pointer;font-size:10px}

/* Color fondos */
.bg-ex{background:var(--col-ex)} .bg-fl{background:var(--col-fl)}

/* Detail */
.detail{padding:.35rem .4rem;border-radius:8px;border:1px solid var(--line);background:#fff;min-height:66vh;box-shadow:var(--shadow)}
.header-row{display:flex;align-items:center;gap:.6rem;margin-bottom:.25rem}
.header-row h2{margin:0;font-size:16px;letter-spacing:.1px}
.hdr-name{font-weight:900;font-size:19px}
.badge{padding:.08rem .44rem;border-radius:999px;background:#00000010;font-size:10.7px}
.header-row .spacer{flex:1}
.save-small{font-size:11px;padding:.36rem .66rem;border-radius:999px;background:#1f6feb;color:#fff;border:0;box-shadow:var(--shadow);cursor:pointer}

/* Forms */
.row{display:flex;gap:.35rem;flex-wrap:wrap;align-items:flex-end}
.field{display:grid;gap:.14rem;min-width:140px;flex:1;margin:.18rem 0}
.field label{font-weight:700;opacity:.9;font-size:10.6px}
.field input,.field select,.field textarea{border:1px solid var(--line);border-radius:7px;padding:.2rem .3rem;font-size:var(--fs-sm);background:#fff;outline:none}

/* Excel tables compact */
.table-wrap{border:1px solid var(--line);border-radius:8px;background:#fff;box-shadow:var(--shadow);padding:.22rem;margin-top:.22rem}
.table-wrap.full .xscroll{overflow-x:hidden}
.table-wrap.full .table-inner{min-width:100%;width:100%}
.xscroll{overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;padding-bottom:4px}
.table-inner{display:block;width:max-content;min-width:820px}
.table-inner input,.table-inner select,.table-inner textarea{padding:.16rem .26rem;font-size:var(--fs-sm)}
.va-head,.va-row{display:grid;gap:.12rem;align-items:center;margin:.04rem}
.scroll{max-height:62vh;overflow:auto}
.toolbar{display:flex;justify-content:flex-end;gap:.25rem;margin:.18rem 0 0}
.tool{border:1px solid var(--line);background:#fff;border-radius:7px;padding:.18rem .42rem;font-size:10.5px;cursor:pointer}

/* Grids */
.acc-head,.acc-row{grid-template-columns:36px 100px 80px 190px 90px 80px 90px 1fr 36px}
/* Formaci√≥n: Observaciones mucho m√°s ancho; checks centrados */
.frm-head,.frm-row{grid-template-columns:36px 1.1fr .45fr .45fr 2fr 36px}
.frm-row input[type="checkbox"]{display:block;margin:auto}
/* Procesos ampliado */
.proc-head,.proc-row{grid-template-columns:36px 116px 150px 86px 86px 98px 98px 160px 1.2fr 88px 36px}
.proc-row input[type="checkbox"]{display:block;margin:auto}

/* Status colors */
.pscore{border:2px solid transparent}
.pscore.good{background:#eaf9f0;border-color:#2ecc71aa}
.pscore.bad{background:#ffe8e8;border-color:#e74c3caa}
.conv{border:2px solid transparent}
.conv.good{background:#eaf9f0;border-color:rgba(46,204,113,.6)}
.conv.bad{background:#ffe8e8;border-color:rgba(231,76,60,.6)}
.hitcell{background:#ffe5e5;border:1px solid #f5c2c2;border-radius:5px;display:flex;justify-content:center;align-items:center;padding:.06rem}
.hitcell.on{background:#e6f6ed;border-color:#bfe7cc}

/* Gate */
.gate{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:1000}
.gate-card{background:#111;color:#fff;border-radius:10px;box-shadow:var(--shadow);padding:16px 14px;min-width:260px;border:1px solid #2a2a2a}
.pin{letter-spacing:.3rem;font-size:.95rem;text-align:center;background:#000;color:#fff;border:1px solid #444;border-radius:7px;padding:.38rem}
.subtle{opacity:.8;font-size:.82rem}
.legend{margin:.25rem 0 .1rem;color:#555;font-size:10.5px}
</style>
</head>
<body class="locked">

<header class="topbar">
  <div class="bar-inner">
    <div class="brand">SEGUIMIENTO AUDIO ¬∑ Cloud</div>
    <div class="spacer"></div>
    <button id="btnFetch" class="btn btn-lite" title="Leer desde local (demo)">Actualizar</button>
    <button id="btnSaveTop" class="btn btn-save" title="Guardar local">Guardar</button>
    <button id="btnReset" class="btn btn-ghost" title="Restaurar √∫ltima vista">Resetear</button>
    <span id="stamp" class="pill">v8.3 ¬∑ Cargando‚Ä¶</span>
  </div>
</header>

<main>
  <section class="main">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="side-card bg-ex" data-section="CENTROS EXCLUSIVOS">
        <div class="side-head"><div>üìí CENTROS EXCLUSIVOS</div>
          <div><button class="side-btn" data-act="toggle">‚ñæ</button><button class="side-btn" data-act="add">Ôºã</button></div>
        </div><div class="side-list"></div>
      </div>
      <div class="side-card bg-fl" data-section="CENTROS FLOP">
        <div class="side-head"><div>üìí CENTROS FLOP</div>
          <div><button class="side-btn" data-act="toggle">‚ñæ</button><button class="side-btn" data-act="add">Ôºã</button></div>
        </div><div class="side-list"></div>
      </div>
    </aside>

    <!-- Detail -->
    <section class="detail" id="detail">
      <div class="header-row">
        <h2>Detalle ‚Äî <span id="centerNameHdr" class="hdr-name">‚Äî</span></h2>
        <span id="detTag" class="badge">‚Äî</span>
        <div class="spacer"></div>
        <button id="saveBtnActive" class="save-small">üíæ Guardar</button>
      </div>
      <p id="detHint" style="opacity:.7;margin:.1rem 0 .2rem">Selecciona un centro a la izquierda (doble clic o ‚úèÔ∏è) o crea con Ôºã.</p>

      <!-- CENTROS -->
      <div id="detCentro" style="display:none">
        <div class="row">
          <div class="field"><label>Nombre</label><input id="cNombre"></div>
          <div class="field"><label>Delegado</label><input id="cDelegado"></div>
          <div class="field"><label>Audi√≥logo</label><input id="cAudiologo"></div>
          <div class="field"><label>Franquicia o Sucursal</label><select id="cTipo"><option>Franquicia</option><option>Sucursal</option></select></div>
        </div>

        <!-- ACCIONES -->
        <h3 style="margin:.35rem 0 .12rem;font-size:11.8px">ACCIONES</h3>
        <div class="toolbar"><button id="accAdd" class="tool">Ôºã A√±adir fila</button></div>
        <div class="table-wrap full">
          <div class="xscroll"><div class="table-inner">
            <div class="va-head acc-head">
              <div>#</div><div>Fecha</div><div>Paquete</div><div>Tipo de acci√≥n</div><div>Derivaci√≥n</div><div>Citas</div><div>Ventas</div><div>Observaciones</div><div></div>
            </div>
            <div id="accionesRows" class="scroll"></div>
          </div></div>
        </div>

        <!-- Leyenda de paquete -->
        <div class="legend">Paquete: <strong>1</strong> Tr√°fico ¬∑ <strong>2</strong> Formaci√≥n y comercial ¬∑ <strong>3</strong> Equipo</div>

        <!-- FORMACI√ìN -->
        <h3 style="margin:.35rem 0 .12rem;font-size:11.8px">FORMACI√ìN</h3>
        <div class="toolbar"><button id="frmAdd" class="tool">Ôºã A√±adir fila</button></div>
        <div class="table-wrap">
          <div class="xscroll"><div class="table-inner">
            <div class="va-head frm-head">
              <div>#</div><div>Curso</div><div>Realizado</div><div>Aplica</div><div>Observaciones</div><div></div>
            </div><div id="formacionesRows"></div>
          </div></div>
        </div>

        <!-- PROCESOS -->
        <h3 style="margin:.35rem 0 .12rem;font-size:11.8px">PROCESOS</h3>
        <div class="toolbar"><button id="procAdd" class="tool">Ôºã A√±adir fila</button></div>
        <div class="table-wrap">
          <div class="xscroll"><div class="table-inner">
            <div class="va-head proc-head">
              <div>#</div><div>Fecha de visita</div><div>Puntuaci√≥n procesos (%)</div><div>HIT</div><div>Pruebas RT</div><div>% Pruebas</div><div>% Venta</div><div>Colaboraciones locales</div><div>Observaciones</div><div>Adjunto</div><div></div>
            </div><div id="procesosRows"></div>
          </div></div>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- Gate -->
<div id="gate" class="gate" aria-modal="true" role="dialog">
  <div class="gate-card">
    <h3>Acceso</h3>
    <p class="subtle">Introduce el PIN para editar:</p>
    <input id="pin" class="pin" type="password" inputmode="numeric" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
    <div style="display:flex;gap:.35rem;margin-top:10px">
      <button id="enter" class="btn btn-lite" style="flex:1">Entrar</button>
      <button id="cancelPin" class="btn btn-ghost" style="flex:.8">Limpiar</button>
    </div>
    <p id="pinMsg" class="subtle" style="color:#ff7b7b;margin:.45rem 0 0 0;display:none">PIN incorrecto</p>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const APP_VERSION='v8.3-Centros';
const REQUIRE_PIN=true;
/* SHA-256('4321') */
const PIN_SHA256='fe2592b42a727e977f055947385b709cc82b16b9a87f88c6abf3900d65d0cdc3';

/* ===== Utils ===== */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const esc=s=>(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const now=()=>new Date().toLocaleString();
function toast(m){const t=document.createElement('div');t.textContent=m;Object.assign(t.style,{position:'fixed',bottom:'10px',left:'50%',transform:'translateX(-50%)',background:'#111',color:'#fff',padding:'6px 9px',borderRadius:'8px',zIndex:90,opacity:.95,fontSize:'11px'});document.body.appendChild(t);setTimeout(()=>t.remove(),1200);}

/* ===== Datos ===== */
let state={selected:{section:null,index:null}};
let data={
  "CENTROS EXCLUSIVOS":[{nombre:"Reina Mercedes",delegado:"",audiologo:"",tipo:"Franquicia",
    acciones:Array.from({length:12},()=>({fecha:'',paquete:'1',tipo:'Azafata/Buzoneo',derivacion:null,citas:null,venta:null,obs:''})),
    formaciones:Array.from({length:5},()=>({curso:'',realizado:false,aplica:false,obs:''})),
    procesos:Array.from({length:4},()=>({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null}))}],
  "CENTROS FLOP":[]
};
const LOCAL_KEY='audioseguimiento_centros_v83';
function localLoad(){try{const r=localStorage.getItem(LOCAL_KEY);if(r) data=JSON.parse(r);}catch(e){}}
function localSave(){try{localStorage.setItem(LOCAL_KEY,JSON.stringify(data));}catch(e){}}
function stamp(txt){$('#stamp').textContent='v8.3 ¬∑ '+txt}

/* ===== Sidebar ===== */
const SECTIONS=["CENTROS EXCLUSIVOS","CENTROS FLOP"];
function renderLeft(){
  SECTIONS.forEach(name=>{
    const box=document.querySelector(`.side-card[data-section="${name}"]`);
    const list=box.querySelector('.side-list'); list.innerHTML='';
    (data[name]||[]).forEach((it,i)=>{
      const div=document.createElement('div');div.className='item';div.dataset.index=i;
      div.innerHTML=`<div><div class="name">${esc(it.nombre||'‚Äî')}</div><small>Delegado: ${esc(it.delegado||'‚Äî')} ¬∑ Aud.: ${esc(it.audiologo||'‚Äî')}</small></div>
        <div class="acts"><button class="ico-btn" data-role="edit">‚úèÔ∏è</button><button class="ico-btn" data-role="del">üóëÔ∏è</button></div>`;
      div.addEventListener('dblclick',()=>{state.selected={section:name,index:i};renderDetail();});
      div.querySelector('[data-role="edit"]').onclick=(e)=>{e.stopPropagation();state.selected={section:name,index:i};renderDetail();};
      div.querySelector('[data-role="del"]').onclick=(e)=>{e.stopPropagation();if(confirm('¬øEliminar?')){data[name].splice(i,1);renderLeft();renderDetailBlank();localSave();}};
      list.appendChild(div);
    });
    box.querySelector('[data-act="add"]').onclick=()=>{data[name].push({nombre:'(nuevo centro)',delegado:'',audiologo:'',tipo:'Franquicia',acciones:Array.from({length:12},()=>({fecha:'',paquete:'1',tipo:'Azafata/Buzoneo',derivacion:null,citas:null,venta:null,obs:''})),formaciones:Array.from({length:5},()=>({curso:'',realizado:false,aplica:false,obs:''})),procesos:Array.from({length:4},()=>({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null}))});renderLeft();localSave();}
    box.querySelector('[data-act="toggle"]').onclick=()=>{list.style.display=list.style.display==='none'?'':'none'; if(list.style.display==='none'){renderDetailBlank();}};
  });
}

/* ===== Detalle ===== */
function renderDetailBlank(){
  $('#detHint').style.display='block'; $('#detTag').textContent='‚Äî'; $('#centerNameHdr').textContent='‚Äî';
  $('#detCentro').style.display='none';
}
function setTone(s){const d=$('#detail'); d.style.background = s==="CENTROS EXCLUSIVOS"?'var(--col-ex)':'var(--col-fl)';}
function cur(){return data[state.selected.section]?.[state.selected.index];}
function renderDetail(){
  $('#detHint').style.display='none';
  const s=state.selected.section; setTone(s); $('#detTag').textContent=s||'‚Äî';
  const it=cur(); $('#centerNameHdr').textContent=it?.nombre||'‚Äî';
  $('#saveBtnActive').onclick=saveCentro;
  $('#detCentro').style.display='block';
  fillCentro();
}

/* ===== CENTRO ===== */
function fillCentro(){
  const it=cur(); if(!it) return;
  $('#cNombre').value=it.nombre||''; $('#cDelegado').value=it.delegado||''; $('#cAudiologo').value=it.audiologo||''; $('#cTipo').value=it.tipo||'Franquicia';
  renderAcciones(); renderFormacion(); renderProcesos();
}
function saveCentro(){
  const it=cur(); if(!it) return;
  it.nombre=$('#cNombre').value.trim(); it.delegado=$('#cDelegado').value.trim(); it.audiologo=$('#cAudiologo').value.trim(); it.tipo=$('#cTipo').value;
  $('#centerNameHdr').textContent=it.nombre||'‚Äî'; localSave(); toast('Guardado');
}

/* ===== ACCIONES ===== */
function renderAcciones(){
  const it=cur(); it.acciones=it.acciones||[];
  const cont=$('#accionesRows'); cont.innerHTML='';
  it.acciones.forEach((r,i)=>{
    const row=document.createElement('div'); row.className='acc-row va-row';
    row.innerHTML=`
      <div>${i+1}</div>
      <input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">
      <select data-i="${i}" data-k="paquete">
        <option ${r.paquete==='1'?'selected':''}>1</option>
        <option ${r.paquete==='2'?'selected':''}>2</option>
        <option ${r.paquete==='3'?'selected':''}>3</option>
      </select>
      <select data-i="${i}" data-k="tipo">
        <option ${r.tipo==='Azafata/Buzoneo'?'selected':''}>Azafata/Buzoneo</option>
        <option ${r.tipo==='Stand'?'selected':''}>Stand</option>
        <option ${r.tipo==='Mailing/Cashback'?'selected':''}>Mailing/Cashback</option>
        <option ${r.tipo==='Otros'?'selected':''}>Otros</option>
      </select>
      <input type="number" min="0" step="1" data-i="${i}" data-k="derivacion" value="${r.derivacion??''}">
      <input type="number" min="0" step="1" data-i="${i}" data-k="citas" value="${r.citas??''}">
      <input type="number" min="0" step="1" data-i="${i}" data-k="venta" value="${r.venta??''}">
      <input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}">
      <button class="ico-btn" title="Eliminar" data-acc-del="${i}">üóëÔ∏è</button>`;
    cont.appendChild(row);
  });
}
$('#accAdd').onclick=()=>{cur().acciones.push({fecha:'',paquete:'1',tipo:'Azafata/Buzoneo',derivacion:null,citas:null,venta:null,obs:''});renderAcciones();localSave();}
$('#accionesRows').addEventListener('click',e=>{const i=e.target.dataset.accDel; if(i!=null){cur().acciones.splice(+i,1);renderAcciones();localSave();}});
$('#accionesRows').addEventListener('input',e=>{
  const i=e.target.dataset.i,k=e.target.dataset.k;if(i==null||!k) return;
  const r=cur().acciones[+i];
  if(e.target.type==='number') r[k]=e.target.value===''?null:Number(e.target.value);
  else r[k]=e.target.value;
  localSave();
});

/* ===== FORMACI√ìN (m√≠nimo 5) ===== */
function ensureMin5(arr){while(arr.length<5) arr.push({curso:'',realizado:false,aplica:false,obs:''});}
function renderFormacion(){
  const it=cur(); it.formaciones=it.formaciones||[]; ensureMin5(it.formaciones);
  const cont=$('#formacionesRows'); cont.innerHTML='';
  it.formaciones.forEach((r,i)=>{
    const row=document.createElement('div'); row.className='frm-row va-row';
    row.innerHTML=`<div>${i+1}</div>
      <input data-i="${i}" data-k="curso" value="${esc(r.curso||'')}">
      <input type="checkbox" data-i="${i}" data-k="realizado" ${r.realizado?'checked':''}>
      <input type="checkbox" data-i="${i}" data-k="aplica" ${r.aplica?'checked':''}>
      <input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}">
      <button class="ico-btn" data-frm-del="${i}" title="Eliminar">üóëÔ∏è</button>`;
    cont.appendChild(row);
  });
}
$('#frmAdd').onclick=()=>{cur().formaciones.push({curso:'',realizado:false,aplica:false,obs:''});renderFormacion();localSave();}
$('#formacionesRows').addEventListener('click',e=>{const i=e.target.dataset.frmDel;if(i!=null){cur().formaciones.splice(+i,1);renderFormacion();localSave();}});
$('#formacionesRows').addEventListener('input',e=>{
  const i=e.target.dataset.i,k=e.target.dataset.k;if(i==null||!k) return;
  const r=cur().formaciones[+i];
  if(e.target.type==='checkbox') r[k]=e.target.checked; else r[k]=e.target.value;
  localSave();
});

/* ===== PROCESOS ===== */
function score95(v){const n=Number(v);if(!Number.isFinite(n))return'';return n>=95?'good':'bad';}
function score80(v){const n=Number(v);if(!Number.isFinite(n))return'';return n>=80?'good':'bad';}
function ensureMin4(arr){while(arr.length<4) arr.push({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null});}
function renderProcesos(){
  const it=cur(); it.procesos=it.procesos||[]; ensureMin4(it.procesos);
  const cont=$('#procesosRows'); cont.innerHTML='';
  it.procesos.forEach((r,i)=>{
    const row=document.createElement('div'); row.className='proc-row va-row';
    const hasAdj = r.adjunto && r.adjunto.data;
    row.innerHTML=`<div>${i+1}</div>
      <input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">
      <input class="pscore ${score95(r.puntuacion)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="puntuacion" value="${r.puntuacion??''}">
      <div class="hitcell ${r.hit?'on':''}"><input type="checkbox" data-i="${i}" data-k="hit" ${r.hit?'checked':''}></div>
      <input type="checkbox" data-i="${i}" data-k="rt" ${r.rt?'checked':''}>
      <input class="conv ${score80(r.pruebas)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="pruebas" value="${r.pruebas??''}">
      <input class="conv ${score80(r.venta)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="venta" value="${r.venta??''}">
      <input data-i="${i}" data-k="colab" value="${esc(r.colab||'')}">
      <input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}">
      <span>
        <button class="ico-btn" data-adj="${i}" title="Adjuntar">üìé</button>
        ${hasAdj?`<a href="${r.adjunto.data}" download="${esc(r.adjunto.name||'adjunto')}" class="ico-btn" title="Ver/descargar" style="text-decoration:none;display:inline-block;text-align:center;">üîó</a>`:''}
        <input type="file" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" data-file="${i}" style="display:none">
      </span>
      <button class="ico-btn" data-proc-del="${i}" title="Eliminar">üóëÔ∏è</button>`;
    cont.appendChild(row);
  });
}
$('#procAdd').onclick=()=>{cur().procesos.push({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null});renderProcesos();localSave();}
$('#procesosRows').addEventListener('click',e=>{
  const d=e.target.dataset;
  if(d.procDel!=null){cur().procesos.splice(+d.procDel,1);renderProcesos();localSave();return;}
  if(d.adj!=null){const i=+d.adj; const input=$(`[data-file="${i}"]`,$('#procesosRows')); input.click();}
});
$('#procesosRows').addEventListener('change',e=>{
  const i=e.target.dataset.file; if(i==null) return;
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{const r=cur().procesos[+i]; r.adjunto={name:f.name,data:reader.result}; localSave(); renderProcesos();};
  reader.readAsDataURL(f);
});
$('#procesosRows').addEventListener('input',e=>{
  const i=e.target.dataset.i,k=e.target.dataset.k;if(i==null||!k)return;
  const r=cur().procesos[+i];
  if(e.target.type==='checkbox'){ r[k]=e.target.checked; if(k==='hit'){const cell=e.target.closest('.hitcell'); if(cell) cell.classList.toggle('on',e.target.checked);} }
  else if(e.target.type==='number'){
    r[k]=e.target.value===''?null:Number(e.target.value);
    if(k==='puntuacion'){e.target.className='pscore '+score95(r[k]);}
    if(k==='pruebas'||k==='venta'){e.target.className='conv '+score80(r[k]);}
  } else r[k]=e.target.value;
  localSave();
});

/* ===== Topbar ===== */
$('#btnSaveTop').onclick=()=>{saveCentro();};
$('#btnFetch').onclick=()=>{localLoad();renderLeft(); if(state.selected.section) renderDetail(); stamp('Actualizado: '+now());};
$('#btnReset').onclick=()=>{localLoad();renderLeft();renderDetailBlank();toast('Reset vista');};

/* ===== PIN ===== */
async function sha256Hex(str){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(str));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}
async function checkPin(val){let s=(val||'').trim(); if(/^AR/i.test(s)) s=s.slice(2); if(!s) return false; try{return (await sha256Hex(s))===PIN_SHA256;}catch(_){return false;}}
function unlock(){document.body.classList.remove('locked');$('#gate').style.display='none';}
function lock(){document.body.classList.add('locked');$('#gate').style.display='flex';$('#pin').focus();}
async function tryEnter(){ $('#pinMsg').style.display='none'; const ok=await checkPin($('#pin').value); if(ok){unlock();toast('Edici√≥n activada');}else{$('#pinMsg').style.display='block';}}
$('#enter').onclick=tryEnter; $('#pin').addEventListener('keydown',e=>{if(e.key==='Enter') tryEnter();}); $('#cancelPin').onclick=()=>{$('#pin').value='';$('#pinMsg').style.display='none';}

/* ===== Init ===== */
function renderAll(){renderLeft();renderDetailBlank();}
window.addEventListener('DOMContentLoaded',()=>{ if(REQUIRE_PIN) lock(); });
window.addEventListener('load',()=>{localLoad();renderAll();stamp('Listo: '+now());});
</script>
</body>
</html>
