<!-- === Pegar justo antes de </body> en https://arrojasboris-byte.github.io/AudioSeguimiento/ === -->
<script type="module">
  /********************************************************************
   * AudioSeguimiento ‚Äì Sincronizaci√≥n en la nube (Firestore)
   * - Guarda/recupera el estado desde la nube
   * - PIN fijo: AR4321 (se guarda en localStorage)
   * - Muestra "√öltima actualizaci√≥n" y estado de sincronizaci√≥n
   *
   * INSTRUCCIONES (una sola vez):
   * 1) Crea un proyecto en https://console.firebase.google.com
   * 2) Activa Firestore (modo production)
   * 3) Copia tu CONFIG de Firebase aqu√≠ abajo (apiKey, authDomain, projectId...)
   * 4) En Firestore Reglas, para prototipo, puedes usar (restringe m√°s tarde):
   *    rules_version = '2';
   *    service cloud.firestore {
   *      match /databases/{database}/documents {
   *        match /platformStates/{docId} {
   *          allow read, write: if true;
   *        }
   *      }
   *    }
   ********************************************************************/

  // 1) CONFIG de tu proyecto Firebase (Rellena con tus valores)
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    projectId: "TU_PROJECT_ID",
    // Opcionales, pero recomendables si los tienes:
    // storageBucket: "TU_STORAGE_BUCKET",
    // messagingSenderId: "TU_SENDER_ID",
    // appId: "TU_APP_ID",
  };

  // 2) Import del SDK v9 modular (desde CDN oficial)
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

  // 3) Utilidad: hash SHA-256 (hex)
  async function sha256Hex(text) {
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // 4) PIN fijo (AR4321) ‚Üí se guarda en localStorage para no preguntar
  const FIXED_PIN = "AR4321";
  localStorage.setItem('audioseguimiento_pin', FIXED_PIN);

  // 5) Hooks necesarios (AJUSTA ESTO A TU APLICACI√ìN REAL)
  // Deben existir 2 funciones globales para serializar/aplicar el estado.
  // Si ya las tienes, elimina estos "fallbacks" y usa las tuyas.
  if (typeof window.getPlatformState !== 'function') {
    // EJEMPLO: recoge campos t√≠picos de la UI. AD√ÅPTALO a tu DOM.
    window.getPlatformState = () => {
      const notas = document.querySelector('#notas')?.value || '';
      // Si tienes listados, tablas o sliders, l√©elos aqu√≠.
      return {
        notas,
        // pacientes: leerPacientesDeTuUI(),
        // ajustes: leerAjustesDeTuUI(),
        version: 'demo',
        savedAt: Date.now()
      };
    };
  }
  if (typeof window.applyPlatformState !== 'function') {
    // EJEMPLO: aplica el estado en la UI. AD√ÅPTALO a tu DOM.
    window.applyPlatformState = (state) => {
      if (!state) return;
      try {
        if (typeof state.notas === 'string' && document.querySelector('#notas')) {
          document.querySelector('#notas').value = state.notas;
        }
        // if (state.pacientes) pintarPacientesEnTuUI(state.pacientes);
        // if (state.ajustes) aplicarAjustesEnTuUI(state.ajustes);
      } catch (e) {
        console.warn('No se pudo aplicar parte del estado:', e);
      }
      // Vista previa r√°pida (opcional)
      const area = document.querySelector('#estado-previsualizacion');
      if (area) area.textContent = JSON.stringify(state, null, 2);
    };
  }

  // 6) UI m√≠nima: barra flotante + previsualizaci√≥n de estado (puedes quitarlo)
  const toolbar = document.createElement('div');
  toolbar.style.position = 'fixed';
  toolbar.style.right = '1rem';
  toolbar.style.bottom = '1rem';
  toolbar.style.zIndex = '2147483647';
  toolbar.style.background = 'rgba(0,0,0,0.75)';
  toolbar.style.color = '#fff';
  toolbar.style.padding = '10px 12px';
  toolbar.style.borderRadius = '12px';
  toolbar.style.fontFamily = 'system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif';
  toolbar.style.boxShadow = '0 6px 18px rgba(0,0,0,0.25)';
  toolbar.innerHTML = `
    <div style="display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;">
      <strong>Cloud Sync</strong>
      <button id="btn-actualizar" style="padding:.4rem .7rem; border:0; border-radius:8px; cursor:pointer;">Actualizar</button>
      <button id="btn-guardar" style="padding:.4rem .7rem; border:0; border-radius:8px; cursor:pointer;">Guardar</button>
      <span id="sync-status" style="opacity:.9">‚è≥ Inicializando‚Ä¶</span>
      <span id="last-update" style="opacity:.9">‚Äî</span>
    </div>`;
  document.body.appendChild(toolbar);

  const pre = document.createElement('pre');
  pre.id = 'estado-previsualizacion';
  pre.style.position = 'fixed';
  pre.style.left = '1rem';
  pre.style.bottom = '1rem';
  pre.style.maxWidth = '40vw';
  pre.style.maxHeight = '30vh';
  pre.style.overflow = 'auto';
  pre.style.background = 'rgba(255,255,255,0.95)';
  pre.style.padding = '8px 10px';
  pre.style.borderRadius = '12px';
  pre.style.fontSize = '12px';
  pre.style.boxShadow = '0 6px 18px rgba(0,0,0,0.15)';
  pre.style.color = '#111';
  pre.style.whiteSpace = 'pre-wrap';
  document.body.appendChild(pre);

  const statusEl = document.getElementById('sync-status');
  const lastEl = document.getElementById('last-update');
  const setStatus = (t) => statusEl.textContent = t;
  const setLast = (date) => {
    if (!date) { lastEl.textContent = '‚Äî'; return; }
    try {
      const d = date.toDate ? date.toDate() : new Date(date);
      lastEl.textContent = `√öltima actualizaci√≥n: ${d.toLocaleString('es-ES')}`;
    } catch {
      lastEl.textContent = '‚Äî';
    }
  };

  // 7) Firebase / Firestore
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // 8) Derivar docId a partir del PIN hasheado (evita doc predecible)
  const currentPIN = localStorage.getItem('audioseguimiento_pin') || FIXED_PIN;
  const docId = await sha256Hex(currentPIN.trim());
  const docRef = doc(db, 'platformStates', docId);

  // 9) Suscripci√≥n en tiempo real
  setStatus('üîÑ Conectando‚Ä¶');
  let initialApplied = false;
  onSnapshot(docRef, (snap) => {
    if (snap.exists()) {
      const data = snap.data();
      setLast(data.lastUpdated);
      if (data && data.state) {
        // Evita que la primera aplicaci√≥n pise cambios locales no guardados:
        if (!initialApplied) {
          window.applyPlatformState(data.state);
          initialApplied = true;
        }
        setStatus('‚úÖ Sincronizado');
      } else {
        setStatus('‚ÑπÔ∏è Documento vac√≠o');
      }
    } else {
      setStatus('‚ûï A√∫n no hay estado en la nube');
      setLast(null);
    }
  }, (err) => {
    console.error(err);
    setStatus('‚ö†Ô∏è Error escuchando cambios');
  });

  // 10) Guardar a nube
  async function saveToCloud() {
    try {
      setStatus('üíæ Guardando‚Ä¶');
      const state = await Promise.resolve(window.getPlatformState());
      await setDoc(docRef, {
        state,
        lastUpdated: serverTimestamp(),
        updatedBy: 'web'
      }, { merge: true });
      setStatus('‚úÖ Guardado');
    } catch (e) {
      console.error(e);
      setStatus('‚ùå Error al guardar');
      alert('Error guardando en la nube. Revisa la consola.');
    }
  }

  // 11) Forzar actualizaci√≥n desde nube
  async function refreshFromCloud() {
    try {
      setStatus('‚¨áÔ∏è Actualizando‚Ä¶');
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        setLast(data.lastUpdated);
        if (data && data.state) {
          window.applyPlatformState(data.state);
          setStatus('‚úÖ Actualizado');
        } else {
          setStatus('‚ÑπÔ∏è Documento vac√≠o');
        }
      } else {
        setStatus('‚ûï No existe estado a√∫n');
        setLast(null);
      }
    } catch (e) {
      console.error(e);
      setStatus('‚ùå Error al actualizar');
      alert('Error actualizando desde la nube.');
    }
  }

  // 12) Auto-guardado opcional (descomenta si quieres autosave por cambios)
  // let saveTimer;
  // function autoSave() {
  //   clearTimeout(saveTimer);
  //   saveTimer = setTimeout(saveToCloud, 800);
  // }
  // Ejemplos:
  // document.querySelector('#notas')?.addEventListener('input', autoSave);

  // 13) Eventos de la barra
  document.getElementById('btn-guardar').addEventListener('click', saveToCloud);
  document.getElementById('btn-actualizar').addEventListener('click', refreshFromCloud);

  // 14) (Opcional) Guardar al cerrar/recargar
  // window.addEventListener('beforeunload', () => { navigator.sendBeacon ? navigator.sendBeacon(...) : saveToCloud(); });
</script>
