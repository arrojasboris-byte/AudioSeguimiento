<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SEGUIMIENTO AUDIO ¬∑ Cloud</title>
<meta name="theme-color" content="#c82727"/>
<style>
  :root{
    --rojo:#c82727; --rojo2:#a71f1f; --bg:#f6f7fb; --card:#fff; --line:#e6e7ee;
    --tx:#111; --muted:#6b7280; --ok:#16a34a; --bad:#ef4444;
    --sh:0 4px 14px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--tx);font:14px/1.25 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

  /* Top */
  .topbar{position:sticky;top:0;z-index:1000;width:100%;
    color:#fff;background:linear-gradient(180deg,var(--rojo),var(--rojo2));box-shadow:var(--sh)}
  .topbar .inner{max-width:1200px;margin:auto;padding:10px 12px;display:flex;align-items:center;gap:10px}
  .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.4px}
  .sp{flex:1}
  .pill{border:1px solid #ffffff44;background:#ffffff14;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .pill.primary{background:#fff;color:#111;font-weight:800}
  .pill:disabled{opacity:.6;cursor:not-allowed}
  .badge{font-size:12px;opacity:.9}

  /* Layout */
  .main{max-width:1200px;margin:12px auto;padding:0 12px;display:grid;grid-template-columns:260px 1fr;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--sh)}
  .side .sec{padding:12px;border-bottom:1px solid var(--line)}
  .side .sec:last-child{border-bottom:0}
  .sec h4{margin:0 0 8px;display:flex;align-items:center;gap:6px;font-size:13px}
  .btn{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
  .detail{padding:12px}
  .toolbar{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .grid{overflow:auto;border:1px solid var(--line);border-radius:8px}
  table{border-collapse:collapse;width:100%;min-width:760px}
  th,td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left;white-space:nowrap}
  thead th{background:#fafafb} tfoot td{background:#fafafb;font-weight:700}
  .ok{background:#10b98112} .bad{background:#ef444410} .muted{color:var(--muted)}
  .topbar:not(:first-of-type){display:none!important} /* anti-duplicados */

  /* PIN overlay (si no tienes uno, usamos este) */
  #pinOverlay{position:fixed;inset:0;background:rgba(0,0,0,.78);
    display:none;align-items:center;justify-content:center;z-index:9999}
  #pinOverlay .panel{background:#1b1b1b;color:#fff;padding:18px 20px;border-radius:12px;width:min(92vw,360px);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  #pinOverlay input{width:130px;text-align:center;letter-spacing:.3em}
  #pinOverlay .msg{display:none;color:#ffb3b3;margin-top:8px;font-size:12px}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="inner">
    <div class="logo">üéß SEGUIMIENTO AUDIO</div>
    <div class="sp"></div>
    <button class="pill" id="btnReload">Actualizar</button>
    <button class="pill" id="btnSaveLocal">Guardar (local)</button>
    <button class="pill primary" id="btnSaveCloud">Guardar (nube)</button>
    <button class="pill" id="btnLoadCloud">Recuperar (nube)</button>
    <span class="badge" id="cloudBadge">Nube: ‚Äî</span>
  </div>
</div>

<!-- Layout b√°sico (puedes reemplazar el contenido del detalle por tu plataforma) -->
<div class="main">
  <div class="card side">
    <div class="sec">
      <h4>üìà Cifra de ventas</h4>
      <button class="btn" id="btnOpenComp">‚ñ∂ Abrir Compa√±√≠a</button>
    </div>
    <div class="sec">
      <h4>‚≠ê Centros exclusivos</h4>
      <button class="btn" id="btnAddCE">+ A√±adir</button>
    </div>
    <div class="sec">
      <h4>üü© Centros flop</h4>
      <button class="btn" id="btnAddCF">+ A√±adir</button>
    </div>
    <div class="sec">
      <h4>üß≠ Visitas audio</h4>
      <button class="btn" id="btnOpenVis">‚ñ∂ Abrir</button>
    </div>
    <div class="sec">
      <h4>üéì Formaciones y mentoring</h4>
      <button class="btn" id="btnOpenFor">‚ñ∂ Abrir</button>
    </div>
    <div class="sec">
      <h4>ü©∫ Teleaudiolog√≠a</h4>
      <button class="btn" id="btnOpenTele">‚ñ∂ Abrir</button>
    </div>
    <div class="sec">
      <h4>üß∞ Equipos</h4>
      <button class="btn" id="btnOpenEq">‚ñ∂ Abrir</button>
    </div>
  </div>

  <div class="card detail">
    <div class="toolbar">
      <h3 id="detTitle" style="margin:0">CIFRA ‚Äî COMPA√ë√çA</h3>
      <span class="muted">Meses: Ago-25 ‚Üí Jul-26</span>
    </div>
    <div class="grid">
      <table id="tblCifra">
        <thead>
          <tr><th>Mes</th><th>Previsto</th><th>CV mes</th><th>Diferencia</th></tr>
        </thead>
        <tbody id="tbCuerpo"></tbody>
        <tfoot>
          <tr><td>Total</td><td id="totPrev">0</td><td id="totMes">0</td><td id="totDif">0</td></tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<!-- PIN (fallback) -->
<div id="pinOverlay" aria-modal="true" role="dialog">
  <div class="panel">
    <h3 style="margin:0 0 10px">Acceso</h3>
    <div style="opacity:.85;margin-bottom:10px">Introduce el PIN para editar:</div>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="pin" type="password" inputmode="numeric" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="one-time-code"/>
      <button id="enter" class="btn" style="background:#fff;font-weight:800">Acceder</button>
      <button id="clear" class="btn">Limpiar</button>
    </div>
    <div id="pinMsg" class="msg">PIN incorrecto</div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const GAS_URL  = 'https://script.google.com/macros/s/AKfycbwsfNXUKAClhKT-Jv_yPEpPNNkJxfwQE1CdKtiOsfxPprc8oeccmbCduuv7L5PriwiI/exec';  // ‚¨ÖÔ∏è Pega aqu√≠ tu /exec
const PIN_CODE = '4321';

/* ===== Utilidades ===== */
const $ = (s,r=document)=>r.querySelector(s);
const nf = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
const MESES = ['Ago-25','Sep-25','Oct-25','Nov-25','Dic-25','Ene-26','Feb-26','Mar-26','Abr-26','May-26','Jun-26','Jul-26'];

function cssPath(el){
  if(!(el instanceof Element)) return '';
  const path=[]; while(el && el.nodeType===1 && el!==document.body){
    let sel = el.nodeName.toLowerCase();
    if(el.id){ sel += '#'+CSS.escape(el.id); path.unshift(sel); break; }
    let sib=el, nth=1; while(sib = sib.previousElementSibling) if(sib.nodeName===el.nodeName) nth++;
    sel += `:nth-of-type(${nth})`; path.unshift(sel); el=el.parentNode;
  } return path.join(' > ');
}
function safeQuery(path){ try{return document.querySelector(path);}catch{ return null; } }
function serializeControls(){
  const out=[]; document.querySelectorAll('input,select,textarea,[contenteditable="true"]').forEach(el=>{
    const t=(el.type||'').toLowerCase(); let v;
    if(t==='checkbox'||t==='radio') v=!!el.checked;
    else if(el.isContentEditable) v=el.innerHTML;
    else v=el.value;
    out.push({path:cssPath(el),t,v});
  }); return out;
}
function restoreControls(list){
  if(!Array.isArray(list)) return;
  list.forEach(it=>{
    const el=safeQuery(it.path); if(!el) return;
    const t=(el.type||'').toLowerCase();
    if(t==='checkbox'||t==='radio') el.checked=!!it.v;
    else if(el.isContentEditable) el.innerHTML=it.v??'';
    else el.value=it.v??'';
    el.dispatchEvent(new Event('input',{bubbles:true}));
    el.dispatchEvent(new Event('change',{bubbles:true}));
  });
}

/* ===== PIN ===== */
(function pinGate(){
  const overlay=$('#pinOverlay'), pin=$('#pin'), enter=$('#enter'), clear=$('#clear'), msg=$('#pinMsg');
  function open(){ overlay.style.display='flex'; overlay.style.visibility='visible'; overlay.style.opacity='1'; overlay.style.pointerEvents='auto'; overlay.style.zIndex='9999'; document.body.style.overflow='hidden'; setTimeout(()=>pin&&pin.focus(),60); }
  function close(){ overlay.style.display='none'; document.body.style.overflow=''; }
  async function go(){
    const code=(pin.value||'').trim();
    if(String(code)===String(PIN_CODE||'4321')){ sessionStorage.setItem('__SEGUI_AUDIO_AUTH__','1'); msg.style.display='none'; close();}
    else { msg.style.display='block'; pin.select(); }
  }
  enter.addEventListener('click',go);
  clear.addEventListener('click',()=>{pin.value='';pin.focus();});
  pin.addEventListener('keydown',e=>{ if(e.key==='Enter') go(); });
  document.addEventListener('DOMContentLoaded',()=>{ if(sessionStorage.getItem('__SEGUI_AUDIO_AUTH__')!=='1') open(); });
})();

/* ===== Tabla demo CIFRA (para verificar que todo responde) ===== */
(function buildCifra(){
  const tb=$('#tbCuerpo'); tb.innerHTML='';
  MESES.forEach(m=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m}</td>
      <td><input type="number" min="0" step="1" class="inPrev" placeholder="0"/></td>
      <td><input type="number" min="0" step="1" class="inMes" placeholder="0"/></td>
      <td class="difCell muted">0</td>`;
    tb.appendChild(tr);
  });
  const upd=()=>calcCifra();
  document.querySelectorAll('.inPrev,.inMes').forEach(i=>{i.addEventListener('input',upd);i.addEventListener('change',upd);});
  calcCifra();
})();
function calcCifra(){
  let tP=0,tM=0,tD=0;
  document.querySelectorAll('#tbCuerpo tr').forEach(tr=>{
    const p=Number(tr.querySelector('.inPrev').value||0);
    const m=Number(tr.querySelector('.inMes').value||0);
    const d=m-p; tP+=p; tM+=m; tD+=d;
    const cell=tr.querySelector('.difCell'); cell.textContent=nf.format(d);
    cell.classList.remove('ok','bad','muted');
    if(p===0 && m===0) cell.classList.add('muted'); else if(m>=p) cell.classList.add('ok'); else cell.classList.add('bad');
  });
  $('#totPrev').textContent=nf.format(tP);
  $('#totMes').textContent =nf.format(tM);
  $('#totDif').textContent =nf.format(tD);
}

/* ===== Nube (Apps Script) sin preflight ===== */
function setBadge(txt){ const b=$('#cloudBadge'); if(b) b.textContent='Nube: '+txt; }

async function saveCloud(){
  try{
    if(!GAS_URL || !/\/exec(\?|$)/.test(GAS_URL)) throw new Error('GAS_URL inv√°lida (falta /exec)');
    const payload={ ts:new Date().toISOString(), origin:location.href, values:serializeControls() };
    const res=await fetch(GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=UTF-8'}, // evita preflight
      body: JSON.stringify({action:'save', data: JSON.stringify(payload)}),
      cache:'no-store', mode:'cors'
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    setBadge('guardado ‚úì');
    alert('Guardado en nube ‚úì');
  }catch(e){ console.error(e); setBadge('error'); alert('Error al guardar en nube: '+e.message); }
}

async function loadCloud(){
  try{
    if(!GAS_URL || !/\/exec(\?|$)/.test(GAS_URL)) throw new Error('GAS_URL inv√°lida (falta /exec)');
    const res=await fetch(GAS_URL+'?action=load&nc='+Date.now(),{method:'GET',cache:'no-store',mode:'cors'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const j=await res.json().catch(()=>null);
    const raw=(j&&j.data)?j.data:'';
    if(!raw){ alert('Nube vac√≠a'); setBadge('vac√≠o'); return; }
    const obj=JSON.parse(raw);
    if(obj && obj.values) restoreControls(obj.values);
    setBadge('cargado ‚úì'); alert('Datos recuperados de la nube');
  }catch(e){ console.error(e); setBadge('error'); alert('Error al recuperar de nube: '+e.message); }
}

/* ===== Local ===== */
function saveLocal(){
  try{ localStorage.setItem('__SEGUI_AUDIO_LOCAL__', JSON.stringify({ts:new Date().toISOString(),values:serializeControls()})); alert('Guardado local ‚úì'); }
  catch(e){ alert('Error guardando local: '+e.message); }
}

/* ===== Eventos ===== */
document.addEventListener('DOMContentLoaded',()=>{
  $('#btnReload')?.addEventListener('click',()=>location.reload());
  $('#btnSaveLocal')?.addEventListener('click',saveLocal);
  $('#btnSaveCloud')?.addEventListener('click',saveCloud);
  $('#btnLoadCloud')?.addEventListener('click',loadCloud);
  $('#btnOpenComp')?.addEventListener('click',()=>{$('#detTitle').textContent='CIFRA ‚Äî COMPA√ë√çA';});
  setBadge('listo');
});
</script>
</body>
</html>
