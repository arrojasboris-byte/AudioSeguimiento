<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SEGUIMIENTO AUDIO ¬∑ Cloud</title>
<meta name="theme-color" content="#c82727"/>
<style>
:root{
  --rojo:#c82727; --rojo2:#a71f1f; --bg:#f6f7fb; --line:#e6e7ee; --txt:#222;
  --card:#fff; --sh:0 4px 14px rgba(0,0,0,.06);
  --fs:12px; --fs-sm:11px;
  --ok:#16a34a; --warn:#d97706; --err:#b91c1c;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--txt);font:var(--fs)/1.25 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

/* Topbar */
.topbar{position:sticky;top:0;z-index:50;width:100%;
  background:linear-gradient(180deg,var(--rojo),var(--rojo2));color:#fff;box-shadow:var(--sh)}
.topbar .wrap{display:grid;grid-template-columns:1fr auto auto;gap:.6rem;align-items:center;padding:.8rem .9rem}
.brand{display:flex;gap:.6rem;align-items:center;font-weight:900;font-size:22px}
.brand i{font-style:normal}
.btn{border:0;border-radius:999px;padding:.42rem .82rem;font-weight:800;font-size:11px;cursor:pointer;box-shadow:var(--sh)}
.btn.white{background:#fff;color:#111}
.btn.ghost{background:transparent;border:1px solid #ffffff66;color:#fff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.pill{border:1px solid #ffffff33;background:#ffffff1a;border-radius:999px;padding:.16rem .6rem;font-size:11px}

/* Layout */
.main{display:grid;grid-template-columns:260px 1fr;gap:10px;padding:10px;max-width:1400px;margin:8px auto}
@media (max-width:1100px){.main{grid-template-columns:1fr}}
.left .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--sh);padding:.6rem}
.left h4{margin:.1rem .2rem .4rem;font-size:12px;font-weight:900;color:#6b7280;display:flex;justify-content:space-between;align-items:center}
.item{display:flex;justify-content:space-between;align-items:center;background:#fafbff;border:1px solid var(--line);border-radius:10px;margin:.3rem 0;padding:.4rem .55rem}
.item .t{font-weight:800}
.iconbtn{border:1px solid var(--line);background:#fff;border-radius:9px;padding:.22rem .45rem;cursor:pointer;font-size:11px}

.right{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--sh);padding:12px;min-height:72vh}
.head{display:flex;align-items:center;gap:.6rem;border-bottom:1px solid var(--line);padding-bottom:8px;margin-bottom:10px}
.head h3{margin:0;font-size:18px}
.helper{display:flex;gap:6px;align-items:center;font-size:11px;color:#6b7280}
.dot{width:8px;height:8px;border-radius:50%}
.dot.ok{background:#22c55e}.dot.warn{background:#f59e0b}.dot.err{background:#ef4444}

/* Forms & tables */
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:8px}
.card{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px}
input[type="text"],input[type="number"],input[type="month"],input[type="date"],textarea,select{
  width:100%;padding:.36rem .5rem;border:1px solid var(--line);border-radius:9px;background:#fff;font-size:var(--fs-sm)
}
table{width:100%;border-collapse:collapse;min-width:840px}
th,td{border:1px solid var(--line);padding:.35rem .45rem;font-size:var(--fs-sm)}
th{background:#f3f4f6;text-align:left}

/* Modals */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:100}
.modal.show{display:flex}
.modal .box{background:#111;color:#fff;border-radius:14px;box-shadow:var(--sh);padding:16px;min-width:320px;max-width:92vw}
.modal .box h3{margin:0 0 10px}

/* Badges */
.badge{display:inline-block;border-radius:999px;padding:.1rem .5rem;font-weight:900;font-size:11px}
.badge.ok{background:#dcfce7;color:#166534}
.badge.warn{background:#fef3c7;color:#92400e}

/* Small helpers */
.empty{padding:18px;border:1px dashed var(--line);border-radius:12px;text-align:center;color:#9ca3af}
.mr{margin-right:.5rem}
</style>
</head>

<body>
  <!-- TOP -->
  <div class="topbar">
    <div class="wrap">
      <div class="brand"><i>üéß</i><span>SEGUIMIENTO AUDIO</span></div>
      <div>
        <button class="btn white" id="btnLoad">Actualizar (nube)</button>
        <button class="btn white" id="btnSave" disabled>Guardar (nube)</button>
      </div>
      <div>
        <button class="btn ghost" id="btnCfg">Configurar</button>
        <span class="pill" id="cloudBadge">Cloud: sin configurar</span>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- LEFT -->
    <div class="left">
      <div class="panel">
        <h4>CIFRA DE VENTAS <span class="mr"></span></h4>
        <div class="item" data-open="cifra-compania"><div class="t">Compa√±√≠a</div><button class="iconbtn">‚ûî</button></div>
        <div class="item" data-open="cifra-exclusivos"><div class="t">Centros exclusivos</div><button class="iconbtn">‚ûî</button></div>
      </div>

      <div class="panel">
        <h4>CENTROS EXCLUSIVOS</h4>
        <div class="item" data-open="centros-exclusivos"><div class="t">Panel</div><button class="iconbtn">‚úé</button></div>
      </div>

      <div class="panel">
        <h4>CENTROS FLOP</h4>
        <div class="item" data-open="centros-flop"><div class="t">Panel</div><button class="iconbtn">‚úé</button></div>
      </div>

      <div class="panel">
        <h4>VISITAS AUDIO</h4>
        <div class="item" data-open="visitas"><div class="t">Panel</div><button class="iconbtn">‚úé</button></div>
      </div>

      <div class="panel">
        <h4>FORMACIONES Y MENTORING</h4>
        <div class="item" data-open="formaciones"><div class="t">Panel</div><button class="iconbtn">‚úé</button></div>
      </div>

      <div class="panel">
        <h4>TELEAUDIOLOG√çA</h4>
        <div class="item" data-open="tele"><div class="t">Panel</div><button class="iconbtn">‚úé</button></div>
      </div>

      <div class="panel">
        <h4>EQUIPOS</h4>
        <div class="item" data-open="equipos"><div class="t">7 packs</div><button class="iconbtn">‚ûî</button></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <div class="head">
        <h3 id="viewTitle">Selecciona un panel</h3>
        <div class="helper">
          <span>Estado nube:</span>
          <span id="dot" class="dot warn"></span>
        </div>
      </div>

      <div id="views">

        <!-- CIFRA: COMPA√ë√çA -->
        <section data-view="cifra-compania" hidden>
          <div class="row">
            <div class="card" style="grid-column:span 12">
              <div style="font-size:11px;color:#6b7280">Meses <b>ago/2025 ‚Üí jul/2026</b>. Verde si CV mes ‚â• Previsto; rojo si CV mes &lt; Previsto.</div>
              <br/>
              <table id="tblCComp">
                <thead><tr><th>Mes</th><th>Previsto</th><th>CV mes</th><th>Œî</th></tr></thead>
                <tbody></tbody>
                <tfoot><tr><th>Total</th><th id="ccPrev">0</th><th id="ccMes">0</th><th id="ccDif">0</th></tr></tfoot>
              </table>
            </div>
          </div>
        </section>

        <!-- CIFRA: EXCLUSIVOS -->
        <section data-view="cifra-exclusivos" hidden>
          <div class="row">
            <div class="card" style="grid-column:span 12">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-size:11px;color:#6b7280">A√±ade centros y su cifra mes a mes.</div>
                <button class="btn white" id="btnAddEx">+ A√±adir l√≠nea</button>
              </div>
              <br/>
              <table id="tblCEx">
                <thead><tr><th>Centro</th><th>Mes</th><th>Previsto</th><th>CV mes</th><th>Œî</th><th></th></tr></thead>
                <tbody></tbody>
                <tfoot><tr><th colspan="2">Total</th><th id="exPrev">0</th><th id="exMes">0</th><th id="exDif">0</th><th></th></tr></tfoot>
              </table>
            </div>
          </div>
        </section>

        <!-- CENTROS EXCLUSIVOS -->
        <section data-view="centros-exclusivos" hidden>
          <div class="empty">Aqu√≠ puedes seguir con tu tabla detallada de Centros Exclusivos. (Se guardar√° en nube).</div>
        </section>

        <!-- CENTROS FLOP -->
        <section data-view="centros-flop" hidden>
          <div class="empty">Aqu√≠ puedes replicar la tabla de Flop. (Guardado en nube).</div>
        </section>

        <!-- VISITAS -->
        <section data-view="visitas" hidden>
          <div class="row">
            <div class="card" style="grid-column:span 6">
              <label>Buscador</label>
              <input id="vsSearch" placeholder="Centro / visitador‚Ä¶"/>
            </div>
            <div class="card" style="grid-column:span 6;display:flex;justify-content:flex-end;align-items:flex-end">
              <button class="btn white" id="btnAddVisita">+ A√±adir visita</button>
            </div>
          </div>
          <br/>
          <table id="tblVisitas">
            <thead><tr>
              <th>#</th><th>Centro</th><th>Visitador</th><th>Rol</th><th>Fecha</th><th>Adjunto (URL)</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- FORMACIONES -->
        <section data-view="formaciones" hidden>
          <div class="row">
            <div class="card" style="grid-column:span 12;display:flex;justify-content:space-between;align-items:center">
              <div style="font-size:11px;color:#6b7280">Mentoring general / por delegados (a√±ade l√≠neas). Se guarda en nube.</div>
              <button class="btn white" id="btnAddForm">+ A√±adir</button>
            </div>
            <div class="card" style="grid-column:span 12">
              <table id="tblForm">
                <thead><tr><th>Fecha</th><th>Delegado</th><th>Tema</th><th>Asistencia</th><th>Observaciones</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- TELEAUDIOLOG√çA -->
        <section data-view="tele" hidden>
          <div class="row">
            <div class="card" style="grid-column:span 3"><span class="badge ok" id="cntCert">Certificados: 0</span></div>
            <div class="card" style="grid-column:span 3"><span class="badge warn" id="cntForm">Formaciones: 0</span></div>
            <div class="card" style="grid-column:span 6;display:flex;justify-content:flex-end;align-items:center">
              <button class="btn white" id="btnAddTele">+ A√±adir fila</button>
            </div>
            <div class="card" style="grid-column:span 12">
              <table id="tblTele">
                <thead><tr><th>Centro</th><th>Tipo</th><th>Fecha</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- EQUIPOS -->
        <section data-view="equipos" hidden>
          <div class="row">
            <div class="card" style="grid-column:span 6">
              <label>Buscador general (equipo / serie / centro)</label>
              <input id="eqSearch" placeholder="Buscar en todos los packs‚Ä¶">
            </div>
          </div>
          <br/>
          <div id="packs"></div>
        </section>

      </div>
    </div>
  </div>

  <!-- MODAL PIN -->
  <div class="modal" id="mPin">
    <div class="box">
      <h3>Acceso</h3>
      <div>Pulsa <b>Acceder</b> o Enter. PIN: <b>4321</b></div><br/>
      <input id="inPin" type="password" inputmode="numeric" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;padding:.6rem;border-radius:10px;border:1px solid #333;background:#000;color:#fff"/>
      <br/><br/>
      <div style="display:flex;gap:8px">
        <button class="btn white" id="btnEnter">Acceder</button>
        <button class="btn ghost" id="btnPinClear">Limpiar</button>
      </div>
    </div>
  </div>

  <!-- MODAL CONFIG -->
  <div class="modal" id="mCfg">
    <div class="box">
      <h3>Configurar nube</h3>
      <div style="font-size:12px;color:#d1d5db">Pega aqu√≠ tu URL <code>/exec</code> del despliegue de Google Apps Script.</div>
      <br/>
      <input id="inUrl" type="url" placeholder="https://script.google.com/macros/s/‚Ä¶/exec" style="width:100%;padding:.6rem;border-radius:10px;border:1px solid #333;background:#000;color:#fff"/>
      <br/><br/>
      <div style="display:flex;gap:8px">
        <button class="btn white" id="btnSaveUrl">Guardar</button>
        <button class="btn ghost" id="btnCloseCfg">Cerrar</button>
      </div>
      <br/>
      <div style="font-size:11px;color:#a1a1aa">Apps Script: Implementar ‚Üí Nueva implementaci√≥n ‚Üí <b>Aplicaci√≥n web</b> ‚Üí Ejecutar como <b>t√∫</b> ‚Üí Acceso <b>Cualquiera con el enlace</b> ‚Üí Implementar.</div>
    </div>
  </div>

<script>
/* ======= Estado ======= */
const months = ['2025-08','2025-09','2025-10','2025-11','2025-12','2026-01','2026-02','2026-03','2026-04','2026-05','2026-06','2026-07'];

let state = {
  cifra: {
    compania: months.map(m=>({mes:m, previsto:0, mescv:0})),
    exclusivos: [] // {centro, mes, previsto, mescv}
  },
  visitas: [],     // {centro, visitador, rol, fecha, adj}
  formaciones: [], // {fecha, delegado, tema, asis, obs}
  tele: [],        // {centro, tipo(cert|form), fecha}
  equipos: {       // 7 packs
    packs: Array.from({length:7}, (_,i)=>({
      nombre:'Pack '+(i+1),
      filas: Array.from({length:5},()=>({
        equipo:'', serie:'', persona:'', fecha:'',
        pares:[{centro:'',c:false,s:false},{centro:'',c:false,s:false},{centro:'',c:false,s:false}]
      }))
    }))
  }
};

/* ======= Util ======= */
const $=s=>document.querySelector(s);
const $$=s=>[...document.querySelectorAll(s)];
function fmt(n){n=Number(n||0);return Intl.NumberFormat('es-ES').format(n)}
function setDot(state){ $('#dot').className='dot '+state; $('#cloudBadge').textContent = 'Cloud: '+({ok:'lista',warn:'sin configurar',err:'error'}[state]||'') }
function lsGet(k){try{return localStorage.getItem(k)||''}catch(_){return''}}
function lsSet(k,v){try{localStorage.setItem(k,v)}catch(_){}}
function gasUrl(){ const u=lsGet('GAS_URL'); return (u.startsWith('https://script.google.com/'))?u:''; }
function openModal(id){ $(id).classList.add('show'); }
function closeModal(id){ $(id).classList.remove('show'); }
function toast(msg,type){ const el=document.createElement('div'); el.textContent=msg; el.style.cssText='position:fixed;top:14px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:999px;z-index:120';
  if(type==='err') el.style.background='#b91c1c'; document.body.appendChild(el); setTimeout(()=>el.remove(),1600);}

/* ======= Vistas ======= */
function openView(id){
  const titles={
    'cifra-compania':'Cifra de ventas ¬∑ Compa√±√≠a',
    'cifra-exclusivos':'Cifra de ventas ¬∑ Centros exclusivos',
    'centros-exclusivos':'Centros exclusivos',
    'centros-flop':'Centros flop',
    'visitas':'Visitas audio',
    'formaciones':'Formaciones y mentoring',
    'tele':'Teleaudiolog√≠a',
    'equipos':'Equipos'
  };
  $('#viewTitle').textContent = titles[id]||'Panel';
  $$('#views > section').forEach(s=>s.hidden = s.dataset.view!==id);
}

/* --- Cifra: compa√±√≠a --- */
function colorCell(td,d){ td.style.background = d<0?'#fee2e2':(d>0?'#dcfce7':'#fff'); }
function renderCComp(){
  const tb=$('#tblCComp tbody'); tb.innerHTML='';
  let sP=0,sM=0,sD=0;
  state.cifra.compania.forEach((r,idx)=>{
    const d=Number(r.mescv||0)-Number(r.previsto||0);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="month" value="${r.mes}"/></td>
      <td><input type="number" min="0" value="${r.previsto}"/></td>
      <td><input type="number" min="0" value="${r.mescv}"/></td>
      <td class="d">${fmt(d)}</td>`;
    tb.appendChild(tr);
    colorCell(tr.querySelector('.d'), d);
    const [m,p,v]=tr.querySelectorAll('input');
    m.oninput=e=>{r.mes=e.target.value; renderCComp();}
    p.oninput=e=>{r.previsto=+e.target.value||0; renderCComp();}
    v.oninput=e=>{r.mescv=+e.target.value||0; renderCComp();}
    sP+=+r.previsto||0; sM+=+r.mescv||0; sD+=d;
  });
  $('#ccPrev').textContent=fmt(sP);
  $('#ccMes').textContent=fmt(sM);
  $('#ccDif').textContent=fmt(sD);
}

/* --- Cifra: exclusivos --- */
function renderCEx(){
  const tb=$('#tblCEx tbody'); tb.innerHTML='';
  let sP=0,sM=0,sD=0;
  state.cifra.exclusivos.forEach((r,i)=>{
    const d=(+r.mescv||0)-(+r.previsto||0);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input value="${r.centro||''}" placeholder="Centro"/></td>
      <td><input type="month" value="${r.mes||''}"/></td>
      <td><input type="number" min="0" value="${r.previsto||0}"/></td>
      <td><input type="number" min="0" value="${r.mescv||0}"/></td>
      <td class="d">${fmt(d)}</td>
      <td><button class="iconbtn" data-del="${i}">üóë</button></td>`;
    tb.appendChild(tr);
    colorCell(tr.querySelector('.d'), d);
    const [c,m,p,v]=tr.querySelectorAll('input');
    c.oninput=e=>{r.centro=e.target.value;}
    m.oninput=e=>{r.mes=e.target.value; renderCEx();}
    p.oninput=e=>{r.previsto=+e.target.value||0; renderCEx();}
    v.oninput=e=>{r.mescv=+e.target.value||0; renderCEx();}
    sP+=+r.previsto||0; sM+=+r.mescv||0; sD+=d;
  });
  $('#exPrev').textContent=fmt(sP);
  $('#exMes').textContent=fmt(sM);
  $('#exDif').textContent=fmt(sD);
  tb.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{state.cifra.exclusivos.splice(+b.dataset.del,1); renderCEx();});
}
$('#btnAddEx')?.addEventListener('click',()=>{state.cifra.exclusivos.push({centro:'',mes:'',previsto:0,mescv:0}); renderCEx();});

/* --- Visitas --- */
function renderVisitas(){
  const tb=$('#tblVisitas tbody'); tb.innerHTML='';
  const q=($('#vsSearch').value||'').toLowerCase();
  state.visitas.forEach((r,i)=>{
    if(q && !(`${r.centro||''} ${r.visitador||''}`.toLowerCase().includes(q))) return;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td>
      <td><input value="${r.centro||''}"/></td>
      <td><input value="${r.visitador||''}" placeholder="Nombre"/></td>
      <td><select>
        <option ${r.rol==='Responsable tec Audio'?'selected':''}>Responsable tec Audio</option>
        <option ${r.rol==='Delegado de audio'?'selected':''}>Delegado de audio</option>
      </select></td>
      <td><input type="date" value="${r.fecha||''}"/></td>
      <td><input value="${r.adj||''}" placeholder="URL Excel"/></td>`;
    tb.appendChild(tr);
    const [c,v,sel,f,a]=[...tr.querySelectorAll('input,select')].filter((_,ix)=>ix!==0); // skip index cell
    c.oninput=e=>{ r.centro=e.target.value; };
    v.oninput=e=>{ r.visitador=e.target.value; };
    sel.oninput=e=>{ r.rol=e.target.value; };
    f.oninput=e=>{ r.fecha=e.target.value; };
    a.oninput=e=>{ r.adj=e.target.value; };
  });
}
$('#btnAddVisita')?.addEventListener('click',()=>{ state.visitas.push({rol:'Responsable tec Audio'}); renderVisitas(); });
$('#vsSearch')?.addEventListener('input',renderVisitas);

/* --- Formaciones --- */
function renderForm(){
  const tb=$('#tblForm tbody'); tb.innerHTML='';
  state.formaciones.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="date" value="${r.fecha||''}"/></td>
      <td><input value="${r.delegado||''}"/></td>
      <td><input value="${r.tema||''}"/></td>
      <td><input value="${r.asis||''}"/></td>
      <td><input value="${r.obs||''}"/></td>`;
    tb.appendChild(tr);
    const [f,d,t,a,o]=tr.querySelectorAll('input');
    f.oninput=e=>{ r.fecha=e.target.value; };
    d.oninput=e=>{ r.delegado=e.target.value; };
    t.oninput=e=>{ r.tema=e.target.value; };
    a.oninput=e=>{ r.asis=e.target.value; };
    o.oninput=e=>{ r.obs=e.target.value; };
  });
}
$('#btnAddForm')?.addEventListener('click',()=>{ state.formaciones.push({}); renderForm(); });

/* --- Teleaudiolog√≠a --- */
function renderTele(){
  const tb=$('#tblTele tbody'); tb.innerHTML='';
  let cC=0,cF=0;
  state.tele.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input value="${r.centro||''}"/></td>
      <td><select>
        <option value="cert" ${r.tipo==='cert'?'selected':''}>cert</option>
        <option value="form" ${r.tipo==='form'?'selected':''}>form</option>
      </select></td>
      <td><input type="date" value="${r.fecha||''}"/></td>`;
    tb.appendChild(tr);
    tr.querySelector('input').oninput=e=>{ r.centro=e.target.value; };
    const sel=tr.querySelector('select'); sel.oninput=e=>{ r.tipo=e.target.value; updateTeleCounters(); };
    tr.querySelector('input[type="date"]').oninput=e=>{ r.fecha=e.target.value; };
    if(r.tipo==='cert') cC++; else if(r.tipo==='form') cF++;
  });
  $('#cntCert').textContent='Certificados: '+cC;
  $('#cntForm').textContent='Formaciones: '+cF;
}
function updateTeleCounters(){ renderTele(); }
$('#btnAddTele')?.addEventListener('click',()=>{ state.tele.push({tipo:'cert'}); renderTele(); });

/* --- Equipos (7 packs) --- */
function renderPacks(){
  const root=$('#packs'); root.innerHTML='';
  const q=($('#eqSearch').value||'').toLowerCase();
  state.equipos.packs.forEach((pack,pi)=>{
    const box=document.createElement('div'); box.className='card'; box.style.marginBottom='8px';
    box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900">${pack.nombre}</div>
      <button class="iconbtn" data-tog="${pi}">‚ñæ</button>
    </div>
    <div class="ct" data-ct="${pi}" style="margin-top:8px"></div>`;
    root.appendChild(box);

    const ct = box.querySelector('.ct');
    // tabla
    const tbl=document.createElement('table'); tbl.innerHTML=`
      <thead><tr>
        <th>Equipo</th><th>N¬∫ serie</th><th>Persona</th><th>Fecha</th>
        <th>Centro 1</th><th>C1</th><th>S1</th>
        <th>Centro 2</th><th>C2</th><th>S2</th>
        <th>Centro 3</th><th>C3</th><th>S3</th>
      </tr></thead><tbody></tbody>`;
    ct.appendChild(tbl);
    const tb=tbl.querySelector('tbody');
    pack.filas.forEach((r,ri)=>{
      const text=(r.equipo||'')+' '+(r.serie||'')+' '+(r.persona||'')+' '+r.pares.map(p=>p.centro||'').join(' ');
      if(q && !text.toLowerCase().includes(q)) return;
      const tr=document.createElement('tr');
      const P=i=>r.pares[i]||{centro:'',c:false,s:false};
      tr.innerHTML=`<td><input value="${r.equipo||''}"/></td>
        <td><input value="${r.serie||''}"/></td>
        <td><input value="${r.persona||''}"/></td>
        <td><input type="date" value="${r.fecha||''}"/></td>
        <td><input value="${P(0).centro||''}"/></td><td><input type="checkbox" ${P(0).c?'checked':''}/></td><td><input type="checkbox" ${P(0).s?'checked':''}/></td>
        <td><input value="${P(1).centro||''}"/></td><td><input type="checkbox" ${P(1).c?'checked':''}/></td><td><input type="checkbox" ${P(1).s?'checked':''}/></td>
        <td><input value="${P(2).centro||''}"/></td><td><input type="checkbox" ${P(2).c?'checked':''}/></td><td><input type="checkbox" ${P(2).s?'checked':''}/></td>`;
      tb.appendChild(tr);
      const ins=[...tr.querySelectorAll('input')];
      ins[0].oninput=e=>{ r.equipo=e.target.value; };
      ins[1].oninput=e=>{ r.serie=e.target.value; };
      ins[2].oninput=e=>{ r.persona=e.target.value; };
      ins[3].oninput=e=>{ r.fecha=e.target.value; };
      // pares
      [[4,5,6,0],[7,8,9,1],[10,11,12,2]].forEach(([iC,iCk,iSk,idx])=>{
        ins[iC].oninput=e=>{ r.pares[idx].centro=e.target.value; };
        ins[iCk].oninput=e=>{ r.pares[idx].c=e.target.checked; };
        ins[iSk].oninput=e=>{ r.pares[idx].s=e.target.checked; };
      });
    });
    // toggle
    box.querySelector('[data-tog]').onclick=()=>{
      ct.style.display = ct.style.display==='none' ? '' : 'none';
    };
  });
}
$('#eqSearch')?.addEventListener('input',renderPacks);

/* ======= Cloud ======= */
async function cloudLoad(){
  const url=gasUrl(); if(!url){ openModal('#mCfg'); return; }
  setDot('ok');
  try{
    const r=await fetch(url+'?action=load',{mode:'cors',cache:'no-store'});
    const t=await r.text(); let obj={};
    try{obj=JSON.parse(t||'{}')}catch(_){}
    if(obj && typeof obj==='object') state=obj;
    renderAll(); toast('Datos cargados');
  }catch(e){ console.error(e); setDot('err'); toast('Error al cargar','err'); }
}
async function cloudSave(){
  const url=gasUrl(); if(!url){ openModal('#mCfg'); return; }
  try{
    const r=await fetch(url,{method:'POST',mode:'cors',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'save', data: JSON.stringify(state)})});
    if(!r.ok) throw new Error(r.status);
    toast('Guardado en nube');
  }catch(e){ console.error(e); toast('Error al guardar','err'); }
}

/* ======= Render general ======= */
function renderAll(){
  renderCComp(); renderCEx(); renderVisitas(); renderForm(); renderTele(); renderPacks();
}

/* ======= Arranque ======= */
window.addEventListener('DOMContentLoaded',()=>{
  // Nav clicks
  $$('.left .item').forEach(x=>x.addEventListener('click',()=>openView(x.dataset.open)));
  // Botones nube
  $('#btnLoad').onclick=cloudLoad;
  $('#btnSave').onclick=cloudSave;
  // Config
  $('#btnCfg').onclick=()=>{ $('#inUrl').value=gasUrl(); openModal('#mCfg'); };
  $('#btnCloseCfg').onclick=()=>closeModal('#mCfg');
  $('#btnSaveUrl').onclick=()=>{ const v=$('#inUrl').value.trim(); if(v.startsWith('https://script.google.com/')&&v.endsWith('/exec')){ lsSet('GAS_URL',v); setDot('ok'); closeModal('#mCfg'); toast('URL guardada'); } else toast('URL inv√°lida','err'); };
  // PIN
  const pinOk = v => { v=(v||'').trim(); if(/^AR/i.test(v)) v=v.slice(2); return v==='4321'; };
  const enter=()=>{ if(pinOk($('#inPin').value)){ $('#mPin').classList.remove('show'); $('#btnSave').disabled=false; } else toast('PIN incorrecto','err'); };
  $('#btnEnter').onclick=enter;
  $('#btnPinClear').onclick=()=>$('#inPin').value='';
  $('#inPin').addEventListener('keydown',e=>{ if(e.key==='Enter') enter(); });
  openModal('#mPin');

  // Cloud badge
  setDot(gasUrl()?'ok':'warn');

  // Vista inicial y render
  openView('cifra-compania'); renderAll();
});
</script>
</body>
</html>
