<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SEGUIMIENTO AUDIO</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; background:#f6f7fb; }
    header {
      position: sticky; top:0; z-index: 20;
      background: linear-gradient(90deg,#c62828,#e53935);
      color:#fff; padding:12px 16px; box-shadow:0 8px 26px rgba(0,0,0,.25);
    }
    .bar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .title { font-weight:900; letter-spacing:.3px; margin-right:8px; font-size:1.15rem; }
    .chip {
      display:inline-flex; align-items:center; gap:.45rem;
      background: rgba(255,255,255,.15); color:#fff; padding:8px 12px;
      border-radius:999px; font-weight:700; box-shadow: inset 0 0 0 1px rgba(255,255,255,.15);
    }
    .chip input[type="text"]{
      width:130px; border:0; outline:none; font:inherit; background:transparent; color:#fff;
      border-bottom:1px dashed rgba(255,255,255,.45); padding-bottom:2px;
    }
    .btn {
      display:inline-flex; align-items:center; gap:.5rem; cursor:pointer;
      border:0; border-radius:999px; padding:9px 14px; font-weight:800;
      background:#fff; color:#b71c1c; box-shadow:0 6px 16px rgba(0,0,0,.25);
    }
    .btn.secondary { background:rgba(255,255,255,.92); color:#2b2b2b; }
    .sep { opacity:.5; margin:0 .2rem; }
    .status { font-weight:700; }
    .last { opacity:.9 }
    main { max-width:1060px; margin:18px auto; padding:0 16px; display:grid; gap:16px; }
    .grid { display:grid; grid-template-columns:repeat(12,1fr); gap:16px; }
    .card { grid-column:span 12; background:#fff; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(34,48,92,.08); }
    .card h2 { margin:0 0 10px; font-size:1.05rem; }
    label { display:block; font-size:.92rem; opacity:.85; margin-bottom:6px; }
    input[type="text"], select, textarea, input[type="range"]{ width:100%; border:1px solid rgba(0,0,0,.12); border-radius:12px; padding:10px 12px; font:inherit; background:#fff; }
    textarea{ min-height:120px; resize:vertical; }
    .row{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
    .col-6{ grid-column:span 6; } .col-4{ grid-column:span 4; } .col-3{ grid-column:span 3; }
    .muted{ opacity:.7; font-size:.9rem; }
    pre#preview{ background:#f1f3f7; border-radius:12px; padding:10px; margin:0; max-height:260px; overflow:auto; font-size:12px; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:0 14px 30px rgba(0,0,0,.25); z-index:9999; opacity:.97 }
    @media (prefers-color-scheme: dark){
      body{ background:#0e1116; } .card{ background:#171a21; }
      input,select,textarea{ background:#0f1217; color:#eee; border-color:rgba(255,255,255,.12); }
      pre#preview{ background:#0f1217; color:#d7dbea; }
      .btn{ background:#ffecec; color:#a30000; }
      .btn.secondary{ background:#f2f2f2; color:#1e1e1e; }
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <span class="title">SEGUIMIENTO AUDIO</span>

      <!-- LO (identificador de seguimiento) -->
      <span class="chip" title="Identificador del seguimiento">
        üîñ LO:
        <input id="lo" type="text" placeholder="ej: 001" />
      </span>

      <!-- Botones con iconos -->
      <button id="btnSave" class="btn" title="Guardar en la nube">üíæ Guardar</button>
      <button id="btnLoad" class="btn secondary" title="Actualizar desde la nube">üîÑ Actualizar</button>

      <span class="sep">‚Äî</span>
      <label class="chip" title="Guardado autom√°tico"><input id="chkAuto" type="checkbox" /> Auto</label>

      <span class="chip" title="PIN actual">üîë PIN: <strong>&nbsp;AR4321&nbsp;</strong></span>

      <span class="chip status" id="status">‚è≥</span>
      <span class="chip last" id="last">‚Äî</span>
    </div>
  </header>

  <main class="grid">
    <!-- Proyecto -->
    <section class="card">
      <h2>Proyecto</h2>
      <div class="row">
        <div class="col-6">
          <label>T√≠tulo</label>
          <input data-cloud id="titulo" type="text" placeholder="Nombre del proyecto..." />
        </div>
        <div class="col-3">
          <label>Estado</label>
          <select data-cloud id="estado">
            <option value="">‚Äî</option>
            <option value="nuevo">Nuevo</option>
            <option value="en_progreso">En progreso</option>
            <option value="bloqueado">Bloqueado</option>
            <option value="finalizado">Finalizado</option>
          </select>
        </div>
        <div class="col-3">
          <label>Progreso: <span id="lblProgreso" class="muted">0%</span></label>
          <input data-cloud id="progreso" type="range" min="0" max="100" step="1" value="0" />
        </div>
      </div>
    </section>

    <!-- Prioridad / Opciones -->
    <section class="card">
      <h2>Prioridad y opciones</h2>
      <div class="row">
        <div class="col-4">
          <label>Prioridad</label>
          <div>
            <label><input data-cloud name="prioridad" type="radio" value="alta" /> Alta</label>&nbsp;&nbsp;
            <label><input data-cloud name="prioridad" type="radio" value="media" /> Media</label>&nbsp;&nbsp;
            <label><input data-cloud name="prioridad" type="radio" value="baja" /> Baja</label>
          </div>
        </div>
        <div class="col-4">
          <label><input data-cloud id="aviso" type="checkbox" /> Avisarme cuando cambie</label>
        </div>
        <div class="col-4">
          <label>Responsable</label>
          <input data-cloud id="responsable" type="text" placeholder="Nombre..." />
        </div>
      </div>
    </section>

    <!-- Checklist -->
    <section class="card">
      <h2>Checklist</h2>
      <div class="row">
        <div class="col-6"><label><input data-cloud id="tarea1" type="checkbox" /> Brief recibido</label></div>
        <div class="col-6"><label><input data-cloud id="tarea2" type="checkbox" /> Material validado</label></div>
        <div class="col-6"><label><input data-cloud id="tarea3" type="checkbox" /> QA interno</label></div>
        <div class="col-6"><label><input data-cloud id="tarea4" type="checkbox" /> Entregado a cliente</label></div>
      </div>
    </section>

    <!-- Notas -->
    <section class="card">
      <h2>Notas</h2>
      <textarea data-cloud id="notas" placeholder="Escribe aqu√≠‚Ä¶"></textarea>
    </section>

    <!-- Vista previa -->
    <section class="card">
      <h2>Vista previa del estado guardado</h2>
      <pre id="preview">‚Äî</pre>
    </section>
  </main>

  <!-- === Cloud Sync (sin tokens) ‚Äì Cliente === -->
  <script type="module">
    /********** Config **********/
    const PIN_BASE = "AR4321"; // PIN fijo visible en cabecera
    const ENDPOINT_EMBED = "https://script.google.com/macros/s/AKfycby5vh1Ja0XllWFB98ypWmDcUfUItwEciVimUd5L6Esi1wfPJbcc2dap6G0lciRf51VR/exec";
    const CFG_KEY = "audioseguimiento_endpoint_url";
    const LO_KEY  = "audioseguimiento_lo";
    const BK_KEY  = "audioseguimiento_backup";

    /********** Helpers **********/
    const $ = s => document.querySelector(s);
    const qs = n => new URL(location.href).searchParams.get(n);
    function getEndpoint(){
      const viaQS = qs("endpoint");
      if (viaQS) return viaQS;
      try { return JSON.parse(localStorage.getItem(CFG_KEY) || "null") || ENDPOINT_EMBED; }
      catch { return ENDPOINT_EMBED; }
    }
    // LO persistente
    const loInput = $("#lo");
    (function initLO(){
      const fromQS = qs("lo");
      const stored = localStorage.getItem(LO_KEY) || "";
      loInput.value = (fromQS ?? stored ?? "");
      loInput.addEventListener("change", ()=> localStorage.setItem(LO_KEY, loInput.value.trim()));
    })();

    function effectivePIN(){
      const lo = loInput.value.trim();
      return lo ? `${PIN_BASE}:${lo}` : PIN_BASE; // PIN por seguimiento (soporta m√∫ltiples)
    }

    const status = $("#status"), last = $("#last"), preview = $("#preview");
    const btnSave = $("#btnSave"), btnLoad = $("#btnLoad"), chkAuto = $("#chkAuto");
    const lblProg = $("#lblProgreso"), rngProg = $("#progreso");
    const setStatus = s => status.textContent = s;
    const setLast   = s => last.textContent = s ? `Actualizado: ${s}` : "‚Äî";
    rngProg.addEventListener("input", ()=> lblProg.textContent = `${rngProg.value}%`);
    function toast(msg){ const t=document.createElement("div"); t.className="toast"; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1800); }

    /********** Estado **********/
    function getCloudElements(){ return [...document.querySelectorAll("[data-cloud]")]; }
    function readEl(el){
      if (el.tagName==="INPUT"){
        const t=(el.type||"text").toLowerCase();
        if (t==="checkbox") return !!el.checked;
        if (t==="radio") return el.checked ? el.value : null;
        return el.value;
      }
      if (el.tagName==="TEXTAREA"||el.tagName==="SELECT") return el.value;
      return el.textContent;
    }
    function writeEl(el,val){
      if (el.tagName==="INPUT"){
        const t=(el.type||"text").toLowerCase();
        if (t==="checkbox"){ el.checked=!!val; return; }
        if (t==="radio"){ el.checked=(val===el.value); return; }
        el.value=(val??"");
        el.dispatchEvent(new Event("input",{bubbles:true}));
        el.dispatchEvent(new Event("change",{bubbles:true}));
        return;
      }
      if (el.tagName==="TEXTAREA"||el.tagName==="SELECT"){
        el.value=(val??"");
        el.dispatchEvent(new Event("input",{bubbles:true}));
        el.dispatchEvent(new Event("change",{bubbles:true}));
        return;
      }
      if (typeof val==="string") el.textContent=val;
    }
    function collectState(){
      const s={}; getCloudElements().forEach((el,i)=>{ const k=el.id||el.name||`el_${i}`; const v=readEl(el); if(v!==null&&k) s[k]=v; });
      preview.textContent = JSON.stringify(s,null,2);
      return s;
    }
    function applyState(s){
      if(!s||typeof s!=="object") return;
      Object.keys(s).forEach(k=>{
        const el=document.getElementById(k)||document.querySelector(`[name="${CSS.escape(k)}"]`);
        if(el) writeEl(el,s[k]);
      });
      if (s?.progreso !== undefined) lblProg.textContent = `${s.progreso}%`;
      preview.textContent = JSON.stringify(s,null,2);
    }

    /********** Copia local **********/
    const saveBackup = (state,pin)=>{ try{ localStorage.setItem(`${BK_KEY}:${pin}`, JSON.stringify({when:Date.now(), state})); }catch{} };
    const loadBackup = (pin)=>{ try{ return JSON.parse(localStorage.getItem(`${BK_KEY}:${pin}`)||"null"); }catch{ return null; } };

    /********** Nube **********/
    async function saveToCloud(){
      try{
        const PIN = effectivePIN();
        setStatus("üíæ Guardando‚Ä¶");
        const ENDPOINT = getEndpoint();
        const state = collectState();
        const res = await fetch(ENDPOINT,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ action:"save", pin: PIN, state })
        });
        const json = await res.json().catch(()=>null);
        if(!res.ok||!json?.ok) throw new Error(json?.error||("HTTP "+res.status));
        setStatus("‚úÖ Guardado"); setLast(json.updatedAt); toast("Guardado en la nube"); saveBackup(state,PIN);
      }catch(e){ console.error(e); setStatus("‚ùå Error al guardar"); toast("Error al guardar"); }
    }
    async function loadFromCloud(){
      try{
        const PIN = effectivePIN();
        setStatus("‚¨áÔ∏è Cargando‚Ä¶");
        const u=new URL(getEndpoint()); u.searchParams.set("action","load"); u.searchParams.set("pin", PIN);
        const res=await fetch(u.toString(),{method:"GET"}); const json=await res.json().catch(()=>null);
        if(!res.ok||!json?.ok) throw new Error(json?.error||("HTTP "+res.status));
        applyState(json.state||{}); setStatus("‚úÖ Actualizado"); setLast(json.updatedAt); toast("Datos cargados");
      }catch(e){
        console.error(e); setStatus("‚ùå Error al cargar");
        const bk=loadBackup(effectivePIN()); if(bk?.state){ applyState(bk.state); toast("Restaurado desde copia local"); }
      }
    }

    /********** Auto-guardado + atajos **********/
    let autosaveTimer=null;
    function autoSaveTick(){ if(!chkAuto.checked) return; clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveToCloud,800); }
    function hookAutosave(){ getCloudElements().forEach(el=>["input","change","keyup","blur"].forEach(evt=>el.addEventListener(evt,autoSaveTick))); }
    document.addEventListener("keydown", e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="s"){ e.preventDefault(); saveToCloud(); } });
    // Cambiar LO cambia el "documento" (PIN efectivo)
    loInput.addEventListener("change", ()=>{ setLast("‚Äî"); loadFromCloud(); });

    /********** Arranque **********/
    (function persistEndpointQS(){ const ep=qs("endpoint"); if(ep){ try{ new URL(ep); localStorage.setItem(CFG_KEY, JSON.stringify(ep)); }catch{} } })();
    hookAutosave(); loadFromCloud();
  </script>
</body>
</html>
