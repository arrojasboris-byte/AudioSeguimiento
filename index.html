<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n Audio - Dashboard General</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #050816;
      --bg-sidebar: #020617;
      --bg-card: #0f172a;
      --bg-card-soft: #111827;
      --accent: #ef4444;
      --accent-soft: #fecaca;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --radius-xl: 18px;
      --shadow-soft: 0 14px 30px rgba(0,0,0,.45);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }

    body {
      background: radial-gradient(circle at top left, #1f2937, #020617 45%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
    }

    body.light-theme {
      --bg: #f3f4f6; --bg-sidebar: #000000; --bg-card: #ffffff; --bg-card-soft: #e5e7eb;
      --text-main: #111827; --text-muted: #6b7280; --border-soft: #d1d5db;
      background: #f3f4f6; color: var(--text-main);
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-soft);
      padding: 20px 18px;
      display: flex; flex-direction: column; gap: 18px;
      flex-shrink: 0;
    }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon {
      width: 40px; height: 40px; border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fecaca, #b91c1c);
      display: flex; align-items: center; justify-content: center; font-size: 1.4rem; color: #fef2f2;
    }
    .logo-title { font-weight: 800; font-size: 1.05rem; }
    .logo-title-gestion { color: #f97316; }
    .logo-title-audio { color: #38bdf8; }
    .logo-subtitle { font-size: .7rem; color: var(--text-muted); }
    
    .side-nav { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
    .side-nav-item {
      width: 100%; text-align: left; background: transparent;
      border-radius: 999px; border: 1px solid rgba(148,163,184,0.6);
      padding: 7px 10px; font-size: .8rem; color: var(--text-muted);
      cursor: pointer; display: flex; align-items: center; gap: 8px;
      transition: all .15s ease;
    }
    .side-nav-item:hover { background: rgba(15,23,42,0.75); color: #e5e7eb; }
    .side-nav-item.active { background: rgba(239,68,68,0.1); border-color: #ef4444; color: #fef2f2; }
    .sidebar-footer { margin-top: auto; font-size: .7rem; color: var(--text-muted); }

    /* Main */
    .main { flex: 1; padding: 18px 22px; display: flex; flex-direction: column; gap: 18px; overflow-x: hidden; }

    .topbar { display: flex; align-items: center; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
    .btn {
      border-radius: 999px; padding: 6px 12px; border: 1px solid #ef4444;
      font-size: .78rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
      background: #ef4444; color: #fef2f2; transition: transform .08s ease;
    }
    .btn:hover { transform: translateY(-1px); background: #dc2626; }

    /* Cards & Layout */
    .card {
      background: var(--bg-card-soft);
      border-radius: var(--radius-xl); padding: 14px;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft); position: relative;
    }
    .card h3 { font-size: .9rem; margin-bottom: 4px; }
    .card-sub { font-size: .76rem; color: var(--text-muted); margin-bottom: 10px; }
    
    .grid-main { display: grid; grid-template-columns: 2fr 1.4fr; gap: 16px; margin-top: 8px; }
    .grid-bottom { margin-top: 16px; display: grid; grid-template-columns: 1.4fr 1.6fr; gap: 16px; }
    
    .chart-container { position: relative; height: 230px; width: 100%; }
    .chart-container.tall { height: 260px; }

    /* KPI Pills */
    .kpi-row { display: flex; gap: 8px; margin-top: 10px; overflow-x: auto; padding-bottom: 4px; }
    .kpi-pill {
      display: flex; align-items: center; justify-content: space-between; gap: 6px;
      padding: 5px 10px; border-radius: 999px; font-size: .76rem;
      border: 1px solid #b91c1c; background: #ef4444; color: #fef2f2;
      min-width: 140px; flex-shrink: 0;
    }
    .kpi-status {
      width: 18px; height: 18px; border-radius: 999px; display: flex;
      align-items: center; justify-content: center; background: rgba(0,0,0,0.2);
    }

    /* Vistas */
    .view { display: none; }
    .view.active { display: block; }

    /* Inputs y Formularios */
    .visit-layout { display: grid; grid-template-columns: 1.2fr 1.6fr; gap: 12px; margin-top: 10px; }
    .visit-meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    
    .visit-field { display: flex; flex-direction: column; gap: 3px; margin-bottom: 6px; }
    .visit-label { font-size: .72rem; color: var(--text-muted); }
    .visit-input, .visit-select, .visit-textarea {
      background: var(--bg-sidebar); border-radius: 10px; border: 1px solid var(--border-soft);
      padding: 5px 8px; font-size: .78rem; color: var(--text-main); outline: none; width: 100%;
    }
    body.light-theme .visit-input { background: #fff; }

    /* Scrollable Tables (Centros) */
    .table-scroll-container {
      width: 100%; overflow-x: auto; border-radius: 8px;
      border: 1px solid var(--border-soft); background: rgba(0,0,0,0.2);
      max-height: 200px;
    }
    .data-table { width: 100%; border-collapse: collapse; font-size: .75rem; white-space: nowrap; }
    .data-table th, .data-table td { padding: 6px 10px; border-bottom: 1px solid var(--border-soft); text-align: left; }
    .data-table th { background: rgba(255,255,255,0.05); font-weight: 600; position: sticky; top: 0; }

    /* Images Grid */
    .images-grid { margin-top: 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .image-slot {
      border-radius: 14px; border: 1px dashed rgba(148,163,184,0.8);
      padding: 10px; font-size: .74rem; text-align: center;
      display: flex; flex-direction: column; align-items: center;
    }
    .image-preview {
      width: 100%; height: 100px; object-fit: cover; margin-top: 5px;
      border-radius: 6px; display: none; border: 1px solid var(--border-soft);
    }
    .image-preview.visible { display: block; }

    /* Check Interno & Observaciones */
    .visit-bottom-grid { margin-top: 12px; display: grid; grid-template-columns: 1.4fr 1.6fr; gap: 12px; }
    .check-groups { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: .76rem; max-height: 260px; overflow-y: auto; }
    .check-list { list-style: none; display: flex; flex-direction: column; gap: 2px; }
    .check-list li { display: flex; align-items: center; gap: 4px; }
    .observaciones-area { height: 100%; min-height: 150px; resize: none; }

    /* Chart Boxes Informe */
    .visit-charts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 14px; }
    .chart-box { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 8px; border: 1px solid var(--border-soft); }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none;
      align-items: center; justify-content: center; z-index: 9999;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: var(--bg-sidebar); padding: 20px; border-radius: 16px; width: 320px;
      border: 1px solid var(--border-soft);
    }

    /* --- ESTILOS DE IMPRESI√ìN (A4) --- */
    @media print {
      @page { size: A4; margin: 5mm; }
      body {
        background: white !important; color: black !important;
        display: block !important; height: auto !important;
      }
      .sidebar, .topbar, .no-print, .btn, .kpi-row::-webkit-scrollbar { display: none !important; }
      .main { padding: 0 !important; overflow: visible !important; }
      
      /* Ajustes generales de impresi√≥n */
      .card {
        border: 1px solid #ccc !important; box-shadow: none !important;
        background: white !important; color: black !important;
        break-inside: avoid; margin-bottom: 10px;
        padding: 8px !important;
      }
      h2, h3, h4, span, div, p { color: black !important; }
      
      /* Forzar una sola p√°gina por vista si es posible */
      .view { display: none !important; }
      .view.active { display: block !important; }
      
      /* Ajuste Dashboard */
      #view-dashboard .grid-main { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      #view-dashboard .chart-container { height: 180px !important; }
      
      /* Ajuste Informe (Gestor de Visitas) */
      #view-informes .visit-planning-grid { display: none; } /* Ocultar calendario al imprimir informe */
      #informeVisitasSection { display: block !important; border: none !important; }
      .visit-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .visit-charts-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
      .chart-box { border: 1px solid #ddd; }
      .images-grid { grid-template-columns: 1fr 1fr 1fr; }
      .image-preview { height: 80px; border: 1px solid #ccc; }
      .visit-bottom-grid { display: grid; grid-template-columns: 1fr 1fr; page-break-inside: avoid; }
      .check-groups { max-height: none; overflow: visible; }
      
      /* Texto inputs al imprimir */
      input, select, textarea {
        border: none !important; background: transparent !important;
        font-weight: bold; padding: 0 !important; color: black !important;
        resize: none;
      }
    }
  </style>
</head>
<body>

  <aside class="sidebar no-print">
    <div class="logo">
      <div class="logo-icon">üéß</div>
      <div class="logo-text">
        <div class="logo-title"><span class="logo-title-gestion">Gesti√≥n</span><span class="logo-title-audio"> Audio</span></div>
        <span class="logo-subtitle">Plataforma de seguimiento</span>
      </div>
    </div>
    <nav class="side-nav">
      <button class="side-nav-item active" onclick="cambiarVista('dashboard')">üìä Dashboard General</button>
      <button class="side-nav-item" onclick="cambiarVista('informes')">üóÇÔ∏è Gestor de Visitas</button>
    </nav>
    <div class="sidebar-footer">
      <p>Versi√≥n editada ¬∑ Persistencia activada</p>
    </div>
  </aside>

  <main class="main">
    <div class="topbar no-print">
      <button class="btn" onclick="toggleTheme()">‚òÄÔ∏è Tema</button>
      <button class="btn" onclick="window.print()">üñ®Ô∏è Imprimir</button>
      <button class="btn" onclick="exportarHTML()">‚¨áÔ∏è Guardar Todo (HTML)</button>
    </div>

    <section id="view-dashboard" class="view active">
      <div class="section-header">
        <h2>Dashboard General</h2>
        <span class="sub" style="font-size:0.8rem; color:var(--text-muted)">Resumen de KPIs y procesos globales.</span>
      </div>

      <div class="kpi-row">
        <div class="kpi-pill"><span>% Procesos</span><strong>92%</strong><div class="kpi-status">üü¢</div></div>
        <div class="kpi-pill"><span>HIT Global</span><strong>100%</strong><div class="kpi-status">üü¢</div></div>
        <div class="kpi-pill"><span>1¬∫ Auxilios</span><strong>63%</strong><div class="kpi-status">üî¥</div></div>
        <div class="kpi-pill"><span>Conv. Prueba</span><strong>72%</strong><div class="kpi-status">üü°</div></div>
        <div class="kpi-pill"><span>Conv. Venta</span><strong>81%</strong><div class="kpi-status">üü¢</div></div>
      </div>

      <section class="grid-main">
        <article class="card">
          <h3>Evoluci√≥n mensual</h3>
          <div class="chart-container"><canvas id="chartEvolucion"></canvas></div>
        </article>
        <article class="card">
          <h3>Estado de visitas</h3>
          <div class="chart-container"><canvas id="chartVisitas"></canvas></div>
        </article>
      </section>

      <section class="grid-main" style="grid-template-columns:1fr 1fr;">
        <article class="card">
          <h3>√Årea de mejora</h3>
          <div class="chart-container"><canvas id="chartAreaMejora"></canvas></div>
        </article>
        <article class="card">
          <h3>Ranking Delegados</h3>
          <div class="chart-container"><canvas id="chartDelegados"></canvas></div>
        </article>
      </section>
    </section>

    <section id="view-informes" class="view">
      <h2>Gestor de Visitas e Informes</h2>

      <section class="visit-planning-grid no-print" style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
        <article class="card">
          <h3>Visitas Pendientes</h3>
          <div id="listaVisitasPendientes" style="margin-top:10px; font-size:.8rem;">
            <div style="padding:6px; background:rgba(255,255,255,0.05); border-radius:6px; margin-bottom:4px;">
              07/12/2025 - Madrid Tetu√°n <button class="btn" style="float:right; transform:scale(0.8);" onclick="cargarInformeDemo()">Crear</button>
            </div>
          </div>
          <button class="btn" style="margin-top:10px;" onclick="abrirModalVisita()">+ Agendar Visita</button>
        </article>

        <article class="card">
          <h3>Carga de Centros (Excel)</h3>
          <p class="card-sub">Adjunta el Excel para ver todos los datos con scroll horizontal.</p>
          <input type="file" id="inputExcelCentros" class="visit-input" style="margin-bottom:8px;">
          
          <div class="table-scroll-container">
            <table class="data-table" id="tablaCentros">
              <thead><tr><th>Nombre Centro</th><th>Ciudad</th><th>Tipo</th><th>Delegado</th></tr></thead>
              <tbody>
                <tr><td>Madrid ¬∑ Reina Mercedes</td><td>Madrid</td><td>Corner</td><td>Blanca</td></tr>
                <tr><td>Sevilla ¬∑ Nervi√≥n</td><td>Sevilla</td><td>Exclusivo</td><td>Luis</td></tr>
              </tbody>
            </table>
          </div>
        </article>
      </section>

      <article class="card" id="informeVisitasSection">
        <h3 style="border-bottom:1px solid var(--border-soft); padding-bottom:8px; margin-bottom:10px;">Informe de Visita</h3>

        <div class="visit-layout">
          <div>
            <div class="visit-meta-grid">
              <div class="visit-field">
                <span class="visit-label">Centro</span>
                <input id="infCentro" class="visit-input" placeholder="Ej: Madrid Tetu√°n">
              </div>
              <div class="visit-field">
                <span class="visit-label">Delegado</span>
                <input id="infDelegado" class="visit-input" placeholder="Nombre">
              </div>
            </div>
            <div class="visit-meta-grid" style="margin-top:6px;">
              <div class="visit-field">
                <span class="visit-label">Responsable Audio</span>
                <input id="infResp" class="visit-input">
              </div>
              <div class="visit-field">
                <span class="visit-label">Fecha Visita</span>
                <input type="date" id="infFecha" class="visit-input">
              </div>
            </div>
            <div class="visit-meta-grid" style="margin-top:6px;">
              <div class="visit-field">
                <span class="visit-label">Audi√≥logo</span>
                <input id="infAudiologo" class="visit-input" placeholder="Nombre Audi√≥logo">
              </div>
              <div class="visit-field">
                <span class="visit-label">Horas de servicio</span>
                <input id="infHoras" class="visit-input" placeholder="Ej: 40h">
              </div>
            </div>
          </div>

          <div>
            <div class="visit-meta-grid">
              <div class="visit-field">
                <span class="visit-label">Tipo de Centro (Afecta l√≥gica)</span>
                <select id="infTipoCentro" class="visit-select">
                  <option value="CORNER">CORNER</option>
                  <option value="EXCLUSIVO">EXCLUSIVO</option>
                </select>
              </div>
              <div class="visit-field">
                <span class="visit-label">Centro AAR</span>
                <select id="infAAR" class="visit-select">
                  <option value="No">No</option>
                  <option value="Si">S√≠</option>
                </select>
              </div>
            </div>
            <div class="visit-field" style="margin-top:12px; background: rgba(239,68,68,0.1); padding:10px; border-radius:10px; border:1px solid var(--accent);">
              <span class="visit-label" style="color:#ef4444; font-weight:bold;">Adjuntar Checklist (Excel) para c√°lculo autom√°tico</span>
              <input type="file" id="inputChecklistExcel" class="visit-input" accept=".xlsx, .xls">
              <small style="font-size:0.65rem; display:block; margin-top:4px;">
                * Corner: Lee B7-B88. * Exclusivo: Lee B8-B102.
              </small>
            </div>
          </div>
        </div>

        <div class="visit-charts-grid">
          <div class="chart-box">
            <h4>Resultados (Radar)</h4>
            <div class="chart-container" style="height:150px;"><canvas id="chartRadarInforme"></canvas></div>
          </div>
          <div class="chart-box">
            <h4>√Åreas Mejora</h4>
            <div class="chart-container" style="height:150px;"><canvas id="chartAreaInforme"></canvas></div>
          </div>
          <div class="chart-box">
            <h4>KPIs Calculados</h4>
            <div class="chart-container" style="height:150px;"><canvas id="chartKpiInforme"></canvas></div>
          </div>
        </div>

        <div class="images-grid">
          <div class="image-slot">
            <strong>Imagen 1</strong>
            <input type="file" onchange="previewImage(this, 'img1')">
            <img id="img1" class="image-preview" alt="Vista previa 1">
          </div>
          <div class="image-slot">
            <strong>Imagen 2</strong>
            <input type="file" onchange="previewImage(this, 'img2')">
            <img id="img2" class="image-preview" alt="Vista previa 2">
          </div>
          <div class="image-slot">
            <strong>Imagen 3</strong>
            <input type="file" onchange="previewImage(this, 'img3')">
            <img id="img3" class="image-preview" alt="Vista previa 3">
          </div>
        </div>

        <div class="visit-bottom-grid">
          <article class="card" style="border:none; box-shadow:none; padding:0; background:transparent;">
            <h3>Check Interno</h3>
            <p class="card-sub">Validaci√≥n manual de elementos visuales y formaci√≥n.</p>
            <div class="check-groups" style="background:var(--bg-card); padding:10px; border-radius:10px; border:1px solid var(--border-soft);">
              <div>
                <strong>Formaci√≥n</strong>
                <ul class="check-list">
                  <li><input type="checkbox"> WSA</li>
                  <li><input type="checkbox"> Starkey</li>
                  <li><input type="checkbox"> HIT</li>
                  <li><input type="checkbox"> Telecare</li>
                  <li><input type="checkbox"> Financiaci√≥n</li>
                </ul>
              </div>
              <div>
                <strong>Marketing/Visual</strong>
                <ul class="check-list">
                  <li><input type="checkbox"> Audiometr√≠a RT</li>
                  <li><input type="checkbox"> Escaparate</li>
                  <li><input type="checkbox"> Manteleta</li>
                  <li><input type="checkbox"> Stock</li>
                </ul>
              </div>
            </div>
          </article>

          <article class="card" style="border:none; box-shadow:none; padding:0; background:transparent;">
            <h3>Observaciones y Compromisos</h3>
            <textarea id="infObs" class="visit-textarea observaciones-area" placeholder="Escribir conclusiones..."></textarea>
          </article>
        </div>
      </article>
    </section>
  </main>

  <div id="modalVisita" class="modal-overlay">
    <div class="modal-content">
      <h3>Nueva Visita</h3>
      <input class="visit-input" style="margin-bottom:8px;" placeholder="Centro">
      <input type="date" class="visit-input" style="margin-bottom:8px;">
      <div style="display:flex; justify-content:flex-end; gap:8px;">
        <button class="btn" style="background:transparent; border-color:#888;" onclick="document.getElementById('modalVisita').classList.remove('active')">Cancelar</button>
        <button class="btn" onclick="document.getElementById('modalVisita').classList.remove('active')">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // --- ESTADO INICIAL (Para persistencia) ---
    // Variables globales que guardaremos al exportar
    let savedState = {
      visitasPendientes: [],
      historialInformes: [],
      config: { theme: 'dark' }
    };

    // --- 1. L√ìGICA DE EXCEL (CHECKLIST) ---
    document.getElementById('inputChecklistExcel').addEventListener('change', handleChecklistFile);

    function handleChecklistFile(e) {
      const file = e.target.files[0];
      const tipoCentro = document.getElementById('infTipoCentro').value; // CORNER o EXCLUSIVO

      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

        // Helper para leer celda con seguridad
        const getVal = (cell) => {
            const v = firstSheet[cell];
            return v ? (v.v === undefined ? 0 : v.v) : 0;
        };

        // VARIABLES DE RESULTADO
        let percentProcesos = 0;
        let percentHIT = 0; // Si aplica o %
        let convPrueba = 0;
        let convVenta = 0;
        let aplicaHIT_Text = "No"; 

        if (tipoCentro === "CORNER") {
            // L√≥gica CORNER
            // Rango B7-B88 (Criterios) y F7-F88 (Resultados 0/1) - Solo leemos resultados clave
            percentProcesos = getVal('F90') * 100; // Asumiendo que el excel trae 0.9 para 90%
            // HIT F63 (Aplica HIT? 0/1 o dato)
            let valHit = getVal('F63');
            aplicaHIT_Text = valHit == 1 ? "S√≠" : "No";
            
            convPrueba = getVal('B92') * 100;
            convVenta = getVal('B93') * 100;

        } else {
            // L√≥gica EXCLUSIVO
            // Rango B8-B102 y F8-F102
            percentProcesos = getVal('F104') * 100;
            
            // HIT F65
            let valHit = getVal('F65');
            aplicaHIT_Text = valHit == 1 ? "S√≠" : "No";

            convPrueba = getVal('I126') * 100;
            convVenta = getVal('I127') * 100;
        }

        // Formatear valores
        percentProcesos = parseFloat(percentProcesos).toFixed(1);
        convPrueba = parseFloat(convPrueba).toFixed(1);
        convVenta = parseFloat(convVenta).toFixed(1);

        alert(`Datos Extra√≠dos (${tipoCentro}):\n% Procesos: ${percentProcesos}%\nConv. Prueba: ${convPrueba}%\nConv. Venta: ${convVenta}%\nAplica HIT: ${aplicaHIT_Text}`);

        // ACTUALIZAR GR√ÅFICOS DEL INFORME
        updateReportCharts(percentProcesos, convPrueba, convVenta);
      };
      reader.readAsArrayBuffer(file);
    }

    function updateReportCharts(procesos, prueba, venta) {
        // Actualizar Radar
        chartRadar.data.datasets[0].data = [procesos, venta, prueba, 85];
        chartRadar.update();
        
        // Actualizar KPI Barras
        chartKpis.data.datasets[0].data = [procesos, venta, prueba, 60, 70, 80];
        chartKpis.update();
    }

    // --- 2. L√ìGICA DE CENTROS (TABLA SCROLL) ---
    document.getElementById('inputExcelCentros').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, {header:1}); // Array de arrays

        // Generar tabla HTML
        let html = '<thead><tr>';
        // Cabeceras (Fila 0)
        if(json.length > 0) {
            json[0].forEach(head => html += `<th>${head}</th>`);
            html += '</tr></thead><tbody>';
            // Datos
            for(let i=1; i<json.length; i++) {
                html += '<tr>';
                json[i].forEach(cell => html += `<td>${cell || ''}</td>`);
                html += '</tr>';
            }
            html += '</tbody>';
            document.getElementById('tablaCentros').innerHTML = html;
        }
      };
      reader.readAsArrayBuffer(file);
    });

    // --- 3. PREVISUALIZACI√ìN DE IM√ÅGENES ---
    function previewImage(input, imgId) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(imgId);
                img.src = e.target.result;
                img.classList.add('visible');
            }
            reader.readAsDataURL(file);
        }
    }

    // --- 4. PERSISTENCIA (GUARDAR HTML CON DATOS) ---
    function exportarHTML() {
      // 1. Capturar el estado actual de los inputs del informe por si acaso
      const inputs = document.querySelectorAll('input, select, textarea');
      inputs.forEach(el => el.setAttribute('value', el.value)); // Para que se quede en el HTML

      // 2. Serializar el contenido
      const htmlContent = document.documentElement.outerHTML;
      
      // 3. Crear descarga
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'gestion-audio-dashboard-GUARDADO.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      alert("Archivo guardado. √Åbrelo en cualquier PC y mantendr√° este contenido.");
    }

    // --- UTILIDADES UI ---
    function cambiarVista(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
        document.querySelectorAll('.side-nav-item').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    function toggleTheme() {
        document.body.classList.toggle('light-theme');
    }
    
    function abrirModalVisita() {
        document.getElementById('modalVisita').classList.add('active');
    }
    
    function cargarInformeDemo() {
        document.getElementById('infCentro').value = "Madrid ¬∑ Tetu√°n";
        document.getElementById('infDelegado').value = "Blanca";
        document.getElementById('infTipoCentro').value = "CORNER";
        cambiarVista('informes');
        // Scroll hacia abajo
        document.getElementById('informeVisitasSection').scrollIntoView({behavior:'smooth'});
    }

    // --- INICIALIZACI√ìN DE GR√ÅFICOS (Chart.js) ---
    // Dashboard Main Charts (Demo data)
    new Chart(document.getElementById('chartEvolucion'), {
        type: 'line',
        data: {
            labels: ['Ene','Feb','Mar','Abr','May','Jun'],
            datasets: [{label: 'Procesos', data: [80,82,81,85,88,92], borderColor: '#ef4444', tension:0.3}]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
    
    new Chart(document.getElementById('chartVisitas'), {
        type: 'doughnut',
        data: { labels: ['Realizadas','Pendientes'], datasets: [{ data: [80, 20], backgroundColor: ['#3b82f6','#fbbf24'] }] },
        options: { responsive: true, maintainAspectRatio: false }
    });

    new Chart(document.getElementById('chartAreaMejora'), {
        type: 'bar',
        data: { labels: ['Financiaci√≥n','Seguimiento','MGM'], datasets: [{ label:'% Fallo', data: [30, 25, 20], backgroundColor: '#ef4444' }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
    });

    new Chart(document.getElementById('chartDelegados'), {
        type: 'bar',
        data: { labels: ['Blanca','Luis','Ana'], datasets: [{ label:'Score', data: [95, 88, 92], backgroundColor: '#3b82f6' }] },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // Informe Charts (Variables)
    const chartRadar = new Chart(document.getElementById('chartRadarInforme'), {
        type: 'radar',
        data: {
            labels: ['Procesos', 'Venta', 'Prueba', 'Formaci√≥n'],
            datasets: [{ label: 'Visita Actual', data: [0,0,0,0], borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.2)' }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { r: { suggestedMax: 100 } } }
    });

    const chartKpis = new Chart(document.getElementById('chartKpiInforme'), {
        type: 'bar',
        data: {
            labels: ['Procesos', 'Venta', 'Prueba', 'HIT', 'Infinity', 'Stock'],
            datasets: [{ label: 'Valores %', data: [0,0,0,0,0,0], backgroundColor: ['#ef4444','#3b82f6','#fbbf24','#10b981','#8b5cf6','#6b7280'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { suggestedMax: 100 } } }
    });
    
    new Chart(document.getElementById('chartAreaInforme'), {
        type: 'bar',
        data: { labels: ['Seguimiento', 'Folleto'], datasets: [{ label:'% No Aplica', data: [40, 30], backgroundColor: '#ef4444' }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
    });

  </script>
</body>
</html>
