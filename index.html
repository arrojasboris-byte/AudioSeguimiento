<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AUDIOLOGIA-SEGUIMIENTO</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#eef1f5; --card:#ffffff; --ink:#1f2937; --muted:#6b7280;
    --accent:#dc2626; --accent-2:#0ea5e9; --ok:#16a34a; --line:#e5e7eb;
    --chip:#f8fafc; --shadow:0 12px 22px rgba(0,0,0,.06); --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(150deg,#f4f6f9 0%,#edf1f7 100%);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink)}
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  .bar{background:var(--card);border-left:5px solid var(--accent);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-radius:14px;box-shadow:var(--shadow)}
  .brand{display:flex;align-items:center;gap:14px}
  .logo{width:190px;height:56px;background:#fff url('https://upload.wikimedia.org/wikipedia/commons/1/1c/Alain_Afflelou_logo.png') center/contain no-repeat;border-radius:10px;border:1px solid var(--line)}
  h1{margin:0;font-weight:800;letter-spacing:.4px}
  .sub{font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:10px}
  .icon{width:46px;height:46px;border-radius:12px;border:1px solid var(--line);background:#101827;display:grid;place-items:center;color:#fff;cursor:pointer;box-shadow:var(--shadow)}
  .icon.blue{background:#2563eb}.icon.red{background:#dc2626}
  .icon img{width:22px;height:22px;opacity:.95}
  .search{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px 14px;display:flex;align-items:center;gap:10px;margin:16px 0;box-shadow:var(--shadow)}
  .search input{border:0;outline:0;width:100%;background:transparent;font-size:16px;color:var(--ink)}
  .grid{display:grid;grid-template-columns:380px 1fr;gap:16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
  /* columnas izquierda */
  .sec{border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
  .sec header{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .sec-title{display:flex;align-items:center;gap:10px}
  .badge{background:#f3f4f6;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px}
  .chip{color:#dc2626;font-weight:700;cursor:pointer}
  .sec-tools{display:flex;gap:6px}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:7px 10px;font-weight:600;cursor:pointer}
  .btn.add{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
  .btn.del{background:#ef4444;border-color:#ef4444;color:#fff}
  .list{margin-top:10px;display:none}
  .list.show{display:block}
  .item{display:flex;align-items:center;justify-content:space-between;border:1px dashed var(--line);border-radius:12px;padding:8px 10px;margin-bottom:8px}
  .tiny{font-size:12px;color:var(--muted)}
  .item-tools{display:flex;gap:6px;align-items:center}
  .tag{font-size:12px;background:#fff;border:1px solid var(--line);padding:4px 8px;border-radius:999px;color:#334155}
  .tag.sel{background:#dcfce7;border-color:#22c55e}
  /* derecha */
  .panel .head{display:flex;align-items:center;justify-content:space-between}
  .title{font-weight:800;font-size:24px}
  .fold{border:1px solid var(--line);border-radius:12px;margin-top:12px}
  .fold summary{list-style:none;cursor:pointer;padding:14px 16px;font-weight:700;border-radius:12px}
  .fold[open] summary{background:#f9fafb}
  .fold .inner{padding:12px 16px;border-top:1px solid var(--line)}
  .row{display:grid;grid-template-columns:110px 1fr 90px 90px 1fr 36px;gap:8px;align-items:center;margin-bottom:6px}
  .row input,.row select{width:100%;border:1px solid var(--line);border-radius:9px;padding:7px 8px}
  .row .x{color:#ef4444;font-weight:700;cursor:pointer;text-align:center}
  .note{font-size:12px;color:var(--muted);margin-top:6px}
  @media (max-width:1000px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div class="brand">
      <div id="logo" class="logo" title="Click para cambiar logo"></div>
      <div>
        <div class="sub">Plataforma</div>
        <h1>AUDIOLOGIA-SEGUIMIENTO</h1>
      </div>
    </div>
    <div class="actions">
      <div class="icon" id="btnLogo" title="Cambiar logo"><img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons/icons/photo.svg" alt=""></div>
      <div class="icon" id="btnLock" title="Modo edici√≥n (PIN)"><img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons/icons/lock.svg" alt=""></div>
      <div class="icon red" id="btnCloud" title="Guardar en la nube"><img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons/icons/cloud-upload.svg" alt=""></div>
      <div class="icon blue" id="btnBackup" title="Backup (descargar/subir json)"><img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons/icons/device-floppy.svg" alt=""></div>
      <div class="icon" id="btnCloudLoad" title="Cargar desde nube"><img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons/icons/cloud-download.svg" alt=""></div>
      <div class="icon" id="btnSettings" title="Configurar nube (token/gist)"><img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons/icons/settings.svg" alt=""></div>
    </div>
  </div>

  <div class="search">
    <img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons/icons/search.svg" width="18" height="18" alt="">
    <input id="q" placeholder="Buscar en secciones, centros y datos‚Ä¶">
  </div>

  <div class="grid">
    <!-- IZQUIERDA -->
    <div class="card" id="left"></div>

    <!-- DERECHA -->
    <div class="card panel">
      <div class="head">
        <div class="title">Procedimientos ‚Äî <span id="currentItem">-</span></div>
      </div>

      <details class="fold" open>
        <summary>Acciones - Resultado</summary>
        <div class="inner" id="accionesBox"></div>
        <div style="padding:12px 16px">
          <button class="btn" id="addAccion">+ Acci√≥n</button>
        </div>
      </details>

      <details class="fold">
        <summary>Formaci√≥n continua</summary>
        <div class="inner" id="formacionBox"></div>
        <div style="padding:12px 16px">
          <button class="btn" id="addFormacion">+ Registro</button>
        </div>
      </details>

      <details class="fold">
        <summary>Procesos y paquetes personalizados</summary>
        <div class="inner" id="procesosBox"></div>
        <div style="padding:12px 16px">
          <button class="btn" id="addProceso">+ Proceso</button>
        </div>
      </details>

      <div class="note">Modo edici√≥n con PIN <code>AR4321</code> (üîí). ‚ÄúGuardar en la nube‚Äù usa <b>GitHub Gist privado</b>.</div>
    </div>
  </div>
</div>

<script>
/* Utilidades */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = () => Date.now()+Math.random().toString(16).slice(2);

/* Estado */
let editMode = false;
let state = {
  logo:"",
  selected:{ sectionId:null, itemId:null },
  sections:[
    { id:'centros_exclusivos', title:'Centros exclusivos', type:'centros', open:true, items:[
      { id:1, nombre:'Reina Mercedes', delegado:'Ana Mart√≠nez', audiologo:'Dr. Garc√≠a', tipo:'Franquicia' },
      { id:2, nombre:'Barcelona Centro', delegado:'Carlos Ruiz', audiologo:'Dra. L√≥pez', tipo:'Sucursal' }
    ]},
    { id:'centros_flop', title:'Centros flop', type:'centros', open:false, items:[] },
    { id:'formacion_mentoring', title:'Formaciones ‚Äì Mentoring', type:'formaciones', open:false, items:[] },
    { id:'visitas', title:'Visitas a centros', type:'visitas', open:false, items:[] }
  ],
  // Procedimientos por clave "sectionId:itemId"
  dataByKey:{}
};

/* Persistencia local */
function localSave(){ localStorage.setItem('audiologia_state_v2', JSON.stringify(state)); }
function localLoad(){ const r=localStorage.getItem('audiologia_state_v2'); if(r){try{state=JSON.parse(r);}catch{}} }

/* Helpers de datos */
const keyFor = (sectionId,itemId)=> `${sectionId}:${itemId}`;
function ensureData(sectionId,itemId){
  const k = keyFor(sectionId,itemId);
  if(!state.dataByKey[k]){
    state.dataByKey[k] = {
      acciones:[{id:1,fecha:'',accion:'',derivacion:0,cita:0,obs:''}],
      formaciones:[{id:1,fecha:'',asistencia:'',titulo:'',aplicacion:''}],
      procesos:[{id:1,nombre:'',descripcion:'',puntuacion:'',observaciones:'',fecha:''}]
    };
  }
}
function displayName(section, item){
  if(section.type==='centros') return item.nombre;
  if(section.type==='formaciones') return item.titulo||'(formaci√≥n)';
  if(section.type==='visitas') return item.objetivo||'(visita)';
  return item.nombre||item.titulo||'(item)';
}

/* Render izquierda */
function renderLeft(){
  const left = $('#left'); left.innerHTML='';
  state.sections.forEach(sec=>{
    const box = document.createElement('div'); box.className='sec';
    const header = document.createElement('header');

    const t = document.createElement('div'); t.className='sec-title';
    const h = document.createElement('h3'); h.style.margin='0'; h.textContent = sec.title;
    const badge = document.createElement('span'); badge.className='badge'; badge.textContent = sec.items.length;
    t.append(h,badge);

    const actions = document.createElement('div'); actions.className='sec-tools';
    const toggle = document.createElement('span'); toggle.className='chip'; toggle.textContent = sec.open?'Ocultar':'Mostrar';
    toggle.addEventListener('click',()=>{sec.open=!sec.open;localSave();renderLeft();});
    const add = document.createElement('button'); add.className='btn add'; add.textContent=' + A√±adir';
    add.addEventListener('click',()=>addItemToSection(sec));
    actions.append(toggle, add);

    header.append(t,actions);
    box.appendChild(header);

    const list = document.createElement('div'); list.className='list'+(sec.open?' show':'');
    sec.items.forEach(it=>{
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `
        <div>
          <div><b>${displayName(sec,it)}</b></div>
          <div class="tiny">
            ${sec.type==='centros'
              ? `üë§ ${it.delegado||'-'} ¬∑ üéß ${it.audiologo||'-'} ¬∑ ${it.tipo||'-'}`
              : (sec.type==='formaciones'
                  ? `${it.ciclo||'-'} ¬∑ ${it.grupo||'-'}`
                  : (sec.fecha?`üìÖ ${it.fecha}`:'')
                )
            }
          </div>
        </div>
        <div class="item-tools">
          <span class="tag ${state.selected.sectionId===sec.id && state.selected.itemId===it.id?'sel':''}">Seleccionar</span>
          ${editMode?'<button class="btn">Editar</button><button class="btn del">Eliminar</button>':''}
        </div>
      `;
      // seleccionar
      row.querySelector('.tag').addEventListener('click',()=>{
        state.selected={sectionId:sec.id,itemId:it.id};
        ensureData(sec.id,it.id); localSave(); renderRight(); renderLeft();
      });
      if(editMode){
        const [editBtn, delBtn] = row.querySelectorAll('button');
        editBtn.addEventListener('click',()=>{
          if(sec.type==='centros'){
            const nombre = prompt('Nombre', it.nombre||'') ?? it.nombre;
            const delegado = prompt('Delegado', it.delegado||'') ?? it.delegado;
            const aud = prompt('Audi√≥logo', it.audiologo||'') ?? it.audiologo;
            const tipo = prompt('Tipo (Franquicia/Sucursal)', it.tipo||'') ?? it.tipo;
            Object.assign(it,{nombre,delegado,audiologo:aud,tipo});
          }else if(sec.type==='formaciones'){
            const titulo = prompt('T√≠tulo del grupo', it.titulo||'') ?? it.titulo;
            const ciclo = prompt('Ciclo (mensual/trimestral/‚Ä¶)', it.ciclo||'') ?? it.ciclo;
            const grupo = prompt('Grupo/Delegado', it.grupo||'') ?? it.grupo;
            Object.assign(it,{titulo,ciclo,grupo});
          }else if(sec.type==='visitas'){
            const fecha = prompt('Fecha', it.fecha||new Date().toISOString().slice(0,10)) ?? it.fecha;
            const objetivo = prompt('Objetivo', it.objetivo||'') ?? it.objetivo;
            Object.assign(it,{fecha,objetivo});
          }
          localSave(); renderLeft();
        });
        delBtn.addEventListener('click',()=>{
          if(confirm('¬øEliminar elemento?')){
            sec.items=sec.items.filter(x=>x.id!==it.id);
            if(state.selected.sectionId===sec.id && state.selected.itemId===it.id){
              state.selected={sectionId:null,itemId:null};
            }
            localSave(); renderLeft(); renderRight();
          }
        });
      }
      list.appendChild(row);
    });
    box.appendChild(list);
    left.appendChild(box);
  });
}
function addItemToSection(sec){
  if(sec.type==='centros'){
    const nombre = prompt('Nombre del centro'); if(!nombre) return;
    const it={id:uid(),nombre,delegado:'',audiologo:'',tipo:''};
    sec.items.push(it); state.selected={sectionId:sec.id,itemId:it.id}; ensureData(sec.id,it.id);
  }else if(sec.type==='formaciones'){
    const titulo = prompt('T√≠tulo del grupo/mentoring'); if(!titulo) return;
    const it={id:uid(),titulo,ciclo:'',grupo:''};
    sec.items.push(it); state.selected={sectionId:sec.id,itemId:it.id}; ensureData(sec.id,it.id);
  }else if(sec.type==='visitas'){
    const objetivo = prompt('Objetivo de la visita'); if(!objetivo) return;
    const it={id:uid(),fecha:new Date().toISOString().slice(0,10),objetivo};
    sec.items.push(it); state.selected={sectionId:sec.id,itemId:it.id}; ensureData(sec.id,it.id);
  }
  localSave(); renderLeft(); renderRight();
}

/* Render derecha (procedimientos por secci√≥n+item) */
function renderRight(){
  const titleEl = $('#currentItem');
  const [sec,item] = getSelected();
  if(!sec||!item){ titleEl.textContent='-'; $('#accionesBox').innerHTML=$('#formacionBox').innerHTML=$('#procesosBox').innerHTML=''; return; }
  titleEl.textContent = displayName(sec,item);
  ensureData(sec.id,item.id);
  const k = keyFor(sec.id,item.id), d = state.dataByKey[k];

  // Acciones
  const A=$('#accionesBox'); A.innerHTML='';
  d.acciones.forEach(a=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`
      <input type="date" value="${a.fecha||''}">
      <input placeholder="Acci√≥n‚Ä¶" value="${a.accion||''}">
      <input type="number" min="0" value="${a.derivacion||0}">
      <input type="number" min="0" value="${a.cita||0}">
      <input placeholder="Observaciones" value="${a.obs||''}">
      <div class="x">‚úï</div>`;
    const [f,ac,de,ci,ob]=row.querySelectorAll('input');
    [f,ac,de,ci,ob].forEach(el=>el.addEventListener('input',()=>{
      Object.assign(a,{fecha:f.value,accion:ac.value,derivacion:+de.value||0,cita:+ci.value||0,obs:ob.value}); localSave();
    }));
    row.querySelector('.x').addEventListener('click',()=>{ if(!editMode) return; d.acciones=d.acciones.filter(x=>x!==a); localSave(); renderRight();});
    A.appendChild(row);
  });

  // Formaci√≥n
  const F=$('#formacionBox'); F.innerHTML='';
  d.formaciones.forEach(f=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`
      <input type="date" value="${f.fecha||''}">
      <input placeholder="T√≠tulo" value="${f.titulo||''}">
      <select>
        <option value="">Asistencia</option>
        <option ${f.asistencia==='SI'?'selected':''}>SI</option>
        <option ${f.asistencia==='NO'?'selected':''}>NO</option>
        <option ${f.asistencia==='Pendiente'?'selected':''}>Pendiente</option>
      </select>
      <input placeholder="Aplicaci√≥n / Nota" value="${f.aplicacion||''}">
      <div></div>
      <div class="x">‚úï</div>`;
    const [fe,ti,se,ap]=[row.children[0],row.children[1],row.children[2],row.children[3]];
    [fe,ti,se,ap].forEach(el=>el.addEventListener('input',()=>{
      Object.assign(f,{fecha:fe.value,titulo:ti.value,asistencia:se.value,aplicacion:ap.value}); localSave();
    }));
    row.querySelector('.x').addEventListener('click',()=>{ if(!editMode) return; d.formaciones=d.formaciones.filter(x=>x!==f); localSave(); renderRight();});
    F.appendChild(row);
  });

  // Procesos
  const P=$('#procesosBox'); P.innerHTML='';
  d.procesos.forEach(p=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`
      <input placeholder="Nombre paquete" value="${p.nombre||''}">
      <input placeholder="Descripci√≥n" value="${p.descripcion||''}">
      <input placeholder="Puntuaci√≥n" value="${p.puntuacion||''}">
      <input placeholder="Observaciones" value="${p.observaciones||''}">
      <input type="date" value="${p.fecha||''}">
      <div class="x">‚úï</div>`;
    const [no,de,pu,ob,fe]=[row.children[0],row.children[1],row.children[2],row.children[3],row.children[4]];
    ;[no,de,pu,ob,fe].forEach(el=>el.addEventListener('input',()=>{
      Object.assign(p,{nombre:no.value,descripcion:de.value,puntuacion:pu.value,observaciones:ob.value,fecha:fe.value}); localSave();
    }));
    row.querySelector('.x').addEventListener('click',()=>{ if(!editMode) return; d.procesos=d.procesos.filter(x=>x!==p); localSave(); renderRight();});
    P.appendChild(row);
  });
}

/* A√±adir filas */
$('#addAccion').addEventListener('click', ()=>{const s=getSelectedKey(); if(!s) return; state.dataByKey[s].acciones.push({id:uid(),fecha:'',accion:'',derivacion:0,cita:0,obs:''}); localSave(); renderRight();});
$('#addFormacion').addEventListener('click', ()=>{const s=getSelectedKey(); if(!s) return; state.dataByKey[s].formaciones.push({id:uid(),fecha:'',asistencia:'',titulo:'',aplicacion:''}); localSave(); renderRight();});
$('#addProceso').addEventListener('click', ()=>{const s=getSelectedKey(); if(!s) return; state.dataByKey[s].procesos.push({id:uid(),nombre:'',descripcion:'',puntuacion:'',observaciones:'',fecha:''}); localSave(); renderRight();});
function getSelected(){const sec=state.sections.find(s=>s.id===state.selected.sectionId); const item=sec?.items?.find(i=>i.id===state.selected.itemId); return [sec,item];}
function getSelectedKey(){const [sec,item]=getSelected(); if(!sec||!item){alert('Selecciona un elemento de alguna secci√≥n.');return null;} ensureData(sec.id,item.id); return keyFor(sec.id,item.id);}

/* Buscador */
$('#q').addEventListener('input', e=>{
  const k=e.target.value.toLowerCase();
  $$('#left .item').forEach(n=>{ n.style.display = n.textContent.toLowerCase().includes(k)?'flex':'none'; });
});

/* Logo + PIN */
$('#btnLogo').addEventListener('click', ()=>{
  if(!editMode) return alert('Activa el modo edici√≥n (candado).');
  const input=document.createElement('input'); input.type='file'; input.accept='image/*';
  input.onchange=e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=ev=>{state.logo=ev.target.result; $('#logo').style.background=`#fff url('${state.logo}') center/contain no-repeat`; localSave();};
    r.readAsDataURL(f);
  }; input.click();
});
$('#btnLock').addEventListener('click', ()=>{
  if(editMode){ editMode=false; alert('Modo edici√≥n DESACTIVADO'); renderLeft(); return; }
  const pin=prompt('PIN de edici√≥n'); if(pin==='AR4321'){ editMode=true; alert('Modo edici√≥n ACTIVADO'); renderLeft(); } else alert('PIN incorrecto');
});

/* Backup local (descargar/subir) */
$('#btnBackup').addEventListener('click', ()=>{
  const isDownload = confirm('OK = Descargar JSON\nCancelar = Cargar desde archivo');
  if(isDownload){
    const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='audiologia_backup.json'; a.click();
  }else{
    const input=document.createElement('input'); input.type='file'; input.accept='application/json';
    input.onchange=async e=>{const f=e.target.files?.[0]; if(!f) return; const txt=await f.text(); try{state=JSON.parse(txt);}catch{return alert('Archivo inv√°lido');} localSave(); hydrate(); alert('Backup cargado.');};
    input.click();
  }
});

/* Nube (GitHub Gist) */
const gh={
  get token(){return localStorage.getItem('gist_token')||'';},
  set token(v){localStorage.setItem('gist_token',v||'');},
  get id(){return localStorage.getItem('gist_id')||'';},
  set id(v){localStorage.setItem('gist_id',v||'');}
};
$('#btnSettings').addEventListener('click', ()=>{
  const tok=prompt('Pega tu GitHub Token (scope: gist). Deja vac√≠o para borrar.', gh.token);
  if(tok===null) return; gh.token=tok.trim();
  if(!gh.id){ const id=prompt('Opcional: si ya tienes un Gist, pega su ID',''); if(id!==null&&id.trim()) gh.id=id.trim(); }
  alert('Configuraci√≥n guardada.');
});
$('#btnCloud').addEventListener('click', cloudSave);
$('#btnCloudLoad').addEventListener('click', cloudLoad);

async function cloudSave(){
  try{
    let token=gh.token; if(!token){ token=prompt('Token (scope: gist)'); if(!token) return; gh.token=token; }
    const headers={'Authorization':'Bearer '+token,'Accept':'application/vnd.github+json','Content-Type':'application/json'};
    const body={description:'AUDIOLOGIA-SEGUIMIENTO backup', public:false, files:{'audiologia_backup.json':{content:JSON.stringify(state,null,2)}}};
    let res,data;
    if(!gh.id){
      res=await fetch('https://api.github.com/gists',{method:'POST',headers,body:JSON.stringify(body)});
      data=await res.json(); if(!res.ok) throw new Error(data.message||'Error creando Gist'); gh.id=data.id; alert('‚úÖ Copia creada (Gist ID: '+gh.id+')');
    }else{
      res=await fetch('https://api.github.com/gists/'+gh.id,{method:'PATCH',headers,body:JSON.stringify(body)});
      data=await res.json(); if(!res.ok) throw new Error(data.message||'Error actualizando Gist'); alert('‚úÖ Copia actualizada en la nube.');
    }
  }catch(e){alert('‚ùå '+e.message);}
}
async function cloudLoad(){
  try{
    let token=gh.token; if(!token){ token=prompt('Token (scope: gist)'); if(!token) return; gh.token=token; }
    if(!gh.id){ const id=prompt('Pega el Gist ID'); if(!id) return; gh.id=id.trim(); }
    const headers={'Authorization':'Bearer '+gh.token,'Accept':'application/vnd.github+json'};
    const res=await fetch('https://api.github.com/gists/'+gh.id,{headers}); const data=await res.json();
    if(!res.ok) throw new Error(data.message||'No se pudo leer el Gist');
    const file=data.files['audiologia_backup.json']; if(!file) throw new Error('No existe audiologia_backup.json');
    state=JSON.parse(file.content); localSave(); hydrate(); alert('‚úÖ Datos cargados.');
  }catch(e){alert('‚ùå '+e.message);}
}

/* Hidrataci√≥n inicial */
function hydrate(){
  if(state.logo) $('#logo').style.background=`#fff url('${state.logo}') center/contain no-repeat`;
  // Selecci√≥n por defecto
  if(!state.selected.sectionId || !state.selected.itemId){
    // priorizar centros exclusivos si hay
    const pref=state.sections.find(s=>s.items.length>0);
    if(pref) state.selected={sectionId:pref.id,itemId:pref.items[0].id};
  }
  renderLeft(); renderRight();
}
localLoad(); hydrate();
// Autoload nube si ya hay token+id
(async()=>{ if(!gh.token||!gh.id) return; try{
  const headers={'Authorization':'Bearer '+gh.token,'Accept':'application/vnd.github+json'};
  const r=await fetch('https://api.github.com/gists/'+gh.id,{headers}); if(!r.ok) return;
  const d=await r.json(); const f=d.files['audiologia_backup.json'];
  if(f){ state=JSON.parse(f.content); localSave(); hydrate(); console.log('Auto-cargado desde nube'); }
}catch(_){}})();
</script>
</body>
</html>
