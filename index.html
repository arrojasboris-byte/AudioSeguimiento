<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SEGUIMIENTO AUDIO</title>
  <style>
    :root{
      --primary:#d32f2f;        /* rojo principal */
      --primary2:#b71c1c;       /* rojo oscuro */
      --bg:#f7f8fc;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --ring: rgba(211,47,47,.45);
      color-scheme: light dark;
    }
    *{box-sizing:border-box}
    html,body{margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:var(--bg);color:var(--text);line-height:1.35}
    /* ===== CABECERA ROJA ===== */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--primary2),var(--primary));
      color:#fff;padding:10px 14px;
      box-shadow:0 10px 24px rgba(0,0,0,.28)
    }
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .title{font-weight:900;letter-spacing:.3px;font-size:1.05rem;margin-right:6px}
    .chip{
      display:inline-flex;align-items:center;gap:.5rem;background:#ffffff22;
      padding:8px 12px;border-radius:999px;font-weight:700;box-shadow:inset 0 0 0 1px #ffffff33
    }
    .btn{
      display:inline-flex;align-items:center;gap:.5rem;cursor:pointer;
      border:0;border-radius:999px;padding:8px 12px;font-weight:800;
      background:#fff;color:var(--primary2);box-shadow:0 8px 18px rgba(0,0,0,.28)
    }
    .btn.secondary{background:#f7f7f9;color:#1f2937}
    .btn.small{padding:6px 10px;font-weight:800}
    .sep{opacity:.6;margin:0 .35rem}
    .status{font-weight:800}
    .last{opacity:.92}
    .search{min-width:230px;border:0;outline:none;border-radius:999px;padding:9px 12px;background:#ffffff; color:#1f2937}
    /* ===== LAYOUT ===== */
    .layout{display:grid;grid-template-columns:320px 1fr;gap:18px;max-width:1200px;margin:18px auto;padding:0 16px}
    aside{background:var(--card);border-radius:16px;box-shadow:0 14px 34px rgba(30,41,59,.08);padding:12px}
    main{display:grid;gap:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 14px 34px rgba(30,41,59,.08);padding:16px}
    .card h2{margin:0 0 10px;font-size:1.05rem}
    /* ===== SECCIONES LATERALES ===== */
    .sec{border:1px solid #00000012;border-radius:12px;margin:10px 0;overflow:hidden}
    .sec header{all:unset;display:flex;align-items:center;justify-content:space-between;background:#f3f4f6;color:#111;padding:10px 12px;font-weight:800}
    .sec header .left{display:flex;align-items:center;gap:.5rem}
    .sec header button{border:0;background:#fff;color:#1f2937;border-radius:8px;padding:6px 10px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.12)}
    .sec header .toggle{background:#eaeef8}
    .list{padding:8px 8px 10px;max-height:320px;overflow:auto}
    .item{display:flex;align-items:center;justify-content:space-between;gap:6px;padding:8px;border-radius:10px;cursor:pointer}
    .item:hover{background:#f5f6fb}
    .item.active{background:#e9ecff}
    .muted{opacity:.7;font-size:.9rem}
    /* ===== FORMULARIOS ===== */
    label{display:block;font-size:.92rem;opacity:.9;margin-bottom:6px}
    input[type="text"],select,textarea{
      width:100%;border:1px solid #0000001f;border-radius:12px;padding:10px 12px;font:inherit;background:#fff;
      outline:none;transition:border .15s, box-shadow .15s
    }
    input:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--ring)}
    textarea{min-height:120px;resize:vertical}
    input[type="checkbox"],input[type="radio"]{accent-color:var(--primary)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-12{grid-column:span 12}
    /* ===== LOGO ===== */
    .logo{height:36px;width:auto;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.25)}
    .hidden{display:none}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 14px 30px rgba(0,0,0,.25);z-index:9999;opacity:.98}
    @media (prefers-color-scheme: dark){
      :root{--bg:#0e1116;--card:#171a21;--text:#e5e7eb}
      aside, .card{box-shadow:0 14px 34px rgba(0,0,0,.25)}
      .sec header{background:#111827;color:#e5e7eb}
      .item:hover{background:#1f2430}
      .item.active{background:#1b2b57}
      input,select,textarea{background:#0f1217;color:#e5e7eb;border-color:#ffffff26}
      .search{background:#ffffffcc}
      .btn{background:#ffe2e2;color:#7f1212}
      .btn.secondary{background:#f0f0f0;color:#1f2937}
    }
  </style>
</head>
<body>
  <!-- CABECERA ROJA -->
  <header>
    <div class="bar">
      <span class="title">SEGUIMIENTO AUDIO</span>

      <!-- Logo (adjuntar) -->
      <label class="btn small" for="logoInput" title="Adjuntar logo">üìé Logo</label>
      <input id="logoInput" type="file" accept="image/*" class="hidden" />
      <img id="logoPreview" class="logo hidden" alt="Logo" />

      <input id="search" class="search" type="search" placeholder="Buscar secciones / centros‚Ä¶" />

      <span class="sep">‚Äî</span>
      <button id="btnEdit" class="btn secondary" title="Introducir PIN para editar">üîí Editar</button>
      <button id="btnLoad" class="btn secondary" title="Actualizar desde la nube" disabled>üîÑ Actualizar</button>
      <button id="btnSave" class="btn" title="Guardar en la nube" disabled>üíæ Guardar</button>

      <span class="chip status" id="status">‚è≥</span>
      <span class="chip last" id="last">‚Äî</span>
    </div>
  </header>

  <!-- LAYOUT -->
  <div class="layout">
    <!-- LADO IZQUIERDO: SECCIONES -->
    <aside>
      <!-- CENTROS EXCLUSIVOS -->
      <section class="sec" data-sec="exclusivos">
        <header>
          <div class="left">üè• <span><strong>CENTROS EXCLUSIVOS</strong> <span class="muted">(m√°x. 10)</span></span></div>
          <div>
            <button class="toggle" data-toggle="exclusivos">‚ñº</button>
            <button class="add" data-add="exclusivos">Ôºã</button>
          </div>
        </header>
        <div class="list" id="list-exclusivos"></div>
      </section>

      <!-- CENTROS FLOP -->
      <section class="sec" data-sec="flop">
        <header>
          <div class="left">üè• <span><strong>CENTROS FLOP</strong></span></div>
          <div>
            <button class="toggle" data-toggle="flop">‚ñº</button>
            <button class="add" data-add="flop">Ôºã</button>
          </div>
        </header>
        <div class="list" id="list-flop"></div>
      </section>

      <!-- VISITAS AUDIO -->
      <section class="sec" data-sec="visitas">
        <header>
          <div class="left">üìã <span><strong>VISITAS AUDIO</strong></span></div>
          <div>
            <button class="toggle" data-toggle="visitas">‚ñº</button>
            <button class="add" data-add="visitas">Ôºã</button>
          </div>
        </header>
        <div class="list" id="list-visitas"></div>
      </section>

      <!-- FORMACIONES Y MENTORING -->
      <section class="sec" data-sec="formaciones">
        <header>
          <div class="left">üéì <span><strong>FORMACIONES Y MENTORING</strong></span></div>
          <div>
            <button class="toggle" data-toggle="formaciones">‚ñº</button>
            <button class="add" data-add="formaciones">Ôºã</button>
          </div>
        </header>
        <div class="list" id="list-formaciones"></div>
      </section>
    </aside>

    <!-- LADO DERECHO: DETALLE -->
    <main>
      <section class="card">
        <h2 id="detail-title">Detalle</h2>
        <div id="detail-form">
          <p class="muted">Selecciona una entrada en la izquierda o crea una nueva con Ôºã.</p>
        </div>
      </section>

      <section class="card">
        <h2>Vista previa del estado</h2>
        <pre id="preview">‚Äî</pre>
      </section>
    </main>
  </div>

  <!-- ===== L√ìGICA (estado, nube y UI) ===== -->
  <script type="module">
    /********** Config **********/
    const PIN = "AR4321";                      // NO visible; se solicita al editar
    const ENDPOINT = "https://script.google.com/macros/s/AKfycby5vh1Ja0XllWFB98ypWmDcUfUItwEciVimUd5L6Esi1wfPJbcc2dap6G0lciRf51VR/exec";

    /********** Estado **********/
    let state = {
      logoDataUrl: "",
      exclusivos: [],   // {id, nombre, delegado, audiologo, tipo}
      flop: [],         // {id, nombre, delegado, audiologo, tipo}
      visitas: [],      // {id, responsable}
      formaciones: []   // {id, titulo, mentor, fecha}
    };
    let editing = false; // bloquea edici√≥n hasta introducir PIN
    let selected = { section:null, id:null };

    /********** Helpers **********/
    const $ = s => document.querySelector(s);
    const $$ = s => [...document.querySelectorAll(s)];
    const statusEl = $("#status"), lastEl = $("#last"), prevEl = $("#preview");
    const detailTitle = $("#detail-title"), detailForm = $("#detail-form");
    const listEls = {
      exclusivos: $("#list-exclusivos"),
      flop: $("#list-flop"),
      visitas: $("#list-visitas"),
      formaciones: $("#list-formaciones")
    };
    const setStatus = t => statusEl.textContent = t;
    const setLast   = t => lastEl.textContent = t ? `Actualizado: ${t}` : "‚Äî";
    const toast = m => { const t=document.createElement("div"); t.className="toast"; t.textContent=m; document.body.appendChild(t); setTimeout(()=>t.remove(),1800); };
    const uid = () => Math.random().toString(36).slice(2,10);

    function updatePreview(){ prevEl.textContent = JSON.stringify(state, null, 2); }

    function renderLists(filter=""){
      ["exclusivos","flop","visitas","formaciones"].forEach(sec=>{
        const data = state[sec];
        const ul = listEls[sec]; ul.innerHTML = "";
        (data||[]).filter(it=>{
          const txt = Object.values(it).join(" ").toLowerCase();
          return txt.includes(filter.toLowerCase());
        }).forEach(it=>{
          const div=document.createElement("div");
          div.className="item"+(selected.section===sec && selected.id===it.id ? " active":"");
          const label = (sec==="visitas") ? (it.responsable || "(Sin responsable)") :
                        (sec==="formaciones") ? (it.titulo || "(Sin t√≠tulo)") :
                        (it.nombre || "(Sin nombre)");
          div.innerHTML = `<span>${label}</span><span class="muted">#${it.id.slice(0,4)}</span>`;
          div.onclick = ()=>{ selected={section:sec,id:it.id}; renderLists(filter); renderDetail(); };
          ul.appendChild(div);
        });
      });
      updatePreview();
    }

    function renderDetail(){
      const {section,id} = selected;
      if(!section){ detailTitle.textContent="Detalle"; detailForm.innerHTML=`<p class="muted">Selecciona una entrada o crea una nueva.</p>`; return; }
      const arr = state[section];
      const it  = arr.find(x=>x.id===id);
      detailTitle.textContent = {
        exclusivos:"Centro EXCLUSIVO",
        flop:"Centro FLOP",
        visitas:"Visita de AUDIO",
        formaciones:"Formaci√≥n / Mentoring"
      }[section] + `  ¬∑  #${id.slice(0,6)}`;

      // Formulario de detalle seg√∫n secci√≥n
      if(section==="exclusivos" || section==="flop"){
        detailForm.innerHTML = `
          <div class="row">
            <div class="col-6"><label>Nombre</label><input id="f_nombre" type="text" ${!editing?"disabled":""} value="${it.nombre||""}"/></div>
            <div class="col-6"><label>Delegado</label><input id="f_delegado" type="text" ${!editing?"disabled":""} value="${it.delegado||""}"/></div>
            <div class="col-6"><label>Audi√≥logo</label><input id="f_audiologo" type="text" ${!editing?"disabled":""} value="${it.audiologo||""}"/></div>
            <div class="col-6"><label>Tipo</label>
              <select id="f_tipo" ${!editing?"disabled":""}>
                <option value="">‚Äî</option>
                <option value="sucursal" ${it.tipo==="sucursal"?"selected":""}>Sucursal</option>
                <option value="franquicia" ${it.tipo==="franquicia"?"selected":""}>Franquicia</option>
              </select>
            </div>
          </div>
        `;
      } else if(section==="visitas"){
        detailForm.innerHTML = `
          <div class="row">
            <div class="col-6"><label>Responsable</label><input id="f_responsable" type="text" ${!editing?"disabled":""} value="${it.responsable||""}"/></div>
          </div>
        `;
      } else if(section==="formaciones"){
        detailForm.innerHTML = `
          <div class="row">
            <div class="col-6"><label>T√≠tulo</label><input id="f_titulo" type="text" ${!editing?"disabled":""} value="${it.titulo||""}"/></div>
            <div class="col-3"><label>Mentor</label><input id="f_mentor" type="text" ${!editing?"disabled":""} value="${it.mentor||""}"/></div>
            <div class="col-3"><label>Fecha</label><input id="f_fecha" type="text" placeholder="YYYY-MM-DD" ${!editing?"disabled":""} value="${it.fecha||""}"/></div>
          </div>
        `;
      }
      // Escuchar cambios si est√° desbloqueado
      if(editing){
        detailForm.querySelectorAll("input,select,textarea").forEach(inp=>{
          inp.addEventListener("input", ()=>{
            if(section==="exclusivos"||section==="flop"){
              it.nombre   = $("#f_nombre").value;
              it.delegado = $("#f_delegado").value;
              it.audiologo= $("#f_audiologo").value;
              it.tipo     = $("#f_tipo").value;
            }else if(section==="visitas"){
              it.responsable = $("#f_responsable").value;
            }else if(section==="formaciones"){
              it.titulo = $("#f_titulo").value;
              it.mentor = $("#f_mentor").value;
              it.fecha  = $("#f_fecha").value;
            }
            renderLists($("#search").value);
          });
        });
      }
    }

    function addItem(section){
      if(section==="exclusivos" && state.exclusivos.length>=10){ toast("M√°ximo 10 centros exclusivos"); return; }
      const obj = (section==="visitas") ? {id:uid(), responsable:""} :
                  (section==="formaciones") ? {id:uid(), titulo:"", mentor:"", fecha:""} :
                  {id:uid(), nombre:"", delegado:"", audiologo:"", tipo:""};
      state[section].push(obj);
      selected={section,id:obj.id};
      renderLists($("#search").value);
      renderDetail();
    }

    /********** B√∫squeda de secciones / items **********/
    $("#search").addEventListener("input", e=>{
      renderLists(e.target.value);
    });

    /********** Logo **********/
    const logoInput = $("#logoInput"), logoPreview=$("#logoPreview");
    logoInput.addEventListener("change", ()=>{
      const file = logoInput.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        state.logoDataUrl = String(reader.result||"");
        logoPreview.src = state.logoDataUrl;
        logoPreview.classList.remove("hidden");
        updatePreview();
      };
      reader.readAsDataURL(file);
    });

    /********** Colapsables y a√±adir **********/
    $$(".toggle").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const key = btn.dataset.toggle;
        const list = listEls[key];
        const open = !list.classList.contains("hidden");
        if(open){ list.classList.add("hidden"); btn.textContent="‚ñ∫"; }
        else{ list.classList.remove("hidden"); btn.textContent="‚ñº"; }
      });
    });
    $$(".add").forEach(btn=>btn.addEventListener("click", ()=>{
      if(!editing){ toast("Pulsa ‚ÄòEditar‚Äô e introduce el PIN para a√±adir"); return; }
      addItem(btn.dataset.add);
    }));

    /********** Bloqueo por PIN **********/
    const btnEdit=$("#btnEdit"), btnSave=$("#btnSave"), btnLoad=$("#btnLoad");
    function setEditing(on){
      editing = !!on;
      btnSave.disabled = !editing;
      btnLoad.disabled = !editing;
      btnEdit.textContent = editing ? "üîì Editando" : "üîí Editar";
      // Re-render detalle para habilitar/deshabilitar inputs
      renderDetail();
    }
    btnEdit.addEventListener("click", ()=>{
      if(editing){ setEditing(false); return; }
      const pin = prompt("Introduce el PIN para editar:");
      if(pin===PIN){ setEditing(true); toast("Edici√≥n desbloqueada"); }
      else { alert("PIN incorrecto."); }
    });

    /********** Nube (sin tokens) **********/
    async function saveToCloud(){
      try{
        setStatus("üíæ Guardando‚Ä¶");
        const res = await fetch(ENDPOINT,{
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({action:"save", pin:PIN, state})
        });
        const json = await res.json().catch(()=>null);
        if(!res.ok || !json?.ok) throw new Error(json?.error||("HTTP "+res.status));
        setStatus("‚úÖ Guardado"); setLast(json.updatedAt); toast("Guardado en la nube");
      }catch(e){ console.error(e); setStatus("‚ùå Error al guardar"); alert("No se pudo guardar."); }
    }
    async function loadFromCloud(){
      try{
        setStatus("‚¨áÔ∏è Cargando‚Ä¶");
        const u=new URL(ENDPOINT); u.searchParams.set("action","load"); u.searchParams.set("pin",PIN);
        const res=await fetch(u.toString(),{method:"GET"});
        const json=await res.json().catch(()=>null);
        if(!res.ok || !json?.ok) throw new Error(json?.error||("HTTP "+res.status));
        state = Object.assign({logoDataUrl:"",exclusivos:[],flop:[],visitas:[],formaciones:[]}, json.state||{});
        // Logo preview
        if(state.logoDataUrl){ logoPreview.src = state.logoDataUrl; logoPreview.classList.remove("hidden"); }
        // Reset selecci√≥n
        selected={section:null,id:null};
        renderLists($("#search").value);
        renderDetail();
        setStatus("‚úÖ Actualizado"); setLast(json.updatedAt); toast("Datos cargados");
      }catch(e){ console.error(e); setStatus("‚ùå Error al cargar"); alert("No se pudo cargar."); }
    }
    btnSave.addEventListener("click", saveToCloud);
    btnLoad.addEventListener("click", loadFromCloud);

    /********** Arranque **********/
    setEditing(false);
    renderLists();
    renderDetail();
    // Carga inicial de nube (solo lectura, aunque no hayas puesto PIN)
    loadFromCloud();
  </script>
</body>
</html>
