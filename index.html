<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AUDIOLOGIA-SEGUIMIENTO</title>
<link rel="icon" href="data:," />
<style>
:root{
  --red:#e1192a;--red-2:#f04a54;--ink:#20252d;--muted:#8a9099;--panel:#f5f6f8;--line:#e7e9ee;--ok:#22a06b;--warn:#f5a524;--primary:#1f78ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font:16px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#eef0f3;color:var(--ink)}
.container{max-width:1180px;margin:0 auto;padding:16px}

.header{display:flex;align-items:center;gap:16px;background:#fff;border:2px solid var(--red);border-radius:16px;padding:10px 14px}
.logo-wrap{width:170px;height:56px;border:1px dashed var(--line);border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#fafafa;cursor:pointer}
.logo-wrap img{max-height:56px;width:auto;object-fit:contain;display:block}
.title{flex:1}
.title h1{margin:0;font-size:28px;letter-spacing:.5px}
.badge{display:inline-flex;gap:6px;align-items:center;margin-left:8px}
.iconbar{display:flex;gap:12px}
.iconbtn{width:42px;height:42px;border-radius:12px;border:none;cursor:pointer;display:grid;place-items:center;background:#353b46;color:#fff}
.iconbtn.red{background:var(--red)}
.iconbtn.blue{background:var(--primary)}
.iconbtn.gray{background:#9096a1}
.iconbtn[disabled]{opacity:.45;cursor:not-allowed}

.search{margin:14px 0 8px}
.search input{width:100%;border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:15px;background:#fff}

.layout{display:grid;grid-template-columns:360px 1fr;gap:18px}
.panel{background:#fff;border-radius:16px;border-left:6px solid var(--red);padding:12px}
.panel h2{margin:6px 0 10px;font-size:20px;display:flex;justify-content:space-between;align-items:center}
.btn{border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.red{background:var(--red);color:#fff}
.btn.gray{background:#f0f2f5;color:#222;border:1px solid var(--line)}
.btn.icon{width:36px;height:36px;display:grid;place-items:center;padding:0}
.row{display:flex;gap:8px;align-items:center}
.section-box{background:#f7f8fa;border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0}
.section-head{display:flex;align-items:center;justify-content:space-between}
.counter{background:#fff;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;color:#444}
.sub-list{display:grid;gap:10px;margin-top:8px}
.sub-item{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px;display:flex;align-items:center;justify-content:space-between}
.sub-left{display:flex;align-items:center;gap:8px}
.dot{width:10px;height:10px;border-radius:999px}
.tag{font-size:12px;border-radius:999px;padding:2px 8px;border:1px solid var(--line);background:#fafbfc;color:#333}
.actions{display:flex;gap:6px}

.right h3{margin:2px 0 10px;font-size:20px}
.sheet{background:#fbfcfe;border:1px solid var(--line);border-radius:14px;padding:10px}
.sheet .toolbar{display:flex;justify-content:flex-end;gap:8px;margin-bottom:8px}
.table{width:100%;border-collapse:collapse;table-layout:fixed}
.table th,.table td{border:1px solid var(--line);padding:6px 8px;font-size:14px;background:#fff}
.table th{position:sticky;top:0;background:#10131a;color:#fff;font-weight:600}
.table td input,.table td textarea,.table td select{
  width:100%;border:none;outline:0;background:transparent;padding:6px 4px;font:inherit
}
.table td textarea{resize:vertical;min-height:36px}
.compact .table th,.compact .table td{padding:4px 6px;font-size:13px}

.status{font-size:12px;color:var(--muted);margin-left:8px}
.ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--red)}

.modal-back{position:fixed;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:#fff;border-radius:16px;max-width:520px;width:92%;padding:16px;border:2px solid var(--line)}
.modal h3{margin:0 0 8px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
input[type="text"],input[type="password"]{border:1px solid var(--line);border-radius:10px;padding:10px}
.helper{font-size:12px;color:#666}

.locked [data-edit], .locked input, .locked select, .locked textarea {pointer-events:none; opacity:.9}
.lock-pill{background:#ffe7e7;color:#aa1b1b;font-size:12px;padding:2px 8px;border-radius:999px;margin-left:8px;border:1px solid #ffd0d0}
</style>
</head>
<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="logo-wrap" id="logoBox" title="Click para subir logo">
      <img id="logoImg" alt="Logo" />
      <input id="logoFile" type="file" accept="image/*" hidden />
    </div>
    <div class="title">
      <h1>AUDIOLOGIA-SEGUIMIENTO <span id="lockState" class="lock-pill" hidden>modo lectura</span></h1>
      <div class="badge">
        <small id="cloudStatus" class="status">nube: sin configurar</small>
      </div>
    </div>
    <div class="iconbar">
      <button class="iconbtn" id="btnPin" title="Editar (PIN AR4321)">üîí</button>
      <button class="iconbtn red" id="btnSaveCloud" title="Guardar en nube">‚òÅÔ∏è</button>
      <button class="iconbtn blue" id="btnLoadCloud" title="Cargar de nube">‚¨áÔ∏è</button>
      <button class="iconbtn gray" id="btnBackup" title="Backup local (JSON)">üíæ</button>
      <button class="iconbtn gray" id="btnSettings" title="Ajustes nube">‚öôÔ∏è</button>
    </div>
  </div>

  <!-- SEARCH -->
  <div class="search"><input id="search" placeholder="Buscar en secciones, centros y datos..." /></div>

  <div class="layout" id="appRoot">

    <!-- LEFT: SECCIONES -->
    <div class="panel left" id="leftPanel">
      <h2>
        Secciones
        <button class="btn red" id="btnAddSection" data-edit>+ A√±adir secci√≥n</button>
      </h2>

      <!-- Bloque: Centros exclusivos -->
      <div class="section-box" data-sec="exclusivos">
        <div class="section-head">
          <div class="row">
            <strong>Centros exclusivos</strong>
            <span id="countEx" class="counter">0</span>
          </div>
          <div class="row">
            <button class="btn gray" id="toggleEx">Mostrar</button>
            <button class="btn icon gray" id="addSubEx" title="A√±adir sub" data-edit>Ôºã</button>
            <button class="btn icon gray" id="editEx" title="Editar secci√≥n" data-edit>‚úé</button>
            <button class="btn icon gray" id="delEx" title="Eliminar secci√≥n" data-edit>üóëÔ∏è</button>
          </div>
        </div>
        <div class="sub-list" id="listEx"></div>
      </div>

      <!-- Bloque: Centros flop -->
      <div class="section-box" data-sec="flop">
        <div class="section-head">
          <div class="row">
            <strong>Centros flop</strong>
            <span id="countFlop" class="counter">0</span>
          </div>
          <div class="row">
            <button class="btn gray" id="toggleFlop">Mostrar</button>
            <button class="btn icon gray" id="addSubFlop" title="A√±adir sub" data-edit>Ôºã</button>
            <button class="btn icon gray" id="editFlop" title="Editar secci√≥n" data-edit>‚úé</button>
            <button class="btn icon gray" id="delFlop" title="Eliminar secci√≥n" data-edit>üóëÔ∏è</button>
          </div>
        </div>
        <div class="sub-list" id="listFlop"></div>
      </div>

      <!-- Bloque: Formaciones ‚Äì Mentoring -->
      <div class="section-box" data-sec="formacion">
        <div class="section-head">
          <div class="row">
            <strong>Formaciones ‚Äì Mentoring</strong>
            <span id="countForm" class="counter">0</span>
          </div>
          <div class="row">
            <button class="btn gray" id="toggleForm">Mostrar</button>
            <button class="btn icon gray" id="addSubForm" title="A√±adir sub" data-edit>Ôºã</button>
            <button class="btn icon gray" id="editForm" title="Editar secci√≥n" data-edit>‚úé</button>
            <button class="btn icon gray" id="delForm" title="Eliminar secci√≥n" data-edit>üóëÔ∏è</button>
          </div>
        </div>
        <div class="sub-list" id="listForm"></div>
      </div>

      <!-- Bloque: Visitas a centros -->
      <div class="section-box" data-sec="visitas">
        <div class="section-head">
          <div class="row">
            <strong>Visitas a centros</strong>
            <span id="countVis" class="counter">0</span>
          </div>
          <div class="row">
            <button class="btn gray" id="toggleVis">Mostrar</button>
            <button class="btn icon gray" id="addSubVis" title="A√±adir sub" data-edit>Ôºã</button>
            <button class="btn icon gray" id="editVis" title="Editar secci√≥n" data-edit>‚úé</button>
            <button class="btn icon gray" id="delVis" title="Eliminar secci√≥n" data-edit>üóëÔ∏è</button>
          </div>
        </div>
        <div class="sub-list" id="listVis"></div>
      </div>

      <div class="helper">Consejo: pulsa el nombre de un centro para cargar sus procedimientos en el panel derecho.</div>
    </div>

    <!-- RIGHT: PROCEDIMIENTOS -->
    <div class="panel right" id="rightPanel">
      <h3 id="procTitle">Procedimientos ‚Äî </h3>

      <!-- Acciones ‚Äì Resultado -->
      <div class="sheet compact" id="sheetAcc">
        <div class="toolbar">
          <button class="btn gray" id="addRowAcc" data-edit>+ A√±adir</button>
          <button class="btn red" id="saveAcc" data-edit>Guardar</button>
        </div>
        <div class="table-wrap">
          <table class="table" id="tblAcc">
            <thead>
              <tr>
                <th style="width:44px">#</th>
                <th style="width:160px">Fecha</th>
                <th>Acci√≥n</th>
                <th style="width:120px">Derivaci√≥n</th>
                <th style="width:120px">Cita</th>
                <th>Observaciones</th>
                <th style="width:60px">‚ùå</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Formaci√≥n continua -->
      <div class="sheet compact" id="sheetForm">
        <div class="toolbar">
          <button class="btn red" id="saveFormTbl" data-edit>Guardar</button>
        </div>
        <table class="table" id="tblForm">
          <thead>
            <tr>
              <th style="width:44px">#</th>
              <th style="width:160px">Fecha</th>
              <th style="width:140px">Asistencia (SI/NO)</th>
              <th>T√≠tulo</th>
              <th>Aplicaci√≥n</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Procesos y paquetes personalizados -->
      <div class="sheet compact" id="sheetProc">
        <div class="toolbar">
          <button class="btn gray" id="addRowProc" data-edit>+ A√±adir</button>
          <button class="btn red" id="saveProc" data-edit>Guardar</button>
        </div>
        <table class="table" id="tblProc">
          <thead>
            <tr>
              <th style="width:44px">#</th>
              <th style="width:220px">Nombre paquete</th>
              <th>Descripci√≥n</th>
              <th style="width:120px">Puntuaci√≥n</th>
              <th>Observaciones</th>
              <th style="width:160px">Fecha visita</th>
              <th style="width:60px">‚ùå</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<!-- MODAL AJUSTES NUBE -->
<div class="modal-back" id="modalBack">
  <div class="modal">
    <h3>Ajustes de nube (Gist)</h3>
    <p class="helper">Crea un token en GitHub con permiso <strong>gist</strong> y p√©galo aqu√≠ una sola vez. Se guardar√° cifrado en tu navegador.</p>
    <div class="row2">
      <div>
        <label>Token</label>
        <input id="inpToken" type="password" placeholder="ghp_‚Ä¶" />
      </div>
      <div>
        <label>Gist ID (deja vac√≠o para crear uno)</label>
        <input id="inpGist" type="text" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn gray" id="btnCloseModal">Cancelar</button>
      <button class="btn red" id="btnSaveModal">OK</button>
    </div>
  </div>
</div>

<script>
/* ====== Estado y utilidades ====== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const STORAGE_KEY = 'audio_state_v1';
const LOGO_KEY = 'audio_logo_v1';
const CLOUD_KEY = 'audio_cloud_v1'; // {tokenEnc, gistId}
const PIN_CODE = 'AR4321';

let state = {
  locked: true,
  activeSection: 'exclusivos',
  activeCentroId: null,
  logo: null,
  secciones: {
    exclusivos: {
      nombre: 'Centros exclusivos',
      items: [
        {id: 1, nombre:'Reina Mercedes', delegado:'Ana Mart√≠nez', audiologo:'Dr. Garc√≠a', tipo:'Franquicia', color:1},
        {id: 2, nombre:'Barcelona Centro', delegado:'Carlos Ruiz', audiologo:'Dra. L√≥pez', tipo:'Sucursal', color:2}
      ],
      data: {
        // por centroId
        1: {
          acciones: [{id:1,fecha:'',accion:'',derivacion:0,cita:0,obs:''}],
          form: [
            {id:1,fecha:'',asistencia:'',titulo:'',aplicacion:''},
            {id:2,fecha:'',asistencia:'',titulo:'',aplicacion:''},
            {id:3,fecha:'',asistencia:'',titulo:'',aplicacion:''},
            {id:4,fecha:'',asistencia:'',titulo:'',aplicacion:''},
            {id:5,fecha:'',asistencia:'',titulo:'',aplicacion:''},
            {id:6,fecha:'',asistencia:'',titulo:'',aplicacion:''},
            {id:7,fecha:'',asistencia:'',titulo:'',aplicacion:''},
            {id:8,fecha:'',asistencia:'',titulo:'',aplicacion:''},
            {id:9,fecha:'',asistencia:'',titulo:'',aplicacion:''},
            {id:10,fecha:'',asistencia:'',titulo:'',aplicacion:''}
          ],
          procesos: [{id:1,nombre:'',desc:'',punt:'',obs:'',fecha:''}]
        },
        2: {
          acciones: [{id:1,fecha:'',accion:'',derivacion:0,cita:0,obs:''}],
          form: Array.from({length:10},(_,i)=>({id:i+1,fecha:'',asistencia:'',titulo:'',aplicacion:''})),
          procesos: [{id:1,nombre:'',desc:'',punt:'',obs:'',fecha:''}]
        }
      }
    },
    flop: {nombre:'Centros flop', items:[], data:{}},
    formacion: {nombre:'Formaciones ‚Äì Mentoring', items:[], data:{}},
    visitas: {nombre:'Visitas a centros', items:[], data:{}}
  }
};

const palette = [
  '#dbeafe','#dcfce7','#fde68a','#fbcfe8','#e9d5ff','#fecaca',
  '#cffafe','#e5e7eb','#fef3c7','#bbf7d0','#bae6fd','#f5d0fe'
];

function centerColor(idx){ return palette[(idx-1) % palette.length]; }

function saveLocal(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function loadLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) {
    try{ state = {...state, ...JSON.parse(raw)} }catch(e){}
  }
  const logo = localStorage.getItem(LOGO_KEY);
  if (logo) state.logo = logo;
}

function setLockUI(){
  const root = $('#appRoot');
  if (state.locked){ root.classList.add('locked'); $('#lockState').hidden=false; }
  else { root.classList.remove('locked'); $('#lockState').hidden=true; }
}

/* ====== Render ====== */
function renderLogo(){
  const img = $('#logoImg');
  if (state.logo){ img.src = state.logo; } else { img.removeAttribute('src'); img.alt='Logo'; }
}

function renderLeft(){
  const ex = state.secciones.exclusivos.items;
  $('#countEx').textContent = ex.length;
  const listEx = $('#listEx'); listEx.innerHTML='';
  ex.forEach(item=>{
    const div = document.createElement('div');
    div.className='sub-item';
    div.innerHTML = `
      <div class="sub-left">
        <span class="dot" style="background:${centerColor(item.color||1)}"></span>
        <div>
          <div><strong style="cursor:pointer" data-centro="${item.id}">${item.nombre}</strong></div>
          <div class="tag">üë§ ${item.delegado} | üéß ${item.audiologo} | üìç ${item.tipo||'-'}</div>
        </div>
      </div>
      <div class="actions" data-edit>
        <button class="btn icon gray" title="Editar" data-editar="${item.id}">‚úé</button>
        <button class="btn icon gray" title="Eliminar" data-borrar="${item.id}">üóëÔ∏è</button>
      </div>
    `;
    listEx.appendChild(div);
  });

  // otros conteos
  $('#countFlop').textContent = state.secciones.flop.items.length;
  $('#countForm').textContent = state.secciones.formacion.items.length;
  $('#countVis').textContent = state.secciones.visitas.items.length;
}

function ensureCentroData(secKey, id){
  const sec = state.secciones[secKey];
  if (!sec.data[id]){
    sec.data[id] = {
      acciones:[{id:1,fecha:'',accion:'',derivacion:0,cita:0,obs:''}],
      form:Array.from({length:10},(_,i)=>({id:i+1,fecha:'',asistencia:'',titulo:'',aplicacion:''})),
      procesos:[{id:1,nombre:'',desc:'',punt:'',obs:'',fecha:''}]
    };
  }
  return sec.data[id];
}

function renderRight(){
  const secKey = 'exclusivos'; // ahora ligamos procedimientos a exclusivos
  const centroId = state.activeCentroId ?? state.secciones.exclusivos.items[0]?.id;
  if (!centroId){ $('#procTitle').textContent = 'Procedimientos ‚Äî'; return; }
  state.activeCentroId = centroId;
  const centro = state.secciones.exclusivos.items.find(c=>c.id===centroId);
  $('#procTitle').textContent = `Procedimientos ‚Äî ${centro?.nombre || ''}`;

  const data = ensureCentroData(secKey, centroId);

  // Acciones
  const tbodyA = $('#tblAcc tbody'); tbodyA.innerHTML='';
  data.acciones.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input type="date" value="${r.fecha||''}" data-a="fecha" data-id="${r.id}"></td>
      <td><input type="text" value="${r.accion||''}" data-a="accion" data-id="${r.id}"></td>
      <td><input type="number" min="0" value="${r.derivacion||0}" data-a="derivacion" data-id="${r.id}"></td>
      <td><input type="number" min="0" value="${r.cita||0}" data-a="cita" data-id="${r.id}"></td>
      <td><input type="text" value="${r.obs||''}" data-a="obs" data-id="${r.id}"></td>
      <td><button class="btn icon gray" data-del-acc="${r.id}" data-edit>‚úñ</button></td>
    `;
    // resaltar fila verde si hay derivaci√≥n y cita
    if ((+r.derivacion>0) && (+r.cita>0)){ tr.style.background='#ecfdf5'; }
    tbodyA.appendChild(tr);
  });

  // Formaciones
  const tbodyF = $('#tblForm tbody'); tbodyF.innerHTML='';
  data.form.forEach((r,i)=>{
    const tr = document.createElement('tr');
    const asis = r.asistencia||'';
    const bg = (asis.toLowerCase()==='si'||asis.toLowerCase()==='s√≠')
      ? (r.aplicacion?.trim()? '#ecfdf5':'#fff7ed') : '#fff';
    tr.style.background = bg;
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input type="date" value="${r.fecha||''}" data-f="fecha" data-id="${r.id}"></td>
      <td>
        <select data-f="asistencia" data-id="${r.id}">
          <option value="" ${asis===''?'selected':''}>-</option>
          <option value="SI" ${asis.toLowerCase()==='si'||asis.toLowerCase()==='s√≠'?'selected':''}>SI</option>
          <option value="NO" ${asis==='NO'?'selected':''}>NO</option>
          <option value="Pendiente" ${asis==='Pendiente'?'selected':''}>Pendiente</option>
        </select>
      </td>
      <td><input type="text" value="${r.titulo||''}" data-f="titulo" data-id="${r.id}"></td>
      <td><input type="text" value="${r.aplicacion||''}" data-f="aplicacion" data-id="${r.id}"></td>
    `;
    tbodyF.appendChild(tr);
  });

  // Procesos
  const tbodyP = $('#tblProc tbody'); tbodyP.innerHTML='';
  data.procesos.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input type="text" value="${r.nombre||''}" data-p="nombre" data-id="${r.id}"></td>
      <td><input type="text" value="${r.desc||''}" data-p="desc" data-id="${r.id}"></td>
      <td><input type="text" value="${r.punt||''}" data-p="punt" data-id="${r.id}" placeholder="Ej: 8/10"></td>
      <td><input type="text" value="${r.obs||''}" data-p="obs" data-id="${r.id}"></td>
      <td><input type="date" value="${r.fecha||''}" data-p="fecha" data-id="${r.id}"></td>
      <td><button class="btn icon gray" data-del-proc="${r.id}" data-edit>‚úñ</button></td>
    `;
    tbodyP.appendChild(tr);
  });
}

function renderAll(){
  setLockUI();
  renderLogo();
  renderLeft();
  renderRight();
}

/* ====== Eventos UI ====== */
$('#logoBox').addEventListener('click', ()=>{
  if (state.locked) return;
  $('#logoFile').click();
});
$('#logoFile').addEventListener('change', e=>{
  const f = e.target.files?.[0]; if(!f) return;
  const rd = new FileReader();
  rd.onload = () => {
    state.logo = rd.result;
    localStorage.setItem(LOGO_KEY, state.logo);
    saveLocal(); renderLogo();
  };
  rd.readAsDataURL(f);
});

$('#btnPin').addEventListener('click', ()=>{
  if (state.locked){
    const pin = prompt('Introduce PIN para editar:');
    if (pin===PIN_CODE){ state.locked=false; saveLocal(); renderAll(); }
    else alert('PIN incorrecto.');
  } else {
    state.locked=true; saveLocal(); renderAll();
  }
});

$('#leftPanel').addEventListener('click', (e)=>{
  const t = e.target;
  // seleccionar centro
  const s = t.closest('[data-centro]');
  if (s){
    state.activeCentroId = +s.getAttribute('data-centro');
    saveLocal(); renderRight();
    return;
  }
  // editar/borrar sub
  if (t.dataset.editar){
    if (state.locked) return;
    const id = +t.dataset.editar;
    const c = state.secciones.exclusivos.items.find(x=>x.id===id);
    const nombre = prompt('Nombre', c.nombre); if(nombre===null) return;
    const delegado = prompt('Delegado', c.delegado) ?? '';
    const audio = prompt('Audi√≥logo', c.audiologo) ?? '';
    const tipo = prompt('Tipo (Franquicia/Sucursal)', c.tipo||'') ?? '';
    c.nombre=nombre; c.delegado=delegado; c.audiologo=audio; c.tipo=tipo;
    saveLocal(); renderLeft(); renderRight();
  }
  if (t.dataset.borrar){
    if (state.locked) return;
    const id = +t.dataset.borrar;
    if (confirm('¬øEliminar centro?')){
      state.secciones.exclusivos.items = state.secciones.exclusivos.items.filter(x=>x.id!==id);
      delete state.secciones.exclusivos.data[id];
      if (state.activeCentroId===id) state.activeCentroId=null;
      saveLocal(); renderAll();
    }
  }
});

$('#addSubEx').addEventListener('click', ()=>{
  if (state.locked) return;
  const nombre = prompt('Nombre del centro'); if(!nombre) return;
  const delegado = prompt('Delegado')||''; const audio = prompt('Audi√≥logo')||'';
  const tipo = prompt('Tipo (Franquicia/Sucursal)')||'';
  const items = state.secciones.exclusivos.items;
  const id = (items.reduce((m,x)=>Math.max(m,x.id),0)+1)||1;
  items.push({id,nombre,delegado,audiologo:audio,tipo,color:items.length+1});
  saveLocal(); renderLeft();
});

$('#addRowAcc').addEventListener('click', ()=>{
  if (state.locked) return;
  const cId = state.activeCentroId; if(!cId) return;
  const arr = state.secciones.exclusivos.data[cId].acciones;
  const id = arr.reduce((m,x)=>Math.max(m,x.id),0)+1;
  arr.push({id,fecha:'',accion:'',derivacion:0,cita:0,obs:''});
  saveLocal(); renderRight();
});
$('#saveAcc').addEventListener('click', ()=>{
  if (state.locked) return;
  const cId = state.activeCentroId; if(!cId) return;
  const inputs = $$('#tblAcc [data-id]');
  const arr = state.secciones.exclusivos.data[cId].acciones;
  inputs.forEach(el=>{
    const id = +el.dataset.id; const key = el.dataset.a;
    const row = arr.find(r=>r.id===id); if (row) row[key] = el.type==='number'? +el.value : el.value;
  });
  saveLocal(); renderRight();
});
$('#tblAcc').addEventListener('click', e=>{
  const t=e.target; if(!t.dataset.delAcc) return;
  if (state.locked) return;
  const id = +t.dataset.delAcc;
  const cId = state.activeCentroId; if(!cId) return;
  const arr = state.secciones.exclusivos.data[cId].acciones;
  if (arr.length>1){
    state.secciones.exclusivos.data[cId].acciones = arr.filter(x=>x.id!==id);
    saveLocal(); renderRight();
  }
});

$('#saveFormTbl').addEventListener('click', ()=>{
  if (state.locked) return;
  const cId = state.activeCentroId; if(!cId) return;
  const arr = state.secciones.exclusivos.data[cId].form;
  $$('#tblForm [data-id]').forEach(el=>{
    const id=+el.dataset.id; const k=el.dataset.f; const row=arr.find(r=>r.id===id);
    if(row) row[k] = el.value;
  });
  saveLocal(); renderRight();
});

$('#addRowProc').addEventListener('click', ()=>{
  if (state.locked) return;
  const cId = state.activeCentroId; if(!cId) return;
  const arr = state.secciones.exclusivos.data[cId].procesos;
  const id = arr.reduce((m,x)=>Math.max(m,x.id),0)+1;
  arr.push({id,nombre:'',desc:'',punt:'',obs:'',fecha:''});
  saveLocal(); renderRight();
});
$('#saveProc').addEventListener('click', ()=>{
  if (state.locked) return;
  const cId = state.activeCentroId; if(!cId) return;
  const arr = state.secciones.exclusivos.data[cId].procesos;
  $$('#tblProc [data-id]').forEach(el=>{
    const id = +el.dataset.id; const k = el.dataset.p; const row = arr.find(r=>r.id===id);
    if(row) row[k] = el.value;
  });
  saveLocal(); renderRight();
});
$('#tblProc').addEventListener('click', e=>{
  const t=e.target; if(!t.dataset.delProc) return;
  if (state.locked) return;
  const id = +t.dataset.delProc;
  const cId = state.activeCentroId; if(!cId) return;
  const arr = state.secciones.exclusivos.data[cId].procesos;
  if (arr.length>1){
    state.secciones.exclusivos.data[cId].procesos = arr.filter(x=>x.id!==id);
    saveLocal(); renderRight();
  }
});

/* ====== Nube (Gist) ====== */
const modal = $('#modalBack');
function openModal(){
  $('#inpToken').value=''; $('#inpGist').value=getCloud().gistId||'';
  modal.style.display='flex';
}
function closeModal(){ modal.style.display='none'; }

$('#btnSettings').addEventListener('click', ()=>{
  if (state.locked) { alert('Desbloquea con el PIN para editar ajustes.'); return; }
  openModal();
});
$('#btnCloseModal').addEventListener('click', closeModal);

function getCloud(){
  try{
    const raw = localStorage.getItem(CLOUD_KEY);
    return raw? JSON.parse(raw): {};
  }catch(e){ return {}; }
}
function setCloud(v){
  localStorage.setItem(CLOUD_KEY, JSON.stringify(v||{}));
}
function updateCloudStatus(msg, cls=''){
  const el = $('#cloudStatus'); el.textContent = `nube: ${msg}`; el.className = `status ${cls}`;
}
async function apiGist(method, url, body, token){
  const res = await fetch(url, {
    method,
    headers: {
      'Accept':'application/vnd.github+json',
      ...(token? {'Authorization':'Bearer '+token} : {}),
    },
    body: body? JSON.stringify(body): undefined
  });
  if (!res.ok){
    const txt = await res.text().catch(()=>res.statusText);
    throw new Error(txt || res.statusText);
  }
  return await res.json();
}

$('#btnSaveModal').addEventListener('click', async ()=>{
  const token = $('#inpToken').value.trim();
  const gistId = $('#inpGist').value.trim();
  if (!token){ alert('Necesitas un token con permiso "gist".'); return; }
  setCloud({token, gistId: gistId||''});
  updateCloudStatus('configurado', 'ok');
  closeModal();
});

async function saveToCloud(){
  const {token, gistId} = getCloud();
  if (!token){
    updateCloudStatus('requiere token', 'warn'); openModal(); return;
  }
  updateCloudStatus('guardando‚Ä¶');
  const payload = {
    version:1,
    savedAt: new Date().toISOString(),
    state,
    logo: state.logo || null
  };
  const files = {'audiologia.json': {content: JSON.stringify(payload, null, 2)}};
  try{
    let id = gistId;
    if (!id){
      const r = await apiGist('POST','https://api.github.com/gists', {public:false, description:'Backup Audiologia Seguimiento', files}, token);
      id = r.id;
      const c = getCloud(); c.gistId = id; setCloud(c);
    }else{
      await apiGist('PATCH',`https://api.github.com/gists/${id}`, {files}, token);
    }
    updateCloudStatus('guardado OK', 'ok');
  }catch(err){
    console.error(err);
    updateCloudStatus('error al guardar', 'err');
    alert('Error al guardar en la nube:\n'+err.message);
  }
}
async function loadFromCloud(){
  const {token, gistId} = getCloud();
  if (!token || !gistId){ updateCloudStatus('sin configuraci√≥n', 'warn'); openModal(); return; }
  updateCloudStatus('cargando‚Ä¶');
  try{
    const r = await apiGist('GET',`https://api.github.com/gists/${gistId}`, null, token);
    const file = r.files?.['audiologia.json'];
    if (!file || !file.content) throw new Error('No existe audiologia.json en ese Gist.');
    const data = JSON.parse(file.content);
    // mezclar (no perder lo ya bien cargado)
    state = data.state || state;
    state.logo = data.logo || state.logo || null;
    saveLocal();
    renderAll();
    updateCloudStatus('cargado OK', 'ok');
  }catch(err){
    console.error(err);
    updateCloudStatus('error al cargar', 'err');
    alert('Error al cargar desde la nube:\n'+err.message);
  }
}

$('#btnSaveCloud').addEventListener('click', saveToCloud);
$('#btnLoadCloud').addEventListener('click', loadFromCloud);
$('#btnBackup').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify({state, logo:state.logo}, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='backup_audiologia.json'; a.click();
  URL.revokeObjectURL(url);
});

/* ====== Init ====== */
loadLocal();
renderAll();
// mostrar estado nube
const c = getCloud();
if (c?.token) updateCloudStatus(c.gistId? 'listo' : 'token OK (crear√° Gist)', 'ok');
else updateCloudStatus('sin configurar');
</script>
</body>
</html>
