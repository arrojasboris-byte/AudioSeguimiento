<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SEGUIMIENTO AUDIO · Cloud</title>
<meta name="theme-color" content="#c82727" />
<style>
:root{
  --rojo:#c82727; --rojo-osc:#a71f1f;
  --bg:#f6f7fb; --card:#fff; --line:#e6e7ee; --shadow:0 8px 22px rgba(0,0,0,.08);
  --contentW:1380px;
  --col-ex:#fde2e4; --col-fl:#e2f0cb; --col-va:#cde7f0; --col-fm:#f9e5c9; --col-ta:#eadcf8; --col-eq:#e8f1ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#222}

/* Topbar */
.topbar{position:sticky;top:0;z-index:50;width:100%;
  background:linear-gradient(180deg,var(--rojo),var(--rojo-osc));color:#fff;box-shadow:var(--shadow)}
.bar-inner{max-width:var(--contentW);margin:0 auto;padding:.85rem 1rem;display:flex;align-items:center;gap:.6rem}
.brand{font-weight:900;letter-spacing:.35px}
.spacer{flex:1}
.btn{border:0;border-radius:12px;padding:.55rem .9rem;cursor:pointer;box-shadow:var(--shadow);font-weight:800}
.btn-lite{background:#fff;color:#861212}
.btn-save{background:#fff;color:#7b0e0e}
.btn-ghost{background:transparent;border:1px solid #ffffff66;color:#fff}
.pill{display:inline-flex;gap:.45rem;align-items:center;border:1px solid #ffffff2f;background:#ffffff1c;padding:.35rem .6rem;border-radius:999px;white-space:nowrap}

/* Layout */
.app{max-width:var(--contentW);margin:0 auto}
.wrap{display:grid;grid-template-columns:320px 1fr;gap:1rem;padding:1rem}
.card{background:var(--card);border-radius:16px;box-shadow:var(--shadow)}
.title{font-weight:900;font-size:1.05rem;padding:.8rem 1rem;border-bottom:1px solid var(--line)}
.section{margin:12px;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#fff}
.sec-head{display:flex;justify-content:space-between;align-items:center;padding:.75rem .9rem;font-weight:900}
.sec-list{padding:.5rem .6rem 1rem}
.sec-btn{width:36px;height:32px;border-radius:9px;border:1px solid var(--line);background:#fff;cursor:pointer}
.item{display:flex;justify-content:space-between;gap:.6rem;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:.6rem .7rem;margin:.5rem 0;cursor:pointer}
.item .name{font-weight:750}
.acts{display:flex;gap:.25rem}
.ico-btn{min-width:30px;height:30px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer}
.ico-btn:hover{background:#fafafa}

/* Colores */
.bg-ex{background:var(--col-ex)} .bg-fl{background:var(--col-fl)} .bg-va{background:var(--col-va)}
.bg-fm{background:var(--col-fm)} .bg-ta{background:var(--col-ta)} .bg-eq{background:var(--col-eq)}

/* Detalle */
.detail{padding:1rem 1.1rem 1.2rem;border-radius:18px;border:1px solid var(--line);background:#fff}
.detail h2{margin:.1rem 0 .4rem 0}
.badge{padding:.15rem .5rem;border-radius:999px;background:#00000010}
.save-band{display:flex;justify-content:center;margin:.2rem 0 .8rem}
.save-big{font-size:1.05rem;padding:.7rem 1.2rem;border-radius:999px;background:#1f6feb;color:#fff;border:0;box-shadow:var(--shadow);cursor:pointer}

.row{display:flex;gap:.8rem;flex-wrap:wrap;align-items:flex-end}
.field{display:grid;gap:.3rem;min-width:200px;flex:1;margin:.4rem 0}
.field label{font-weight:700;opacity:.9}
.field input,.field select{border:1px solid var(--line);border-radius:10px;padding:.5rem .6rem;font-size:1rem;background:#fff;outline:none}

/* Tablas con scroll horizontal */
.table-wrap{border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--shadow);padding:.5rem}
.xscroll{overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;padding-bottom:14px}
.table-inner{display:block;width:max-content;min-width:1800px}
.scroll{max-height:58vh;overflow:auto;padding-right:.3rem}
.va-head,.va-row{display:grid;gap:.35rem;align-items:center;margin:.2rem .1rem}
.va-cols{grid-template-columns:52px 1.1fr 140px 140px 160px 130px 120px 70px 170px 170px}
.fm-head,.fm-row{grid-template-columns:52px 120px 220px 160px 140px 140px 140px 140px 140px 120px 120px}
.ta-head,.ta-row{grid-template-columns:52px 1.2fr 160px 150px 180px 110px 110px 130px 130px 140px}
.pscore{border:2px solid transparent}
.pscore.good{background:#eaf9f0;border-color:#2ecc71aa}
.pscore.bad{background:#ffe8e8;border-color:#e74c3caa}
.conv{border:2px solid transparent}
.conv.good{background:#eaf9f0;border-color:rgba(46,204,113,.6)}
.conv.bad{background:#fff4e1;border-color:rgba(243,156,18,.7)}
@media (max-width:1200px){.wrap{grid-template-columns:1fr}.scroll{max-height:52vh}}

/* Overlay PIN: negro */
.gate{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:1000}
.gate-card{background:#111;color:#fff;border-radius:16px;box-shadow:var(--shadow);padding:24px 22px;min-width:320px;border:1px solid #2a2a2a}
.gate-card h3{margin:.25rem 0 1rem 0}
.pin{letter-spacing:.45rem;font-size:1.25rem;text-align:center;background:#000;color:#fff;border:1px solid #444;border-radius:10px;padding:.6rem}
.subtle{opacity:.8;font-size:.9rem}
</style>
</head>
<body>

<header class="topbar">
  <div class="bar-inner">
    <div class="brand">SEGUIMIENTO AUDIO · Cloud</div>
    <div class="spacer"></div>
    <button id="btnFetch" class="btn btn-lite" title="Leer de la nube o local (no guarda)">Actualizar (nube)</button>
    <button id="btnSaveTop" class="btn btn-save" title="Guardar en la nube o local">Guardar (nube)</button>
    <button id="btnReset" class="btn btn-ghost" title="Descartar cambios locales y volver al último leído">Resetear</button>
    <span id="stamp" class="pill">Conectando…</span>
  </div>
</header>

<main class="app">
  <section class="wrap">
    <!-- IZQUIERDA -->
    <aside class="card">
      <div class="title">SEGUIMIENTO</div>

      <section class="section bg-ex" data-section="CENTROS EXCLUSIVOS">
        <div class="sec-head"><div>📒 CENTROS EXCLUSIVOS <span class="badge">(máx. 10)</span></div>
          <div><button class="sec-btn" data-act="toggle">▾</button><button class="sec-btn" data-act="add">＋</button></div>
        </div><div class="sec-list"></div>
      </section>

      <section class="section bg-fl" data-section="CENTROS FLOP">
        <div class="sec-head"><div>📒 CENTROS FLOP</div>
          <div><button class="sec-btn" data-act="toggle">▾</button><button class="sec-btn" data-act="add">＋</button></div>
        </div><div class="sec-list"></div>
      </section>

      <section class="section bg-va" data-section="VISITAS AUDIO">
        <div class="sec-head"><div>📋 VISITAS AUDIO</div>
          <div><button class="sec-btn" data-act="toggle">▾</button><button class="sec-btn" data-act="add">＋</button></div>
        </div><div class="sec-list"></div>
      </section>

      <section class="section bg-fm" data-section="FORMACIONES Y MENTORING">
        <div class="sec-head"><div>🎓 FORMACIONES Y MENTORING</div>
          <div><button class="sec-btn" data-act="toggle">▾</button><button class="sec-btn" data-act="add">＋</button></div>
        </div><div class="sec-list"></div>
      </section>

      <section class="section bg-ta" data-section="TELEAUDIOLOGIA">
        <div class="sec-head"><div>📡 TELEAUDIOLOGIA</div>
          <div><button class="sec-btn" data-act="toggle">▾</button><button class="sec-btn" data-act="add">＋</button></div>
        </div><div class="sec-list"></div>
      </section>

      <section class="section bg-eq" data-section="EQUIPOS">
        <div class="sec-head"><div>🧰 EQUIPOS</div>
          <div><button class="sec-btn" data-act="toggle">▾</button><button class="sec-btn" data-act="add">＋</button></div>
        </div><div class="sec-list"></div>
      </section>
    </aside>

    <!-- DERECHA -->
    <section class="detail card" id="detail">
      <div style="display:flex;align-items:center;gap:.6rem">
        <h2 id="detTitle">Detalle</h2><span id="detTag" class="badge">—</span>
      </div>
      <p id="detHint" style="opacity:.7">Selecciona un item a la izquierda o crea uno con ＋.</p>

      <!-- CENTROS -->
      <div id="detCentro" style="display:none">
        <div class="save-band"><button id="saveCentroTop" class="save-big">💾 GUARDAR CENTRO</button></div>
        <div class="row">
          <div class="field"><label>Nombre</label><input id="cNombre"></div>
          <div class="field"><label>Delegado</label><input id="cDelegado"></div>
        </div>
        <div class="row">
          <div class="field"><label>Audiólogo</label><input id="cAudiologo"></div>
          <div class="field"><label>Franquicia o Sucursal</label><select id="cTipo"><option>Franquicia</option><option>Sucursal</option></select></div>
        </div>

        <div class="table-wrap">
          <div class="xscroll"><div class="table-inner">
            <div class="va-head" style="grid-template-columns:52px 130px 1fr 110px 110px 110px 150px 52px">
              <div>#</div><div>Fecha</div><div>Tipo de acción</div><div>Paquete</div><div>Derivación</div><div>Citas</div><div>Venta</div><div></div>
            </div><div id="accionesRows"></div>
          </div></div>
        </div>

        <div class="table-wrap">
          <div class="xscroll"><div class="table-inner">
            <div class="va-head" style="grid-template-columns:52px 1.2fr .7fr .7fr 1.4fr 52px">
              <div>#</div><div>Curso</div><div>Realizado</div><div>Aplica</div><div>Observaciones</div><div></div>
            </div><div id="formacionesRows"></div>
          </div></div>
        </div>

        <div class="table-wrap">
          <div class="xscroll"><div class="table-inner">
            <div class="va-head" style="grid-template-columns:52px 220px 120px 160px 52px">
              <div>#</div><div>Puntuación checklist (0–100 %)</div><div>HIT</div><div>Colaboraciones</div><div></div>
            </div><div id="procesosRows"></div>
          </div></div>
        </div>
      </div>

      <!-- VISITAS -->
      <div id="detVisitas" style="display:none">
        <div class="save-band"><button id="saveVisitasTop" class="save-big">💾 GUARDAR VISITAS</button></div>
        <div class="row">
          <div class="field"><label>Rol</label><select id="vaRol"><option>Delegado audio</option><option>Responsable AAR</option></select></div>
          <div class="field"><label>Nombre</label><input id="vaResp" placeholder="Nombre"></div>
          <div class="field"><label>Buscar centro</label><input id="vaSearch" placeholder="Filtrar…"></div>
        </div>
        <div id="vaTabs" style="margin:.2rem 0 .5rem 0"></div>
        <div class="table-wrap">
          <div class="xscroll"><div class="table-inner">
            <div class="va-head va-cols">
              <div>#</div><div>Centro</div><div>Delegado</div><div>Audiólogo</div><div>Sucursal/Franquicia</div><div>Fecha visita</div><div>Puntuación (%)</div><div>HIT</div><div>% Conversión prueba</div><div>% Conversión venta</div>
            </div><div id="vaRows" class="scroll"></div>
          </div></div>
        </div>
      </div>

      <!-- FORMACIONES -->
      <div id="detFormaciones" style="display:none">
        <div class="save-band"><button id="saveFMTop" class="save-big">💾 GUARDAR FORMACIONES</button></div>
        <div class="row">
          <div class="field"><label>Delegado regional</label><input id="fmDelegado"></div>
          <div class="field"><label>Buscar</label><input id="fmSearch" placeholder="Filtrar…"></div>
        </div>
        <div class="table-wrap">
          <div class="xscroll"><div class="table-inner">
            <div class="va-head fm-head">
              <div>#</div><div>Fecha</div><div>Tema</div><div>Audiólogo</div>
              <div>Duración (semanas)</div><div>% Prueba inicial</div><div>% Venta inicial</div>
              <div>% Prueba 3m</div><div>% Venta 3m</div><div>Evo. prueba</div><div>Evo. venta</div>
            </div><div id="fmRows" class="scroll"></div>
          </div></div>
        </div>
      </div>

      <!-- TELE -->
      <div id="detTele" style="display:none">
        <div class="save-band"><button id="saveTATop" class="save-big">💾 GUARDAR TELE</button></div>
        <div class="row">
          <div class="field"><label>Buscar</label><input id="taSearch" placeholder="Centro o persona…"></div>
          <div class="field"><label>Persona</label><select id="taPerson"><option value="">Todos</option></select></div>
        </div>
        <div class="table-wrap">
          <div class="xscroll"><div class="table-inner">
            <div class="va-head ta-head">
              <div>#</div><div>Centro</div><div>Delegado</div><div>Rol</div><div>Persona</div><div>Formación</div><div>Prácticas</div><div>Certificado</div><div>Pruebas reales</div><div>Ventas</div>
            </div><div id="taRows" class="scroll"></div>
          </div></div>
        </div>
      </div>

      <!-- EQUIPOS -->
      <div id="detEquipos" style="display:none">
        <div class="save-band"><button id="saveEQTop" class="save-big">💾 GUARDAR EQUIPOS</button></div>
        <div class="row">
          <div class="field"><label>Buscar</label><input id="eqSearch" placeholder="Equipo, serie, centro o persona…"></div>
          <div class="field"><label>&nbsp;</label>
            <div style="display:flex;gap:.5rem"><button id="btnAddParCols" class="btn">＋ Añadir par</button><button id="btnAddFila" class="btn">＋ Añadir fila</button></div>
          </div>
        </div>
        <div class="table-wrap"><div class="xscroll"><div id="eqTable" class="table-inner"></div></div></div>
      </div>

    </section>
  </section>
</main>

<!-- Overlay PIN -->
<div id="gate" class="gate">
  <div class="gate-card">
    <h3>Acceso</h3>
    <p class="subtle">Introduce el PIN para editar:</p>
    <input id="pin" class="pin" type="password" inputmode="numeric" autocomplete="one-time-code" maxlength="6" placeholder="••••"/>
    <div style="display:flex;gap:.5rem;margin-top:12px">
      <button id="enter" class="btn btn-lite" style="flex:1">Entrar</button>
      <button id="cancelPin" class="btn btn-ghost" style="flex:.8">Cancelar</button>
    </div>
    <p id="pinMsg" class="subtle" style="color:#ff7b7b;margin:.7rem 0 0 0;display:none">PIN incorrecto</p>
  </div>
</div>

<!-- (Firebase opcional) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
/* ======= CONFIG ======= */
const REQUIRE_PIN = true;
const PIN_CODE = '4321';             // <— PIN (admite may/min)
const DB_PATH  = 'audioseguimiento/v6'; // cambia para “versionar” datos

// Rellena esto si quieres usar Firebase Realtime Database.
// Si lo dejas vacío, la app usa LocalStorage automáticamente.
const firebaseConfig = {
  apiKey: "",
  authDomain: "",
  databaseURL: "",
  projectId: "",
  storageBucket: "",
  messagingSenderId: "",
  appId: ""
};

/* ======= Utiles ======= */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const esc=s=>(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const now=()=>new Date().toLocaleString();

/* ======= Estado/Datos ======= */
let cloud={enabled:false,db:null,ref:null,ready:false};
let lastCloud=null;

let state={selected:{section:null,index:null},vaSheet:0,vaFilter:'',fmFilter:'',taFilter:'',taPerson:'',eqFilter:''};

function sheetVA(n){const rows=Array.from({length:300},()=>({centro:'',delegado:'',audiologo:'',tipo:'Sucursal',fecha:'',puntuacion:null,hit:false,conv_prueba:null,conv_venta:null}));return{nombre:n,rows};}
function rowsFM(){return Array.from({length:300},()=>({fecha:'',tema:'',audiologo:'',duracion:1,p_ini:null,v_ini:null,p_3m:null,v_3m:null}));}
function sheetTA(n){const rows=Array.from({length:300},()=>({centro:'',delegado:'',rol:'Audiólogo',persona:'',formacion:false,practicas:false,certificado:false,pruebas_reales:null,ventas:null}));return{nombre:n,rows};}
function equiposInit(){const filas=Array.from({length:25},()=>({equipo:'',serie:'',persona:'',fecha:'',pares:[{centro:'',sede:false},{centro:'',sede:false},{centro:'',sede:false}]}));return{columnas:3,filas};}

let data={
  "CENTROS EXCLUSIVOS":[{nombre:"Reina Mercedes",delegado:"",audiologo:"",tipo:"Franquicia",acciones:[],formaciones:[],procesos:[]}],
  "CENTROS FLOP":[],
  "VISITAS AUDIO":[{rol:"Delegado audio",responsable:"",hojas:[sheetVA("Visita 1")]}],
  "FORMACIONES Y MENTORING":[{delegado:"",filas:rowsFM()}],
  "TELEAUDIOLOGIA":[{hojas:[sheetTA("Tele 1")]}],
  "EQUIPOS":[equiposInit()]
};

/* ======= Persistencia (Nube/Local) ======= */
const LOCAL_KEY='audioseguimiento_local_v6';
function localLoad(){ try{const raw=localStorage.getItem(LOCAL_KEY); if(raw){data=JSON.parse(raw);} }catch(e){} }
function localSave(){ try{localStorage.setItem(LOCAL_KEY,JSON.stringify(data));}catch(e){} }

function initFirebase(){
  if(!firebaseConfig || !firebaseConfig.apiKey) return; // sin claves -> local
  try{firebase.initializeApp(firebaseConfig);}catch(e){}
  cloud.enabled=true;
  cloud.db=firebase.database();
  firebase.auth().signInAnonymously().then(()=>{
    cloud.ref=cloud.db.ref(DB_PATH);
    cloud.ref.on('value',snap=>{
      const v=snap.val(); if(v){data=v; lastCloud=JSON.parse(JSON.stringify(v)); localSave();}
      cloud.ready=true;
      $('#stamp').textContent='Actualizado: '+now();
      renderAll();
    });
  }).catch(()=>{cloud.enabled=false;});
}
function saveCloudOrLocal(){
  if(cloud.enabled && cloud.ready){
    cloud.ref.set(data).then(()=>{
      lastCloud=JSON.parse(JSON.stringify(data));
      $('#stamp').textContent='Guardado (nube): '+now();
    });
  }else{
    localSave();
    $('#stamp').textContent='Guardado (local): '+now();
  }
}
function fetchCloudOrLocal(){
  if(cloud.enabled && cloud.ready){
    cloud.ref.once('value').then(s=>{const v=s.val(); if(v){data=v; lastCloud=JSON.parse(JSON.stringify(v)); localSave(); renderAll(); $('#stamp').textContent='Actualizado (nube): '+now();}});
  }else{
    localLoad(); renderAll(); $('#stamp').textContent='Actualizado (local): '+now();
  }
}
function resetLocalView(){
  if(cloud.enabled && lastCloud){ data=JSON.parse(JSON.stringify(lastCloud)); }
  else localLoad();
  renderAll();
}

/* ======= UI izquierda ======= */
const SECTIONS=["CENTROS EXCLUSIVOS","CENTROS FLOP","VISITAS AUDIO","FORMACIONES Y MENTORING","TELEAUDIOLOGIA","EQUIPOS"];
function renderLeft(){
  SECTIONS.forEach(name=>{
    const sec=document.querySelector(`.section[data-section="${name}"]`);
    const list=sec.querySelector('.sec-list'); list.innerHTML='';
    (data[name]||[]).forEach((it,i)=>{
      const div=document.createElement('div'); div.className='item'; div.dataset.index=i;
      let inner='', acts=true;
      if(name.includes('CENTROS')){
        inner=`<div><div class="name">${esc(it.nombre||'—')}</div><small>Delegado: ${esc(it.delegado||'—')} · Aud.: ${esc(it.audiologo||'—')}</small></div>`;
      }else if(name==="VISITAS AUDIO"){
        inner=`<div><div class="name">(${esc(it.rol||'Rol')}) ${esc(it.responsable||'—')}</div><small>Visitas</small></div>`;
      }else if(name==="FORMACIONES Y MENTORING"){
        inner=`<div><div class="name">${esc(it.delegado||'(Delegado regional)')}</div></div>`;
      }else if(name==="TELEAUDIOLOGIA"){
        inner=`<div><div class="name">Teleaudiología</div></div>`;
      }else{ inner=`<div><div class="name">Inventario de equipos</div></div>`; acts=false; }
      div.innerHTML=inner+(acts?`<div class="acts"><button class="ico-btn" data-role="edit" title="Editar">✏️</button><button class="ico-btn" data-role="del" title="Eliminar">🗑️</button></div>`:'');
      list.appendChild(div);
    });
    sec.querySelector('[data-act="toggle"]').onclick=()=>{list.style.display=list.style.display==='none'?'':'none'; if(list.style.display==='none'&&name.includes('CENTROS')){state.selected={section:null,index:null}; renderDetailBlank();}};
    sec.querySelector('[data-act="add"]').onclick=()=>{
      let nuevo; if(name.includes('CENTROS')) nuevo={nombre:'(nuevo centro)',delegado:'',audiologo:'',tipo:'Franquicia',acciones:[],formaciones:[],procesos:[]};
      else if(name==="VISITAS AUDIO") nuevo={rol:'Delegado audio',responsable:'',hojas:[sheetVA('Visita 1')]};
      else if(name==="FORMACIONES Y MENTORING") nuevo={delegado:'(Delegado regional)',filas:rowsFM()};
      else if(name==="TELEAUDIOLOGIA") nuevo={hojas:[sheetTA('Tele 1')]};
      else nuevo=equiposInit();
      data[name].push(nuevo); renderAll(); saveCloudOrLocal();
    };
    list.onclick=(e)=>{
      const role=e.target.dataset.role; const item=e.target.closest('.item'); if(!item) return;
      const idx=+item.dataset.index;
      if(role==='del'){ if(confirm('¿Eliminar este item?')){ data[name].splice(idx,1); renderAll(); saveCloudOrLocal(); } return; }
      state.selected={section:name,index:idx}; renderDetail();
    };
  });
}

/* ======= Detalle ======= */
function renderDetailBlank(){ $('#detHint').style.display='block'; $('#detTag').textContent='—';
  $('#detCentro').style.display='none'; $('#detVisitas').style.display='none'; $('#detFormaciones').style.display='none'; $('#detTele').style.display='none'; $('#detEquipos').style.display='none'; }
function setTone(s){ const d=$('#detail'); d.style.background = s==="CENTROS EXCLUSIVOS"?'var(--col-ex)':s==="CENTROS FLOP"?'var(--col-fl)':s==="VISITAS AUDIO"?'var(--col-va)':s==="FORMACIONES Y MENTORING"?'var(--col-fm)':s==="TELEAUDIOLOGIA"?'var(--col-ta)':'var(--col-eq)'; }
function cur(){ return data[state.selected.section]?.[state.selected.index]; }
function renderDetail(){
  $('#detHint').style.display='none';
  const s=state.selected.section; setTone(s); $('#detTag').textContent=s||'—';
  $('#detCentro').style.display=s?.includes('CENTROS')?'block':'none';
  $('#detVisitas').style.display=s==='VISITAS AUDIO'?'block':'none';
  $('#detFormaciones').style.display=s==='FORMACIONES Y MENTORING'?'block':'none';
  $('#detTele').style.display=s==='TELEAUDIOLOGIA'?'block':'none';
  $('#detEquipos').style.display=s==='EQUIPOS'?'block':'none';
  if(s?.includes('CENTROS')) fillCentro();
  if(s==='VISITAS AUDIO') fillVisitas();
  if(s==='FORMACIONES Y MENTORING') fillFM();
  if(s==='TELEAUDIOLOGIA') fillTA();
  if(s==='EQUIPOS') fillEQ();
}

/* ======= CENTROS ======= */
function fillCentro(){ const it=cur(); if(!it) return;
  $('#cNombre').value=it.nombre||''; $('#cDelegado').value=it.delegado||''; $('#cAudiologo').value=it.audiologo||''; $('#cTipo').value=it.tipo||'Franquicia';
  renderAcciones(); renderFormaciones(); renderProcesos();
}
function saveCentro(){ const it=cur(); if(!it) return; it.nombre=$('#cNombre').value.trim(); it.delegado=$('#cDelegado').value.trim(); it.audiologo=$('#cAudiologo').value.trim(); it.tipo=$('#cTipo').value; saveCloudOrLocal(); renderLeft(); }
$('#saveCentroTop').onclick=saveCentro;

function renderAcciones(){ const it=cur(); it.acciones=it.acciones||[]; const cont=$('#accionesRows'); cont.innerHTML='';
  it.acciones.forEach((r,i)=>{const row=document.createElement('div'); row.className='va-row'; row.style.gridTemplateColumns='52px 130px 1fr 110px 110px 110px 150px 52px';
    row.innerHTML=`<div>${i+1}</div><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">
    <input data-i="${i}" data-k="tipo" value="${esc(r.tipo||'')}">
    <select data-i="${i}" data-k="paquete"><option ${r.paquete==='1'?'selected':''}>1</option><option ${r.paquete==='2'?'selected':''}>2</option><option ${r.paquete==='3'?'selected':''}>3</option></select>
    <input type="number" min="0" step="1" data-i="${i}" data-k="derivacion" value="${r.derivacion??''}">
    <input type="number" min="0" step="1" data-i="${i}" data-k="citas" value="${r.citas??''}">
    <input type="number" min="0" step="1" data-i="${i}" data-k="venta" value="${r.venta??''}">
    <button class="ico-btn" data-del="${i}">🗑️</button>`; cont.appendChild(row);});
  const add=document.createElement('div'); add.className='va-row'; add.style.gridTemplateColumns='52px 130px 1fr 110px 110px 110px 150px 52px';
  add.innerHTML=`<div>${it.acciones.length+1}</div><input type="date" data-new="1" data-k="fecha"><input data-new="1" data-k="tipo">
  <select data-new="1" data-k="paquete"><option>1</option><option>2</option><option>3</option></select>
  <input type="number" data-new="1" data-k="derivacion"><input type="number" data-new="1" data-k="citas"><input type="number" data-new="1" data-k="venta"><span></span>`;
  cont.appendChild(add);
}
$('#accionesRows').addEventListener('click',e=>{const i=e.target.dataset.del; if(i!=null){cur().acciones.splice(+i,1); renderAcciones(); saveCloudOrLocal();}});
$('#accionesRows').addEventListener('input',e=>{
  const i=e.target.dataset.i, k=e.target.dataset.k, isNew=e.target.dataset.new;
  if(!k) return;
  if(isNew){ const r={fecha:'',tipo:'',paquete:'1',derivacion:null,citas:null,venta:null}; r[k]=e.target.type==='number'?(e.target.value===''?null:Number(e.target.value)):e.target.value; cur().acciones.push(r); renderAcciones(); saveCloudOrLocal(); return; }
  const r=cur().acciones[+i]; r[k]=e.target.type==='number'?(e.target.value===''?null:Number(e.target.value)):e.target.value; saveCloudOrLocal();
});

function renderFormaciones(){ const it=cur(); it.formaciones=it.formaciones||[]; const cont=$('#formacionesRows'); cont.innerHTML='';
  it.formaciones.forEach((r,i)=>{const row=document.createElement('div'); row.className='va-row'; row.style.gridTemplateColumns='52px 1.2fr .7fr .7fr 1.4fr 52px';
    row.innerHTML=`<div>${i+1}</div><input data-i="${i}" data-k="curso" value="${esc(r.curso||'')}"><input type="checkbox" data-i="${i}" data-k="realizado" ${r.realizado?'checked':''}><input type="checkbox" data-i="${i}" data-k="aplica" ${r.aplica?'checked':''}><input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}"><button class="ico-btn" data-delf="${i}">🗑️</button>`; cont.appendChild(row);});
  const add=document.createElement('div'); add.className='va-row'; add.style.gridTemplateColumns='52px 1.2fr .7fr .7fr 1.4fr 52px';
  add.innerHTML=`<div>${it.formaciones.length+1}</div><input data-new="1" data-k="curso"><input type="checkbox" data-new="1" data-k="realizado"><input type="checkbox" data-new="1" data-k="aplica"><input data-new="1" data-k="obs"><span></span>`; cont.appendChild(add);
}
$('#formacionesRows').addEventListener('click',e=>{const i=e.target.dataset.delf; if(i!=null){cur().formaciones.splice(+i,1); renderFormaciones(); saveCloudOrLocal();}});
$('#formacionesRows').addEventListener('input',e=>{
  const i=e.target.dataset.i,k=e.target.dataset.k,isNew=e.target.dataset.new;if(!k)return;
  if(isNew){const r={curso:'',realizado:false,aplica:false,obs:''};r[k]=e.target.type==='checkbox'?e.target.checked:e.target.value;cur().formaciones.push(r);renderFormaciones();saveCloudOrLocal();return;}
  const r=cur().formaciones[+i]; r[k]=e.target.type==='checkbox'?e.target.checked:e.target.value; saveCloudOrLocal();
});

function renderProcesos(){ const it=cur(); it.procesos=it.procesos||[]; const cont=$('#procesosRows'); cont.innerHTML='';
  const color=v=>{const n=Number(v); if(!Number.isFinite(n)) return ''; return n>=95?'good':(n>=85?'':'bad');}
  it.procesos.forEach((r,i)=>{const row=document.createElement('div'); row.className='va-row'; row.style.gridTemplateColumns='52px 220px 120px 160px 52px';
    row.innerHTML=`<div>${i+1}</div><input class="pscore ${color(r.puntuacion)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="puntuacion" value="${r.puntuacion??''}"><input type="checkbox" data-i="${i}" data-k="hit" ${r.hit?'checked':''}><input type="checkbox" data-i="${i}" data-k="colaboraciones" ${r.colaboraciones?'checked':''}><button class="ico-btn" data-delp="${i}">🗑️</button>`; cont.appendChild(row);});
  const add=document.createElement('div'); add.className='va-row'; add.style.gridTemplateColumns='52px 220px 120px 160px 52px';
  add.innerHTML=`<div>${it.procesos.length+1}</div><input class="pscore" type="number" min="0" max="100" step="1" data-new="1" data-k="puntuacion"><input type="checkbox" data-new="1" data-k="hit"><input type="checkbox" data-new="1" data-k="colaboraciones"><span></span>`; cont.appendChild(add);
}
$('#procesosRows').addEventListener('click',e=>{const i=e.target.dataset.delp; if(i!=null){cur().procesos.splice(+i,1); renderProcesos(); saveCloudOrLocal();}});
$('#procesosRows').addEventListener('input',e=>{
  const i=e.target.dataset.i,k=e.target.dataset.k,isNew=e.target.dataset.new;if(!k)return;
  if(isNew){const r={puntuacion:null,hit:false,colaboraciones:false}; r[k]=e.target.type==='checkbox'?e.target.checked:(e.target.value===''?null:Number(e.target.value)); cur().procesos.push(r); renderProcesos(); saveCloudOrLocal(); return;}
  const r=cur().procesos[+i]; r[k]=e.target.type==='checkbox'?e.target.checked:(e.target.value===''?null:Number(e.target.value)); if(k==='puntuacion'){e.target.className='pscore '+(Number(r[k])>=95?'good':(Number(r[k])>=85?'':'bad'));} saveCloudOrLocal();
});

/* ======= VISITAS ======= */
function fillVisitas(){const it=cur(); if(!it) return; $('#vaRol').value=it.rol||'Delegado audio'; $('#vaResp').value=it.responsable||''; $('#vaSearch').value=state.vaFilter||''; renderVaTabs(); renderVA();}
$('#vaRol').onchange=e=>{cur().rol=e.target.value; saveCloudOrLocal(); renderLeft();};
$('#vaResp').oninput=e=>{cur().responsable=e.target.value; saveCloudOrLocal(); renderLeft();};
$('#vaSearch').oninput=e=>{state.vaFilter=e.target.value.trim(); renderVA();};
function renderVaTabs(){const it=cur(); const tabs=$('#vaTabs'); tabs.innerHTML=''; it.hojas=it.hojas||[sheetVA('Visita 1')];
  it.hojas.forEach((h,idx)=>{const b=document.createElement('button'); b.className='sec-btn'; b.textContent=h.nombre||('Visita '+(idx+1)); if(idx===state.vaSheet) b.style.background='#f1f1f1'; b.onclick=()=>{state.vaSheet=idx; renderVA();}; tabs.appendChild(b);});
  const add=document.createElement('button'); add.className='sec-btn'; add.textContent='＋'; add.title='Añadir visita'; add.onclick=()=>{it.hojas.push(sheetVA('Visita '+(it.hojas.length+1))); state.vaSheet=it.hojas.length-1; saveCloudOrLocal(); renderVaTabs(); renderVA();}; tabs.appendChild(add);
}
function vClass80(v){const n=Number(v); if(!Number.isFinite(n)) return ''; return n>=80?'good':'bad';}
function vScore85(v){const n=Number(v); if(!Number.isFinite(n)) return ''; return n>=85?'good':'bad';}
function renderVA(){const it=cur(); const h=it.hojas[state.vaSheet]||it.hojas[0]; const f=(state.vaFilter||'').toLowerCase(); const cont=$('#vaRows'); cont.innerHTML='';
  h.rows.forEach((r,i)=>{if(f && !(r.centro||'').toLowerCase().includes(f)) return; const row=document.createElement('div'); row.className='va-row va-cols';
    row.innerHTML=`<div>${i+1}</div><input data-i="${i}" data-k="centro" value="${esc(r.centro||'')}"><input data-i="${i}" data-k="delegado" value="${esc(r.delegado||'')}"><input data-i="${i}" data-k="audiologo" value="${esc(r.audiologo||'')}"><select data-i="${i}" data-k="tipo"><option ${r.tipo==='Sucursal'?'selected':''}>Sucursal</option><option ${r.tipo==='Franquicia'?'selected':''}>Franquicia</option></select><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}"><input class="pscore ${vScore85(r.puntuacion)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="puntuacion" value="${r.puntuacion??''}"><input type="checkbox" data-i="${i}" data-k="hit" ${r.hit?'checked':''}><input class="conv ${vClass80(r.conv_prueba)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="conv_prueba" value="${r.conv_prueba??''}"><input class="conv ${vClass80(r.conv_venta)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="conv_venta" value="${r.conv_venta??''}">`; cont.appendChild(row);});
}
$('#vaRows').addEventListener('input',e=>{
  const i=+e.target.dataset.i, k=e.target.dataset.k; if(!k) return;
  const h=cur().hojas[state.vaSheet]; if(e.target.type==='checkbox') h.rows[i][k]=e.target.checked;
  else if(e.target.type==='number') h.rows[i][k]=e.target.value===''?null:Number(e.target.value);
  else h.rows[i][k]=e.target.value; saveCloudOrLocal();
});
$('#saveVisitasTop').onclick=saveCloudOrLocal;

/* ======= FORMACIONES ======= */
function fillFM(){const it=cur(); if(!it) return; $('#fmDelegado').value=it.delegado||''; $('#fmSearch').value=state.fmFilter||''; renderFM();}
$('#fmDelegado').oninput=e=>{cur().delegado=e.target.value; saveCloudOrLocal(); renderLeft();};
$('#fmSearch').oninput=e=>{state.fmFilter=e.target.value.trim(); renderFM();};
function renderFM(){const it=cur(); it.filas=it.filas||rowsFM(); const f=(state.fmFilter||'').toLowerCase(); const cont=$('#fmRows'); cont.innerHTML='';
  it.filas.forEach((r,i)=>{const ok=!f||(r.tema||'').toLowerCase().includes(f)||(r.audiologo||'').toLowerCase().includes(f); if(!ok) return;
    const evoP=(Number.isFinite(+r.p_ini)&&Number.isFinite(+r.p_3m))?(Number(r.p_3m)-Number(r.p_ini)):null;
    const evoV=(Number.isFinite(+r.v_ini)&&Number.isFinite(+r.v_3m))?(Number(r.v_3m)-Number(r.v_ini)):null;
    const row=document.createElement('div'); row.className='fm-row';
    row.innerHTML=`<div>${i+1}</div><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}"><input data-i="${i}" data-k="tema" value="${esc(r.tema||'')}"><input data-i="${i}" data-k="audiologo" value="${esc(r.audiologo||'')}"><select data-i="${i}" data-k="duracion">${[1,2,3,4].map(n=>`<option ${Number(r.duracion)===n?'selected':''}>${n}</option>`).join('')}</select><input class="conv ${(Number(r.p_ini)>=80)?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="p_ini" value="${r.p_ini??''}"><input class="conv ${(Number(r.v_ini)>=80)?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="v_ini" value="${r.v_ini??''}"><input class="conv ${(Number(r.p_3m)>=80)?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="p_3m" value="${r.p_3m??''}"><input class="conv ${(Number(r.v_3m)>=80)?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="v_3m" value="${r.v_3m??''}"><div style="text-align:center;font-weight:700">${evoP==null?'—':(evoP>0?'↑ ':'')+(evoP<0?'↓ ':'')+Math.abs(Math.round(evoP))}</div><div style="text-align:center;font-weight:700">${evoV==null?'—':(evoV>0?'↑ ':'')+(evoV<0?'↓ ':'')+Math.abs(Math.round(evoV))}</div>`; cont.appendChild(row);
  });
}
$('#fmRows').addEventListener('input',e=>{
  const i=+e.target.dataset.i,k=e.target.dataset.k; if(!k)return;
  const it=cur(); if(e.target.type==='number') it.filas[i][k]=e.target.value===''?null:Number(e.target.value);
  else if(e.target.tagName==='SELECT') it.filas[i][k]=Number(e.target.value);
  else it.filas[i][k]=e.target.value; saveCloudOrLocal();
});
$('#saveFMTop').onclick=saveCloudOrLocal;

/* ======= TELE ======= */
function fillTA(){ $('#taSearch').value=state.taFilter||''; populateTASelect(); renderTA(); }
function populateTASelect(){ const it=cur(); const h=(it.hojas&&it.hojas[0])||sheetTA('Tele 1'); it.hojas=it.hojas||[h];
  const names=[...new Set(h.rows.map(r=>(r.persona||'').trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  $('#taPerson').innerHTML='<option value="">Todos</option>'+names.map(n=>`<option>${esc(n)}</option>`).join('');
}
$('#taSearch').oninput=e=>{state.taFilter=e.target.value.trim(); renderTA();};
$('#taPerson').onchange=e=>{state.taPerson=e.target.value; renderTA();};
function renderTA(){ const it=cur(); const h=it.hojas[0]; const f=(state.taFilter||'').toLowerCase(); const per=state.taPerson||''; const cont=$('#taRows'); cont.innerHTML='';
  h.rows.forEach((r,i)=>{ if((f && !(r.centro||'').toLowerCase().includes(f) && !(r.persona||'').toLowerCase().includes(f)) || (per && (r.persona||'')!==per)) return;
    const row=document.createElement('div'); row.className='ta-row'; row.style.gridTemplateColumns='52px 1.2fr 160px 150px 180px 110px 110px 130px 130px 140px';
    row.innerHTML=`<div>${i+1}</div><input data-i="${i}" data-k="centro" value="${esc(r.centro||'')}"><input data-i="${i}" data-k="delegado" value="${esc(r.delegado||'')}"><select data-i="${i}" data-k="rol"><option ${r.rol!=='Técnico'?'selected':''}>Audiólogo</option><option ${r.rol==='Técnico'?'selected':''}>Técnico</option></select><input data-i="${i}" data-k="persona" value="${esc(r.persona||'')}" placeholder="Nombre"><input type="checkbox" data-i="${i}" data-k="formacion" ${r.formacion?'checked':''}><input type="checkbox" data-i="${i}" data-k="practicas" ${r.practicas?'checked':''}><input type="checkbox" data-i="${i}" data-k="certificado" ${r.certificado?'checked':''}><input type="number" min="0" step="1" data-i="${i}" data-k="pruebas_reales" value="${r.pruebas_reales??''}"><input type="number" min="0" step="1" data-i="${i}" data-k="ventas" value="${r.ventas??''}">`; cont.appendChild(row);
  });
}
$('#taRows').addEventListener('input',e=>{
  const i=+e.target.dataset.i,k=e.target.dataset.k;if(!k)return;
  const h=cur().hojas[0]; if(e.target.type==='checkbox') h.rows[i][k]=e.target.checked;
  else if(e.target.type==='number') h.rows[i][k]=e.target.value===''?null:Number(e.target.value);
  else h.rows[i][k]=e.target.value; saveCloudOrLocal();
});
$('#saveTATop').onclick=saveCloudOrLocal;

/* ======= EQUIPOS ======= */
function fillEQ(){ $('#eqSearch').value=state.eqFilter||''; renderEQ(); }
$('#eqSearch').oninput=e=>{state.eqFilter=e.target.value.trim(); renderEQ();};
$('#btnAddFila').onclick=()=>{ const it=cur(); it.filas.push({equipo:'',serie:'',persona:'',fecha:'',pares:Array.from({length:it.columnas},()=>({centro:'',sede:false}))}); renderEQ(); saveCloudOrLocal(); };
$('#btnAddParCols').onclick=()=>{ const it=cur(); it.columnas=(it.columnas||3)+1; it.filas.forEach(r=>r.pares.push({centro:'',sede:false})); renderEQ(); saveCloudOrLocal(); };

function renderEQ(){
  const it=cur(); const cols=Math.max(1,it.columnas||3); const f=(state.eqFilter||'').toLowerCase(); const root=$('#eqTable'); root.innerHTML='';
  const template=['52px','220px','160px','180px','130px'].concat(Array.from({length:cols},()=>['180px','110px']).flat()).join(' ');
  const head=document.createElement('div'); head.className='va-head'; head.style.gridTemplateColumns=template;
  head.innerHTML=`<div>#</div><div>Equipo</div><div>Nº serie</div><div>Persona que envía</div><div>Fecha</div>`+Array.from({length:cols},(_,i)=>`<div>Centro ${i+1}</div><div>Sede ${i+1}</div>`).join(''); root.appendChild(head);
  const body=document.createElement('div'); body.className='scroll'; root.appendChild(body);

  it.filas.forEach((r,i)=>{ const txt=(r.equipo||'')+' '+(r.serie||'')+' '+(r.persona||' ')+' '+(r.pares||[]).map(p=>(p.centro||'')+(p.sede?' Sede':'' )).join(' '); if(f && !txt.toLowerCase().includes(f)) return;
    const row=document.createElement('div'); row.className='va-row'; row.style.gridTemplateColumns=template;
    row.innerHTML=`<div>${i+1}</div>
      <input data-i="${i}" data-k="equipo" value="${esc(r.equipo||'')}">
      <input data-i="${i}" data-k="serie" value="${esc(r.serie||'')}">
      <input data-i="${i}" data-k="persona" value="${esc(r.persona||'')}">
      <input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">`+
      Array.from({length:cols},(_,c)=>`
        <input data-i="${i}" data-k="centro" data-c="${c}" value="${esc(r.pares?.[c]?.centro||'')}">
        <input type="checkbox" data-i="${i}" data-k="sede" data-c="${c}" ${r.pares?.[c]?.sede?'checked':''}>
      `).join('');
    body.appendChild(row);
  });

  body.addEventListener('input',e=>{
    const i=+e.target.dataset.i,k=e.target.dataset.k; if(isNaN(i)||!k) return;
    if(k==='centro'||k==='sede'){ const c=+e.target.dataset.c; const p=cur().filas[i].pares[c]; if(k==='centro') p.centro=e.target.value; else p.sede=e.target.checked; }
    else cur().filas[i][k]= e.target.value;
    saveCloudOrLocal();
  });
}
$('#saveEQTop').onclick=saveCloudOrLocal;

/* ======= Topbar ======= */
$('#btnSaveTop').onclick=saveCloudOrLocal; $('#btnFetch').onclick=fetchCloudOrLocal; $('#btnReset').onclick=resetLocalView;

/* ======= PIN (siempre) ======= */
function tryEnter(){
  const val=(($('#pin').value)||'').trim();
  const ok = val.toLowerCase() === (PIN_CODE||'').toLowerCase();
  if(ok){ document.getElementById('gate').style.display='none'; }
  else { document.getElementById('pinMsg').style.display='block'; }
}
$('#enter').onclick=tryEnter;
$('#pin').addEventListener('keydown',e=>{ if(e.key==='Enter') tryEnter(); });
$('#cancelPin').onclick=()=>{ $('#pin').value=''; $('#pinMsg').style.display='none'; };

/* ======= Init ======= */
function renderAll(){ renderLeft(); if(state.selected.section) renderDetail(); else renderDetailBlank(); }
window.addEventListener('load',()=>{
  localLoad();           // siempre tenemos un respaldo local
  initFirebase();        // opcional (si no hay claves, se queda en local)
  renderAll();
  $('#stamp').textContent='Listo: '+now();
  if(REQUIRE_PIN){ $('#gate').style.display='flex'; $('#pin').focus(); }
});
</script>
</body>
</html>
