<!-- === AudioSeguimiento ‚Äì Cloud Sync TODO EN UNO (Pegar antes de </body>) === -->
<script type="module">
  /********************************************************************
   * ‚úÖ TODO EN UNO, LISTO PARA PEGAR
   * - Funciona SIN editar el c√≥digo: te pedir√° pegar tu Firebase config
   *   una sola vez y la guardar√° en localStorage.
   * - Mantiene tu edici√≥n original (no rompe tus eventos/JS).
   * - Sincroniza SOLO elementos [data-cloud] (o #notas si existe).
   * - PIN fijo: AR4321 ‚Üí docId = SHA-256(PIN).
   * - Barra flotante: Guardar nube / Actualizar + √öltima actualizaci√≥n.
   ********************************************************************/

  // ======= IMPORTS DEL SDK (CDN OFICIAL) =======
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

  // ======= CONSTANTES =======
  const PIN = "AR4321";
  const CFG_KEY = 'audioseguimiento_firebase_config'; // donde se guarda tu config

  // ======= UTILIDADES =======
  async function sha256Hex(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  function isConfigured(cfg){
    if (!cfg || typeof cfg !== 'object') return false;
    const req = ['apiKey','authDomain','projectId'];
    return req.every(k => typeof cfg[k]==='string' && cfg[k].length>0);
  }

  // ======= UI: BARRA FLOTANTE + PREVIEW + CONFIGURADOR =======
  const bar = document.createElement('div');
  Object.assign(bar.style,{
    position:'fixed',right:'12px',bottom:'12px',zIndex:2147483647,
    background:'rgba(0,0,0,0.80)',color:'#fff',padding:'8px 10px',
    borderRadius:'12px',fontFamily:'system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif',
    boxShadow:'0 6px 18px rgba(0,0,0,0.25)',display:'flex',gap:'8px',alignItems:'center',flexWrap:'wrap'
  });
  bar.innerHTML = `
    <strong style="font-weight:600">Cloud Sync</strong>
    <button id="cloud-save" style="padding:.4rem .6rem;border:0;border-radius:8px;cursor:pointer;">Guardar nube</button>
    <button id="cloud-load" style="padding:.4rem .6rem;border:0;border-radius:8px;cursor:pointer;">Actualizar</button>
    <span id="cloud-status" style="opacity:.95">‚è≥</span>
    <span id="cloud-last" style="opacity:.9">‚Äî</span>
    <button id="cloud-config" title="Configurar Firebase" style="padding:.2rem .5rem;border:0;border-radius:8px;cursor:pointer;background:#444;color:#fff;">‚öôÔ∏è</button>
  `;
  document.body.appendChild(bar);
  const btnSave = bar.querySelector('#cloud-save');
  const btnLoad = bar.querySelector('#cloud-load');
  const btnCfg  = bar.querySelector('#cloud-config');
  const elStatus = bar.querySelector('#cloud-status');
  const elLast   = bar.querySelector('#cloud-last');

  const pre = document.createElement('pre');
  Object.assign(pre.style,{
    position:'fixed',left:'12px',bottom:'12px',maxWidth:'40vw',maxHeight:'32vh',
    overflow:'auto',background:'rgba(255,255,255,0.96)',padding:'8px 10px',
    borderRadius:'12px',fontSize:'12px',boxShadow:'0 6px 18px rgba(0,0,0,0.15)',
    color:'#111',whiteSpace:'pre-wrap',zIndex:2147483646
  });
  pre.id='estado-previsualizacion';
  document.body.appendChild(pre);

  function setStatus(m){ elStatus.textContent = m; }
  function setLast(ts){
    if(!ts){ elLast.textContent='‚Äî'; return; }
    try{
      const d = ts?.toDate ? ts.toDate() : new Date(ts);
      elLast.textContent = `√öltima actualizaci√≥n: ${d.toLocaleString('es-ES')}`;
    }catch{ elLast.textContent='‚Äî'; }
  }
  function disableButtons(reason){
    btnSave.disabled = true; btnLoad.disabled = true;
    btnSave.style.opacity = .6; btnLoad.style.opacity = .6;
    setStatus(reason);
  }
  function enableButtons(){
    btnSave.disabled = false; btnLoad.disabled = false;
    btnSave.style.opacity = 1; btnLoad.style.opacity = 1;
  }

  // ======= SELECCI√ìN DE CAMPOS A SINCRONIZAR =======
  function getCloudElements(){
    const marked = Array.from(document.querySelectorAll('[data-cloud]'));
    if (marked.length > 0) return marked;
    const fallback = document.querySelector('#notas');
    return fallback ? [fallback] : [];
  }
  function readElementValue(el){
    if(el.tagName==='INPUT'){
      const t=(el.type||'text').toLowerCase();
      if(t==='checkbox') return !!el.checked;
      if(t==='radio') return el.checked ? el.value : null;
      return el.value;
    }
    if(el.tagName==='TEXTAREA'||el.tagName==='SELECT') return el.value;
    return el.textContent;
  }
  function writeElementValue(el,val){
    try{
      if(el.tagName==='INPUT'){
        const t=(el.type||'text').toLowerCase();
        if(t==='checkbox'){ el.checked=!!val; return; }
        if(t==='radio'){ el.checked=(val===el.value); return; }
        el.value=(val??'');
        el.dispatchEvent(new Event('input',{bubbles:true}));
        el.dispatchEvent(new Event('change',{bubbles:true}));
        return;
      }
      if(el.tagName==='TEXTAREA'||el.tagName==='SELECT'){
        el.value=(val??'');
        el.dispatchEvent(new Event('input',{bubbles:true}));
        el.dispatchEvent(new Event('change',{bubbles:true}));
        return;
      }
      if(typeof val==='string') el.textContent = val;
    }catch(e){ console.warn('No se pudo aplicar valor a', el, e); }
  }
  function collectState(){
    const els = getCloudElements();
    const state = {};
    els.forEach((el, i)=>{
      const key = el.id || el.name || `el_${i}`;
      const val = readElementValue(el);
      if (val !== null && key) state[key] = val;
    });
    const area = document.getElementById('estado-previsualizacion');
    if (area) area.textContent = JSON.stringify(state, null, 2);
    return state;
  }
  function applyState(state){
    if(!state || typeof state!=='object') return;
    Object.keys(state).forEach(k=>{
      let el = document.getElementById(k) || document.querySelector(`[name="${CSS.escape(k)}"]`);
      if(el) writeElementValue(el, state[k]);
    });
    const area = document.getElementById('estado-previsualizacion');
    if (area) area.textContent = JSON.stringify(state, null, 2);
  }

  // ======= CONFIGURACI√ìN (PEGAR UNA VEZ) =======
  function promptConfig(){
    const example = `{
  "apiKey": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "authDomain": "tuproyecto.firebaseapp.com",
  "projectId": "tuproyecto",
  "storageBucket": "tuproyecto.appspot.com",
  "messagingSenderId": "1234567890",
  "appId": "1:1234567890:web:abcdef123456"
}`;
    const msg = "Pega aqu√≠ tu Firebase config (JSON) tal como aparece en Project Settings > General > 'Tu app web' (</>):\\n\\nEjemplo:\\n" + example + "\\n\\nSe guardar√° en este navegador y se usar√° autom√°ticamente.";
    const txt = prompt(msg);
    if (!txt) return;
    try{
      const cfg = JSON.parse(txt);
      if(!isConfigured(cfg)) { alert("Config incompleta. Necesita apiKey, authDomain y projectId."); return; }
      localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
      alert("¬°Configuraci√≥n guardada! Recarga la p√°gina.");
      location.reload();
    }catch(e){
      alert("JSON inv√°lido. Intenta de nuevo.");
    }
  }
  btnCfg.addEventListener('click', promptConfig);

  // ======= ESTADO FIREBASE / FIRESTORE =======
  let app, db, docRef;

  async function init(){
    // 1) Leer config de localStorage (si no hay, pedirla y deshabilitar)
    let firebaseConfig = null;
    try{
      firebaseConfig = JSON.parse(localStorage.getItem(CFG_KEY) || 'null');
    }catch{ firebaseConfig = null; }

    if(!isConfigured(firebaseConfig)){
      disableButtons('‚ö†Ô∏è Haz clic en ‚öôÔ∏è para configurar Firebase');
      setLast(null);
      return; // a√∫n sin nube; la p√°gina sigue funcionando normal
    }

    // 2) Iniciar Firebase + Firestore
    try{
      app = initializeApp(firebaseConfig);
      db  = getFirestore(app);
    }catch(e){
      console.error('Error inicializando Firebase:', e);
      disableButtons('‚ùå Error de Firebase (revisa la config)');
      return;
    }

    // 3) Preparar docRef y suscripci√≥n
    enableButtons();
    setStatus('üîÑ Conectando‚Ä¶');
    const docId = await sha256Hex(PIN);
    docRef = doc(db, 'platformStates', docId);

    onSnapshot(docRef, (snap)=>{
      if(snap.exists()){
        const data = snap.data();
        setLast(data.lastUpdated);
        if (data?.state){
          applyState(data.state);
          setStatus('‚úÖ Sincronizado');
        } else {
          setStatus('‚ÑπÔ∏è Documento vac√≠o');
        }
      } else {
        setLast(null);
        setStatus('‚ûï Sin datos en la nube');
      }
    }, (err)=>{
      console.error(err);
      setStatus('‚ö†Ô∏è Error de escucha');
    });
  }

  async function saveToCloud(){
    try{
      if(!docRef) throw new Error('Firestore no inicializado');
      setStatus('üíæ Guardando‚Ä¶');
      const state = collectState();
      await setDoc(docRef, { state, lastUpdated: serverTimestamp(), updatedBy:'web' }, { merge:true });
      setStatus('‚úÖ Guardado');
      localStorage.setItem('audioseguimiento_backup', JSON.stringify({ when: Date.now(), state }));
    }catch(e){
      console.error(e);
      setStatus('‚ùå Error al guardar');
      alert('Error guardando. Revisa la configuraci√≥n y las reglas de Firestore.');
    }
  }

  async function loadFromCloud(){
    try{
      if(!docRef) throw new Error('Firestore no inicializado');
      setStatus('‚¨áÔ∏è Actualizando‚Ä¶');
      const snap = await getDoc(docRef);
      if(snap.exists()){
        const data = snap.data();
        setLast(data.lastUpdated);
        if (data?.state){
          applyState(data.state);
          setStatus('‚úÖ Actualizado');
        } else {
          setStatus('‚ÑπÔ∏è Documento vac√≠o');
        }
      } else {
        setLast(null);
        setStatus('‚ûï No existe estado a√∫n');
      }
    }catch(e){
      console.error(e);
      setStatus('‚ùå Error al actualizar');
      alert('Error actualizando. Revisa la configuraci√≥n y las reglas de Firestore.');
    }
  }

  // Eventos
  btnSave.addEventListener('click', saveToCloud);
  btnLoad.addEventListener('click', loadFromCloud);

  // Iniciar
  init();

  /********************************************************************
   * REGLAS DE FIRESTORE (para probar r√°pidamente):
   * rules_version = '2';
   * service cloud.firestore {
   *   match /databases/{database}/documents {
   *     match /platformStates/{docId} {
   *       allow read, write: if true;
   *     }
   *   }
   * }
   * Luego, para producci√≥n, usa Firebase Auth + reglas estrictas.
   ********************************************************************/
</script>
