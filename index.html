<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>SEGUIMIENTO AUDIO · Local</title>
<meta name="theme-color" content="#c82727"/>
<style>
:root{--rojo:#c82727;--rojo2:#a71f1f;--line:#e8e8ee;--bg:#f6f7fb;--sh:0 4px 14px rgba(0,0,0,.06);
--col-ex:#fde2e4;--col-fl:#e2f0cb;--col-va:#cde7f0;--col-fm:#f9e5c9;--col-ta:#eadcf8;--col-eq:#e8f1ff;--col-sv:#ffe9cc;--fs:12px;--fs-sm:11px}
*{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;font-size:var(--fs)}
.topbar{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,var(--rojo),var(--rojo2));box-shadow:var(--sh)}
.topbar .inner{display:grid;grid-template-columns:1fr auto 1fr;gap:.6rem;align-items:center;padding:.9rem .8rem}
.brand{justify-self:center;display:flex;gap:.6rem;align-items:center;color:#fff;font-weight:900}
.brand i{font-style:normal;font-size:20px}.brand span{font-size:22px}
.actions{justify-self:start;display:flex;gap:.35rem}.actions button{background:#fff;border:0;border-radius:9px;padding:.42rem .75rem;font-weight:800;cursor:pointer;box-shadow:var(--sh)}
.meta{justify-self:end;color:#fff;font-weight:700;opacity:.9}
.wrapper{display:grid;grid-template-columns:210px minmax(0,1fr);gap:8px;padding:8px}
.sidebar{display:flex;flex-direction:column;gap:8px}
.side-card{border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--sh);overflow:hidden}
.side-card .head{display:flex;justify-content:space-between;align-items:center;padding:.48rem .6rem;font-weight:900}
.side-card .list{padding:.25rem .45rem .5rem;max-height:220px;overflow:auto}
.side-card .item{display:flex;justify-content:space-between;align-items:center;gap:.35rem;padding:.32rem .38rem;margin:.22rem 0;border:1px solid var(--line);border-radius:9px;background:#fff}
.side-card .item .name{font-weight:750}.side-card .btn{width:26px;height:22px;border:1px solid var(--line);border-radius:7px;background:#fff;cursor:pointer}
.detail{border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--sh);min-height:70vh;padding:.6rem}
.detail .hdr{display:flex;gap:.6rem;align-items:center;margin:.2rem 0 .4rem}.detail .hdr h2{margin:0;font-size:18px}.badge{padding:.12rem .52rem;border-radius:999px;background:#0001}
.table{border:1px solid var(--line);border-radius:10px;overflow:auto}.xscroll{overflow:auto}
.grid{display:grid;gap:1px;background:var(--line)} .grid>div{background:#fff;padding:.35rem .4rem} .grid .head{background:#f7f8ff;font-weight:800}
.num,.txt,.date,.sel{width:100%;border:1px solid var(--line);border-radius:6px;padding:.28rem .35rem;font-size:var(--fs-sm)}
.ok{background:#eaf9f0!important;border:1px solid #bfe3cd}.bad{background:#ffe9e9!important;border:1px solid #f4c7c7}
.gate{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:100}
.card{background:#111;color:#fff;min-width:280px;border-radius:12px;border:1px solid #2a2a2a;padding:14px 12px;box-shadow:var(--sh)}
.card h3{margin:.1rem 0 .5rem}.pin{width:100%;letter-spacing:.35rem;font-size:1rem;text-align:center;background:#000;color:#fff;border:1px solid #444;border-radius:8px;padding:.42rem}
.btnRow{display:flex;gap:.45rem;margin-top:10px}.btnDark{flex:1;background:#fff;border:0;color:#111;font-weight:900;border-radius:10px;padding:.45rem .8rem;cursor:pointer}
.btnGhost{flex:.9;background:transparent;color:#fff;border:1px solid #ffffff55;border-radius:10px;padding:.45rem .8rem;cursor:pointer}
.msg{color:#ff8080;display:none;margin-top:.4rem}
</style>
</head>
<body>
<header class="topbar"><div class="inner">
  <div class="actions"><button id="btnLoad">Actualizar (local)</button><button id="btnSave">Guardar (local)</button></div>
  <div class="brand"><i>🎧</i><span>SEGUIMIENTO AUDIO</span></div>
  <div id="stamp" class="meta">Listo</div>
</div></header>

<main class="wrapper">
  <aside class="sidebar">
    <!-- CIFRA DE VENTAS -->
    <div class="side-card" style="background:var(--col-sv)">
      <div class="head">📊 CIFRA DE VENTAS</div>
      <div class="list" id="svList">
        <div class="item">
          <div class="name">🏢 Compañía</div>
          <div><button class="btn" id="svOpenCompany" title="Abrir panel compañía">➡️</button></div>
        </div>
        <div class="item">
          <div class="name">🏬 Centros exclusivos</div>
          <div><button class="btn" id="svOpenCenters" title="Abrir panel centros exclusivos">➡️</button></div>
        </div>
      </div>
    </div>

    <!-- Resto (placeholders para mantener estructura) -->
    <div class="side-card" style="background:var(--col-ex)"><div class="head">📒 CENTROS EXCLUSIVOS<div></div></div><div class="list" id="ceList"></div></div>
    <div class="side-card" style="background:var(--col-fl)"><div class="head">📒 CENTROS FLOP<div></div></div><div class="list" id="flList"></div></div>
    <div class="side-card" style="background:var(--col-va)"><div class="head">📋 VISITAS AUDIO<div></div></div><div class="list"><div class="item"><div class="name">(Responsable Tec. Audio) —</div></div></div></div>
    <div class="side-card" style="background:var(--col-fm)"><div class="head">🎓 FORMACIONES Y MENTORING<div><button class="btn" id="btnShowMent">🧭</button></div></div><div class="list" id="fmList"></div></div>
    <div class="side-card" style="background:var(--col-ta)"><div class="head">📡 TELEAUDIOLOGIA<div></div></div><div class="list" id="taList"></div></div>
    <div class="side-card" style="background:var(--col-eq)"><div class="head">🧰 EQUIPOS<div><button class="btn" id="eqAdd">＋</button></div></div><div class="list"><div class="item"><div class="name">Inventario de equipos</div></div></div></div>
  </aside>

  <section class="detail">
    <div class="hdr"><h2 id="detTitle">Detalle</h2><span id="detTag" class="badge">—</span></div>

    <!-- Panel: CIFRA VENTAS · Compañía -->
    <div id="panelSalesCompany" style="display:none" class="table xscroll"><div class="grid" id="gridSalesCompany"></div></div>

    <!-- Panel: CIFRA VENTAS · Centros exclusivos -->
    <div id="panelSalesCenters"  style="display:none">
      <div class="table xscroll">
        <div class="grid" id="gridSalesCenters"></div>
      </div>
      <div class="tools"><button class="btn" id="svCentersAdd">＋ Añadir fila</button></div>
    </div>

    <!-- Panel: Mentoring general -->
    <div id="panelMentoring"     style="display:none" class="table xscroll"><div class="grid" id="gridMentoring"></div></div>

    <div id="panelPlaceholder" style="opacity:.7">Selecciona una sección en el lateral.</div>
  </section>
</main>

<!-- Gate -->
<div class="gate" id="gate">
  <div class="card">
    <h3>Acceso</h3>
    <p>Introduce el PIN para editar:</p>
    <input id="pin" class="pin" type="password" inputmode="numeric" maxlength="6" placeholder="••••"/>
    <div class="btnRow"><button class="btnDark" id="enter">Entrar</button><button class="btnGhost" id="clearPin">Limpiar</button></div>
    <p id="pinMsg" class="msg">PIN incorrecto</p>
  </div>
</div>

<script>
/* ---------- Datos ---------- */
const MONTHS_25_26=['Ago-2025','Sep-2025','Oct-2025','Nov-2025','Dic-2025','Ene-2026','Feb-2026','Mar-2026','Abr-2026','May-2026','Jun-2026','Jul-2026'];
const LSKEY='seguimiento_audio_vlocal_v2';
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const money=v=>isFinite(+v)?(+v).toLocaleString('es-ES'):'';
let state={sales:{company:MONTHS_25_26.map(m=>({mes:m,previsto:null,cv:null})),centers:[/* {centro:'',mes:null,previsto:null} */]},mentoring:[]};

/* ---------- Persistencia ---------- */
function stamp(t){ const s=$('#stamp'); if(s) s.textContent=t+' · '+new Date().toLocaleString(); }
function save(){ localStorage.setItem(LSKEY, JSON.stringify(state)); stamp('Guardado local'); }
function load(){ try{ const raw=localStorage.getItem(LSKEY); if(raw) state=JSON.parse(raw);}catch{} stamp('Cargado local'); }

/* ---------- Apertura / Paneles ---------- */
function openPanel(which){
  $('#panelPlaceholder').style.display='none';
  $('#panelSalesCompany').style.display=(which==='company')?'block':'none';
  $('#panelSalesCenters').style.display=(which==='centers')?'block':'none';
  $('#panelMentoring').style.display=(which==='mentoring')?'block':'none';
  if(which==='company'){ $('#detTitle').textContent='Detalle — Cifra de ventas (Compañía)'; $('#detTag').textContent='CIFRA DE VENTAS'; renderSalesCompany(); }
  if(which==='centers'){ $('#detTitle').textContent='Detalle — Cifra de ventas (Centros exclusivos)'; $('#detTag').textContent='CIFRA DE VENTAS'; renderSalesCenters(); }
  if(which==='mentoring'){ $('#detTitle').textContent='Detalle — Mentoring general'; $('#detTag').textContent='FORMACIONES Y MENTORING'; renderMentoring(); }
}

/* ---------- Compañía ---------- */
function renderSalesCompany(){
  const g=$('#gridSalesCompany'); g.innerHTML=''; g.style.gridTemplateColumns='180px 140px 140px 120px 120px';
  ['Mes','Previsto (€)','CV mes (€)','Dif.','Estado'].forEach(h=>{const d=document.createElement('div');d.className='head';d.textContent=h;g.appendChild(d);});
  let totP=0, totC=0;
  state.sales.company.forEach(r=>{
    const dM=document.createElement('div'); dM.textContent=r.mes; g.appendChild(dM);
    const p=document.createElement('input'); p.type='number'; p.className='num'; p.step='0.01'; p.value=r.previsto??''; p.oninput=()=>{r.previsto=p.value===''?null:+p.value; paint(); save();}; g.appendChild(p);
    const c=document.createElement('input'); c.type='number'; c.className='num'; c.step='0.01'; c.value=r.cv??''; c.oninput=()=>{r.cv=c.value===''?null:+c.value; paint(); save();}; g.appendChild(c);
    const d=document.createElement('div'); g.appendChild(d);
    const e=document.createElement('div'); g.appendChild(e);
    function paint(){ const pv=+r.previsto||0, cv=+r.cv||0; d.textContent=money(cv-pv); e.textContent=cv>=pv?'OK':'Bajo'; c.classList.remove('ok','bad'); if(!isNaN(pv)&&!isNaN(cv)) c.classList.add(cv>=pv?'ok':'bad'); drawTotals(); }
    function drawTotals(){ const olds=$$('#gridSalesCompany .totline'); olds.forEach(x=>x.remove()); totP=state.sales.company.reduce((s,x)=>s+(+x.previsto||0),0); totC=state.sales.company.reduce((s,x)=>s+(+x.cv||0),0);
      ['TOTAL',money(totP),money(totC),money(totC-totP),totC>=totP?'OK':'Bajo'].forEach((t,ix)=>{const dd=document.createElement('div');dd.className='totline head';dd.textContent=t;g.appendChild(dd);});
    }
    paint();
  });
}

/* ---------- Centros exclusivos ---------- */
function renderSalesCenters(){
  const g=$('#gridSalesCenters'); g.innerHTML='';
  // Columnas: Centro, Mes, Previsto, Diferencia
  g.style.gridTemplateColumns='1.6fr 140px 140px 120px';
  ['Centro','Mes (€)','Previsto (€)','Diferencia'].forEach(h=>{const d=document.createElement('div');d.className='head';d.textContent=h;g.appendChild(d);});

  let totMes=0, totPrev=0;

  state.sales.centers.forEach((r,idx)=>{
    const c=document.createElement('input'); c.className='txt'; c.value=r.centro||''; c.oninput=()=>{r.centro=c.value; save();}; g.appendChild(c);

    const m=document.createElement('input'); m.type='number'; m.step='0.01'; m.className='num'; m.value=r.mes??''; 
    m.oninput=()=>{r.mes=m.value===''?null:+m.value; paint(); save();}; g.appendChild(m);

    const p=document.createElement('input'); p.type='number'; p.step='0.01'; p.className='num'; p.value=r.previsto??''; 
    p.oninput=()=>{r.previsto=p.value===''?null:+p.value; paint(); save();}; g.appendChild(p);

    const d=document.createElement('div'); g.appendChild(d);

    function paint(){
      const mv=+r.mes||0, pv=+r.previsto||0;
      d.textContent = money(mv-pv);
      m.classList.remove('ok','bad');
      if(!isNaN(mv)&&!isNaN(pv)) m.classList.add(mv>=pv?'ok':'bad');
      drawTotals();
    }
    paint();
  });

  function drawTotals(){
    const olds=$$('#gridSalesCenters .totline'); olds.forEach(x=>x.remove());
    totMes = state.sales.centers.reduce((s,x)=>s+(+x.mes||0),0);
    totPrev= state.sales.centers.reduce((s,x)=>s+(+x.previsto||0),0);
    ['TOTAL', money(totMes), money(totPrev), money(totMes-totPrev)].forEach((t,ix)=>{
      const dd=document.createElement('div'); dd.className='totline head'; dd.textContent=t; g.appendChild(dd);
    });
  }

  // botón añadir fila (a la derecha)
  $('#svCentersAdd').onclick=()=>{ state.sales.centers.push({centro:'',mes:null,previsto:null}); renderSalesCenters(); save(); };

  // Asegura que siempre haya al menos 1 fila
  if(state.sales.centers.length===0){ state.sales.centers.push({centro:'',mes:null,previsto:null}); }
  // Forzar totales
  const ev=new Event('input'); const anyNum=g.querySelector('.num'); if(anyNum) anyNum.dispatchEvent(ev);
}

/* ---------- Mentoring general ---------- */
function renderMentoring(){
  const g=$('#gridMentoring'); g.innerHTML=''; g.style.gridTemplateColumns='140px 1.1fr 120px 1.6fr';
  ['Fecha','Tema','Asistencia','Observaciones'].forEach(h=>{const d=document.createElement('div');d.className='head';d.textContent=h;g.appendChild(d);});
  state.mentoring.forEach((r,idx)=>{
    const f=document.createElement('input'); f.type='date'; f.className='date'; f.value=r.fecha||''; f.oninput=()=>{r.fecha=f.value; save();}; g.appendChild(f);
    const t=document.createElement('input'); t.className='txt'; t.value=r.tema||''; t.oninput=()=>{r.tema=t.value; save();}; g.appendChild(t);
    const a=document.createElement('input'); a.className='txt'; a.placeholder='Nº / lista'; a.value=r.asistencia||''; a.oninput=()=>{r.asistencia=a.value; save();}; g.appendChild(a);
    const o=document.createElement('input'); o.className='txt'; o.value=r.obs||''; o.oninput=()=>{r.obs=o.value; save();}; g.appendChild(o);
  });
}
$('#btnShowMent')?.addEventListener('click',()=>openPanel('mentoring'));

/* ---------- Botones sidebar de ventas ---------- */
document.getElementById('svOpenCompany').onclick=()=>openPanel('company');
document.getElementById('svOpenCenters').onclick=()=>openPanel('centers');

/* ---------- Topbar ---------- */
document.getElementById('btnSave').onclick=save;
document.getElementById('btnLoad').onclick=()=>{load(); openPanel('company');};

/* ---------- PIN ---------- */
function enter(){ const v=document.getElementById('pin').value.trim();
  if(v==='4321' || /^AR4321$/i.test(v)){ document.getElementById('gate').style.display='none'; }
  else{ document.getElementById('pinMsg').style.display='block'; }
}
document.getElementById('enter').onclick=enter;
document.getElementById('clearPin').onclick=()=>{document.getElementById('pin').value='';document.getElementById('pinMsg').style.display='none';};
document.getElementById('pin').addEventListener('keydown',e=>{ if(e.key==='Enter') enter(); });

/* ---------- Boot ---------- */
window.addEventListener('load',()=>{ load(); openPanel('company'); });
</script>
</body>
</html>
