<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control Center Audio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg-main: radial-gradient(circle at top left, #111827, #020617 55%);
      --bg-card: #020617;
      --bg-card-soft: #0b1120;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --accent-red: #ff2440;
      --accent-blue: #38bdf8;
      --accent-green: #22c55e;
      --accent-orange: #f97316;
      --chip-pendiente: #facc15;
      --chip-enproceso: #4ade80;
      --chip-finalizada: #22c55e;
    }

    body.light {
      --bg-main: #f3f4f6;
      --bg-card: #ffffff;
      --bg-card-soft: #f9fafb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    html, body {
      width: 100%;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body {
      background: var(--bg-main);
      color: var(--text-main);
      display: flex;
      overflow-x: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 250px;
      background: #020617;
      border-right: 1px solid #020617;
      padding: 18px 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      color: #e5e7eb;
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fee2e2, var(--accent-red));
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-title {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .logo-subtitle {
      font-size: .7rem;
      color: #9ca3af;
    }

    .section-title {
      font-size: .75rem;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: .12em;
      margin-bottom: 8px;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: .88rem;
      color: #9ca3af;
      cursor: pointer;
      transition: all .18s ease;
    }

    .nav-item span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #020617;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
    }

    .nav-item.active {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      color: #111827;
      font-weight: 600;
    }

    .nav-item.active span.icon {
      background: rgba(15,23,42,.2);
    }

    .nav-item:hover:not(.active) {
      background: rgba(31,41,55,0.7);
      color: #e5e7eb;
    }

    body.light .nav-item:hover:not(.active) {
      background: rgba(15,23,42,0.2);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: .78rem;
      color: #9ca3af;
    }

    /* MAIN LAYOUT */
    .main {
      flex: 1;
      padding: 10px 18px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 1600px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .topbar-search {
      flex: 1 1 260px;
      position: relative;
      min-width: 220px;
    }

    .topbar-search input {
      width: 100%;
      border-radius: 999px;
      padding: 8px 14px 8px 30px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card);
      color: var(--text-main);
      font-size: .86rem;
      outline: none;
    }

    .topbar-search span {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: .8rem;
      color: var(--text-muted);
    }

    .topbar-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-soft);
      font-size: .8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--bg-card);
      color: var(--text-main);
      white-space: nowrap;
      box-shadow: none;
    }

    .btn-cta {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      color: #111827;
      font-weight: 600;
      border-color: transparent;
    }

    .btn span.icon {
      font-size: .85rem;
    }

    #themeToggle {
      min-width: 120px;
      justify-content: center;
    }

    #btnGuardarVista {
      background: linear-gradient(90deg, #3b82f6, #22c55e);
      color: #0b1120;
      border-color: transparent;
      font-weight: 600;
    }

    #btnExportarHTML {
      background: linear-gradient(90deg, #8b5cf6, #ec4899);
      color: #0b1120;
      border-color: transparent;
      font-weight: 600;
    }

    #btnImprimir {
      background: linear-gradient(90deg, #14b8a6, #0ea5e9);
      color: #0b1120;
      border-color: transparent;
      font-weight: 600;
    }

    body.light #btnGuardarVista,
    body.light #btnExportarHTML,
    body.light #btnImprimir {
      color:#111827;
    }

    /* PAGES */
    .pages {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 100%;
    }

    .page {
      flex: 1;
      display: none;
      overflow-y: auto;
      overflow-x: hidden;
      max-width: 100%;
    }

    .page.active {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 10px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .card-title {
      font-size: .9rem;
      font-weight: 600;
    }

    .card-sub {
      font-size: .72rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .card-header-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .badge-small {
      font-size: .7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111827;
      color: #9ca3af;
      border: 1px solid var(--border-soft);
    }

    body.light .badge-small {
      background: #e5e7eb;
    }

    .chip-estado {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .7rem;
      font-weight: 500;
      color: #111827;
      background: #9ca3af;
    }

    .chip-estado.pendiente    { background: var(--chip-pendiente); }
    .chip-estado.enproceso    { background: var(--chip-enproceso); }
    .chip-estado.finalizada   { background: var(--chip-finalizada); }

    .btn-chip {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: transparent;
      font-size: .72rem;
      padding: 2px 6px;
      cursor: pointer;
      color: var(--accent-blue);
    }

    /* DASHBOARD PAGE */
    .dashboard-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.3fr);
      gap: 10px;
      min-height: 0;
      align-items: flex-start;
      width: 100%;
      box-sizing: border-box;
    }

    .dashboard-right-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 6px;
      margin-bottom: 6px;
    }

    .kpi-card {
      background: var(--bg-card-soft);
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .kpi-label {
      font-size: .72rem;
      color: var(--text-muted);
    }

    .kpi-value {
      font-size: .98rem;
      font-weight: 600;
    }

    .kpi-caption {
      font-size: .7rem;
      color: var(--text-muted);
    }

    .dashboard-charts {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
      min-height: 0;
    }

    .chart-container {
      position: relative;
      width: 100%;
      min-height: 160px;
      max-height: 240px;
    }

    .chart-container.centered {
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .chart-container canvas {
      position: relative;
      inset: auto !important;
      width: 100% !important;
      height: 100% !important;
      display: block;
      box-sizing: border-box;
    }

    /* contenedor espec√≠fico para los 80 criterios */
    .criterios-container {
      min-height: 260px;
      max-height: 320px;
      overflow-y: auto; 
    }

    .ranking-list {
      font-size: .78rem;
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .ranking-row {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: space-between;
      padding:3px 0;
      border-bottom: 1px dashed rgba(148,163,184,0.3);
    }

    .ranking-main {
      display:flex;
      align-items:center;
      gap:6px;
    }

    .ranking-bar {
      height: 5px;
      border-radius:999px;
      background: var(--bg-card-soft);
      flex: 1;
      overflow:hidden;
    }

    .ranking-bar span {
      display:block;
      height:100%;
      background: linear-gradient(90deg,#22c55e,#38bdf8);
    }

    .ranking-row.extra-hidden {
      display:none;
    }

    .ranking-toggle {
      margin-top:6px;
      font-size:.76rem;
      color:var(--accent-blue);
      cursor:pointer;
      text-align:right;
    }

    .ranking-summary {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed rgba(148,163,184,0.4);
      font-size: .76rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .ranking-summary-item span {
      font-weight: 600;
      color: var(--text-main);
    }

    /* CENTROS PAGE Y DEM√ÅS */
    .centros-top {
      display: grid;
      grid-template-columns: 1.2fr 1.2fr 1fr;
      gap: 10px;
      min-height: 210px;
    }

    .delegados-list {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 160px;
      overflow: auto;
    }

    .delegado-card {
      background: var(--bg-card-soft);
      border-radius: 10px;
      padding: 4px 6px;
      border: 1px solid var(--border-soft);
      cursor: pointer;
    }

    .delegado-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }

    .delegado-main {
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.8rem;
    }

    .delegado-color {
      width:8px;
      height:8px;
      border-radius:999px;
    }

    .delegado-count {
      font-size:.72rem;
      color:var(--text-muted);
    }

    .delegado-bar {
      margin-top:3px;
      height:4px;
      border-radius:999px;
      background:var(--border-soft);
      overflow:hidden;
    }

    .delegado-bar span {
      display:block;
      height:100%;
      width:100%;
      background:linear-gradient(90deg,#38bdf8,#fb7185);
    }

    .delegado-card.active {
      outline:1px solid var(--accent-blue);
    }

    .calendar-wrapper {
      display:flex;
      flex-direction:column;
      gap:4px;
      height:100%;
    }

    .calendar-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:.85rem;
      font-weight:700;
    }

    .calendar-header button {
      border-radius:999px;
      width:24px;
      height:24px;
      border:1px solid var(--border-soft);
      background:transparent;
      color:var(--text-main);
      cursor:pointer;
      font-size:.8rem;
    }

    .calendar-weekdays {
      display:grid;
      grid-template-columns: repeat(7, minmax(0,1fr));
      font-size:.7rem;
      margin-top:4px;
      color:var(--text-muted);
      text-align:center;
    }

    .calendar-grid {
      margin-top:4px;
      display:grid;
      grid-template-columns: repeat(7, minmax(0,1fr));
      grid-template-rows: repeat(6, 42px);
      gap:4px;
      flex:1;
    }

    .cal-cell {
      border-radius:10px;
      border:1px solid var(--border-soft);
      background:var(--bg-card-soft);
      font-size:.8rem;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:flex-start;
      padding:3px 4px;
      cursor:pointer;
      position:relative;
    }

    .cal-cell.empty {
      background:transparent;
      border-style:dashed;
      cursor:default;
    }

    .cal-day {
      font-size:.78rem;
    }

    .cal-event {
      position:absolute;
      bottom:4px;
      left:4px;
      display:flex;
      align-items:center;
      gap:3px;
      font-size:.7rem;
    }

    .cal-dot {
      width:6px;
      height:6px;
      border-radius:999px;
      background:#facc15;
    }

    .cal-letter {
      font-weight:600;
    }

    .visitas-list {
      flex:1;
      overflow:auto;
      font-size:.78rem;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .visita-row {
      border-radius:10px;
      border:1px solid var(--border-soft);
      padding:4px 6px;
      background:var(--bg-card-soft);
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .visita-row-line {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
    }

    .visita-row-main {
      font-weight:500;
    }

    .visita-row-secondary {
      color:var(--text-muted);
      font-size:.72rem;
    }

    .visita-actions {
      margin-top:2px;
      display:flex;
      justify-content:flex-end;
      gap:4px;
    }

    .table-wrapper {
      flex:1;
      background: var(--bg-card);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .table-header {
      padding: 8px 10px 6px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .table-header h3 {
      font-size: .9rem;
    }

    .table-header span {
      font-size: .72rem;
      color: var(--text-muted);
    }

    .table-scroll {
      flex: 1;
      overflow: auto;
      border-top: 1px solid var(--border-soft);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .78rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: var(--bg-card);
      z-index: 2;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #0b1120;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: .75rem;
      color: var(--text-muted);
    }

    tbody tr:nth-child(even) {
      background: var(--bg-card-soft);
    }

    tbody tr:hover {
      background: rgba(15,23,42,0.8);
    }

    body.light tbody tr:nth-child(even) {
      background:#f3f4f6;
    }
    body.light tbody tr:hover {
      background:#e5e7eb;
    }

    .tag {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: .7rem;
      border: 1px solid var(--border-soft);
      background: #0b1120;
    }

    .tag.exclusivo {
      background: rgba(22,163,74,0.15);
      color: var(--accent-green);
      border-color: rgba(22,163,74,0.7);
    }

    .tag.corner {
      background: rgba(37,99,235,0.15);
      color: var(--accent-blue);
      border-color: rgba(37,99,235,0.7);
    }

    .tag-aar {
      background: rgba(148,163,184,0.15);
      border-color: rgba(148,163,184,0.7);
      color: var(--text-muted);
    }

    .tag-aar.si {
      background: rgba(34,197,94,0.15);
      border-color: rgba(34,197,94,0.7);
      color: var(--accent-green);
    }

    .tag-aar.formacion {
      background: rgba(234,179,8,0.15);
      border-color: rgba(234,179,8,0.7);
      color: #eab308;
    }

    .btn-link {
      border: none;
      background: transparent;
      color: var(--accent-blue);
      cursor: pointer;
      font-size: .74rem;
      text-decoration: underline;
    }

    .informe-layout {
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }

    .informe-top {
      display:grid;
      grid-template-columns: 1.3fr 1fr;
      gap:10px;
      min-height:190px;
    }

    .datos-grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px 12px;
      font-size:.8rem;
      margin-top:6px;
    }

    .dato-label {
      font-size:.72rem;
      color:var(--text-muted);
    }

    .dato-value {
      font-size:.82rem;
      font-weight:500;
    }

    .dato-full {
      grid-column:1 / -1;
    }

    .field-input {
      width:100%;
      padding:4px 6px;
      border-radius:8px;
      border:1px solid var(--border-soft);
      background:var(--bg-card-soft);
      color:var(--text-main);
      font-size:.8rem;
      outline:none;
    }

    /* NUEVOS ESTILOS PARA RADIO BUTTONS */
    .radio-group {
      display: flex;
      align-items: center;
      gap: 15px;
      height: 28px;
    }
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      font-size: .8rem;
    }
    .radio-group input[type="radio"] {
      accent-color: var(--accent-blue);
      transform: scale(1.2);
      cursor: pointer;
    }

    .panel-graficos {
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:8px;
      min-height:0;
      /* Eliminamos max-height para evitar corte en impresi√≥n */
      overflow:visible; 
    }

    .panel-inferior {
      display: grid;
      grid-template-columns: 1.1fr 1.9fr;
      gap: 10px;
    }

    /* CHECKLIST CON SCROLL */
    .checklist-visita {
      font-size: .78rem;
      max-height: 220px; /* Scroll vertical */
      overflow-y: auto;
      display:flex;
      flex-direction:column;
      gap:2px;
      border: 1px solid var(--border-soft);
      padding: 6px;
      border-radius: 8px;
    }
    .checklist-visita::-webkit-scrollbar { width:6px; }
    .checklist-visita::-webkit-scrollbar-thumb { background:var(--border-soft); border-radius:4px; }

    .checklist-visita label {
      display:flex;
      align-items:center;
      gap:4px;
      cursor: pointer;
    }

    .checklist-heading {
      margin-top:6px;
      font-size:.8rem;
      font-weight:600;
      color:var(--text-main);
    }

    .imagenes-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
      font-size: .78rem;
    }

    .imagen-item-title {
      font-size:.78rem;
      margin-bottom:3px;
    }

    .imagen-preview {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 10px;
      border: 1px dashed var(--border-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .7rem;
      color: var(--text-muted);
      overflow: hidden;
      background:var(--bg-card-soft);
      cursor:pointer;
    }

    .imagen-preview img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .observaciones-grid {
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top:4px;
    }

    .obs-item textarea {
      width:100%;
      height:80px;
      resize:vertical;
      border-radius:10px;
      border:1px solid var(--border-soft);
      background:var(--bg-card-soft);
      color:var(--text-main);
      padding:6px;
      font-size:.78rem;
      outline:none;
    }

    .obs-label {
      font-size:.78rem;
      margin-bottom:2px;
    }

    .acciones-informe {
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 14px;
      width: 420px;
      max-width: 95%;
      border: 1px solid var(--border-soft);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h3 {
      font-size: .95rem;
    }

    .modal-close {
      cursor: pointer;
      font-size: 1rem;
      color: var(--text-muted);
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: .78rem;
    }

    .modal-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .modal-field label {
      font-size: .74rem;
      color: var(--text-muted);
    }

    .modal-field input,
    .modal-field select {
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card-soft);
      color: var(--text-main);
      font-size: .78rem;
      outline: none;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    input[type="file"] {
      font-size:.75rem;
    }

    body.light .btn {
      background:#ffffff;
    }

    body.light .card {
      background:#ffffff;
    }

    /* RESPONSIVE */
    @media (max-width: 1400px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      .centros-top {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 1100px) {
      .topbar {
        flex-direction: column;
        align-items: stretch;
      }
      .topbar-buttons {
        justify-content: flex-start;
      }
      .centros-top {
        grid-template-columns: 1fr;
      }
      .informe-top {
        grid-template-columns: 1fr;
      }
      .panel-graficos {
        grid-template-columns: 1fr 1fr;
      }
      .panel-inferior {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 800px) {
      .dashboard-charts {
        grid-template-columns: 1fr;
      }
      .panel-graficos {
        grid-template-columns: 1fr;
      }
      .observaciones-grid {
        grid-template-columns: 1fr;
      }
      .imagenes-grid {
        grid-template-columns: 1fr;
      }
    }

    /* --- ESTILOS DE IMPRESI√ìN --- */
    /* OCULTO POR DEFECTO */
    #printChecklistContainer { display: none; }

    @page {
      size: A4 portrait;
      margin: 10mm;
    }

    @media print {
      html, body {
        width: 100%;
        height: auto;
        margin: 0;
        padding: 0;
        background:#ffffff !important;
        color: black !important;
        overflow: visible !important;
      }
      body {
        display:block;
      }
      /* Ocultar elementos de navegaci√≥n e interfaz */
      .sidebar,
      .topbar,
      .topbar-buttons,
      .acciones-informe,
      #themeToggle,
      #btnGuardarVista,
      #btnExportarHTML,
      #btnImprimir,
      #btnActualizarNube,
      .btn, 
      .btn-cta,
      .modal-backdrop {
        display:none !important;
      }

      .main {
        padding:0 !important;
        margin:0 !important;
        width:100% !important;
        max-width:none !important;
        overflow:visible !important;
      }
      .pages {
        overflow:visible !important;
        height: auto !important;
        display: block !important;
      }
      .page {
        display: none !important;
      }
      /* Solo mostrar la p√°gina activa */
      .page.active {
        display: flex !important;
        overflow: visible !important;
        height: auto !important;
      }

      .card {
        box-shadow:none !important;
        border: 1px solid #ccc !important;
        background: white !important;
        color: black !important;
        break-inside: avoid;
        margin-bottom: 10px;
      }
      
      input, textarea, select {
        background: white !important;
        color: black !important;
        border: 1px solid #ccc !important;
      }

      /* Ajustes Grid Impresi√≥n */
      .dashboard-grid { grid-template-columns: 1fr !important; }
      .panel-graficos { grid-template-columns: 1fr 1fr 1fr !important; height:auto; }
      .panel-inferior { grid-template-columns: 1fr 2fr !important; height:auto; }
      .informe-top { grid-template-columns: 1.4fr 1fr !important; }
      
      /* Checklist en p√°gina 1 (resumen) */
      .checklist-visita { 
        max-height: none !important; 
        overflow: visible !important; 
        border: 1px solid #eee;
      }

      /* P√ÅGINA 2: Tabla de Checklist Completo */
      #printChecklistContainer {
        display: block !important;
        break-before: page;
        margin-top: 20px;
      }
      .print-header { font-size: 16px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid black; padding-bottom: 5px; }
      .print-table { width: 100%; border-collapse: collapse; font-size: 11px; }
      .print-table th, .print-table td { border: 1px solid #ccc; padding: 5px; text-align: left; }
      .print-table th { background: #f0f0f0; font-weight: bold; }
      .print-table tr:nth-child(even) { background: #f9f9f9; }
    }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-badge"></div>
      <div class="logo-text">
        <span class="logo-title">Control Center Audio</span>
        <span class="logo-subtitle">Gesti√≥n de centros y delegados</span>
      </div>
    </div>

    <div>
      <div class="section-title">Secciones</div>
      <nav class="nav-list">
        <div class="nav-item active" data-page="dashboard">
          <span class="icon">üè†</span> Dashboard
        </div>
        <div class="nav-item" data-page="centros">
          <span class="icon">üè¢</span> Centros
        </div>
        <div class="nav-item" data-page="informe">
          <span class="icon">üìã</span> Informe de la visita
        </div>
        <div class="nav-item" data-page="servicios">
          <span class="icon">üõ†</span> Servicios
        </div>
        <div class="nav-item" data-page="ventas">
          <span class="icon">üí≥</span> Ventas
        </div>
        <div class="nav-item" data-page="proyectos">
          <span class="icon">üìä</span> Proyectos
        </div>
      </nav>
    </div>

    <div class="sidebar-footer">
      Versi√≥n demo ¬∑ Datos ficticios
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="topbar-search">
        <span>üîç</span>
        <input id="searchGlobal" placeholder="Buscar por centro, propietario o delegado...">
      </div>
      <div class="topbar-buttons">
        <button class="btn" id="themeToggle">
          <span class="icon">üåì</span> Oscuro / Claro
        </button>
        <button class="btn" id="btnGuardarVista">
          <span class="icon">üíæ</span> Guardar vista
        </button>
        <button class="btn" id="btnExportarHTML">
          <span class="icon">‚¨áÔ∏è</span> Exportar HTML
        </button>
        <button class="btn" id="btnImprimir">
          <span class="icon">üñ®</span> Imprimir
        </button>
        <button class="btn btn-cta" id="btnActualizarNube">
          <span class="icon">‚òÅÔ∏è</span> Actualizar datos nube
        </button>
      </div>
    </div>

    <div class="pages">
      <section class="page active" data-page="dashboard">
        <div class="dashboard-grid">
          <article class="card">
            <div class="card-header-row">
              <span class="card-title">Resumen general</span>
              <span class="badge-small">Demo ¬∑ Promedios sobre visitas guardadas</span>
            </div>

            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-label">% de aplicaci√≥n de procesos</div>
                <div class="kpi-value" id="kpiProcesos">‚Äì</div>
                <div class="kpi-caption">Objetivo 85‚Äì100%</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Conv. a prueba</div>
                <div class="kpi-value" id="kpiConvPrueba">‚Äì</div>
                <div class="kpi-caption">Objetivo 80%</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Conv. a venta</div>
                <div class="kpi-value" id="kpiConvVenta">‚Äì</div>
                <div class="kpi-caption">Objetivo 80%</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Aplicaci√≥n HIT</div>
                <div class="kpi-value" id="kpiHIT">‚Äì</div>
                <div class="kpi-caption">% Centros (Global)</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Formaciones %</div>
                <div class="kpi-value" id="kpiFormaciones">‚Äì</div>
                <div class="kpi-caption">Media de m√≥dulos formativos</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Ayuda</div>
                <div class="kpi-value" id="kpiAyuda">‚Äì</div>
                <div class="kpi-caption">Telecare / PIA / Telehear</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">AAR</div>
                <div class="kpi-value" id="kpiAar">‚Äì</div>
                <div class="kpi-caption">% Centros (Global)</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Primeros auxilios</div>
                <div class="kpi-value" id="kpiPrimeros">‚Äì</div>
                <div class="kpi-caption">Centros con formaci√≥n</div>
              </div>
            </div>

            <div class="dashboard-charts">
              <div class="card">
                <div class="card-header-row">
                  <span class="card-title">Radar general</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartRadarGeneral" width="360" height="360"></canvas>
                </div>
              </div>

              <div class="card">
                <div class="card-header-row">
                  <span class="card-title">Procesos y √°reas de mejora por mes</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartProcesosMes" width="438" height="240"></canvas>
                </div>
              </div>

              <div class="card">
                <div class="card-header-row">
                  <span class="card-title">√Åreas de mejora por mes</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartAreasMes" width="438" height="240"></canvas>
                </div>
              </div>

              <div class="card">
                <div class="card-header-row">
                  <span class="card-title">Primeros auxilios por mes</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartPrimerosMes" width="438" height="240"></canvas>
                </div>
              </div>

              <div class="card">
                <div class="card-header-row">
                  <span class="card-title">Top 10 √°reas de mejora</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartTopAreas" width="438" height="240"></canvas>
                </div>
              </div>

              <div class="card">
                <div class="card-header-row">
                  <span class="card-title">Aplicaci√≥n AAR / HIT</span>
                </div>
                <div class="chart-container">
                  <canvas id="chartAarHitDonut" width="438" height="360"></canvas>
                </div>
              </div>
            </div>
          </article>

          <div class="dashboard-right-column">
            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Evaluaci√≥n detallada de procesos (80 criterios)</span>
                <span class="badge-small">Se actualiza con los checklists</span>
              </div>
              <div class="card-sub" id="criteriosEmptyMsg" style="display: none;">
                Adjunta un checklist en el informe de la visita para ver el detalle.
              </div>
              <div class="chart-container criterios-container">
                <canvas id="chartCriteriosDetalle" width="1435"></canvas>
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Ranking de delegados</span>
              </div>
              <div class="ranking-list" id="rankingDelegados">
                </div>
              <div class="ranking-toggle" id="rankingToggle" style="display: block;">
                Mostrar todos
              </div>
              <div class="ranking-summary" id="rankingResumen">
                <div class="ranking-summary-item">
                  Top delegado: <span id="rankingTopDelegado">-</span>
                </div>
                <div class="ranking-summary-item">
                  Media procesos delegados: <span id="rankingMediaProcesos">-</span>
                </div>
              </div>
            </article>
          </div>
        </div>
      </section>

      <section class="page" data-page="centros">
        <div class="centros-top">
          <article class="card">
            <div class="card-header-row">
              <span class="card-title">Centros y delegados</span>
              <span class="badge-small"><span id="numDelegados">0</span> delegados</span>
            </div>
            <div class="delegados-list" id="delegadosList"></div>
            <div style="display:flex; gap:8px; margin-top:6px;">
              <button class="btn btn-cta" id="btnAddCentro">
                <span class="icon">‚ûï</span> A√±adir centro
              </button>
              <button class="btn" id="btnAdjuntarExcel">
                <span class="icon">üì§</span> Adjuntar centros (Excel)
              </button>
              <input type="file" id="inputExcel" accept=".xlsx,.xls" style="display:none">
            </div>
            <div style="margin-top:4px; font-size:.74rem; color:var(--text-muted);">
              Centros mostrados: <span id="centrosMostrados">0</span> / <span id="centrosTotal">0</span>
            </div>
          </article>

          <article class="card">
            <div class="calendar-wrapper">
              <div class="calendar-header">
                <button id="calPrev">&lt;</button>
                <div class="calendar-month" id="calTitulo" style="font-weight:700;">Diciembre de 2025</div>
                <button id="calNext">&gt;</button>
              </div>
              <div class="calendar-weekdays">
                <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
              </div>
              <div class="calendar-grid" id="calendarGrid"></div>
              <div style="font-size:.72rem; color:var(--text-muted); margin-top:2px;">
                Clic en un d√≠a para agendar visita.
              </div>
            </div>
          </article>

          <article class="card">
            <div class="card-header-row">
              <span class="card-title">Visitas agendadas</span>
            </div>
            <div class="visitas-list" id="visitasList"></div>
          </article>
        </div>

        <section class="table-wrapper">
          <div class="table-header">
            <div>
              <h3>Listado de centros</h3>
            </div>
            <span class="badge-small" id="totalCentrosLabel">Centros mostrados: 0 / 0</span>
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Propietario</th>
                  <th>Centro</th>
                  <th>Provincia</th>
                  <th>Delegado</th>
                  <th>Tipo</th>
                  <th>Informes</th>
                  <th>Centro AAR</th>
                </tr>
              </thead>
              <tbody id="tablaCentrosBody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <section class="page" data-page="informe">
        <div class="informe-layout">
          <div class="informe-top">
            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Datos del centro</span>
              </div>
              <div class="datos-grid">
                <div>
                  <div class="dato-label">Centro</div>
                  <input id="infCentro" class="field-input" readonly="">
                </div>
                <div>
                  <div class="dato-label">Provincia</div>
                  <input id="infProvincia" class="field-input" readonly="">
                </div>
                <div>
                  <div class="dato-label">Delegado</div>
                  <input id="infDelegado" class="field-input" readonly="">
                </div>
                
                <div class="dato-full">
                   <div class="dato-label" style="margin-bottom:2px;">Tipo de Centro</div>
                   <div class="radio-group">
                      <label><input type="radio" name="tipoCentro" value="Exclusivo" id="radExclusivo"> Exclusivo</label>
                      <label><input type="radio" name="tipoCentro" value="Corner" id="radCorner"> Corner</label>
                   </div>
                </div>

                <div>
                  <div class="dato-label">Responsable audio</div>
                  <input id="infRespAudio" class="field-input">
                </div>
                <div>
                  <div class="dato-label">Fecha visita</div>
                  <input id="infFecha" class="field-input">
                </div>
                <div class="dato-full" style="margin-top:4px;">
                  <button class="btn btn-cta" id="btnAdjuntarChecklist">
                    <span class="icon">üìé</span> Adjuntar checklist (Excel)
                  </button>
                  <input type="file" id="inputChecklist" accept=".xlsx,.xls" style="display:none">
                  <span id="nombreChecklist" style="margin-left:8px; font-size:.74rem; color:var(--text-muted);"></span>
                </div>
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">KPIs del centro</span>
              </div>
              <div style="font-size:.78rem; margin-top:4px;">
                <div>% de aplicaci√≥n de procesos: <strong id="kpiCentroProcesos">0%</strong></div>
                <div>Conv. a prueba: <strong id="kpiCentroPrueba">0%</strong></div>
                <div>Conv. a cierre: <strong id="kpiCentroVenta">0%</strong></div>
                <div>Aplicaci√≥n HIT: <strong id="kpiCentroHit" style="color:var(--accent-blue);">No</strong></div>
              </div>
              <div class="chart-container centered" style="margin-top:6px; max-height:180px;">
                <canvas id="chartCentroRadar" width="270" height="270"></canvas>
              </div>
            </article>
          </div>

          <div class="panel-graficos">
            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Palancas (Aplica/No Aplica)</span>
              </div>
              <div class="chart-container">
                <canvas id="chartCentroPalancas"></canvas>
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">√Åreas de Mejora (F=0)</span>
              </div>
              <div class="chart-container">
                <canvas id="chartCentroAreasMejora"></canvas>
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Resumen Procesos (Cumple vs No)</span>
              </div>
              <div class="chart-container">
                <canvas id="chartCentroProcesosStack"></canvas>
              </div>
            </article>
          </div>

          <div class="panel-inferior">
            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Checklist R√°pido (Manual)</span>
              </div>
              <div class="checklist-visita">
                <label><input type="checkbox" id="chkHit"> <strong>HIT</strong></label>
                <label><input type="checkbox" id="chkAar"> <strong>AAR</strong></label>
                <label><input type="checkbox" id="chk1os"> Primeros Auxilios</label>
                <label><input type="checkbox" id="chkInfinity"> Infinity</label>
                <label><input type="checkbox" id="chkSeguro"> Seguro</label>
                <label><input type="checkbox" id="chkStock"> Stock</label>
                <div style="margin:5px 0; border-top:1px dashed #333;"></div>
                <label><input type="checkbox"> Formaci√≥n WSA</label>
                <label><input type="checkbox"> Formaci√≥n Starkey</label>
                <label><input type="checkbox"> Neuroventas</label>
                <label><input type="checkbox"> Telecare</label>
                <label><input type="checkbox"> PIA</label>
                <label><input type="checkbox"> Telehear</label>
                <label><input type="checkbox"> Audiometr√≠a RT</label>
                <label><input type="checkbox"> Test Lectura Audio</label>
              </div>
              <div style="margin-top:5px;">
                 <div class="dato-label">Nota Formaciones (0-10)</div>
                 <input type="number" id="inpFormaciones" class="field-input" value="0" min="0" max="10">
              </div>
            </article>

            <article class="card">
              <div class="card-header-row">
                <span class="card-title">Im√°genes del centro</span>
              </div>
              <div class="imagenes-grid" style="margin-top:4px;">
                <div>
                  <div class="imagen-item-title">Centro exterior</div>
                  <div class="imagen-preview" onclick="$('#fExt').click()">
                    Adjuntar imagen
                    <input type="file" id="fExt" accept="image/*" hidden onchange="preview(this)">
                  </div>
                </div>
                <div>
                  <div class="imagen-item-title">Centro interior</div>
                  <div class="imagen-preview" onclick="$('#fInt').click()">
                    Adjuntar imagen
                    <input type="file" id="fInt" accept="image/*" hidden onchange="preview(this)">
                  </div>
                </div>
                <div>
                  <div class="imagen-item-title">Gabinete</div>
                  <div class="imagen-preview" onclick="$('#fGab').click()">
                    Adjuntar imagen
                    <input type="file" id="fGab" accept="image/*" hidden onchange="preview(this)">
                  </div>
                </div>
              </div>
            </article>
          </div>

          <article class="card">
            <div class="card-header-row">
              <span class="card-title">Observaciones ¬∑ Recomendaciones ¬∑ Compromisos</span>
            </div>
            <div class="observaciones-grid" style="margin-top:6px;">
              <div class="obs-item">
                <div class="obs-label">Observaciones</div>
                <textarea id="obsObservaciones"></textarea>
              </div>
              <div class="obs-item">
                <div class="obs-label">Recomendaciones</div>
                <textarea id="obsRecomendaciones"></textarea>
              </div>
              <div class="obs-item">
                <div class="obs-label">Compromisos</div>
                <textarea id="obsCompromisos"></textarea>
              </div>
            </div>
            <div class="acciones-informe">
              <button class="btn btn-cta" id="btnGuardarInforme">
                <span class="icon">üíæ</span> Guardar informe
              </button>
            </div>
          </article>
        </div>
      </section>

      <section class="page" data-page="servicios">
        <article class="card"><div class="card-title">Servicios</div></article>
      </section>
      <section class="page" data-page="ventas">
        <article class="card"><div class="card-title">Ventas</div></article>
      </section>
      <section class="page" data-page="proyectos">
        <article class="card"><div class="card-title">Proyectos</div></article>
      </section>
    </div>
  </main>

  <div id="printChecklistContainer">
    <div class="print-header">ANEXO: DETALLE DE CHECKLIST (80 Puntos)</div>
    <table class="print-table" id="tablaPrint">
      <thead><tr><th>Criterio</th><th>Resultado</th></tr></thead>
      <tbody id="tbodyPrint"></tbody>
    </table>
  </div>

  <div class="modal-backdrop" id="modalVisita" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3>Agendar visita</h3>
        <span class="modal-close" data-close="modalVisita">‚úï</span>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <label>Fecha</label>
          <input id="visitaFecha" readonly="" data-iso="2025-12-09">
        </div>
        <div class="modal-field">
          <label>Responsable audio</label>
          <select id="visitaResp">
            <option value="Ariannys Rojas">Ariannys Rojas</option>
            <option value="Sonia Guasque">Sonia Guasque</option>
          </select>
        </div>
        <div class="modal-field">
          <label>Centro</label>
          <input id="visitaCentro" list="listaCentros">
          <datalist id="listaCentros"></datalist>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modalVisita">Cancelar</button>
        <button class="btn btn-cta" id="btnGuardarVisita">Guardar visita</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalCentro">
    <div class="modal">
      <div class="modal-header">
        <h3>Nuevo centro</h3>
        <span class="modal-close" data-close="modalCentro">‚úï</span>
      </div>
      <div class="modal-body">
        <div class="modal-field"><label>C√≥digo</label><input id="nuevoCodigo"></div>
        <div class="modal-field"><label>Propietario</label><input id="nuevoPropietario"></div>
        <div class="modal-field"><label>Centro</label><input id="nuevoCentro"></div>
        <div class="modal-field"><label>Provincia</label><input id="nuevoProvincia"></div>
        <div class="modal-field"><label>Delegado</label><input id="nuevoDelegado"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modalCentro">Cancelar</button>
        <button class="btn btn-cta" id="guardarCentro">Guardar centro</button>
      </div>
    </div>
  </div>

  <script>
    Chart.register(ChartDataLabels);
    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    /* UTILS */
    function formatDateISO(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function formatDateHuman(iso) {
      const [y,m,d] = iso.split("-");
      return `${d}-${m}-${y}`;
    }
    function preview(input) {
       if(input.files && input.files[0]) {
          const r = new FileReader();
          r.onload = e => input.parentElement.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:10px;">`;
          r.readAsDataURL(input.files[0]);
       }
    }

    /* NAV */
    const pages = $$(".page");
    $$(".nav-item").forEach(item => {
      item.addEventListener("click", () => {
        const page = item.dataset.page;
        $$(".nav-item").forEach(i => i.classList.toggle("active", i === item));
        pages.forEach(p => p.classList.toggle("active", p.dataset.page === page));
      });
    });

    /* TEMA Y IMPRESI√ìN */
    $("#themeToggle").addEventListener("click", () => {
      document.body.classList.toggle("light");
      updateChartsTheme();
    });
    $("#btnImprimir").addEventListener("click", () => window.print());

    /* DATOS INICIALES */
    const centros = [];
    const informesPorCentro = {};
    const delegadosColores = {};
    const colorPalette = ["#22c55e","#2563eb","#14b8a6","#a855f7","#f97316","#0ea5e9","#ef4444","#eab308","#ec4899"];

    function getColorForDelegado(nombre) {
      if (!delegadosColores[nombre]) {
        const idx = Object.keys(delegadosColores).length % colorPalette.length;
        delegadosColores[nombre] = colorPalette[idx];
      }
      return delegadosColores[nombre];
    }
    function tipoCentro(nombreCentro) {
      return nombreCentro.toUpperCase().includes("EXCLUSIVO") ? "Exclusivo" : "Corner";
    }
    function getInformes(nombreCentro) {
      return informesPorCentro[nombreCentro] || 0;
    }

    /* RENDER TABLA CENTROS */
    let filtroDelegadoActual = null;
    let filtroTextoActual = "";

    function renderTablaCentros() {
      const tbody = $("#tablaCentrosBody");
      tbody.innerHTML = "";
      const filtrados = centros.filter(c => {
        const cad = (c.centro + " " + c.propietario + " " + c.delegado).toLowerCase();
        const pasaTexto = cad.includes(filtroTextoActual.toLowerCase());
        const pasaDel   = !filtroDelegadoActual || c.delegado === filtroDelegadoActual;
        return pasaTexto && pasaDel;
      });

      filtrados.forEach(c => {
        const tr = document.createElement("tr");
        const t  = tipoCentro(c.centro);
        const informes = getInformes(c.centro);
        const aarEstado = c.aar ? "S√≠" : "No";

        tr.innerHTML = `
          <td>${c.codigo}</td><td>${c.propietario}</td><td>${c.centro}</td><td>${c.provincia}</td><td>${c.delegado}</td>
          <td><span class="tag ${t === 'Exclusivo' ? 'exclusivo' : 'corner'}">${t}</span></td>
          <td><button class="btn-link btn-informe-centro" data-centro="${c.centro}">${informes ? `Ver (${informes})` : "A√±adir informe"}</button></td>
          <td><span class="tag tag-aar ${aarEstado === 'S√≠' ? 'si' : ''}">${aarEstado}</span></td>
        `;
        tbody.appendChild(tr);
      });
      $("#totalCentrosLabel").textContent = `Centros mostrados: ${filtrados.length} / ${centros.length}`;
      $("#centrosMostrados").textContent = filtrados.length;
      $("#centrosTotal").textContent = centros.length;
    }

    /* RENDER DELEGADOS */
    function renderDelegados() {
      const map = new Map();
      centros.forEach(c => {
        if (!map.has(c.delegado)) map.set(c.delegado, []);
        map.get(c.delegado).push(c);
      });
      const list = $("#delegadosList");
      list.innerHTML = "";
      const arr = Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0]));

      arr.forEach(([nombre, lista]) => {
        const card = document.createElement("div");
        card.className = "delegado-card";
        const color = getColorForDelegado(nombre);
        card.innerHTML = `<div class="delegado-header"><div class="delegado-main"><span class="delegado-color" style="background:${color}"></span><span>${nombre}</span></div><span class="delegado-count">${lista.length} centros</span></div><div class="delegado-bar"><span style="background:${color}"></span></div>`;
        card.addEventListener("click", () => {
          if (filtroDelegadoActual === nombre) { filtroDelegadoActual = null; card.classList.remove("active"); } 
          else { filtroDelegadoActual = nombre; $$(".delegado-card").forEach(c=>c.classList.remove("active")); card.classList.add("active"); }
          renderTablaCentros();
        });
        list.appendChild(card);
      });
      $("#numDelegados").textContent = arr.length;
      renderRankingDelegados(map);
    }

    function renderRankingDelegados(map) {
      const div = $("#rankingDelegados"); div.innerHTML = "";
      const arr = Array.from(map.entries()).map(([nombre, lista]) => ({nombre, score: Math.floor(80+Math.random()*15)})).sort((a,b)=>b.score-a.score);
      arr.forEach((d, idx) => {
        const row = document.createElement("div"); row.className = "ranking-row"; if(idx>=5) row.classList.add("extra-hidden");
        const color = getColorForDelegado(d.nombre);
        row.innerHTML = `<div class="ranking-main"><span style="font-size:.75rem; color:var(--text-muted);">${idx+1}.</span><span class="delegado-color" style="background:${color}"></span><span>${d.nombre}</span></div><div style="flex:1; display:flex; align-items:center; gap:4px; margin-left:6px;"><div class="ranking-bar"><span style="width:${d.score}%; background:${color}"></span></div><span style="font-size:.72rem;">${d.score}</span></div>`;
        div.appendChild(row);
      });
      if(arr.length) { $("#rankingTopDelegado").textContent = arr[0].nombre; $("#rankingMediaProcesos").textContent = "86%"; }
    }
    $("#rankingToggle").addEventListener("click", () => {
       const exp = $("#rankingToggle").textContent === "Ocultar";
       $$(".ranking-row.extra-hidden").forEach(r => r.style.display = exp ? "none" : "flex");
       $("#rankingToggle").textContent = exp ? "Mostrar todos" : "Ocultar";
    });

    $("#searchGlobal").addEventListener("input", e => { filtroTextoActual = e.target.value || ""; renderTablaCentros(); });

    /* EXCEL CARGA MASIVA CENTROS */
    $("#btnAdjuntarExcel").addEventListener("click", () => $("#inputExcel").click());
    $("#inputExcel").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const wb = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
        rows.slice(1).forEach(row => {
          if (!row || row.length < 5) return;
          centros.push({
            codigo: (row[0]||"").toString().trim(), propietario: (row[1]||"").toString().trim(),
            centro: (row[2]||"").toString().trim(), provincia: (row[3]||"").toString().trim(),
            delegado: (row[4]||"").toString().trim(), aar: false, hit: false
          });
        });
        actualizarListaCentrosDatalist(); renderTablaCentros(); renderDelegados();
      };
      reader.readAsArrayBuffer(file);
    });

    /* NUEVO CENTRO */
    $("#btnAddCentro").addEventListener("click", () => { $("#nuevoCodigo").value=""; abrirModal("modalCentro"); });
    $("#guardarCentro").addEventListener("click", () => {
      centros.push({
        codigo: $("#nuevoCodigo").value||"NEW", propietario: $("#nuevoPropietario").value||"N/D",
        centro: $("#nuevoCentro").value||"Centro", provincia: $("#nuevoProvincia").value||"N/D",
        delegado: $("#nuevoDelegado").value||"N/D", aar: false, hit: false
      });
      cerrarModal("modalCentro"); renderTablaCentros(); renderDelegados(); actualizarListaCentrosDatalist();
    });
    function actualizarListaCentrosDatalist() {
      const dl = $("#listaCentros"); dl.innerHTML = "";
      centros.forEach(c => { const opt = document.createElement("option"); opt.value = c.centro; dl.appendChild(opt); });
    }

    /* CALENDARIO */
    const calendarGrid = $("#calendarGrid");
    let calYear, calMonth; const visitas = []; let visitaActual = null;
    function initCalendar() { const now = new Date(); calYear = now.getFullYear(); calMonth = now.getMonth(); drawCalendar(); }
    function drawCalendar() {
      calendarGrid.innerHTML = "";
      const first = new Date(calYear, calMonth, 1);
      const dow = (first.getDay()+6)%7;
      const last = new Date(calYear, calMonth+1, 0).getDate();
      $("#calTitulo").textContent = new Intl.DateTimeFormat("es-ES", {month:"long", year:"numeric"}).format(first).replace(/^\w/, c=>c.toUpperCase());
      for (let i=0;i<42;i++) {
        const cell = document.createElement("div"); const dayNum = i - dow + 1;
        if (dayNum < 1 || dayNum > last) { cell.className = "cal-cell empty"; } else {
          cell.className = "cal-cell";
          const dIso = formatDateISO(new Date(calYear, calMonth, dayNum));
          cell.innerHTML = `<div class="cal-day">${dayNum}</div>`;
          const v = visitas.find(x=>x.fecha===dIso);
          if (v) cell.innerHTML += `<div class="cal-event"><span class="cal-dot"></span><span class="cal-letter">V</span></div>`;
          cell.addEventListener("click", ()=> { $("#visitaFecha").value=formatDateHuman(dIso); $("#visitaFecha").dataset.iso=dIso; abrirModal("modalVisita"); });
        }
        calendarGrid.appendChild(cell);
      }
    }
    $("#calPrev").addEventListener("click", ()=>{ calMonth--; if(calMonth<0){calMonth=11;calYear--;} drawCalendar(); });
    $("#calNext").addEventListener("click", ()=>{ calMonth++; if(calMonth>11){calMonth=0;calYear++;} drawCalendar(); });
    $("#btnGuardarVisita").addEventListener("click", ()=>{
       const c = $("#visitaCentro").value.trim(); if(!c) return;
       const obj = centros.find(x=>x.centro===c);
       visitas.push({ fecha: $("#visitaFecha").dataset.iso, centro:c, delegado: obj?obj.delegado:"N/D", respAudio: $("#visitaResp").value, estado:"pendiente" });
       cerrarModal("modalVisita"); drawCalendar(); renderVisitas();
    });
    function renderVisitas() {
       const l = $("#visitasList"); l.innerHTML="";
       visitas.sort((a,b)=>a.fecha.localeCompare(b.fecha));
       visitas.forEach((v,i) => {
          l.innerHTML += `<div class="visita-row"><div class="visita-row-line"><span class="visita-row-main">${formatDateHuman(v.fecha)} ¬∑ ${v.centro}</span><span class="chip-estado ${v.estado}">${v.estado}</span></div><div class="visita-actions"><button class="btn-chip btn-ir-informe" data-centro="${v.centro}" data-idx="${i}">Informe</button></div></div>`;
       });
    }

    function abrirModal(id){ document.getElementById(id).style.display = "flex"; }
    function cerrarModal(id){ document.getElementById(id).style.display = "none"; }
    $$(".modal-close").forEach(el=>el.addEventListener("click", ()=>cerrarModal(el.dataset.close)));

    /* ========================================================================= */
    /* L√ìGICA DE INFORME Y LECTURA DE EXCEL (CORNER/EXCLUSIVO + NUEVOS CHARTS)   */
    /* ========================================================================= */
    
    let centroChartsCreated = false;
    let centroCharts = {};
    let globalCharts = {};
    let centroActual = null;
    let itemsFallidosGlobal = []; 
    let conteoF1 = 0, conteoF0 = 0;

    // --- RECALCULAR DASHBOARD GLOBAL ---
    function recalcularKPIsGlobales() {
       const total = centros.length || 1;
       const hitCount = centros.filter(c => c.hit).length;
       const aarCount = centros.filter(c => c.aar).length;
       const hitPct = Math.round((hitCount / total) * 100);
       const aarPct = Math.round((aarCount / total) * 100);

       $("#kpiHIT").textContent = hitPct + "%";
       $("#kpiAar").textContent = aarPct + "%";
       // Dummy Static
       $("#kpiProcesos").textContent = "85%"; $("#kpiConvPrueba").textContent = "80%"; $("#kpiConvVenta").textContent = "78%";
       
       if(globalCharts.radarGeneral) {
         globalCharts.radarGeneral.data.datasets[0].data = [85, 80, 78, hitPct, 60, aarPct];
         globalCharts.radarGeneral.update();
       }
       if(globalCharts.aarHit) {
         globalCharts.aarHit.data.datasets[0].data = [hitCount, total - hitCount];
         globalCharts.aarHit.update();
       }
       renderTablaCentros();
    }

    // --- LECTURA CHECKLIST EXCEL ---
    $("#btnAdjuntarChecklist").addEventListener("click", ()=> $("#inputChecklist").click());
    $("#inputChecklist").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) { $("#nombreChecklist").textContent = file.name; leerChecklist(file); }
    });

    function leerChecklist(file) {
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
          const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header:1 });
          
          // Detectar tipo y seleccionar Radio Button
          const nameUpper = file.name.toUpperCase();
          const isExclusivo = nameUpper.includes("EXCLUSIVO");
          if(isExclusivo) $("#radExclusivo").checked = true; else $("#radCorner").checked = true;

          // Procesar Filas
          let rStart = isExclusivo ? 7 : 6;
          let rEnd   = isExclusivo ? 101 : 87;
          
          itemsFallidosGlobal = [];
          let c1=0, c0=0;
          let listaPrint = ""; // HTML para tabla pagina 2

          for(let r=rStart; r<=rEnd; r++) {
             const row = rows[r] || [];
             const nombre = row[1]; // Col B
             const res = row[5];    // Col F
             if(nombre) {
                const ok = (res == 1);
                if(ok) c1++; else { c0++; itemsFallidosGlobal.push(nombre); }
                
                // A√±adir a tabla oculta de impresi√≥n
                listaPrint += `<tr><td>${nombre}</td><td style="color:${ok?'green':'red'}"><b>${ok?'CUMPLE':'NO CUMPLE'}</b></td></tr>`;
             }
          }
          // Actualizar Tabla Print
          $("#tbodyPrint").innerHTML = listaPrint;

          conteoF1 = c1; conteoF0 = c0;
          
          // Leer KPIs unitarios (coords dummy)
          let fHit = isExclusivo ? 64 : 62;
          let valHit = (rows[fHit]||[])[5] == 1;
          const procPct = Math.round((c1 / (c1+c0))*100) || 0;
          
          if(centroActual) centroActual.hit = valHit;
          $("#chkHit").checked = valHit;
          
          alert(`Checklist procesado.\nHIT: ${valHit ? "S√ç" : "NO"}`);
          actualizarVisualesCentro(valHit, $("#chkAar").checked, procPct, 80, 75);

        } catch (err) { console.error(err); alert("Error al leer Excel"); }
      };
      reader.readAsArrayBuffer(file);
    }

    // --- GR√ÅFICOS CENTRO RENOVADOS ---
    function crearChartsCentro() {
      if (centroChartsCreated) return;
      centroChartsCreated = true;
      const textColor = getComputedStyle(document.body).getPropertyValue('--text-muted');

      // 1. RADAR CLEAN
      centroCharts.radar = new Chart(document.getElementById("chartCentroRadar").getContext("2d"), {
        type: "radar",
        data: {
          labels: ['Procesos', 'C. Prueba', 'C. Venta', 'Formaci√≥n (x10)'],
          datasets: [{ label: 'Nivel', data: [0,0,0,0], backgroundColor: 'rgba(56, 189, 248, 0.25)', borderColor: '#38bdf8', borderWidth: 3, pointBackgroundColor: '#fff' }]
        },
        options: { 
           scales: { r: { angleLines: { color: 'rgba(255,255,255,0.1)' }, grid: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: '#ffffff', font:{size:13, weight:'bold'} }, ticks: { display: false, min:0, max:100 } } }, 
           plugins: { legend: { display: false } } 
        }
      });

      // 2. PALANCAS (SEM√ÅFORO)
      centroCharts.barras = new Chart(document.getElementById("chartCentroPalancas").getContext("2d"), {
        type: 'bar',
        data: {
           labels: ['HIT', 'AAR', 'Primeros Auxilios', 'Infinity', 'Seguro', 'Stock'],
           datasets: [{ data: [1,1,1,1,1,1], backgroundColor: [], borderRadius: 4, barPercentage: 0.6 }]
        },
        options: { indexAxis: 'y', scales: { x: { display: false, max: 1 }, y: { grid: {display:false}, ticks: {color: textColor, font:{size:11}} } }, plugins: { legend: { display: false } } }
      });

      // 3. AREAS MEJORA (TOP F=0)
      centroCharts.topAreas = new Chart(document.getElementById("chartCentroAreasMejora").getContext("2d"), {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'No Cumple', data: [], backgroundColor: '#ef4444', borderRadius: 4, barPercentage: 0.6 }] },
        options: { 
           indexAxis: 'y', maintainAspectRatio: false, 
           scales: { x: { display: false }, y: { grid: {display:false}, ticks: {color: textColor, callback: function(v){ let l = this.getLabelForValue(v); return l.length>20?l.substr(0,20)+'...':l; }} } }, 
           plugins: { legend: { display: false } } 
        }
      });

      // 4. RESUMEN STACKED
      centroCharts.procesosResumen = new Chart(document.getElementById("chartCentroProcesosStack").getContext("2d"), {
        type: 'bar',
        data: {
           labels: ['Global'],
           datasets: [
              { label: 'Cumple', data: [0], backgroundColor: '#22c55e', stack:'st1', borderRadius:{topLeft:4, bottomLeft:4} },
              { label: 'No Cumple', data: [0], backgroundColor: '#ef4444', stack:'st1', borderRadius:{topRight:4, bottomRight:4} }
           ]
        },
        options: { 
           indexAxis: 'y', maintainAspectRatio: false, 
           scales: { x: { display:false, stacked:true, max:100 }, y: { display:false, stacked:true } }, 
           plugins: { 
              legend: { position: 'bottom', labels: {color: textColor} },
              datalabels: { color: 'white', font: {weight:'bold'}, formatter: (v)=> v>5 ? v+'%' : '' }
           } 
        }
      });
    }

    function updateChartsTheme() {
       if(centroCharts.radar) {
          const isLight = document.body.classList.contains('light');
          centroCharts.radar.options.scales.r.pointLabels.color = isLight ? '#333' : '#fff';
          centroCharts.radar.update();
       }
    }

    function actualizarVisualesCentro(hitBool, aarBool, procVal=85, pruebaVal=80, ventaVal=75) {
       if(!centroChartsCreated) crearChartsCentro();
       
       // UI Textos
       const kpiHit = $("#kpiCentroHit"); kpiHit.textContent = hitBool ? "S√≠" : "No"; kpiHit.style.color = hitBool ? "var(--accent-green)" : "var(--accent-red)";
       $("#kpiCentroProcesos").textContent = procVal + "%"; $("#kpiCentroPrueba").textContent = pruebaVal + "%"; $("#kpiCentroVenta").textContent = ventaVal + "%";

       // Manual Inputs
       const formVal = $("#inpFormaciones").value || 5;
       const p1 = $("#chk1os").checked; const pInf = $("#chkInfinity").checked; const pSeg = $("#chkSeguro").checked; const pStk = $("#chkStock").checked;

       // 1. Radar
       centroCharts.radar.data.datasets[0].data = [procVal, pruebaVal, ventaVal, formVal * 10];
       centroCharts.radar.update();

       // 2. Palancas
       const estados = [hitBool, aarBool, p1, pInf, pSeg, pStk];
       centroCharts.barras.data.datasets[0].backgroundColor = estados.map(s => s ? '#22c55e' : '#ef4444');
       centroCharts.barras.update();

       // 3. Areas Mejora
       let lbls = itemsFallidosGlobal.slice(0, 10);
       let dts = itemsFallidosGlobal.map(()=>1).slice(0,10);
       if(lbls.length===0) { lbls=["Sin incidencias"]; dts=[0]; }
       centroCharts.topAreas.data.labels = lbls;
       centroCharts.topAreas.data.datasets[0].data = dts;
       centroCharts.topAreas.update();

       // 4. Stack
       const total = conteoF1 + conteoF0;
       const pOk = total ? Math.round((conteoF1/total)*100) : 0;
       centroCharts.procesosResumen.data.datasets[0].data = [pOk];
       centroCharts.procesosResumen.data.datasets[1].data = [100 - pOk];
       centroCharts.procesosResumen.update();
    }
    
    $("#inpFormaciones").addEventListener("input", () => actualizarVisualesCentro($("#chkHit").checked, $("#chkAar").checked));
    $$(".checklist-visita input[type='checkbox']").forEach(ch => {
       ch.addEventListener("change", () => actualizarVisualesCentro($("#chkHit").checked, $("#chkAar").checked));
    });

    // NAVEGACI√ìN A INFORME
    function irAInforme(centroName, isoDate) {
       const c = centros.find(x => x.centro === centroName);
       if (!c) return;
       centroActual = c;
       
       $$(".nav-item").forEach(i => i.classList.toggle("active", i.dataset.page === "informe"));
       pages.forEach(p => p.classList.toggle("active", p.dataset.page === "informe"));
       
       $("#infCentro").value = c.centro; $("#infProvincia").value = c.provincia; $("#infDelegado").value = c.delegado;
       $("#infFecha").value = isoDate ? formatDateHuman(isoDate) : formatDateHuman(new Date().toISOString().slice(0,10));
       
       // Radio
       const tipo = tipoCentro(c.centro);
       if(tipo === "Exclusivo") $("#radExclusivo").checked = true; else $("#radCorner").checked = true;

       // Estado inicial
       $("#chkHit").checked = c.hit; $("#chkAar").checked = c.aar;
       
       itemsFallidosGlobal = []; conteoF1=0; conteoF0=0; $("#tbodyPrint").innerHTML = "";
       actualizarVisualesCentro(c.hit, c.aar);
    }

    document.addEventListener("click", e => {
       if (e.target.matches(".btn-ir-informe")) {
          const idx = parseInt(e.target.dataset.idx); visitaActual=visitas[idx];
          if(visitaActual) { visitaActual.estado="enproceso"; renderVisitas(); irAInforme(visitaActual.centro, visitaActual.fecha); }
       }
       if (e.target.matches(".btn-informe-centro")) { irAInforme(e.target.dataset.centro, formatDateISO(new Date())); }
    });

    $("#btnGuardarInforme").addEventListener("click", () => {
       if(centroActual) {
          centroActual.hit = $("#chkHit").checked; centroActual.aar = $("#chkAar").checked;
          recalcularKPIsGlobales(); informesPorCentro[centroActual.centro] = (informesPorCentro[centroActual.centro]||0)+1;
          renderTablaCentros();
       }
       alert("Informe guardado.");
    });

    // GLOBAL CHARTS INIT
    function initGlobalCharts() {
       const ctxR = document.getElementById("chartRadarGeneral").getContext("2d");
       globalCharts.radarGeneral = new Chart(ctxR, {
          type:"radar",
          data:{ labels:["Procesos","Prueba","Venta","HIT (%)","Form","AAR (%)"], datasets:[{ label:"Promedio %", data:[0,0,0,0,0,0], backgroundColor:"rgba(96,165,250,0.2)", borderColor:"#60a5fa" }] },
          options:{ scales:{r:{min:0, max:100, ticks:{display:false}}}, plugins:{legend:{display:false}} }
       });
       const aarHitCtx = document.getElementById("chartAarHitDonut").getContext("2d");
       globalCharts.aarHit = new Chart(aarHitCtx, {
          type:"doughnut", data:{ labels:["S√≠","No"], datasets:[{ data:[1,1], backgroundColor:["#22c55e","#ef4444"] }] }, options:{ cutout:"60%", plugins:{legend:{position:"bottom"}} }
       });
       // Dummys
       new Chart(document.getElementById("chartProcesosMes"), { type:"line", data:{labels:["E","F","M"],datasets:[{data:[80,82,85],borderColor:"#3b82f6"}]}, options:{maintainAspectRatio:false} });
       new Chart(document.getElementById("chartAreasMes"), { type:"bar", data:{labels:["E","F"],datasets:[{data:[5,3],backgroundColor:"#ef4444"}]}, options:{maintainAspectRatio:false} });
       new Chart(document.getElementById("chartPrimerosMes"), { type:"bar", data:{labels:["E","F"],datasets:[{data:[40,60],backgroundColor:"#22c55e"}]}, options:{maintainAspectRatio:false} });
       new Chart(document.getElementById("chartTopAreas"), { type:"bar", data:{labels:["Stock","Limpieza"],datasets:[{data:[10,5],backgroundColor:"#3b82f6"}]}, options:{indexAxis:"y",maintainAspectRatio:false} });
       
       // Criterios Globales (Empty)
       const ctxC = document.getElementById("chartCriteriosDetalle").getContext("2d");
       globalCharts.criteriosDetalle = new Chart(ctxC, { type: "bar", data: { labels: ["Sin datos"], datasets: [{ label: "%", data: [0], backgroundColor: "#38bdf8" }] }, options: { indexAxis: "y", maintainAspectRatio: false, plugins: { legend: { display:false } } } });
    }

    /* CARGA DEMO */
    function cargarCentrosDemo() {
      const demo = [
        { codigo:"4ABB", propietario:"MAZA Oriol", centro:"PAMPLONA C. Exclusivo", provincia:"NAVARRA", delegado:"Sonia Godino", hit:true, aar:false },
        { codigo:"4AFH", propietario:"MAZA Oriol", centro:"PAMPLONA Calle Sancho el Mayor", provincia:"NAVARRA", delegado:"Sonia Godino", hit:false, aar:true },
        { codigo:"4AWQ", propietario:"MAZA Oriol", centro:"PAMPLONA Carlos III", provincia:"NAVARRA", delegado:"Sonia Godino", hit:true, aar:true },
        { codigo:"4MRM", propietario:"AAO", centro:"REINA DE MERCEDES", provincia:"Madrid", delegado:"Sergio Per√°n", hit:false, aar:false },
        { codigo:"4PEC", propietario:"AAO", centro:"SANTANDER CC PE√ëACASTILLO", provincia:"Santander", delegado:"Sergio Per√°n", hit:true, aar:false },
        { codigo:"4AXF", propietario:"URRUTIA Esteban", centro:"SANTIAGO DE COMPOSTELA RUA DA ROSA", provincia:"A Coru√±a", delegado:"Daniel Chazo", hit:true, aar:true },
        { codigo:"4TOL", propietario:"AAO", centro:"TORRELAVEGA CARREFOUR CC", provincia:"Santander", delegado:"Sergio Per√°n", hit:false, aar:false },
        { codigo:"4ZDE", propietario:"AAO", centro:"ZARAGOZA CALLE DELICIAS", provincia:"ZARAGOZA", delegado:"ENERITZ ARANGUREN", hit:true, aar:false },
        { codigo:"4AKI", propietario:"PIEDRAFITA Rocio", centro:"CC LOS VALLES", provincia:"MADRID", delegado:"Blanca Fdez. de la Pradilla", hit:false, aar:false },
        { codigo:"4MLG", propietario:"AAO", centro:"FUENLABRADA Calle Leganes", provincia:"MADRID", delegado:"Marisa Carmona", hit:true, aar:true }
      ];
      demo.forEach(c => centros.push(c));
      actualizarListaCentrosDatalist(); renderTablaCentros(); renderDelegados();
    }

    window.addEventListener("load", () => {
      cargarCentrosDemo(); initCalendar(); initGlobalCharts(); recalcularKPIsGlobales();
    });
  </script>
</body>
</html>
