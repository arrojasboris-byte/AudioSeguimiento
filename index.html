<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AUDIOLOGIA-SEGUIMIENTO</title>
<style>
  :root{
    --brand:#c9161d; --brand2:#e63a40; --bg:#f3f4f6; --panel:#ffffff; --ink:#111827;
    --muted:#6b7280; --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626;
    --chip1:#e0f2fe; --chip2:#ecfccb; --chip3:#ede9fe; --chip4:#fee2e2; --chip5:#fef9c3;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.3 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  /* header */
  .bar{display:flex;align-items:center;gap:12px;background:var(--panel);border-radius:14px;padding:10px 12px;border:3px solid var(--brand);border-bottom-width:6px}
  .logoBox{width:160px;height:56px;border-radius:10px;background:#fafafa;border:1px dashed #d1d5db;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .logoBox img{max-height:54px;width:auto}
  h1{margin:0;font-size:26px;font-weight:800;letter-spacing:.3px}
  .grow{flex:1}
  .toolbar{display:flex;gap:8px}
  .btn{border:0;background:#111827;color:#fff;padding:10px;border-radius:10px;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  .btn.gray{background:#374151}
  .btn.red{background:var(--brand)}
  .btn.blue{background:#2563eb}
  .btn:hover{opacity:.95}
  .btn .i{font-style:normal}
  input[type="file"]{display:none}
  /* search */
  .search{margin:12px 0;background:var(--panel);border-radius:12px;padding:10px;border:1px solid #e5e7eb}
  .search input{width:100%;border:0;font-size:15px;padding:10px}
  /* layout */
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
  .panel{background:var(--panel);border-radius:14px;border:1px solid #e5e7eb}
  .pad{padding:12px}
  .title{font-weight:800;font-size:18px;margin:0 0 8px}
  .sub{color:var(--muted);font-size:13px}
  .row{display:flex;align-items:center;gap:10px}
  .right{display:flex;gap:6px;margin-left:auto}
  .pill{border-radius:999px;background:#eef2ff;color:#1f2937;font-size:12px;padding:2px 8px}
  .sep{height:1px;background:#e5e7eb;margin:8px 0}
  /* sections left */
  .secBox{border:1px solid #e5e7eb;border-radius:12px;margin:10px 0;overflow:hidden}
  .secHead{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#f9fafb}
  .secItems{padding:10px}
  .mini{display:flex;gap:8px;align-items:center;border:1px solid #e5e7eb;border-radius:10px;padding:8px;margin:8px 0;background:#fff}
  .mini .name{font-weight:700}
  .mini .meta{font-size:12px;color:var(--muted)}
  .chip{font-size:12px;border-radius:999px;padding:2px 8px;border:1px solid #e5e7eb}
  .mini .right .x{background:#fef2f2;color:#991b1b}
  .mini .right .ed{background:#eef2ff;color:#1e3a8a}
  .addSm{border:1px dashed #d1d5db;border-radius:10px;padding:6px 10px;background:#fafafa;cursor:pointer}
  /* procedures right */
  details{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;margin:10px 0;overflow:hidden}
  summary{list-style:none;cursor:pointer;padding:10px 12px;font-weight:800}
  summary::-webkit-details-marker{display:none}
  .box{padding:10px}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden}
  th,td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:left;font-size:14px}
  th{background:var(--brand);color:#fff}
  tr:last-child td{border-bottom:0}
  input[type="text"],input[type="date"],input[type="number"],select,textarea{
    width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:7px 8px;font-size:14px;background:#fff
  }
  textarea{min-height:70px;resize:vertical}
  .tRight{text-align:right}
  .sm{font-size:12px}
  .muted{color:var(--muted)}
  /* modals */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .card{background:#fff;border-radius:14px;max-width:520px;width:100%;padding:16px;border:2px solid var(--brand)}
  .card h3{margin:0 0 10px}
  .card .row{margin:6px 0}
  .flex{display:flex;gap:8px}
  .w50{width:50%}
  .notice{font-size:13px;color:var(--muted)}
  .foot{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .hidden{display:none}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#eff6ff;color:#1e3a8a;font-size:12px}
</style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="bar">
    <label class="logoBox" title="Logo (clic para cambiar)">
      <img id="logoImg" alt="Logo" />
      <input id="logoInput" type="file" accept="image/*">
    </label>
    <div>
      <div class="sm muted">Plataforma</div>
      <h1 id="brandTitle">AUDIOLOGIA-SEGUIMIENTO</h1>
    </div>
    <div class="grow"></div>

    <div class="toolbar">
      <button class="btn gray" id="btnLock" title="Desbloquear con PIN"><span class="i">üîí</span></button>
      <button class="btn gray" id="btnLogo" title="Cambiar logo"><span class="i">üñºÔ∏è</span></button>
      <button class="btn blue" id="btnLoadCloud" title="Actualizar desde nube"><span class="i">‚òÅÔ∏è‚Üª</span></button>
      <button class="btn red" id="btnSaveCloud" title="Guardar en nube (Gist)"><span class="i">‚òÅÔ∏è</span>Guardar</button>
      <button class="btn gray" id="btnBackup" title="Backup local"><span class="i">üíæ</span></button>
      <button class="btn gray" id="btnRestore" title="Cargar archivo backup"><span class="i">üì§</span></button>
      <button class="btn gray" id="btnCloudSetup" title="Ajustes de nube"><span class="i">‚öôÔ∏è</span></button>
      <input id="restoreInput" type="file" accept="application/json">
    </div>
  </div>

  <!-- SEARCH -->
  <div class="search">
    <input id="searchInput" placeholder="Buscar en secciones, centros y datos‚Ä¶">
  </div>

  <div class="grid">
    <!-- LEFT: SECTIONS -->
    <div class="panel pad" id="left">
      <div class="row">
        <div class="title">Secciones</div>
        <div class="right"><span class="pill" id="lastCloud">√öltima carga nube: ‚Äì</span></div>
      </div>

      <div id="sections"></div>
    </div>

    <!-- RIGHT: PROCEDURES -->
    <div class="panel pad" id="right">
      <div class="row">
        <div class="title">Procedimientos ‚Äî <span id="activeCentroName">‚Äì</span></div>
        <div class="right"><span class="pill" id="itemsCount">0 √≠tems</span></div>
      </div>

      <!-- Acciones-Resultado -->
      <details open id="blkAcciones">
        <summary>Acciones ‚Äì Resultado</summary>
        <div class="box">
          <div class="row"><div class="right"><button class="btn blue sm" id="addAccion">+ A√±adir</button></div></div>
          <div class="sep"></div>
          <table id="tblAcciones">
            <thead><tr><th>#</th><th>Fecha</th><th>Acci√≥n</th><th>Derivaci√≥n</th><th>Cita</th><th>Observaciones</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- Formaci√≥n continua -->
      <details id="blkFormacion">
        <summary>Formaci√≥n continua</summary>
        <div class="box">
          <div class="row"><div class="right"><button class="btn blue sm" id="addFormacion">+ A√±adir</button></div></div>
          <div class="sep"></div>
          <table id="tblFormacion">
            <thead><tr><th>#</th><th>Fecha</th><th>Asistencia</th><th>T√≠tulo</th><th>Aplicaci√≥n</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- Procesos -->
      <details id="blkProcesos">
        <summary>Procesos / Paquetes</summary>
        <div class="box">
          <div class="row"><div class="right"><button class="btn blue sm" id="addProceso">+ A√±adir</button></div></div>
          <div class="sep"></div>
          <table id="tblProcesos">
            <thead><tr><th>#</th><th>Nombre</th><th>Descripci√≥n</th><th>Puntuaci√≥n</th><th>Observaciones</th><th>Fecha visita</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

    </div>
  </div>
</div>

<!-- MODAL: CLOUD SETUP -->
<div class="modal" id="cloudModal">
  <div class="card">
    <h3>Ajustes de nube (Gist)</h3>
    <div class="notice">Pega un token de GitHub con permiso <b>gist</b>. Se guardar√° cifrado en tu navegador.</div>
    <div class="row"><input id="inpToken" placeholder="ghp_‚Ä¶ (scope: gist)"></div>
    <div class="row flex">
      <input class="w50" id="inpGistId" placeholder="Gist ID (vac√≠o para crear uno nuevo)">
      <label class="w50" style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="chkNewGist"> Crear Gist nuevo (secreto)
      </label>
    </div>
    <div class="row"><span class="notice">Tu Gist almacenar√° <code>audiologia.json</code>. Con el mismo Gist ID cualquier PC/m√≥vil podr√° cargar tu √∫ltima versi√≥n (‚òÅÔ∏è‚Üª).</span></div>
    <div class="foot">
      <button class="btn gray" id="btnCloudCancel">Cancelar</button>
      <button class="btn red" id="btnCloudSave">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: EDITAR/CREAR CENTRO -->
<div class="modal" id="centroModal">
  <div class="card">
    <h3 id="centroTitle">Centro</h3>
    <div class="row"><input id="cNombre" placeholder="Nombre del centro"></div>
    <div class="row flex">
      <input class="w50" id="cDelegado" placeholder="Delegado">
      <input class="w50" id="cAudiologo" placeholder="Audi√≥logo">
    </div>
    <div class="row">
      <select id="cTipo">
        <option value="Franquicia">Franquicia</option>
        <option value="Sucursal">Sucursal</option>
      </select>
    </div>
    <div class="foot">
      <button class="btn gray" id="btnCentroCancel">Cancelar</button>
      <button class="btn red" id="btnCentroOk">OK</button>
    </div>
  </div>
</div>

<script>
/* ================== Estado / Modelo ================== */
const PIN = "AR4321";
const CHIPS = ["var(--chip1)","var(--chip2)","var(--chip3)","var(--chip4)","var(--chip5)"];

const emptyData = () => ({
  meta:{
    title:"AUDIOLOGIA-SEGUIMIENTO",
    logoDataUrl:"",
    lastCloud:"",
    gistId:"",
  },
  cloud:{ encToken:"" }, // token cifrado (simple)
  centros:[
    {id:1,nombre:"Centro Madrid Norte",delegado:"Ana Mart√≠nez",audiologo:"Dr. Garc√≠a",tipo:"Franquicia",kind:"exclusivo",color:0},
    {id:2,nombre:"Centro Barcelona Centro",delegado:"Carlos Ruiz",audiologo:"Dra. L√≥pez",tipo:"Sucursal",kind:"exclusivo",color:1},
  ],
  flop:[],
  mentoring:[],
  visitas:[],
  proc:{ // procedimientos por centroId
    1: {acciones:[{id:1,fecha:"",accion:"",derivacion:0,cita:0,obs:""}],
        formacion:[{id:1,fecha:"",asis:"",titulo:"",apli:""}],
        procesos:[{id:1,nombre:"",desc:"",punt:"",obs:"",fecha:""}]},
    2: {acciones:[{id:1,fecha:"",accion:"",derivacion:0,cita:0,obs:""}],
        formacion:[{id:1,fecha:"",asis:"",titulo:"",apli:""}],
        procesos:[{id:1,nombre:"",desc:"",punt:"",obs:"",fecha:""}]},
  },
  ui:{activeCentro:1}
});

let DB = JSON.parse(localStorage.getItem("audio_db_v1")||"null") || emptyData();
saveLocal(); // normaliza

function saveLocal(){
  localStorage.setItem("audio_db_v1", JSON.stringify(DB));
  document.getElementById("brandTitle").textContent = DB.meta.title || "AUDIOLOGIA-SEGUIMIENTO";
  document.getElementById("logoImg").src = DB.meta.logoDataUrl || "";
  document.getElementById("lastCloud").textContent = "√öltima carga nube: " + (DB.meta.lastCloud||"‚Äì");
}

function setActiveCentro(id){
  DB.ui.activeCentro = id;
  saveLocal();
  renderAll();
}

/* ================== Utiles ================== */
function uid(list){ return (Math.max(0,...list.map(x=>x.id||0))+1)||1; }
function fmtNow(){ const d=new Date(); return d.toLocaleString("es-ES"); }
function alertMsg(txt){ window.alert(txt); }

/* cifrado muy simple para token (solo ofuscaci√≥n) */
function enc(s){ try{ return btoa(unescape(encodeURIComponent(s))); }catch(e){ return s; } }
function dec(s){ try{ return decodeURIComponent(escape(atob(s))); }catch(e){ return s; } }

/* ================== Render secciones ================== */
function renderSections(){
  const wrap = document.getElementById("sections");
  wrap.innerHTML = "";

  // bloque generico
  function block(title, key, kindLabel){
    const box = document.createElement("div");
    box.className="secBox";
    box.innerHTML = `
      <div class="secHead">
        <div class="row">
          <div class="title">${title}</div>
          <span class="pill">${(DB[key]||[]).length}</span>
        </div>
        <div class="right">
          <button class="btn gray sm" data-add="${key}">Ôºã Sub</button>
        </div>
      </div>
      <div class="secItems" id="lst_${key}"></div>
    `;
    wrap.appendChild(box);

    const lst = box.querySelector("#lst_"+key);
    const items = DB[key]||[];
    items.forEach((c,i)=>{
      const chipColor = CHIPS[c.color % CHIPS.length];
      const mini = document.createElement("div");
      mini.className="mini";
      mini.style.background = "#fff";
      mini.innerHTML = `
        <div class="chip" style="background:${chipColor};border-color:#d1d5db">${kindLabel||""}</div>
        <div>
          <div class="name">${c.nombre}</div>
          <div class="meta">üë§ ${c.delegado} ¬∑ üéß ${c.audiologo} ¬∑ üìç ${c.tipo||"-"}</div>
        </div>
        <div class="right" style="margin-left:auto">
          <button class="btn gray sm ed" data-ed="${key}:${c.id}">‚úé</button>
          <button class="btn gray sm x" data-del="${key}:${c.id}">üóë</button>
          <button class="btn blue sm" data-sel="${key}:${c.id}">Seleccionar</button>
        </div>
      `;
      lst.appendChild(mini);
    });

    box.querySelector('[data-add]').onclick = ()=> openCentroModal({key});
  }

  // Exclusivos (centros)
  (function(){
    const box = document.createElement("div");
    box.className="secBox";
    box.innerHTML = `
      <div class="secHead">
        <div class="title">Centros Exclusivos</div>
        <div class="right">
          <button class="btn gray sm" id="addCent">Ôºã Sub</button>
        </div>
      </div>
      <div class="secItems" id="lst_cent"></div>
    `;
    wrap.appendChild(box);
    const lst = box.querySelector("#lst_cent");
    DB.centros.forEach(c=>{
      const chipColor = CHIPS[c.color % CHIPS.length];
      const mini = document.createElement("div");
      mini.className="mini";
      mini.innerHTML = `
        <div class="chip" style="background:${chipColor};border-color:#d1d5db">Exclusivo</div>
        <div>
          <div class="name">${c.nombre}</div>
          <div class="meta">üë§ ${c.delegado} ¬∑ üéß ${c.audiologo} ¬∑ üìç ${c.tipo||"-"}</div>
        </div>
        <div class="right" style="margin-left:auto">
          <button class="btn gray sm ed" data-ed="centros:${c.id}">‚úé</button>
          <button class="btn gray sm x" data-del="centros:${c.id}">üóë</button>
          <button class="btn blue sm" data-sel="centros:${c.id}">Seleccionar</button>
        </div>
      `;
      lst.appendChild(mini);
    });
    box.querySelector("#addCent").onclick = ()=> openCentroModal({key:"centros"});
    lst.addEventListener("click",(e)=>{
      const t=e.target.closest("button"); if(!t) return;
      if(t.dataset.sel){ const [key,id]=t.dataset.sel.split(":"); setActiveCentro(+id); }
      if(t.dataset.ed){ const [key,id]=t.dataset.ed.split(":"); openCentroModal({key,id:+id}); }
      if(t.dataset.del){ const [key,id]=t.dataset.del.split(":"); delCentro(key,+id); }
    });
  })();

  block("Centros FLOP","flop","FLOP");
  block("Formaciones ‚Äì Mentoring","mentoring","Mentoring");
  block("Visitas a centros","visitas","Visitas");

  wrap.querySelectorAll("[data-add]").forEach(b=>{
    b.onclick = ()=>{
      const key=b.dataset.add;
      openCentroModal({key});
    };
  });
  wrap.addEventListener("click",(e)=>{
    const t=e.target.closest("button"); if(!t) return;
    if(t.dataset.sel){ const [key,id]=t.dataset.sel.split(":"); /* para otras secciones no hay proc */ }
    if(t.dataset.ed){ const [key,id]=t.dataset.ed.split(":"); openCentroModal({key,id:+id}); }
    if(t.dataset.del){ const [key,id]=t.dataset.del.split(":"); delCentro(key,+id); }
  });
}

function delCentro(key,id){
  if(!confirm("¬øEliminar este elemento?")) return;
  DB[key]=DB[key].filter(x=>x.id!==id);
  if(key==="centros"){
    delete DB.proc[id];
    if(DB.ui.activeCentro===id){
      const nxt = DB.centros[0]?.id || null;
      DB.ui.activeCentro = nxt;
    }
  }
  saveLocal(); renderAll();
}

function openCentroModal({key,id}){
  const mdl = document.getElementById("centroModal");
  const title = document.getElementById("centroTitle");
  const cN = document.getElementById("cNombre");
  const cD = document.getElementById("cDelegado");
  const cA = document.getElementById("cAudiologo");
  const cT = document.getElementById("cTipo");
  cN.value=cD.value=cA.value=""; cT.value="Franquicia";
  if(id){
    const arr=DB[key]; const it=arr.find(x=>x.id===id);
    cN.value=it.nombre; cD.value=it.delegado||""; cA.value=it.audiologo||""; cT.value=it.tipo||"Franquicia";
    title.textContent = "Editar";
  }else{
    title.textContent = "A√±adir";
  }
  mdl.style.display="flex";
  document.getElementById("btnCentroCancel").onclick = ()=> mdl.style.display="none";
  document.getElementById("btnCentroOk").onclick = ()=>{
    const obj={nombre:cN.value.trim(),delegado:cD.value.trim(),audiologo:cA.value.trim(),tipo:cT.value, color: Math.floor(Math.random()*CHIPS.length)};
    if(!obj.nombre){ alertMsg("Nombre requerido"); return;}
    if(id){
      const idx=DB[key].findIndex(x=>x.id===id);
      DB[key][idx] = {...DB[key][idx],...obj};
    }else{
      const nid = uid(DB[key]||[]);
      (DB[key]=DB[key]||[]).push({id:nid, ...obj});
      if(key==="centros"){ DB.proc[nid] = {acciones:[{id:1,fecha:"",accion:"",derivacion:0,cita:0,obs:""}],formacion:[{id:1,fecha:"",asis:"",titulo:"",apli:""}],procesos:[{id:1,nombre:"",desc:"",punt:"",obs:"",fecha:""}]}; }
    }
    saveLocal(); mdl.style.display="none"; renderAll();
  };
}

/* ================== Render procedimientos ================== */
function getProc(id){ if(!DB.proc[id]) DB.proc[id]={acciones:[],formacion:[],procesos:[]}; return DB.proc[id]; }

function renderProcedures(){
  const id = DB.ui.activeCentro;
  const centro = DB.centros.find(x=>x.id===id);
  document.getElementById("activeCentroName").textContent = centro? centro.nombre : "‚Äì";

  const P = getProc(id);
  // Acciones
  const tbA = document.querySelector("#tblAcciones tbody");
  tbA.innerHTML="";
  P.acciones.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td><input type="date" value="${r.fecha||""}"></td>
      <td><input type="text" value="${r.accion||""}" placeholder="Descripci√≥n‚Ä¶"></td>
      <td><input type="number" value="${r.derivacion||0}"></td>
      <td><input type="number" value="${r.cita||0}"></td>
      <td><input type="text" value="${r.obs||""}" placeholder="Observaciones‚Ä¶"></td>
      <td class="tRight"><button class="btn gray sm" data-del="acc:${r.id}">‚úñ</button></td>
    `;
    tbA.appendChild(tr);
    const [f,a,d,c,o]=tr.querySelectorAll("input");
    f.oninput=()=>{r.fecha=f.value;saveLocal();};
    a.oninput=()=>{r.accion=a.value;saveLocal();};
    d.oninput=()=>{r.derivacion=+d.value||0;saveLocal();};
    c.oninput=()=>{r.cita=+c.value||0;saveLocal();};
    o.oninput=()=>{r.obs=o.value;saveLocal();};
    tr.querySelector("[data-del]").onclick=()=>{ if(P.acciones.length>1){ P.acciones = P.acciones.filter(x=>x.id!==r.id); saveLocal(); renderProcedures(); }};
  });
  document.getElementById("addAccion").onclick=()=>{
    P.acciones.push({id:uid(P.acciones),fecha:"",accion:"",derivacion:0,cita:0,obs:""});
    saveLocal(); renderProcedures();
  };

  // Formacion
  const tbF = document.querySelector("#tblFormacion tbody");
  tbF.innerHTML="";
  P.formacion.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td><input type="date" value="${r.fecha||""}"></td>
      <td>
        <select>
          <option value=""></option>
          <option ${r.asis==="SI"?"selected":""}>SI</option>
          <option ${r.asis==="NO"?"selected":""}>NO</option>
          <option ${r.asis==="Pendiente"?"selected":""}>Pendiente</option>
        </select>
      </td>
      <td><input type="text" value="${r.titulo||""}" placeholder="T√≠tulo‚Ä¶"></td>
      <td><input type="text" value="${r.apli||""}" placeholder="Aplicaci√≥n o SI/NO‚Ä¶"></td>
      <td class="tRight"><button class="btn gray sm" data-del="for:${r.id}">‚úñ</button></td>
    `;
    tbF.appendChild(tr);
    const f=tr.querySelector('input[type="date"]');
    const s=tr.querySelector('select');
    const t=tr.querySelectorAll('input[type="text"]')[0];
    const a=tr.querySelectorAll('input[type="text"]')[1];
    f.oninput=()=>{r.fecha=f.value;saveLocal();};
    s.oninput=()=>{r.asis=s.value;saveLocal();};
    t.oninput=()=>{r.titulo=t.value;saveLocal();};
    a.oninput=()=>{r.apli=a.value;saveLocal();};
    tr.querySelector("[data-del]").onclick=()=>{ if(P.formacion.length>1){ P.formacion=P.formacion.filter(x=>x.id!==r.id); saveLocal(); renderProcedures(); }};
  });
  document.getElementById("addFormacion").onclick=()=>{
    P.formacion.push({id:uid(P.formacion),fecha:"",asis:"",titulo:"",apli:""});
    saveLocal(); renderProcedures();
  };

  // Procesos
  const tbP = document.querySelector("#tblProcesos tbody");
  tbP.innerHTML="";
  P.procesos.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td><input type="text" value="${r.nombre||""}" placeholder="Nombre‚Ä¶"></td>
      <td><input type="text" value="${r.desc||""}" placeholder="Descripci√≥n‚Ä¶"></td>
      <td><input type="text" value="${r.punt||""}" placeholder="Ej: 8/10"></td>
      <td><input type="text" value="${r.obs||""}" placeholder="Observaciones‚Ä¶"></td>
      <td><input type="date" value="${r.fecha||""}"></td>
      <td class="tRight"><button class="btn gray sm" data-del="pro:${r.id}">‚úñ</button></td>
    `;
    tbP.appendChild(tr);
    const [n,d,p,o,f]=tr.querySelectorAll("input");
    n.oninput=()=>{r.nombre=n.value;saveLocal();};
    d.oninput=()=>{r.desc=d.value;saveLocal();};
    p.oninput=()=>{r.punt=p.value;saveLocal();};
    o.oninput=()=>{r.obs=o.value;saveLocal();};
    f.oninput=()=>{r.fecha=f.value;saveLocal();};
    tr.querySelector("[data-del]").onclick=()=>{ if(P.procesos.length>1){ P.procesos=P.procesos.filter(x=>x.id!==r.id); saveLocal(); renderProcedures(); }};
  });
  document.getElementById("addProceso").onclick=()=>{
    P.procesos.push({id:uid(P.procesos),nombre:"",desc:"",punt:"",obs:"",fecha:""});
    saveLocal(); renderProcedures();
  };

  document.getElementById("itemsCount").textContent =
    (P.acciones.length + P.formacion.length + P.procesos.length) + " √≠tems";
}

/* ================== Render global ================== */
function renderAll(){
  renderSections();
  renderProcedures();
}

/* ================== B√∫squeda simple ================== */
document.getElementById("searchInput").oninput = (e)=>{
  const q=e.target.value.trim().toLowerCase();
  document.querySelectorAll(".mini").forEach(el=>{
    const t=el.textContent.toLowerCase();
    el.style.display = t.includes(q) ? "" : "none";
  });
};

/* ================== Logo + t√≠tulo ================== */
document.getElementById("btnLogo").onclick = ()=> document.getElementById("logoInput").click();
document.getElementById("logoInput").onchange = (e)=>{
  const f=e.target.files[0]; if(!f) return;
  // Redimensiona a alto m√°ximo 56px para no romper cabecera
  const img=new Image(); const reader=new FileReader();
  reader.onload = ev=>{
    img.onload = ()=>{
      const h=56, ratio=img.width/img.height, w=h*ratio;
      const cv=document.createElement("canvas"); cv.width=w; cv.height=h;
      const ctx=cv.getContext("2d"); ctx.drawImage(img,0,0,w,h);
      DB.meta.logoDataUrl = cv.toDataURL("image/png");
      saveLocal(); renderAll();
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(f);
};

/* ================== PIN lock ================== */
let unlocked=false;
function requireUnlock(){
  if(!unlocked){
    const p=prompt("PIN:");
    if(p!==PIN){ alertMsg("PIN incorrecto"); return false; }
    unlocked=true;
    document.getElementById("btnLock").textContent="üîì";
  }
  return true;
}
document.getElementById("btnLock").onclick=()=>{ if(requireUnlock()) alertMsg("Edici√≥n desbloqueada"); };

/* ================== Modal Cloud ================== */
const Mcloud = document.getElementById("cloudModal");
document.getElementById("btnCloudSetup").onclick=()=>{
  if(!requireUnlock()) return;
  document.getElementById("inpToken").value = DB.cloud.encToken? "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" : "";
  document.getElementById("inpGistId").value = DB.meta.gistId||"";
  document.getElementById("chkNewGist").checked = !DB.meta.gistId;
  Mcloud.style.display="flex";
};
document.getElementById("btnCloudCancel").onclick=()=> Mcloud.style.display="none";
document.getElementById("btnCloudSave").onclick=()=>{
  const t = document.getElementById("inpToken").value.trim();
  if(t && !t.startsWith("ghp_")){ alertMsg("Token inv√°lido"); return; }
  if(t) DB.cloud.encToken = enc(t);
  DB.meta.gistId = document.getElementById("inpGistId").value.trim();
  if(document.getElementById("chkNewGist").checked) DB.meta.gistId="";
  saveLocal();
  Mcloud.style.display="none";
  alertMsg("Ajustes guardados.");
};

/* ================== GitHub Gist API ================== */
async function gistFetch(method, url, body){
  const token = dec(DB.cloud.encToken||"");
  if(!token){ throw new Error("No hay token de GitHub (gist)"); }
  const res = await fetch(url,{
    method,
    headers:{
      "Accept":"application/vnd.github+json",
      "Authorization":"token "+token,
    },
    body: body? JSON.stringify(body): undefined
  });
  if(!res.ok){ const txt=await res.text(); throw new Error("GitHub "+res.status+": "+txt); }
  return res.json();
}

async function cloudSave(){
  try{
    const token = dec(DB.cloud.encToken||"");
    if(!token){ alertMsg("Configura la nube primero (‚öôÔ∏è)"); return; }
    const payload = JSON.stringify(DB);
    let data;
    if(DB.meta.gistId){
      data = await gistFetch("PATCH","https://api.github.com/gists/"+DB.meta.gistId,{
        files:{ "audiologia.json":{ content: payload } }
      });
    }else{
      data = await gistFetch("POST","https://api.github.com/gists",{
        description:"AudioSeguimiento data",
        public:false,
        files:{ "audiologia.json":{ content: payload } }
      });
      DB.meta.gistId = data.id;
      saveLocal();
    }
    DB.meta.lastCloud = fmtNow();
    saveLocal();
    alertMsg("Guardado en nube OK.\nGist ID:\n"+DB.meta.gistId);
  }catch(err){
    alertMsg("Error al guardar en nube:\n"+err.message);
  }
}
async function cloudLoad(){
  try{
    const token = dec(DB.cloud.encToken||"");
    if(!token){ alertMsg("Configura la nube primero (‚öôÔ∏è)"); return; }
    if(!DB.meta.gistId){ alertMsg("No hay Gist ID. Abre ‚öôÔ∏è y crea uno o pega tu ID."); return; }
    const data = await gistFetch("GET","https://api.github.com/gists/"+DB.meta.gistId);
    const file = data.files["audiologia.json"];
    if(!file) throw new Error("No existe audiologia.json en tu Gist.");
    const txt = file.content;
    const json = JSON.parse(txt);
    DB = json; // reemplaza
    saveLocal();
    renderAll();
    alertMsg("Cargado desde nube OK.");
  }catch(err){
    alertMsg("No se pudo leer de la nube: "+err.message);
  }
}

/* ================== Backup local ================== */
document.getElementById("btnBackup").onclick=()=>{
  const blob = new Blob([JSON.stringify(DB,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="data.json"; a.click();
  URL.revokeObjectURL(a.href);
};
document.getElementById("btnRestore").onclick=()=> document.getElementById("restoreInput").click();
document.getElementById("restoreInput").onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      DB = JSON.parse(ev.target.result);
      saveLocal(); renderAll();
      alertMsg("Backup cargado.");
    }catch(err){ alertMsg("Archivo inv√°lido"); }
  };
  r.readAsText(f);
};

/* ================== Botones nube ================== */
document.getElementById("btnSaveCloud").onclick=()=> cloudSave();
document.getElementById("btnLoadCloud").onclick=()=> cloudLoad();

/* ================== iniciar ================== */
renderAll();
</script>
</body>
</html>
