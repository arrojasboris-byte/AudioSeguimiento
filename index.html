<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SEGUIMIENTO AUDIO ¬∑ Cloud</title>
<meta name="theme-color" content="#c82727"/>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
:root{
  --rojo:#c82727; --rojo2:#a71f1f;
  --bg:#f6f7fb; --line:#e6e7ee; --shadow:0 4px 14px rgba(0,0,0,.06);
  --col-ex:#fde2e4; --col-fl:#e2f0cb; --col-az:#cde7f0; --col-ta:#eadcf8; --col-eq:#e8f1ff; --col-am:#fff4cc;
  --fs:11.5px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;font-size:var(--fs);color:#222;line-height:1.18}

/* Top bar (roja) */
.topbar{position:sticky;top:0;z-index:999;width:100%;
  background:linear-gradient(180deg,var(--rojo),var(--rojo2));color:#fff;box-shadow:var(--shadow)}
.topbar .row{display:grid;grid-template-columns:1fr auto 1fr;gap:.5rem;align-items:center;padding:.65rem .85rem;max-width:1400px;margin:0 auto}
.topbar h1{margin:0;font-size:24px;letter-spacing:.3px;display:flex;gap:.5rem;align-items:center}
.topbar h1 .brand{font-weight:900}
.btn{border:1px solid #0001;background:#fff;border-radius:999px;padding:.28rem .6rem;font-weight:700;cursor:pointer}
.btn.primary{background:#fff;color:#c22727;border-color:#fff}
.btn.ghost{background:#ffffff10;color:#fff;border-color:#ffffff50}
.badge{background:#ffe7e7;border:1px solid #ffd9d9;padding:.12rem .5rem;border-radius:999px}
.small{font-size:.92em}
.right{justify-self:end}

/* Layout */
.layout{display:grid;grid-template-columns:260px 1fr;gap:10px;padding:10px;max-width:1400px;margin:0 auto}
.side{display:flex;flex-direction:column;gap:10px}
.side-card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow)}
.side-head{display:flex;justify-content:space-between;align-items:center;padding:.55rem .6rem;border-bottom:1px solid var(--line);font-weight:800}
.side-list{padding:.5rem .6rem;display:flex;flex-direction:column;gap:.45rem}
.side-btn{border:1px solid #0001;background:#fff;border-radius:8px;padding:.1rem .4rem;font-weight:800;cursor:pointer}

.main{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);min-height:70vh}
.main-head{display:flex;justify-content:space-between;align-items:center;padding:.6rem .8rem;border-bottom:1px solid var(--line)}
.main-body{padding:.6rem .8rem}

/* Tabla */
.table{width:100%;border-collapse:separate;border-spacing:0;min-width:900px}
.table th,.table td{border:1px solid var(--line);padding:.35rem .4rem;vertical-align:middle}
.table th{background:#fafbff;text-align:left;position:sticky;top:0;z-index:1}
.table tfoot td{font-weight:800;background:#fcfcff}
.table input[type="text"], .table input[type="number"], .table input[type="date"], .table select{
  width:100%;border:1px solid var(--line);padding:.22rem .32rem;border-radius:6px;background:#fff;font-size:inherit
}
.table-wrap{overflow:auto;max-height:66vh}
.row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
.col{display:flex;flex-direction:column;gap:.5rem}

/* Indicadores */
.kpi{display:flex;gap:.5rem;align-items:center}
.kpi .dot{width:.65rem;height:.65rem;border-radius:999px;background:#eee;border:1px solid #0002}
.kpi.green .dot{background:#c7f7d3;border-color:#96ddab}
.kpi.orange .dot{background:#ffe6c5;border-color:#ffcf91}

/* Colores */
.cv-good{color:#1b5e20}
.cv-bad{color:#c62828}
.score-ok{background:#e7f8ec}
.score-mid{background:#fff5da}
.score-bad{background:#ffe8e8}
.pct-ok{background:#e7f8ec}
.pct-bad{background:#ffe8e8}

/* HIT */
.hitbox{display:flex;justify-content:center;align-items:center;border-radius:6px;padding:.05rem .1rem;border:1px solid #0002}
.hit-off{background:#ffe8e8}
.hit-on{background:#e7f8ec}

/* PIN */
#pinModal{position:fixed;inset:0;background:rgba(0,0,0,.67);display:flex;align-items:center;justify-content:center;z-index:9999}
.pin-card{background:#111;color:#fff;border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.5);width:min(92vw,420px);padding:1.2rem}
.pin-card h3{margin:.2rem 0 1rem}
.pin-row{display:flex;gap:.45rem;align-items:center}
.pin-row input{flex:1;border-radius:8px;border:1px solid #333;background:#000;color:#fff;padding:.5rem .6rem;letter-spacing:.35rem}
.pin-actions{display:flex;gap:.5rem;margin-top:.8rem}

/* Helpers */
.pill{border:1px solid #0002;background:#fff;border-radius:999px;padding:.18rem .5rem}
.note{opacity:.72}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="row">
    <div class="left">
      <button class="btn ghost small" id="btnRefresh" title="Recargar">Actualizar</button>
      <button class="btn ghost small" id="btnSaveLocal" title="Guardar en este navegador">Guardar (local)</button>
      <button class="btn primary small" id="btnSaveCloud" title="Guardar en la nube (Apps Script)">Guardar (nube)</button>
      <button class="btn ghost small" id="btnRecover" title="Importar JSON anterior">Recuperar‚Ä¶</button>
    </div>
    <h1><span>üéß</span><span class="brand">SEGUIMIENTO AUDIO</span></h1>
    <div class="right">
      <span class="badge small" id="statusTag">Local ¬∑ listo</span>
    </div>
  </div>
</div>

<!-- LAYOUT -->
<div class="layout">
  <!-- SIDEBAR -->
  <aside class="side">

    <!-- CIFRA DE VENTAS -->
    <div class="side-card" style="background:var(--col-ex)">
      <div class="side-head">
        <div>üßæ CIFRA DE VENTAS</div>
        <div><button class="side-btn" data-open="cv">‚ñ∏</button></div>
      </div>
      <div class="side-list" style="gap:.55rem">
        <div class="row" style="justify-content:space-between;align-items:center">
          <strong>Compa√±√≠a</strong>
          <button class="btn pill" id="cvOpenComp">Abrir</button>
        </div>
        <hr style="border:none;border-top:1px solid #0001">
        <div class="row" style="justify-content:space-between;align-items:center">
          <strong>Centros exclusivos</strong>
          <button class="btn pill" id="cvAddEx">Ôºã</button>
        </div>
        <input id="cvSearchEx" placeholder="Buscar centro exclusivo‚Ä¶"/>
        <div id="cvListEx"></div>
      </div>
    </div>

    <!-- CENTROS EXCLUSIVOS (general) -->
    <div class="side-card" style="background:var(--col-ex)">
      <div class="side-head"><div>üè¨ CENTROS EXCLUSIVOS</div><div><button class="side-btn" data-open="ex">‚ñ∏</button></div></div>
      <div class="side-list">
        <div class="row"><button class="btn pill small" id="exAdd">Ôºã A√±adir</button><input id="exSearch" placeholder="Buscar..."/></div>
        <div id="exList"></div>
      </div>
    </div>

    <!-- CENTROS FLOP -->
    <div class="side-card" style="background:var(--col-fl)">
      <div class="side-head"><div>üè∑Ô∏è CENTROS FLOP</div><div><button class="side-btn" data-open="flop">‚ñ∏</button></div></div>
      <div class="side-list">
        <div class="row"><button class="btn pill small" id="flopAdd">Ôºã A√±adir</button><input id="flopSearch" placeholder="Buscar..."/></div>
        <div id="flopList"></div>
      </div>
    </div>

    <!-- VISITAS AUDIO -->
    <div class="side-card" style="background:var(--col-az)">
      <div class="side-head"><div>üìã VISITAS AUDIO</div><div><button class="side-btn" data-open="va">‚ñ∏</button></div></div>
      <div class="side-list"><div class="small note">Hasta 250 filas, admite pegado desde Excel.</div></div>
    </div>

    <!-- FORMACIONES Y MENTORING -->
    <div class="side-card" style="background:var(--col-am)">
      <div class="side-head"><div>üéì FORMACIONES Y MENTORING</div><div><button class="side-btn" data-open="fm">‚ñ∏</button></div></div>
      <div class="side-list">
        <button class="btn pill" data-fm="mentoring">Mentoring</button>
        <button class="btn pill" data-fm="coaching">Coaching</button>
        <button class="btn pill" data-fm="generales">Generales</button>
      </div>
    </div>

    <!-- TELEAUDIOLOG√çA -->
    <div class="side-card" style="background:var(--col-ta)">
      <div class="side-head"><div>üñ•Ô∏è TELEAUDIOLOG√çA</div><div><button class="side-btn" data-open="ta">‚ñ∏</button></div></div>
      <div class="side-list"><div class="kpi green"><div class="dot"></div> Certificados</div><div class="kpi orange"><div class="dot"></div> Formaciones</div></div>
    </div>

    <!-- EQUIPOS -->
    <div class="side-card" style="background:var(--col-eq)">
      <div class="side-head"><div>üß∞ EQUIPOS</div><div><button class="side-btn" data-open="eq">‚ñ∏</button></div></div>
      <div class="side-list"><div class="small">7 packs, buscador y ‚ÄúÔºã‚Äù por pack.</div></div>
    </div>

  </aside>

  <!-- MAIN -->
  <section class="main">
    <div class="main-head">
      <div class="row"><strong id="detTag">Detalle</strong></div>
      <div class="row small" id="cvHeaderMeta" style="display:none;gap:.35rem"><span class="pill">CIFRA</span></div>
    </div>
    <div class="main-body" id="detBody"><div class="small note">Selecciona una opci√≥n a la izquierda.</div></div>
  </section>
</div>

<!-- PIN -->
<div id="pinModal" aria-modal="true" role="dialog">
  <div class="pin-card">
    <h3>Acceso</h3>
    <div class="small" style="opacity:.9">Introduce el PIN para editar:</div>
    <div class="pin-row" style="margin-top:.45rem"><input id="pin" type="password" maxlength="4" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
    <div class="pin-actions"><button class="btn primary" id="enter">Acceder</button><button class="btn" id="clear">Limpiar</button></div>
    <div id="pinMsg" class="small" style="color:#ffb3b3;margin-top:.4rem;display:none">PIN incorrecto</div>
  </div>
</div>

<script>
<script>
<script>
/* ======== CONFIG ========= */
const GAS_URL  = 'https://script.google.com/macros/s/AKfyc...TU_EXEC.../exec';  // ‚Üê pega aqu√≠ tu /exec
const PIN_CODE = '4321';
</script>

<!-- =========================================================
     PARCHE ANTI-DUPLICADOS DE TOPBAR (se conserva)
     ========================================================= -->
<style>
  /* Si el SW o recargas crean varias topbars, se oculta toda menos la 1¬™ */
  .topbar:not(:first-of-type){display:none !important}
</style>

<!-- =========================================================
     GUARD contra doble inicializaci√≥n (se conserva)
     ========================================================= -->
<script>
  if (window.__SEGUI_AUDIO_INITED__) {
    console.warn('UI ya inicializada ‚Äî evitando duplicaci√≥n');
  } else {
    window.__SEGUI_AUDIO_INITED__ = true;
  }
</script>

<!-- =========================================================
     PUENTE DE GUARDADO EN NUBE (Apps Script) SIN PREFLIGHT
     ========================================================= -->
<script id="cloud-bridge">
(() => {
  /*** 1) Utilidades ***/
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  // Localiza un bot√≥n por su texto visible (case-insensitive)
  const findButtonByText = (txt) => {
    const t = (txt||'').trim().toLowerCase();
    for (const b of $$('button, a.btn, a')) {
      const v = (b.textContent || '').trim().toLowerCase();
      if (v.includes(t)) return b;
    }
    return null;
  };

  // Toast simple (cae en alert si no hay estilos)
  const toast = (msg, ok=true) => {
    try {
      const box = document.createElement('div');
      box.textContent = msg;
      box.style.cssText = `
        position:fixed;left:50%;top:20px;transform:translateX(-50%);
        z-index:999999;padding:.6rem .9rem;border-radius:8px;
        background:${ok?'#19c37d':'#e74c3c'};color:#fff;
        font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.15);
      `;
      document.body.appendChild(box);
      setTimeout(()=>box.remove(), 2800);
    } catch { alert(msg); }
  };

  /*** 2) Export/import del estado ***/
  // Si tu app define exportJSON()/importJSON(json) los usamos;
  // si no, hacemos snapshot de localStorage y luego recarga.
  const exportState = () => {
    if (typeof window.exportJSON === 'function') {
      try { return window.exportJSON(); } catch {}
    }
    const snap = {};
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      snap[k] = localStorage.getItem(k);
    }
    return JSON.stringify({__type:'localStorage', data:snap});
  };

  const importState = (json) => {
    let data = json;
    if (typeof data === 'string') {
      try { data = JSON.parse(data); } catch {}
    }
    if (typeof window.importJSON === 'function') {
      try { window.importJSON(data); return true; } catch {}
    }
    if (data && data.__type === 'localStorage' && data.data && typeof data.data === 'object') {
      Object.keys(data.data).forEach(k => localStorage.setItem(k, data.data[k]));
      return true;
    }
    try {
      localStorage.setItem('__segui_audio_cloud_raw__', (typeof json === 'string') ? json : JSON.stringify(json));
    } catch {}
    return true;
  };

  /*** 3) Llamadas a Apps Script (sin preflight) ***/
  const saveCloud = async () => {
    if (!GAS_URL || !/\/exec(\?|$)/.test(GAS_URL)) {
      alert('Configura GAS_URL con tu /exec de Apps Script');
      return;
    }
    try {
      const payload = {
        action: 'save',
        data: exportState()              // mantenemos el contenido tal cual (string u objeto)
      };
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },  // evita preflight
        body: JSON.stringify(payload),
        cache: 'no-store',
        mode: 'cors'
      });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const txt = await res.text();
      let out = null; try { out = JSON.parse(txt); } catch {}
      if (out && out.ok) {
        toast('Guardado en nube ‚úì', true);
      } else {
        throw new Error((out && out.error) || 'Respuesta inv√°lida');
      }
    } catch (e) {
      console.error(e);
      alert('Error guardando en nube: ' + (e.message || e));
    }
  };

  const loadCloud = async () => {
    if (!GAS_URL || !/\/exec(\?|$)/.test(GAS_URL)) {
      alert('Configura GAS_URL con tu /exec de Apps Script');
      return;
    }
    try {
      const res = await fetch(GAS_URL + (GAS_URL.includes('?') ? '&' : '?') + 'action=load', {
        method: 'GET',
        cache: 'no-store',
        mode: 'cors'
      });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const txt = await res.text();
      let out = null; try { out = JSON.parse(txt); } catch {}
      const raw = out && out.data ? out.data : txt;
      if (!raw || raw === 'null' || raw === '""') {
        toast('No hay datos en nube todav√≠a', false);
        return;
      }
      importState(raw);
      toast('Datos recuperados. Recargando‚Ä¶', true);
      setTimeout(()=>location.reload(), 400);
    } catch (e) {
      console.error(e);
      alert('Error recuperando de nube: ' + (e.message || e));
    }
  };

  /*** 4) Enlazar a los botones existentes ***/
  const wireButtons = () => {
    const btnSaveCloud = findButtonByText('guardar (nube)') || findButtonByText('guardar nube') || findButtonByText('cloud');
    const btnLoadCloud = findButtonByText('recuperar') || findButtonByText('cargar');

    if (btnSaveCloud) btnSaveCloud.addEventListener('click', saveCloud, {passive:true});
    if (btnLoadCloud) btnLoadCloud.addEventListener('click', loadCloud, {passive:true});

    // atajo: Ctrl/Cmd + Alt + S ‚Üí guardar en nube
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.altKey && e.key.toLowerCase() === 's') {
        e.preventDefault();
        saveCloud();
      }
    });
  };

  /*** 5) PIN: bot√≥n + Enter (sin tocar tu UI) ***/
  const ensurePinEnter = () => {
    const pin = $('#pin'), enter = $('#enter'), clear = $('#clear'), msg = $('#pinMsg');
    if (pin && enter) {
      const go = async () => {
        try {
          if (String(PIN_CODE) !== String(pin.value || '')) {
            if (msg) { msg.style.display = 'block'; msg.textContent = 'PIN incorrecto'; }
            setTimeout(()=> { if (msg) msg.style.display = 'none'; }, 1600);
            return;
          }
          if (typeof window.showApp === 'function') window.showApp(); // si la tienes
          document.body.classList.remove('locked');
        } catch {}
      };
      enter.addEventListener('click', go, {passive:true});
      pin.addEventListener('keydown', (e)=> { if (e.key === 'Enter') go(); }, {passive:true});
      if (clear) clear.addEventListener('click', ()=> pin.value='', {passive:true});
      setTimeout(()=> { try { pin.focus(); } catch {} }, 60);
    }
  };

  /*** 6) Init ***/
  window.addEventListener('DOMContentLoaded', () => {
    ensurePinEnter();
    wireButtons();
  });
})();
</script>

<!-- (opcional) Si la cach√©/Service Worker te da guerra, descomenta, recarga 1 vez y vuelve a comentar -->
<script>
  /*
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
    caches && caches.keys && caches.keys().then(k => k.forEach(c => caches.delete(c)));
  }
  */
</script>
</body>
</html>
