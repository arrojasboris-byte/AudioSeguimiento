<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AUDIOLOGIA-SEGUIMIENTO</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath fill='%23e11' d='M16 3a13 13 0 1 0 0 26 13 13 0 0 0 0-26Zm-1 6h2v8h-2V9Zm1 12a2 2 0 1 1 0 4 2 2 0 0 1 0-4Z'/%3E%3C/svg%3E">
<style>
  :root{--brand:#e11;--ink:#1f2937;--muted:#6b7280;--bg:#f3f4f6;--card:#fff;--ring:#e5e7eb;--ok:#059669;--warn:#d97706;--bad:#b91c1c}
  *{box-sizing:border-box} html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  body{background:linear-gradient(180deg,#f7f7f8 0%,#eceef1 100%)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px}
  .row{display:grid;grid-template-columns:1fr auto auto auto auto auto;gap:10px;align-items:center}
  .brand{display:flex;align-items:center;gap:14px;background:var(--card);border:1px solid var(--ring);border-left:6px solid var(--brand);border-radius:12px;padding:12px 14px;box-shadow:0 8px 22px rgba(0,0,0,.04)}
  .brand h1{margin:0;font-size:28px;color:var(--ink)}
  .brand small{color:var(--muted)}
  .logoBox{width:140px;height:48px;border-radius:10px;background:#f2f2f2;border:1px dashed #ccc;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer}
  .iconbtn{width:46px;height:46px;border-radius:12px;border:1px solid var(--ring);background:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,.04)}
  .iconbtn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
  .iconbtn:disabled{opacity:.5;cursor:not-allowed}
  .search{margin:12px 0}
  .search input{width:100%;padding:14px 16px;border-radius:12px;border:1px solid var(--ring);font-size:15px}
  .grid{display:grid;grid-template-columns:340px 1fr;gap:16px}
  .pane{background:var(--card);border:1px solid var(--ring);border-radius:12px;overflow:hidden}
  .pane .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--ring)}
  .pane .title{font-weight:800;color:var(--ink)}
  .muted{color:var(--muted);font-size:13px}
  .sec{padding:14px 14px 18px}
  .secBlock{border:1px solid var(--ring);border-radius:12px;margin-bottom:12px;background:#fafafa}
  .secBlock .secHead{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 12px}
  .secBlock .badge{background:#111827;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px}
  .secBlock .actions{display:flex;gap:6px;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--ring);background:#fff;cursor:pointer}
  .btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.icon{padding:7px 9px}
  .collapse{border-top:1px solid var(--ring);padding:10px 12px;display:none}
  .item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border:1px solid var(--ring);background:#fff;border-radius:10px;padding:10px;margin-bottom:10px}
  .tag{font-size:12px;color:#6b7280}
  .hint{font-size:12px;color:#6b7280;margin-top:6px}
  .danger{color:var(--bad)} .ok{color:var(--ok)} .warn{color:var(--warn)}
  .table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--ring);border-radius:10px;overflow:hidden}
  .table th,.table td{border-bottom:1px solid var(--ring);padding:8px 10px;text-align:left;font-size:14px}
  .table th{background:#111827;color:#fff}
  .rightCard{padding:14px}
  details.block{margin-bottom:14px;border:1px solid var(--ring);border-radius:12px;background:#fafafa}
  details.block>summary{list-style:none;padding:12px 14px;cursor:pointer;font-weight:800;display:flex;justify-content:space-between;align-items:center}
  details.block[open]>summary{border-bottom:1px solid var(--ring);background:#fff}
  .toolbar{display:flex;gap:8px;align-items:center}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.2);z-index:9999}
  .hidden{display:none !important}
</style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="row brand">
      <div class="logoBox" id="logoBox"><span id="logoText">Logo</span><img id="logoImg" class="hidden" alt="logo" /></div>
      <div><small class="muted">Plataforma</small><h1>AUDIOLOGIA-SEGUIMIENTO</h1></div>
      <div class="iconbtn" title="Subir logo" id="btnLogo">üñºÔ∏è</div>
      <div class="iconbtn" title="Desbloquear edici√≥n (PIN AR4321)" id="btnLock">üîí</div>
      <div class="iconbtn brand" title="Guardar (nube + local)" id="btnCloudSave">‚òÅÔ∏è</div>
      <div class="iconbtn" title="Cargar backup JSON" id="btnLoad">‚¨ÜÔ∏è</div>
      <div class="iconbtn" title="Descargar backup JSON" id="btnDownload">‚¨áÔ∏è</div>
      <div class="iconbtn" title="Ajustes (no necesarios)" id="btnSettings">‚öôÔ∏è</div>
      <input type="file" accept="image/*" id="logoFile" class="hidden" />
      <input type="file" accept="application/json" id="jsonFile" class="hidden" />
    </div>

    <!-- Buscador -->
    <div class="search"><input id="search" placeholder="Buscar en secciones, centros y datos..." /></div>

    <!-- Grid principal -->
    <div class="grid">
      <!-- IZQUIERDA -->
      <div class="pane">
        <div class="head">
          <div class="title">Secciones</div>
          <button class="btn brand" id="btnAddSection">+ A√±adir secci√≥n</button>
        </div>
        <div class="sec" id="sections"></div>
        <div class="hint">Consejo: pulsa el nombre de un elemento para cargar sus procedimientos.</div>
      </div>

      <!-- DERECHA -->
      <div class="pane" id="rightPane">
        <div class="head">
          <div class="title" id="procTitle">Procedimientos</div>
          <div class="toolbar"><span class="muted" id="itemsCount"></span></div>
        </div>
        <div class="rightCard" id="proceduresArea">
          <div class="muted">Selecciona un elemento de la izquierda para ver/editar sus procedimientos.</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================== Estado y helpers ================== */
const $ = s => document.querySelector(s);
const elSections = $('#sections'), elProcedures = $('#proceduresArea'), elProcTitle = $('#procTitle'), elItemsCount = $('#itemsCount');

const DEFAULT_STATE = {
  logo:"", companyName:"AUDIOLOG√çA",
  sections:[
    { id:"centros_exclusivos", name:"Centros exclusivos", items:[
      { id:"c1", name:"Reina Mercedes", delegado:"Ana Mart√≠nez", audiologo:"Dr. Garc√≠a", tipo:"Franquicia" },
      { id:"c2", name:"Barcelona Centro", delegado:"Carlos Ruiz", audiologo:"Dra. L√≥pez", tipo:"Sucursal" }
    ]},
    { id:"centros_flop", name:"Centros flop", items:[] },
    { id:"formaciones_mentoring", name:"Formaciones ‚Äì Mentoring", items:[] },
    { id:"visitas_centros", name:"Visitas a centros", items:[] }
  ],
  procedures:{ c1: seedProcedures(), c2: seedProcedures() },
  updatedAt: Date.now()
};
function seedProcedures(){
  return {
    accionesResultado:[{id:1,fecha:"",accion:"",derivacion:0,cita:0,observaciones:""}],
    formaciones: Array.from({length:10}).map((_,i)=>({id:i+1,fecha:"",asistencia:"",titulo:"",aplicacion:""})),
    procesosPersonalizados:[{id:1,nombrePaquete:"",descripcion:"",puntuacion:"",observaciones:"",fechaVisita:"",archivos:[],enlaces:[]}]
  };
}
let STATE = loadLocal() || DEFAULT_STATE;
let SELECTED = { sectionId:"centros_exclusivos", itemId:"c1" };
let UNLOCKED = false;

/* ================== Render ================== */
function render(){
  // Logo
  if (STATE.logo){ $('#logoImg').src=STATE.logo; $('#logoImg').classList.remove('hidden'); $('#logoText').classList.add('hidden'); }
  else { $('#logoImg').classList.add('hidden'); $('#logoText').classList.remove('hidden'); }

  // Secciones
  elSections.innerHTML='';
  STATE.sections.forEach(sec=>{
    const block = document.createElement('div'); block.className='secBlock';
    const head = document.createElement('div'); head.className='secHead';
    head.innerHTML=`
      <div class="title">${sec.name} <span class="badge">${sec.items.length}</span></div>
      <div class="actions">
        <button class="btn" data-act="toggle">${sec._open?'Ocultar':'Mostrar'}</button>
        <button class="btn" data-act="add">+ Sub</button>
        <button class="btn" data-act="editSec">‚úé</button>
        <button class="btn danger" data-act="delSec">üóë</button>
      </div>`;
    block.appendChild(head);

    const body = document.createElement('div'); body.className='collapse'; if (sec._open) body.style.display='block';
    sec.items.forEach(it=>{
      const item = document.createElement('div'); item.className='item';
      item.innerHTML=`
        <div>
          <div style="font-weight:700;cursor:pointer" data-select="${sec.id}|${it.id}">${it.name}</div>
          ${sec.id.startsWith('centros_')?`<div class="tag">üë§ ${it.delegado} ¬∑ üéß ${it.audiologo} ¬∑ üìç ${it.tipo||'-'}</div>`:''}
        </div>
        <div>
          <button class="btn icon" data-edit="${sec.id}|${it.id}">‚úé</button>
          <button class="btn icon danger" data-del="${sec.id}|${it.id}">üóë</button>
        </div>`;
      body.appendChild(item);
    });
    block.appendChild(body); elSections.appendChild(block);

    head.querySelector('[data-act="toggle"]').onclick=()=>{sec._open=!sec._open; render();};
    head.querySelector('[data-act="add"]').onclick=()=>addItem(sec.id);
    head.querySelector('[data-act="editSec"]').onclick=()=>editSection(sec.id);
    head.querySelector('[data-act="delSec"]').onclick=()=>deleteSection(sec.id);
  });

  elSections.querySelectorAll('[data-select]').forEach(n=> n.onclick=()=>{const [sid,iid]=n.dataset.select.split('|'); SELECTED={sectionId:sid,itemId:iid}; renderProcedures();});
  elSections.querySelectorAll('[data-edit]').forEach(n=> n.onclick=()=>{const [sid,iid]=n.dataset.edit.split('|'); editItem(sid,iid);});
  elSections.querySelectorAll('[data-del]').forEach(n=> n.onclick=()=>{const [sid,iid]=n.dataset.del.split('|'); deleteItem(sid,iid);});

  renderProcedures();
  saveLocal();
}
function renderProcedures(){
  const sec = STATE.sections.find(s=>s.id===SELECTED.sectionId);
  if(!sec){ elProcedures.innerHTML='<div class="muted">Selecciona un elemento‚Ä¶</div>'; elProcTitle.textContent='Procedimientos'; return; }
  const it = sec.items.find(i=>i.id===SELECTED.itemId);
  if(!it){ elProcedures.innerHTML='<div class="muted">Selecciona un elemento‚Ä¶</div>'; elProcTitle.textContent='Procedimientos'; return; }
  elProcTitle.textContent = `Procedimientos ‚Äî ${it.name}`;

  if (!SELECTED.sectionId.startsWith('centros_exclusivos')){
    elProcedures.innerHTML = `<div class="muted">Procedimientos a√∫n no definidos para ‚Äú${sec.name}‚Äù.</div>`; elItemsCount.textContent='';
    return;
  }
  const P = STATE.procedures[it.id] || (STATE.procedures[it.id]=seedProcedures());

  // Acciones
  const acciones = `
  <details class="block" open>
    <summary>
      <span>Acciones ‚Äì Resultado</span>
      <span class="toolbar">
        <button class="btn" onclick="addAccion('${it.id}')">+ A√±adir</button>
        <button class="btn brand" onclick="saveCloud()">Guardar</button>
      </span>
    </summary>
    <div style="padding:10px;">
      <table class="table">
        <thead><tr><th>#</th><th>Fecha</th><th>Acci√≥n</th><th>Derivaci√≥n</th><th>Cita</th><th>Observaciones</th><th></th></tr></thead>
        <tbody>
          ${P.accionesResultado.map((r,idx)=>`
            <tr>
              <td>${idx+1}</td>
              <td><input type="date" value="${r.fecha||''}" onchange="updateAccion('${it.id}',${r.id},'fecha',this.value)"></td>
              <td><input type="text" value="${r.accion||''}" onchange="updateAccion('${it.id}',${r.id},'accion',this.value)"></td>
              <td><input type="number" min="0" value="${r.derivacion||0}" onchange="updateAccion('${it.id}',${r.id},'derivacion',+this.value||0)"></td>
              <td><input type="number" min="0" value="${r.cita||0}" onchange="updateAccion('${it.id}',${r.id},'cita',+this.value||0)"></td>
              <td><input type="text" value="${r.observaciones||''}" onchange="updateAccion('${it.id}',${r.id},'observaciones',this.value)"></td>
              <td><button class="btn danger" onclick="delAccion('${it.id}',${r.id})">üóë</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  </details>`;

  // Formaci√≥n
  const formaciones = `
  <details class="block">
    <summary>
      <span>Formaci√≥n continua</span>
      <span class="toolbar"><button class="btn brand" onclick="saveCloud()">Guardar</button></span>
    </summary>
    <div style="padding:10px;">
      <table class="table">
        <thead><tr><th>#</th><th>Fecha</th><th>Asistencia (SI/NO)</th><th>T√≠tulo</th><th>Aplicaci√≥n</th></tr></thead>
        <tbody>
          ${P.formaciones.map((f,idx)=>`
            <tr>
              <td>${idx+1}</td>
              <td><input type="date" value="${f.fecha||''}" onchange="updateFormacion('${it.id}',${f.id},'fecha',this.value)"></td>
              <td>
                <select onchange="updateFormacion('${it.id}',${f.id},'asistencia',this.value)">
                  <option value="" ${!f.asistencia?'selected':''}>-</option>
                  <option ${/si|s√≠/i.test(f.asistencia)?'selected':''}>SI</option>
                  <option ${/no/i.test(f.asistencia)?'selected':''}>NO</option>
                  <option ${/pendiente/i.test(f.asistencia)?'selected':''}>Pendiente</option>
                </select>
              </td>
              <td><input type="text" value="${f.titulo||''}" onchange="updateFormacion('${it.id}',${f.id},'titulo',this.value)"></td>
              <td><input type="text" value="${f.aplicacion||''}" onchange="updateFormacion('${it.id}',${f.id},'aplicacion',this.value)"></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  </details>`;

  // Procesos
  const procesos = `
  <details class="block">
    <summary>
      <span>Procesos y paquetes personalizados</span>
      <span class="toolbar"><button class="btn" onclick="addProceso('${it.id}')">+ A√±adir</button><button class="btn brand" onclick="saveCloud()">Guardar</button></span>
    </summary>
    <div style="padding:10px;">
      <table class="table">
        <thead><tr><th>#</th><th>Nombre paquete</th><th>Descripci√≥n</th><th>Puntuaci√≥n</th><th>Observaciones</th><th>Fecha visita</th><th></th></tr></thead>
        <tbody>
          ${P.procesosPersonalizados.map((p,idx)=>`
            <tr>
              <td>${idx+1}</td>
              <td><input type="text" value="${p.nombrePaquete||''}" onchange="updateProceso('${it.id}',${p.id},'nombrePaquete',this.value)"></td>
              <td><input type="text" value="${p.descripcion||''}" onchange="updateProceso('${it.id}',${p.id},'descripcion',this.value)"></td>
              <td><input type="text" value="${p.puntuacion||''}" onchange="updateProceso('${it.id}',${p.id},'puntuacion',this.value)"></td>
              <td><input type="text" value="${p.observaciones||''}" onchange="updateProceso('${it.id}',${p.id},'observaciones',this.value)"></td>
              <td><input type="date" value="${p.fechaVisita||''}" onchange="updateProceso('${it.id}',${p.id},'fechaVisita',this.value)"></td>
              <td><button class="btn danger" onclick="delProceso('${it.id}',${p.id})">üóë</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  </details>`;
  elProcedures.innerHTML = acciones + formaciones + procesos;
  elItemsCount.textContent = `${(P.accionesResultado?.length||0)} √≠tems`;
}

/* ================== CRUD Secciones ================== */
const LS_KEY='audiologia_state_v2';
function uid(){return Math.random().toString(36).slice(2,9)}

$('#btnAddSection').onclick=()=>{
  const name=prompt('Nombre de la nueva secci√≥n:'); if(!name) return;
  const id=name.toLowerCase().replace(/\s+/g,'_')+'_'+uid();
  STATE.sections.push({id,name,items:[],_open:true}); touch(); render(); toast('Secci√≥n creada');
};
function editSection(id){const s=STATE.sections.find(x=>x.id===id); if(!s)return; const n=prompt('Nuevo nombre:',s.name); if(!n)return; s.name=n; touch(); render(); toast('Secci√≥n actualizada');}
function deleteSection(id){ if(!confirm('¬øEliminar secci√≥n?'))return; STATE.sections=STATE.sections.filter(x=>x.id!==id); if(SELECTED.sectionId===id) SELECTED={sectionId:'',itemId:''}; touch(); render(); toast('Secci√≥n eliminada');}

function addItem(sectionId){
  const s=STATE.sections.find(x=>x.id===sectionId); if(!s) return;
  const name=prompt('Nombre:'); if(!name) return;
  const it={id:uid(),name};
  if(sectionId.startsWith('centros_')){ it.delegado=prompt('Delegado:')||''; it.audiologo=prompt('Audi√≥logo:')||''; it.tipo=prompt('Tipo (Franquicia/Sucursal/-):')||''; }
  s.items.push(it); if(sectionId==='centros_exclusivos') STATE.procedures[it.id]=seedProcedures();
  touch(); render(); toast('Elemento a√±adido');
}
function editItem(sectionId,itemId){
  const s=STATE.sections.find(x=>x.id===sectionId); if(!s) return;
  const it=s.items.find(x=>x.id===itemId); if(!it) return;
  const name=prompt('Nombre:',it.name); if(!name) return; it.name=name;
  if(sectionId.startsWith('centros_')){ it.delegado=prompt('Delegado:',it.delegado||'')||''; it.audiologo=prompt('Audi√≥logo:',it.audiologo||'')||''; it.tipo=prompt('Tipo:',it.tipo||'')||''; }
  touch(); render(); toast('Elemento actualizado');
}
function deleteItem(sectionId,itemId){
  if(!confirm('¬øEliminar elemento?'))return;
  const s=STATE.sections.find(x=>x.id===sectionId); if(!s) return;
  s.items=s.items.filter(x=>x.id!==itemId); if(STATE.procedures[itemId]) delete STATE.procedures[itemId];
  if(SELECTED.itemId===itemId) SELECTED.itemId=''; touch(); render(); toast('Elemento eliminado');
}

/* ================== Procedimientos ================== */
function addAccion(itemId){ const P=STATE.procedures[itemId]; const id=(Math.max(0,...P.accionesResultado.map(a=>a.id))+1)||1; P.accionesResultado.push({id,fecha:"",accion:"",derivacion:0,cita:0,observaciones:""}); touch(); renderProcedures(); }
function updateAccion(itemId,id,field,val){ STATE.procedures[itemId].accionesResultado=STATE.procedures[itemId].accionesResultado.map(a=>a.id===id?({...a,[field]:val}):a); touchSoft(); }
function delAccion(itemId,id){ const P=STATE.procedures[itemId]; if(P.accionesResultado.length<=1) return toast('Debe quedar al menos una fila','warn'); P.accionesResultado=P.accionesResultado.filter(a=>a.id!==id); touch(); renderProcedures(); }
function updateFormacion(itemId,id,field,val){ STATE.procedures[itemId].formaciones=STATE.procedures[itemId].formaciones.map(f=>f.id===id?({...f,[field]:val}):f); touchSoft(); }
function addProceso(itemId){ const P=STATE.procedures[itemId]; const id=(Math.max(0,...P.procesosPersonalizados.map(a=>a.id))+1)||1; P.procesosPersonalizados.push({id,nombrePaquete:"",descripcion:"",puntuacion:"",observaciones:"",fechaVisita:"",archivos:[],enlaces:[]}); touch(); renderProcedures();}
function updateProceso(itemId,id,field,val){ STATE.procedures[itemId].procesosPersonalizados=STATE.procedures[itemId].procesosPersonalizados.map(p=>p.id===id?({...p,[field]:val}):p); touchSoft(); }
function delProceso(itemId,id){ const P=STATE.procedures[itemId]; if(P.procesosPersonalizados.length<=1) return toast('Debe quedar al menos una fila','warn'); P.procesosPersonalizados=P.procesosPersonalizados.filter(a=>a.id!==id); touch(); renderProcedures(); }

/* ================== Guardado local + NUBE (JSONBlob) ================== */
/* 100% autom√°tico, sin tokens. Crea un contenedor la 1¬™ vez y reutiliza el mismo. */
const CLOUD = (()=> {
  const LS_ID='cloud_blob_id_v2';
  const LS_URL='cloud_blob_url_v2';
  function blobId(){return localStorage.getItem(LS_ID)||''}
  function blobUrl(){return localStorage.getItem(LS_URL)||''}

  async function create(payload){
    const r = await fetch('https://jsonblob.com/api/jsonBlob',{method:'POST',headers:{'Content-Type':'application/json'},body:payload});
    if(!r.ok) throw new Error('No se pudo crear nube');
    const url = r.headers.get('Location'); // ej: https://jsonblob.com/123-abc...
    localStorage.setItem(LS_URL,url); localStorage.setItem(LS_ID,url.split('/').pop());
    return url;
  }
  async function put(url,payload){
    const r = await fetch(url,{method:'PUT',headers:{'Content-Type':'application/json'},body:payload});
    if(!r.ok) throw new Error('No se pudo guardar en nube'); return true;
  }
  async function get(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('No se pudo leer nube'); return await r.json(); }

  return {
    async save(state){
      const payload = JSON.stringify({updatedAt:state.updatedAt,state},null,2);
      let url = blobUrl();
      if(!url){ url = await create(payload); }
      await put(url,payload);
      return true;
    },
    async load(){
      const url = blobUrl(); if(!url) return null;
      try{ return await get(url);}catch(_){return null;}
    },
    has(){return !!blobUrl()}
  };
})();

function touch(){ STATE.updatedAt=Date.now(); saveLocal(); }
function touchSoft(){ STATE.updatedAt=Date.now(); saveLocal(); }

function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(STATE)); }
function loadLocal(){ try{ const j=localStorage.getItem(LS_KEY); return j?JSON.parse(j):null; }catch(e){ return null; }}

/* Guardar en nube (y local) con un click */
async function saveCloud(){
  try{
    saveLocal();
    await CLOUD.save(STATE);
    toast('Guardado en nube y local','ok');
  }catch(e){
    console.error(e); toast('Error al guardar en nube','bad');
  }
}
$('#btnCloudSave').onclick = saveCloud;

/* Auto-cargar nube al iniciar (si existe) y fusionar con local para NO empezar de 0 */
async function bootLoadCloud(){
  try{
    const cloud = await CLOUD.load();
    if(!cloud) return;
    // Si la nube es m√°s reciente, la usamos; si no, mantenemos local.
    if (cloud.updatedAt && cloud.updatedAt > (STATE.updatedAt||0)){
      STATE = cloud.state; toast('Cargado desde nube','ok');
    } else {
      // si local es m√°s reciente, subimos local silenciosamente
      await CLOUD.save(STATE);
    }
  }catch(e){
    console.warn('No se pudo sincronizar nube:', e.message);
  }
}

/* ================== Logo / B√∫squeda / PIN ================== */
$('#btnLogo').onclick = ()=> $('#logoFile').click();
$('#logoFile').onchange = e => { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ STATE.logo=r.result; touch(); render(); saveCloud(); }; r.readAsDataURL(f); };

$('#search').oninput = e => { const q=e.target.value.trim().toLowerCase(); document.querySelectorAll('.item').forEach(div=>{ const txt=div.textContent.toLowerCase(); div.style.display = txt.includes(q)?'':'none'; }); };

$('#btnLock').onclick = ()=>{ const pin=prompt('PIN de edici√≥n:'); if(pin==='AR4321'){ UNLOCKED=true; toast('Edici√≥n habilitada','ok'); } else toast('PIN incorrecto','bad'); };
$('#btnSettings').onclick = ()=> toast('No necesitas configurar nada. El guardado en nube es autom√°tico.','ok');

/* ================== Backup JSON ================== */
$('#btnDownload').onclick=()=>{
  const blob=new Blob([JSON.stringify(STATE,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='audioseguimiento-backup.json'; a.click(); URL.revokeObjectURL(a.href);
};
$('#btnLoad').onclick = ()=> $('#jsonFile').click();
$('#jsonFile').onchange = e => { const f=e.target.files[0]; if(!f) return; f.text().then(t=>{ try{ const j=JSON.parse(t); STATE=j; touch(); render(); saveCloud(); toast('Backup cargado','ok'); }catch(_){ toast('JSON inv√°lido','bad'); } }); };

/* ================== Util ================== */
let T=null; function toast(msg,type='ok'){ if(T)T.remove(); T=document.createElement('div'); T.className='toast'; T.style.background=type==='ok'?'#111827':type==='warn'?'#d97706':'#b91c1c'; T.textContent=msg; document.body.appendChild(T); setTimeout(()=>{T.remove();T=null;},2200); }

/* ================== Init ================== */
(async function init(){
  await bootLoadCloud(); // trae nube si existe y fusiona
  render();
})();
</script>
</body>
</html>
