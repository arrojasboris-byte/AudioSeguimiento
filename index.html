<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SEGUIMIENTO AUDIO ¬∑ Cloud</title>
<meta name="theme-color" content="#c82727"/>
<style>
  :root{
    --rojo:#c82727; --rojo2:#a71f1f; --bg:#f6f7fb; --card:#fff; --line:#e6e7ee;
    --tx:#111; --muted:#6b7280; --ok:#16a34a; --bad:#ef4444; --sh:0 4px 14px rgba(0,0,0,.06);
    --fs:13px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--tx);font:var(--fs)/1.25 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

  /* Top */
  .topbar{position:sticky;top:0;z-index:1000;width:100%;color:#fff;background:linear-gradient(180deg,var(--rojo),var(--rojo2));box-shadow:var(--sh)}
  .topbar .inner{max-width:1280px;margin:auto;padding:10px 12px;display:flex;align-items:center;gap:10px}
  .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.4px}
  .sp{flex:1}
  .pill{border:1px solid #ffffff44;background:#ffffff14;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .pill.primary{background:#fff;color:#111;font-weight:800}
  .pill:disabled{opacity:.6;cursor:not-allowed}
  .badge{font-size:12px;opacity:.9}
  .topbar:not(:first-of-type){display:none!important} /* anti-duplicados SW */

  /* Layout */
  .main{max-width:1280px;margin:12px auto;padding:0 12px;display:grid;grid-template-columns:260px 1fr;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--sh)}
  .side .sec{padding:12px;border-bottom:1px solid var(--line)}
  .side .sec:last-child{border-bottom:0}
  .sec h4{margin:0 0 8px;display:flex;align-items:center;gap:6px;font-size:13px}
  .btn{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .detail{padding:12px}
  .toolbar{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .grid{overflow:auto;border:1px solid var(--line);border-radius:8px}
  table{border-collapse:collapse;width:100%;min-width:880px}
  th,td{border-bottom:1px solid var(--line);padding:6px 8px;text-align:left;white-space:nowrap}
  thead th{background:#fafafb} tfoot td{background:#fafafb;font-weight:700}
  input[type="number"]{width:110px}
  .ok{background:#10b98112} .bad{background:#ef444410}

  /* Estilo PARA los botones de la izquierda (solo visual): */
  .side .btn.open{background:#111;color:#fff;border-color:#111}
  .side .btn.open:hover{filter:brightness(1.08)}
  .side .btn.add{background:#c82727;color:#fff;border-color:#c82727;font-weight:700}
  .side .btn.add:hover{filter:brightness(1.1)}

  /* PIN */
  #pinOverlay{position:fixed;inset:0;background:rgba(0,0,0,.78);
    display:none;align-items:center;justify-content:center;z-index:9999}
  #pinOverlay .panel{background:#1b1b1b;color:#fff;padding:18px 20px;border-radius:12px;width:min(92vw,360px);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  #pinOverlay input{width:130px;text-align:center;letter-spacing:.3em}
  #pinOverlay .msg{display:none;color:#ffb3b3;margin-top:8px;font-size:12px}

  /* Visitas: barra lateral de progreso */
  .va-right{position:sticky; top:82px; margin-left:8px; align-self:flex-start; width:240px}
  .va-card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--sh);padding:8px}
  .bar{height:6px;background:#e9ecef;border-radius:999px;overflow:hidden}
  .bar>div{height:100%;background:#1f6feb;width:0%}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="inner">
    <div class="logo">üéß SEGUIMIENTO AUDIO</div>
    <div class="sp"></div>
    <button class="pill" id="btnReload">Actualizar</button>
    <button class="pill" id="btnSaveLocal">Guardar (local)</button>
    <button class="pill primary" id="btnSaveCloud">Guardar (nube)</button>
    <button class="pill" id="btnLoadCloud">Recuperar (nube)</button>
    <button class="pill" id="btnDownload">Descargar HTML</button>
    <span class="badge" id="cloudBadge">Nube: ‚Äî</span>
  </div>
</div>

<!-- Layout -->
<div class="main">
  <!-- Sidebar -->
  <div class="card side" id="sidebar">
    <div class="sec">
      <h4>üìà Cifra de ventas</h4>
      <button class="btn open" data-open="cifra">‚ñ∂ Abrir compa√±√≠a</button>
    </div>

    <div class="sec">
      <h4>‚≠ê Centros exclusivos</h4>
      <div class="row">
        <button class="btn open" data-open="centros_ex">‚ñ∂ Abrir</button>
        <button class="btn add" id="addCentroEx">+ Centro</button>
      </div>
    </div>

    <div class="sec">
      <h4>üü© Centros flop</h4>
      <div class="row">
        <button class="btn open" data-open="centros_flop">‚ñ∂ Abrir</button>
        <button class="btn add" id="addCentroFlop">+ Centro</button>
      </div>
    </div>

    <div class="sec">
      <h4>üß≠ Visitas audio</h4>
      <button class="btn open" data-open="visitas">‚ñ∂ Abrir</button>
    </div>

    <div class="sec">
      <h4>üéì Formaciones y mentoring</h4>
      <button class="btn open" data-open="formaciones">‚ñ∂ Abrir</button>
    </div>

    <div class="sec">
      <h4>ü©∫ Teleaudiolog√≠a</h4>
      <button class="btn open" data-open="tele">‚ñ∂ Abrir</button>
    </div>

    <div class="sec">
      <h4>üß∞ Equipos</h4>
      <button class="btn open" data-open="equipos">‚ñ∂ Abrir</button>
    </div>
  </div>

  <!-- Detalle -->
  <div class="card detail">
    <div class="toolbar">
      <h3 id="detTitle" style="margin:0">CIFRA ‚Äî COMPA√ë√çA</h3>
      <span class="muted" id="detHint">Edite y guarde; todo es editable. Use ‚ÄúGuardar (nube)‚Äù.</span>
    </div>

    <!-- ===== CIFRA ===== -->
    <section id="panel-cifra">
      <div class="grid">
        <table id="tblCifra">
          <thead>
            <tr><th>Mes</th><th>Previsto</th><th>CV mes</th><th>Diferencia</th></tr>
          </thead>
          <tbody id="tbCifraBody"></tbody>
          <tfoot>
            <tr><td>Total</td><td id="cifraTotPrev">0</td><td id="cifraTotMes">0</td><td id="cifraTotDif">0</td></tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- ===== CENTROS EXCLUSIVOS ===== -->
    <section id="panel-centros_ex" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <input placeholder="Buscar‚Ä¶" id="cExSearch" />
      </div>
      <div class="grid">
        <table>
          <thead>
            <tr><th>#</th><th>Nombre</th><th>Delegado</th><th>Audi√≥logo</th><th>Tipo</th></tr>
          </thead>
          <tbody id="cExBody"></tbody>
        </table>
      </div>

      <h4 style="margin:12px 0 6px">Acciones</h4>
      <div class="grid">
        <table>
          <thead><tr><th>#</th><th>Fecha</th><th>Tipo de acci√≥n</th><th>Derivaciones</th><th>Citas</th><th>Ventas</th><th>Observaciones</th></tr></thead>
          <tbody id="cExAcciones"></tbody>
        </table>
      </div>

      <h4 style="margin:12px 0 6px">Formaciones obligatorias</h4>
      <div class="grid">
        <table>
          <thead><tr><th>#</th><th>Fecha</th><th>Tema</th><th>Asistencia</th><th>Aplicado</th><th>Observaciones</th></tr></thead>
        <tbody id="cExForm"></tbody>
        </table>
      </div>

      <h4 style="margin:12px 0 6px">Procesos</h4>
      <div class="grid">
        <table>
          <thead><tr><th>#</th><th>Fecha visita</th><th>Puntuaci√≥n %</th><th>% Pruebas</th><th>% Venta</th><th>Derivaciones √≥ptica</th><th>Observaciones</th><th>Adjunto</th></tr></thead>
          <tbody id="cExProc"></tbody>
        </table>
      </div>
    </section>

    <!-- ===== CENTROS FLOP ===== (id√©ntico formato) -->
    <section id="panel-centros_flop" style="display:none">
      <div class="row" style="margin-bottom:8px"><input placeholder="Buscar‚Ä¶" id="cFlSearch" /></div>
      <div class="grid">
        <table>
          <thead><tr><th>#</th><th>Nombre</th><th>Delegado</th><th>Audi√≥logo</th><th>Tipo</th></tr></thead>
          <tbody id="cFlBody"></tbody>
        </table>
      </div>

      <h4 style="margin:12px 0 6px">Acciones</h4>
      <div class="grid"><table><thead><tr><th>#</th><th>Fecha</th><th>Tipo de acci√≥n</th><th>Derivaciones</th><th>Citas</th><th>Ventas</th><th>Observaciones</th></tr></thead><tbody id="cFlAcciones"></tbody></table></div>

      <h4 style="margin:12px 0 6px">Formaciones obligatorias</h4>
      <div class="grid"><table><thead><tr><th>#</th><th>Fecha</th><th>Tema</th><th>Asistencia</th><th>Aplicado</th><th>Observaciones</th></tr></thead><tbody id="cFlForm"></tbody></table></div>

      <h4 style="margin:12px 0 6px">Procesos</h4>
      <div class="grid"><table><thead><tr><th>#</th><th>Fecha visita</th><th>Puntuaci√≥n %</th><th>% Pruebas</th><th>% Venta</th><th>Derivaciones √≥ptica</th><th>Observaciones</th><th>Adjunto</th></tr></thead><tbody id="cFlProc"></tbody></table></div>
    </section>

    <!-- ===== VISITAS ===== -->
    <section id="panel-visitas" style="display:none">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;margin-bottom:8px">
        <select id="vaRol">
          <option>Responsable Tec Audio</option>
          <option>Delegado Audio</option>
        </select>
        <input id="vaNombre" placeholder="Nombre visitador"/>
        <input id="vaSearch" placeholder="Buscar centro‚Ä¶"/>
        <button class="btn" id="vaAdd">+ 50 filas</button>
      </div>

      <div style="display:grid;grid-template-columns:1fr 240px;gap:8px">
        <div class="grid">
          <table>
            <thead>
              <tr><th>#</th><th>Fecha</th><th>Centro</th><th>Delegado</th><th>Suc/Fran</th><th>Puntuaci√≥n %</th><th>% Pruebas</th><th>% Venta</th><th>HIT</th><th>RT</th><th>Adj.</th></tr>
            </thead>
            <tbody id="vaBody"></tbody>
          </table>
        </div>
        <div class="va-right">
          <div class="va-card">
            <div style="font-weight:700">Avance de visitas</div>
            <div id="vaCount" class="muted">0 / 0</div>
            <div class="bar" style="margin-top:6px"><div id="vaBar"></div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== FORMACIONES ===== -->
    <section id="panel-formaciones" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <select id="fmModo">
          <option>Mentoring general</option>
          <option>Mentoring por delegados</option>
          <option>Formaciones generales</option>
        </select>
        <input id="fmSearch" placeholder="Buscar‚Ä¶"/>
        <button class="btn" id="fmAdd">+ A√±adir fila</button>
      </div>
      <div class="grid">
        <table>
          <thead><tr><th>#</th><th>Fecha</th><th>Centro</th><th>Delegado</th><th>Audi√≥logo</th><th>Tema</th><th>Asisti√≥</th><th>Aplicado</th><th>Observaciones</th></tr></thead>
          <tbody id="fmBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ===== TELEAUDIOLOG√çA ===== -->
    <section id="panel-tele" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <input id="taSearch" placeholder="Centro o persona‚Ä¶"/>
        <span class="muted">Certificados ‚úÖ: <b id="taCert">0</b> ¬∑ En formaci√≥n üüß: <b id="taForm">0</b></span>
        <button class="btn" id="taAdd">+ 50 filas</button>
      </div>
      <div class="grid">
        <table>
          <thead><tr><th>#</th><th>Centro</th><th>Delegado</th><th>Rol</th><th>Persona</th><th>Form.</th><th>Pr√°c.</th><th>Cert.</th><th>Pruebas</th><th>Ventas</th><th>Obs.</th></tr></thead>
          <tbody id="taBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ===== EQUIPOS ===== -->
    <section id="panel-equipos" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <input id="eqSearch" placeholder="Equipo, serie o centro‚Ä¶"/>
        <button class="btn" id="eqAdd">+ Fila</button>
      </div>
      <div class="grid">
        <table>
          <thead><tr><th>#</th><th>Equipo</th><th>N¬∫ serie</th><th>Persona env√≠o</th><th>Fecha</th><th>Centro</th><th>Centro ‚úì</th><th>Sede ‚úì</th></tr></thead>
          <tbody id="eqBody"></tbody>
        </table>
      </div>
    </section>

  </div>
</div>

<!-- PIN overlay -->
<div id="pinOverlay" aria-modal="true" role="dialog" style="display:none">
  <div class="panel">
    <h3 style="margin:0 0 10px">Acceso</h3>
    <div style="opacity:.85;margin-bottom:10px">Introduce el PIN para editar:</div>
    <div class="row">
      <input id="pin" type="password" inputmode="numeric" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="one-time-code"/>
      <button id="enter" class="btn" style="background:#fff;font-weight:800">Acceder</button>
      <button id="clear" class="btn">Limpiar</button>
    </div>
    <div id="pinMsg" class="msg">PIN incorrecto</div>
  </div>
</div>

<script>
/* ========= CONFIG (cambia la URL) ========= */
const GAS_URL  = 'PEGAR_AQUI_TU_URL_EXEC';  // ‚¨ÖÔ∏è tu /exec real
const PIN_CODE = '4321';

/* ========= Utiles ========= */
const $ = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const nf = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});
function setBadge(t){ const b=$('#cloudBadge'); if(b) b.textContent='Nube: '+t; }

/* ========= PIN ========= */
(function pinGate(){
  const overlay=$('#pinOverlay'), pin=$('#pin'), enter=$('#enter'), clear=$('#clear'), msg=$('#pinMsg');
  function open(){ overlay.style.display='flex'; overlay.style.visibility='visible'; overlay.style.opacity='1'; overlay.style.pointerEvents='auto'; overlay.style.zIndex='9999'; document.body.style.overflow='hidden'; setTimeout(()=>pin&&pin.focus(),60); }
  function close(){ overlay.style.display='none'; document.body.style.overflow=''; }
  async function go(){
    const code=(pin.value||'').trim();
    if(String(code)===String(PIN_CODE||'4321')){ sessionStorage.setItem('__SEGUI_AUDIO_AUTH__','1'); msg.style.display='none'; close(); }
    else { msg.style.display='block'; pin.select(); }
  }
  enter.addEventListener('click',go);
  clear.addEventListener('click',()=>{pin.value='';pin.focus();});
  pin.addEventListener('keydown',e=>{ if(e.key==='Enter') go(); });
  document.addEventListener('DOMContentLoaded',()=>{ if(sessionStorage.getItem('__SEGUI_AUDIO_AUTH__')!=='1') open(); });
})();

/* ========= NAV: abrir paneles ========= */
const PANELS = ['cifra','centros_ex','centros_flop','visitas','formaciones','tele','equipos'];
function openPanel(key){
  PANELS.forEach(k=>$('#panel-'+k).style.display = (k===key)?'block':'none');
  const titles = {
    cifra:'CIFRA ‚Äî COMPA√ë√çA',
    centros_ex:'CENTROS EXCLUSIVOS',
    centros_flop:'CENTROS FLOP',
    visitas:'VISITAS AUDIO',
    formaciones:'FORMACIONES Y MENTORING',
    tele:'TELEAUDIOLOG√çA',
    equipos:'EQUIPOS'
  };
  $('#detTitle').textContent = titles[key] || '';
}
$('#sidebar').addEventListener('click',(e)=>{
  const k=e.target?.dataset?.open; if(!k) return;
  e.preventDefault(); openPanel(k);
});

/* ========= CIFRA ========= */
const MESES=['Ago-25','Sep-25','Oct-25','Nov-25','Dic-25','Ene-26','Feb-26','Mar-26','Abr-26','May-26','Jun-26','Jul-26'];
(function buildCifra(){
  const tb=$('#tbCifraBody'); tb.innerHTML='';
  for(const m of MESES){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m}</td>
      <td><input type="number" min="0" step="1" class="cPrev" placeholder="0"/></td>
      <td><input type="number" min="0" step="1" class="cMes"  placeholder="0"/></td>
      <td class="cDif muted">0</td>`;
    tb.appendChild(tr);
  }
  const upd=()=>calcCifra();
  $$('.cPrev,.cMes').forEach(i=>{i.addEventListener('input',upd);i.addEventListener('change',upd);});
  calcCifra();
})();
function calcCifra(){
  let tP=0,tM=0,tD=0;
  $$('#tbCifraBody tr').forEach(tr=>{
    const p=Number($('.cPrev',tr).value||0), m=Number($('.cMes',tr).value||0), d=m-p;
    tP+=p; tM+=m; tD+=d;
    const cell=$('.cDif',tr); cell.textContent=nf.format(d);
    cell.classList.remove('ok','bad','muted'); if(p===0&&m===0) cell.classList.add('muted'); else if(m>=p) cell.classList.add('ok'); else cell.classList.add('bad');
  });
  $('#cifraTotPrev').textContent=nf.format(tP);
  $('#cifraTotMes').textContent =nf.format(tM);
  $('#cifraTotDif').textContent =nf.format(tD);
}

/* ========= CENTROS (EX & FLOP) ========= */
const ACTION_OPTS = ['Azafata','Buzoneo','Mailing','Ruleta','Stand','Cashback','Otros'];
function buildCentros(section){
  const body = section==='ex' ? $('#cExBody') : $('#cFlBody');
  const acc  = section==='ex' ? $('#cExAcciones') : $('#cFlAcciones');
  const frm  = section==='ex' ? $('#cExForm') : $('#cFlForm'];
  const pro  = section==='ex' ? $('#cExProc') : $('#cFlProc');

  body.innerHTML=''; acc.innerHTML=''; frm.innerHTML=''; pro.innerHTML='';

  for(let i=0;i<5;i++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td>
      <td contenteditable="true"></td>
      <td contenteditable="true"></td>
      <td contenteditable="true"></td>
      <td><select><option>Sucursal</option><option>Franquicia</option></select></td>`;
    body.appendChild(tr);
  }
  for(let i=0;i<12;i++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td>
      <td><input type="date"/></td>
      <td><select>${ACTION_OPTS.map(o=>`<option>${o}</option>`).join('')}</select></td>
      <td><input type="number" min="0" step="1"/></td>
      <td><input type="number" min="0" step="1"/></td>
      <td><input type="number" min="0" step="1"/></td>
      <td><input/></td>`;
    acc.appendChild(tr);
  }
  for(let i=0;i<5;i++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td>
      <td><input type="date"/></td>
      <td><input placeholder="Tema"/></td>
      <td><input type="checkbox"/></td>
      <td><input type="checkbox"/></td>
      <td><input placeholder="Observaciones"/></td>`;
    frm.appendChild(tr);
  }
  for(let i=0;i<4;i++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td>
      <td><input type="date"/></td>
      <td><input type="number" min="0" max="100" step="1" placeholder="%" /></td>
      <td><input type="number" min="0" max="100" step="1" placeholder="%"/></td>
      <td><input type="number" min="0" max="100" step="1" placeholder="%"/></td>
      <td><input type="checkbox"/></td>
      <td><input placeholder="Observaciones"/></td>
      <td><input type="file" accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.png,.jpg"/></td>`;
    pro.appendChild(tr);
  }
}
buildCentros('ex'); buildCentros('flop');
$('#addCentroEx').onclick=()=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>*</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td><select><option>Sucursal</option><option>Franquicia</option></select></td>`; $('#cExBody').appendChild(tr); };
$('#addCentroFlop').onclick=()=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>*</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td><select><option>Sucursal</option><option>Franquicia</option></select></td>`; $('#cFlBody').appendChild(tr); };

/* ========= VISITAS ========= */
let VA_ROWS=50;
function buildVisitas(){
  const tb=$('#vaBody'); tb.innerHTML='';
  for(let i=0;i<VA_ROWS;i++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td>
      <td><input type="date"/></td>
      <td><input placeholder="Centro"/></td>
      <td><input placeholder="Delegado"/></td>
      <td><select><option>Sucursal</option><option>Franquicia</option></select></td>
      <td><input type="number" min="0" max="100" step="1" placeholder="%"/></td>
      <td><input type="number" min="0" max="100" step="1" placeholder="%"/></td>
      <td><input type="number" min="0" max="100" step="1" placeholder="%"/></td>
      <td style="text-align:center"><input type="checkbox"/></td>
      <td style="text-align:center"><input type="checkbox"/></td>
      <td><input type="file" /></td>`;
    tb.appendChild(tr);
  }
  updateVisitasProgress();
}
function updateVisitasProgress(){
  const rows=$$('#vaBody tr');
  const total=rows.length;
  let filled=0;
  rows.forEach(tr=>{ const f=$('td:nth-child(2) input',tr)?.value; if(f) filled++; });
  $('#vaCount').textContent = `${filled} / ${total}`;
  $('#vaBar').style.width = Math.min(100, Math.round(filled*100/Math.max(1,total)))+'%';
}
$('#vaAdd').onclick=()=>{ VA_ROWS+=50; buildVisitas(); };
$('#vaBody').addEventListener('input',updateVisitasProgress);
buildVisitas();

/* ========= FORMACIONES ========= */
function buildFormaciones(){
  const tb=$('#fmBody'); tb.innerHTML='';
  for(let i=0;i<20;i++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td>
      <td><input type="date"/></td>
      <td><input placeholder="Centro"/></td>
      <td><input placeholder="Delegado"/></td>
      <td><input placeholder="Audi√≥logo"/></td>
      <td><input placeholder="Tema"/></td>
      <td style="text-align:center"><input type="checkbox"/></td>
      <td style="text-align:center"><input type="checkbox"/></td>
      <td><input placeholder="Observaciones"/></td>`;
    tb.appendChild(tr);
  }
}
buildFormaciones();
$('#fmAdd').onclick=()=>{ const tb=$('#fmBody'); const i=tb.children.length+1; const tr=document.createElement('tr'); tr.innerHTML=`<td>${i}</td><td><input type="date"/></td><td><input/></td><td><input/></td><td><input/></td><td><input/></td><td style="text-align:center"><input type="checkbox"/></td><td style="text-align:center"><input type="checkbox"/></td><td><input/></td>`; tb.appendChild(tr); };

/* ========= TELEAUDIOLOG√çA ========= */
let TA_ROWS=100;
function buildTele(){
  const tb=$('#taBody'); tb.innerHTML='';
  for(let i=0;i<TA_ROWS;i++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td>
      <td><input placeholder="Centro"/></td>
      <td><input placeholder="Delegado"/></td>
      <td><select><option>Audi√≥logo</option><option>T√©cnico</option></select></td>
      <td><input placeholder="Nombre"/></td>
      <td style="text-align:center"><input class="taForm" type="checkbox"/></td>
      <td style="text-align:center"><input type="checkbox"/></td>
      <td style="text-align:center"><input class="taCert" type="checkbox"/></td>
      <td style="text-align:center"><input type="checkbox"/></td>
      <td style="text-align:center"><input type="checkbox"/></td>
      <td><input placeholder="Obs."/></td>`;
    tb.appendChild(tr);
  }
  updateTeleCounters();
}
function updateTeleCounters(){
  const cert = $$('.taCert:checked').length;
  const form = $$('.taForm:checked').length;
  $('#taCert').textContent=cert;
  $('#taForm').textContent=form;
}
$('#taAdd').onclick=()=>{ TA_ROWS+=50; buildTele(); };
$('#taBody').addEventListener('input',updateTeleCounters);
buildTele();

/* ========= EQUIPOS ========= */
function buildEquipos(){
  const tb=$('#eqBody'); tb.innerHTML='';
  for(let i=0;i<20;i++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td>
      <td><input placeholder="Equipo"/></td>
      <td><input placeholder="Serie"/></td>
      <td><input placeholder="Persona"/></td>
      <td><input type="date"/></td>
      <td><input placeholder="Centro"/></td>
      <td style="text-align:center"><input type="checkbox"/></td>
      <td style="text-align:center"><input type="checkbox"/></td>`;
    tb.appendChild(tr);
  }
}
buildEquipos();
$('#eqAdd').onclick=()=>{ const tb=$('#eqBody'); const i=tb.children.length+1; const tr=document.createElement('tr'); tr.innerHTML=`<td>${i}</td><td><input/></td><td><input/></td><td><input/></td><td><input type="date"/></td><td><input/></td><td style="text-align:center"><input type="checkbox"/></td><td style="text-align:center"><input type="checkbox"/></td>`; tb.appendChild(tr); };

/* ========= SERIALIZACI√ìN DOM ========= */
function cssPath(el){
  if(!(el instanceof Element)) return '';
  const path=[]; while(el && el.nodeType===1 && el!==document.body){
    let sel=el.nodeName.toLowerCase();
    if(el.id){ sel+='#'+CSS.escape(el.id); path.unshift(sel); break; }
    let sib=el, nth=1; while(sib=sib.previousElementSibling) if(sib.nodeName===el.nodeName) nth++;
    sel+=`:nth-of-type(${nth})`; path.unshift(sel); el=el.parentNode;
  } return path.join(' ');
}
function safeQuery(path){ try{return document.querySelector(path);}catch{ return null; } }
function serializeControls(){
  const out=[];
  $$('input,select,textarea,[contenteditable="true"]').forEach(el=>{
    const t=(el.type||'').toLowerCase(); let v;
    if(t==='checkbox'||t==='radio') v=!!el.checked;
    else if(el.isContentEditable) v=el.innerHTML;
    else v=el.value;
    out.push({path:cssPath(el),t,v});
  });
  return out;
}
function restoreControls(list){
  if(!Array.isArray(list)) return;
  list.forEach(it=>{
    const el=safeQuery(it.path); if(!el) return;
    const t=(el.type||'').toLowerCase();
    if(t==='checkbox'||t==='radio') el.checked=!!it.v;
    else if(el.isContentEditable) el.innerHTML=it.v??'';
    else el.value=it.v??'';
    el.dispatchEvent(new Event('input',{bubbles:true}));
    el.dispatchEvent(new Event('change',{bubbles:true}));
  });
}

/* ========= NUBE (Apps Script ‚Äî sin preflight) ========= */
async function saveCloud(){
  try{
    if(!GAS_URL || !/\/exec(\?|$)/.test(GAS_URL)) throw new Error('Configura GAS_URL con tu /exec');
    const payload={ ts:new Date().toISOString(), origin:location.href, values:serializeControls() };
    const res=await fetch(GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=UTF-8'},
      body: JSON.stringify({action:'save', data: JSON.stringify(payload)}),
      cache:'no-store', mode:'cors'
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    setBadge('guardado ‚úì'); alert('Guardado en nube ‚úì');
  }catch(e){ console.error(e); setBadge('error'); alert('Error al guardar en nube: '+e.message); }
}
async function loadCloud(){
  try{
    if(!GAS_URL || !/\/exec(\?|$)/.test(GAS_URL)) throw new Error('Configura GAS_URL con tu /exec');
    const res=await fetch(GAS_URL+'?action=load&nc='+Date.now(),{method:'GET',cache:'no-store',mode:'cors'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const j=await res.json().catch(()=>null);
    const raw=(j&&j.data)?j.data:'';
    if(!raw){ alert('Nube vac√≠a'); setBadge('vac√≠o'); return; }
    const obj=JSON.parse(raw); if(obj&&obj.values) restoreControls(obj.values);
    setBadge('cargado ‚úì'); alert('Datos recuperados de la nube');
  }catch(e){ console.error(e); setBadge('error'); alert('Error al recuperar de nube: '+e.message); }
}

/* ========= Local, descargar y eventos ========= */
function saveLocal(){ try{ localStorage.setItem('__SEGUI_AUDIO_LOCAL__', JSON.stringify({ts:new Date().toISOString(),values:serializeControls()})); alert('Guardado local ‚úì'); }catch(e){ alert('Error local: '+e.message); } }
function downloadHTML(){
  const html='<!doctype html>\n'+document.documentElement.outerHTML;
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([html],{type:'text/html;charset=utf-8'}));
  a.download='index.html';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},100);
}

document.addEventListener('DOMContentLoaded',()=>{
  $('#btnReload')?.addEventListener('click',()=>location.reload());
  $('#btnSaveLocal')?.addEventListener('click',saveLocal);
  $('#btnSaveCloud')?.addEventListener('click',saveCloud);
  $('#btnLoadCloud')?.addEventListener('click',loadCloud);
  $('#btnDownload')?.addEventListener('click',downloadHTML);
  setBadge('listo');
});
</script>
</body>
</html>
