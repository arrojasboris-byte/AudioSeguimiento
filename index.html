<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SEGUIMIENTO AUDIO</title>
<style>
  :root{--primary:#d32f2f;--primary2:#b71c1c;--bg:#f7f8fc;--card:#fff;--text:#111827;--ring:rgba(211,47,47,.25);color-scheme:light dark}
  *{box-sizing:border-box} html,body{margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:var(--bg);color:var(--text);line-height:1.35}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(90deg,var(--primary2),var(--primary));color:#fff;padding:10px 14px;box-shadow:0 10px 24px rgba(0,0,0,.28)}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .title{font-weight:900;letter-spacing:.3px;font-size:1.05rem;margin-right:6px}
  .btn{display:inline-flex;align-items:center;gap:.5rem;cursor:pointer;border:0;border-radius:999px;padding:8px 12px;font-weight:800;background:#fff;color:var(--primary2);box-shadow:0 8px 18px rgba(0,0,0,.28)}
  .btn.secondary{background:#f7f7f9;color:#1f2937} .btn.small{padding:6px 10px}
  .chip{display:inline-flex;align-items:center;gap:.5rem;background:#ffffff22;padding:8px 12px;border-radius:999px;font-weight:700}
  .status{font-weight:800}.last{opacity:.92}
  .search{min-width:260px;border:0;outline:none;border-radius:999px;padding:9px 12px;background:#fff;color:#1f2937}
  .logoWrap{display:flex;align-items:center;gap:8px}
  .logoBadge{background:#fff;border-radius:10px;padding:4px 8px;box-shadow:0 4px 12px rgba(0,0,0,.25)}
  .logo{height:34px;width:auto;display:block}

  .layout{display:grid;grid-template-columns:340px 1fr;gap:18px;max-width:1300px;margin:18px auto;padding:0 16px}
  aside{background:var(--card);border-radius:16px;box-shadow:0 14px 34px rgba(30,41,59,.08);padding:12px}
  main{display:grid;gap:16px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 14px 34px rgba(30,41,59,.08);padding:16px}
  .card h2{margin:0 0 6px;font-size:1.05rem}
  .subtle{font-size:.85rem;opacity:.75;margin:0 0 12px}
  .muted{opacity:.7;font-size:.9rem}

  .sec{border:1px solid #0001;border-radius:12px;margin:10px 0;overflow:hidden}
  .sec header{all:unset;display:flex;align-items:center;justify-content:space-between;background:#f3f4f6;color:#111;padding:10px 12px;font-weight:800}
  .sec header button{border:0;background:#fff;color:#1f2937;border-radius:8px;padding:6px 10px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.12)}
  .sec .list{padding:8px 8px 10px;max-height:340px;overflow:auto}
  .item{display:flex;align-items:center;justify-content:space-between;gap:6px;padding:8px;border-radius:10px;cursor:pointer}
  .item:hover{background:#f5f6fb} .item.active{background:#e9ecff}
  .actions{display:flex;gap:6px} .iconbtn{border:0;background:#fff;border-radius:8px;padding:5px 8px;cursor:pointer;box-shadow:0 3px 9px rgba(0,0,0,.12)}

  label{display:block;font-size:.92rem;margin-bottom:6px}
  input[type="text"],select,textarea,input[type="number"],input[type="date"]{width:100%;border:1px solid #cfd3dc;border-radius:10px;padding:10px 12px;font:inherit;background:#fff;outline:none}
  input:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--ring)}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}

  /* tablas cuadr√≠cula */
  .table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden;table-layout:fixed}
  .table th,.table td{border:1px solid #dfe3eb;padding:8px 10px;text-align:left;background:#fff}
  .table th{background:#f3f4f6}
  .table input{width:100%;border:0;outline:none;background:transparent;padding:6px}
  .cell-act{display:flex;align-items:center;gap:6px}
  .pick{border:0;background:#fff;border-radius:8px;padding:3px 8px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.12)}
  .tbar{display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px}
  .tbar .addrow{border:0;background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;box-shadow:0 3px 9px rgba(0,0,0,.12)}

  .saveStrip{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:12px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 14px 30px rgba(0,0,0,.25);z-index:9999;opacity:.98}

  @media (prefers-color-scheme:dark){:root{--bg:#0e1116;--card:#171a21;--text:#e5e7eb}
    aside,.card{box-shadow:0 14px 34px rgba(0,0,0,.25)} .sec header{background:#111827;color:#e5e7eb}
    .item:hover{background:#1f2430}.item.active{background:#1b2b57}
    input,select,textarea{background:#0f1217;color:#e5e7eb;border-color:#2b2f3a}
    .search{background:#ffffffcc} .btn{background:#ffe2e2;color:#7f1212}.btn.secondary{background:#f0f0f0;color:#1f2937}
    .table th,.table td{border-color:#2b2f3a;background:#0f1217}.table th{background:#161a22}
    .logoBadge{background:#fff}
  }
</style>
</head>
<body>
  <header>
    <div class="bar">
      <span class="title">SEGUIMIENTO AUDIO</span>
      <div class="logoWrap">
        <div class="logoBadge"><img id="logoPreview" class="logo" alt="Logo"/></div>
      </div>
      <input id="search" class="search" type="search" placeholder="Buscar: secciones / centros / delegado / audi√≥logo‚Ä¶"/>
      <span class="chip status" id="status">‚è≥</span>
      <span class="chip last" id="last">‚Äî</span>
      <span class="chip">üîí <strong id="editState">Bloqueado</strong></span>
      <button id="btnEdit" class="btn secondary">Editar</button>
      <button id="btnLoad" class="btn secondary">üîÑ Actualizar</button>
      <button id="btnSave" class="btn">üíæ Guardar</button>
    </div>
  </header>

  <div class="layout">
    <!-- IZQUIERDA -->
    <aside id="aside">
      <section class="sec" data-sec="exclusivos">
        <header><div>üè• <strong>CENTROS EXCLUSIVOS</strong> <span class="muted">(m√°x. 10)</span></div>
          <div><button class="toggle" data-toggle="exclusivos">‚ñº</button><button class="add" data-add="exclusivos">Ôºã</button></div></header>
        <div class="list" id="list-exclusivos"></div>
      </section>
      <section class="sec" data-sec="flop">
        <header><div>üè• <strong>CENTROS FLOP</strong></div>
          <div><button class="toggle" data-toggle="flop">‚ñº</button><button class="add" data-add="flop">Ôºã</button></div></header>
        <div class="list" id="list-flop"></div>
      </section>
      <section class="sec" data-sec="visitas">
        <header><div>üìã <strong>VISITAS AUDIO</strong></div>
          <div><button class="toggle" data-toggle="visitas">‚ñº</button><button class="add" data-add="visitas">Ôºã</button></div></header>
        <div class="list" id="list-visitas"></div>
      </section>
      <section class="sec" data-sec="formaciones">
        <header><div>üéì <strong>FORMACIONES Y MENTORING</strong></div>
          <div><button class="toggle" data-toggle="formaciones">‚ñº</button><button class="add" data-add="formaciones">Ôºã</button></div></header>
        <div class="list" id="list-formaciones"></div>
      </section>
    </aside>

    <!-- DERECHA -->
    <main>
      <section class="card">
        <h2 id="detail-title">Detalle</h2>
        <p class="subtle" id="panelSub">‚Äî</p>
        <div id="detail-form"><p class="muted">Selecciona un item a la izquierda o crea uno con Ôºã.</p></div>
        <div class="saveStrip">
          <span class="muted" id="dirtyHint">‚Äî</span>
          <button class="btn" id="btnSaveDetail">üíæ Guardar cambios</button>
        </div>
      </section>
    </main>
  </div>

<script type="module">
/* ===== config ===== */
const PIN="AR4321";
const ENDPOINT=new URLSearchParams(location.search).get("endpoint")||"https://script.google.com/macros/s/AKfycby5vh1Ja0XllWFB98ypWmDcUfUItwEciVimUd5L6Esi1wfPJbcc2dap6G0lciRf51VR/exec";

/* ===== state ===== */
let canEdit=false; // solo afecta cabecera; las tablas SON SIEMPRE editables
let state={logoDataUrl:"",exclusivos:[],flop:[],visitas:[],formaciones:[]};
let selected={section:null,id:null};
let dirty=false;

/* ===== helpers ===== */
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
const statusEl=$("#status"), lastEl=$("#last"), editLbl=$("#editState");
const detailTitle=$("#detail-title"), detailForm=$("#detail-form"), panelSub=$("#panelSub"), dirtyHint=$("#dirtyHint");
const setStatus=t=>statusEl.textContent=t, setLast=t=>lastEl.textContent=t?`Actualizado: ${t}`:"‚Äî";
const toast=m=>{const x=document.createElement("div");x.className="toast";x.textContent=m;document.body.appendChild(x);setTimeout(()=>x.remove(),1800);};
const uid=()=>Math.random().toString(36).slice(2,10);
const setDirty=v=>{dirty=v; dirtyHint.textContent=v?"‚Ä¢ Tienes cambios sin guardar":"‚Äî";};

/* ===== left lists ===== */
const lists={exclusivos:$("#list-exclusivos"), flop:$("#list-flop"), visitas:$("#list-visitas"), formaciones:$("#list-formaciones")};
const sectionsDom={"exclusivos":document.querySelector('[data-sec="exclusivos"]'),"flop":document.querySelector('[data-sec="flop"]'),"visitas":document.querySelector('[data-sec="visitas"]'),"formaciones":document.querySelector('[data-sec="formaciones"]')};

function renderLists(filter=""){
  const f=filter.trim().toLowerCase();
  Object.keys(lists).forEach(sec=>{
    const data=state[sec]||[];
    const results=f?data.filter(it=>JSON.stringify(it).toLowerCase().includes(f)):data;
    sectionsDom[sec].style.display=(f && results.length===0)?"none":"";
    const ul=lists[sec]; ul.innerHTML="";
    results.forEach(it=>{
      const div=document.createElement("div");
      div.className="item"+(selected.section===sec&&selected.id===it.id?" active":"");
      const label=sec==="visitas"?(it.responsable||"(Responsable)"):sec==="formaciones"?(it.titulo||"(Formaci√≥n)"):(it.nombre||"(Centro)");
      div.innerHTML=`<span>${label}</span>
        <span class="actions">
          <button class="iconbtn edit" title="Editar">‚úèÔ∏è</button>
          <button class="iconbtn del" title="Eliminar">üóëÔ∏è</button>
        </span>`;
      div.addEventListener("click",e=>{
        if(!(e.target.classList.contains("edit")||e.target.classList.contains("del"))){
          selected={section:sec,id:it.id}; renderLists(filter); renderDetail();
        }
      });
      div.querySelector(".edit").onclick=()=>{selected={section:sec,id:it.id}; renderDetail();};
      div.querySelector(".del").onclick=()=>{ if(!confirm("¬øEliminar este elemento?"))return;
        state[sec]=state[sec].filter(x=>x.id!==it.id); selected={section:null,id:null}; renderLists($("#search").value); renderDetail(); setDirty(true);
      };
      ul.appendChild(div);
    });
  });
}
$("#search").addEventListener("input",e=>renderLists(e.target.value));

/* ===== context label ===== */
function setPanelSub(){
  if(!selected.section){ panelSub.textContent="‚Äî"; return; }
  const it=(state[selected.section]||[]).find(x=>x.id===selected.id);
  const name=selected.section==="visitas"?(it?.responsable||"‚Äî"):selected.section==="formaciones"?(it?.titulo||"‚Äî"):(it?.nombre||"‚Äî");
  panelSub.textContent=`Centro: ${name}`;
}

/* ===== detail + tables ===== */
function renderDetail(){
  setPanelSub();
  const {section,id}=selected;
  if(!section){ detailTitle.textContent="Detalle"; detailForm.innerHTML='<p class="muted">Selecciona un item a la izquierda o crea uno con Ôºã.</p>'; return; }
  const arr=state[section]; const it=arr.find(x=>x.id===id); if(!it) return;

  detailTitle.textContent = section==="exclusivos"?"Centro EXCLUSIVO"
    : section==="flop"?"Centro FLOP"
    : section==="visitas"?"Visita de AUDIO":"Formaci√≥n / Mentoring";

  if(section==="exclusivos"||section==="flop"){
    if(!it.historial) it.historial=[];
    if(!it.formaciones) it.formaciones=[];
    if(!it.evaluaciones) it.evaluaciones=[];

    detailForm.innerHTML=`
      <div class="row">
        <div class="col-6"><label>Nombre</label><input id="f_nombre" type="text" value="${it.nombre||""}" ${!canEdit?"disabled":""}></div>
        <div class="col-6"><label>Delegado</label><input id="f_delegado" type="text" value="${it.delegado||""}" ${!canEdit?"disabled":""}></div>
        <div class="col-6"><label>Audi√≥logo</label><input id="f_audiologo" type="text" value="${it.audiologo||""}" ${!canEdit?"disabled":""}></div>
        <div class="col-6"><label>Tipo</label>
          <select id="f_tipo" ${!canEdit?"disabled":""}>
            <option value="">‚Äî</option>
            <option value="sucursal" ${it.tipo==="sucursal"?"selected":""}>Sucursal</option>
            <option value="franquicia" ${it.tipo==="franquicia"?"selected":""}>Franquicia</option>
          </select>
        </div>
      </div>

      <!-- ACCIONES -->
      <div class="tbar" style="margin-top:10px">
        <h3 style="margin:12px 0 6px">Acciones</h3>
        <button class="addrow" id="addRowAcc">Ôºã A√±adir fila</button>
      </div>
      <div style="overflow:auto">
        <table class="table" id="tblAcc">
          <thead><tr>
            <th>Fecha</th>
            <th>Acci√≥n</th>
            <th>Derivaci√≥n</th>
            <th>Citas</th>
            <th>Ventas</th>
            <th>% Conversi√≥n</th>
            <th>Paquete</th>
            <th>Adjuntar archivo</th>
            <th></th>
          </tr></thead><tbody></tbody>
        </table>
      </div>

      <!-- FORMACIONES -->
      <div class="tbar" style="margin-top:18px">
        <h3 style="margin:12px 0 6px">Formaciones</h3>
        <button class="addrow" id="addRowForm">Ôºã A√±adir fila</button>
      </div>
      <p class="muted" style="margin-top:-6px">Espacio para 12 formaciones</p>
      <div style="overflow:auto">
        <table class="table" id="tblForm">
          <thead><tr>
            <th>Tema de curso / Mentoring</th>
            <th>Realizado</th>
            <th>Aplica</th>
            <th></th>
          </tr></thead><tbody></tbody>
        </table>
      </div>

      <!-- EVALUACIONES -->
      <div class="tbar" style="margin-top:18px">
        <h3 style="margin:12px 0 6px">Evaluaciones de procesos y visitas</h3>
        <button class="addrow" id="addRowEval">Ôºã A√±adir fila</button>
      </div>
      <div style="overflow:auto">
        <table class="table" id="tblEval">
          <thead><tr>
            <th>Fecha de visita</th>
            <th>Puntuaci√≥n</th>
            <th>√Åreas de mejora</th>
            <th>Adjuntar Excel</th>
            <th></th>
          </tr></thead><tbody></tbody>
        </table>
      </div>
    `;

    /* cabecera (opcionalmente bloqueable por PIN) */
    if(canEdit){
      $("#f_nombre").oninput =()=>{it.nombre=$("#f_nombre").value; renderLists($("#search").value); setDirty(true);};
      $("#f_delegado").oninput=()=>{it.delegado=$("#f_delegado").value; renderLists($("#search").value); setDirty(true);};
      $("#f_audiologo").oninput=()=>{it.audiologo=$("#f_audiologo").value; setDirty(true);};
      $("#f_tipo").onchange  =()=>{it.tipo=$("#f_tipo").value; setDirty(true);};
    }

    /* ===== ACCIONES ===== */
    const tbA=detailForm.querySelector("#tblAcc tbody");
    function rowAccHTML(r,i){
      const conv=(Number(r.citas)||0)?(((Number(r.ventas)||0)/(Number(r.citas)||1))*100).toFixed(1):"0.0";
      const fileLabel = r.archivoName ? `üìé ${r.archivoName}` : "Adjuntar .xls/.xlsx/.csv";
      return `<tr data-i="${i}">
        <td class="cell-act">
          <input type="date" value="${r.fecha||""}">
          <button class="pick" data-pick="date">üìÖ</button>
        </td>
        <td><input type="text" placeholder="Llamada / Taller / Visita‚Ä¶" value="${r.accion||""}"></td>
        <td><input type="text" placeholder="Hospital / Proveedor‚Ä¶" value="${r.derivacion||""}"></td>
        <td><input type="number" min="0" value="${r.citas??""}"></td>
        <td><input type="number" min="0" value="${r.ventas??""}"></td>
        <td><input type="text" disabled value="${conv}%"></td>
        <td><input type="text" placeholder="Paquete‚Ä¶" value="${r.paquete||""}"></td>
        <td>
          <label class="btn small" style="padding:4px 8px">${fileLabel}
            <input type="file" accept=".xls,.xlsx,.csv" style="display:none">
          </label>
        </td>
        <td><button class="iconbtn delA">üóëÔ∏è</button></td>
      </tr>`;
    }
    function renderAcc(){
      tbA.innerHTML = it.historial.map((r,i)=>rowAccHTML(r,i)).join("") || `<tr><td colspan="9" class="muted">Sin filas</td></tr>`;
    }
    renderAcc();

    // delegaci√≥n de eventos acciones
    tbA.onclick = (ev)=>{
      const tr=ev.target.closest("tr"); if(!tr) return; const i=+tr.dataset.i;
      if(ev.target.classList.contains("delA")){ it.historial.splice(i,1); renderAcc(); setDirty(true); return;}
      if(ev.target.dataset.pick==="date"){ tr.querySelector('input[type="date"]').showPicker?.(); return; }
    };
    tbA.oninput = (ev)=>{
      const tr=ev.target.closest("tr"); if(!tr) return; const i=+tr.dataset.i;
      const inputs=[...tr.querySelectorAll("input")];
      const [date,acc,der,citas,ventas,conv,paq]=inputs;
      it.historial[i].fecha   = date.value;
      it.historial[i].accion  = acc.value;
      it.historial[i].derivacion = der.value;
      it.historial[i].citas   = +citas.value||0;
      it.historial[i].ventas  = +ventas.value||0;
      it.historial[i].paquete = paq.value;
      const p = (it.historial[i].citas ? (it.historial[i].ventas||0)/it.historial[i].citas*100 : 0).toFixed(1);
      conv.value = p+"%";
      setDirty(true);
    };
    tbA.onchange = (ev)=>{
      const tr=ev.target.closest("tr"); if(!tr) return; const i=+tr.dataset.i;
      const file=ev.target.files?.[0]; if(!file) return;
      const r=new FileReader();
      r.onload=()=>{ it.historial[i].archivoName=file.name; it.historial[i].archivoDataUrl=String(r.result||""); tr.querySelector("label").firstChild.textContent=`üìé ${file.name}`; setDirty(true); };
      r.readAsDataURL(file);
    };
    $("#addRowAcc").onclick=()=>{ it.historial.push({fecha:"",accion:"",derivacion:"",citas:0,ventas:0,paquete:"",archivoName:"",archivoDataUrl:""}); renderAcc(); setDirty(true);};

    /* ===== FORMACIONES ===== */
    const tbF=detailForm.querySelector("#tblForm tbody");
    function rowFormHTML(r,i){
      return `<tr data-i="${i}">
        <td><input type="text" placeholder="Tema del curso o mentoring" value="${r.tema||""}"></td>
        <td style="text-align:center"><input type="checkbox" ${r.realizado?"checked":""}></td>
        <td style="text-align:center"><input type="checkbox" ${r.aplica?"checked":""}></td>
        <td><button class="iconbtn delF">üóëÔ∏è</button></td>
      </tr>`;
    }
    function renderForm(){ tbF.innerHTML = it.formaciones.map((r,i)=>rowFormHTML(r,i)).join("") || `<tr><td colspan="4" class="muted">Sin formaciones</td></tr>`; }
    renderForm();
    tbF.onclick=(ev)=>{ const tr=ev.target.closest("tr"); if(!tr) return; const i=+tr.dataset.i; if(ev.target.classList.contains("delF")){it.formaciones.splice(i,1); renderForm(); setDirty(true);} };
    tbF.oninput=(ev)=>{ const tr=ev.target.closest("tr"); if(!tr)return; const i=+tr.dataset.i; const ins=[...tr.querySelectorAll("input")]; it.formaciones[i].tema=ins[0].value; it.formaciones[i].realizado=ins[1].checked; it.formaciones[i].aplica=ins[2].checked; setDirty(true); };
    tbF.onchange=tbF.oninput;
    $("#addRowForm").onclick=()=>{ if(it.formaciones.length>=12){ toast("M√°ximo 12 formaciones"); return; } it.formaciones.push({tema:"",realizado:false,aplica:false}); renderForm(); setDirty(true); };

    /* ===== EVALUACIONES ===== */
    const tbE=detailForm.querySelector("#tblEval tbody");
    function rowEvalHTML(r,i){
      const fileLabel = r.archivoName ? `üìé ${r.archivoName}` : "Adjuntar .xls/.xlsx/.csv";
      return `<tr data-i="${i}">
        <td class="cell-act"><input type="date" value="${r.fecha||""}"><button class="pick" data-pick="date">üìÖ</button></td>
        <td><input type="number" min="0" max="10" step="0.1" placeholder="0-10" value="${r.puntos??""}"></td>
        <td><input type="text" placeholder="√Åreas de mejora‚Ä¶" value="${r.mejoras||""}"></td>
        <td><label class="btn small" style="padding:4px 8px">${fileLabel}<input type="file" accept=".xls,.xlsx,.csv" style="display:none"></label></td>
        <td><button class="iconbtn delE">üóëÔ∏è</button></td>
      </tr>`;
    }
    function renderEval(){ tbE.innerHTML = it.evaluaciones.map((r,i)=>rowEvalHTML(r,i)).join("") || `<tr><td colspan="5" class="muted">Sin evaluaciones</td></tr>`; }
    renderEval();
    tbE.onclick=(ev)=>{ const tr=ev.target.closest("tr"); if(!tr)return; const i=+tr.dataset.i; if(ev.target.classList.contains("delE")){it.evaluaciones.splice(i,1); renderEval(); setDirty(true); return;} if(ev.target.dataset.pick==="date"){ tr.querySelector('input[type="date"]').showPicker?.(); } };
    tbE.oninput=(ev)=>{ const tr=ev.target.closest("tr"); if(!tr)return; const i=+tr.dataset.i; const ins=[...tr.querySelectorAll("input")]; it.evaluaciones[i].fecha=ins[0].value; it.evaluaciones[i].puntos=+ins[1].value||0; it.evaluaciones[i].mejoras=ins[2].value; setDirty(true); };
    tbE.onchange=(ev)=>{ const tr=ev.target.closest("tr"); if(!tr)return; const i=+tr.dataset.i; const file=ev.target.files?.[0]; if(!file)return; const r=new FileReader(); r.onload=()=>{it.evaluaciones[i].archivoName=file.name; it.evaluaciones[i].archivoDataUrl=String(r.result||""); tr.querySelector("label").firstChild.textContent=`üìé ${file.name}`; setDirty(true);}; r.readAsDataURL(file); };
    $("#addRowEval").onclick=()=>{ it.evaluaciones.push({fecha:"",puntos:0,mejoras:"",archivoName:"",archivoDataUrl:""}); renderEval(); setDirty(true); };

  } else if(section==="visitas"){
    detailForm.innerHTML=`<div class="row"><div class="col-6"><label>Responsable</label><input id="f_responsable" type="text" value="${arr.find(x=>x.id===id)?.responsable||""}"></div></div>`;
    $("#f_responsable").oninput=()=>{const v=$("#f_responsable").value; arr.find(x=>x.id===id).responsable=v; renderLists($("#search").value); setDirty(true);};
  } else {
    detailForm.innerHTML=`<div class="row">
      <div class="col-6"><label>T√≠tulo</label><input id="f_titulo" type="text" value="${arr.find(x=>x.id===id)?.titulo||""}"></div>
      <div class="col-3"><label>Mentor</label><input id="f_mentor" type="text" value="${arr.find(x=>x.id===id)?.mentor||""}"></div>
      <div class="col-3"><label>Fecha</label><div class="cell-act"><input id="f_fecha" type="date" value="${arr.find(x=>x.id===id)?.fecha||""}"><button class="pick" onclick="document.getElementById('f_fecha').showPicker?.()">üìÖ</button></div></div>
    </div>`;
    $("#f_titulo").oninput=()=>{arr.find(x=>x.id===id).titulo=$("#f_titulo").value; renderLists($("#search").value); setDirty(true);};
    $("#f_mentor").oninput=()=>{arr.find(x=>x.id===id).mentor=$("#f_mentor").value; setDirty(true);};
    $("#f_fecha").oninput =()=>{arr.find(x=>x.id===id).fecha=$("#f_fecha").value; setDirty(true);};
  }
}

/* ===== add items ===== */
function addItem(section){
  if(section==="exclusivos" && state.exclusivos.length>=10){ toast("M√°x. 10 exclusivos"); return; }
  const obj = section==="visitas" ? {id:uid(), responsable:""}
    : section==="formaciones" ? {id:uid(), titulo:"", mentor:"", fecha:""}
    : {id:uid(), nombre:"", delegado:"", audiologo:"", tipo:"", historial:[], formaciones:[], evaluaciones:[]};
  state[section].push(obj); selected={section,id:obj.id}; renderLists($("#search").value); renderDetail(); setDirty(true);
}
$$(".toggle").forEach(b=>b.onclick=()=>{const k=b.dataset.toggle; const l=document.getElementById(`list-${k}`); const open=!l.classList.contains("hidden"); if(open){l.classList.add("hidden");b.textContent="‚ñ∫";}else{l.classList.remove("hidden");b.textContent="‚ñº";}});
$$(".add").forEach(b=>b.onclick=()=>addItem(b.dataset.add));

/* ===== edit pin ===== */
function setEdit(on){ canEdit=!!on; editLbl.textContent=canEdit?"Editando":"Bloqueado"; renderDetail(); }
$("#btnEdit").onclick=()=>{ if(canEdit){ setEdit(false); return; } const p=prompt("Introduce PIN para editar cabecera (tablas ya son editables):"); if(p===PIN){ setEdit(true); toast("Edici√≥n desbloqueada"); } else alert("PIN incorrecto."); };

/* ===== cloud (con fallbacks CORS) ===== */
async function tryPost(type,mode){const body=JSON.stringify({action:"save",pin:PIN,state}); return fetch(ENDPOINT,{method:"POST",headers:{"Content-Type":type},body,...(mode?{mode}:{})});}
async function saveToCloud(){
  try{
    setStatus("üíæ Guardando‚Ä¶");
    try{const r1=await tryPost("application/json"); const t1=await r1.text(); let j1=null; try{j1=JSON.parse(t1);}catch{} if(r1.ok&&j1?.ok){okSave(j1.updatedAt); return;} throw 0;}catch{}
    try{const r2=await tryPost("text/plain;charset=utf-8"); const t2=await r2.text(); let j2=null; try{j2=JSON.parse(t2);}catch{} if(r2.ok&&j2?.ok){okSave(j2.updatedAt); return;} throw 0;}catch{}
    await tryPost("text/plain;charset=utf-8","no-cors"); setStatus("‚è≥ Verificando‚Ä¶"); setTimeout(async()=>{await loadFromCloud(); okSave(new Date().toISOString());},450);
  }catch(e){console.error(e); setStatus("‚ùå Error al guardar"); alert("No se pudo guardar.");}
}
function okSave(ts){setStatus("‚úÖ Guardado"); setLast(ts); setDirty(false); toast("Guardado");}
async function loadFromCloud(){
  try{
    setStatus("‚¨áÔ∏è Cargando‚Ä¶");
    const u=new URL(ENDPOINT); u.searchParams.set("action","load"); u.searchParams.set("pin",PIN);
    const res=await fetch(u.toString(),{method:"GET"}); const t=await res.text(); let j=null; try{j=JSON.parse(t);}catch{}
    if(!res.ok||!j?.ok) throw 0;
    state=Object.assign({logoDataUrl:"",exclusivos:[],flop:[],visitas:[],formaciones:[]}, j.state||{});
    // mostrar logo con fondo blanco
    const logo=$("#logoPreview"); if(state.logoDataUrl){logo.src=state.logoDataUrl;} else {logo.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='36'%3E%3Ctext x='0' y='24' font-size='20'%3E%3C/text%3E%3C/svg%3E";}
    selected={section:null,id:null}; renderLists($("#search").value); renderDetail();
    setStatus("‚úÖ Actualizado"); setLast(j.updatedAt); setDirty(false);
  }catch(e){console.error(e); setStatus("‚ùå Error al cargar"); alert("No se pudo cargar.");}
}
$("#btnSave").onclick=saveToCloud;
$("#btnLoad").onclick=loadFromCloud;
$("#btnSaveDetail").onclick=saveToCloud;

/* ===== init ===== */
setEdit(false); renderLists(); renderDetail(); loadFromCloud();
</script>
</body>
</html>
