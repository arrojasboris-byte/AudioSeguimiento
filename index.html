<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>AUDIOLOGIA-SEGUIMIENTO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { scroll-behavior: smooth; }
    .btn { display:inline-flex; align-items:center; justify-content:center; border-radius:0.5rem; padding:0.5rem 0.75rem; font-size:0.875rem; font-weight:600; box-shadow:0 1px 2px rgba(0,0,0,.05); }
    .btn-red { background:#dc2626; color:#fff; } .btn-red:hover{ background:#b91c1c; }
    .btn-blue{ background:#2563eb; color:#fff; } .btn-blue:hover{ background:#1d4ed8; }
    .btn-green{ background:#16a34a; color:#fff; } .btn-green:hover{ background:#15803d; }
    .btn-gray{ background:#4b5563; color:#fff; } .btn-gray:hover{ background:#374151; }
    .chip{ display:inline-block; border-radius:0.5rem; border-width:2px; padding:0.125rem 0.5rem; font-size:0.75rem; font-weight:700; }
    .card{ background:#fff; border-left:4px solid #dc2626; border-radius:0.75rem; box-shadow:0 10px 20px rgba(0,0,0,.06); }
    .subcard{ background:#f9fafb; border:2px solid #e5e7eb; border-radius:0.75rem; }
    details > summary::-webkit-details-marker {display:none}
    summary { user-select:none; cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:0.75rem; padding:0.75rem 1rem; font-weight:700; color:#1f2937; background:#fff; border:1px solid #e5e7eb; border-radius:0.5rem; }
    .icon { width:18px; height:18px; }
    .drag-handle { cursor:move; }
    .grabber { width:3px; height:3px; background:#9ca3af; border-radius:9999px; margin:2px auto; }
    .floating-cloud { position: fixed; right: 12px; bottom: 12px; display:flex; gap:8px; flex-direction:column; z-index: 9999; }
    .hidden-important { display:none !important; }
    input, select { outline: none; }
    table input, table select { background:#fff; }
    .muted { color:#6b7280; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200">

  <!-- HEADER -->
  <header class="bg-white border-b-4 border-red-600 shadow-xl">
    <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="bg-gradient-to-br from-red-600 to-red-700 p-3 rounded-xl shadow-lg">
          <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-3xl font-extrabold text-gray-800">AUDIOLOGIA-SEGUIMIENTO</h1>
          <p class="text-red-600">Sistema de Gesti√≥n de Audiolog√≠a</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="relative">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <input id="searchInput" type="text" placeholder="Buscar en secciones, centros y tablas..."
                 class="pl-10 pr-4 py-2 bg-white border-2 border-gray-300 text-gray-800 placeholder-gray-400 rounded-lg focus:border-red-600 focus:outline-none w-72">
        </div>
        <button id="btnSaveLocal" class="btn btn-gray">üíæ Guardar local</button>
        <button id="btnReset" class="btn btn-gray">‚Ü∫ Reset</button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-6 py-8">
    <div class="grid grid-cols-12 gap-6">
      <!-- SIDEBAR -->
      <aside class="col-span-12 lg:col-span-3">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-gray-800">Secciones</h2>
            <button id="btnAddSection" class="btn btn-red px-2 py-1">+ Secci√≥n</button>
          </div>
          <nav id="sectionsNav" class="space-y-2"></nav>

          <!-- Centros -->
          <div id="centrosWrap" class="mt-4 hidden">
            <button id="toggleCentros" class="w-full btn btn-blue">Centros ‚ñæ</button>
            <div id="centrosList" class="mt-2 hidden bg-gray-100 rounded-lg p-2 border border-gray-200 space-y-2"></div>
            <div class="mt-2">
              <button id="btnAddCentro" class="btn btn-green w-full">+ A√±adir Centro</button>
              <p class="text-xs muted mt-1 text-center">M√°x. 12 centros</p>
            </div>
          </div>
        </div>
      </aside>

      <!-- CONTENT -->
      <section class="col-span-12 lg:col-span-9">
        <div class="card p-6">
          <div class="flex items-center justify-between mb-5">
            <div class="flex items-center gap-3">
              <div class="bg-red-600 p-3 rounded-lg shadow-md">
                <svg id="activeIcon" class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
              </div>
              <div>
                <h2 id="activeTitle" class="text-2xl font-bold text-gray-800">‚Äî</h2>
                <div id="activeCentroChip" class="mt-1"></div>
              </div>
            </div>
          </div>

          <!-- PANEL: Acciones-Resultado -->
          <details id="panelAcciones" class="subcard p-4 mb-5" open>
            <summary>
              <span>Acciones-Resultado</span>
              <div class="flex items-center gap-2">
                <button id="btnAddAccion" class="btn btn-blue px-2 py-1">+ A√±adir</button>
                <button id="btnSaveAcciones" class="btn btn-green px-2 py-1">Guardar</button>
              </div>
            </summary>
            <div class="mt-4 overflow-x-auto">
              <table class="w-full border-collapse bg-white rounded-lg overflow-hidden shadow-sm text-sm">
                <thead>
                  <tr class="bg-red-600 text-white">
                    <th class="px-2 py-2 w-6">‚Üï</th>
                    <th class="px-2 py-2 w-10">#</th>
                    <th class="px-2 py-2 w-36">Fecha</th>
                    <th class="px-2 py-2 w-56">Acci√≥n</th>
                    <th class="px-2 py-2 w-24">Derivaci√≥n</th>
                    <th class="px-2 py-2 w-24">Cita</th>
                    <th class="px-2 py-2">Observaciones</th>
                    <th class="px-2 py-2 w-12">‚ùå</th>
                  </tr>
                </thead>
                <tbody id="tbodyAcciones"></tbody>
              </table>
              <div class="text-xs muted mt-2">Consejo: reordena arrastrando el manejador (columna ‚Üï).</div>
            </div>
          </details>

          <!-- PANEL: Formaci√≥n Continua -->
          <details id="panelFormacion" class="subcard p-4 mb-5">
            <summary>
              <span>Formaci√≥n Continua</span>
              <div class="flex items-center gap-2">
                <button id="btnSaveFormacion" class="btn btn-green px-2 py-1">Guardar</button>
              </div>
            </summary>
            <div class="mt-4 overflow-x-auto">
              <table class="w-full border-collapse bg-white rounded-lg overflow-hidden shadow-sm text-sm">
                <thead>
                  <tr class="bg-red-600 text-white">
                    <th class="px-2 py-2 w-6">‚Üï</th>
                    <th class="px-2 py-2 w-10">#</th>
                    <th class="px-2 py-2 w-36">Fecha</th>
                    <th class="px-2 py-2 w-32">Asistencia</th>
                    <th class="px-2 py-2">T√≠tulo</th>
                    <th class="px-2 py-2">Aplicaci√≥n</th>
                  </tr>
                </thead>
                <tbody id="tbodyFormacion"></tbody>
              </table>
              <div class="mt-3 flex items-center gap-4 text-sm">
                <div class="flex items-center gap-2">
                  <div class="w-4 h-4 bg-orange-100 border border-orange-300 rounded"></div>
                  <span class="text-gray-700">Asistencia: SI</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-4 h-4 bg-green-100 border border-green-300 rounded"></div>
                  <span class="text-gray-700">Asistencia: SI + Aplicaci√≥n</span>
                </div>
              </div>
            </div>
          </details>

          <!-- PANEL: Procesos Personalizados -->
          <details id="panelProcesos" class="subcard p-4">
            <summary>
              <span>Procesos y Paquetes Personalizados</span>
              <div class="flex items-center gap-2">
                <button id="btnAddProceso" class="btn btn-blue px-2 py-1">+ A√±adir</button>
                <button id="btnSaveProcesos" class="btn btn-green px-2 py-1">Guardar</button>
              </div>
            </summary>
            <div class="mt-4 overflow-x-auto">
              <table class="w-full border-collapse bg-white rounded-lg overflow-hidden shadow-sm text-sm">
                <thead>
                  <tr class="bg-red-600 text-white">
                    <th class="px-2 py-2 w-6">‚Üï</th>
                    <th class="px-2 py-2 w-10">#</th>
                    <th class="px-2 py-2 w-52">Nombre Paquete</th>
                    <th class="px-2 py-2">Descripci√≥n</th>
                    <th class="px-2 py-2 w-28">Puntuaci√≥n</th>
                    <th class="px-2 py-2">Observaciones</th>
                    <th class="px-2 py-2 w-36">Fecha Visita</th>
                    <th class="px-2 py-2 w-24">Acciones</th>
                    <th class="px-2 py-2 w-12">‚ùå</th>
                  </tr>
                </thead>
                <tbody id="tbodyProcesos"></tbody>
              </table>
            </div>
          </details>
        </div>
      </section>
    </div>
  </main>

  <!-- Botones Nube -->
  <div class="floating-cloud">
    <button id="btnCloudSave" class="btn btn-green">‚òÅ Guardar nube</button>
    <button id="btnCloudLoad" class="btn btn-blue">‚òÅ Cargar nube</button>
  </div>

  <!-- ========== APP LOGIC ========== -->
  <script>
    const LS_KEY = "audioseguimiento_state_v2";
    const centroColors = [
      'bg-blue-100 border-blue-400 text-blue-800',
      'bg-green-100 border-green-400 text-green-800',
      'bg-purple-100 border-purple-400 text-purple-800',
      'bg-orange-100 border-orange-400 text-orange-800',
      'bg-pink-100 border-pink-400 text-pink-800',
      'bg-indigo-100 border-indigo-400 text-indigo-800',
      'bg-yellow-100 border-yellow-400 text-yellow-800',
      'bg-red-100 border-red-400 text-red-800',
      'bg-teal-100 border-teal-400 text-teal-800',
      'bg-cyan-100 border-cyan-400 text-cyan-800',
      'bg-lime-100 border-lime-400 text-lime-800',
      'bg-rose-100 border-rose-400 text-rose-800'
    ];
    const defaultState = () => ({
      activeSection: 'centros_exclusivos',
      showCentrosDropdown: true,
      activeCentroId: 1,
      centros: [
        { id: 1, nombre: 'Centro Madrid Norte', delegado: 'Ana Mart√≠nez', audiologo: 'Dr. Garc√≠a', tipo: 'Franquicia', color: centroColors[0] },
        { id: 2, nombre: 'Centro Barcelona Centro', delegado: 'Carlos Ruiz', audiologo: 'Dra. L√≥pez', tipo: 'Sucursal', color: centroColors[1] }
      ],
      sections: {
        centros_exclusivos: {
          title: 'CENTROS EXCLUSIVOS',
          requiresCentro: true,
          centrosData: {
            1: {
              acciones: [{ id:1, fecha:'', accion:'', derivacion:0, cita:0, observaciones:'' }],
              formaciones: Array.from({length: 10}, (_,i)=>({ id:i+1, fecha:'', asistencia:'', titulo:'', aplicacion:'' })),
              procesos: [{ id:1, nombrePaquete:'', descripcion:'', puntuacion:'', observaciones:'', fechaVisita:'', archivos:[], enlaces:[] }]
            },
            2: {
              acciones: [{ id:1, fecha:'', accion:'', derivacion:0, cita:0, observaciones:'' }],
              formaciones: Array.from({length: 10}, (_,i)=>({ id:i+1, fecha:'', asistencia:'', titulo:'', aplicacion:'' })),
              procesos: [{ id:1, nombrePaquete:'', descripcion:'', puntuacion:'', observaciones:'', fechaVisita:'', archivos:[], enlaces:[] }]
            }
          }
        },
        centros_flop: { title:'CENTROS FLOP', requiresCentro:false, items:[] },
        visitas_audio: { title:'VISITAS AUDIO', requiresCentro:false, items:[] },
        mentoring_audio:{ title:'MENTORING AUDIO', requiresCentro:false, items:[] },
        producto_pedidos:{ title:'Producto / Pedidos / Devoluciones', requiresCentro:false, items:[] },
        comunicacion:   { title:'Comunicaci√≥n', requiresCentro:false, items:[] },
        area_social:    { title:'√Årea Social y Colaboraciones', requiresCentro:false, items:[] }
      }
    });

    let state = loadLocal() || defaultState();

    function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function loadLocal(){
      const raw = localStorage.getItem(LS_KEY);
      try { return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
    }
    function resetLocal(){
      localStorage.removeItem(LS_KEY);
      state = defaultState();
      renderAll();
    }

    function byId(id){ return document.getElementById(id); }
    function nextId(list){ return (Math.max(0, ...list.map(x=>+x.id||0))+1) || 1; }
    function humanIndex(i){ return (i+1).toString(); }
    function ensureCentroData(centroId){
      const cd = state.sections.centros_exclusivos.centrosData;
      if (!cd[centroId]) {
        cd[centroId] = {
          acciones: [{ id:1, fecha:'', accion:'', derivacion:0, cita:0, observaciones:'' }],
          formaciones: Array.from({length: 10}, (_,i)=>({ id:i+1, fecha:'', asistencia:'', titulo:'', aplicacion:'' })),
          procesos: [{ id:1, nombrePaquete:'', descripcion:'', puntuacion:'', observaciones:'', fechaVisita:'', archivos:[], enlaces:[] }]
        };
      }
    }

    // Buscar (resaltado simple en tablas y t√≠tulos)
    byId('searchInput').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      document.querySelectorAll('[data-searchable]').forEach(el=>{
        const hit = el.dataset.searchable.toLowerCase().includes(q);
        el.classList.toggle('hidden-important', q && !hit);
      });
      // Tablas: no ocultamos filas (para no descuadrar), pero podr√≠as a√±adir l√≥gica extra aqu√≠.
    });

    // NAV de secciones
    function renderSectionsNav(){
      const nav = byId('sectionsNav');
      nav.innerHTML = '';
      Object.entries(state.sections).forEach(([id, sec])=>{
        const isActive = id === state.activeSection;
        const btn = document.createElement('button');
        btn.className = `w-full flex items-center justify-between gap-3 px-4 py-3 rounded-lg transition-all ${isActive ? 'bg-red-600 text-white shadow-md' : 'text-gray-700 bg-gray-50 hover:bg-gray-100'}`;
        btn.innerHTML = `
          <span class="font-medium text-sm" data-searchable="${sec.title}">${sec.title}</span>
          ${sec.requiresCentro ? '<span class="text-xs bg-black/10 px-2 py-0.5 rounded-full">'+ state.centros.length +'/12</span>' : ''}
        `;
        btn.onclick = ()=>{
          state.activeSection = id;
          saveLocal();
          renderAll();
        };
        nav.appendChild(btn);
      });
    }

    // Centros
    function renderCentros(){
      const wrap = byId('centrosWrap');
      const isCentros = state.activeSection === 'centros_exclusivos';
      wrap.classList.toggle('hidden', !isCentros);
      if (!isCentros) return;

      const list = byId('centrosList');
      list.classList.toggle('hidden', !state.showCentrosDropdown);
      list.innerHTML = '';

      state.centros.forEach((c, idx)=>{
        const row = document.createElement('div');
        row.className = 'relative group bg-white border-2 border-gray-200 rounded-lg p-2';
        const active = c.id === state.activeCentroId;
        row.setAttribute('data-searchable', `${c.nombre} ${c.delegado} ${c.audiologo} ${c.tipo}`);

        row.innerHTML = `
          <div class="flex items-center gap-2">
            <button class="flex-1 text-left px-2 py-1.5 rounded-md text-xs transition-all border-2 ${active ? c.color : 'bg-white text-gray-700 border-gray-200 hover:border-gray-300'}" data-action="select">
              <div class="font-bold truncate">${c.nombre}</div>
              <div class="text-xs opacity-75 truncate">üë§ ${c.delegado} | üéß ${c.audiologo}</div>
              <div class="text-xs opacity-75">üìç ${c.tipo || '-'}</div>
            </button>
            <div class="flex flex-col gap-1">
              <button class="p-1 bg-blue-500 hover:bg-blue-600 text-white rounded" title="Editar" data-action="edit">‚úé</button>
              <button class="p-1 bg-red-500 hover:bg-red-600 text-white rounded" title="Eliminar" data-action="del">‚úï</button>
            </div>
          </div>
          <div class="mt-2 hidden" data-edit>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <input class="border rounded px-2 py-1" placeholder="Nombre" value="${c.nombre}" data-f="nombre">
              <input class="border rounded px-2 py-1" placeholder="Delegado" value="${c.delegado}" data-f="delegado">
              <input class="border rounded px-2 py-1" placeholder="Audi√≥logo" value="${c.audiologo}" data-f="audiologo">
              <select class="border rounded px-2 py-1" data-f="tipo">
                <option value="">Seleccionar...</option>
                <option ${c.tipo==='Franquicia'?'selected':''}>Franquicia</option>
                <option ${c.tipo==='Sucursal'?'selected':''}>Sucursal</option>
              </select>
            </div>
            <div class="flex gap-2 mt-2">
              <button class="btn btn-green flex-1" data-action="save">‚úì Guardar</button>
              <button class="btn btn-gray flex-1" data-action="cancel">Cancelar</button>
            </div>
          </div>
        `;

        row.onclick = (e)=>{
          const act = e.target.closest('[data-action]')?.dataset.action;
          if (!act) return;
          if (act === 'select') {
            state.activeCentroId = c.id;
            ensureCentroData(c.id);
            saveLocal(); renderAll();
          }
          if (act === 'edit') {
            row.querySelector('[data-edit]').classList.toggle('hidden');
          }
          if (act === 'cancel') {
            row.querySelector('[data-edit]').classList.add('hidden');
          }
          if (act === 'save') {
            const nombre = row.querySelector('[data-f="nombre"]').value.trim();
            if (!nombre) { alert('Nombre requerido'); return; }
            state.centros[idx] = {
              ...state.centros[idx],
              nombre,
              delegado: row.querySelector('[data-f="delegado"]').value.trim(),
              audiologo: row.querySelector('[data-f="audiologo"]').value.trim(),
              tipo: row.querySelector('[data-f="tipo"]').value
            };
            saveLocal(); renderAll();
          }
          if (act === 'del') {
            if (!confirm('¬øEliminar este centro?')) return;
            const delId = c.id;
            state.centros = state.centros.filter(z => z.id !== delId);
            if (state.activeCentroId === delId) state.activeCentroId = state.centros[0]?.id || null;
            delete state.sections.centros_exclusivos.centrosData[delId];
            saveLocal(); renderAll();
          }
        };
        list.appendChild(row);
      });
    }

    function renderActiveHeader(){
      const sec = state.sections[state.activeSection];
      byId('activeTitle').textContent = sec.title;

      const chipWrap = byId('activeCentroChip');
      chipWrap.innerHTML = '';
      if (sec.requiresCentro && state.activeCentroId) {
        const c = state.centros.find(x => x.id === state.activeCentroId);
        if (c) {
          const chip = document.createElement('span');
          chip.className = `chip ${c.color}`;
          chip.textContent = c.nombre;
          chipWrap.appendChild(chip);
        }
      }
      // Mostrar/ocultar wrapper de Centros en sidebar
      byId('centrosWrap').classList.toggle('hidden', !sec.requiresCentro);
    }

    function renderAcciones(){
      const tb = byId('tbodyAcciones'); tb.innerHTML = '';
      const sec = state.sections[state.activeSection];
      if (!sec.requiresCentro) { tb.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">Selecciona "CENTROS EXCLUSIVOS".</td></tr>'; return; }
      ensureCentroData(state.activeCentroId);
      const arr = state.sections.centros_exclusivos.centrosData[state.activeCentroId].acciones;

      arr.forEach((a, i)=>{
        const isGreen = (+a.derivacion>0 && +a.cita>0);
        const tr = document.createElement('tr');
        tr.className = `${isGreen ? 'bg-green-100' : 'bg-white'} hover:bg-opacity-80 transition`;
        tr.setAttribute('data-searchable', `${a.fecha} ${a.accion} ${a.observaciones} ${a.derivacion} ${a.cita}`);
        tr.innerHTML = `
          <td class="text-center align-top drag-handle"><div class="grabber"></div><div class="grabber"></div><div class="grabber"></div></td>
          <td class="text-center font-bold">${(i+1)}</td>
          <td><input type="date" value="${a.fecha||''}" class="w-full border rounded px-2 py-1" data-f="fecha"></td>
          <td><input type="text" value="${a.accion||''}" placeholder="Descripci√≥n..." class="w-full border rounded px-2 py-1" data-f="accion"></td>
          <td><input type="number" min="0" value="${a.derivacion||0}" class="w-full border rounded px-2 py-1 text-center font-bold" data-f="derivacion"></td>
          <td><input type="number" min="0" value="${a.cita||0}" class="w-full border rounded px-2 py-1 text-center font-bold" data-f="cita"></td>
          <td><input type="text" value="${a.observaciones||''}" placeholder="Observaciones..." class="w-full border rounded px-2 py-1" data-f="observaciones"></td>
          <td class="text-center"><button class="text-red-600" data-action="del">‚úï</button></td>
        `;
        tr.oninput = e=>{
          const f = e.target.dataset.f; if (!f) return;
          arr[i][f] = (f==='derivacion'||f==='cita') ? (+e.target.value||0) : e.target.value;
        };
        tr.onclick = e=>{
          if (e.target.dataset.action === 'del') {
            if (arr.length===1) return;
            arr.splice(i,1); renderAcciones();
          }
        };
        tb.appendChild(tr);
      });
      makeRowsDraggable(tb, arr, renderAcciones);
    }

    function renderFormacion(){
      const tb = byId('tbodyFormacion'); tb.innerHTML = '';
      const sec = state.sections[state.activeSection];
      if (!sec.requiresCentro) { tb.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">Selecciona "CENTROS EXCLUSIVOS".</td></tr>'; return; }
      ensureCentroData(state.activeCentroId);
      const arr = state.sections.centros_exclusivos.centrosData[state.activeCentroId].formaciones;

      arr.forEach((f, i)=>{
        const asiste = (f.asistencia||'').toLowerCase();
        const aplica = (f.aplicacion||'').trim();
        let bg = 'bg-white';
        if (asiste==='si' || asiste==='s√≠') bg = 'bg-orange-100';
        if ((asiste==='si' || asiste==='s√≠') && (aplica && aplica.length>0 && aplica.toLowerCase()!=='no')) bg='bg-green-100';

        const tr = document.createElement('tr');
        tr.className = `${bg} hover:bg-opacity-80 transition`;
        tr.setAttribute('data-searchable', `${f.fecha} ${f.asistencia} ${f.titulo} ${f.aplicacion}`);
        tr.innerHTML = `
          <td class="text-center align-top drag-handle"><div class="grabber"></div><div class="grabber"></div><div class="grabber"></div></td>
          <td class="text-center font-bold">${(i+1)}</td>
          <td><input type="date" value="${f.fecha||''}" class="w-full border rounded px-2 py-1" data-f="fecha"></td>
          <td>
            <select class="w-full border rounded px-2 py-1 font-semibold" data-f="asistencia">
              <option value="" ${!f.asistencia?'selected':''}>-</option>
              <option value="SI" ${(f.asistencia||'').toUpperCase()==='SI'?'selected':''}>SI</option>
              <option value="NO" ${(f.asistencia||'').toUpperCase()==='NO'?'selected':''}>NO</option>
              <option value="Pendiente" ${(f.asistencia||'')==='Pendiente'?'selected':''}>Pendiente</option>
            </select>
          </td>
          <td><input type="text" value="${f.titulo||''}" placeholder="Nombre del curso..." class="w-full border rounded px-2 py-1" data-f="titulo"></td>
          <td><input type="text" value="${f.aplicacion||''}" placeholder="¬øC√≥mo se aplicar√°? o SI/NO" class="w-full border rounded px-2 py-1" data-f="aplicacion"></td>
        `;
        tr.oninput = e=>{
          const field = e.target.dataset.f; if (!field) return;
          arr[i][field] = e.target.value;
        };
        tb.appendChild(tr);
      });
      makeRowsDraggable(tb, arr, renderFormacion);
    }

    function renderProcesos(){
      const tb = byId('tbodyProcesos'); tb.innerHTML = '';
      const sec = state.sections[state.activeSection];
      if (!sec.requiresCentro) { tb.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">Selecciona "CENTROS EXCLUSIVOS".</td></tr>'; return; }
      ensureCentroData(state.activeCentroId);
      const arr = state.sections.centros_exclusivos.centrosData[state.activeCentroId].procesos;

      arr.forEach((p, i)=>{
        const tr = document.createElement('tr');
        tr.className = `bg-white hover:bg-gray-50 transition`;
        tr.setAttribute('data-searchable', `${p.nombrePaquete} ${p.descripcion} ${p.puntuacion} ${p.observaciones}`);
        tr.innerHTML = `
          <td class="text-center align-top drag-handle"><div class="grabber"></div><div class="grabber"></div><div class="grabber"></div></td>
          <td class="text-center font-bold">${(i+1)}</td>
          <td><input type="text" value="${p.nombrePaquete||''}" placeholder="Nombre del paquete..." class="w-full border rounded px-2 py-1 font-semibold" data-f="nombrePaquete"></td>
          <td><input type="text" value="${p.descripcion||''}" placeholder="Descripci√≥n personalizada..." class="w-full border rounded px-2 py-1" data-f="descripcion"></td>
          <td><input type="text" value="${p.puntuacion||''}" placeholder="Ej: 8/10" class="w-full border rounded px-2 py-1 text-center font-bold" data-f="puntuacion"></td>
          <td><input type="text" value="${p.observaciones||''}" placeholder="Observaciones..." class="w-full border rounded px-2 py-1" data-f="observaciones"></td>
          <td><input type="date" value="${p.fechaVisita||''}" class="w-full border rounded px-2 py-1" data-f="fechaVisita"></td>
          <td class="text-center">
            <button class="btn btn-gray px-2 py-1" data-action="add-file">üìé</button>
            <button class="btn btn-gray px-2 py-1" data-action="add-link">üîó</button>
          </td>
          <td class="text-center"><button class="text-red-600" data-action="del">‚úï</button></td>
        `;
        tr.oninput = e=>{
          const f = e.target.dataset.f; if (!f) return;
          arr[i][f] = e.target.value;
        };
        tr.onclick = e=>{
          const act = e.target.closest('[data-action]')?.dataset.action;
          if (!act) return;
          if (act==='del') { if (arr.length===1) return; arr.splice(i,1); renderProcesos(); }
          if (act==='add-file') {
            const name = prompt('Nombre del archivo (solo referencia visual):'); if (!name) return;
            const f = { id: Date.now()+Math.random(), name };
            arr[i].archivos = arr[i].archivos || []; arr[i].archivos.push(f); renderProcesos();
          }
          if (act==='add-link') {
            const url = prompt('URL del enlace:'); if (!url) return;
            const title = prompt('T√≠tulo (opcional):') || url;
            const l = { id: Date.now()+Math.random(), url, title };
            arr[i].enlaces = arr[i].enlaces || []; arr[i].enlaces.push(l); renderProcesos();
          }
        };

        const sub = document.createElement('tr');
        sub.innerHTML = `
          <td colspan="9" class="bg-gray-50">
            <div class="grid grid-cols-2 gap-3 p-3 text-xs">
              <div>
                <div class="font-semibold mb-1">Archivos</div>
                <div id="files-${p.id}">
                  ${ (p.archivos||[]).map(f=>`
                    <div class="flex items-center justify-between bg-white border rounded px-2 py-1 mb-1">
                      <span>üìé ${f.name}</span>
                      <button class="text-red-600" data-remove-file="${f.id}">‚úï</button>
                    </div>
                  `).join('') || '<div class="muted">‚Äî</div>'}
                </div>
              </div>
              <div>
                <div class="font-semibold mb-1">Enlaces</div>
                <div id="links-${p.id}">
                  ${ (p.enlaces||[]).map(l=>`
                    <div class="flex items-center justify-between bg-white border rounded px-2 py-1 mb-1">
                      <a href="${l.url}" target="_blank" class="text-blue-600 hover:text-blue-800 truncate">üîó ${l.title}</a>
                      <button class="text-red-600" data-remove-link="${l.id}">‚úï</button>
                    </div>
                  `).join('') || '<div class="muted">‚Äî</div>'}
                </div>
              </div>
            </div>
          </td>
        `;
        sub.onclick = e=>{
          const rmFile = e.target.dataset.removeFile;
          const rmLink = e.target.dataset.removeLink;
          if (rmFile) { arr[i].archivos = (arr[i].archivos||[]).filter(x=> String(x.id)!==String(rmFile)); renderProcesos(); }
          if (rmLink) { arr[i].enlaces = (arr[i].enlaces||[]).filter(x=> String(x.id)!==String(rmLink)); renderProcesos(); }
        };

        tb.appendChild(tr);
        tb.appendChild(sub);
      });
      makeRowsDraggable(tb, arr, renderProcesos, {rowSpan:2});
    }

    function makeRowsDraggable(tbody, arrayRef, rerender, opts={rowSpan:1}){
      const rows = [...tbody.querySelectorAll('tr')].filter((_,idx)=> opts.rowSpan===2 ? idx%2===0 : true);
      rows.forEach((tr, idx)=>{
        tr.draggable = true;
        tr.ondragstart = (e)=>{ tr.classList.add('opacity-50'); e.dataTransfer.setData('rowIndex', idx); };
        tr.ondragend   = ()=> tr.classList.remove('opacity-50');
        tr.ondragover  = (e)=> e.preventDefault();
        tr.ondrop = (e)=>{
          e.preventDefault();
          const from = +e.dataTransfer.getData('rowIndex');
          const to = rows.indexOf(tr);
          if (from<0 || to<0 || from===to) return;
          const item = arrayRef.splice(from,1)[0];
          arrayRef.splice(to,0,item);
          rerender();
        };
      });
    }

    byId('btnSaveLocal').onclick = ()=>{ saveLocal(); alert('‚úÖ Guardado local.'); };
    byId('btnReset').onclick = ()=>{ if (confirm('¬øRestablecer a valores de ejemplo?')) resetLocal(); };
    byId('btnAddSection').onclick = ()=>{
      const id = 'section_'+Date.now();
      state.sections[id] = { title:'Nueva Secci√≥n', requiresCentro:false, items:[] };
      state.activeSection = id;
      saveLocal(); renderAll();
    };
    byId('toggleCentros').onclick = ()=>{
      state.showCentrosDropdown = !state.showCentrosDropdown;
      saveLocal(); renderCentros();
    };
    byId('btnAddCentro').onclick = ()=>{
      if (state.centros.length>=12) { alert('M√°ximo 12 centros'); return; }
      const nombre = prompt('Nombre del Centro:'); if (!nombre) return;
      const delegado = prompt('Delegado:') || '';
      const audiologo = prompt('Audi√≥logo:') || '';
      const tipo = prompt('Tipo (Franquicia/Sucursal):') || '';
      const newId = nextId(state.centros);
      const color = centroColors[state.centros.length % centroColors.length];
      state.centros.push({ id:newId, nombre:nombre.trim(), delegado, audiologo, tipo, color });
      ensureCentroData(newId);
      state.activeCentroId = newId;
      saveLocal(); renderAll();
    };

    byId('btnAddAccion').onclick = ()=>{
      ensureCentroData(state.activeCentroId);
      const arr = state.sections.centros_exclusivos.centrosData[state.activeCentroId].acciones;
      arr.push({ id: nextId(arr), fecha:'', accion:'', derivacion:0, cita:0, observaciones:'' });
      renderAcciones();
    };
    byId('btnSaveAcciones').onclick = ()=>{ saveLocal(); alert('‚úÖ Acciones guardadas.'); };

    byId('btnSaveFormacion').onclick = ()=>{ saveLocal(); alert('‚úÖ Formaci√≥n guardada.'); };

    byId('btnAddProceso').onclick = ()=>{
      ensureCentroData(state.activeCentroId);
      const arr = state.sections.centros_exclusivos.centrosData[state.activeCentroId].procesos;
      arr.push({ id: nextId(arr), nombrePaquete:'', descripcion:'', puntuacion:'', observaciones:'', fechaVisita:'', archivos:[], enlaces:[] });
      renderProcesos();
    };
    byId('btnSaveProcesos').onclick = ()=>{ saveLocal(); alert('‚úÖ Procesos guardados.'); };

    function renderAll(){
      renderSectionsNav();
      renderCentros();
      renderActiveHeader();
      renderAcciones();
      renderFormacion();
      renderProcesos();
      // Aplicar filtro de b√∫squeda activo (si hay)
      const q = byId('searchInput').value.trim().toLowerCase();
      document.querySelectorAll('[data-searchable]').forEach(el=>{
        const hit = el.dataset.searchable?.toLowerCase().includes(q);
        el.classList.toggle('hidden-important', q && !hit);
      });
    }
    renderAll();
  </script>

  <!-- ========== CLOUD SYNC (SUPABASE) ========== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // 1) Pega tus credenciales:
    const SUPABASE_URL  = "https://TU-PROYECTO.supabase.co"; // <-- pega tu Project URL
    const SUPABASE_ANON = "TU-ANON-KEY";                      // <-- pega tu anon public key

    // 2) Config de sincronizaci√≥n
    const WORKSPACE_ID = "AUDIOLOGIA"; // separa espacios si quieres
    const SECRET_PIN   = "AR4321";     // no se pide ni se muestra

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    async function cloudSave(){
      try {
        const raw = localStorage.getItem(LS_KEY);
        const payload = raw ? JSON.parse(raw) : null;
        if (!payload) { alert("No hay datos locales para guardar."); return; }

        const { error } = await sb.from('states').upsert({
          id: WORKSPACE_ID,
          payload,
          pin: SECRET_PIN
        });
        if (error) throw error;
        alert("‚úÖ Guardado en la nube.");
      } catch (e) {
        console.error(e);
        alert("‚ùå Error guardando en la nube.");
      }
    }

    async function cloudLoad(){
      try {
        const { data, error } = await sb
          .from('states')
          .select('payload, updated_at')
          .eq('id', WORKSPACE_ID)
          .limit(1)
          .maybeSingle();
        if (error) throw error;
        if (!data) { alert("No hay backup en la nube para este espacio."); return; }
        // Cargar al estado y re-renderizar sin recargar la p√°gina
        state = data.payload;
        saveLocal();
        renderAll();
        alert("‚úÖ Cargado desde la nube.");
      } catch (e) {
        console.error(e);
        alert("‚ùå Error cargando desde la nube.");
      }
    }

    document.getElementById('btnCloudSave').onclick = cloudSave;
    document.getElementById('btnCloudLoad').onclick = cloudLoad;
  </script>
  <!-- ========== / CLOUD SYNC ========== -->

</body>
</html>
