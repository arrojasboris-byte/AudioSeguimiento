<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SEGUIMIENTO AUDIO ¬∑ Cloud</title>
<meta name="theme-color" content="#c82727"/>

<style>
:root{
  --rojo:#c82727; --rojo2:#a71f1f;
  --bg:#f6f7fb; --line:#e6e7ee; --shadow:0 4px 14px rgba(0,0,0,.06);
  --col-ex:#fde2e4; --col-fl:#e2f0cb; --col-az:#cde7f0; --col-ta:#eadcf8; --col-eq:#e8f1ff; --col-am:#fff4cc;
  --fs:11.5px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;font-size:var(--fs);color:#222;line-height:1.18}

/* Topbar rojo ancho */
.topbar{position:sticky;top:0;z-index:999;width:100%;
  background:linear-gradient(180deg,var(--rojo),var(--rojo2));color:#fff;box-shadow:var(--shadow)}
.topbar .row{display:grid;grid-template-columns:1fr auto 1fr;gap:.5rem;align-items:center;padding:.65rem .85rem}
.topbar h1{margin:0;font-size:22px;letter-spacing:.3px;display:flex;gap:.5rem;align-items:center}
.topbar h1 .brand{font-weight:900}
.btn{border:1px solid #0001;background:#fff;border-radius:999px;padding:.28rem .6rem;font-weight:700;cursor:pointer}
.btn.primary{background:#fff;color:#c22727;border-color:#fff}
.btn.ghost{background:#ffffff10;color:#fff;border-color:#ffffff50}
.badge{background:#ffe7e7;border:1px solid #ffd9d9;padding:.12rem .5rem;border-radius:999px}
.pill{border:1px solid #0002;background:#fff;border-radius:999px;padding:.18rem .5rem}
.small{font-size:.92em}
.right{justify-self:end}

/* Layout */
.layout{display:grid;grid-template-columns:240px 1fr;gap:10px;padding:10px;max-width:1400px;margin:0 auto}
.side{display:flex;flex-direction:column;gap:10px}
.side-card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow)}
.side-head{display:flex;justify-content:space-between;align-items:center;padding:.55rem .6rem;border-bottom:1px solid var(--line);font-weight:800}
.side-list{padding:.5rem .6rem;display:flex;flex-direction:column;gap:.45rem}
.side-btn{border:1px solid #0001;background:#fff;border-radius:8px;padding:.1rem .4rem;font-weight:800;cursor:pointer}

.main{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);min-height:70vh}
.main-head{display:flex;justify-content:space-between;align-items:center;padding:.6rem .8rem;border-bottom:1px solid var(--line)}
.main-body{padding:.6rem .8rem}

/* Tabla base */
.table{width:100%;border-collapse:separate;border-spacing:0;min-width:820px}
.table th,.table td{border:1px solid var(--line);padding:.35rem .4rem;vertical-align:middle}
.table th{background:#fafbff;text-align:left;position:sticky;top:0;z-index:1}
.table tfoot td{font-weight:800;background:#fcfcff}
.table input[type="text"], .table input[type="number"], .table input[type="date"], .table select{
  width:100%;border:1px solid var(--line);padding:.22rem .32rem;border-radius:6px;background:#fff;font-size:inherit
}

/* Contenedores scroll */
.table-wrap{overflow:auto;max-height:66vh}
.row{display:flex;gap:.4rem;align-items:center;flex-wrap:wrap}
.col{display:flex;flex-direction:column;gap:.35rem}

/* Indicadores */
.kpi{display:flex;gap:.5rem;align-items:center}
.kpi .dot{width:.65rem;height:.65rem;border-radius:999px;background:#eee;border:1px solid #0002}
.kpi.green .dot{background:#c7f7d3;border-color:#96ddab}
.kpi.orange .dot{background:#ffe6c5;border-color:#ffcf91}

/* Colores CV */
.cv-good{color:#1b5e20}
.cv-bad{color:#c62828}

/* Puntuaci√≥n procesos */
.score-ok{background:#e7f8ec}
.score-warn{background:#fff2e0}
.score-bad{background:#ffe8e8}
.pct-ok{background:#e7f8ec}
.pct-bad{background:#ffe8e8}

/* HIT */
.hitbox{display:flex;justify-content:center;align-items:center;border-radius:6px;padding:.05rem .1rem;border:1px solid #0002}
.hit-off{background:#ffe8e8}
.hit-on{background:#e7f8ec}

/* Modal PIN */
#pinModal{position:fixed;inset:0;background:rgba(0,0,0,.67);display:flex;align-items:center;justify-content:center;z-index:9999}
.pin-card{background:#111;color:#fff;border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.5);width:min(92vw,420px);padding:1.2rem}
.pin-card h3{margin:.2rem 0 1rem}
.pin-row{display:flex;gap:.45rem;align-items:center}
.pin-row input{flex:1;border-radius:8px;border:1px solid #333;background:#000;color:#fff;padding:.5rem .6rem;letter-spacing:.35rem}
.pin-actions{display:flex;gap:.5rem;margin-top:.8rem}
.topbar.dedup-hide{display:none}

/* Chips/tags */
.tag{display:inline-flex;gap:.35rem;align-items:center;background:#f5f6ff;border:1px solid #e5e6f8;padding:.12rem .45rem;border-radius:999px}

/* Ayudas */
.note{opacity:.7}
</style>
</head>
<body>

<!-- ===== TOPBAR ===== -->
<div class="topbar" id="appTop">
  <div class="row">
    <div class="left">
      <button class="btn ghost small" id="btnRefresh" title="Recargar">Actualizar</button>
      <button class="btn ghost small" id="btnSaveLocal" title="Guardar en este navegador">Guardar (local)</button>
      <button class="btn primary small" id="btnSaveCloud" title="Guardar en la nube (Apps Script)">Guardar (nube)</button>
    </div>
    <h1><span>üéß</span><span class="brand">SEGUIMIENTO AUDIO</span></h1>
    <div class="right">
      <span class="badge small" id="statusTag">Local ¬∑ listo</span>
    </div>
  </div>
</div>

<!-- ===== LAYOUT ===== -->
<div class="layout">
  <!-- SIDEBAR -->
  <aside class="side">

    <!-- CIFRA DE VENTAS -->
    <div class="side-card" style="background:var(--col-ex)">
      <div class="side-head">
        <div>üßæ CIFRA DE VENTAS</div>
        <div><button class="side-btn" data-open="cv">‚ñ∏</button></div>
      </div>
      <div class="side-list" style="gap:.55rem">
        <div class="row"><strong>Compa√±√≠a</strong><button class="btn pill" id="cvOpenComp">Abrir</button></div>
        <hr style="border:none;border-top:1px solid #0001">
        <div class="row" style="justify-content:space-between;align-items:center">
          <strong>Centros exclusivos</strong><button class="btn pill" id="cvAddEx">Ôºã</button>
        </div>
        <select id="cvSelEx"><option value="">‚Äî Selecciona un centro ‚Äî</option></select>
        <div id="cvListEx"></div>
      </div>
    </div>

    <!-- CENTROS EXCLUSIVOS -->
    <div class="side-card" style="background:var(--col-ex)">
      <div class="side-head"><div>üè¨ CENTROS EXCLUSIVOS</div><div><button class="side-btn" data-open="ex">‚ñ∏</button></div></div>
      <div class="side-list">
        <div class="row"><button class="btn pill small" id="exAdd">Ôºã A√±adir</button><input id="exSearch" placeholder="Buscar..."/></div>
        <div id="exList"></div>
      </div>
    </div>

    <!-- CENTROS FLOP -->
    <div class="side-card" style="background:var(--col-fl)">
      <div class="side-head"><div>üè∑Ô∏è CENTROS FLOP</div><div><button class="side-btn" data-open="flop">‚ñ∏</button></div></div>
      <div class="side-list">
        <div class="row"><button class="btn pill small" id="flopAdd">Ôºã A√±adir</button><input id="flopSearch" placeholder="Buscar..."/></div>
        <div id="flopList"></div>
      </div>
    </div>

    <!-- VISITAS AUDIO -->
    <div class="side-card" style="background:var(--col-az)">
      <div class="side-head"><div>üìã VISITAS AUDIO</div><div><button class="side-btn" data-open="va">‚ñ∏</button></div></div>
      <div class="side-list"><div class="small note">Hasta 250 filas, se puede pegar desde Excel.</div></div>
    </div>

    <!-- FORMACIONES Y MENTORING -->
    <div class="side-card" style="background:var(--col-am)">
      <div class="side-head"><div>üéì FORMACIONES Y MENTORING</div><div><button class="side-btn" data-open="fm">‚ñ∏</button></div></div>
      <div class="side-list">
        <button class="btn pill" data-fm="mentoring">Mentoring</button>
        <button class="btn pill" data-fm="coaching">Coaching</button>
        <button class="btn pill" data-fm="generales">Generales</button>
      </div>
    </div>

    <!-- TELEAUDIOLOG√çA -->
    <div class="side-card" style="background:var(--col-ta)">
      <div class="side-head"><div>üñ•Ô∏è TELEAUDIOLOG√çA</div><div><button class="side-btn" data-open="ta">‚ñ∏</button></div></div>
      <div class="side-list"><div class="kpi green"><div class="dot"></div> Certificados</div><div class="kpi orange"><div class="dot"></div> Formaciones</div></div>
    </div>

    <!-- EQUIPOS -->
    <div class="side-card" style="background:var(--col-eq)">
      <div class="side-head"><div>üß∞ EQUIPOS</div><div><button class="side-btn" data-open="eq">‚ñ∏</button></div></div>
      <div class="side-list"><div class="small">7 packs, buscador y ‚ÄúÔºã‚Äù por pack.</div></div>
    </div>

  </aside>

  <!-- MAIN -->
  <section class="main">
    <div class="main-head">
      <div class="row"><strong id="detTag">Detalle</strong></div>
      <div class="row small" id="cvHeaderMeta" style="display:none;gap:.35rem"><span class="tag">CIFRA</span></div>
    </div>
    <div class="main-body" id="detBody"><div class="small note">Selecciona una opci√≥n a la izquierda.</div></div>
  </section>
</div>

<!-- PIN -->
<div id="pinModal" aria-modal="true" role="dialog">
  <div class="pin-card">
    <h3>Acceso</h3>
    <div class="small" style="opacity:.9">Introduce el PIN para editar:</div>
    <div class="pin-row" style="margin-top:.45rem"><input id="pin" type="password" maxlength="4" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
    <div class="pin-actions"><button class="btn primary" id="enter">Acceder</button><button class="btn" id="clear">Limpiar</button></div>
    <div id="pinMsg" class="small" style="color:#ffb3b3;margin-top:.4rem;display:none">PIN incorrecto</div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const GAS_URL = 'PEGAR_AQUI_TU_URL_EXEC'; // ‚Üê Pega aqu√≠ tu /exec de Apps Script
const PIN_CODE = '4321';

/* ===== ESTADO Y DATOS ===== */
const state = { panel:null, cvTarget:null, fmMode:'mentoring' };
let data = window.data || {};
data.cv ||= {compania:[], exclusivos:[], flop:[]};
data.ex ||= []; data.flop ||= [];
data.va ||= { rol:'Delegado de Audio', visitador:'', rows:[] };
data.fm ||= { mentoring:[], coaching:[], generales:[] };
data.ta ||= { rows:[] };
data.eq ||= { packs: Array.from({length:7},()=>({rows:[]})) };

/* ===== UTILS ===== */
const $ = (s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
function toast(msg){const t=document.createElement('div'); t.textContent=msg;
  Object.assign(t.style,{position:'fixed',bottom:'10px',left:'50%',transform:'translateX(-50%)',background:'#111',color:'#fff',padding:'6px 9px',borderRadius:'8px',zIndex:9999,fontSize:'11px',opacity:.96});
  document.body.appendChild(t); setTimeout(()=>t.remove(),1200);
}

/* ===== PIN ===== */
function checkPin(v){ return v===PIN_CODE; }
function handleEnter(){
  $('#pinMsg').style.display='none';
  if(!checkPin($('#pin').value)){ $('#pinMsg').style.display='block'; return; }
  $('#pinModal').style.display='none';
}
$('#enter').onclick=handleEnter;
$('#clear').onclick=()=>$('#pin').value='';
$('#pin').addEventListener('keydown',e=>{ if(e.key==='Enter') handleEnter(); });

/* ===== NAV ===== */
function openPanel(id){
  state.panel = id;
  $('#detBody').innerHTML = '';
  $('#cvHeaderMeta').style.display = (id==='cv') ? 'flex' : 'none';
  if(id==='cv') drawCvLanding();
  if(id==='ex') drawCentrosPanel('ex');
  if(id==='flop') drawCentrosPanel('flop');
  if(id==='va') drawVisitas();
  if(id==='fm') drawFormaciones();
  if(id==='ta') drawTeleaudiologia();
  if(id==='eq') drawEquipos();
}

/* ===== CIFRA ‚Äì MESES ===== */
const CV_MESES=['Ago-25','Sep-25','Oct-25','Nov-25','Dic-25','Ene-26','Feb-26','Mar-26','Abr-26','May-26','Jun-26','Jul-26'];
const blankCvMeses=()=>CV_MESES.map(m=>({mes:m,previsto:'',mescv:'',dif:0}));
function ensureCvCentro(o){o.meta||={};o.meta.nombre??='';o.meta.delegado??='';o.meta.tipo??='Sucursal';o.meta.audiologo??='';o.meses||=blankCvMeses();return o;}

/* ===== CIFRA ‚Äì SIDEBAR ===== */
function renderCvSidebar(){
  const sel=$('#cvSelEx'); if(!sel) return;
  sel.innerHTML='<option value="">‚Äî Selecciona un centro ‚Äî</option>';
  data.cv.exclusivos.forEach((c,i)=> sel.innerHTML+=`<option value="${i}">${esc(c.meta?.nombre||('Centro '+(i+1)))}</option>`);
  const list=$('#cvListEx');
  if(list) list.innerHTML = data.cv.exclusivos.map((c,i)=>`
    <div class="row" style="justify-content:space-between">
      <span>${esc(c.meta?.nombre||('Centro '+(i+1)))}</span>
      <button class="btn pill small" data-cvex="${i}">Abrir</button>
    </div>`).join('');
}
$('#cvAddEx')?.addEventListener('click',()=>{
  const n=prompt('Nombre del centro exclusivo:',''); if(n===null) return;
  data.cv.exclusivos.push(ensureCvCentro({meta:{nombre:n,delegado:'',tipo:'Sucursal',audiologo:''}}));
  renderCvSidebar(); $('#cvSelEx').value=String(data.cv.exclusivos.length-1);
  openCvCentro('ex', data.cv.exclusivos.length-1);
});
$('#cvSelEx')?.addEventListener('change',e=>{
  const i=e.target.value===''?null:Number(e.target.value); if(i==null) return; openCvCentro('ex', i);
});
$('#cvListEx')?.addEventListener('click',e=>{
  const i=e.target?.dataset?.cvex; if(i!=null) openCvCentro('ex', Number(i));
});
$('#cvOpenComp')?.addEventListener('click', ()=> openCvCompania());

/* ===== CIFRA ‚Äì LANDING/TABLAS ===== */
function drawCvLanding(){
  $('#detTag').textContent='CIFRA DE VENTAS';
  $('#detBody').innerHTML=
    `<div class="col" style="gap:.6rem">
       <div class="row" style="gap:.6rem">
         <button class="btn pill" id="goComp">Abrir Compa√±√≠a</button>
         <button class="btn pill" id="goFirstEx">Abrir primer Centro exclusivo</button>
       </div>
       <div class="note small">Usa la izquierda para crear/abrir centros exclusivos.</div>
     </div>`;
  $('#goComp').onclick=openCvCompania;
  $('#goFirstEx').onclick=()=>{ if(data.cv.exclusivos.length) openCvCentro('ex',0); else toast('A√±ade un centro en la izquierda'); };
}
function openCvCompania(){ openPanel('cv'); state.cvTarget={kind:'compania'}; $('#detTag').textContent='CIFRA ‚Äî COMPA√ë√çA'; drawCvTable(null, data.cv.compania); }
function openCvCentro(kind,index){
  openPanel('cv');
  const arr=(kind==='ex')?data.cv.exclusivos:data.cv.flop;
  ensureCvCentro(arr[index]); state.cvTarget={kind,index};
  const m=arr[index].meta; $('#detTag').textContent=(kind==='ex'?'CIFRA ‚Äî CENTRO EXCLUSIVO':'CIFRA ‚Äî CENTRO FLOP')+' ¬∑ '+(m.nombre||('Centro '+(index+1)));
  drawCvTable(arr[index], arr[index].meses, m);
}
function drawCvTable(centro, mesesArr, meta){
  mesesArr ||= blankCvMeses();
  const metaHtml = centro ? `
    <div class="row" style="flex-wrap:wrap;margin-bottom:.4rem">
      <input id="cvMetaNombre"  class="pill" value="${esc(meta?.nombre||'')}"   placeholder="Nombre del centro"/>
      <input id="cvMetaDelegado"class="pill" value="${esc(meta?.delegado||'')}" placeholder="Delegado"/>
      <select id="cvMetaTipo" class="pill">
        <option ${meta?.tipo==='Sucursal'?'selected':''}>Sucursal</option>
        <option ${meta?.tipo==='Franquicia'?'selected':''}>Franquicia</option>
        <option ${meta?.tipo==='Propio'?'selected':''}>Propio</option>
      </select>
      <input id="cvMetaAudiologo"class="pill" value="${esc(meta?.audiologo||'')}" placeholder="Audi√≥logo"/>
    </div>` : '';

  $('#detBody').innerHTML =
    metaHtml +
    `<div class="table-wrap">
      <table class="table" id="cvTable">
        <thead><tr><th>Mes</th><th>Previsto</th><th>CV mes</th><th>Dif.</th></tr></thead>
        <tbody>
          ${mesesArr.map((r,i)=>`
            <tr>
              <td>${esc(r.mes)}</td>
              <td><input type="number" step="any" value="${esc(r.previsto)}" data-cv="prev" data-i="${i}"/></td>
              <td><input type="number" step="any" value="${esc(r.mescv)}" data-cv="mes"  data-i="${i}"/></td>
              <td id="cv-dif-${i}">0</td>
            </tr>`).join('')}
        </tbody>
        <tfoot><tr><td>Total</td><td id="cv-t-prev">0</td><td id="cv-t-mes">0</td><td id="cv-t-dif">0</td></tr></tfoot>
      </table>
    </div>`;

  if(centro){
    $('#cvMetaNombre').oninput   = e=>{ centro.meta.nombre   = e.target.value; renderCvSidebar(); };
    $('#cvMetaDelegado').oninput = e=>{ centro.meta.delegado = e.target.value; };
    $('#cvMetaTipo').oninput     = e=>{ centro.meta.tipo     = e.target.value; };
    $('#cvMetaAudiologo').oninput= e=>{ centro.meta.audiologo= e.target.value; };
  }
  $('#cvTable').addEventListener('input',e=>{
    const i=+e.target.dataset.i; if(Number.isNaN(i)) return;
    const k=e.target.dataset.cv; if(k==='prev') mesesArr[i].previsto=e.target.value; if(k==='mes') mesesArr[i].mescv=e.target.value;
    updateCvTotals(mesesArr);
  });
  updateCvTotals(mesesArr);
}
function updateCvTotals(mesesArr){
  let tP=0,tM=0,tD=0;
  mesesArr.forEach((r,i)=>{
    const p=Number(r.previsto||0), m=Number(r.mescv||0), d=m-p;
    tP+=p; tM+=m; tD+=d;
    const cell=$('#cv-dif-'+i); if(cell){ cell.textContent=d.toFixed(2); cell.className=(m<p)?'cv-bad':'cv-good'; }
  });
  $('#cv-t-prev').textContent=tP.toFixed(2);
  $('#cv-t-mes').textContent=tM.toFixed(2);
  $('#cv-t-dif').textContent=tD.toFixed(2);
}

/* ===== CENTROS EXCLUSIVOS / FLOP ===== */
function drawCentrosPanel(kind){
  $('#detTag').textContent=(kind==='ex'?'CENTROS EXCLUSIVOS':'CENTROS FLOP');
  const store = (kind==='ex')? data.ex : data.flop;
  $('#detBody').innerHTML =
    `<div class="col" style="gap:.6rem">
      <div class="row"><button class="btn pill small" id="${kind}AddRow">Ôºã A√±adir centro</button><input id="${kind}Search" placeholder="Buscar centro, delegado, audi√≥logo..."></div>
      <div class="table-wrap"><table class="table" id="${kind}Tbl"><thead>
        <tr><th>Nombre</th><th>Delegado</th><th>Audi√≥logo</th><th>Sucursal/Franquicia</th></tr>
      </thead><tbody></tbody></table></div>
      <hr/>
      <div class="row" style="gap:.6rem;flex-wrap:wrap">
        <button class="btn pill" data-sub="acc">Acciones</button>
        <button class="btn pill" data-sub="form">Formaciones y mentoring</button>
        <button class="btn pill" data-sub="proc">Procesos</button>
      </div>
      <div id="${kind}Sub" class="col"></div>
    </div>`;

  const search = $('#'+kind+'Search');
  const tbody  = $('#'+kind+'Tbl tbody');
  function render(){
    const q=(search.value||'').toLowerCase();
    tbody.innerHTML = store
      .filter(r=>!q || [r.nombre,r.delegado,r.audiologo,r.tipo].join(' ').toLowerCase().includes(q))
      .map((r,i)=>`
        <tr>
          <td><input value="${esc(r?.nombre||'')}" data-i="${i}" data-k="nombre"></td>
          <td><input value="${esc(r?.delegado||'')}" data-i="${i}" data-k="delegado"></td>
          <td><input value="${esc(r?.audiologo||'')}" data-i="${i}" data-k="audiologo"></td>
          <td>
            <select data-i="${i}" data-k="tipo">
              <option ${r?.tipo==='Sucursal'?'selected':''}>Sucursal</option>
              <option ${r?.tipo==='Franquicia'?'selected':''}>Franquicia</option>
              <option ${r?.tipo==='Propio'?'selected':''}>Propio</option>
            </select>
          </td>
        </tr>`).join('');
  }
  $('#'+kind+'AddRow').onclick=()=>{ store.push({nombre:'',delegado:'',audiologo:'',tipo:'Sucursal'}); render(); };
  search.oninput=render;
  tbody.addEventListener('input',e=>{
    const i=+e.target.dataset.i, k=e.target.dataset.k; if(Number.isNaN(i)||!k) return;
    store[i] ||= {}; store[i][k] = (e.target.type==='checkbox')? e.target.checked : e.target.value;
  });
  render();

  const sub = $('#'+kind+'Sub');
  $('[data-sub="acc"]').onclick = ()=> subAcciones(sub);
  $('[data-sub="form"]').onclick= ()=> subForm(sub);
  $('[data-sub="proc"]').onclick= ()=> subProc(sub);
}
function subAcciones(root){
  root.innerHTML =
   `<div class="table-wrap"><table class="table" id="tbAcc">
      <thead><tr><th>Fecha</th><th>Tipo de acci√≥n</th><th>Derivaciones</th><th>Citas</th><th>Ventas</th><th>Observaciones</th></tr></thead>
      <tbody></tbody></table></div>
    <button class="btn pill" id="accAdd">Ôºã A√±adir</button>`;
  const get=()=> (data.cxAcc ||= []);
  const render=()=> $('#tbAcc tbody').innerHTML = get().map((r,i)=>`
    <tr>
      <td><input type="date" value="${esc(r.fecha||'')}" data-i="${i}" data-k="fecha"></td>
      <td>
        <select data-i="${i}" data-k="accion">
          ${['azafata','buzoneo','mailing','ruleta','stand','cashback','otros'].map(x=>`<option ${r.accion===x?'selected':''}>${x}</option>`).join('')}
        </select>
      </td>
      <td><input type="number" value="${esc(r.der||'')}"   data-i="${i}" data-k="der"></td>
      <td><input type="number" value="${esc(r.cita||'')}"  data-i="${i}" data-k="cita"></td>
      <td><input type="number" value="${esc(r.venta||'')}" data-i="${i}" data-k="venta"></td>
      <td><input type="text"   value="${esc(r.obs||'')}"   data-i="${i}" data-k="obs"></td>
    </tr>`).join('');
  $('#accAdd').onclick=()=>{ get().push({}); render(); };
  $('#tbAcc').addEventListener('input',e=>{const i=+e.target.dataset.i,k=e.target.dataset.k; if(Number.isNaN(i))return; get()[i][k]=(e.target.type==='checkbox')?e.target.checked:e.target.value;});
  render();
}
function subForm(root){
  root.innerHTML =
   `<div class="table-wrap"><table class="table" id="tbForm">
      <thead><tr><th>Fecha</th><th>Tema</th><th>Asistencia</th><th>Aplicado</th><th>Observaciones</th></tr></thead>
      <tbody></tbody></table></div>
    <button class="btn pill" id="formAdd">Ôºã A√±adir</button>`;
  const get=()=> (data.cxForm ||= []);
  const render=()=> $('#tbForm tbody').innerHTML = get().map((r,i)=>`
    <tr>
      <td><input type="date" value="${esc(r.fecha||'')}" data-i="${i}" data-k="fecha"></td>
      <td><input type="text"  value="${esc(r.tema||'')}"  data-i="${i}" data-k="tema"></td>
      <td style="text-align:center"><input type="checkbox" ${r.asis?'checked':''} data-i="${i}" data-k="asis"></td>
      <td style="text-align:center"><input type="checkbox" ${r.apli?'checked':''} data-i="${i}" data-k="apli"></td>
      <td><input type="text"  value="${esc(r.obs||'')}"   data-i="${i}" data-k="obs"></td>
    </tr>`).join('');
  $('#formAdd').onclick=()=>{ get().push({}); render(); };
  $('#tbForm').addEventListener('input',e=>{const i=+e.target.dataset.i,k=e.target.dataset.k; const t=get()[i]; t[k]=(e.target.type==='checkbox')?e.target.checked:e.target.value;});
  render();
}
function colorPunt(v){const n=Number(v||0); if(n>=95) return 'score-ok'; if(n>=85) return 'score-warn'; return 'score-bad';}
function colorPct(v){return Number(v||0)>=80 ? 'pct-ok' : 'pct-bad';}
function subProc(root){
  root.innerHTML =
   `<div class="table-wrap"><table class="table" id="tbProc">
      <thead><tr>
        <th>Fecha visita</th><th>Puntuaci√≥n %</th><th>% Pruebas</th><th>% Ventas</th>
        <th>Deriv. √≥ptica</th><th>Observaciones</th><th>Excel (enlace)</th>
      </tr></thead><tbody></tbody></table></div>
    <button class="btn pill" id="procAdd">Ôºã A√±adir</button>`;
  const get=()=> (data.cxProc ||= []);
  function render(){
    $('#tbProc tbody').innerHTML = get().map((r,i)=>`
      <tr>
        <td><input type="date" value="${esc(r.fecha||'')}" data-i="${i}" data-k="fecha"></td>
        <td class="${colorPunt(r.punt)}"><input type="number" value="${esc(r.punt||'')}" data-i="${i}" data-k="punt"></td>
        <td class="${colorPct (r.prue)}"><input type="number" value="${esc(r.prue||'')}" data-i="${i}" data-k="prue"></td>
        <td class="${colorPct (r.vent)}"><input type="number" value="${esc(r.vent||'')}" data-i="${i}" data-k="vent"></td>
        <td style="text-align:center"><input type="checkbox" ${r.optica?'checked':''} data-i="${i}" data-k="optica"></td>
        <td><input type="text" value="${esc(r.obs||'')}" data-i="${i}" data-k="obs"></td>
        <td><input type="text" value="${esc(r.xlsx||'')}" data-i="${i}" data-k="xlsx" placeholder="https://‚Ä¶"></td>
      </tr>`).join('');
  }
  $('#procAdd').onclick=()=>{ get().push({}); render(); };
  $('#tbProc').addEventListener('input',e=>{
    const i=+e.target.dataset.i,k=e.target.dataset.k; const t=get()[i];
    t[k]=(e.target.type==='checkbox')?e.target.checked:e.target.value; render(); // repintar para recolores
  });
  render();
}

/* ===== VISITAS AUDIO ===== */
function drawVisitas(){
  $('#detTag').textContent='VISITAS AUDIO';
  const rows=data.va.rows ||= Array.from({length:250},()=>({}));
  $('#detBody').innerHTML =
    `<div class="col" style="gap:.6rem">
      <div class="row" style="gap:.6rem">
        <label class="pill">Visitador
          <select id="vaRol">
            <option ${data.va.rol==='Delegado de Audio'?'selected':''}>Delegado de Audio</option>
            <option ${data.va.rol==='Responsable Tec. Audio'?'selected':''}>Responsable Tec. Audio</option>
          </select>
        </label>
        <input id="vaVisitador" class="pill" placeholder="Nombre del visitador" value="${esc(data.va.visitador||'')}">
        <input id="vaFilter" class="pill" placeholder="Buscar centro, delegado‚Ä¶">
      </div>
      <div class="table-wrap"><table class="table" id="tbVa">
        <thead><tr>
          <th>#</th><th>Fecha</th><th>Centro</th><th>Franquicia/Sucursal</th><th>Delegado</th>
          <th>% Pruebas</th><th>% Ventas</th><th>HIT</th><th>Pruebas RT</th><th>Primeros aux.</th><th>Excel</th>
        </tr></thead><tbody></tbody></table></div>
      <button class="btn pill" id="vaAdd">Ôºã A√±adir fila</button>
    </div>`;
  function render(){
    const q=($('#vaFilter').value||'').toLowerCase();
    $('#tbVa tbody').innerHTML = rows
      .map((r,i)=>({r,i}))
      .filter(o=>!q || [o.r.centro,o.r.delegado,o.r.tipo].join(' ').toLowerCase().includes(q))
      .map(o=>`
        <tr>
          <td>${o.i+1}</td>
          <td><input type="date" value="${esc(o.r.fecha||'')}" data-i="${o.i}" data-k="fecha"></td>
          <td><input type="text"  value="${esc(o.r.centro||'')}" data-i="${o.i}" data-k="centro"></td>
          <td>
            <select data-i="${o.i}" data-k="tipo">
              <option ${o.r.tipo==='Sucursal'?'selected':''}>Sucursal</option>
              <option ${o.r.tipo==='Franquicia'?'selected':''}>Franquicia</option>
            </select>
          </td>
          <td><input type="text"  value="${esc(o.r.delegado||'')}" data-i="${o.i}" data-k="delegado"></td>
          <td class="${colorPct(o.r.pctPrue)}"><input type="number" value="${esc(o.r.pctPrue||'')}" data-i="${o.i}" data-k="pctPrue"></td>
          <td class="${colorPct(o.r.pctVent)}"><input type="number" value="${esc(o.r.pctVent||'')}" data-i="${o.i}" data-k="pctVent"></td>
          <td><div class="hitbox ${o.r.hit?'hit-on':'hit-off'}"><input type="checkbox" ${o.r.hit?'checked':''} data-i="${o.i}" data-k="hit"></div></td>
          <td style="text-align:center"><input type="checkbox" ${o.r.rt?'checked':''} data-i="${o.i}" data-k="rt"></td>
          <td style="text-align:center"><input type="checkbox" ${o.r.pa?'checked':''} data-i="${o.i}" data-k="pa"></td>
          <td><input type="text" value="${esc(o.r.xlsx||'')}" data-i="${o.i}" data-k="xlsx" placeholder="https://‚Ä¶"></td>
        </tr>`).join('');
  }
  $('#tbVa').addEventListener('input',e=>{
    const i=+e.target.dataset.i,k=e.target.dataset.k; if(Number.isNaN(i))return;
    const t=rows[i]; if(e.target.type==='checkbox'){ t[k]=e.target.checked; if(k==='hit') render(); } else t[k]=e.target.value;
  });
  $('#vaAdd').onclick=()=>{ rows.push({}); render(); };
  $('#vaRol').onchange=e=>{ data.va.rol=e.target.value; };
  $('#vaVisitador').oninput=e=>{ data.va.visitador=e.target.value; };
  $('#vaFilter').oninput=render;
  render();
}

/* ===== FORMACIONES Y MENTORING ===== */
function drawFormaciones(){
  $('#detTag').textContent='FORMACIONES Y MENTORING';
  $('#detBody').innerHTML =
   `<div class="row" style="gap:.6rem;margin-bottom:.6rem">
      <button class="btn pill ${state.fmMode==='mentoring'?'primary':''}" data-fm="mentoring">Mentoring</button>
      <button class="btn pill ${state.fmMode==='coaching'?'primary':''}" data-fm="coaching">Coaching</button>
      <button class="btn pill ${state.fmMode==='generales'?'primary':''}" data-fm="generales">Generales</button>
    </div>
    <div class="table-wrap"><table class="table" id="tbFm">
      <thead><tr><th>Fecha</th><th>Centro</th><th>Delegado</th><th>Audi√≥logo</th><th>Tema</th><th>Asisti√≥</th><th>Aplicado</th><th>Observaciones</th></tr></thead>
      <tbody></tbody></table></div>
    <button class="btn pill" id="fmAdd">Ôºã A√±adir</button>`;
  const arr = data.fm[state.fmMode] ||= [];
  function render(){
    $('#tbFm tbody').innerHTML = arr.map((r,i)=>`
      <tr>
        <td><input type="date" value="${esc(r.fecha||'')}" data-i="${i}" data-k="fecha"></td>
        <td><input type="text"  value="${esc(r.centro||'')}" data-i="${i}" data-k="centro"></td>
        <td><input type="text"  value="${esc(r.delegado||'')}" data-i="${i}" data-k="delegado"></td>
        <td><input type="text"  value="${esc(r.audiologo||'')}" data-i="${i}" data-k="audiologo"></td>
        <td><input type="text"  value="${esc(r.tema||'')}" data-i="${i}" data-k="tema"></td>
        <td style="text-align:center"><input type="checkbox" ${r.asis?'checked':''} data-i="${i}" data-k="asis"></td>
        <td style="text-align:center"><input type="checkbox" ${r.apli?'checked':''} data-i="${i}" data-k="apli"></td>
        <td><input type="text"  value="${esc(r.obs||'')}" data-i="${i}" data-k="obs"></td>
      </tr>`).join('');
  }
  $('#tbFm').addEventListener('input',e=>{
    const i=+e.target.dataset.i,k=e.target.dataset.k; const t=arr[i];
    t[k]=(e.target.type==='checkbox')?e.target.checked:e.target.value;
  });
  $('#fmAdd').onclick=()=>{ arr.push({}); render(); };
  $$('[data-fm]').forEach(b=> b.onclick=()=>{ state.fmMode=b.dataset.fm; drawFormaciones(); });
  render();
}

/* ===== TELEAUDIOLOG√çA ===== */
function drawTeleaudiologia(){
  $('#detTag').textContent='TELEAUDIOLOG√çA';
  const arr=data.ta.rows ||= [];
  $('#detBody').innerHTML =
   `<div class="row" style="gap:1rem;margin-bottom:.5rem">
      <div class="kpi green"><div class="dot"></div> <b id="taCert">0</b> cert.</div>
      <div class="kpi orange"><div class="dot"></div> <b id="taForm">0</b> form.</div>
      <input id="taSearch" class="pill" placeholder="Buscar por centro o persona‚Ä¶">
    </div>
    <div class="table-wrap"><table class="table" id="tbTa">
      <thead><tr>
        <th>Centro</th><th>Delegado</th><th>Rol</th><th>Persona</th>
        <th>Form.</th><th>Pr√°c.</th><th>Cert.</th><th>Pruebas</th><th>Ventas</th><th>Observaciones</th>
      </tr></thead><tbody></tbody></table></div>
    <button class="btn pill" id="taAdd">Ôºã A√±adir</button>`;
  function render(){
    const q=($('#taSearch').value||'').toLowerCase();
    $('#tbTa tbody').innerHTML = arr
      .filter(r=>!q || [r.centro,r.persona].join(' ').toLowerCase().includes(q))
      .map((r,i)=>`
        <tr>
          <td><input value="${esc(r.centro||'')}"   data-i="${i}" data-k="centro"></td>
          <td><input value="${esc(r.delegado||'')}" data-i="${i}" data-k="delegado"></td>
          <td>
            <select data-i="${i}" data-k="rol">
              <option ${r.rol!=='T√©cnico'?'selected':''}>Audi√≥logo</option>
              <option ${r.rol==='T√©cnico'?'selected':''}>T√©cnico</option>
            </select>
          </td>
          <td><input value="${esc(r.persona||'')}"  data-i="${i}" data-k="persona" placeholder="Nombre"></td>
          <td style="text-align:center"><input type="checkbox" ${r.form?'checked':''}       data-i="${i}" data-k="form"></td>
          <td style="text-align:center"><input type="checkbox" ${r.pract?'checked':''}      data-i="${i}" data-k="pract"></td>
          <td style="text-align:center"><input type="checkbox" ${r.cert?'checked':''}       data-i="${i}" data-k="cert"></td>
          <td style="text-align:center"><input type="checkbox" ${r.pruebas?'checked':''}    data-i="${i}" data-k="pruebas"></td>
          <td style="text-align:center"><input type="checkbox" ${r.ventas?'checked':''}     data-i="${i}" data-k="ventas"></td>
          <td><input value="${esc(r.obs||'')}"      data-i="${i}" data-k="obs"></td>
        </tr>`).join('');
    $('#taCert').textContent = arr.filter(r=>r.cert).length;
    $('#taForm').textContent = arr.filter(r=>r.form).length;
  }
  $('#tbTa').addEventListener('input',e=>{
    const i=+e.target.dataset.i,k=e.target.dataset.k; const t=arr[i]; if(!t) return;
    t[k]=(e.target.type==='checkbox')?e.target.checked:e.target.value; render();
  });
  $('#taAdd').onclick=()=>{ arr.push({}); render(); };
  $('#taSearch').oninput=render;
  render();
}

/* ===== EQUIPOS ===== */
function drawEquipos(){
  $('#detTag').textContent='EQUIPOS';
  const packs=data.eq.packs ||= Array.from({length:7},()=>({rows:[]}));
  $('#detBody').innerHTML =
    `<div class="row" style="gap:.6rem;margin-bottom:.5rem">
       <input id="eqSearch" class="pill" placeholder="Buscar por equipo, N¬∫ de serie o centro‚Ä¶">
     </div>` +
    packs.map((p,pi)=>`
      <details ${pi<2?'open':''} style="margin-bottom:.6rem">
        <summary class="row" style="gap:.5rem"><strong>Pack ${pi+1}</strong> <button class="btn pill small" data-pack="${pi}">Ôºã</button></summary>
        <div class="table-wrap" style="margin-top:.4rem">
          <table class="table" data-tb="${pi}">
            <thead><tr><th>Equipo</th><th>N¬∫ serie</th><th>Centro</th><th>Persona que env√≠a</th><th>Fecha</th></tr></thead>
            <tbody>${
              (p.rows||[]).map((r,ri)=>`
              <tr>
                <td><input value="${esc(r.eq||'')}"     data-p="${pi}" data-i="${ri}" data-k="eq"></td>
                <td><input value="${esc(r.sn||'')}"     data-p="${pi}" data-i="${ri}" data-k="sn"></td>
                <td><input value="${esc(r.centro||'')}" data-p="${pi}" data-i="${ri}" data-k="centro"></td>
                <td><input value="${esc(r.envia||'')}"  data-p="${pi}" data-i="${ri}" data-k="envia"></td>
                <td><input type="date" value="${esc(r.fecha||'')}" data-p="${pi}" data-i="${ri}" data-k="fecha"></td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </details>`).join('');

  // + por pack
  $('#detBody').addEventListener('click',e=>{
    const p=e.target.dataset.pack; if(p==null) return;
    packs[+p].rows ||=([]); packs[+p].rows.push({}); drawEquipos();
  });
  // edici√≥n
  $('#detBody').addEventListener('input',e=>{
    const p=e.target.dataset.p,i=e.target.dataset.i,k=e.target.dataset.k;
    if(p==null||i==null||!k) return; (packs[+p].rows[+i] ||= {})[k]=e.target.value;
  });
  // buscador
  $('#eqSearch').oninput=(e)=>{
    const q=(e.target.value||'').toLowerCase();
    $$('table[data-tb]').forEach(t=>{
      const pi=+t.dataset.tb; const rows=packs[pi].rows||[];
      t.tBodies[0].innerHTML = rows
        .filter(r=>!q || [r.eq,r.sn,r.centro].join(' ').toLowerCase().includes(q))
        .map((r,ri)=>`
          <tr>
            <td><input value="${esc(r.eq||'')}"     data-p="${pi}" data-i="${ri}" data-k="eq"></td>
            <td><input value="${esc(r.sn||'')}"     data-p="${pi}" data-i="${ri}" data-k="sn"></td>
            <td><input value="${esc(r.centro||'')}" data-p="${pi}" data-i="${ri}" data-k="centro"></td>
            <td><input value="${esc(r.envia||'')}"  data-p="${pi}" data-i="${ri}" data-k="envia"></td>
            <td><input type="date" value="${esc(r.fecha||'')}" data-p="${pi}" data-i="${ri}" data-k="fecha"></td>
          </tr>`).join('');
    });
  };
}

/* ===== GUARDAR / CARGAR ===== */
function saveLocal(){
  try{ localStorage.setItem('audioSeguimientoCloud', JSON.stringify(data)); $('#statusTag').textContent='Local ¬∑ guardado'; toast('Guardado local'); }
  catch(e){ alert('No se pudo guardar en local: '+e.message); }
}
async function saveCloud(){
  if(!/^https:\/\/script\.google/.test(GAS_URL)){ alert('Configura GAS_URL con tu /exec de Apps Script'); return; }
  $('#statusTag').textContent='Nube ¬∑ guardando‚Ä¶';
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'save',data})});
    if(!res.ok) throw new Error('HTTP '+res.status);
    $('#statusTag').textContent='Nube ¬∑ guardado'; toast('Guardado en nube');
  }catch(e){ $('#statusTag').textContent='Error nube'; alert('Error guardando en nube: '+e.message); }
}
async function loadCloud(){
  if(!/^https:\/\/script\.google/.test(GAS_URL)){
    const raw=localStorage.getItem('audioSeguimientoCloud'); if(raw){ try{ data=JSON.parse(raw); }catch{} }
    afterLoad(); return;
  }
  try{
    const res=await fetch(GAS_URL+'?action=load',{cache:'no-store'}); const txt=await res.text();
    let json={}; try{ json=JSON.parse(txt||'{}'); }catch{}
    if(json && typeof json==='object' && Object.keys(json).length) data=json;
  }catch{}
  afterLoad();
}
function afterLoad(){
  // estructuras base
  data.cv ||= {compania:[], exclusivos:[], flop:[]};
  data.ex ||= []; data.flop ||= []; data.va ||= {rol:'Delegado de Audio',visitador:'',rows:[]};
  data.fm ||= {mentoring:[],coaching:[],generales:[]}; data.ta ||= {rows:[]};
  data.eq ||= {packs:Array.from({length:7},()=>({rows:[]}))};
  renderCvSidebar(); openPanel('cv'); // inicio en CV
}

/* ===== TOPBAR ===== */
$('#btnRefresh').onclick = ()=> location.reload();
$('#btnSaveLocal').onclick = saveLocal;
$('#btnSaveCloud').onclick = saveCloud;

/* ===== INICIO ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  // evita duplicaciones si hay SW
  if(window.__SEGUI_AUDIO_INITED__){ $('#appTop')?.classList.add('dedup-hide'); } else { window.__SEGUI_AUDIO_INITED__=true; }
  // side opens
  $$('[data-open]').forEach(b=> b.addEventListener('click',()=> openPanel(b.dataset.open)));
  $$('[data-fm]').forEach(b=> b.addEventListener('click',()=>{ state.fmMode=b.dataset.fm; openPanel('fm'); }));
  renderCvSidebar();
  loadCloud();
});
</script>
</body>
</html>
