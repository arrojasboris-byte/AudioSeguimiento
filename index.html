<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SEGUIMIENTO AUDIO-AR</title>
  <style>
    :root {
      --bg: #f4f4f4;
      --panel: #ffffff;
      --gris: #2f3437;
      --rojo: #b71c1c;
      --negro: #181818;
      --radius-lg: 18px;
      --shadow-sm: 0 3px 10px rgba(0, 0, 0, 0.08);
      --obj: #ffe6e6;
      --cex: #f6f0ff;
      --cflop: #ffe9d6;
      --form: #e7f7ff;
      --vis: #f9fbe7;
      --ok: #0ba048;
      --bad: #d32f2f;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--negro);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: linear-gradient(120deg, #000 0%, #b71c1c 80%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 26px;
      gap: 12px;
    }
    header h1 {
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header h1 span.logo {
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 10px;
      border-radius: 99px;
      font-weight: 700;
    }
    .top-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .btn {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #fff;
      border-radius: 14px;
      padding: 6px 12px;
      font-size: 0.78rem;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      cursor: pointer;
    }
    .btn.secondary {
      background: rgba(0, 0, 0, 0.3);
    }
    .pin-box {
      display: flex;
      gap: 6px;
      align-items: center;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 3px 6px 3px 10px;
    }
    .pin-box input {
      all: unset;
      background: rgba(0, 0, 0, 0.3);
      padding: 3px 6px;
      border-radius: 8px;
      font-size: 0.7rem;
    }
    .status-pill {
      background: rgba(0, 0, 0, 0.2);
      padding: 3px 10px;
      border-radius: 99px;
      font-size: 0.68rem;
    }
    main {
      flex: 1;
      display: flex;
      gap: 10px;
      padding: 12px;
      overflow: hidden;
    }
    .left-panel {
      width: 268px;
      background: var(--panel);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
    }
    .left-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .block-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f3f3f3;
      border: 1px solid transparent;
      border-radius: 14px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.78rem;
    }
    .block-btn .tag {
      width: 28px;
      height: 28px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .block-btn small {
      opacity: 0.5;
      font-size: 0.65rem;
    }
    .block-btn.active {
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #fff;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.03);
    }
    .block-btn[data-type="OBJETIVOS"] { background: var(--obj); }
    .block-btn[data-type="CENTROS EXCLUSIVOS"] { background: var(--cex); }
    .block-btn[data-type="CENTROS FLOP"] { background: var(--cflop); }
    .block-btn[data-type="FORMACIONES Y MENTORING"] { background: var(--form); }
    .block-btn[data-type="VISITAS"] { background: var(--vis); }

    .right-panel {
      flex: 1;
      background: var(--panel);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .right-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    .right-header .title {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .badge-color {
      width: 18px;
      height: 18px;
      border-radius: 6px;
    }
    .content-area {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    .content-wrap {
      position: relative;
    }
    .locked-overlay {
      background: rgba(255, 255, 255, 0.75);
      border: 2px dashed rgba(183, 28, 28, 0.3);
      border-radius: 16px;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: 500;
      color: #b71c1c;
      padding: 10px;
    }
    .content-wrap.locked .locked-overlay {
      display: flex;
      position: absolute;
      inset: 0;
      backdrop-filter: blur(1px);
    }

    .list { display: grid; gap: 10px; }
    .item {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, 0.04);
      border-left: 4px solid rgba(183, 28, 28, 0.6);
      border-radius: 12px;
      padding: 8px 10px 6px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.02);
    }
    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .item-actions { display: flex; gap: 6px; }
    .tiny-btn, .ghost-icon {
      background: rgba(0,0,0,0.04);
      padding: 2px 6px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }
    .ghost-icon { background: rgba(0,0,0,0.02); }
    .disabled { opacity: 0.6; cursor: not-allowed; }

    /* layout centros */
    .flex-split { display: flex; gap: 14px; align-items: stretch; }
    .centers-list {
      width: 240px;
      background: #fff;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.03);
      box-shadow: 0 2px 6px rgba(0,0,0,0.02);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .centers-list-header { display:flex; justify-content:space-between; align-items:center; gap:6px; }
    .center-right { flex: 1; display: flex; }
    .center-content { flex: 1; display: flex; flex-direction: column; gap: 10px; }
    .center-subnav { width: 100%; display: flex; gap: 8px; margin-top: 4px; }
    .center-subnav button {
      background: #000;
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 0.72rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .center-subnav button.active { background: #b71c1c; }

    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
    .field { display: flex; flex-direction: column; gap: 4px; }
    .field label { font-size: 0.7rem; opacity: 0.8; }
    .field input, .field select {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.1);
      padding: 5px 8px;
      font-size: 0.78rem;
      background: #fff;
    }

    /* FECHA con icono */
    .date-wrapper {
      position: relative;
    }
    .date-input {
      width: 100%;
      padding-right: 28px;
    }
    .date-wrapper::after {
      content: "üìÖ";
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      pointer-events: none;
      opacity: 0.6;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      opacity: 0;
      cursor: pointer;
    }

    .table-like {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      font-size: 0.74rem;
    }
    .table-like th, .table-like td {
      border: 1px solid rgba(0,0,0,0.12);
      padding: 4px 6px;
      vertical-align: middle;
    }
    .table-toolbar {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
      align-items: center;
      justify-content: flex-end;
    }

    .yes-cell { background: rgba(11,160,72,0.12); }
    .no-cell { background: rgba(211,47,47,0.12); }
    .text-red { color: #b71c1c; }
    .text-green { color: #0b7a3a; }

    /* columnas visitas */
    .col-centro { width: 220px; }
    .col-suc { width: 100px; }
    .col-obs { min-width: 200px; }

    @media (max-width: 1080px) {
      .flex-split { flex-direction: column; }
      .centers-list { width: 100%; }
    }
    @media (max-width: 960px) {
      main { flex-direction: column; }
      .left-panel { width: 100%; flex-direction: row; overflow-x: auto; }
      .right-panel { height: 60vh; }
    }
  </style>
</head>
<body>
  <header>
    <h1><span class="logo">SEGUIMIENTO</span> AUDIO-AR <small style="opacity:0.6; font-size:0.65rem;">Panel de seguimiento formaci√≥n & ventas</small></h1>
    <div class="top-actions">
      <div class="pin-box">
        <span>üîê PIN:</span>
        <input id="pinInput" type="password" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <button id="pinBtn" class="btn secondary" style="padding:4px 8px;">OK</button>
      </div>
      <button id="saveCloud" class="btn secondary" disabled>‚òÅÔ∏è Guardar en nube</button>
      <button id="loadCloud" class="btn secondary" disabled>üîÑ Actualizar de nube</button>
      <button id="saveLocal" class="btn secondary">üíæ Guardar local</button>
      <div class="status-pill" id="editStatus">Solo lectura</div>
    </div>
  </header>
  <main>
    <aside class="left-panel" id="leftPanel">
      <div class="left-header"><strong>Bloques</strong></div>
      <button class="block-btn active" data-type="OBJETIVOS" data-color="var(--obj)">
        <div class="tag" style="background: rgba(183,28,28,0.2);">üéØ</div>
        <div><div>OBJETIVOS</div><small>KPIs, % logro</small></div>
      </button>
      <button class="block-btn" data-type="CENTROS EXCLUSIVOS" data-color="var(--cex)">
        <div class="tag" style="background: rgba(47,52,55,0.05);">üè¢</div>
        <div><div>CENTROS EXCLUSIVOS</div><small>Seguimiento premium</small></div>
      </button>
      <button class="block-btn" data-type="CENTROS FLOP" data-color="var(--cflop)">
        <div class="tag" style="background: rgba(183,28,28,0.17);">‚ö†Ô∏è</div>
        <div><div>CENTROS FLOP</div><small>Alarmas & plan</small></div>
      </button>
      <button class="block-btn" data-type="FORMACIONES Y MENTORING" data-color="var(--form)">
        <div class="tag" style="background: rgba(24,24,24,0.05);">üìö</div>
        <div><div>FORMACIONES Y MENTORING</div><small>Plan de aulas</small></div>
      </button>
      <button class="block-btn" data-type="VISITAS" data-color="var(--vis)">
        <div class="tag" style="background: rgba(0,0,0,0.04);">üóìÔ∏è</div>
        <div><div>VISITAS</div><small>Agenda & report</small></div>
      </button>
    </aside>
    <section class="right-panel">
      <div class="right-header">
        <div class="title">
          <div class="badge-color" id="badgeColor" style="background: var(--obj);"></div>
          <h2 id="sectionTitle" style="font-size:0.95rem;">OBJETIVOS</h2>
        </div>
        <div>
          <button id="btnHTML" class="btn secondary">‚¨áÔ∏é HTML</button>
          <button id="btnPDF" class="btn secondary">‚¨áÔ∏é PDF</button>
          <button id="btnXLS" class="btn secondary">‚¨áÔ∏é Excel</button>
        </div>
      </div>
      <div class="content-area">
        <div class="content-wrap" id="contentWrap">
          <div class="locked-overlay">üîí Edici√≥n bloqueada. Introduce PIN AR4321.</div>
          <div id="contentHolder"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const PIN_MASTER = "AR4321";
    const pinInput = document.getElementById("pinInput");
    const pinBtn = document.getElementById("pinBtn");
    const editStatus = document.getElementById("editStatus");
    const leftPanel = document.getElementById("leftPanel");
    const contentWrap = document.getElementById("contentWrap");
    const contentHolder = document.getElementById("contentHolder");
    const badgeColor = document.getElementById("badgeColor");
    const sectionTitle = document.getElementById("sectionTitle");
    const saveLocalBtn = document.getElementById("saveLocal");

    let editable = false;

    // ESTADO
    let blocks = JSON.parse(localStorage.getItem("audioar_blocks") || "null") || {
      "OBJETIVOS": {
        color: "var(--obj)",
        items: [
          { titulo: "Ventas Q4", detalle: "Objetivo 140% sobre 2024", fecha: "2025-11-02" }
        ]
      },
      "CENTROS EXCLUSIVOS": {
        color: "var(--cex)",
        selected: 0,
        view: "acciones",
        centers: [
          {
            nombre: "Centro exclusivo 1",
            delegado: "Delegado A",
            audiologo: "Audi 1",
            tipo: "Sucursal",
            acciones: [
              { tipo: "Seguimiento aud√≠fonos", fecha: "2025-11-03", derivaciones: "2", citas: "3", ventas: "1", obs: "Potencial en ORL" }
            ],
            formaciones: [
              { curso: "Teleaudiometr√≠a avanzada", superado: "S√≠", aplicado: "S√≠", mentoring: "No" }
            ],
            visitas: [
              { fecha: "2025-11-02", checklist: "90", convPrueba: "85", convVenta: "80" }
            ]
          }
        ]
      },
      "CENTROS FLOP": {
        color: "var(--cflop)",
        selected: 0,
        view: "acciones",
        centers: [
          {
            nombre: "Centro flop 1",
            delegado: "Delegado B",
            audiologo: "Audi 2",
            tipo: "Franquicia",
            acciones: [
              { tipo: "Alerta baja conversi√≥n", fecha: "2025-11-05", derivaciones: "0", citas: "1", ventas: "0", obs: "Revisar argumentario" }
            ],
            formaciones: [
              { curso: "ACE / Rehabilitaci√≥n", superado: "No", aplicado: "No", mentoring: "S√≠" }
            ],
            visitas: [
              { fecha: "2025-11-05", checklist: "70", convPrueba: "60", convVenta: "50" }
            ]
          }
        ]
      },
      "FORMACIONES Y MENTORING": {
        color: "var(--form)",
        selected: 0,
        delegados: [
          {
            nombre: "Delegado 1",
            tabla: [
              { fecha: "2025-11-04", centros: "Centro 1", sucursal: "Sucursal", tema: "Teleaudiometr√≠a", superado: "S√≠", aplicado: "S√≠", mentoring: "No", obs: "Buena participaci√≥n" }
            ],
            adjunto: ""
          }
        ]
      },
      "VISITAS": {
        color: "var(--vis)",
        selected: 0,
        delegados: [
          {
            nombre: "Delegado 1",
            visitador: "",
            visitas: [
              { fecha: "2025-11-06", centros: "Centro Tetu√°n", sucursal: "Sucursal", audiologo: "", checklist: "82", convPrueba: "75", convVenta: "60", hit: "No", aar: "No", rt: "No", obs: "Reforzar cierre" }
            ],
            adjunto: ""
          }
        ]
      }
    };

    let currentBlock = "OBJETIVOS";

    function persist() {
      localStorage.setItem("audioar_blocks", JSON.stringify(blocks));
    }

    function setEditable(on) {
      editable = on;
      editStatus.textContent = on ? "Edici√≥n activada" : "Solo lectura";
      editStatus.style.background = on ? "rgba(11,160,72,0.12)" : "rgba(0,0,0,0.2)";
      renderCurrentBlock();
    }

    // ============= RENDER OBJETIVOS (con fecha con icono) ============
    function renderObjectives(data) {
      contentHolder.innerHTML = "";
      const list = document.createElement("div");
      list.className = "list";
      data.items.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="item-header">
            <strong>${item.titulo}</strong>
            ${editable ? `
              <div class="item-actions">
                <button class="ghost-icon" data-act="obj-edit" data-idx="${idx}">‚úè</button>
                <button class="ghost-icon" data-act="obj-add" data-idx="${idx}">Ôºã</button>
                <button class="ghost-icon" data-act="obj-del" data-idx="${idx}">‚àí</button>
              </div>` : ``}
          </div>
          <small>${item.detalle}</small>
          <div class="field" style="margin-top:4px; max-width:160px;">
            <label style="font-size:0.65rem;">Fecha</label>
            <div class="date-wrapper">
              <input type="date" class="date-input" data-act="obj-date" data-idx="${idx}" value="${item.fecha||""}" ${editable?"":"disabled"}>
            </div>
          </div>
        `;
        list.appendChild(div);
      });
      if (editable) {
        const btn = document.createElement("button");
        btn.className = "tiny-btn";
        btn.textContent = "+ A√±adir objetivo";
        btn.onclick = () => {
          data.items.push({ titulo: "Nuevo objetivo", detalle: "", fecha: "" });
          persist(); renderCurrentBlock();
        };
        list.appendChild(btn);
      }
      contentHolder.appendChild(list);
    }

    // ============= RENDER CENTROS (EXCLUSIVOS / FLOP) ============
    function renderCentersBlock(blockName, data) {
      contentHolder.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.className = "flex-split";

      // Panel de centros
      const left = document.createElement("div");
      left.className = "centers-list";
      left.innerHTML = `
        <div class="centers-list-header">
          <strong>${blockName === "CENTROS EXCLUSIVOS" ? "Centros exclusivos" : "Centros flop"}</strong>
          ${editable ? `
          <div style="display:flex;gap:4px;">
            <button class="tiny-btn" data-act="center-add">+</button>
            <button class="tiny-btn" data-act="center-del">‚àí</button>
            <button class="tiny-btn" data-act="center-rename">‚úè</button>
            <button class="tiny-btn" data-act="center-save">Guardar</button>
          </div>
          ` : ``}
        </div>
      `;
      const select = document.createElement("select");
      select.dataset.act = "center-select";
      (data.centers || []).forEach((c, idx) => {
        const opt = document.createElement("option");
        opt.value = idx;
        opt.textContent = c.nombre || (blockName === "CENTROS EXCLUSIVOS" ? "Exclusivo " : "Flop ") + (idx + 1);
        if (idx === (data.selected || 0)) opt.selected = true;
        select.appendChild(opt);
      });
      left.appendChild(select);
      wrap.appendChild(left);

      // Detalle a la derecha
      const right = document.createElement("div");
      right.className = "center-right";

      const currentIdx = data.selected || 0;
      const center = data.centers[currentIdx] || { nombre:"", delegado:"", audiologo:"", tipo:"Sucursal", acciones:[], formaciones:[], visitas:[] };
      if (!data.view) data.view = "acciones";

      const cont = document.createElement("div");
      cont.className = "center-content";

      // Datos del centro
      const info = document.createElement("div");
      info.className = "grid-3";
      info.innerHTML = `
        <div class="field"><label>Nombre del centro</label><input ${editable?"":"disabled"} data-field="nombre" value="${center.nombre||""}"></div>
        <div class="field"><label>Delegado</label><input ${editable?"":"disabled"} data-field="delegado" value="${center.delegado||""}"></div>
        <div class="field"><label>Audi√≥logo</label><input ${editable?"":"disabled"} data-field="audiologo" value="${center.audiologo||""}"></div>
        <div class="field"><label>Sucursal / Franquicia</label>
          <select ${editable?"":"disabled"} data-field="tipo">
            <option value="Sucursal" ${center.tipo==="Sucursal"?"selected":""}>Sucursal</option>
            <option value="Franquicia" ${center.tipo==="Franquicia"?"selected":""}>Franquicia</option>
          </select>
        </div>
      `;
      cont.appendChild(info);

      // Subpesta√±as
      const subnav = document.createElement("div");
      subnav.className = "center-subnav";
      [
        {id:"acciones", label:"üìã Acciones"},
        {id:"formaciones", label:"üìö Formaciones y refuerzo"},
        {id:"visitas", label:"üóìÔ∏è Visitas"}
      ].forEach(b=>{
        const btn = document.createElement("button");
        btn.dataset.sub = b.id;
        btn.textContent = b.label;
        if (data.view === b.id) btn.classList.add("active");
        subnav.appendChild(btn);
      });
      cont.appendChild(subnav);

      // Contenido seg√∫n vista
      if (data.view === "acciones") {
        const box = document.createElement("div");
        box.innerHTML = `
          <div class="table-toolbar" style="justify-content:flex-end;">
            <strong style="margin-right:auto;">Acciones</strong>
            ${editable?`<button class="tiny-btn" data-act="center-add-accion">+ Acci√≥n</button>`:""}
          </div>
        `;
        const t = document.createElement("table");
        t.className = "table-like";
        t.innerHTML = `
          <thead>
            <tr>
              <th>Tipo de acci√≥n</th>
              <th>Fecha</th>
              <th>Derivaciones</th>
              <th>Citas</th>
              <th>Ventas</th>
              <th>Observaciones</th>
              ${editable?`<th></th>`:""}
            </tr>
          </thead>
          <tbody>
            ${(center.acciones||[]).map((a,i)=>`
              <tr data-table="acciones" data-row="${i}">
                <td><input ${editable?"":"disabled"} value="${a.tipo||""}" data-centercell="acciones" data-field="tipo" data-idx="${i}" style="width:100%;"></td>
                <td>
                  <div class="date-wrapper">
                    <input type="date" class="date-input" ${editable?"":"disabled"} value="${a.fecha||""}" data-centercell="acciones" data-field="fecha" data-idx="${i}">
                  </div>
                </td>
                <td><input ${editable?"":"disabled"} value="${a.derivaciones||""}" data-centercell="acciones" data-field="derivaciones" data-idx="${i}" style="width:70px;"></td>
                <td><input ${editable?"":"disabled"} value="${a.citas||""}" data-centercell="acciones" data-field="citas" data-idx="${i}" style="width:70px;"></td>
                <td><input ${editable?"":"disabled"} value="${a.ventas||""}" data-centercell="acciones" data-field="ventas" data-idx="${i}" style="width:70px;"></td>
                <td><input ${editable?"":"disabled"} value="${a.obs||""}" data-centercell="acciones" data-field="obs" data-idx="${i}" style="width:100%;"></td>
                ${editable?`<td><button class="ghost-icon" data-act="center-del-row" data-table="acciones" data-idx="${i}">‚àí</button></td>`:""}
              </tr>
            `).join("")}
          </tbody>
        `;
        box.appendChild(t);
        cont.appendChild(box);
      }
      else if (data.view === "formaciones") {
        const box = document.createElement("div");
        box.innerHTML = `
          <div class="table-toolbar" style="justify-content:flex-end;">
            <strong style="margin-right:auto;">Formaciones y refuerzo</strong>
            ${editable?`<button class="tiny-btn" data-act="center-add-forma">+ Formaci√≥n</button>`:""}
          </div>
        `;
        const t = document.createElement("table");
        t.className = "table-like";
        t.innerHTML = `
          <thead>
            <tr>
              <th>Curso relevante</th>
              <th>Superado</th>
              <th>Aplicado</th>
              <th>Mentoring-Coaching</th>
              ${editable?`<th></th>`:""}
            </tr>
          </thead>
          <tbody>
            ${(center.formaciones||[]).map((f,i)=>`
              <tr data-table="formaciones" data-row="${i}">
                <td><input ${editable?"":"disabled"} value="${f.curso||""}" data-centercell="formaciones" data-field="curso" data-idx="${i}" style="width:100%;"></td>
                <td>
                  <select ${editable?"":"disabled"} data-centercell="formaciones" data-field="superado" data-idx="${i}">
                    <option value="S√≠" ${f.superado==="S√≠"?"selected":""}>S√≠</option>
                    <option value="No" ${f.superado!=="S√≠"?"selected":""}>No</option>
                  </select>
                </td>
                <td>
                  <select ${editable?"":"disabled"} data-centercell="formaciones" data-field="aplicado" data-idx="${i}">
                    <option value="S√≠" ${f.aplicado==="S√≠"?"selected":""}>S√≠</option>
                    <option value="No" ${f.aplicado!=="S√≠"?"selected":""}>No</option>
                  </select>
                </td>
                <td>
                  <select ${editable?"":"disabled"} data-centercell="formaciones" data-field="mentoring" data-idx="${i}">
                    <option value="S√≠" ${f.mentoring==="S√≠"?"selected":""}>S√≠</option>
                    <option value="No" ${f.mentoring!=="S√≠"?"selected":""}>No</option>
                  </select>
                </td>
                ${editable?`<td><button class="ghost-icon" data-act="center-del-row" data-table="formaciones" data-idx="${i}">‚àí</button></td>`:""}
              </tr>
            `).join("")}
          </tbody>
        `;
        box.appendChild(t);
        cont.appendChild(box);
      }
      else if (data.view === "visitas") {
        const box = document.createElement("div");
        box.innerHTML = `
          <div class="table-toolbar" style="justify-content:flex-end;">
            <strong style="margin-right:auto;">Visitas</strong>
            ${editable?`<button class="tiny-btn" data-act="center-add-visita">+ Visita</button>`:""}
          </div>
        `;
        const t = document.createElement("table");
        t.className = "table-like";
        t.innerHTML = `
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Checklist %</th>
              <th>Conv. prueba %</th>
              <th>Conv. venta %</th>
              ${editable?`<th></th>`:""}
            </tr>
          </thead>
          <tbody>
            ${(center.visitas||[]).map((v,i)=>{
              const pruebaRed = Number(v.convPrueba||0) < 80;
              const ventaRed = Number(v.convVenta||0) < 80;
              return `
              <tr data-table="visitas" data-row="${i}">
                <td>
                  <div class="date-wrapper">
                    <input type="date" class="date-input" ${editable?"":"disabled"} value="${v.fecha||""}" data-centercell="visitas" data-field="fecha" data-idx="${i}">
                  </div>
                </td>
                <td><input ${editable?"":"disabled"} value="${v.checklist||""}" data-centercell="visitas" data-field="checklist" data-idx="${i}" style="width:80px;"></td>
                <td><input ${editable?"":"disabled"} value="${v.convPrueba||""}" data-centercell="visitas" data-field="convPrueba" data-idx="${i}" style="width:90px;${pruebaRed?"background:rgba(211,47,47,0.12);":"background:rgba(11,160,72,0.12);"}"></td>
                <td><input ${editable?"":"disabled"} value="${v.convVenta||""}" data-centercell="visitas" data-field="convVenta" data-idx="${i}" style="width:90px;${ventaRed?"background:rgba(211,47,47,0.12);":"background:rgba(11,160,72,0.12);"}"></td>
                ${editable?`<td><button class="ghost-icon" data-act="center-del-row" data-table="visitas" data-idx="${i}">‚àí</button></td>`:""}
              </tr>
              `;
            }).join("")}
          </tbody>
        `;
        box.appendChild(t);
        cont.appendChild(box);
      }

      right.appendChild(cont);
      wrap.appendChild(right);
      contentHolder.appendChild(wrap);
    }

    // ============= RENDER FORMACIONES (DELEGADOS) ============
    function renderFormacionesBlock(data) {
      contentHolder.innerHTML = "";
      const sel = data.selected || 0;
      const delegado = data.delegados[sel] || { nombre:"", tabla:[], adjunto:"" };

      // cabecera simple
      const top = document.createElement("div");
      top.className = "grid-3";
      top.innerHTML = `
        <div class="field">
          <label>Delegado</label>
          <select data-act="form-sel-delegado" ${editable?"":"disabled"}>
            ${(data.delegados||[]).map((d,i)=>`<option value="${i}" ${i===sel?"selected":""}>${d.nombre||("Delegado "+(i+1))}</option>`).join("")}
          </select>
        </div>
        <div class="field" style="flex-direction:row;gap:6px;align-items:center;margin-top:16px;">
          ${editable?`
          <button class="tiny-btn" data-act="form-add-delegado">+</button>
          <button class="tiny-btn" data-act="form-del-delegado">‚àí</button>
          <button class="tiny-btn" data-act="form-rename-delegado">‚úè</button>
          <button class="tiny-btn" data-act="form-save">Guardar</button>
          `:""}
        </div>
        <div class="field">
          <label>Buscar</label>
          <input type="text" data-act="form-filter" placeholder="Filtrar formaci√≥n...">
        </div>
      `;
      contentHolder.appendChild(top);

      const box = document.createElement("div");
      box.innerHTML = `
        <div class="table-toolbar" style="justify-content:flex-end;">
          <strong style="margin-right:auto;">Formaciones del delegado</strong>
          ${editable?`<button class="tiny-btn" data-act="form-add-row">+ Fila</button>`:""}
          <label style="font-size:0.7rem;cursor:pointer;">
            ${delegado.adjunto ? "üìé "+delegado.adjunto : "üìé Adjuntar Excel"}
            <input type="file" data-act="form-attach" style="display:none;">
          </label>
        </div>
      `;
      const t = document.createElement("table");
      t.className = "table-like";
      t.innerHTML = `
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Centros</th>
            <th>Suc./Franq.</th>
            <th>Tema formaci√≥n</th>
            <th>Superado</th>
            <th>Aplicado</th>
            <th>Mentoring</th>
            <th>Observaciones</th>
            ${editable?`<th></th>`:""}
          </tr>
        </thead>
        <tbody>
          ${(delegado.tabla||[]).map((r,i)=>`
            <tr data-row="${i}">
              <td>
                <div class="date-wrapper">
                  <input type="date" class="date-input" ${editable?"":"disabled"} value="${r.fecha||""}" data-formcell="fecha" data-idx="${i}">
                </div>
              </td>
              <td><input ${editable?"":"disabled"} value="${r.centros||""}" data-formcell="centros" data-idx="${i}" style="width:100%;"></td>
              <td>
                <select ${editable?"":"disabled"} data-formcell="sucursal" data-idx="${i}">
                  <option value="Sucursal" ${r.sucursal==="Sucursal"?"selected":""}>Sucursal</option>
                  <option value="Franquicia" ${r.sucursal==="Franquicia"?"selected":""}>Franquicia</option>
                </select>
              </td>
              <td><input ${editable?"":"disabled"} value="${r.tema||""}" data-formcell="tema" data-idx="${i}" style="width:100%;"></td>
              <td>
                <select ${editable?"":"disabled"} data-formcell="superado" data-idx="${i}">
                  <option value="S√≠" ${r.superado==="S√≠"?"selected":""}>S√≠</option>
                  <option value="No" ${r.superado!=="S√≠"?"selected":""}>No</option>
                </select>
              </td>
              <td>
                <select ${editable?"":"disabled"} data-formcell="aplicado" data-idx="${i}">
                  <option value="S√≠" ${r.aplicado==="S√≠"?"selected":""}>S√≠</option>
                  <option value="No" ${r.aplicado!=="S√≠"?"selected":""}>No</option>
                </select>
              </td>
              <td>
                <select ${editable?"":"disabled"} data-formcell="mentoring" data-idx="${i}">
                  <option value="S√≠" ${r.mentoring==="S√≠"?"selected":""}>S√≠</option>
                  <option value="No" ${r.mentoring!=="S√≠"?"selected":""}>No</option>
                </select>
              </td>
              <td><input ${editable?"":"disabled"} value="${r.obs||""}" data-formcell="obs" data-idx="${i}" style="width:100%;"></td>
              ${editable?`<td><button class="ghost-icon" data-act="form-del-row" data-idx="${i}">‚àí</button></td>`:""}
            </tr>
          `).join("")}
        </tbody>
      `;
      box.appendChild(t);
      contentHolder.appendChild(box);
    }

    // ============= RENDER VISITAS (DELEGADOS) ============
    function renderVisitasBlock(data) {
      contentHolder.innerHTML = "";
      const sel = data.selected || 0;
      const delegado = data.delegados[sel] || { nombre:"", visitador:"", visitas:[], adjunto:"" };

      const top = document.createElement("div");
      top.className = "grid-3";
      top.innerHTML = `
        <div class="field">
          <label>Delegado</label>
          <select data-act="vis-sel-delegado" ${editable?"":"disabled"}>
            ${(data.delegados||[]).map((d,i)=>`<option value="${i}" ${i===sel?"selected":""}>${d.nombre||"Delegado "+(i+1)}</option>`).join("")}
          </select>
        </div>
        <div class="field">
          <label>Visitador</label>
          <input ${editable?"":"disabled"} data-act="vis-visitador" value="${delegado.visitador||""}">
        </div>
        <div class="field">
          <label>Buscar</label>
          <input type="text" data-act="vis-filter" placeholder="Filtrar visitas...">
        </div>
      `;
      contentHolder.appendChild(top);

      const box = document.createElement("div");
      box.innerHTML = `
        <div class="table-toolbar" style="justify-content:flex-end;">
          <strong style="margin-right:auto;">Visitas del delegado</strong>
          ${editable?`<button class="tiny-btn" data-act="vis-add-row">+ Visita</button>`:""}
          <label style="font-size:0.7rem;cursor:pointer;">
            ${delegado.adjunto ? "üìé "+delegado.adjunto : "üìé Adjuntar Excel"}
            <input type="file" data-act="vis-attach" style="display:none;">
          </label>
          ${editable?`<button class="tiny-btn" data-act="vis-save">Guardar</button>`:""}
        </div>
      `;
      const t = document.createElement("table");
      t.className = "table-like";
      t.innerHTML = `
        <thead>
          <tr>
            <th>Fecha</th>
            <th class="col-centro">Centros</th>
            <th class="col-suc">Suc./Franq.</th>
            <th>Audi√≥logo</th>
            <th>Checklist %</th>
            <th>Conv. prueba %</th>
            <th>Conv. venta %</th>
            <th>HIT</th>
            <th>AAR</th>
            <th>RT-equipo</th>
            <th class="col-obs">Observaciones</th>
            ${editable?`<th></th>`:""}
          </tr>
        </thead>
        <tbody>
          ${(delegado.visitas||[]).map((v,i)=>{
            const checklistColor = Number(v.checklist||0) < 85 ? "background:rgba(211,47,47,0.12);" : "background:rgba(11,160,72,0.12);";
            const convPruebaRed = Number(v.convPrueba||0) < 80;
            const convVentaRed = Number(v.convVenta||0) < 80;
            const aarVal = v.aar || v.arr || "No";
            const hitClass = (v.hit||"No")==="S√≠" ? "yes-cell" : "no-cell";
            const aarClass = (aarVal||"No")==="S√≠" ? "yes-cell" : "no-cell";
            const rtClass = (v.rt||"No")==="S√≠" ? "yes-cell" : "no-cell";
            return `
              <tr data-row="${i}">
                <td>
                  <div class="date-wrapper">
                    <input type="date" class="date-input" ${editable?"":"disabled"} value="${v.fecha||""}" data-viscell="fecha" data-idx="${i}">
                  </div>
                </td>
                <td><input ${editable?"":"disabled"} value="${v.centros||""}" data-viscell="centros" data-idx="${i}" style="width:100%;"></td>
                <td>
                  <select ${editable?"":"disabled"} data-viscell="sucursal" data-idx="${i}" style="width:100%;">
                    <option value="Sucursal" ${v.sucursal==="Sucursal"?"selected":""}>Sucursal</option>
                    <option value="Franquicia" ${v.sucursal==="Franquicia"?"selected":""}>Franquicia</option>
                  </select>
                </td>
                <td><input ${editable?"":"disabled"} value="${v.audiologo||""}" data-viscell="audiologo" data-idx="${i}" style="width:120px;"></td>
                <td><input ${editable?"":"disabled"} value="${v.checklist||""}" data-viscell="checklist" data-idx="${i}" style="width:70px;${checklistColor}"></td>
                <td><input ${editable?"":"disabled"} value="${v.convPrueba||""}" data-viscell="convPrueba" data-idx="${i}" style="width:90px;${convPruebaRed?"background:rgba(211,47,47,0.12);":"background:rgba(11,160,72,0.12);"}"></td>
                <td><input ${editable?"":"disabled"} value="${v.convVenta||""}" data-viscell="convVenta" data-idx="${i}" style="width:90px;${convVentaRed?"background:rgba(211,47,47,0.12);":"background:rgba(11,160,72,0.12);"}"></td>
                <td class="${hitClass}">
                  <select ${editable?"":"disabled"} data-viscell="hit" data-idx="${i}" style="background:transparent;width:80px;">
                    <option value="S√≠" ${(v.hit||"No")==="S√≠"?"selected":""}>S√≠</option>
                    <option value="No" ${(v.hit||"No")==="No"?"selected":""}>No</option>
                  </select>
                </td>
                <td class="${aarClass}">
                  <select ${editable?"":"disabled"} data-viscell="aar" data-idx="${i}" style="background:transparent;width:80px;">
                    <option value="S√≠" ${(aarVal||"No")==="S√≠"?"selected":""}>S√≠</option>
                    <option value="No" ${(aarVal||"No")==="No"?"selected":""}>No</option>
                  </select>
                </td>
                <td class="${rtClass}">
                  <select ${editable?"":"disabled"} data-viscell="rt" data-idx="${i}" style="background:transparent;width:80px;">
                    <option value="S√≠" ${(v.rt||"No")==="S√≠"?"selected":""}>S√≠</option>
                    <option value="No" ${(v.rt||"No")==="No"?"selected":""}>No</option>
                  </select>
                </td>
                <td><input ${editable?"":"disabled"} value="${v.obs||""}" data-viscell="obs" data-idx="${i}" style="width:100%;"></td>
                ${editable?`<td><button class="ghost-icon" data-act="vis-del-row" data-idx="${i}">‚àí</button></td>`:""}
              </tr>
            `;
          }).join("")}
        </tbody>
      `;
      box.appendChild(t);
      contentHolder.appendChild(box);
    }

    function renderCurrentBlock() {
      const data = blocks[currentBlock]; if (!data) return;
      badgeColor.style.background = data.color || "#fff";
      sectionTitle.textContent = currentBlock;
      if (!editable) contentWrap.classList.add("locked"); else contentWrap.classList.remove("locked");
      if (currentBlock === "OBJETIVOS") renderObjectives(data);
      else if (currentBlock === "CENTROS EXCLUSIVOS" || currentBlock === "CENTROS FLOP") renderCentersBlock(currentBlock, data);
      else if (currentBlock === "FORMACIONES Y MENTORING") renderFormacionesBlock(data);
      else if (currentBlock === "VISITAS") renderVisitasBlock(data);
      else contentHolder.innerHTML = "<p>Bloque sin contenido.</p>";
    }

    // PIN
    pinBtn.addEventListener("click", () => {
      const val = pinInput.value.trim();
      if (val === PIN_MASTER) setEditable(true);
      else { alert("PIN incorrecto. Usa AR4321"); setEditable(false); }
    });
    pinInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const val = pinInput.value.trim();
        if (val === PIN_MASTER) setEditable(true);
        else { alert("PIN incorrecto. Usa AR4321"); setEditable(false); }
      }
    });

    // CAMBIO DE BLOQUE
    leftPanel.addEventListener("click", (e) => {
      const btn = e.target.closest(".block-btn");
      if (!btn) return;
      document.querySelectorAll(".block-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentBlock = btn.dataset.type;
      renderCurrentBlock();
    });

    // CLICS CONTENIDO
    contentHolder.addEventListener("click", (e) => {
      const t = e.target;

      // OBJETIVOS
      if (t.dataset.act === "obj-edit") {
        const idx = +t.dataset.idx;
        const it = blocks["OBJETIVOS"].items[idx];
        const nt = prompt("T√≠tulo", it.titulo||"");
        if (nt !== null) it.titulo = nt;
        const nd = prompt("Detalle", it.detalle||"");
        if (nd !== null) it.detalle = nd;
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "obj-add") {
        const idx = +t.dataset.idx;
        blocks["OBJETIVOS"].items.splice(idx+1,0,{titulo:"Nuevo objetivo",detalle:"",fecha:""});
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "obj-del") {
        blocks["OBJETIVOS"].items.splice(+t.dataset.idx,1);
        persist(); renderCurrentBlock(); return;
      }

      // CENTROS CONTROL
      if (t.dataset.act === "center-add") {
        const data = blocks[currentBlock];
        data.centers.push({
          nombre: currentBlock==="CENTROS EXCLUSIVOS" ? "Centro exclusivo nuevo" : "Centro flop nuevo",
          delegado:"", audiologo:"", tipo:"Sucursal", acciones:[], formaciones:[], visitas:[]
        });
        data.selected = data.centers.length - 1;
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "center-del") {
        const data = blocks[currentBlock];
        if (!data.centers.length) return;
        data.centers.splice(data.selected||0,1);
        if ((data.selected||0)>0) data.selected--;
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "center-rename") {
        const data = blocks[currentBlock];
        const c = data.centers[data.selected||0];
        const nuevo = prompt("Nombre del centro", c.nombre||"");
        if (nuevo!==null) c.nombre = nuevo.trim();
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "center-save") { persist(); alert("Centros guardados"); return; }

      if (t.closest(".center-subnav")) {
        const btn = t.closest("button[data-sub]");
        if (!btn) return;
        const data = blocks[currentBlock];
        data.view = btn.dataset.sub;
        persist(); renderCurrentBlock(); return;
      }

      // tablas de centros a√±adir
      if (t.dataset.act === "center-add-accion") {
        const data = blocks[currentBlock];
        const c = data.centers[data.selected||0];
        c.acciones.push({tipo:"",fecha:"",derivaciones:"",citas:"",ventas:"",obs:""});
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "center-add-forma") {
        const data = blocks[currentBlock];
        const c = data.centers[data.selected||0];
        c.formaciones.push({curso:"",superado:"No",aplicado:"No",mentoring:"No"});
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "center-add-visita") {
        const data = blocks[currentBlock];
        const c = data.centers[data.selected||0];
        c.visitas.push({fecha:"",checklist:"",convPrueba:"",convVenta:""});
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "center-del-row") {
        const data = blocks[currentBlock];
        const c = data.centers[data.selected||0];
        const table = t.dataset.table;
        const idx = +t.dataset.idx;
        c[table].splice(idx,1);
        persist(); renderCurrentBlock(); return;
      }

      // FORMACIONES borrar fila
      if (t.dataset.act === "form-del-row") {
        const data = blocks["FORMACIONES Y MENTORING"];
        const d = data.delegados[data.selected||0];
        d.tabla.splice(+t.dataset.idx,1);
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "form-add-row") {
        const data = blocks["FORMACIONES Y MENTORING"];
        const d = data.delegados[data.selected||0];
        d.tabla.push({fecha:"",centros:"",sucursal:"Sucursal",tema:"",superado:"No",aplicado:"No",mentoring:"No",obs:""});
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "form-add-delegado") {
        const data = blocks["FORMACIONES Y MENTORING"];
        data.delegados.push({nombre:"Delegado nuevo", tabla:[], adjunto:""});
        data.selected = data.delegados.length - 1;
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "form-del-delegado") {
        const data = blocks["FORMACIONES Y MENTORING"];
        if (!data.delegados.length) return;
        data.delegados.splice(data.selected||0,1);
        if ((data.selected||0)>0) data.selected--;
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "form-rename-delegado") {
        const data = blocks["FORMACIONES Y MENTORING"];
        const d = data.delegados[data.selected||0];
        const nuevo = prompt("Nombre delegado", d.nombre||"");
        if (nuevo!==null) d.nombre = nuevo.trim();
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "form-save") { persist(); alert("Formaciones guardadas"); return; }

      // VISITAS borrar fila
      if (t.dataset.act === "vis-del-row") {
        const data = blocks["VISITAS"];
        const d = data.delegados[data.selected||0];
        d.visitas.splice(+t.dataset.idx,1);
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "vis-add-row") {
        const data = blocks["VISITAS"];
        const d = data.delegados[data.selected||0];
        d.visitas.push({fecha:"",centros:"",sucursal:"Sucursal",audiologo:"",checklist:"",convPrueba:"",convVenta:"",hit:"No",aar:"No",rt:"No",obs:""});
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "vis-save") { persist(); alert("Visitas guardadas"); return; }
    });

    // CHANGE (selects, fechas)
    contentHolder.addEventListener("change", (e) => {
      const t = e.target;

      // OBJETIVOS fecha
      if (t.dataset.act === "obj-date") {
        const idx = +t.dataset.idx;
        blocks["OBJETIVOS"].items[idx].fecha = t.value;
        persist(); return;
      }

      // cambiar centro
      if (t.dataset.act === "center-select") {
        const data = blocks[currentBlock];
        data.selected = parseInt(t.value,10) || 0;
        persist(); renderCurrentBlock(); return;
      }

      // celdas de centros (inputs/select)
      if (t.dataset.centercell) {
        const data = blocks[currentBlock];
        const c = data.centers[data.selected||0];
        const table = t.dataset.centercell;
        const idx = +t.dataset.idx;
        if (table === "acciones") {
          c.acciones[idx][t.dataset.field] = t.value;
        } else if (table === "formaciones") {
          c.formaciones[idx][t.dataset.field] = t.value;
        } else if (table === "visitas") {
          c.visitas[idx][t.dataset.field] = t.value;
        }
        persist();
        // recolor conversions en visitas de centros
        if (table === "visitas" && (t.dataset.field==="convPrueba" || t.dataset.field==="convVenta")) {
          renderCurrentBlock();
        }
        return;
      }

      // formaciones selects
      if (t.dataset.act === "form-sel-delegado") {
        const data = blocks["FORMACIONES Y MENTORING"];
        data.selected = parseInt(t.value,10) || 0;
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.formcell) {
        const data = blocks["FORMACIONES Y MENTORING"];
        const d = data.delegados[data.selected||0];
        const idx = +t.dataset.idx;
        d.tabla[idx][t.dataset.formcell] = t.value;
        persist(); return;
      }

      // visitas selects
      if (t.dataset.act === "vis-sel-delegado") {
        const data = blocks["VISITAS"];
        data.selected = parseInt(t.value,10) || 0;
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.viscell) {
        const data = blocks["VISITAS"];
        const d = data.delegados[data.selected||0];
        const idx = +t.dataset.idx;
        const old = d.visitas[idx] || {};
        d.visitas[idx] = {
          ...old,
          [t.dataset.viscell]: t.value
        };
        // recolor si es conversi√≥n o Si/No
        persist();
        if (["convPrueba","convVenta","hit","aar","rt","checklist"].includes(t.dataset.viscell)) {
          renderCurrentBlock();
        }
        return;
      }
    });

    // INPUT (texto en tablas)
    contentHolder.addEventListener("input", (e) => {
      const t = e.target;

      // campos de centro (cabecera)
      if ((currentBlock === "CENTROS EXCLUSIVOS" || currentBlock === "CENTROS FLOP") && t.dataset.field) {
        const data = blocks[currentBlock];
        const c = data.centers[data.selected||0];
        c[t.dataset.field] = t.value;
        persist(); return;
      }

      // formaciones filtro
      if (t.dataset.act === "form-filter") {
        const term = t.value.toLowerCase();
        contentHolder.querySelectorAll("table tbody tr").forEach(tr=>{
          const txt = tr.textContent.toLowerCase();
          tr.style.display = txt.includes(term) ? "" : "none";
        });
        return;
      }

      // visitas filtro
      if (t.dataset.act === "vis-filter") {
        const term = t.value.toLowerCase();
        contentHolder.querySelectorAll("table tbody tr").forEach(tr=>{
          const txt = tr.textContent.toLowerCase();
          tr.style.display = txt.includes(term) ? "" : "none";
        });
        return;
      }

      // visitas visitador
      if (t.dataset.act === "vis-visitador") {
        const data = blocks["VISITAS"];
        const d = data.delegados[data.selected||0];
        d.visitador = t.value;
        persist(); return;
      }

      // formaciones inputs
      if (t.dataset.formcell) {
        const data = blocks["FORMACIONES Y MENTORING"];
        const d = data.delegados[data.selected||0];
        const idx = +t.dataset.idx;
        d.tabla[idx][t.dataset.formcell] = t.value;
        persist(); return;
      }

      // visitas inputs
      if (t.dataset.viscell) {
        const data = blocks["VISITAS"];
        const d = data.delegados[data.selected||0];
        const idx = +t.dataset.idx;
        const old = d.visitas[idx] || {};
        d.visitas[idx] = { ...old, [t.dataset.viscell]: t.value };
        persist(); return;
      }

      // centros tabla con input
      if (t.dataset.centercell) {
        const data = blocks[currentBlock];
        const c = data.centers[data.selected||0];
        const table = t.dataset.centercell;
        const idx = +t.dataset.idx;
        c[table][idx][t.dataset.field] = t.value;
        persist(); return;
      }
    });

    // GUARDAR CON ENTER
    document.addEventListener("keydown", (e) => {
      if (!editable) return;
      if (e.key === "Enter" && !e.target.closest(".pin-box")) {
        // si es input/textarea/contenteditable no hagas salto
        if (e.target.tagName === "INPUT" || e.target.tagName === "SELECT" || e.target.isContentEditable) {
          e.preventDefault();
        }
        persist();
        editStatus.textContent = "Guardado local (ENTER)";
        setTimeout(()=>{ editStatus.textContent = "Edici√≥n activada"; }, 1500);
      }
    });

    // EXPORTS
    document.getElementById("btnHTML").addEventListener("click", () => {
      const blob = new Blob([document.documentElement.outerHTML], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "seguimiento-audio-ar.html";
      a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById("btnPDF").addEventListener("click", () => {
      alert("Exportar a PDF: usa Imprimir > Guardar como PDF.");
    });
    document.getElementById("btnXLS").addEventListener("click", () => {
      const rows = [["Bloque","Campo1","Campo2","Campo3","Campo4"]];
      Object.keys(blocks).forEach(bn => {
        const b = blocks[bn];
        if (bn === "CENTROS EXCLUSIVOS" || bn === "CENTROS FLOP") {
          (b.centers||[]).forEach(c=>{
            rows.push([bn, c.nombre, c.delegado, c.audiologo, c.tipo]);
          });
        } else if (bn === "FORMACIONES Y MENTORING") {
          (b.delegados||[]).forEach(d=>{
            (d.tabla||[]).forEach(r=>{
              rows.push([bn, d.nombre, r.centros, r.sucursal, r.tema]);
            });
          });
        } else if (bn === "VISITAS") {
          (b.delegados||[]).forEach(d=>{
            (d.visitas||[]).forEach(v=>{
              rows.push([bn, d.nombre, v.centros, v.sucursal, v.checklist]);
            });
          });
        } else {
          (b.items||[]).forEach(it=>{
            rows.push([bn, it.titulo, it.detalle, it.fecha||"", ""]);
          });
        }
      });
      const csv = rows.map(r=>r.map(x=>`"${(x||"").replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "seguimiento-audio-ar.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    // GUARDAR LOCAL BOT√ìN
    saveLocalBtn.addEventListener("click", () => {
      persist();
      editStatus.textContent = "Guardado local";
      setTimeout(()=>{ editStatus.textContent = editable ? "Edici√≥n activada" : "Solo lectura"; }, 2000);
    });

    // ARRANQUE
    renderCurrentBlock();
  </script>
</body>
</html>
