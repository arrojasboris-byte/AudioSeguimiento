<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SEGUIMIENTO AUDIO ¬∑ Cloud</title>
<meta name="theme-color" content="#c82727" />
<style>
  :root{
    --rojo:#c82727; --rojo2:#a71f1f;
    --bg:#f6f7fb; --card:#ffffff; --line:#e6e7ee;
    --tx:#222; --muted:#6b7280; --ok:#10b981; --bad:#ef4444; --warn:#f59e0b;
    --sh:0 4px 14px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--tx);font:14px/1.25 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  input,select,button{font:inherit}

  /* Top bar */
  .topbar{
    position:sticky; top:0; z-index:1000; width:100%;
    color:#fff; background:linear-gradient(180deg,var(--rojo),var(--rojo2));
    box-shadow:var(--sh);
  }
  .topbar .inner{
    max-width:1200px; margin:auto; padding:10px 12px;
    display:flex; align-items:center; gap:12px;
  }
  .logo{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px; font-size:18px}
  .sp{flex:1}
  .pill{border:1px solid #fff5; background:#ffffff18; color:#fff; border-radius:999px; padding:8px 12px; cursor:pointer}
  .pill.primary{background:#fff; color:#000; font-weight:700; box-shadow:0 1px 0 #0001}
  .pill:disabled{opacity:.6; cursor:not-allowed}

  /* Layout */
  .main{max-width:1200px; margin:12px auto; padding:0 12px; display:grid; gap:12px; grid-template-columns:270px 1fr}
  .card{background:var(--card); border:1px solid var(--line); box-shadow:var(--sh); border-radius:12px}
  .side .sec{padding:12px; border-bottom:1px solid var(--line)}
  .side .sec:last-child{border-bottom:0}
  .sec h4{margin:0 0 8px; display:flex; align-items:center; gap:8px; font-size:13px; color:#000; letter-spacing:.2px}
  .sec .hint{font-size:12px; color:var(--muted)}
  .btn{border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:8px; cursor:pointer}
  .btn.primary{background:#111; color:#fff}
  .row{display:flex; align-items:center; gap:8px}

  .detail{padding:12px}
  .detail h3{margin:0 0 8px}
  .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px}
  .tag{font-size:12px; color:#555}
  .grid{overflow:auto; border:1px solid var(--line); border-radius:8px}
  table{border-collapse:collapse; width:100%; min-width:780px}
  th,td{border-bottom:1px solid var(--line); padding:8px 10px; text-align:left; white-space:nowrap}
  thead th{background:#fafafb; font-weight:700}
  tfoot td{background:#fafafb; font-weight:700}
  input[type="number"]{width:110px}
  .ok{background:#10b98112}
  .bad{background:#ef44440f}
  .muted{color:var(--muted)}

  /* PIN overlay (fallback, si no hay uno nativo) */
  #pinOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,.78);
    display:flex; align-items:center; justify-content:center; z-index:9999;
  }
  #pinOverlay .panel{
    background:#1b1b1b; color:#fff; padding:18px 20px; border-radius:12px; width:min(92vw,360px);
    box-shadow:0 10px 30px rgba(0,0,0,.35)
  }
  #pinOverlay .panel h3{margin:0 0 10px}
  #pinOverlay input{width:130px; text-align:center; letter-spacing:.3em}
  #pinOverlay .msg{display:none; color:#ffb3b3; margin-top:8px; font-size:12px}

  /* Parche anti-duplicados de topbar por SW/recarga */
  .topbar:not(:first-of-type){display:none !important}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="inner">
    <div class="logo">üéß SEGUIMIENTO AUDIO</div>
    <div class="sp"></div>
    <button class="pill" id="btnReload">Actualizar</button>
    <button class="pill" id="btnSaveLocal">Guardar (local)</button>
    <button class="pill primary" id="btnSaveCloud">Guardar (nube)</button>
    <button class="pill" id="btnRecover">Recuperar‚Ä¶</button>
    <div class="tag" id="cloudBadge">Nube: ‚Äî</div>
  </div>
</div>

<!-- Layout -->
<div class="main">
  <!-- Side -->
  <div class="card side">
    <div class="sec">
      <h4>üìà CIFRA DE VENTAS</h4>
      <div class="hint">Abre con ‚ñ∂ para editar la tabla mensual</div>
      <div class="row">
        <button class="btn" id="btnOpenComp">‚ñ∂ Abrir Compa√±√≠a</button>
      </div>
    </div>

    <div class="sec">
      <h4>‚≠ê Centros exclusivos</h4>
      <div class="row"><button class="btn" id="btnAddCE">+ A√±adir</button></div>
      <div class="hint">Usa este bloque para tus centros exclusivos.</div>
    </div>

    <div class="sec">
      <h4>üü© Centros flop</h4>
      <div class="row"><button class="btn" id="btnAddCF">+ A√±adir</button></div>
    </div>

    <div class="sec">
      <h4>üß≠ Visitas audio</h4>
      <div class="hint">Se puede pegar desde Excel (250 filas).</div>
      <div class="row"><button class="btn" id="btnOpenVis">‚ñ∂ Abrir</button></div>
    </div>

    <div class="sec">
      <h4>üéì Formaciones y mentoring</h4>
      <div class="row"><button class="btn" id="btnOpenFor">‚ñ∂ Abrir</button></div>
    </div>

    <div class="sec">
      <h4>ü©∫ Teleaudiolog√≠a</h4>
      <div class="row"><button class="btn" id="btnOpenTele">‚ñ∂ Abrir</button></div>
    </div>

    <div class="sec">
      <h4>üß∞ Equipos</h4>
      <div class="row"><button class="btn" id="btnOpenEq">‚ñ∂ Abrir</button></div>
    </div>
  </div>

  <!-- Detail -->
  <div class="card detail">
    <div class="toolbar">
      <h3 id="detTitle" style="margin:0">CIFRA ‚Äî COMPA√ë√çA</h3>
      <span class="tag">Meses: Ago-25 ‚Üí Jul-26</span>
      <span class="tag">Consejo: rellena ‚ÄúPrevisto‚Äù y ‚ÄúCV mes‚Äù</span>
    </div>

    <div class="grid">
      <table id="tblCifra">
        <thead>
          <tr>
            <th style="width:130px">Mes</th>
            <th>Previsto</th>
            <th>CV mes</th>
            <th>Diferencia</th>
          </tr>
        </thead>
        <tbody id="tbCuerpo"></tbody>
        <tfoot>
          <tr>
            <td>Total</td>
            <td id="totPrev" class="muted">0</td>
            <td id="totMes" class="muted">0</td>
            <td id="totDif" class="muted">0</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<!-- Overlay de PIN (fallback; si ya tienes uno, este no molesta) -->
<div id="pinOverlay" aria-modal="true" role="dialog" style="display:none">
  <div class="panel">
    <h3>Acceso</h3>
    <div style="opacity:.85;margin-bottom:10px">Introduce el PIN para editar:</div>
    <div class="row">
      <input id="pin" type="password" inputmode="numeric" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="one-time-code" />
      <button id="enter" class="btn primary">Acceder</button>
      <button id="clear" class="btn">Limpiar</button>
    </div>
    <div id="pinMsg" class="msg">PIN incorrecto</div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const GAS_URL  = 'https://script.google.com/macros/s/AKfycbwsfNXUKAClhKT-Jv_yPEpPNNkJxfwQE1CdKtiOsfxPprc8oeccmbCduuv7L5PriwiI/exec';   // ‚Üê pon aqu√≠ tu /exec
const PIN_CODE = '4321';                     // ‚Üê cambia si lo necesitas

/* ========= UTILIDADES ========= */

// Meses Ago-25 ‚Üí Jul-26
const MESES = [
  'Ago-25','Sep-25','Oct-25','Nov-25','Dic-25','Ene-26','Feb-26','Mar-26','Abr-26','May-26','Jun-26','Jul-26'
];

// Formateo n√∫meros
const nf = new Intl.NumberFormat('es-ES',{maximumFractionDigits:0});

// Selecci√≥n r√°pida
const $ = (sel, root=document) => root.querySelector(sel);

// Serializar todos los inputs/select/textarea (y checked)
function serializeControls(){
  const out = [];
  const all = document.querySelectorAll('input, select, textarea, [contenteditable="true"]');
  all.forEach((el,idx)=>{
    let type = (el.type||'').toLowerCase();
    let val;
    if (type==='checkbox' || type==='radio') val = el.checked;
    else if (el.isContentEditable) val = el.innerHTML;
    else val = el.value;
    out.push({path: cssPath(el), t:type, v:val});
  });
  return out;
}

// Restaurar
function restoreControls(list){
  if(!Array.isArray(list)) return;
  list.forEach(item=>{
    const el = safeQuery(item.path);
    if(!el) return;
    const type = (el.type||'').toLowerCase();
    if (type==='checkbox' || type==='radio'){
      el.checked = !!item.v;
    }else if (el.isContentEditable){
      el.innerHTML = item.v ?? '';
    }else{
      el.value = item.v ?? '';
    }
    // dispara evento change para c√°lculos
    el.dispatchEvent(new Event('input', {bubbles:true}));
    el.dispatchEvent(new Event('change', {bubbles:true}));
  });
}

// CSS path robusto
function cssPath(el){
  if (!(el instanceof Element)) return '';
  const path = [];
  while (el.nodeType === Node.ELEMENT_NODE && el !== document.body){
    let sel = el.nodeName.toLowerCase();
    if (el.id){
      sel += '#'+CSS.escape(el.id);
      path.unshift(sel); break;
    }else{
      let sib = el, nth=1;
      while (sib = sib.previousElementSibling) if (sib.nodeName===el.nodeName) nth++;
      sel += `:nth-of-type(${nth})`;
    }
    path.unshift(sel);
    el = el.parentNode;
  }
  return path.join(' > ');
}
function safeQuery(path){
  try{ return document.querySelector(path); }catch(_){ return null; }
}

/* ========= PIN ========= */

(function pinGate(){
  const overlay = $('#pinOverlay');
  const pinInp  = $('#pin');
  const btnOk   = $('#enter');
  const btnCl   = $('#clear');
  const msg     = $('#pinMsg');

  function openGate(){
    overlay.style.display = 'flex';
    overlay.style.visibility = 'visible';
    overlay.style.opacity = '1';
    overlay.style.pointerEvents = 'auto';
    overlay.style.zIndex = '9999';
    document.body.style.overflow = 'hidden';
    setTimeout(()=>pinInp.focus(),60);
  }
  function closeGate(){
    overlay.style.display = 'none';
    document.body.style.overflow = '';
  }
  async function handleEnter(){
    const code = (pinInp.value||'').trim();
    if (String(code) === String(PIN_CODE||'4321')){
      sessionStorage.setItem('__SEGUI_AUDIO_AUTH__','1');
      msg.style.display='none';
      closeGate();
    }else{
      msg.style.display='block';
      pinInp.select();
    }
  }
  btnOk.addEventListener('click',handleEnter);
  btnCl.addEventListener('click',()=>{pinInp.value=''; pinInp.focus();});
  pinInp.addEventListener('keydown',e=>{ if(e.key==='Enter') handleEnter(); });

  document.addEventListener('DOMContentLoaded',()=>{
    if(sessionStorage.getItem('__SEGUI_AUDIO_AUTH__')!=='1'){ openGate(); }
  });
})();

/* ========= TABLA CIFRA ‚Äî COMPA√ë√çA ========= */

(function buildCifra(){
  const tbody = $('#tbCuerpo');
  tbody.innerHTML = '';
  MESES.forEach(m=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${m}</td>
      <td><input type="number" min="0" step="1" class="inPrev"  placeholder="0" /></td>
      <td><input type="number" min="0" step="1" class="inMes"   placeholder="0" /></td>
      <td class="difCell muted">0</td>
    `;
    tbody.appendChild(tr);
  });
  const ups = () => calcCifra();
  document.querySelectorAll('.inPrev,.inMes').forEach(i=>{
    i.addEventListener('input', ups);
    i.addEventListener('change', ups);
  });
  calcCifra();
})();

function calcCifra(){
  let tPrev=0, tMes=0, tDif=0;
  document.querySelectorAll('#tbCuerpo tr').forEach(tr=>{
    const prev = Number(tr.querySelector('.inPrev').value || 0);
    const mes  = Number(tr.querySelector('.inMes').value  || 0);
    const dif  = mes - prev;

    tPrev += prev; tMes += mes; tDif += dif;

    const cell = tr.querySelector('.difCell');
    cell.textContent = nf.format(dif);
    cell.classList.remove('ok','bad','muted');
    if (mes === 0 && prev === 0){ cell.classList.add('muted'); }
    else if (mes >= prev){ cell.classList.add('ok'); }
    else { cell.classList.add('bad'); }
  });
  $('#totPrev').textContent = nf.format(tPrev);
  $('#totMes').textContent  = nf.format(tMes);
  $('#totDif').textContent  = nf.format(tDif);
}

/* ========= NUBE (Apps Script) ========= */

/**
 * Carga: GET ?action=load ‚Üí devuelve string JSON o "{}"
 * Guarda: POST text/plain {action:'save', data:'<json string>'}
 * Los datos que enviamos: { ts, origin, values:[{path,t,v}] }
 */
async function cloudStatusBadge(ok, extra=''){
  const b = $('#cloudBadge');
  if(!b) return;
  b.textContent = ok ? ('Nube: guardado '+extra) : ('Nube: error '+extra);
}

async function saveCloud(){
  try{
    const payload = {
      ts: new Date().toISOString(),
      origin: location.href,
      values: serializeControls()
    };
    const resp = await fetch(GAS_URL, {
      method:'POST',
      headers:{'Content-Type':'text/plain'},
      body: JSON.stringify({action:'save', data: JSON.stringify(payload)})
    });
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    await resp.text(); // Apps Script suele responder "ok" / lo que env√≠es
    alert('Guardado en nube: OK');
    cloudStatusBadge(true, 'OK');
  }catch(err){
    console.error(err);
    alert('Error guardando en nube: '+err.message);
    cloudStatusBadge(false, '(guardar)');
  }
}

async function loadCloud(){
  try{
    const url = GAS_URL + '?action=load';
    const resp = await fetch(url, {method:'GET'});
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const txt = await resp.text();
    const data = JSON.parse(txt || '{}');
    if(data && data.values){
      restoreControls(data.values);
      alert('Datos recuperados de la nube');
      cloudStatusBadge(true, 'recuperado');
    }else{
      alert('Nube vac√≠a (sin datos previos)');
      cloudStatusBadge(true, 'vac√≠o');
    }
  }catch(err){
    console.error(err);
    alert('Error recuperando de la nube: '+err.message);
    cloudStatusBadge(false, '(cargar)');
  }
}

/* ========= LOCAL & RECUPERAR ========= */

function saveLocal(){
  try{
    const payload = {
      ts:new Date().toISOString(),
      origin:location.href,
      values:serializeControls()
    };
    localStorage.setItem('__SEGUI_AUDIO_LOCAL__', JSON.stringify(payload));
    alert('Guardado local: OK');
  }catch(err){
    alert('Error guardando local: '+err.message);
  }
}

function openRecoverDialog(){
  const wrap = document.createElement('div');
  wrap.style.position='fixed';
  wrap.style.inset='0';
  wrap.style.background='rgba(0,0,0,.65)';
  wrap.style.zIndex='9999';
  wrap.style.display='flex';
  wrap.style.alignItems='center';
  wrap.style.justifyContent='center';

  const card=document.createElement('div');
  card.style.background='#111'; card.style.color='#fff';
  card.style.padding='16px'; card.style.borderRadius='12px';
  card.style.width='min(92vw,720px)'; card.style.boxShadow='0 10px 30px rgba(0,0,0,.35)';

  card.innerHTML=`
    <h3 style="margin:0 0 8px">Recuperar datos</h3>
    <div style="opacity:.85;margin-bottom:8px">Pega el JSON o usa ‚ÄúElegir archivo‚Ä¶‚Äù. Nada de tu contenido actual se borra: se fusiona.</div>
    <textarea id="recJson" style="width:100%;height:320px;border-radius:8px;padding:8px"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <input id="recFile" type="file" accept=".json,application/json" />
      <button class="btn" id="recCancel">Cancelar</button>
      <button class="btn primary" id="recImport">Importar y guardar</button>
    </div>
  `;
  wrap.appendChild(card);
  document.body.appendChild(wrap);

  $('#recCancel',wrap).onclick=()=>wrap.remove();
  $('#recFile',wrap).onchange=(e)=>{
    const f=e.target.files[0]; if(!f) return;
    const fr=new FileReader();
    fr.onload=()=>{ $('#recJson',wrap).value=fr.result; };
    fr.readAsText(f,'utf-8');
  };
  $('#recImport',wrap).onclick=()=>{
    try{
      const txt=$('#recJson',wrap).value||'{}';
      const obj=JSON.parse(txt);
      if(obj && obj.values) restoreControls(obj.values);
      alert('Importado. No olvides ‚ÄúGuardar (nube)‚Äù si quieres subirlo.');
      wrap.remove();
    }catch(err){
      alert('JSON inv√°lido: '+err.message);
    }
  };
}

/* ========= EVENTOS UI ========= */

document.addEventListener('DOMContentLoaded',()=>{
  $('#btnReload')?.addEventListener('click',()=>location.reload());
  $('#btnSaveLocal')?.addEventListener('click',saveLocal);
  $('#btnSaveCloud')?.addEventListener('click',saveCloud);
  $('#btnRecover')?.addEventListener('click',openRecoverDialog);

  // Demo: abrir compa√±√≠a (no cambia nada, mantiene la tabla actual visible)
  $('#btnOpenComp')?.addEventListener('click',()=>{
    $('#detTitle').textContent='CIFRA ‚Äî COMPA√ë√çA';
  });

  // Badges iniciales
  cloudStatusBadge(true,'listo');
});
</script>
</body>
</html>
