<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SEGUIMIENTO AUDIO-AR</title>
  <style>
    :root {
      --bg: #f4f4f4;
      --panel: #ffffff;
      --rojo: #b71c1c;
      --negro: #181818;
      --radius-lg: 18px;
      --shadow-sm: 0 3px 10px rgba(0,0,0,0.08);
      --obj: #ffe6e6;
      --cex: #f6f0ff;
      --cflop: #ffe9d6;
      --form: #e7f7ff;
      --vis: #f9fbe7;
      --ok: #0ba048;
      --bad: #d32f2f;
    }
    * { box-sizing:border-box; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    body { margin:0; background:var(--bg); color:var(--negro); height:100vh; display:flex; flex-direction:column; }
    header {
      background:linear-gradient(120deg,#000 0%,#b71c1c 80%);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 26px;
      gap:12px;
    }
    header h1 { font-size:1.1rem; display:flex; gap:10px; align-items:center; }
    header h1 span.logo { background:rgba(255,255,255,0.1); padding:4px 10px; border-radius:99px; font-weight:700; }
    .top-actions { display:flex; gap:10px; align-items:center; }
    .btn {
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.15);
      color:#fff;
      border-radius:14px;
      padding:6px 12px;
      font-size:0.78rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .btn.secondary { background:rgba(0,0,0,0.25); }
    .pin-box {
      display:flex;
      gap:6px;
      align-items:center;
      background:rgba(0,0,0,0.25);
      border-radius:12px;
      padding:3px 6px 3px 10px;
    }
    .pin-box input { all:unset; background:rgba(0,0,0,0.25); padding:3px 6px; border-radius:8px; font-size:0.7rem; }
    .status-pill { background:rgba(0,0,0,0.2); padding:3px 10px; border-radius:99px; font-size:0.68rem; }
    main { flex:1; display:flex; gap:10px; padding:12px; overflow:hidden; }
    .left-panel {
      width:268px;
      background:var(--panel);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-sm);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      overflow-y:auto;
    }
    .left-header { font-weight:600; margin-bottom:4px; }
    .block-btn {
      display:flex; gap:10px; align-items:center;
      border-radius:14px; padding:6px 10px;
      border:1px solid transparent;
      cursor:pointer; font-size:0.78rem;
    }
    .block-btn .tag {
      width:28px; height:28px; border-radius:12px;
      display:grid; place-items:center; font-size:0.75rem;
    }
    .block-btn small { font-size:0.65rem; opacity:0.5; }
    .block-btn.active { border:1px solid rgba(0,0,0,0.08); background:#fff; box-shadow:0 3px 12px rgba(0,0,0,0.03); }
    .block-btn[data-type="OBJETIVOS"] { background:var(--obj); }
    .block-btn[data-type="CENTROS EXCLUSIVOS"] { background:var(--cex); }
    .block-btn[data-type="CENTROS FLOP"] { background:var(--cflop); }
    .block-btn[data-type="FORMACIONES Y MENTORING"] { background:var(--form); }
    .block-btn[data-type="VISITAS"] { background:var(--vis); }
    .right-panel {
      flex:1;
      background:var(--panel);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-sm);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .right-header {
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 16px; border-bottom:1px solid rgba(0,0,0,0.05);
    }
    .right-header .title { display:flex; gap:8px; align-items:center; }
    .badge-color { width:18px; height:18px; border-radius:6px; }
    .content-area { flex:1; padding:16px; overflow-y:auto; background:#f9f9f9; }
    .content-wrap { position:relative; }
    .locked-overlay {
      background:rgba(255,255,255,0.75);
      border:2px dashed rgba(183,28,28,0.3);
      border-radius:16px;
      display:none;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight:500;
      color:#b71c1c;
      position:absolute; inset:0;
    }
    .content-wrap.locked .locked-overlay { display:flex; }
    /* inputs */
    .field { display:flex; flex-direction:column; gap:4px; }
    .field label { font-size:0.7rem; opacity:0.8; }
    .field input, .field select {
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.1);
      padding:4px 8px;
      font-size:0.78rem;
    }
    /* calendario */
    .date-wrapper { position:relative; }
    .date-input { width:100%; padding-right:28px; }
    .date-wrapper::after {
      content:"üìÖ"; position:absolute; right:6px; top:50%; transform:translateY(-50%); font-size:0.75rem; opacity:0.5; pointer-events:none;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      opacity:0; cursor:pointer;
    }
    /* layout centros */
    .flex-split { display:flex; gap:14px; align-items:stretch; }
    .centers-list {
      width:240px; background:#fff; border-radius:14px;
      border:1px solid rgba(0,0,0,0.03);
      box-shadow:0 2px 6px rgba(0,0,0,0.02);
      padding:10px; display:flex; flex-direction:column; gap:10px;
    }
    .centers-list-header { display:flex; justify-content:space-between; align-items:center; gap:6px; }
    .center-right { flex:1; display:flex; }
    .center-content { flex:1; display:flex; flex-direction:column; gap:10px; }
    .center-subnav { display:flex; gap:8px; }
    .center-subnav button {
      background:#000; color:#fff; border:none; border-radius:12px;
      padding:6px 10px; font-size:0.72rem; cursor:pointer;
      display:flex; gap:6px; align-items:center;
    }
    .center-subnav button.active { background:#b71c1c; }
    .grid-3 { display:grid; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); gap:10px; }
    /* tablas */
    .table-like { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; font-size:0.73rem; }
    .table-like th, .table-like td { border:1px solid rgba(0,0,0,0.12); padding:4px 6px; }
    .table-toolbar { display:flex; gap:6px; margin-bottom:4px; align-items:center; justify-content:flex-end; }
    .yes-cell { background:rgba(11,160,72,0.12); }
    .no-cell { background:rgba(211,47,47,0.12); }
    /* visitas tama√±o columnas */
    .vis-centro { min-width:230px; }
    .vis-suc { width:110px; }
    .vis-check { width:70px; }
    .vis-conv { width:90px; }
    .vis-si { width:90px; }
    .vis-obs { min-width:230px; }
    @media (max-width:1080px){
      .flex-split { flex-direction:column; }
      .centers-list { width:100%; }
    }
    @media (max-width:960px){
      main { flex-direction:column; }
      .left-panel { width:100%; flex-direction:row; overflow-x:auto; }
      .right-panel { height:62vh; }
    }
  </style>
</head>
<body>
<header>
  <h1><span class="logo">SEGUIMIENTO</span> AUDIO-AR <small style="opacity:0.6; font-size:0.65rem;">Panel de seguimiento formaci√≥n & ventas</small></h1>
  <div class="top-actions">
    <div class="pin-box">
      <span>üîê PIN:</span>
      <input id="pinInput" type="password" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <button id="pinBtn" class="btn secondary" style="padding:4px 8px;">OK</button>
    </div>
    <button id="cloudSave" class="btn secondary" disabled>‚òÅÔ∏è Guardar en nube</button>
    <button id="cloudLoad" class="btn secondary" disabled>üîÑ Actualizar de nube</button>
    <button id="saveLocal" class="btn secondary">üíæ Guardar local</button>
    <div id="editStatus" class="status-pill">Solo lectura</div>
  </div>
</header>
<main>
  <aside class="left-panel" id="leftPanel">
    <div class="left-header">Bloques</div>
    <button class="block-btn active" data-type="OBJETIVOS" data-color="var(--obj)">
      <div class="tag" style="background:rgba(183,28,28,0.2);">üéØ</div>
      <div><div>OBJETIVOS</div><small>KPIs, % logro</small></div>
    </button>
    <button class="block-btn" data-type="CENTROS EXCLUSIVOS" data-color="var(--cex)">
      <div class="tag" style="background:rgba(47,52,55,0.05);">üè¢</div>
      <div><div>CENTROS EXCLUSIVOS</div><small>Seguimiento premium</small></div>
    </button>
    <button class="block-btn" data-type="CENTROS FLOP" data-color="var(--cflop)">
      <div class="tag" style="background:rgba(183,28,28,0.17);">‚ö†Ô∏è</div>
      <div><div>CENTROS FLOP</div><small>Alarmas & plan</small></div>
    </button>
    <button class="block-btn" data-type="FORMACIONES Y MENTORING" data-color="var(--form)">
      <div class="tag" style="background:rgba(24,24,24,0.05);">üìö</div>
      <div><div>FORMACIONES Y MENTORING</div><small>Plan de aulas</small></div>
    </button>
    <button class="block-btn" data-type="VISITAS" data-color="var(--vis)">
      <div class="tag" style="background:rgba(0,0,0,0.04);">üóìÔ∏è</div>
      <div><div>VISITAS</div><small>Agenda & report</small></div>
    </button>
  </aside>
  <section class="right-panel">
    <div class="right-header">
      <div class="title">
        <div id="badgeColor" class="badge-color" style="background:var(--obj);"></div>
        <h2 id="sectionTitle" style="font-size:0.95rem;">OBJETIVOS</h2>
      </div>
      <div>
        <button id="btnHTML" class="btn secondary">‚¨áÔ∏é HTML</button>
        <button id="btnPDF" class="btn secondary">‚¨áÔ∏é PDF</button>
        <button id="btnXLS" class="btn secondary">‚¨áÔ∏é Excel</button>
      </div>
    </div>
    <div class="content-area">
      <div id="contentWrap" class="content-wrap">
        <div class="locked-overlay">üîí Edici√≥n bloqueada. Introduce PIN AR4321.</div>
        <div id="contentHolder"></div>
      </div>
    </div>
  </section>
</main>

<script>
const PIN_MASTER = "AR4321";
const pinInput = document.getElementById("pinInput");
const pinBtn = document.getElementById("pinBtn");
const contentWrap = document.getElementById("contentWrap");
const contentHolder = document.getElementById("contentHolder");
const editStatus = document.getElementById("editStatus");
const leftPanel = document.getElementById("leftPanel");
const badgeColor = document.getElementById("badgeColor");
const sectionTitle = document.getElementById("sectionTitle");
const saveLocalBtn = document.getElementById("saveLocal");

let editable = false;

let blocks = JSON.parse(localStorage.getItem("audioar_blocks") || "null") || {
  "OBJETIVOS": {
    color: "var(--obj)",
    items: [
      { titulo: "Ventas Q4", detalle: "Objetivo 140% sobre 2024", fecha: "2025-11-02" }
    ]
  },
  "CENTROS EXCLUSIVOS": {
    color: "var(--cex)",
    selected: 0,
    view: "acciones",
    centers: [
      {
        nombre: "Centro exclusivo 1",
        delegado: "Delegado A",
        audiologo: "Audi 1",
        tipo: "Sucursal",
        acciones: [
          { tipo: "Seguimiento aud√≠fonos", fecha: "2025-11-03", derivaciones: "2", citas: "3", ventas: "1", obs: "Potencial en ORL" }
        ],
        formaciones: [
          { curso: "Teleaudiometr√≠a avanzada", superado: "S√≠", aplicado: "S√≠", mentoring: "No" }
        ],
        visitas: [
          { fecha: "2025-11-02", checklist: "90", convPrueba: "85", convVenta: "80" }
        ]
      }
    ]
  },
  "CENTROS FLOP": {
    color: "var(--cflop)",
    selected: 0,
    view: "acciones",
    centers: [
      {
        nombre: "Centro flop 1",
        delegado: "Delegado B",
        audiologo: "Audi 2",
        tipo: "Franquicia",
        acciones: [
          { tipo: "Alerta baja conversi√≥n", fecha: "2025-11-05", derivaciones: "0", citas: "1", ventas: "0", obs: "Revisar argumentario" }
        ],
        formaciones: [
          { curso: "ACE / Rehabilitaci√≥n", superado: "No", aplicado: "No", mentoring: "S√≠" }
        ],
        visitas: [
          { fecha: "2025-11-05", checklist: "70", convPrueba: "60", convVenta: "50" }
        ]
      }
    ]
  },
  "FORMACIONES Y MENTORING": {
    color: "var(--form)",
    selected: 0,
    delegados: [
      {
        nombre: "Delegado 1",
        tabla: [
          { fecha: "2025-11-04", centros: "Centro 1", sucursal: "Sucursal", tema: "Teleaudiometr√≠a", superado: "S√≠", aplicado: "S√≠", mentoring: "No", obs: "Buena participaci√≥n" }
        ],
        adjunto: ""
      }
    ]
  },
  "VISITAS": {
    color: "var(--vis)",
    selected: 0,
    delegados: [
      {
        nombre: "Delegado 1",
        visitador: "",
        visitas: [
          { fecha: "2025-11-06", centros: "Centro Tetu√°n", sucursal: "Sucursal", audiologo: "", checklist: "82", convPrueba: "75", convVenta: "60", hit: "No", aar: "No", rt: "No", obs: "Reforzar cierre" }
        ],
        adjunto: ""
      }
    ]
  }
};

let currentBlock = "OBJETIVOS";

function persist() {
  localStorage.setItem("audioar_blocks", JSON.stringify(blocks));
}

function setEditable(on) {
  editable = on;
  editStatus.textContent = on ? "Edici√≥n activada" : "Solo lectura";
  editStatus.style.background = on ? "rgba(11,160,72,0.12)" : "rgba(0,0,0,0.2)";
  renderCurrentBlock();
}

/* ====== RENDER OBJETIVOS (con calendario) ====== */
function renderObjectives(data) {
  contentHolder.innerHTML = "";
  const list = document.createElement("div");
  list.style.display = "grid";
  list.style.gap = "10px";
  data.items.forEach((item, idx) => {
    const div = document.createElement("div");
    div.className = "item";
    div.style.background = "#fff";
    div.style.borderRadius = "12px";
    div.style.padding = "8px 10px";
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:6px;">
        <strong>${item.titulo}</strong>
        ${editable?`<div style="display:flex;gap:4px;">
          <button class="ghost-icon" data-act="obj-edit" data-idx="${idx}">‚úè</button>
          <button class="ghost-icon" data-act="obj-add" data-idx="${idx}">Ôºã</button>
          <button class="ghost-icon" data-act="obj-del" data-idx="${idx}">‚àí</button>
        </div>`:""}
      </div>
      <small>${item.detalle||""}</small>
      <div class="field" style="max-width:160px;margin-top:4px;">
        <label>Fecha</label>
        <div class="date-wrapper">
          <input type="date" class="date-input" data-act="obj-date" data-idx="${idx}" value="${item.fecha||""}" ${editable?"":"disabled"}>
        </div>
      </div>
    `;
    list.appendChild(div);
  });
  if (editable) {
    const btn = document.createElement("button");
    btn.textContent = "+ A√±adir objetivo";
    btn.className = "btn secondary";
    btn.style.width = "fit-content";
    btn.onclick = () => {
      data.items.push({titulo:"Nuevo objetivo", detalle:"", fecha:""});
      persist(); renderCurrentBlock();
    };
    list.appendChild(btn);
  }
  contentHolder.appendChild(list);
}

/* ====== RENDER CENTROS (exclusivos / flop) ====== */
function renderCentersBlock(blockName, data) {
  contentHolder.innerHTML = "";
  const wrap = document.createElement("div");
  wrap.className = "flex-split";

  // panel izq
  const left = document.createElement("div");
  left.className = "centers-list";
  left.innerHTML = `
    <div class="centers-list-header">
      <strong>${blockName==="CENTROS EXCLUSIVOS"?"Centros exclusivos":"Centros flop"}</strong>
      ${editable?`
      <div style="display:flex;gap:4px;">
        <button class="btn secondary" style="padding:2px 6px;font-size:0.65rem;" data-act="center-add">+</button>
        <button class="btn secondary" style="padding:2px 6px;font-size:0.65rem;" data-act="center-del">‚àí</button>
        <button class="btn secondary" style="padding:2px 6px;font-size:0.65rem;" data-act="center-rename">‚úè</button>
        <button class="btn secondary" style="padding:2px 6px;font-size:0.65rem;" data-act="center-save">Guardar</button>
      </div>
      `:""}
    </div>
  `;
  const sel = document.createElement("select");
  sel.dataset.act = "center-select";
  (data.centers||[]).forEach((c,idx)=>{
    const opt = document.createElement("option");
    opt.value = idx;
    opt.textContent = c.nombre || (blockName==="CENTROS EXCLUSIVOS"?"Exclusivo ":"Flop ")+(idx+1);
    if (idx===(data.selected||0)) opt.selected = true;
    sel.appendChild(opt);
  });
  left.appendChild(sel);
  wrap.appendChild(left);

  // panel dcha
  const right = document.createElement("div");
  right.className = "center-right";
  const currentIdx = data.selected || 0;
  const center = data.centers[currentIdx] || {nombre:"",delegado:"",audiologo:"",tipo:"Sucursal",acciones:[],formaciones:[],visitas:[]};
  if (!data.view) data.view = "acciones";

  const cont = document.createElement("div");
  cont.className = "center-content";

  const info = document.createElement("div");
  info.className = "grid-3";
  info.innerHTML = `
    <div class="field"><label>Nombre del centro</label><input ${editable?"":"disabled"} data-field="nombre" value="${center.nombre||""}"></div>
    <div class="field"><label>Delegado</label><input ${editable?"":"disabled"} data-field="delegado" value="${center.delegado||""}"></div>
    <div class="field"><label>Audi√≥logo</label><input ${editable?"":"disabled"} data-field="audiologo" value="${center.audiologo||""}"></div>
    <div class="field"><label>Sucursal / Franquicia</label>
      <select ${editable?"":"disabled"} data-field="tipo">
        <option value="Sucursal" ${center.tipo==="Sucursal"?"selected":""}>Sucursal</option>
        <option value="Franquicia" ${center.tipo==="Franquicia"?"selected":""}>Franquicia</option>
      </select>
    </div>
  `;
  cont.appendChild(info);

  const sub = document.createElement("div");
  sub.className = "center-subnav";
  [
    {id:"acciones",label:"üìã Acciones"},
    {id:"formaciones",label:"üìö Formaciones y refuerzo"},
    {id:"visitas",label:"üóìÔ∏è Visitas"}
  ].forEach(b=>{
    const btn = document.createElement("button");
    btn.dataset.sub = b.id;
    btn.textContent = b.label;
    if (data.view===b.id) btn.classList.add("active");
    sub.appendChild(btn);
  });
  cont.appendChild(sub);

  if (data.view==="acciones") {
    const box = document.createElement("div");
    box.innerHTML = `
      <div class="table-toolbar" style="justify-content:flex-end;">
        <strong style="margin-right:auto;">Acciones</strong>
        ${editable?`<button class="btn secondary" style="padding:2px 8px;font-size:0.7rem;" data-act="center-add-accion">+ Acci√≥n</button>`:""}
      </div>
    `;
    const t = document.createElement("table");
    t.className = "table-like";
    t.innerHTML = `
      <thead>
        <tr>
          <th>Tipo de acci√≥n</th>
          <th>Fecha</th>
          <th>Derivaciones</th>
          <th>Citas</th>
          <th>Ventas</th>
          <th>Observaciones</th>
          ${editable?`<th></th>`:""}
        </tr>
      </thead>
      <tbody>
        ${(center.acciones||[]).map((a,i)=>`
          <tr>
            <td><input ${editable?"":"disabled"} data-centercell="acciones" data-field="tipo" data-idx="${i}" value="${a.tipo||""}" style="width:100%;"></td>
            <td>
              <div class="date-wrapper">
                <input type="date" class="date-input" ${editable?"":"disabled"} data-centercell="acciones" data-field="fecha" data-idx="${i}" value="${a.fecha||""}">
              </div>
            </td>
            <td><input ${editable?"":"disabled"} data-centercell="acciones" data-field="derivaciones" data-idx="${i}" value="${a.derivaciones||""}" style="width:70px;"></td>
            <td><input ${editable?"":"disabled"} data-centercell="acciones" data-field="citas" data-idx="${i}" value="${a.citas||""}" style="width:70px;"></td>
            <td><input ${editable?"":"disabled"} data-centercell="acciones" data-field="ventas" data-idx="${i}" value="${a.ventas||""}" style="width:70px;"></td>
            <td><input ${editable?"":"disabled"} data-centercell="acciones" data-field="obs" data-idx="${i}" value="${a.obs||""}" style="width:100%;"></td>
            ${editable?`<td><button class="btn secondary" style="padding:2px 6px;font-size:0.6rem;" data-act="center-del-row" data-table="acciones" data-idx="${i}">‚àí</button></td>`:""}
          </tr>
        `).join("")}
      </tbody>
    `;
    box.appendChild(t);
    cont.appendChild(box);
  }
  else if (data.view==="formaciones") {
    const box = document.createElement("div");
    box.innerHTML = `
      <div class="table-toolbar" style="justify-content:flex-end;">
        <strong style="margin-right:auto;">Formaciones y refuerzo</strong>
        ${editable?`<button class="btn secondary" style="padding:2px 8px;font-size:0.7rem;" data-act="center-add-forma">+ Formaci√≥n</button>`:""}
      </div>
    `;
    const t = document.createElement("table");
    t.className = "table-like";
    t.innerHTML = `
      <thead>
        <tr>
          <th>Curso relevante</th>
          <th>Superado</th>
          <th>Aplicado</th>
          <th>Mentoring-Coaching</th>
          ${editable?`<th></th>`:""}
        </tr>
      </thead>
      <tbody>
        ${(center.formaciones||[]).map((f,i)=>`
          <tr>
            <td><input ${editable?"":"disabled"} data-centercell="formaciones" data-field="curso" data-idx="${i}" value="${f.curso||""}" style="width:100%;"></td>
            <td>
              <select ${editable?"":"disabled"} data-centercell="formaciones" data-field="superado" data-idx="${i}">
                <option value="S√≠" ${f.superado==="S√≠"?"selected":""}>S√≠</option>
                <option value="No" ${f.superado!=="S√≠"?"selected":""}>No</option>
              </select>
            </td>
            <td>
              <select ${editable?"":"disabled"} data-centercell="formaciones" data-field="aplicado" data-idx="${i}">
                <option value="S√≠" ${f.aplicado==="S√≠"?"selected":""}>S√≠</option>
                <option value="No" ${f.aplicado!=="S√≠"?"selected":""}>No</option>
              </select>
            </td>
            <td>
              <select ${editable?"":"disabled"} data-centercell="formaciones" data-field="mentoring" data-idx="${i}">
                <option value="S√≠" ${f.mentoring==="S√≠"?"selected":""}>S√≠</option>
                <option value="No" ${f.mentoring!=="S√≠"?"selected":""}>No</option>
              </select>
            </td>
            ${editable?`<td><button class="btn secondary" style="padding:2px 6px;font-size:0.6rem;" data-act="center-del-row" data-table="formaciones" data-idx="${i}">‚àí</button></td>`:""}
          </tr>
        `).join("")}
      </tbody>
    `;
    box.appendChild(t);
    cont.appendChild(box);
  }
  else if (data.view==="visitas") {
    const box = document.createElement("div");
    box.innerHTML = `
      <div class="table-toolbar" style="justify-content:flex-end;">
        <strong style="margin-right:auto;">Visitas</strong>
        ${editable?`<button class="btn secondary" style="padding:2px 8px;font-size:0.7rem;" data-act="center-add-visita">+ Visita</button>`:""}
      </div>
    `;
    const t = document.createElement("table");
    t.className = "table-like";
    t.innerHTML = `
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Checklist %</th>
          <th>Conv. prueba %</th>
          <th>Conv. venta %</th>
          ${editable?`<th></th>`:""}
        </tr>
      </thead>
      <tbody>
        ${(center.visitas||[]).map((v,i)=>{
          const pruebaRed = Number(v.convPrueba||0) < 80;
          const ventaRed = Number(v.convVenta||0) < 80;
          const checkRed = Number(v.checklist||0) < 85;
          return `
            <tr>
              <td>
                <div class="date-wrapper">
                  <input type="date" class="date-input" ${editable?"":"disabled"} data-centercell="visitas" data-field="fecha" data-idx="${i}" value="${v.fecha||""}">
                </div>
              </td>
              <td><input ${editable?"":"disabled"} data-centercell="visitas" data-field="checklist" data-idx="${i}" value="${v.checklist||""}" style="width:80px;${checkRed?"background:rgba(211,47,47,0.12);":"background:rgba(11,160,72,0.12);"}"></td>
              <td><input ${editable?"":"disabled"} data-centercell="visitas" data-field="convPrueba" data-idx="${i}" value="${v.convPrueba||""}" style="width:90px;${pruebaRed?"background:rgba(211,47,47,0.12);":"background:rgba(11,160,72,0.12);"}"></td>
              <td><input ${editable?"":"disabled"} data-centercell="visitas" data-field="convVenta" data-idx="${i}" value="${v.convVenta||""}" style="width:90px;${ventaRed?"background:rgba(211,47,47,0.12);":"background:rgba(11,160,72,0.12);"}"></td>
              ${editable?`<td><button class="btn secondary" style="padding:2px 6px;font-size:0.6rem;" data-act="center-del-row" data-table="visitas" data-idx="${i}">‚àí</button></td>`:""}
            </tr>
          `;
        }).join("")}
      </tbody>
    `;
    box.appendChild(t);
    cont.appendChild(box);
  }

  right.appendChild(cont);
  wrap.appendChild(right);
  contentHolder.appendChild(wrap);
}

/* ====== FORMACIONES (delegados) ====== */
function renderFormacionesBlock(data) {
  contentHolder.innerHTML = "";
  const sel = data.selected || 0;
  const delegado = data.delegados[sel] || {nombre:"",tabla:[],adjunto:""};
  const top = document.createElement("div");
  top.className = "grid-3";
  top.innerHTML = `
    <div class="field">
      <label>Delegado</label>
      <select data-act="form-sel-delegado" ${editable?"":"disabled"}>
        ${(data.delegados||[]).map((d,i)=>`<option value="${i}" ${i===sel?"selected":""}>${d.nombre||"Delegado "+(i+1)}</option>`).join("")}
      </select>
    </div>
    <div class="field" style="flex-direction:row;gap:6px;align-items:center;margin-top:16px;">
      ${editable?`
      <button class="btn secondary" style="padding:2px 8px;font-size:0.7rem;" data-act="form-add-delegado">+</button>
      <button class="btn secondary" style="padding:2px 8px;font-size:0.7rem;" data-act="form-del-delegado">‚àí</button>
      <button class="btn secondary" style="padding:2px 8px;font-size:0.7rem;" data-act="form-rename-delegado">‚úè</button>
      <button class="btn secondary" style="padding:2px 8px;font-size:0.7rem;" data-act="form-save">Guardar</button>
      `:""}
    </div>
    <div class="field">
      <label>Buscar</label>
      <input type="text" data-act="form-filter" placeholder="Filtrar formaci√≥n...">
    </div>
  `;
  contentHolder.appendChild(top);

  const box = document.createElement("div");
  box.innerHTML = `
    <div class="table-toolbar" style="justify-content:flex-end;">
      <strong style="margin-right:auto;">Formaciones del delegado</strong>
      ${editable?`<button class="btn secondary" style="padding:2px 8px;font-size:0.7rem;" data-act="form-add-row">+ Fila</button>`:""}
      <label style="font-size:0.7rem;cursor:pointer;">
        ${delegado.adjunto?("üìé "+delegado.adjunto):"üìé Adjuntar Excel"}
        <input type="file" data-act="form-attach" style="display:none;">
      </label>
    </div>
  `;
  const t = document.createElement("table");
  t.className = "table-like";
  t.innerHTML = `
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Centros</th>
        <th>Suc./Franq.</th>
        <th>Tema formaci√≥n</th>
        <th>Superado</th>
        <th>Aplicado</th>
        <th>Mentoring</th>
        <th>Observaciones</th>
        ${editable?`<th></th>`:""}
      </tr>
    </thead>
    <tbody>
      ${(delegado.tabla||[]).map((r,i)=>`
        <tr>
          <td>
            <div class="date-wrapper">
              <input type="date" class="date-input" ${editable?"":"disabled"} data-formcell="fecha" data-idx="${i}" value="${r.fecha||""}">
            </div>
          </td>
          <td><input ${editable?"":"disabled"} data-formcell="centros" data-idx="${i}" value="${r.centros||""}" style="width:160px;"></td>
          <td>
            <select ${editable?"":"disabled"} data-formcell="sucursal" data-idx="${i}">
              <option value="Sucursal" ${r.sucursal==="Sucursal"?"selected":""}>Sucursal</option>
              <option value="Franquicia" ${r.sucursal==="Franquicia"?"selected":""}>Franquicia</option>
            </select>
          </td>
          <td><input ${editable?"":"disabled"} data-formcell="tema" data-idx="${i}" value="${r.tema||""}" style="width:150px;"></td>
          <td>
            <select ${editable?"":"disabled"} data-formcell="superado" data-idx="${i}">
              <option value="S√≠" ${r.superado==="S√≠"?"selected":""}>S√≠</option>
              <option value="No" ${r.superado!=="S√≠"?"selected":""}>No</option>
            </select>
          </td>
          <td>
            <select ${editable?"":"disabled"} data-formcell="aplicado" data-idx="${i}">
              <option value="S√≠" ${r.aplicado==="S√≠"?"selected":""}>S√≠</option>
              <option value="No" ${r.aplicado!=="S√≠"?"selected":""}>No</option>
            </select>
          </td>
          <td>
            <select ${editable?"":"disabled"} data-formcell="mentoring" data-idx="${i}">
              <option value="S√≠" ${r.mentoring==="S√≠"?"selected":""}>S√≠</option>
              <option value="No" ${r.mentoring!=="S√≠"?"selected":""}>No</option>
            </select>
          </td>
          <td><input ${editable?"":"disabled"} data-formcell="obs" data-idx="${i}" value="${r.obs||""}" style="width:180px;"></td>
          ${editable?`<td><button class="btn secondary" style="padding:2px 6px;font-size:0.6rem;" data-act="form-del-row" data-idx="${i}">‚àí</button></td>`:""}
        </tr>
      `).join("")}
    </tbody>
  `;
  box.appendChild(t);
  contentHolder.appendChild(box);
}

/* ====== VISITAS (delegados) ====== */
function renderVisitasBlock(data) {
  contentHolder.innerHTML = "";
  const sel = data.selected || 0;
  const delegado = data.delegados[sel] || {nombre:"",visitador:"",visitas:[],adjunto:""};
  const top = document.createElement("div");
  top.className = "grid-3";
  top.innerHTML = `
    <div class="field">
      <label>Delegado</label>
      <select data-act="vis-sel-delegado" ${editable?"":"disabled"}>
        ${(data.delegados||[]).map((d,i)=>`<option value="${i}" ${i===sel?"selected":""}>${d.nombre||"Delegado "+(i+1)}</option>`).join("")}
      </select>
    </div>
    <div class="field">
      <label>Visitador</label>
      <input ${editable?"":"disabled"} data-act="vis-visitador" value="${delegado.visitador||""}">
    </div>
    <div class="field">
      <label>Buscar</label>
      <input type="text" data-act="vis-filter" placeholder="Filtrar visitas...">
    </div>
  `;
  contentHolder.appendChild(top);

  const box = document.createElement("div");
  box.innerHTML = `
    <div class="table-toolbar" style="justify-content:flex-end;">
      <strong style="margin-right:auto;">Visitas del delegado</strong>
      ${editable?`<button class="btn secondary" style="padding:2px 8px;font-size:0.7rem;" data-act="vis-add-row">+ Visita</button>`:""}
      <label style="font-size:0.7rem;cursor:pointer;">
        ${delegado.adjunto?("üìé "+delegado.adjunto):"üìé Adjuntar Excel"}
        <input type="file" data-act="vis-attach" style="display:none;">
      </label>
      ${editable?`<button class="btn secondary" style="padding:2px 8px;font-size:0.7rem;" data-act="vis-save">Guardar</button>`:""}
    </div>
  `;
  const t = document.createElement("table");
  t.className = "table-like";
  t.innerHTML = `
    <thead>
      <tr>
        <th>Fecha</th>
        <th class="vis-centro">Centros</th>
        <th class="vis-suc">Suc./Franq.</th>
        <th>Audi√≥logo</th>
        <th class="vis-check">Checklist %</th>
        <th class="vis-conv">Conv. prueba %</th>
        <th class="vis-conv">Conv. venta %</th>
        <th class="vis-si">HIT</th>
        <th class="vis-si">AAR</th>
        <th class="vis-si">RT-equipo</th>
        <th class="vis-obs">Observaciones</th>
        ${editable?`<th></th>`:""}
      </tr>
    </thead>
    <tbody>
      ${(delegado.visitas||[]).map((v,i)=>{
        const checkRed = Number(v.checklist||0) < 85;
        const convPruebaRed = Number(v.convPrueba||0) < 80;
        const convVentaRed = Number(v.convVenta||0) < 80;
        const hitYes = (v.hit||"No")==="S√≠";
        const aarYes = (v.aar||"No")==="S√≠";
        const rtYes = (v.rt||"No")==="S√≠";
        return `
          <tr>
            <td>
              <div class="date-wrapper">
                <input type="date" class="date-input" ${editable?"":"disabled"} data-viscell="fecha" data-idx="${i}" value="${v.fecha||""}">
              </div>
            </td>
            <td><input ${editable?"":"disabled"} data-viscell="centros" data-idx="${i}" value="${v.centros||""}" style="width:100%;"></td>
            <td>
              <select ${editable?"":"disabled"} data-viscell="sucursal" data-idx="${i}" style="width:100%;">
                <option value="Sucursal" ${v.sucursal==="Sucursal"?"selected":""}>Sucursal</option>
                <option value="Franquicia" ${v.sucursal==="Franquicia"?"selected":""}>Franquicia</option>
              </select>
            </td>
            <td><input ${editable?"":"disabled"} data-viscell="audiologo" data-idx="${i}" value="${v.audiologo||""}" style="width:110px;"></td>
            <td><input ${editable?"":"disabled"} data-viscell="checklist" data-idx="${i}" value="${v.checklist||""}" style="width:70px;${checkRed?"background:rgba(211,47,47,0.12);":"background:rgba(11,160,72,0.12);"}"></td>
            <td><input ${editable?"":"disabled"} data-viscell="convPrueba" data-idx="${i}" value="${v.convPrueba||""}" style="width:90px;${convPruebaRed?"background:rgba(211,47,47,0.12);":"background:rgba(11,160,72,0.12);"}"></td>
            <td><input ${editable?"":"disabled"} data-viscell="convVenta" data-idx="${i}" value="${v.convVenta||""}" style="width:90px;${convVentaRed?"background:rgba(211,47,47,0.12);":"background:rgba(11,160,72,0.12);"}"></td>
            <td class="${hitYes?"yes-cell":"no-cell"}">
              <select ${editable?"":"disabled"} data-viscell="hit" data-idx="${i}" style="background:transparent;width:80px;">
                <option value="S√≠" ${hitYes?"selected":""}>S√≠</option>
                <option value="No" ${!hitYes?"selected":""}>No</option>
              </select>
            </td>
            <td class="${aarYes?"yes-cell":"no-cell"}">
              <select ${editable?"":"disabled"} data-viscell="aar" data-idx="${i}" style="background:transparent;width:80px;">
                <option value="S√≠" ${aarYes?"selected":""}>S√≠</option>
                <option value="No" ${!aarYes?"selected":""}>No</option>
              </select>
            </td>
            <td class="${rtYes?"yes-cell":"no-cell"}">
              <select ${editable?"":"disabled"} data-viscell="rt" data-idx="${i}" style="background:transparent;width:80px;">
                <option value="S√≠" ${rtYes?"selected":""}>S√≠</option>
                <option value="No" ${!rtYes?"selected":""}>No</option>
              </select>
            </td>
            <td><input ${editable?"":"disabled"} data-viscell="obs" data-idx="${i}" value="${v.obs||""}" style="width:100%;"></td>
            ${editable?`<td><button class="btn secondary" style="padding:2px 6px;font-size:0.6rem;" data-act="vis-del-row" data-idx="${i}">‚àí</button></td>`:""}
          </tr>
        `;
      }).join("")}
    </tbody>
  `;
  box.appendChild(t);
  contentHolder.appendChild(box);
}

/* ====== render general ====== */
function renderCurrentBlock() {
  const data = blocks[currentBlock]; if (!data) return;
  badgeColor.style.background = data.color || "#fff";
  sectionTitle.textContent = currentBlock;
  if (!editable) contentWrap.classList.add("locked"); else contentWrap.classList.remove("locked");
  if (currentBlock==="OBJETIVOS") renderObjectives(data);
  else if (currentBlock==="CENTROS EXCLUSIVOS" || currentBlock==="CENTROS FLOP") renderCentersBlock(currentBlock, data);
  else if (currentBlock==="FORMACIONES Y MENTORING") renderFormacionesBlock(data);
  else if (currentBlock==="VISITAS") renderVisitasBlock(data);
}

/* ====== eventos globales ====== */
pinBtn.addEventListener("click", ()=>{
  const v = pinInput.value.trim();
  if (v===PIN_MASTER) setEditable(true);
  else { alert("PIN incorrecto. Usa AR4321"); setEditable(false); }
});
pinInput.addEventListener("keydown", e=>{
  if (e.key==="Enter") {
    const v = pinInput.value.trim();
    if (v===PIN_MASTER) setEditable(true);
    else { alert("PIN incorrecto. Usa AR4321"); setEditable(false); }
  }
});

leftPanel.addEventListener("click", e=>{
  const btn = e.target.closest(".block-btn");
  if (!btn) return;
  document.querySelectorAll(".block-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  currentBlock = btn.dataset.type;
  renderCurrentBlock();
});

/* click contenido */
contentHolder.addEventListener("click", e=>{
  const t = e.target;

  // OBJETIVOS
  if (t.dataset.act==="obj-edit") {
    const idx = +t.dataset.idx;
    const it = blocks["OBJETIVOS"].items[idx];
    const nt = prompt("T√≠tulo", it.titulo||"");
    if (nt!==null) it.titulo = nt;
    const nd = prompt("Detalle", it.detalle||"");
    if (nd!==null) it.detalle = nd;
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="obj-add") {
    const idx = +t.dataset.idx;
    blocks["OBJETIVOS"].items.splice(idx+1,0,{titulo:"Nuevo objetivo",detalle:"",fecha:""});
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="obj-del") {
    blocks["OBJETIVOS"].items.splice(+t.dataset.idx,1);
    persist(); renderCurrentBlock(); return;
  }

  // CENTROS
  if (t.dataset.act==="center-add") {
    const d = blocks[currentBlock];
    d.centers.push({nombre: currentBlock==="CENTROS EXCLUSIVOS"?"Centro exclusivo nuevo":"Centro flop nuevo", delegado:"",audiologo:"",tipo:"Sucursal",acciones:[],formaciones:[],visitas:[]});
    d.selected = d.centers.length-1;
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="center-del") {
    const d = blocks[currentBlock];
    if (!d.centers.length) return;
    d.centers.splice(d.selected||0,1);
    if ((d.selected||0)>0) d.selected--;
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="center-rename") {
    const d = blocks[currentBlock];
    const c = d.centers[d.selected||0];
    const nuevo = prompt("Nombre del centro", c.nombre||"");
    if (nuevo!==null) c.nombre = nuevo.trim();
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="center-save") { persist(); alert("Centros guardados."); return; }

  if (t.closest(".center-subnav")) {
    const btn = t.closest("button[data-sub]");
    if (!btn) return;
    const d = blocks[currentBlock];
    d.view = btn.dataset.sub;
    persist(); renderCurrentBlock(); return;
  }

  // tablas centro
  if (t.dataset.act==="center-add-accion") {
    const d = blocks[currentBlock];
    const c = d.centers[d.selected||0];
    c.acciones.push({tipo:"",fecha:"",derivaciones:"",citas:"",ventas:"",obs:""});
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="center-add-forma") {
    const d = blocks[currentBlock];
    const c = d.centers[d.selected||0];
    c.formaciones.push({curso:"",superado:"No",aplicado:"No",mentoring:"No"});
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="center-add-visita") {
    const d = blocks[currentBlock];
    const c = d.centers[d.selected||0];
    c.visitas.push({fecha:"",checklist:"",convPrueba:"",convVenta:""});
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="center-del-row") {
    const d = blocks[currentBlock];
    const c = d.centers[d.selected||0];
    c[t.dataset.table].splice(+t.dataset.idx,1);
    persist(); renderCurrentBlock(); return;
  }

  // FORMACIONES
  if (t.dataset.act==="form-add-row") {
    const d = blocks["FORMACIONES Y MENTORING"];
    const del = d.delegados[d.selected||0];
    del.tabla.push({fecha:"",centros:"",sucursal:"Sucursal",tema:"",superado:"No",aplicado:"No",mentoring:"No",obs:""});
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="form-del-row") {
    const d = blocks["FORMACIONES Y MENTORING"];
    const del = d.delegados[d.selected||0];
    del.tabla.splice(+t.dataset.idx,1);
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="form-add-delegado") {
    const d = blocks["FORMACIONES Y MENTORING"];
    d.delegados.push({nombre:"Delegado nuevo",tabla:[],adjunto:""});
    d.selected = d.delegados.length-1;
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="form-del-delegado") {
    const d = blocks["FORMACIONES Y MENTORING"];
    if (!d.delegados.length) return;
    d.delegados.splice(d.selected||0,1);
    if ((d.selected||0)>0) d.selected--;
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="form-rename-delegado") {
    const d = blocks["FORMACIONES Y MENTORING"];
    const del = d.delegados[d.selected||0];
    const nuevo = prompt("Nombre del delegado", del.nombre||"");
    if (nuevo!==null) del.nombre = nuevo.trim();
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="form-save") { persist(); alert("Formaciones guardadas."); return; }

  // VISITAS
  if (t.dataset.act==="vis-add-row") {
    const d = blocks["VISITAS"];
    const del = d.delegados[d.selected||0];
    del.visitas.push({fecha:"",centros:"",sucursal:"Sucursal",audiologo:"",checklist:"",convPrueba:"",convVenta:"",hit:"No",aar:"No",rt:"No",obs:""});
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="vis-del-row") {
    const d = blocks["VISITAS"];
    const del = d.delegados[d.selected||0];
    del.visitas.splice(+t.dataset.idx,1);
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.act==="vis-save") { persist(); alert("Visitas guardadas."); return; }
});

/* change (select, date) */
contentHolder.addEventListener("change", e=>{
  const t = e.target;

  // objetivos date
  if (t.dataset.act==="obj-date") {
    blocks["OBJETIVOS"].items[+t.dataset.idx].fecha = t.value;
    persist(); return;
  }

  // centro select
  if (t.dataset.act==="center-select") {
    const d = blocks[currentBlock];
    d.selected = parseInt(t.value,10) || 0;
    persist(); renderCurrentBlock(); return;
  }

  // centro tabla
  if (t.dataset.centercell) {
    const d = blocks[currentBlock];
    const c = d.centers[d.selected||0];
    const table = t.dataset.centercell;
    const idx = +t.dataset.idx;
    if (table==="acciones") c.acciones[idx][t.dataset.field] = t.value;
    else if (table==="formaciones") c.formaciones[idx][t.dataset.field] = t.value;
    else if (table==="visitas") c.visitas[idx][t.dataset.field] = t.value;
    persist();
    if (table==="visitas" && (t.dataset.field==="convPrueba" || t.dataset.field==="convVenta" || t.dataset.field==="checklist")) {
      renderCurrentBlock();
    }
    return;
  }

  // formaciones
  if (t.dataset.act==="form-sel-delegado") {
    const d = blocks["FORMACIONES Y MENTORING"];
    d.selected = parseInt(t.value,10) || 0;
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.formcell) {
    const d = blocks["FORMACIONES Y MENTORING"];
    const del = d.delegados[d.selected||0];
    del.tabla[+t.dataset.idx][t.dataset.formcell] = t.value;
    persist(); return;
  }

  // visitas
  if (t.dataset.act==="vis-sel-delegado") {
    const d = blocks["VISITAS"];
    d.selected = parseInt(t.value,10) || 0;
    persist(); renderCurrentBlock(); return;
  }
  if (t.dataset.viscell) {
    const d = blocks["VISITAS"];
    const del = d.delegados[d.selected||0];
    const idx = +t.dataset.idx;
    del.visitas[idx][t.dataset.viscell] = t.value;
    persist();
    if (["checklist","convPrueba","convVenta","hit","aar","rt"].includes(t.dataset.viscell)) {
      renderCurrentBlock();
    }
    return;
  }
});

/* input (texto) */
contentHolder.addEventListener("input", e=>{
  const t = e.target;
  // centros cabecera
  if ((currentBlock==="CENTROS EXCLUSIVOS" || currentBlock==="CENTROS FLOP") && t.dataset.field) {
    const d = blocks[currentBlock];
    const c = d.centers[d.selected||0];
    c[t.dataset.field] = t.value;
    persist(); return;
  }
  // form filter
  if (t.dataset.act==="form-filter") {
    const term = t.value.toLowerCase();
    contentHolder.querySelectorAll("table tbody tr").forEach(tr=>{
      tr.style.display = tr.textContent.toLowerCase().includes(term) ? "" : "none";
    });
    return;
  }
  // visitas filter
  if (t.dataset.act==="vis-filter") {
    const term = t.value.toLowerCase();
    contentHolder.querySelectorAll("table tbody tr").forEach(tr=>{
      tr.style.display = tr.textContent.toLowerCase().includes(term) ? "" : "none";
    });
    return;
  }
  // visitador
  if (t.dataset.act==="vis-visitador") {
    const d = blocks["VISITAS"];
    const del = d.delegados[d.selected||0];
    del.visitador = t.value;
    persist(); return;
  }
  // visitas inputs
  if (t.dataset.viscell) {
    const d = blocks["VISITAS"];
    const del = d.delegados[d.selected||0];
    del.visitas[+t.dataset.idx][t.dataset.viscell] = t.value;
    persist(); return;
  }
  // formaciones inputs
  if (t.dataset.formcell) {
    const d = blocks["FORMACIONES Y MENTORING"];
    const del = d.delegados[d.selected||0];
    del.tabla[+t.dataset.idx][t.dataset.formcell] = t.value;
    persist(); return;
  }
});

/* guardar con ENTER */
document.addEventListener("keydown", e=>{
  if (!editable) return;
  if (e.key==="Enter" && !e.target.closest(".pin-box")) {
    e.preventDefault();
    persist();
    editStatus.textContent = "Guardado local (ENTER)";
    setTimeout(()=>{ editStatus.textContent = "Edici√≥n activada"; }, 1500);
  }
});

/* export */
document.getElementById("btnHTML").addEventListener("click", ()=>{
  const blob = new Blob([document.documentElement.outerHTML], {type:"text/html"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "seguimiento-audio-ar.html"; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById("btnPDF").addEventListener("click", ()=>{
  alert("Exportar a PDF: usa Imprimir > Guardar como PDF.");
});
document.getElementById("btnXLS").addEventListener("click", ()=>{
  const rows = [["Bloque","Campo1","Campo2","Campo3","Campo4"]];
  Object.keys(blocks).forEach(bn=>{
    const b = blocks[bn];
    if (bn==="CENTROS EXCLUSIVOS" || bn==="CENTROS FLOP") {
      (b.centers||[]).forEach(c=>{
        rows.push([bn, c.nombre, c.delegado, c.audiologo, c.tipo]);
      });
    } else if (bn==="FORMACIONES Y MENTORING") {
      (b.delegados||[]).forEach(d=>{
        (d.tabla||[]).forEach(r=>{
          rows.push([bn, d.nombre, r.centros, r.sucursal, r.tema]);
        });
      });
    } else if (bn==="VISITAS") {
      (b.delegados||[]).forEach(d=>{
        (d.visitas||[]).forEach(v=>{
          rows.push([bn, d.nombre, v.centros, v.sucursal, v.checklist]);
        });
      });
    } else {
      (b.items||[]).forEach(it=>{
        rows.push([bn, it.titulo, it.detalle, it.fecha||"", ""]);
      });
    }
  });
  const csv = rows.map(r=>r.map(x=>`"${(x||"").replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "seguimiento-audio-ar.csv"; a.click();
  URL.revokeObjectURL(url);
});

/* guardar local bot√≥n */
saveLocalBtn.addEventListener("click", ()=>{
  persist();
  editStatus.textContent = "Guardado local";
  setTimeout(()=>{ editStatus.textContent = editable ? "Edici√≥n activada" : "Solo lectura"; }, 1500);
});

/* inicio */
renderCurrentBlock();
</script>
</body>
</html>
