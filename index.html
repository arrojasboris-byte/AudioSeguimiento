<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AUDIOLOGIA-SEGUIMIENTO</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#e11d48; --ink:#0f172a; --muted:#64748b; --bg:#f1f5f9; --card:#ffffff; --ok:#16a34a; --warn:#f59e0b;
  }
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .app{max-width:1220px;margin:24px auto;padding:0 16px}
  .bar{display:flex;align-items:center;gap:12px;background:var(--card);border-radius:14px;padding:10px 14px;border:3px solid var(--brand)}
  .logo{width:140px;height:44px;object-fit:contain;border-radius:8px;background:#f8fafc;display:block}
  .title{font-weight:800;font-size:26px;letter-spacing:.5px}
  .grow{flex:1}
  .btn-ic{width:42px;height:42px;border-radius:12px;border:none;display:grid;place-items:center;background:#1f2937;color:#fff;cursor:pointer}
  .btn-ic.red{background:#ef4444} .btn-ic.blue{background:#2563eb} .btn-ic.gray{background:#374151}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:9px 14px;font-weight:600;cursor:pointer}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#f8fafc;border:1px solid #e2e8f0;padding:8px 12px;border-radius:12px}
  .wrap{display:grid;grid-template-columns:360px 1fr;gap:16px;margin-top:16px}
  .card{background:var(--card);border-radius:14px;padding:14px;border:1px solid #e5e7eb}
  .h{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .h h3{margin:0;font-size:18px}
  .sec{margin-bottom:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fcfcfd}
  .sec-h{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .mini{display:flex;align-items:center;gap:8px}
  .tag{font-weight:700}
  .sublist{display:grid;gap:8px}
  .sub{display:flex;align-items:center;justify-content:space-between;background:#fff;border:1px dashed #e5e7eb;border-radius:10px;padding:8px 10px}
  .sub .meta{font-size:12px;color:var(--muted)}
  .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
  .b1{background:#eef2ff;border-color:#c7d2fe} .b2{background:#ecfeff;border-color:#a5f3fc}
  .b3{background:#ecfccb;border-color:#bef264} .b4{background:#fee2e2;border-color:#fecaca}
  .actions{display:flex;gap:6px}
  .x{cursor:pointer;border:none;background:#fff;border-radius:8px;padding:6px}
  .x:hover{background:#f1f5f9}
  .proc-head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .proc-title{font-size:20px;font-weight:800}
  .t{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb}
  .t th,.t td{border-bottom:1px solid #e5e7eb;padding:10px;font-size:14px}
  .t th{background:#0f172a;color:#fff;text-align:left}
  input,select{border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;font:inherit;width:100%}
  .foot{margin-top:10px;display:flex;gap:8px;justify-content:flex-end}
  .muted{color:var(--muted);font-size:12px}
  .note{font-size:12px;color:#475569;margin-top:8px}
  @media(max-width:980px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <!-- TOP BAR -->
  <div class="bar">
    <img id="logo" class="logo" alt="Logo">
    <div class="pill"><strong>Plataforma</strong> <span class="title">AUDIOLOGIA-SEGUIMIENTO</span></div>
    <div class="grow"></div>
    <button class="btn-ic gray" id="btnLogo" title="Subir logo">üñºÔ∏è</button>
    <button class="btn-ic gray" id="btnLock" title="Editar (PIN)">üîí</button>
    <button class="btn-ic red"  id="btnSaveLocal" title="Guardar local">üíæ</button>
    <button class="btn-ic blue" id="btnExport" title="Exportar JSON (subir al repo como data.json)">‚¨áÔ∏è</button>
    <button class="btn-ic gray" id="btnCloud" title="Actualizar de nube (leer data.json)">üîÑ</button>
    <button class="btn-ic gray" id="btnCfg" title="Ajustes">‚öôÔ∏è</button>
    <input id="fileLogo" type="file" accept="image/*" hidden>
  </div>

  <!-- SEARCH -->
  <div class="card" style="margin-top:12px">
    <input id="q" placeholder="Buscar en secciones, centros y datos‚Ä¶">
  </div>

  <div class="wrap">
    <!-- LEFT: SECTIONS -->
    <div class="card" id="left">
      <div class="h">
        <h3>Secciones</h3>
        <button class="btn" id="addSection">+ A√±adir secci√≥n</button>
      </div>

      <!-- Secciones fijas -->
      <div id="sections"></div>
      <div class="note">Consejo: pulsa el nombre de un centro para cargar sus procedimientos.</div>
    </div>

    <!-- RIGHT: PROCEDIMIENTOS -->
    <div class="card">
      <div class="proc-head">
        <div class="proc-title" id="procTitle">Procedimientos ‚Äî </div>
        <span class="badge" id="itemsCount">0 √≠tems</span>
        <div class="grow"></div>
        <button class="btn" id="addProc">+ A√±adir</button>
        <button class="btn" id="saveProc">Guardar</button>
      </div>

      <!-- Acciones-Resultado -->
      <div class="sec">
        <div class="sec-h"><div class="mini"><span class="tag">Acciones ‚Äì Resultado</span></div></div>
        <div class="table-wrap">
          <table class="t" id="tblAcc">
            <thead><tr>
              <th>#</th><th>Fecha</th><th>Acci√≥n</th><th>Derivaci√≥n</th><th>Cita</th><th>Observaciones</th><th></th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Formaci√≥n Continua -->
      <div class="sec">
        <div class="sec-h"><div class="mini"><span class="tag">Formaci√≥n continua</span></div></div>
        <table class="t" id="tblForm">
          <thead><tr>
            <th>#</th><th>Fecha</th><th>Asistencia (SI/NO)</th><th>T√≠tulo</th><th>Aplicaci√≥n</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
        <div class="foot"><button class="btn" id="saveForm">Guardar</button></div>
      </div>

      <!-- Procesos personalizados -->
      <div class="sec">
        <div class="sec-h"><div class="mini"><span class="tag">Procesos y paquetes personalizados</span></div></div>
        <table class="t" id="tblProc">
          <thead><tr>
            <th>#</th><th>Nombre paquete</th><th>Descripci√≥n</th><th>Puntuaci√≥n</th><th>Observaciones</th><th>Fecha visita</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
        <div class="foot"><button class="btn" id="savePP">Guardar</button></div>
      </div>
    </div>
  </div>

  <div class="muted" id="status"></div>
</div>

<script>
/* ===== CONFIG NUBE LOCAL =====
   URL del JSON en la nube (mismo repo). Sube/actualiza un archivo 'data.json' en la ra√≠z.
   Ejemplo de acceso: https://arrojasboris-byte.github.io/AudioSeguimiento/data.json
*/
const CLOUD_URL = location.origin + location.pathname.replace(/index\.html?$/,'') + 'data.json';

// Estado principal
let state = {
  logo: "", company: "AUDIOLOG√çA",
  pin: "AR4321", edit:false,
  sections: [
    { id:'exclusivos', title:'Centros exclusivos', subs:[
      { id:'c1', name:'Reina Mercedes', delegado:'Ana Mart√≠nez', audiologo:'Dr. Garc√≠a', tipo:'Franquicia', color:'b1' },
      { id:'c2', name:'Barcelona Centro', delegado:'Carlos Ruiz', audiologo:'Dra. L√≥pez', tipo:'Sucursal', color:'b2' },
    ]},
    { id:'flop', title:'Centros flop', subs:[] },
    { id:'form', title:'Formaciones ‚Äì Mentoring', subs:[] },
    { id:'visitas', title:'Visitas a centros', subs:[] },
  ],
  // Datos por centro exclusivo
  dataByCentro:{
    c1: sampleCentroData(),
    c2: sampleCentroData()
  },
  activeCentro:'c1'
};

function sampleCentroData(){
  return {
    acciones:[{id:1, fecha:'', accion:'', derivacion:0, cita:0, obs:''}],
    formaciones:Array.from({length:10},(_,i)=>({id:i+1,fecha:'',asistencia:'',titulo:'',aplica:''})),
    procesos:[{id:1,nombrePaquete:'',descripcion:'',puntuacion:'',obs:'',fecha:''}]
  }
}

// Helpers
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function uid(){ return Math.random().toString(36).slice(2,9) }
function setStatus(msg){ $('#status').textContent = msg }

// Render
function renderLogo(){
  const el = $('#logo');
  if(state.logo){ el.src = state.logo; el.alt='Logo' } else { el.removeAttribute('src'); el.alt='Logo' }
}
function renderSections(){
  const box = $('#sections'); box.innerHTML='';
  state.sections.forEach(sec=>{
    const wrap = document.createElement('div'); wrap.className='sec';
    const count = sec.subs.length;
    wrap.innerHTML = `
      <div class="sec-h">
        <div class="mini"><span class="tag">${sec.title}</span> <span class="badge">${count}</span></div>
        <div class="actions">
          <button class="x" title="A√±adir sub" data-act="addSub" data-sec="${sec.id}">‚ûï</button>
        </div>
      </div>
      <div class="sublist" id="list-${sec.id}"></div>
    `;
    box.appendChild(wrap);
    const list = wrap.querySelector('.sublist');

    sec.subs.forEach((s,i)=>{
      const row = document.createElement('div'); row.className='sub';
      row.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:2px;max-width:70%">
          <div style="display:flex;align-items:center;gap:8px;cursor:pointer" data-act="selectCentro" data-id="${s.id}">
            <strong>${s.name}</strong>
            <span class="badge ${s.color||'b3'}">${s.tipo||'-'}</span>
          </div>
          <div class="meta">üë§ ${s.delegado||'-'} ¬∑ üéß ${s.audiologo||'-'}</div>
        </div>
        <div class="actions">
          <button class="x" title="Editar" data-act="editSub" data-sec="${sec.id}" data-id="${s.id}">‚úèÔ∏è</button>
          <button class="x" title="Eliminar" data-act="delSub" data-sec="${sec.id}" data-id="${s.id}">üóëÔ∏è</button>
        </div>
      `;
      list.appendChild(row);
    });
  });
}
function activeCentroName(){
  for(const sec of state.sections){
    for(const s of sec.subs){ if(s.id===state.activeCentro) return s.name }
  }
  return '';
}
function ensureCentroData(id){
  if(!state.dataByCentro[id]) state.dataByCentro[id]=sampleCentroData();
  return state.dataByCentro[id];
}
function renderTablas(){
  const centro = ensureCentroData(state.activeCentro);
  $('#procTitle').textContent = 'Procedimientos ‚Äî ' + (activeCentroName()||'');
  // Acciones
  const tbA = $('#tblAcc tbody'); tbA.innerHTML='';
  centro.acciones.forEach((a,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td><input type="date" value="${a.fecha||''}" data-k="fecha" data-t="acc" data-id="${a.id}"></td>
      <td><input value="${a.accion||''}" data-k="accion" data-t="acc" data-id="${a.id}"></td>
      <td><input type="number" min="0" value="${a.derivacion||0}" data-k="derivacion" data-t="acc" data-id="${a.id}"></td>
      <td><input type="number" min="0" value="${a.cita||0}" data-k="cita" data-t="acc" data-id="${a.id}"></td>
      <td><input value="${a.obs||''}" data-k="obs" data-t="acc" data-id="${a.id}"></td>
      <td><button class="x" data-act="delAcc" data-id="${a.id}">‚úñ</button></td>
    `;
    tbA.appendChild(tr);
  });
  // Formaciones
  const tbF = $('#tblForm tbody'); tbF.innerHTML='';
  centro.formaciones.forEach((f,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td><input type="date" value="${f.fecha||''}" data-k="fecha" data-t="form" data-id="${f.id}"></td>
      <td><input value="${f.asistencia||''}" placeholder="SI/NO" data-k="asistencia" data-t="form" data-id="${f.id}"></td>
      <td><input value="${f.titulo||''}" data-k="titulo" data-t="form" data-id="${f.id}"></td>
      <td><input value="${f.aplica||''}" data-k="aplica" data-t="form" data-id="${f.id}"></td>
      <td><button class="x" data-act="clearForm" data-id="${f.id}" title="Limpiar">üßπ</button></td>
    `;
    tbF.appendChild(tr);
  });
  // Procesos
  const tbP = $('#tblProc tbody'); tbP.innerHTML='';
  centro.procesos.forEach((p,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td><input value="${p.nombrePaquete||''}" data-k="nombrePaquete" data-t="pp" data-id="${p.id}"></td>
      <td><input value="${p.descripcion||''}" data-k="descripcion" data-t="pp" data-id="${p.id}"></td>
      <td><input value="${p.puntuacion||''}" data-k="puntuacion" data-t="pp" data-id="${p.id}"></td>
      <td><input value="${p.obs||''}" data-k="obs" data-t="pp" data-id="${p.id}"></td>
      <td><input type="date" value="${p.fecha||''}" data-k="fecha" data-t="pp" data-id="${p.id}"></td>
      <td><button class="x" data-act="delPP" data-id="${p.id}">‚úñ</button></td>
    `;
    tbP.appendChild(tr);
  });

  $('#itemsCount').textContent = (centro.acciones.length + centro.formaciones.length + centro.procesos.length) + ' √≠tems';
}

// Eventos globales
document.addEventListener('click',e=>{
  const act = e.target.dataset.act;
  if(!act) return;
  if(!state.edit && ['addSub','editSub','delSub','selectCentro','delAcc','delPP','clearForm'].includes(act)){
    alert('Bloqueado. Pulsa el candado y usa el PIN AR4321.');
    return;
  }
  if(act==='addSub'){
    const secId = e.target.dataset.sec;
    const name = prompt('Nombre del centro/subsecci√≥n:'); if(!name) return;
    const delegado = prompt('Delegado:')||''; const audiologo=prompt('Audi√≥logo:')||''; const tipo = prompt('Tipo (Franquicia/Sucursal):')||'';
    const color = ['b1','b2','b3','b4'][Math.floor(Math.random()*4)];
    const sub = {id:uid(),name,delegado,audiologo,tipo,color};
    const sec = state.sections.find(s=>s.id===secId); sec.subs.push(sub);
    if(secId==='exclusivos') state.dataByCentro[sub.id]=sampleCentroData();
    saveLocal(); renderSections();
  }
  if(act==='editSub'){
    const secId=e.target.dataset.sec, id=e.target.dataset.id;
    const sec = state.sections.find(s=>s.id===secId); const s = sec.subs.find(x=>x.id===id);
    const name = prompt('Nombre:',s.name); if(!name) return;
    s.name=name; s.delegado=prompt('Delegado:',s.delegado||'')||''; s.audiologo=prompt('Audi√≥logo:',s.audiologo||'')||''; s.tipo=prompt('Tipo:',s.tipo||'')||'';
    renderSections(); saveLocal();
  }
  if(act==='delSub'){
    if(!confirm('¬øEliminar?')) return;
    const secId=e.target.dataset.sec, id=e.target.dataset.id;
    const sec = state.sections.find(s=>s.id===secId);
    sec.subs = sec.subs.filter(x=>x.id!==id);
    delete state.dataByCentro[id];
    if(state.activeCentro===id) state.activeCentro='';
    renderSections(); renderTablas(); saveLocal();
  }
  if(act==='selectCentro'){
    state.activeCentro = e.target.closest('[data-id]').dataset.id;
    renderTablas();
  }
  if(act==='delAcc'){
    const id=e.target.dataset.id;
    const c=ensureCentroData(state.activeCentro);
    c.acciones=c.acciones.filter(x=>String(x.id)!==String(id));
    renderTablas(); saveLocal();
  }
  if(act==='delPP'){
    const id=e.target.dataset.id;
    const c=ensureCentroData(state.activeCentro);
    c.procesos=c.procesos.filter(x=>String(x.id)!==String(id));
    renderTablas(); saveLocal();
  }
  if(act==='clearForm'){
    const id=e.target.dataset.id;
    const c=ensureCentroData(state.activeCentro);
    const f=c.formaciones.find(x=>x.id==id); if(!f) return;
    Object.assign(f,{fecha:'',asistencia:'',titulo:'',aplica:''});
    renderTablas(); saveLocal();
  }
});

document.addEventListener('input',e=>{
  const t=e.target.dataset.t; if(!t) return;
  const id=e.target.dataset.id, k=e.target.dataset.k, v=e.target.value;
  const c=ensureCentroData(state.activeCentro);
  if(t==='acc'){ const it=c.acciones.find(x=>x.id==id); it[k]= (k==='derivacion'||k==='cita') ? Number(v||0) : v; }
  if(t==='form'){ const it=c.formaciones.find(x=>x.id==id); it[k]=v; }
  if(t==='pp'){ const it=c.procesos.find(x=>x.id==id); it[k]=v; }
  setStatus('Editando‚Ä¶ (no olvides Guardar)'); 
});

$('#addProc').onclick=()=>{
  const c=ensureCentroData(state.activeCentro);
  const nid = Math.max(0,...c.acciones.map(x=>x.id))+1;
  c.acciones.push({id:nid,fecha:'',accion:'',derivacion:0,cita:0,obs:''});
  renderTablas();
}
$('#saveProc').onclick=()=>{ saveLocal(); setStatus('Acciones guardadas localmente. Exporta JSON para subir al repo.'); }
$('#saveForm').onclick=()=>{ saveLocal(); setStatus('Formaciones guardadas localmente.'); }
$('#savePP').onclick =()=>{ saveLocal(); setStatus('Procesos guardados localmente.'); }

$('#btnLogo').onclick=()=>$('#fileLogo').click();
$('#fileLogo').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=ev=>{ state.logo=ev.target.result; renderLogo(); saveLocal(); };
  r.readAsDataURL(f);
};

$('#btnLock').onclick=()=>{
  if(state.edit){ state.edit=false; $('#btnLock').textContent='üîí'; setStatus('Edici√≥n bloqueada.'); return; }
  const pin=prompt('PIN:'); if(pin===state.pin){ state.edit=true; $('#btnLock').textContent='üîì'; setStatus('Edici√≥n habilitada.'); }
  else alert('PIN incorrecto.');
};

function saveLocal(){
  localStorage.setItem('audioseguimiento', JSON.stringify(state));
}
function loadLocal(){
  const raw=localStorage.getItem('audioseguimiento'); if(!raw) return false;
  try{ state=JSON.parse(raw); return true }catch{ return false }
}
function exportJSON(){
  const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='data.json'; a.click(); URL.revokeObjectURL(a.href);
}
$('#btnExport').onclick=exportJSON;
$('#btnSaveLocal').onclick=()=>{ saveLocal(); setStatus('Guardado local OK. Ahora exporta y sube data.json al repo.'); };

async function loadCloud(){
  try{
    const url = CLOUD_URL + (CLOUD_URL.includes('?')?'&':'?') + 'ts=' + Date.now();
    const res=await fetch(url,{cache:'no-store'}); 
    if(!res.ok) throw 0;
    const data=await res.json();
    // preserva el PIN local y el modo edici√≥n; acepta logo remota si existe
    const keepPin = state.pin, wasEdit = state.edit;
    state = data; state.pin = keepPin; state.edit = wasEdit;
    saveLocal();
    bootstrap();
    setStatus('Datos actualizados desde la nube (data.json).');
  }catch{
    setStatus('No se encontr√≥ data.json en la nube o fallo de lectura.');
  }
}
$('#btnCloud').onclick=loadCloud;

$('#btnCfg').onclick=()=>alert(
  'Nube local (sin tokens):\n\n1) Pulsa Exportar JSON para descargar data.json.\n2) En GitHub ‚Üí tu repo ‚Üí Add file ‚Üí Upload files ‚Üí sube/actualiza data.json (en la ra√≠z).\n3) Espera el deploy de Pages.\n4) En cualquier equipo pulsa üîÑ Actualizar de nube.\n\nTodos ver√°n el √∫ltimo data.json del repositorio.'
);

// Buscador simple
$('#q').addEventListener('input',e=>{
  const q=e.target.value.toLowerCase();
  $$('#sections .sub').forEach(row=>{
    const txt=row.textContent.toLowerCase();
    row.style.display = txt.includes(q)?'flex':'none';
  });
});

// Inicializaci√≥n
function bootstrap(){
  renderLogo();
  renderSections();
  if(!state.activeCentro){
    const ex = state.sections.find(s=>s.id==='exclusivos');
    if(ex && ex.subs[0]) state.activeCentro = ex.subs[0].id;
  }
  renderTablas();
}

(function init(){
  const had = loadLocal();
  bootstrap();
  // Cargar de nube al entrar, si existe data.json (no bloquea UI)
  loadCloud();
  setStatus(had ? 'Cargado desde local. Intentando nube‚Ä¶' : 'Bienvenido. Crea/Exporta data.json para la nube.');
})();
</script>
</body>
</html>
