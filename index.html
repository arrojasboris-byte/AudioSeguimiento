<!-- === AudioSeguimiento ‚Äì Cloud Sync (Firestore) | PEGAR ANTES DE </body> === -->
<script type="module">
  /********************************************************************
   * AudioSeguimiento ‚Äì Guardar en la Nube (Firestore)
   * - Mantiene tu edici√≥n original intacta (no interfiere con tu JS).
   * - Sincroniza SOLO elementos [data-cloud] (o #notas como fallback).
   * - PIN fijo: AR4321 ‚Üí docId = SHA-256(PIN).
   * - Barra flotante: Guardar nube / Actualizar + √öltima actualizaci√≥n.
   * - Falla con gracia si falta config Firebase (sin romper la p√°gina).
   ********************************************************************/

  // ============ 1) CONFIGURA AQU√ç TU FIREBASE (RELLENA LOS CAMPOS) ============
  const firebaseConfig = {
    apiKey: "TU_API_KEY",                 // <- RELLENA
    authDomain: "TU_AUTH_DOMAIN",         // <- RELLENA (p.ej. tuapp.firebaseapp.com)
    projectId: "TU_PROJECT_ID",           // <- RELLENA (p.ej. tuapp)
    // Opcionales si los tienes:
    // storageBucket: "TU_STORAGE_BUCKET",
    // messagingSenderId: "TU_SENDER_ID",
    // appId: "TU_APP_ID",
  };

  // ============ 2) IMPORTS SDK FIREBASE (CDN OFICIAL) ============
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

  // ============ 3) UTILIDADES ============
  const PIN = "AR4321";

  async function sha256Hex(text) {
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');
  }

  function isFirebaseConfigured(cfg) {
    const req = ["apiKey","authDomain","projectId"];
    return req.every(k => typeof cfg[k] === "string" && cfg[k] && !cfg[k].startsWith("TU_"));
  }

  // ============ 4) UI DISCRETA (NO ROMPE TU DISE√ëO) ============
  const bar = document.createElement('div');
  Object.assign(bar.style, {
    position: 'fixed',
    right: '12px',
    bottom: '12px',
    zIndex: 2147483647,
    background: 'rgba(0,0,0,0.78)',
    color: '#fff',
    padding: '8px 10px',
    borderRadius: '12px',
    fontFamily: 'system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif',
    boxShadow: '0 6px 18px rgba(0,0,0,0.25)',
    display: 'flex',
    gap: '8px',
    alignItems: 'center',
    flexWrap: 'wrap'
  });
  bar.innerHTML = `
    <strong style="font-weight:600">Cloud Sync</strong>
    <button id="cloud-save" style="padding:.4rem .6rem;border:0;border-radius:8px;cursor:pointer;">Guardar nube</button>
    <button id="cloud-load" style="padding:.4rem .6rem;border:0;border-radius:8px;cursor:pointer;">Actualizar</button>
    <span id="cloud-status" style="opacity:.95">‚è≥</span>
    <span id="cloud-last" style="opacity:.9">‚Äî</span>
  `;
  document.body.appendChild(bar);

  const btnSave = bar.querySelector('#cloud-save');
  const btnLoad = bar.querySelector('#cloud-load');
  const elStatus = bar.querySelector('#cloud-status');
  const elLast   = bar.querySelector('#cloud-last');

  // Vista previa opcional (√∫til al probar). Quita si no la quieres.
  const pre = document.createElement('pre');
  Object.assign(pre.style, {
    position: 'fixed',
    left: '12px',
    bottom: '12px',
    maxWidth: '40vw',
    maxHeight: '32vh',
    overflow: 'auto',
    background: 'rgba(255,255,255,0.96)',
    padding: '8px 10px',
    borderRadius: '12px',
    fontSize: '12px',
    boxShadow: '0 6px 18px rgba(0,0,0,0.15)',
    color: '#111',
    whiteSpace: 'pre-wrap',
    zIndex: 2147483646
  });
  pre.id = 'estado-previsualizacion';
  document.body.appendChild(pre);

  function setStatus(msg){ elStatus.textContent = msg; }
  function setLast(ts){
    if (!ts) { elLast.textContent = '‚Äî'; return; }
    try {
      const d = ts?.toDate ? ts.toDate() : new Date(ts);
      elLast.textContent = `√öltima actualizaci√≥n: ${d.toLocaleString('es-ES')}`;
    } catch { elLast.textContent = '‚Äî'; }
  }

  function disableButtons(reason){
    btnSave.disabled = true; btnLoad.disabled = true;
    btnSave.style.opacity = .6; btnLoad.style.opacity = .6;
    setStatus(reason);
  }

  // ============ 5) SELECCI√ìN DE CAMPOS A SINCRONIZAR ============
  function getCloudElements() {
    const marked = Array.from(document.querySelectorAll('[data-cloud]'));
    if (marked.length > 0) return marked;
    const fallback = document.querySelector('#notas');
    return fallback ? [fallback] : [];
  }

  function readElementValue(el) {
    const tag = el.tagName;
    if (tag === 'INPUT') {
      const t = (el.getAttribute('type') || 'text').toLowerCase();
      if (t === 'checkbox') return !!el.checked;
      if (t === 'radio') return el.checked ? el.value : null;
      return el.value;
    }
    if (tag === 'TEXTAREA' || tag === 'SELECT') return el.value;
    return el.textContent;
  }

  function writeElementValue(el, val) {
    try {
      const tag = el.tagName;
      if (tag === 'INPUT') {
        const t = (el.getAttribute('type') || 'text').toLowerCase();
        if (t === 'checkbox') { el.checked = !!val; return; }
        if (t === 'radio') { el.checked = (val === el.value); return; }
        el.value = (val ?? '');
        el.dispatchEvent(new Event('input', { bubbles: true }));
        el.dispatchEvent(new Event('change', { bubbles: true }));
        return;
      }
      if (tag === 'TEXTAREA' || tag === 'SELECT') {
        el.value = (val ?? '');
        el.dispatchEvent(new Event('input', { bubbles: true }));
        el.dispatchEvent(new Event('change', { bubbles: true }));
        return;
      }
      if (typeof val === 'string') el.textContent = val;
    } catch (e) {
      console.warn('No se pudo aplicar valor a', el, e);
    }
  }

  function collectState() {
    const els = getCloudElements();
    const state = {};
    els.forEach((el, idx) => {
      const key = el.id || el.name || `el_${idx}`;
      const val = readElementValue(el);
      if (val !== null && key) state[key] = val;
    });
    // Previsualizaci√≥n opcional
    const area = document.getElementById('estado-previsualizacion');
    if (area) area.textContent = JSON.stringify(state, null, 2);
    return state;
  }

  function applyState(state) {
    if (!state || typeof state !== 'object') return;
    Object.keys(state).forEach(k => {
      let el = document.getElementById(k) || document.querySelector(`[name="${CSS.escape(k)}"]`);
      if (el) writeElementValue(el, state[k]);
    });
    const area = document.getElementById('estado-previsualizacion');
    if (area) area.textContent = JSON.stringify(state, null, 2);
  }

  // ============ 6) FLUJO PRINCIPAL ============
  let app, db, docRef;

  async function init() {
    try {
      // Comprobaci√≥n de configuraci√≥n
      if (!isFirebaseConfigured(firebaseConfig)) {
        disableButtons('‚ö†Ô∏è Configura Firebase (apiKey/authDomain/projectId)');
        console.warn('Rellena firebaseConfig con los valores reales de tu proyecto.');
        return;
      }

      // Inicializa Firebase + Firestore
      app = initializeApp(firebaseConfig);
      db  = getFirestore(app);

      // Deriva docId desde PIN y prepara docRef
      const docId = await sha256Hex(PIN);
      docRef = doc(db, 'platformStates', docId);

      setStatus('üîÑ Conectando‚Ä¶');

      // Suscripci√≥n en tiempo real
      onSnapshot(docRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          setLast(data.lastUpdated);
          if (data?.state) {
            applyState(data.state);
            setStatus('‚úÖ Sincronizado');
          } else {
            setStatus('‚ÑπÔ∏è Documento vac√≠o');
          }
        } else {
          setLast(null);
          setStatus('‚ûï Sin datos en la nube');
        }
      }, (err) => {
        console.error(err);
        setStatus('‚ö†Ô∏è Error de escucha');
      });

    } catch (e) {
      console.error('Fallo en init:', e);
      disableButtons('‚ùå Error inicializando');
      alert('Error inicializando sincronizaci√≥n. Revisa consola.');
    }
  }

  async function saveToCloud() {
    try {
      if (!docRef) throw new Error('Firestore no inicializado');
      setStatus('üíæ Guardando‚Ä¶');
      const state = collectState();
      await setDoc(docRef, {
        state,
        lastUpdated: serverTimestamp(),
        updatedBy: 'web'
      }, { merge: true });
      setStatus('‚úÖ Guardado');
      localStorage.setItem('audioseguimiento_backup', JSON.stringify({ when: Date.now(), state }));
    } catch (e) {
      console.error(e);
      setStatus('‚ùå Error al guardar');
      alert('Error guardando en la nube. Ver consola / reglas Firestore.');
    }
  }

  async function loadFromCloud() {
    try {
      if (!docRef) throw new Error('Firestore no inicializado');
      setStatus('‚¨áÔ∏è Actualizando‚Ä¶');
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        setLast(data.lastUpdated);
        if (data?.state) {
          applyState(data.state);
          setStatus('‚úÖ Actualizado');
        } else {
          setStatus('‚ÑπÔ∏è Documento vac√≠o');
        }
      } else {
        setLast(null);
        setStatus('‚ûï No existe estado a√∫n');
      }
    } catch (e) {
      console.error(e);
      setStatus('‚ùå Error al actualizar');
      alert('Error actualizando desde la nube. Ver consola / reglas Firestore.');
    }
  }

  // ============ 7) ENLACE DE EVENTOS ============
  btnSave.addEventListener('click', saveToCloud);
  btnLoad.addEventListener('click', loadFromCloud);

  // ============ 8) INICIO ============
  init();

  /********************************************************************
   * CONSEJO R√ÅPIDO:
   * - Marca con data-cloud lo que quieras sincronizar:
   *   <input id="nombre" data-cloud>
   *   <textarea id="notas" data-cloud></textarea>
   *   <select id="tipo" data-cloud></select>
   *
   * REGLAS FIRESTORE (prototipo, abre lectura/escritura):
   * rules_version = '2';
   * service cloud.firestore {
   *   match /databases/{database}/documents {
   *     match /platformStates/{docId} {
   *       allow read, write: if true;
   *     }
   *   }
   * }
   * Para producci√≥n: usa Firebase Auth + reglas estrictas.
   ********************************************************************/
</script>
