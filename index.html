<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SEGUIMIENTO AUDIO-AR</title>
  <style>
    :root {
      --bg: #f4f4f4;
      --panel: #ffffff;
      --gris: #2f3437;
      --rojo: #b71c1c;
      --blanco: #ffffff;
      --negro: #181818;
      --radius-lg: 18px;
      --shadow-sm: 0 3px 10px rgba(0,0,0,0.08);
      --obj: #ffe6e6;
      --cex: #f6f0ff;
      --cflop: #ffe9d6;
      --form: #e7f7ff;
      --vis: #f9fbe7;
      --ok: #0ba048;
      --bad: #d32f2f;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{margin:0;background:var(--bg);color:var(--negro);height:100vh;display:flex;flex-direction:column;}
    header{background:linear-gradient(120deg,#000 0%,#b71c1c 80%);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:12px 26px;gap:12px;}
    header h1{font-size:1.1rem;display:flex;gap:10px;align-items:center;}
    header h1 span.logo{background:rgba(255,255,255,.1);padding:4px 10px;border-radius:999px;font-weight:700;}
    .top-actions{display:flex;gap:10px;align-items:center;}
    .btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:#fff;border-radius:14px;padding:6px 12px;font-size:.78rem;display:inline-flex;gap:6px;align-items:center;cursor:pointer;transition:.15s;}
    .btn:hover{background:rgba(255,255,255,.2);}
    .btn.secondary{background:rgba(0,0,0,.3);}
    .pin-box{display:flex;gap:6px;align-items:center;background:rgba(0,0,0,.2);border-radius:12px;padding:3px 6px 3px 10px;}
    .pin-box input{all:unset;background:rgba(0,0,0,.3);padding:3px 6px;border-radius:8px;font-size:.7rem;}
    .status-pill{background:rgba(0,0,0,.2);padding:3px 10px;border-radius:999px;font-size:.68rem;}
    main{flex:1;display:flex;gap:10px;padding:12px;overflow:hidden;}
    .left-panel{width:268px;background:var(--panel);border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);padding:10px;display:flex;flex-direction:column;gap:6px;overflow-y:auto;}
    .left-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;}
    .block-btn{display:flex;align-items:center;gap:10px;background:#f3f3f3;border:1px solid transparent;border-radius:14px;padding:6px 10px;cursor:pointer;transition:.15s;font-size:.78rem;}
    .block-btn .tag{width:28px;height:28px;border-radius:12px;display:grid;place-items:center;font-size:.75rem;font-weight:600;}
    .block-btn small{opacity:.5;font-size:.65rem;}
    .block-btn.active{border:1px solid rgba(0,0,0,.12);background:#fff;box-shadow:0 3px 12px rgba(0,0,0,.03);}
    .block-btn[data-type="OBJETIVOS"]{background:var(--obj);}
    .block-btn[data-type="CENTROS EXCLUSIVOS"]{background:var(--cex);}
    .block-btn[data-type="CENTROS FLOP"]{background:var(--cflop);}
    .block-btn[data-type="FORMACIONES Y MENTORING"]{background:var(--form);}
    .block-btn[data-type="VISITAS"]{background:var(--vis);}
    .right-panel{flex:1;background:var(--panel);border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);display:flex;flex-direction:column;overflow:hidden;}
    .right-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(0,0,0,.05);}
    .badge-color{width:18px;height:18px;border-radius:6px;}
    .content-area{flex:1;padding:16px;overflow-y:auto;background:#f9f9f9;}
    .content-wrap{position:relative;}
    .locked-overlay{background:rgba(255,255,255,.75);border:2px dashed rgba(183,28,28,.3);border-radius:16px;display:none;align-items:center;justify-content:center;gap:10px;font-weight:500;color:#b71c1c;padding:10px;}
    .content-wrap.locked .locked-overlay{display:flex;position:absolute;inset:0;backdrop-filter:blur(1px);}
    .list{display:grid;gap:10px;}
    .item{background:#fff;border:1px solid rgba(0,0,0,.04);border-left:4px solid rgba(183,28,28,.6);border-radius:12px;padding:8px 10px 6px 10px;display:flex;flex-direction:column;gap:4px;box-shadow:0 1px 6px rgba(0,0,0,.02);}
    .item-header{display:flex;justify-content:space-between;align-items:center;gap:6px;}
    .tiny-btn,.ghost-icon{background:rgba(0,0,0,.04);padding:2px 6px;border-radius:6px;border:none;cursor:pointer;font-size:.7rem;display:inline-flex;align-items:center;gap:2px;}
    .ghost-icon{background:rgba(0,0,0,.02);}
    .flex-split{display:flex;gap:14px;align-items:stretch;}
    .centers-list{width:240px;background:#fff;border-radius:14px;border:1px solid rgba(0,0,0,.03);box-shadow:0 2px 6px rgba(0,0,0,.02);padding:10px;display:flex;flex-direction:column;gap:10px;}
    .centers-list-header{display:flex;justify-content:space-between;align-items:center;gap:6px;}
    .center-right{flex:1;display:flex;}
    .center-content{flex:1;display:flex;flex-direction:column;gap:10px;}
    .center-subnav{display:flex;gap:8px;margin-top:4px;}
    .center-subnav button{background:#000;color:#fff;border:none;border-radius:12px;padding:6px 10px;font-size:.72rem;cursor:pointer;display:flex;align-items:center;gap:4px;}
    .center-subnav button.active{background:#b71c1c;}
    .grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;}
    .field{display:flex;flex-direction:column;gap:4px;}
    .field label{font-size:.7rem;opacity:.8;}
    .field input,.field select{border-radius:10px;border:1px solid rgba(0,0,0,.1);padding:5px 8px;font-size:.78rem;background:#fff;}
    .table-like{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;font-size:.74rem;}
    .table-like th,.table-like td{border:1px solid rgba(0,0,0,.12);padding:4px 6px;}
    .table-toolbar{display:flex;gap:6px;margin-bottom:4px;align-items:center;justify-content:flex-end;}
    .badge-ok{background:rgba(11,160,72,.1);color:#0b7a3a;padding:2px 6px;border-radius:6px;font-size:.65rem;}
    .badge-bad{background:rgba(211,47,47,.12);color:#b71c1c;padding:2px 6px;border-radius:6px;font-size:.65rem;}
    .delegados-panel{width:220px;background:#fff;border-radius:14px;border:1px solid rgba(0,0,0,.03);padding:10px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 6px rgba(0,0,0,.02);}
    .delegados-header{display:flex;justify-content:space-between;align-items:center;}
    .delegado-item{background:rgba(0,0,0,.02);border-radius:9px;padding:5px 8px;display:flex;justify-content:space-between;align-items:center;gap:6px;cursor:pointer;font-size:.75rem;}
    .delegado-item.active{background:#000;color:#fff;}
    .flex-form-vis{display:flex;gap:14px;}
    .date-wrap{position:relative;}
    .date-wrap::after{content:"üìÖ";position:absolute;right:5px;top:50%;transform:translateY(-50%);font-size:.6rem;opacity:.6;pointer-events:none;}
    input[type="date"]::-webkit-calendar-picker-indicator{opacity:0;cursor:pointer;}
    @media(max-width:1080px){.flex-split,.flex-form-vis{flex-direction:column;}.centers-list,.delegados-panel{width:100%;}}
    @media(max-width:960px){main{flex-direction:column;}.left-panel{width:100%;flex-direction:row;overflow-x:auto;}.right-panel{height:60vh;}}
  </style>
</head>
<body>
<header>
  <h1><span class="logo">SEGUIMIENTO</span> AUDIO-AR <small style="opacity:.6;font-size:.65rem;">Panel de seguimiento formaci√≥n & ventas</small></h1>
  <div class="top-actions">
    <div class="pin-box">
      <span>üîê PIN:</span>
      <input id="pinInput" type="password" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <button id="pinBtn" class="btn secondary" style="padding:4px 8px;">OK</button>
    </div>
    <button class="btn disabled" id="saveCloud">‚òÅÔ∏è Guardar en nube</button>
    <button class="btn disabled" id="loadCloud">üîÑ Actualizar de nube</button>
    <button class="btn secondary" id="saveLocal">üíæ Guardar local</button>
    <div class="status-pill" id="editStatus">Solo lectura</div>
  </div>
</header>
<main>
  <aside class="left-panel" id="leftPanel">
    <div class="left-header">
      <strong>Bloques</strong>
      <button id="addBlock" class="tiny-btn">+ A√±adir</button>
    </div>
    <button class="block-btn active" data-type="OBJETIVOS" data-color="var(--obj)"><div class="tag" style="background:rgba(183,28,28,.2);">üéØ</div><div><div>OBJETIVOS</div><small>KPIs, % logro</small></div></button>
    <button class="block-btn" data-type="CENTROS EXCLUSIVOS" data-color="var(--cex)"><div class="tag" style="background:rgba(47,52,55,.05);">üè¢</div><div><div>CENTROS EXCLUSIVOS</div><small>Seguimiento premium</small></div></button>
    <button class="block-btn" data-type="CENTROS FLOP" data-color="var(--cflop)"><div class="tag" style="background:rgba(183,28,28,.17);">‚ö†Ô∏è</div><div><div>CENTROS FLOP</div><small>Alarmas & plan</small></div></button>
    <button class="block-btn" data-type="FORMACIONES Y MENTORING" data-color="var(--form)"><div class="tag" style="background:rgba(24,24,24,.05);">üìö</div><div><div>FORMACIONES Y MENTORING</div><small>Plan de aulas</small></div></button>
    <button class="block-btn" data-type="VISITAS" data-color="var(--vis)"><div class="tag" style="background:rgba(0,0,0,.04);">üóìÔ∏è</div><div><div>VISITAS</div><small>Agenda & report</small></div></button>
  </aside>
  <section class="right-panel">
    <div class="right-header">
      <div class="title">
        <div class="badge-color" id="badgeColor" style="background:var(--obj);"></div>
        <h2 id="sectionTitle" style="font-size:.95rem;">OBJETIVOS</h2>
      </div>
      <div>
        <button class="btn secondary" id="btnHTML">‚¨áÔ∏é HTML</button>
        <button class="btn secondary" id="btnPDF">‚¨áÔ∏é PDF</button>
        <button class="btn secondary" id="btnXLS">‚¨áÔ∏é Excel</button>
      </div>
    </div>
    <div class="content-area">
      <div class="content-wrap" id="contentWrap">
        <div class="locked-overlay">üîí Edici√≥n bloqueada. Introduce PIN AR4321.</div>
        <div id="contentHolder"></div>
      </div>
    </div>
  </section>
</main>
<script>
const PIN_MASTER = "AR4321";
const ACTION_TYPES = ["Azafata","Cashback","Ruleta","Stand","Call center","Mailing","Buzoneo","Bono","Otro"];

let editable = false;
const pinInput = document.getElementById("pinInput");
const pinBtn = document.getElementById("pinBtn");
const editStatus = document.getElementById("editStatus");
const contentWrap = document.getElementById("contentWrap");
const contentHolder = document.getElementById("contentHolder");
const leftPanel = document.getElementById("leftPanel");
const badgeColor = document.getElementById("badgeColor");
const sectionTitle = document.getElementById("sectionTitle");
const saveLocalBtn = document.getElementById("saveLocal");

let blocks = JSON.parse(localStorage.getItem("audioar_blocks") || "null") || {
  "OBJETIVOS": {
    color: "var(--obj)",
    items: [
      { titulo: "Ventas Q4", detalle: "Objetivo 140% sobre 2024", fecha: "2025-11-02" }
    ]
  },
  "CENTROS EXCLUSIVOS": {
    color: "var(--cex)",
    selected: 0,
    view: "acciones",
    centers: [
      {
        nombre: "Centro exclusivo 1",
        delegado: "",
        audiologo: "",
        tipo: "Sucursal",
        acciones: [
          { tipo: "Azafata", fecha: "2025-11-05", derivaciones: "2", citas: "3", ventas: "1", obs: "Potencial ORL" }
        ],
        formaciones: [
          { curso: "Teleaudiometr√≠a avanzada", superado: "S√≠", aplicado: "S√≠", mentoring: "No" }
        ],
        visitas: [
          { fecha: "2025-11-10", checklist: "90", convPrueba: "85", convVenta: "81" }
        ],
        servicios: [
          { nombre: "Tinnitus-TRT", tiene: "No", ventas: "" },
          { nombre: "Pedi√°trico", tiene: "No", ventas: "" },
          { nombre: "AAR", tiene: "No", ventas: "" },
          { nombre: "HIT", tiene: "No", ventas: "" }
        ]
      }
    ]
  },
  "CENTROS FLOP": {
    color: "var(--cflop)",
    selected: 0,
    view: "acciones",
    centers: [
      {
        nombre: "Centro flop 1",
        delegado: "",
        audiologo: "",
        tipo: "Franquicia",
        acciones: [
          { tipo: "Mailing", fecha: "2025-11-06", derivaciones: "0", citas: "1", ventas: "0", obs: "Revisar cierre" }
        ],
        formaciones: [
          { curso: "ACE / Rehabilitaci√≥n", superado: "No", aplicado: "No", mentoring: "S√≠" }
        ],
        visitas: [
          { fecha: "2025-11-08", checklist: "72", convPrueba: "60", convVenta: "50" }
        ],
        servicios: [
          { nombre: "Tinnitus-TRT", tiene: "No", ventas: "" },
          { nombre: "Pedi√°trico", tiene: "No", ventas: "" },
          { nombre: "AAR", tiene: "No", ventas: "" },
          { nombre: "HIT", tiene: "No", ventas: "" }
        ]
      }
    ]
  },
  "FORMACIONES Y MENTORING": {
    color: "var(--form)",
    selected: 0,
    delegados: [
      {
        nombre: "SERG",
        filas: [
          { fecha: "2025-11-06", centros: "Centro Tetu√°n", sucursal: "Sucursal", tema: "Teleaudiometr√≠a", superado: "S√≠", aplicado: "No", mentoring: "No", obs: "" }
        ],
        adjunto: ""
      }
    ]
  },
  "VISITAS": {
    color: "var(--vis)",
    selected: 0,
    delegados: [
      {
        nombre: "Delegado 1",
        visitas: [
          { fecha: "2025-11-06", centros: "Centro Tetu√°n", sucursal: "Sucursal", audiologo: "", checklist: "82", convPrueba: "75", convVenta: "60", hit: "No", aar: "No", rt: "No", obs: "Reforzar cierre" }
        ],
        adjunto: ""
      }
    ]
  }
};

let currentBlock = "OBJETIVOS";

function persist(){ localStorage.setItem("audioar_blocks", JSON.stringify(blocks)); }

function setEditable(on){
  editable = on;
  editStatus.textContent = on ? "Edici√≥n activada" : "Solo lectura";
  editStatus.style.background = on ? "rgba(11,160,72,.1)" : "rgba(0,0,0,.2)";
  render();
}

pinBtn.addEventListener("click", ()=> {
  if (pinInput.value.trim() === PIN_MASTER) setEditable(true);
  else { alert("PIN incorrecto. Usa AR4321."); setEditable(false); }
});
pinInput.addEventListener("keydown", e=>{
  if (e.key==="Enter"){
    if (pinInput.value.trim() === PIN_MASTER) setEditable(true);
    else { alert("PIN incorrecto. Usa AR4321."); setEditable(false); }
  }
});

leftPanel.addEventListener("click", e=>{
  const btn = e.target.closest(".block-btn");
  if (!btn) return;
  document.querySelectorAll(".block-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  currentBlock = btn.dataset.type;
  render();
});

function renderObjetivos(data){
  contentHolder.innerHTML = "";
  const list = document.createElement("div");
  list.className = "list";
  data.items.forEach((item,idx)=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="item-header">
        <strong>${item.titulo}</strong>
        ${editable ? `<div class="item-actions">
            <button class="ghost-icon" data-act="obj-edit" data-idx="${idx}">‚úè</button>
            <button class="ghost-icon" data-act="obj-add" data-idx="${idx}">Ôºã</button>
            <button class="ghost-icon" data-act="obj-del" data-idx="${idx}">‚àí</button>
          </div>` : ``}
      </div>
      <small>${item.detalle}</small>
      <small>üìÖ ${item.fecha||""}</small>
    `;
    list.appendChild(div);
  });
  if (editable){
    const add = document.createElement("button");
    add.className = "tiny-btn";
    add.textContent = "+ A√±adir objetivo";
    add.onclick = ()=>{ data.items.push({titulo:"Nuevo objetivo",detalle:"",fecha:""}); persist(); render(); }
    list.appendChild(add);
  }
  contentHolder.appendChild(list);
}

function makeDateInput(value, attrs=""){
  const v = value ? value : "";
  return `<div class="date-wrap"><input type="date" value="${v}" ${attrs}></div>`;
}

/* CENTROS EXCLUSIVOS / FLOP */
function renderCentros(blockName, data){
  contentHolder.innerHTML = "";
  const wrap = document.createElement("div");
  wrap.className = "flex-split";

  const panel = document.createElement("div");
  panel.className = "centers-list";
  panel.innerHTML = `
    <div class="centers-list-header">
      <strong>${blockName === "CENTROS EXCLUSIVOS" ? "Centros exclusivos" : "Centros flop"}</strong>
      ${editable ? `<span>
          <button class="tiny-btn" data-act="cen-add">+</button>
          <button class="tiny-btn" data-act="cen-del">‚àí</button>
          <button class="tiny-btn" data-act="cen-rename">‚úè</button>
          <button class="tiny-btn" data-act="cen-save">Guardar</button>
        </span>` : ``}
    </div>
    <select data-act="cen-select">
      ${(data.centers||[]).map((c,i)=>`<option value="${i}" ${i=== (data.selected||0) ? "selected":""}>${c.nombre||((blockName==="CENTROS EXCLUSIVOS"?"Exclusivo ":"Flop ")+(i+1))}</option>`).join("")}
    </select>
  `;
  wrap.appendChild(panel);

  const right = document.createElement("div");
  right.className = "center-right";

  const sel = data.selected || 0;
  const c = data.centers[sel] || {
    nombre:"",
    delegado:"",
    audiologo:"",
    tipo:"Sucursal",
    acciones:[],
    formaciones:[],
    visitas:[],
    servicios:[
      {nombre:"Tinnitus-TRT",tiene:"No",ventas:""},
      {nombre:"Pedi√°trico",tiene:"No",ventas:""},
      {nombre:"AAR",tiene:"No",ventas:""},
      {nombre:"HIT",tiene:"No",ventas:""}
    ]
  };
  if (!data.view) data.view = "acciones";

  const cont = document.createElement("div");
  cont.className = "center-content";

  cont.innerHTML = `
    <div class="grid-3">
      <div class="field"><label>Nombre del centro</label><input ${editable?"":"disabled"} data-cen-field="nombre" value="${c.nombre||""}"></div>
      <div class="field"><label>Delegado</label><input ${editable?"":"disabled"} data-cen-field="delegado" value="${c.delegado||""}"></div>
      <div class="field"><label>Audi√≥logo</label><input ${editable?"":"disabled"} data-cen-field="audiologo" value="${c.audiologo||""}"></div>
      <div class="field"><label>Sucursal / Franquicia</label>
        <select ${editable?"":"disabled"} data-cen-field="tipo">
          <option value="Sucursal" ${c.tipo==="Sucursal"?"selected":""}>Sucursal</option>
          <option value="Franquicia" ${c.tipo==="Franquicia"?"selected":""}>Franquicia</option>
        </select>
      </div>
    </div>
    <div class="center-subnav">
      <button data-sub="acciones" class="${data.view==="acciones"?"active":""}">üìã Acciones</button>
      <button data-sub="formaciones" class="${data.view==="formaciones"?"active":""}">üìö Formaciones y refuerzo</button>
      <button data-sub="visitas" class="${data.view==="visitas"?"active":""}">üóìÔ∏è Visitas</button>
      <button data-sub="servicios" class="${data.view==="servicios"?"active":""}">üß© Servicios</button>
    </div>
  `;

  /* VISTA ACCIONES CON CALENDARIO Y DESPLEGABLE TIPO */
  if (data.view === "acciones"){
    const box = document.createElement("div");
    box.innerHTML = `
      <div class="table-toolbar" style="justify-content:flex-end;">
        <strong style="margin-right:auto;">Acciones</strong>
        ${editable ? `<button class="tiny-btn" data-act="cen-add-accion">+ Acci√≥n</button>` : ``}
      </div>
    `;
    const table = document.createElement("table");
    table.className = "table-like";
    table.innerHTML = `
      <thead>
        <tr>
          <th>Tipo de acci√≥n</th>
          <th>Fecha</th>
          <th>Derivaciones</th>
          <th>Citas</th>
          <th>Ventas</th>
          <th>Observaciones</th>
          ${editable ? `<th></th>`:""}
        </tr>
      </thead>
      <tbody>
        ${(c.acciones||[]).map((a,i)=>`
          <tr data-row="${i}" data-table="acciones">
            <td>
              ${editable ? `
                <select data-cen-acc="tipo" data-row="${i}">
                  ${ACTION_TYPES.map(opt=>`<option value="${opt}" ${a.tipo===opt?"selected":""}>${opt}</option>`).join("")}
                </select>
              ` : (a.tipo||"")}
            </td>
            <td>
              ${makeDateInput(a.fecha||"", editable?`data-cen-acc="fecha" data-row="${i}"`:"disabled")}
            </td>
            <td><input ${editable?"":"disabled"} data-cen-acc="derivaciones" data-row="${i}" value="${a.derivaciones||""}" style="width:70px;"></td>
            <td><input ${editable?"":"disabled"} data-cen-acc="citas" data-row="${i}" value="${a.citas||""}" style="width:70px;"></td>
            <td><input ${editable?"":"disabled"} data-cen-acc="ventas" data-row="${i}" value="${a.ventas||""}" style="width:70px;"></td>
            <td><input ${editable?"":"disabled"} data-cen-acc="obs" data-row="${i}" value="${a.obs||""}" style="width:100%;"></td>
            ${editable ? `<td><button class="ghost-icon" data-act="cen-del-accion" data-row="${i}">‚àí</button></td>`:""}
          </tr>
        `).join("")}
      </tbody>
    `;
    box.appendChild(table);
    cont.appendChild(box);
  }

  /* VISTA FORMACIONES (se queda como estaba) */
  if (data.view === "formaciones"){
    const box = document.createElement("div");
    box.innerHTML = `
      <div class="table-toolbar" style="justify-content:flex-end;">
        <strong style="margin-right:auto;">Formaciones y refuerzo</strong>
        ${editable ? `<button class="tiny-btn" data-act="cen-add-forma">+ Formaci√≥n</button>`:""}
      </div>
    `;
    const table = document.createElement("table");
    table.className = "table-like";
    table.innerHTML = `
      <thead><tr><th>Curso relevante</th><th>Superado</th><th>Aplicado</th><th>Mentoring-Coaching</th>${editable?`<th></th>`:""}</tr></thead>
      <tbody>
        ${(c.formaciones||[]).map((f,i)=>`
          <tr data-row="${i}" data-table="formaciones">
            <td contenteditable="${editable}">${f.curso||""}</td>
            <td contenteditable="${editable}">${f.superado||"No"}</td>
            <td contenteditable="${editable}">${f.aplicado||"No"}</td>
            <td contenteditable="${editable}">${f.mentoring||"No"}</td>
            ${editable?`<td><button class="ghost-icon" data-act="cen-del-row">‚àí</button></td>`:""}
          </tr>
        `).join("")}
      </tbody>
    `;
    box.appendChild(table);
    cont.appendChild(box);
  }

  /* VISTA VISITAS (la tuya, con colores) */
  if (data.view === "visitas"){
    const box = document.createElement("div");
    box.innerHTML = `
      <div class="table-toolbar" style="justify-content:flex-end;">
        <strong style="margin-right:auto;">Visitas</strong>
        ${editable ? `<button class="tiny-btn" data-act="cen-add-visita">+ Visita</button>`:""}
      </div>
    `;
    const table = document.createElement("table");
    table.className = "table-like";
    table.innerHTML = `
      <thead><tr><th>Fecha</th><th>Checklist %</th><th>Estado</th><th>Conv. prueba %</th><th>Conv. venta %</th>${editable?`<th></th>`:""}</tr></thead>
      <tbody>
        ${(c.visitas||[]).map((v,i)=>{
          const malo = Number(v.checklist||0) < 85;
          const estado = malo ? '<span class="badge-bad">ROJO</span>' : '<span class="badge-ok">VERDE</span>';
          const pruebaMala = Number(v.convPrueba||0) < 80;
          const ventaMala = Number(v.convVenta||0) < 80;
          return `
            <tr data-row="${i}" data-table="visitas">
              <td>${makeDateInput(v.fecha||"", editable?`data-cen-vis="fecha" data-row="${i}"`:"disabled")}</td>
              <td><input ${editable?"":"disabled"} data-cen-vis="checklist" data-row="${i}" value="${v.checklist||""}" style="width:70px; background:${malo?"#ffe1e1":"#d4f2dc"};"></td>
              <td>${estado}</td>
              <td><input ${editable?"":"disabled"} data-cen-vis="convPrueba" data-row="${i}" value="${v.convPrueba||""}" style="width:70px; background:${pruebaMala?"#ffe1e1":"#d4f2dc"};"></td>
              <td><input ${editable?"":"disabled"} data-cen-vis="convVenta" data-row="${i}" value="${v.convVenta||""}" style="width:70px; background:${ventaMala?"#ffe1e1":"#d4f2dc"};"></td>
              ${editable?`<td><button class="ghost-icon" data-act="cen-del-visita" data-row="${i}">‚àí</button></td>`:""}
            </tr>
          `;
        }).join("")}
      </tbody>
    `;
    box.appendChild(table);
    cont.appendChild(box);
  }

  /* VISTA SERVICIOS (la que te faltaba) */
  if (data.view === "servicios"){
    const box = document.createElement("div");
    box.innerHTML = `
      <div class="table-toolbar" style="justify-content:flex-end;">
        <strong style="margin-right:auto;">Servicios</strong>
      </div>
    `;
    const table = document.createElement("table");
    table.className = "table-like";
    table.innerHTML = `
      <thead><tr><th>Servicio</th><th>¬øDisponible?</th><th>Ventas</th></tr></thead>
      <tbody>
        ${(c.servicios||[]).map((s,i)=>`
          <tr data-row="${i}" data-table="servicios">
            <td>${s.nombre}</td>
            <td>
              ${editable ? `
                <select data-cen-serv="tiene" data-row="${i}" style="background:${s.tiene==="S√≠"?"#d4f2dc":"#ffe1e1"};">
                  <option value="S√≠" ${s.tiene==="S√≠"?"selected":""}>S√≠</option>
                  <option value="No" ${s.tiene!=="S√≠"?"selected":""}>No</option>
                </select>
              ` : s.tiene||"No"}
            </td>
            <td><input ${editable?"":"disabled"} data-cen-serv="ventas" data-row="${i}" value="${s.ventas||""}" style="width:80px;"></td>
          </tr>
        `).join("")}
      </tbody>
    `;
    box.appendChild(table);
    cont.appendChild(box);
  }

  right.appendChild(cont);
  wrap.appendChild(right);
  contentHolder.appendChild(wrap);
}

/* FORMACIONES Y MENTORING: como en tu captura (delegados + tabla) */
function renderFormaciones(data){
  contentHolder.innerHTML = "";
  const wrap = document.createElement("div");
  wrap.className = "flex-form-vis";

  const left = document.createElement("div");
  left.className = "delegados-panel";
  left.innerHTML = `
    <div class="delegados-header">
      <strong>Delegados</strong>
      ${editable ? `<span>
        <button class="tiny-btn" data-act="form-delg-add">+</button>
        <button class="tiny-btn" data-act="form-delg-del">‚àí</button>
        <button class="tiny-btn" data-act="form-delg-save">Guardar</button>
      </span>` : ``}
    </div>
  `;
  (data.delegados||[]).forEach((d,i)=>{
    const it = document.createElement("div");
    it.className = "delegado-item " + (i===(data.selected||0)?"active":"");
    it.dataset.act = "form-delg-select";
    it.dataset.idx = i;
    it.innerHTML = `<span>${d.nombre||("Delegado "+(i+1))}</span>${editable?`<button data-act="form-delg-rename" data-idx="${i}">‚úè</button>`:""}`;
    left.appendChild(it);
  });
  wrap.appendChild(left);

  const right = document.createElement("div");
  right.style.flex = "1";

  const sel = data.selected || 0;
  const del = data.delegados[sel] || { nombre:"", filas:[], adjunto:"" };

  const top = document.createElement("div");
  top.className = "table-toolbar";
  top.style.justifyContent = "flex-end";
  top.innerHTML = `
    <strong style="margin-right:auto;">Formaciones del delegado</strong>
    ${editable ? `<button class="tiny-btn" data-act="form-row-add">+ Fila</button>`:""}
    <label style="font-size:.7rem;cursor:pointer;">${del.adjunto?("üìé "+del.adjunto):"üìé Adjuntar Excel"}<input type="file" data-act="form-adj" style="display:none;"></label>
    ${editable ? `<button class="tiny-btn" data-act="form-save">Guardar</button>`:""}
  `;
  right.appendChild(top);

  const table = document.createElement("table");
  table.className = "table-like";
  table.innerHTML = `
    <thead>
      <tr>
        <th style="width:120px;">Fecha</th>
        <th style="min-width:190px;">Centros</th>
        <th style="width:120px;">Suc./Franq.</th>
        <th>Tema formaci√≥n</th>
        <th style="width:90px;">Superado</th>
        <th style="width:90px;">Aplicado</th>
        <th style="width:90px;">Mentoring</th>
        <th>Observaciones</th>
        ${editable?`<th style="width:40px;"></th>`:""}
      </tr>
    </thead>
    <tbody>
      ${(del.filas||[]).map((f,i)=>`
        <tr data-row="${i}">
          <td>${makeDateInput(f.fecha||"", editable?`data-form="fecha" data-row="${i}"`:"disabled")}</td>
          <td><input ${editable?"":"disabled"} data-form="centros" data-row="${i}" value="${f.centros||""}" style="width:100%;"></td>
          <td>
            <select ${editable?"":"disabled"} data-form="sucursal" data-row="${i}">
              <option value="Sucursal" ${f.sucursal==="Sucursal"?"selected":""}>Sucursal</option>
              <option value="Franquicia" ${f.sucursal==="Franquicia"?"selected":""}>Franquicia</option>
            </select>
          </td>
          <td><input ${editable?"":"disabled"} data-form="tema" data-row="${i}" value="${f.tema||""}" style="width:100%;"></td>
          <td>
            <select ${editable?"":"disabled"} data-form="superado" data-row="${i}">
              <option value="S√≠" ${f.superado==="S√≠"?"selected":""}>S√≠</option>
              <option value="No" ${f.superado!=="S√≠"?"selected":""}>No</option>
            </select>
          </td>
          <td>
            <select ${editable?"":"disabled"} data-form="aplicado" data-row="${i}">
              <option value="S√≠" ${f.aplicado==="S√≠"?"selected":""}>S√≠</option>
              <option value="No" ${f.aplicado!=="S√≠"?"selected":""}>No</option>
            </select>
          </td>
          <td>
            <select ${editable?"":"disabled"} data-form="mentoring" data-row="${i}">
              <option value="No" ${f.mentoring!=="S√≠"?"selected":""}>No</option>
              <option value="S√≠" ${f.mentoring==="S√≠"?"selected":""}>S√≠</option>
            </select>
          </td>
          <td><input ${editable?"":"disabled"} data-form="obs" data-row="${i}" value="${f.obs||""}" style="width:100%;"></td>
          ${editable?`<td><button class="ghost-icon" data-act="form-row-del" data-row="${i}">‚àí</button></td>`:""}
        </tr>
      `).join("")}
    </tbody>
  `;
  right.appendChild(table);

  wrap.appendChild(right);
  contentHolder.appendChild(wrap);
}

/* VISITAS: delegados + tabla, con colores y desplegables, como ten√≠as */
function renderVisitas(data){
  contentHolder.innerHTML = "";
  const wrap = document.createElement("div");
  wrap.className = "flex-form-vis";

  const left = document.createElement("div");
  left.className = "delegados-panel";
  left.innerHTML = `
    <div class="delegados-header">
      <strong>Delegados</strong>
      ${editable?`<span><button class="tiny-btn" data-act="vis-delg-add">+</button><button class="tiny-btn" data-act="vis-delg-del">‚àí</button><button class="tiny-btn" data-act="vis-delg-save">Guardar</button></span>`:""}
    </div>
  `;
  (data.delegados||[]).forEach((d,i)=>{
    const it=document.createElement("div");
    it.className="delegado-item "+(i===(data.selected||0)?"active":"");
    it.dataset.act="vis-delg-select";
    it.dataset.idx=i;
    it.innerHTML=`<span>${d.nombre||("Delegado "+(i+1))}</span>${editable?`<button data-act="vis-delg-rename" data-idx="${i}">‚úè</button>`:""}`;
    left.appendChild(it);
  });
  wrap.appendChild(left);

  const right = document.createElement("div");
  right.style.flex="1";

  const sel = data.selected || 0;
  const del = data.delegados[sel] || { nombre:"", visitas:[], adjunto:"" };

  const top = document.createElement("div");
  top.className="table-toolbar";
  top.style.justifyContent="flex-end";
  top.innerHTML=`
    <strong style="margin-right:auto;">Visitas del delegado</strong>
    ${editable?`<button class="tiny-btn" data-act="vis-row-add">+ Visita</button>`:""}
    <label style="font-size:.7rem;cursor:pointer;">${del.adjunto?("üìé "+del.adjunto):"üìé Adjuntar Excel"}<input type="file" data-act="vis-adj" style="display:none;"></label>
    ${editable?`<button class="tiny-btn" data-act="vis-save">Guardar</button>`:""}
  `;
  right.appendChild(top);

  const table = document.createElement("table");
  table.className="table-like";
  table.innerHTML=`
    <thead>
      <tr>
        <th style="width:120px;">Fecha</th>
        <th style="min-width:200px;">Centros</th>
        <th style="width:110px;">Suc./Franq.</th>
        <th style="width:110px;">Audi√≥logo</th>
        <th style="width:85px;">Checklist %</th>
        <th style="width:70px;">Estado</th>
        <th style="width:95px;">Conv. prueba %</th>
        <th style="width:95px;">Conv. venta %</th>
        <th style="width:80px;">HIT</th>
        <th style="width:80px;">AAR</th>
        <th style="width:95px;">RT-equipo</th>
        <th>Observaciones</th>
        ${editable?`<th style="width:40px;"></th>`:""}
      </tr>
    </thead>
    <tbody>
      ${(del.visitas||[]).map((v,i)=>{
        const malo = Number(v.checklist||0) < 85;
        const estado = malo ? '<span class="badge-bad">ROJO</span>' : '<span class="badge-ok">VERDE</span>';
        const pruebaMala = Number(v.convPrueba||0) < 80;
        const ventaMala = Number(v.convVenta||0) < 80;
        return `
          <tr data-row="${i}">
            <td>${makeDateInput(v.fecha||"", editable?`data-vis="fecha" data-row="${i}"`:"disabled")}</td>
            <td><input ${editable?"":"disabled"} data-vis="centros" data-row="${i}" value="${v.centros||""}" style="width:100%;"></td>
            <td>
              <select ${editable?"":"disabled"} data-vis="sucursal" data-row="${i}">
                <option value="Sucursal" ${v.sucursal==="Sucursal"?"selected":""}>Sucursal</option>
                <option value="Franquicia" ${v.sucursal==="Franquicia"?"selected":""}>Franquicia</option>
              </select>
            </td>
            <td><input ${editable?"":"disabled"} data-vis="audiologo" data-row="${i}" value="${v.audiologo||""}" style="width:100%;"></td>
            <td><input ${editable?"":"disabled"} data-vis="checklist" data-row="${i}" value="${v.checklist||""}" style="width:70px;background:${malo?"#ffe1e1":"#d4f2dc"};"></td>
            <td>${estado}</td>
            <td><input ${editable?"":"disabled"} data-vis="convPrueba" data-row="${i}" value="${v.convPrueba||""}" style="width:70px;background:${pruebaMala?"#ffe1e1":"#d4f2dc"};"></td>
            <td><input ${editable?"":"disabled"} data-vis="convVenta" data-row="${i}" value="${v.convVenta||""}" style="width:70px;background:${ventaMala?"#ffe1e1":"#d4f2dc"};"></td>
            <td>
              <select ${editable?"":"disabled"} data-vis="hit" data-row="${i}" style="background:${v.hit==="S√≠"?"#d4f2dc":"#ffe1e1"};">
                <option value="S√≠" ${v.hit==="S√≠"?"selected":""}>S√≠</option>
                <option value="No" ${v.hit!=="S√≠"?"selected":""}>No</option>
              </select>
            </td>
            <td>
              <select ${editable?"":"disabled"} data-vis="aar" data-row="${i}" style="background:${v.aar==="S√≠"?"#d4f2dc":"#ffe1e1"};">
                <option value="S√≠" ${v.aar==="S√≠"?"selected":""}>S√≠</option>
                <option value="No" ${v.aar!=="S√≠"?"selected":""}>No</option>
              </select>
            </td>
            <td>
              <select ${editable?"":"disabled"} data-vis="rt" data-row="${i}" style="background:${v.rt==="S√≠"?"#d4f2dc":"#ffe1e1"};">
                <option value="S√≠" ${v.rt==="S√≠"?"selected":""}>S√≠</option>
                <option value="No" ${v.rt!=="S√≠"?"selected":""}>No</option>
              </select>
            </td>
            <td><input ${editable?"":"disabled"} data-vis="obs" data-row="${i}" value="${v.obs||""}" style="width:100%;"></td>
            ${editable?`<td><button class="ghost-icon" data-act="vis-row-del" data-row="${i}">‚àí</button></td>`:""}
          </tr>
        `;
      }).join("")}
    </tbody>
  `;
  right.appendChild(table);

  wrap.appendChild(right);
  contentHolder.appendChild(wrap);
}

function render(){
  const data = blocks[currentBlock];
  badgeColor.style.background = data.color || "#fff";
  sectionTitle.textContent = currentBlock;
  if (!editable) contentWrap.classList.add("locked"); else contentWrap.classList.remove("locked");

  if (currentBlock === "OBJETIVOS") renderObjetivos(data);
  else if (currentBlock === "CENTROS EXCLUSIVOS" || currentBlock === "CENTROS FLOP") renderCentros(currentBlock, data);
  else if (currentBlock === "FORMACIONES Y MENTORING") renderFormaciones(data);
  else if (currentBlock === "VISITAS") renderVisitas(data);
}

contentHolder.addEventListener("click", e=>{
  const t = e.target;

  /* OBJETIVOS */
  if (t.dataset.act==="obj-edit"){
    const idx = +t.dataset.idx;
    const it = blocks["OBJETIVOS"].items[idx];
    const nt = prompt("T√≠tulo", it.titulo||"");
    if (nt!==null) it.titulo=nt;
    const nd = prompt("Detalle", it.detalle||"");
    if (nd!==null) it.detalle=nd;
    const nf = prompt("Fecha", it.fecha||"");
    if (nf!==null) it.fecha=nf;
    persist(); render(); return;
  }
  if (t.dataset.act==="obj-add"){
    blocks["OBJETIVOS"].items.splice(+t.dataset.idx+1,0,{titulo:"Nuevo objetivo",detalle:"",fecha:""});
    persist(); render(); return;
  }
  if (t.dataset.act==="obj-del"){
    blocks["OBJETIVOS"].items.splice(+t.dataset.idx,1);
    persist(); render(); return;
  }

  /* CENTROS */
  if (t.dataset.act==="cen-select"){
    const data = blocks[currentBlock];
    data.selected = parseInt(t.value,10)||0;
    persist(); render(); return;
  }
  if (t.closest(".center-subnav")){
    const btn = t.closest("button[data-sub]");
    if (btn){
      const data = blocks[currentBlock];
      data.view = btn.dataset.sub;
      persist(); render();
    }
    return;
  }
  if (t.dataset.act==="cen-add"){
    const data = blocks[currentBlock];
    data.centers.push({
      nombre: currentBlock==="CENTROS EXCLUSIVOS" ? "Centro exclusivo nuevo":"Centro flop nuevo",
      delegado:"",
      audiologo:"",
      tipo:"Sucursal",
      acciones:[],
      formaciones:[],
      visitas:[],
      servicios:[
        {nombre:"Tinnitus-TRT",tiene:"No",ventas:""},
        {nombre:"Pedi√°trico",tiene:"No",ventas:""},
        {nombre:"AAR",tiene:"No",ventas:""},
        {nombre:"HIT",tiene:"No",ventas:""}
      ]
    });
    data.selected = data.centers.length-1;
    persist(); render(); return;
  }
  if (t.dataset.act==="cen-del"){
    const data = blocks[currentBlock];
    if (data.centers.length===0) return;
    data.centers.splice(data.selected||0,1);
    if (data.selected>0) data.selected--;
    persist(); render(); return;
  }
  if (t.dataset.act==="cen-rename"){
    const data = blocks[currentBlock];
    const c = data.centers[data.selected||0];
    const nv = prompt("Nombre del centro:", c.nombre||"");
    if (nv!==null){ c.nombre = nv.trim(); persist(); render(); }
    return;
  }
  if (t.dataset.act==="cen-save"){ persist(); alert("Centros guardados"); return; }

  if (t.dataset.act==="cen-add-accion"){
    const data = blocks[currentBlock];
    const c = data.centers[data.selected||0];
    c.acciones.push({ tipo:"Azafata", fecha:"", derivaciones:"", citas:"", ventas:"", obs:"" });
    persist(); render(); return;
  }
  if (t.dataset.act==="cen-del-accion"){
    const data = blocks[currentBlock];
    const c = data.centers[data.selected||0];
    c.acciones.splice(+t.dataset.row,1);
    persist(); render(); return;
  }
  if (t.dataset.act==="cen-add-forma"){
    const data = blocks[currentBlock];
    const c = data.centers[data.selected||0];
    c.formaciones.push({curso:"",superado:"No",aplicado:"No",mentoring:"No"});
    persist(); render(); return;
  }
  if (t.dataset.act==="cen-del-row"){
    const data = blocks[currentBlock];
    const c = data.centers[data.selected||0];
    c.formaciones.splice(+t.closest("tr").dataset.row,1);
    persist(); render(); return;
  }
  if (t.dataset.act==="cen-add-visita"){
    const data = blocks[currentBlock];
    const c = data.centers[data.selected||0];
    c.visitas.push({fecha:"",checklist:"",convPrueba:"",convVenta:""});
    persist(); render(); return;
  }
  if (t.dataset.act==="cen-del-visita"){
    const data = blocks[currentBlock];
    const c = data.centers[data.selected||0];
    c.visitas.splice(+t.dataset.row,1);
    persist(); render(); return;
  }

  /* FORMACIONES delegados */
  if (t.dataset.act==="form-delg-select"){
    blocks["FORMACIONES Y MENTORING"].selected = +t.dataset.idx;
    persist(); render(); return;
  }
  if (t.dataset.act==="form-delg-add"){
    const d = blocks["FORMACIONES Y MENTORING"];
    d.delegados.push({nombre:"Delegado nuevo",filas:[],adjunto:""});
    d.selected = d.delegados.length-1;
    persist(); render(); return;
  }
  if (t.dataset.act==="form-delg-del"){
    const d = blocks["FORMACIONES Y MENTORING"];
    if (d.delegados.length===0) return;
    d.delegados.splice(d.selected||0,1);
    if (d.selected>0) d.selected--;
    persist(); render(); return;
  }
  if (t.dataset.act==="form-delg-rename"){
    const d = blocks["FORMACIONES Y MENTORING"];
    const idx = +t.dataset.idx;
    const nv = prompt("Nombre del delegado:", d.delegados[idx].nombre||"");
    if (nv!==null){ d.delegados[idx].nombre = nv.trim(); persist(); render(); }
    return;
  }
  if (t.dataset.act==="form-row-add"){
    const d = blocks["FORMACIONES Y MENTORING"];
    const del = d.delegados[d.selected||0];
    del.filas.push({ fecha:"", centros:"", sucursal:"Sucursal", tema:"", superado:"No", aplicado:"No", mentoring:"No", obs:"" });
    persist(); render(); return;
  }
  if (t.dataset.act==="form-row-del"){
    const d = blocks["FORMACIONES Y MENTORING"];
    const del = d.delegados[d.selected||0];
    del.filas.splice(+t.dataset.row,1);
    persist(); render(); return;
  }
  if (t.dataset.act==="form-save" || t.dataset.act==="form-delg-save"){
    persist(); alert("Formaciones guardadas"); return;
  }

  /* VISITAS delegados */
  if (t.dataset.act==="vis-delg-select"){
    blocks["VISITAS"].selected = +t.dataset.idx;
    persist(); render(); return;
  }
  if (t.dataset.act==="vis-delg-add"){
    const v = blocks["VISITAS"];
    v.delegados.push({ nombre:"Delegado nuevo", visitas:[], adjunto:"" });
    v.selected = v.delegados.length-1;
    persist(); render(); return;
  }
  if (t.dataset.act==="vis-delg-del"){
    const v = blocks["VISITAS"];
    if (v.delegados.length===0) return;
    v.delegados.splice(v.selected||0,1);
    if (v.selected>0) v.selected--;
    persist(); render(); return;
  }
  if (t.dataset.act==="vis-delg-rename"){
    const v = blocks["VISITAS"];
    const idx = +t.dataset.idx;
    const nv = prompt("Nombre del delegado:", v.delegados[idx].nombre||"");
    if (nv!==null){ v.delegados[idx].nombre = nv.trim(); persist(); render(); }
    return;
  }
  if (t.dataset.act==="vis-row-add"){
    const v = blocks["VISITAS"];
    const del = v.delegados[v.selected||0];
    del.visitas.push({ fecha:"", centros:"", sucursal:"Sucursal", audiologo:"", checklist:"", convPrueba:"", convVenta:"", hit:"No", aar:"No", rt:"No", obs:"" });
    persist(); render(); return;
  }
  if (t.dataset.act==="vis-row-del"){
    const v = blocks["VISITAS"];
    const del = v.delegados[v.selected||0];
    del.visitas.splice(+t.dataset.row,1);
    persist(); render(); return;
  }
  if (t.dataset.act==="vis-save" || t.dataset.act==="vis-delg-save"){
    persist(); alert("Visitas guardadas"); return;
  }
});

contentHolder.addEventListener("change", e=>{
  const t = e.target;
  /* campos de centros */
  if ((currentBlock==="CENTROS EXCLUSIVOS" || currentBlock==="CENTROS FLOP") && t.dataset.cenField){
    const data = blocks[currentBlock];
    const c = data.centers[data.selected||0];
    c[t.dataset.cenField] = t.value;
    persist();
    return;
  }
  /* acciones de centro */
  if (t.dataset.cenAcc){
    const data = blocks[currentBlock];
    const c = data.centers[data.selected||0];
    const row = +t.dataset.row;
    if (!c.acciones[row]) c.acciones[row] = {};
    c.acciones[row][t.dataset.cenAcc] = t.value;
    persist();
    return;
  }
  /* visitas de centro */
  if (t.dataset.cenVis){
    const data = blocks[currentBlock];
    const c = data.centers[data.selected||0];
    const row = +t.dataset.row;
    if (!c.visitas[row]) c.visitas[row] = {};
    c.visitas[row][t.dataset.cenVis] = t.value;
    persist();
    return;
  }
  /* servicios de centro */
  if (t.dataset.cenServ){
    const data = blocks[currentBlock];
    const c = data.centers[data.selected||0];
    const row = +t.dataset.row;
    if (!c.servicios[row]) c.servicios[row] = {};
    c.servicios[row][t.dataset.cenServ] = t.value;
    persist();
    return;
  }
  /* formaciones tabla */
  if (t.dataset.form){
    const d = blocks["FORMACIONES Y MENTORING"];
    const del = d.delegados[d.selected||0];
    const row = +t.dataset.row;
    if (!del.filas[row]) del.filas[row]={};
    del.filas[row][t.dataset.form] = t.value;
    persist();
    return;
  }
  /* visitas tabla */
  if (t.dataset.vis){
    const v = blocks["VISITAS"];
    const del = v.delegados[v.selected||0];
    const row = +t.dataset.row;
    if (!del.visitas[row]) del.visitas[row]={};
    del.visitas[row][t.dataset.vis] = t.value;
    persist();
    renderVisitas(v); // para recolorear
    return;
  }
});

contentHolder.addEventListener("input", e=>{
  const t = e.target;
  // formaciones inputs
  if (t.dataset.form){
    const d = blocks["FORMACIONES Y MENTORING"];
    const del = d.delegados[d.selected||0];
    const row = +t.dataset.row;
    if (!del.filas[row]) del.filas[row]={};
    del.filas[row][t.dataset.form] = t.value;
    persist();
    return;
  }
  // visitas inputs
  if (t.dataset.vis){
    const v = blocks["VISITAS"];
    const del = v.delegados[v.selected||0];
    const row = +t.dataset.row;
    if (!del.visitas[row]) del.visitas[row]={};
    del.visitas[row][t.dataset.vis] = t.value;
    persist();
    return;
  }
});

document.getElementById("btnHTML").addEventListener("click", ()=>{
  const blob = new Blob([document.documentElement.outerHTML],{type:"text/html"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="seguimiento-audio-ar.html"; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById("btnPDF").addEventListener("click", ()=>alert("Imprimir > Guardar como PDF"));
document.getElementById("btnXLS").addEventListener("click", ()=>{
  const rows=[["Bloque","Nombre","Detalle","Extra1","Extra2"]];
  Object.keys(blocks).forEach(bn=>{
    const b=blocks[bn];
    if (bn==="CENTROS EXCLUSIVOS" || bn==="CENTROS FLOP"){
      (b.centers||[]).forEach(c=>{rows.push([bn,c.nombre,c.delegado,c.audiologo,c.tipo]);});
    } else if (bn==="FORMACIONES Y MENTORING"){
      (b.delegados||[]).forEach(d=>{(d.filas||[]).forEach(f=>{rows.push([bn,d.nombre,f.centros,f.tema,f.fecha]);});});
    } else if (bn==="VISITAS"){
      (b.delegados||[]).forEach(d=>{(d.visitas||[]).forEach(v=>{rows.push([bn,d.nombre,v.centros,v.sucursal,v.fecha]);});});
    } else {
      (b.items||[]).forEach(it=>rows.push([bn,it.titulo,it.detalle,it.fecha,""]));
    }
  });
  const csv=rows.map(r=>r.map(v=>`"${(v||"").replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="seguimiento-audio-ar.csv"; a.click();
  URL.revokeObjectURL(url);
});

saveLocalBtn.addEventListener("click", ()=>{ persist(); editStatus.textContent="Guardado local"; setTimeout(()=>{editStatus.textContent=editable?"Edici√≥n activada":"Solo lectura";},2000); });

render();
</script>
</body>
</html>
