<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SEGUIMIENTO-VISITAS AUDIO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet (mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Chart.js (gráficos) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- SheetJS (leer Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Iconos (Font Awesome) -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-S+8Vs2RVr4YFvR9p1tWmZQYx8uX8yGBXvJ8TlatN4vVNyYoP2lV/nuYEM+J1EfrQaKd8t0lUz2Ce/Jb9x6WQ2g=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <style>
    :root {
      --color-bg: #0b0b0d;
      --color-bg-alt: #141418;
      --color-primary: #ff2b45;
      --color-primary-soft: #ff4b5c;
      --color-accent: #ffb347;
      --color-text: #f7f7f7;
      --color-text-soft: #c2c2c2;
      --color-border: #262632;
      --radius-xl: 18px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.45);
      --transition-fast: 0.2s ease;
      --header-height: 70px;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1a1a20 0, #050509 55%, #000 100%);
      color: var(--color-text);
    }

    body {
      overflow: hidden;
    }

    .hidden {
      display: none !important;
    }

    /* --- PANTALLA DE PIN --- */
    #pin-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #ff2b45 0, #050509 60%, #000 100%);
      z-index: 9999;
    }

    .pin-card {
      background: linear-gradient(135deg, rgba(15,15,25,0.9), rgba(0,0,0,0.95));
      border-radius: 26px;
      padding: 32px 40px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255,255,255,0.06);
      max-width: 420px;
      width: 90%;
      text-align: center;
      backdrop-filter: blur(20px);
    }

    .pin-icon {
      font-size: 52px;
      color: var(--color-primary);
      margin-bottom: 10px;
    }

    .pin-title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .pin-subtitle {
      font-size: 0.9rem;
      color: var(--color-text-soft);
      margin-bottom: 24px;
    }

    .pin-input-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      margin-bottom: 16px;
    }

    .pin-input-wrapper input {
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.6);
      color: var(--color-text);
      outline: none;
      min-width: 150px;
      text-align: center;
      font-size: 1rem;
      letter-spacing: 0.1em;
    }

    .pin-input-wrapper input::placeholder {
      color: #555;
    }

    .pin-button {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-soft));
      color: white;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), filter var(--transition-fast);
      box-shadow: 0 14px 30px rgba(255, 43, 69, 0.6);
    }

    .pin-button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 18px 40px rgba(255, 43, 69, 0.85);
    }

    .pin-error {
      min-height: 18px;
      font-size: 0.8rem;
      color: #ff8b9c;
      margin-top: 4px;
    }

    /* --- APP PRINCIPAL --- */
    #app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top left, #20101a 0, #050509 50%, #010106 100%);
    }

    header.app-header {
      height: var(--header-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 22px;
      background: linear-gradient(90deg, #f0002b, #8b001b, #050509);
      border-bottom: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 12px 30px rgba(0,0,0,0.8);
      z-index: 10;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .header-logo {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ff9f9f 0, #ff2b45 40%, #050509 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 20px rgba(255,255,255,0.12);
    }

    .header-logo i {
      font-size: 24px;
      color: #fff;
    }

    .header-title {
      display: flex;
      flex-direction: column;
    }

    .header-title-main {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    .header-title-sub {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.7);
      text-transform: uppercase;
      letter-spacing: 0.18em;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .icon-button {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
      color: #fff;
      position: relative;
    }

    .icon-button:hover {
      background: rgba(0,0,0,0.7);
      border-color: var(--color-accent);
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.7);
    }

    .icon-button i {
      font-size: 15px;
    }

    .icon-button span.tooltip {
      position: absolute;
      bottom: -26px;
      left: 50%;
      transform: translateX(-50%);
      background: #000;
      color: #fff;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-fast), transform var(--transition-fast);
    }

    .icon-button:hover span.tooltip {
      opacity: 1;
      transform: translate(-50%, -2px);
    }

    /* --- CONTENIDO PRINCIPAL --- */
    .app-main {
      flex: 1;
      padding: 14px 18px 18px;
      overflow: auto;
    }

    .app-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 14px;
      min-height: 0;
    }

    @media (max-width: 1100px) {
      .app-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .section {
      background: radial-gradient(circle at top left, #1c141c 0, #090912 45%, #050509 100%);
      border-radius: var(--radius-xl);
      border: 1px solid var(--color-border);
      box-shadow: var(--shadow-soft);
      padding: 12px 12px 14px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      margin-bottom: 8px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--color-text-soft);
    }

    .section-title i {
      color: var(--color-primary-soft);
      font-size: 15px;
    }

    .section-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--color-text-soft);
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.02);
    }

    /* --- REGIONES & MAPA --- */
    .regiones-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 900px) {
      .regiones-layout {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top, #181821 0, #070711 55%, #050509 100%);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.05);
      padding: 10px;
      display: flex;
      flex-direction: column;
      min-height: 0;
      position: relative;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--color-text-soft);
    }

    .card-subtitle {
      font-size: 0.7rem;
      color: #777;
    }

    .map-wrapper {
      flex: 1;
      min-height: 260px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.06);
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .regiones-sidebar {
      gap: 8px;
    }

    .sidebar-group {
      margin-bottom: 8px;
    }

    .label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--color-text-soft);
      margin-bottom: 4px;
    }

    .input {
      width: 100%;
      padding: 7px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(5,5,10,0.9);
      color: var(--color-text);
      font-size: 0.8rem;
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .input::placeholder {
      color: #555;
    }

    .input:focus {
      border-color: var(--color-primary-soft);
      box-shadow: 0 0 0 1px rgba(255,43,69,0.5);
      background: rgba(5,5,10,1);
    }

    .sidebar-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
    }

    .small-text {
      font-size: 0.7rem;
      color: var(--color-text-soft);
    }

    .add-button {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #2ecc71, #00b894);
      color: #fff;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,184,148,0.6);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), filter var(--transition-fast);
    }

    .add-button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 14px 30px rgba(0,184,148,0.8);
    }

    .lista-regiones {
      flex: 1;
      overflow: auto;
      margin-top: 6px;
      border-top: 1px solid rgba(255,255,255,0.05);
      padding-top: 6px;
    }

    .lista-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.76rem;
      padding: 5px 6px;
      border-radius: 10px;
      margin-bottom: 3px;
      background: rgba(255,255,255,0.01);
    }

    .lista-item-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .delegado-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.6);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.12);
    }

    .lista-item-provincia {
      font-weight: 500;
    }

    .lista-item-delegados {
      font-size: 0.7rem;
      color: var(--color-text-soft);
    }

    /* --- CUADRO DE MANDOS --- */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      grid-auto-rows: minmax(180px, 1fr);
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 900px) {
      .dashboard-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .chart-container {
      flex: 1;
      position: relative;
      min-height: 0;
    }

    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .excel-panel {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.75rem;
      margin-bottom: 8px;
      background: rgba(0,0,0,0.35);
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .excel-panel-row {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .excel-panel input[type="file"] {
      font-size: 0.7rem;
    }

    /* --- TOAST --- */
    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      padding: 8px 14px;
      background: rgba(0,0,0,0.9);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      font-size: 0.8rem;
      color: var(--color-text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(8px);
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 999;
    }

    .toast.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .toast i {
      color: var(--color-primary-soft);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #202028;
      border-radius: 999px;
    }
  </style>
</head>
<body>
  <!-- PANTALLA DE PIN -->
  <div id="pin-screen">
    <div class="pin-card">
      <div class="pin-icon">
        <i class="fa-solid fa-headphones"></i>
      </div>
      <div class="pin-title">SEGUIMIENTO-VISITAS AUDIO</div>
      <div class="pin-subtitle">Introduce el PIN de acceso</div>

      <div class="pin-input-wrapper">
        <input
          type="password"
          id="pin-input"
          placeholder="AR4321"
          maxlength="6"
          autocomplete="off"
        />
        <button class="pin-button" id="pin-button">Entrar</button>
      </div>
      <div class="pin-error" id="pin-error"></div>
    </div>
  </div>

  <!-- APLICACIÓN PRINCIPAL -->
  <div id="app" class="hidden">
    <header class="app-header">
      <div class="header-left">
        <div class="header-logo">
          <i class="fa-solid fa-headphones"></i>
        </div>
        <div class="header-title">
          <div class="header-title-main">SEGUIMIENTO-VISITAS AUDIO</div>
          <div class="header-title-sub">Panel de visitas · centros · ventas</div>
        </div>
      </div>

      <div class="header-actions">
        <button class="icon-button" id="btn-save">
          <i class="fa-solid fa-cloud-arrow-up"></i>
          <span class="tooltip">Guardar en nube (local)</span>
        </button>
        <button class="icon-button" id="btn-load">
          <i class="fa-solid fa-cloud-arrow-down"></i>
          <span class="tooltip">Actualizar desde nube (local)</span>
        </button>
        <button class="icon-button" id="btn-print">
          <i class="fa-solid fa-print"></i>
          <span class="tooltip">Imprimir</span>
        </button>
        <button class="icon-button" id="btn-download">
          <i class="fa-solid fa-file-arrow-down"></i>
          <span class="tooltip">Descargar HTML</span>
        </button>
      </div>
    </header>

    <main class="app-main">
      <div class="app-grid">
        <!-- SECCIÓN REGIONES / MAPA / CENTROS -->
        <section class="section" id="section-regiones">
          <div class="section-header">
            <div class="section-title">
              <i class="fa-solid fa-location-dot"></i>
              REGIONES &amp; CENTROS
            </div>
            <div class="section-header-right">
              <span class="badge">Mapa delegados</span>
            </div>
          </div>

          <div class="regiones-layout">
            <!-- MAPA -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Mapa de delegados por provincia</div>
                  <div class="card-subtitle">Colores por delegado regional</div>
                </div>
              </div>
              <div class="map-wrapper">
                <div id="map"></div>
              </div>
            </div>

            <!-- BUSCADORES / LISTADO -->
            <div class="card regiones-sidebar">
              <div class="card-header">
                <div>
                  <div class="card-title">Centros &amp; responsables</div>
                  <div class="card-subtitle">Búsqueda rápida y altas</div>
                </div>
              </div>

              <div class="sidebar-group">
                <div class="label">Buscar centro</div>
                <input
                  type="text"
                  id="search-centro"
                  class="input"
                  placeholder="Nombre de centro / provincia..."
                />
              </div>

              <div class="sidebar-group">
                <div class="label">Buscar delegado</div>
                <input
                  type="text"
                  id="search-delegado"
                  class="input"
                  placeholder="Nombre de delegado..."
                />
              </div>

              <div class="sidebar-actions">
                <div class="small-text">
                  Filtra el mapa en tiempo real por provincia / delegado.
                </div>
                <button class="add-button" id="btn-add-centro">
                  <i class="fa-solid fa-plus"></i>
                  Nuevo centro
                </button>
              </div>

              <div class="lista-regiones" id="lista-regiones">
                <!-- Rellenado por JS con provincias + delegados + color -->
              </div>
            </div>
          </div>
        </section>

        <!-- SECCIÓN CUADRO DE MANDOS -->
        <section class="section" id="section-dashboard">
          <div class="section-header">
            <div class="section-title">
              <i class="fa-solid fa-chart-line"></i>
              CUADRO DE MANDOS
            </div>
            <div class="section-header-right">
              <span class="badge">Visitas · procesos · HIT · AAR</span>
            </div>
          </div>

          <div class="excel-panel">
            <div class="excel-panel-row">
              <span>Vincular datos de checklist (Excel):</span>
              <input
                type="file"
                id="excelChecklist"
                accept=".xlsx"
                multiple
              />
            </div>
            <span class="small-text">
              Sube tus archivos <b>CHECKLIST AUDIO Córners</b> y
              <b>CHECKLIST AUDIO Exclusv</b>. El ejemplo de abajo agrupa por
              criterio y actualiza el gráfico de barras de procesos.
            </span>
          </div>

          <div class="dashboard-grid">
            <!-- BARRAS: APLICACIÓN PROCESOS GENERAL -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">
                    Aplicación de procesos (Checklist)
                  </div>
                  <div class="card-subtitle">
                    Media por criterio de checklist
                  </div>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="chartProcesos"></canvas>
              </div>
            </div>

            <!-- DONUT: APLICACIÓN GENERAL HIT -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Aplicación general HIT</div>
                  <div class="card-subtitle">
                    % centros aplicando protocolo HIT
                  </div>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="chartHIT"></canvas>
              </div>
            </div>

            <!-- DONUT: CAPACITACIÓN SERVICIO AAR -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Capacitación servicio AAR</div>
                  <div class="card-subtitle">
                    % equipos formados en servicio AAR
                  </div>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="chartAAR"></canvas>
              </div>
            </div>

            <!-- RADAR: VENTAS / FORMACIONES / DINAMIZACIONES -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Indicadores clave</div>
                  <div class="card-subtitle">
                    Ventas · formaciones · dinamizaciones (% objetivo)
                  </div>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="chartRadar"></canvas>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast">
    <i class="fa-solid fa-circle-info"></i>
    <span id="toast-text"></span>
  </div>

  <script>
    /* ===========================
       LÓGICA PANTALLA PIN
    ============================ */
    const PIN_CODE = "AR4321";
    const pinScreen = document.getElementById("pin-screen");
    const app = document.getElementById("app");
    const pinInput = document.getElementById("pin-input");
    const pinButton = document.getElementById("pin-button");
    const pinError = document.getElementById("pin-error");

    function checkPin() {
      const value = pinInput.value.trim();
      if (value === PIN_CODE) {
        pinScreen.classList.add("hidden");
        app.classList.remove("hidden");
      } else {
        pinError.textContent = "PIN incorrecto. Vuelve a intentarlo.";
        pinInput.focus();
      }
    }

    pinButton.addEventListener("click", checkPin);
    pinInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") checkPin();
    });

    /* ===========================
       TOAST
    ============================ */
    const toastEl = document.getElementById("toast");
    const toastTextEl = document.getElementById("toast-text");
    let toastTimeout = null;

    function showToast(message) {
      toastTextEl.textContent = message;
      toastEl.classList.add("visible");
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toastEl.classList.remove("visible");
      }, 2600);
    }

    /* ===========================
       BOTONES CABECERA
    ============================ */
    document.getElementById("btn-print").addEventListener("click", () => {
      window.print();
    });

    document.getElementById("btn-download").addEventListener("click", () => {
      try {
        const html = document.documentElement.outerHTML;
        const blob = new Blob([html], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "seguimiento-visitas-audio.html";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast("Descarga de HTML iniciada.");
      } catch (e) {
        console.error(e);
        showToast("No se pudo generar el HTML.");
      }
    });

    const STORAGE_KEY = "seguimiento-visitas-audio";

    document.getElementById("btn-save").addEventListener("click", () => {
      try {
        const filtros = {
          centro: document.getElementById("search-centro").value || "",
          delegado: document.getElementById("search-delegado").value || "",
        };

        const payload = {
          timestamp: new Date().toISOString(),
          filtros,
          charts: {
            procesos: chartProcesos ? chartProcesos.data : null,
            hit: chartHIT ? chartHIT.data : null,
            aar: chartAAR ? chartAAR.data : null,
            radar: chartRadar ? chartRadar.data : null,
          },
        };

        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        showToast("Datos guardados en nube local (navegador).");
      } catch (e) {
        console.error(e);
        showToast("Error al guardar datos.");
      }
    });

    document.getElementById("btn-load").addEventListener("click", () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          showToast("No hay datos guardados aún.");
          return;
        }
        const payload = JSON.parse(raw);
        if (payload.filtros) {
          document.getElementById("search-centro").value =
            payload.filtros.centro || "";
          document.getElementById("search-delegado").value =
            payload.filtros.delegado || "";
          filtrarMapa();
        }

        if (payload.charts && payload.charts.procesos && chartProcesos) {
          chartProcesos.data = payload.charts.procesos;
          chartProcesos.update();
        }
        if (payload.charts && payload.charts.hit && chartHIT) {
          chartHIT.data = payload.charts.hit;
          chartHIT.update();
        }
        if (payload.charts && payload.charts.aar && chartAAR) {
          chartAAR.data = payload.charts.aar;
          chartAAR.update();
        }
        if (payload.charts && payload.charts.radar && chartRadar) {
          chartRadar.data = payload.charts.radar;
          chartRadar.update();
        }

        showToast("Datos cargados desde nube local.");
      } catch (e) {
        console.error(e);
        showToast("Error al cargar datos.");
      }
    });

    /* ===========================
       MAPA DELEGADOS (LEAFLET)
       Datos integrados desde el HTML de mapa original
    ============================ */

    // Datos de provincias / delegados (extraídos del mapa que enviaste)
    const markersData = [
      {"provincia": "A CORUÑA", "delegados": ["Manuel Cánovas", "Marisa Carmona"], "lat": 43.3623, "lon": -8.4115},
      {"provincia": "ALBACETE", "delegados": ["Manuel Cánovas"], "lat": 38.9941, "lon": -1.8589},
      {"provincia": "ALICANTE", "delegados": ["Manuel Cánovas", "Martin SEBASTIÁN", "Verónica Alfonsín"], "lat": 38.3452, "lon": -0.481},
      {"provincia": "ALMERIA", "delegados": ["LAURA RAMOS", "Maribel Amezcua"], "lat": 36.834, "lon": -2.4637},
      {"provincia": "ASTURIAS", "delegados": ["Cecilia Pérez", "Maribel Amezcua"], "lat": 43.3614, "lon": -5.8593},
      {"provincia": "BADAJOZ", "delegados": ["Cecilia Pérez", "LAURA PLAZAS"], "lat": 38.8794, "lon": -6.9707},
      {"provincia": "BALEARES", "delegados": ["LAURA PLAZAS"], "lat": 39.5696, "lon": 2.6502},
      {"provincia": "BARCELONA", "delegados": ["ENERITZ ARANGUREN", "LAURA PLAZAS", "LAURA RAMOS", "Laura Plazas", "Laura Ramos", "Maribel Amezcua", "Martin SEBASTIÁN", "Sonia Godino"], "lat": 41.3851, "lon": 2.1734},
      {"provincia": "BURGOS", "delegados": ["Martin SEBASTIÁN"], "lat": 42.3439, "lon": -3.6969},
      {"provincia": "CACERES", "delegados": ["Maribel Amezcua", "Sonia Godino"], "lat": 39.4763, "lon": -6.3727},
      {"provincia": "CADIZ", "delegados": ["Sergio Perán"], "lat": 36.5271, "lon": -6.2886},
      {"provincia": "CANTABRIA", "delegados": ["Cecilia Pérez", "ENERITZ ARANGUREN", "Marisa Carmona"], "lat": 43.4623, "lon": -3.8099},
      {"provincia": "CASTELLON", "delegados": ["ENERITZ ARANGUREN", "Laura Plazas", "Marisa Carmona", "Martin SEBASTIÁN"], "lat": 39.9864, "lon": -0.0513},
      {"provincia": "CORDOBA", "delegados": ["ENERITZ ARANGUREN", "Martin SEBASTIÁN"], "lat": 37.8882, "lon": -4.7794},
      {"provincia": "CUENCA", "delegados": ["Maribel Amezcua"], "lat": 40.0704, "lon": -2.1374},
      {"provincia": "GIRONA", "delegados": ["Maribel Amezcua", "SONIA GODINO", "Sonia Godino"], "lat": 41.9794, "lon": 2.8214},
      {"provincia": "GRANADA", "delegados": ["ENERITZ ARANGUREN", "SONIA GODINO", "Sonia Godino"], "lat": 37.1773, "lon": -3.5986},
      {"provincia": "GUIPUZCOA", "delegados": ["Daniel Chazo", "Martin SEBASTIÁN"], "lat": 43.3128, "lon": -1.974},
      {"provincia": "HUESCA", "delegados": ["Daniel Chazo"], "lat": 42.1362, "lon": -0.4089},
      {"provincia": "JAEN", "delegados": ["Daniel Chazo", "Verónica Alfonsín"], "lat": 37.7796, "lon": -3.7849},
      {"provincia": "LA RIOJA", "delegados": ["SONIA GODINO"], "lat": 42.2871, "lon": -2.5396},
      {"provincia": "LAS PALMAS", "delegados": ["Blanca Fdez. de la Pradilla"], "lat": 28.1235, "lon": -15.4363},
      {"provincia": "LLEIDA", "delegados": ["ENERITZ ARANGUREN", "LAURA PLAZAS"], "lat": 41.6176, "lon": 0.62},
      {"provincia": "LUGO", "delegados": ["Daniel Chazo"], "lat": 43.0125, "lon": -7.555},
      {"provincia": "MADRID", "delegados": ["Blanca Fdez. de la Pradilla", "LAURA RAMOS", "Laura RAMOS", "Marisa Carmona", "Sergio Perán"], "lat": 40.4168, "lon": -3.7038},
      {"provincia": "MALAGA", "delegados": ["Maribel Amezcua", "Martin SEBASTIÁN"], "lat": 36.7213, "lon": -4.4214},
      {"provincia": "MURCIA", "delegados": ["Manuel Cánovas"], "lat": 37.9922, "lon": -1.1307},
      {"provincia": "NAVARRA", "delegados": ["Sonia Godino"], "lat": 42.6954, "lon": -1.6761},
      {"provincia": "OURENSE", "delegados": ["Daniel Chazo"], "lat": 42.3358, "lon": -7.8639},
      {"provincia": "PONTEVEDRA", "delegados": ["Cecilia Pérez", "ENERITZ ARANGUREN", "Manuel Cánovas", "Verónica Alfonsín"], "lat": 42.4337, "lon": -8.6481},
      {"provincia": "SALAMANCA", "delegados": ["Sergio Perán"], "lat": 40.9701, "lon": -5.6635},
      {"provincia": "SEVILLA", "delegados": ["Maribel Amezcua", "Sergio Perán"], "lat": 37.3891, "lon": -5.9845},
      {"provincia": "SORIA", "delegados": ["ENERITZ ARANGUREN"], "lat": 41.7662, "lon": -2.479},
      {"provincia": "TARRAGONA", "delegados": ["Cecilia Pérez", "ENERITZ ARANGUREN", "LAURA PLAZAS"], "lat": 41.1189, "lon": 1.2445},
      {"provincia": "TENERIFE", "delegados": ["Blanca Fdez. de la Pradilla"], "lat": 28.4636, "lon": -16.2518},
      {"provincia": "TERUEL", "delegados": ["ENERITZ ARANGUREN"], "lat": 40.3456, "lon": -1.1065},
      {"provincia": "TOLEDO", "delegados": ["Marisa Carmona"], "lat": 39.8628, "lon": -4.0273},
      {"provincia": "VALENCIA", "delegados": ["Cecilia Pérez", "Marisa Carmona"], "lat": 39.4699, "lon": -0.3763},
      {"provincia": "VALLADOLID", "delegados": ["Daniel Chazo"], "lat": 41.6523, "lon": -4.7245},
      {"provincia": "VIZCAYA", "delegados": ["SONIA GODINO", "Sonia Godino"], "lat": 43.263, "lon": -2.935},
      {"provincia": "ZAMORA", "delegados": ["Blanca Fdez. de la Pradilla"], "lat": 41.5035, "lon": -5.7445},
      {"provincia": "ZARAGOZA", "delegados": ["ENERITZ ARANGUREN"], "lat": 41.6488, "lon": -0.8891}
    ];

    let mapInstance = null;
    const marcadorLayers = [];
    const delegadoColors = {};
    const colorPalette = [
      "#ff4b5c",
      "#ffb347",
      "#4ecca3",
      "#1e90ff",
      "#9b59b6",
      "#2ecc71",
      "#e67e22",
      "#e84393",
      "#00cec9",
      "#fdcb6e",
      "#e74c3c",
      "#16a085"
    ];
    let colorIndex = 0;

    function normalizarDelegado(nombre) {
      if (!nombre) return "";
      return nombre.trim().toLowerCase().replace(/\s+/g, " ");
    }

    function getColorDelegado(nombre) {
      const key = normalizarDelegado(nombre);
      if (!delegadoColors[key]) {
        delegadoColors[key] = colorPalette[colorIndex % colorPalette.length];
        colorIndex++;
      }
      return delegadoColors[key];
    }

    function inicializarMapa() {
      mapInstance = L.map("map").setView([40.3, -3.7], 6);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(mapInstance);

      const listaRegiones = document.getElementById("lista-regiones");
      listaRegiones.innerHTML = "";

      markersData.forEach((m) => {
        const principal = m.delegados && m.delegados.length ? m.delegados[0] : "Sin delegado";
        const color = getColorDelegado(principal);

        const delegadosList = (m.delegados || [])
          .map((d) => "- " + d)
          .join("<br/>");

        const popup =
          "<b>" +
          m.provincia +
          "</b><br/><br/><b>Delegado(s):</b><br/>" +
          delegadosList;

        const circle = L.circleMarker([m.lat, m.lon], {
          radius: 8,
          fillColor: color,
          color: "#ffffff",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.9
        }).addTo(mapInstance);

        circle.bindPopup(popup);

        marcadorLayers.push({
          layer: circle,
          provincia: m.provincia,
          delegados: m.delegados || [],
          color
        });

        // Lista lateral
        const item = document.createElement("div");
        item.className = "lista-item";

        const left = document.createElement("div");
        left.className = "lista-item-left";

        const dot = document.createElement("div");
        dot.className = "delegado-dot";
        dot.style.background = color;

        const provSpan = document.createElement("span");
        provSpan.className = "lista-item-provincia";
        provSpan.textContent = m.provincia;

        const delSpan = document.createElement("span");
        delSpan.className = "lista-item-delegados";
        delSpan.textContent = (m.delegados || []).join(" · ");

        left.appendChild(dot);
        left.appendChild(provSpan);

        item.appendChild(left);
        item.appendChild(delSpan);

        item.addEventListener("click", () => {
          mapInstance.setView([m.lat, m.lon], 7);
          circle.openPopup();
        });

        listaRegiones.appendChild(item);
      });
    }

    function filtrarMapa() {
      const searchCentro = document
        .getElementById("search-centro")
        .value.trim()
        .toLowerCase();
      const searchDelegado = document
        .getElementById("search-delegado")
        .value.trim()
        .toLowerCase();

      marcadorLayers.forEach((m) => {
        const provinciaMatch =
          !searchCentro ||
          (m.provincia && m.provincia.toLowerCase().includes(searchCentro));

        // Aquí podrías enlazar "centros" cuando vengan de Excel
        const centroMatch = provinciaMatch;

        const delegadosStr = (m.delegados || []).join(" ").toLowerCase();
        const delegadoMatch =
          !searchDelegado || delegadosStr.includes(searchDelegado);

        const visible = centroMatch && delegadoMatch;

        if (visible) {
          if (!mapInstance.hasLayer(m.layer)) {
            m.layer.addTo(mapInstance);
          }
        } else {
          if (mapInstance.hasLayer(m.layer)) {
            mapInstance.removeLayer(m.layer);
          }
        }
      });
    }

    document
      .getElementById("search-centro")
      .addEventListener("input", filtrarMapa);
    document
      .getElementById("search-delegado")
      .addEventListener("input", filtrarMapa);

    document.getElementById("btn-add-centro").addEventListener("click", () => {
      const provincia = window.prompt("Provincia del nuevo centro:");
      if (!provincia) return;
      const delegado = window.prompt("Delegado responsable:");
      if (!delegado) return;
      showToast(
        "Nuevo centro en " +
          provincia +
          " con delegado " +
          delegado +
          " (pendiente de geolocalización fina y guardado real)."
      );
      // Aquí podríamos abrir un formulario completo y añadirlo a markersData + Excel
    });

    /* ===========================
       GRÁFICOS (Chart.js)
    ============================ */
    let chartProcesos = null;
    let chartHIT = null;
    let chartAAR = null;
    let chartRadar = null;

    function inicializarGraficos() {
      const ctxProcesos = document
        .getElementById("chartProcesos")
        .getContext("2d");
      const ctxHIT = document.getElementById("chartHIT").getContext("2d");
      const ctxAAR = document.getElementById("chartAAR").getContext("2d");
      const ctxRadar = document.getElementById("chartRadar").getContext("2d");

      chartProcesos = new Chart(ctxProcesos, {
        type: "bar",
        data: {
          labels: [
            "Recepción paciente",
            "Anamnesis",
            "Pruebas",
            "Informe",
            "Seguimiento"
          ],
          datasets: [
            {
              label: "% aplicación",
              data: [80, 72, 65, 78, 70],
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { stepSize: 20 }
            }
          }
        }
      });

      chartHIT = new Chart(ctxHIT, {
        type: "doughnut",
        data: {
          labels: ["Centros con HIT aplicado", "Pendiente / parcial"],
          datasets: [
            {
              data: [68, 32],
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: { boxWidth: 10 }
            }
          },
          cutout: "60%"
        }
      });

      chartAAR = new Chart(ctxAAR, {
        type: "doughnut",
        data: {
          labels: ["Equipos formados AAR", "Sin formación / parcial"],
          datasets: [
            {
              data: [55, 45],
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: { boxWidth: 10 }
            }
          },
          cutout: "60%"
        }
      });

      chartRadar = new Chart(ctxRadar, {
        type: "radar",
        data: {
          labels: ["Ventas", "Formaciones", "Dinamizaciones"],
          datasets: [
            {
              label: "Objetivo",
              data: [100, 100, 100],
              borderWidth: 1,
              borderDash: [4, 4],
              pointRadius: 2
            },
            {
              label: "Real",
              data: [72, 60, 54],
              borderWidth: 1,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: { boxWidth: 10 }
            }
          },
          scales: {
            r: {
              beginAtZero: true,
              max: 100,
              ticks: { stepSize: 20 }
            }
          }
        }
      });
    }

    /* ===========================
       VINCULAR EXCEL (CHECKLIST)
    ============================ */
    const excelInput = document.getElementById("excelChecklist");

    excelInput.addEventListener("change", (event) => {
      const files = Array.from(event.target.files || []);
      if (!files.length) return;

      files.forEach((file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
          actualizarGraficosDesdeChecklist(json);
        };
        reader.readAsArrayBuffer(file);
      });

      showToast(
        "Excel cargado. Actualizando gráfico de procesos (ajusta nombres de columnas si es necesario)."
      );
    });

    // Ejemplo genérico: asume columnas tipo "CRITERIO" y "PUNTUACIÓN"
    function actualizarGraficosDesdeChecklist(rows) {
      if (!rows || !rows.length || !chartProcesos) return;

      const agregados = {};
      rows.forEach((row) => {
        const criterio =
          row["CRITERIO"] ||
          row["Criterio"] ||
          row["criterio"] ||
          row["Proceso"] ||
          row["PROCESO"];
        const rawValor =
          row["PUNTUACIÓN"] ||
          row["Puntuación"] ||
          row["puntuacion"] ||
          row["SCORE"] ||
          row["Score"];
        const valor = Number(rawValor);
        if (!criterio || Number.isNaN(valor)) return;
        if (!agregados[criterio]) {
          agregados[criterio] = { suma: 0, count: 0 };
        }
        agregados[criterio].suma += valor;
        agregados[criterio].count += 1;
      });

      const etiquetas = Object.keys(agregados);
      const valores = etiquetas.map((c) =>
        Math.round(agregados[c].suma / agregados[c].count)
      );

      if (etiquetas.length) {
        chartProcesos.data.labels = etiquetas;
        chartProcesos.data.datasets[0].data = valores;
        chartProcesos.update();
      }
    }

    /* ===========================
       INICIALIZACIÓN GLOBAL
    ============================ */
    window.addEventListener("load", () => {
      inicializarMapa();
      inicializarGraficos();
    });
  </script>
</body>
</html>
