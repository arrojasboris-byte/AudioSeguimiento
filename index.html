<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SEGUIMIENTO AUDIO • Local</title>
<meta name="theme-color" content="#c82727"/>
<style>
/* ===== Diseño compacto tipo “Excel”, todo cabe en pantalla ===== */
:root{
  --rojo:#c82727; --rojo2:#a71f1f; --bg:#f6f7fb; --line:#e4e6ef;
  --ex:#fde2e4; --fl:#e2f0cb; --va:#cde7f0; --fm:#f9e5c9; --ta:#eadcf8; --eq:#e8f1ff;
  --fs:11px; --fs-sm:10px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;font-size:var(--fs);color:#222}

/* Topbar */
.topbar{position:sticky;top:0;z-index:100;background:linear-gradient(180deg,var(--rojo),var(--rojo2));color:#fff;box-shadow:0 6px 14px rgba(0,0,0,.06)}
.topbar-inner{padding:.6rem .6rem;display:grid;grid-template-columns:1fr auto 1fr;gap:.4rem;align-items:center}
.brand{justify-self:center;font-weight:900;letter-spacing:.3px;font-size:20px;display:flex;gap:.4rem;align-items:center}
.btn{border:0;border-radius:10px;padding:.28rem .55rem;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.06);font-weight:800;font-size:10px}
.btn-white{background:#fff;color:#7b0e0e}
.btn-ghost{background:transparent;border:1px solid #ffffff66;color:#fff}
.pill{justify-self:end;display:inline-flex;gap:.32rem;align-items:center;background:#ffffff1a;border:1px solid #ffffff36;padding:.12rem .45rem;border-radius:999px;font-size:10px}

/* Layout */
.main{display:grid;grid-template-columns:210px minmax(0,1fr);gap:6px;padding:6px}
@media (max-width:1100px){.main{grid-template-columns:1fr}}
.sidebar{display:flex;flex-direction:column;gap:6px}
.side{border:1px solid var(--line);background:#fff;border-radius:10px}
.side .head{display:flex;justify-content:space-between;align-items:center;padding:.3rem .36rem;font-weight:900;border-bottom:1px solid var(--line);font-size:10.5px}
.side .list{padding:.25rem .3rem .35rem;max-height:170px;overflow:auto}
.side .btn-mini{border:1px solid var(--line);background:#fff;border-radius:7px;height:20px;width:24px;cursor:pointer;font-size:10px}
.item{display:flex;justify-content:space-between;gap:.3rem;align-items:center;background:#fff;border:1px solid var(--line);border-radius:8px;padding:.24rem .3rem;margin:.18rem 0}
.item .name{font-weight:750;font-size:10.8px}
.act{display:flex;gap:.22rem}
.act .btn-mini{height:18px}

/* Detalle */
.detail{padding:.45rem .45rem;border-radius:8px;border:1px solid var(--line);background:#fff;min-height:68vh;box-shadow:0 4px 14px rgba(0,0,0,.06)}
.header{display:flex;gap:.7rem;align-items:center;margin-bottom:.28rem}
.header h2{margin:0;font-size:15px}
.badge{background:#0000000f;border:1px solid var(--line);padding:.08rem .44rem;border-radius:999px;font-size:10px}
.save{margin-left:auto;border-radius:999px;background:#1f6feb;color:#fff;border:0;font-size:10px;padding:.32rem .6rem;cursor:pointer}

/* Campos & tablas */
.row{display:flex;gap:.3rem;flex-wrap:wrap;align-items:flex-end}
.f{display:grid;gap:.1rem;min-width:120px;flex:1;margin:.14rem 0}
.f label{font-weight:700;opacity:.85;font-size:9.6px}
.f input,.f select,.f textarea{border:1px solid var(--line);border-radius:7px;padding:.14rem .24rem;font-size:var(--fs-sm);background:#fff;outline:none}
.xwrap{border:1px solid var(--line);border-radius:8px;background:#fff;padding:.18rem}
.xscroll{overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;padding-bottom:3px}
.xinner{display:block;width:max-content;min-width:820px}
.scroll{max-height:60vh;overflow:auto}

.grid{display:grid;gap:.1rem;align-items:center;margin:.03rem}
.acc-h,.acc-r{grid-template-columns:28px 90px 64px 200px 80px 70px 70px 240px 30px}
.frm-h,.frm-r{grid-template-columns:28px 1.1fr .5fr .5fr 2fr 30px}
.proc-h,.proc-r{grid-template-columns:28px 120px 120px 54px 60px 96px 96px 160px 1.1fr 80px 30px}
.va-h,.va-r{grid-template-columns:28px .85fr .85fr .9fr 108px 110px 94px 46px 110px 110px}
.fm-h,.fm-r{grid-template-columns:28px 84px 180px 110px 86px 90px 90px 90px 90px 78px 78px}
.ta-h,.ta-r{grid-template-columns:28px 1fr 120px 110px 150px 44px 44px 44px 44px 44px 1.1fr}
.eq-h,.eq-r{grid-template-columns:28px 120px 98px 140px 100px 120px 36px 36px 120px 36px 36px 120px 36px 36px}

/* Estados */
.good{background:#eaf9f0;border:1px solid #caf1d8;border-radius:6px}
.bad{background:#ffe8e8;border:1px solid #f7c9c9;border-radius:6px}
.hit{background:#ffe8e8;border:1px solid #f5caca;border-radius:5px;text-align:center}
.hit.on{background:#e7f6ed;border:1px solid #cdebd9}

/* Avance visitas */
.widget{position:sticky;top:86px;margin-left:auto;width:220px}
.card{background:#fff;border:1px solid var(--line);border-radius:8px;padding:.34rem;box-shadow:0 4px 14px rgba(0,0,0,.06)}
.card .bar{height:6px;background:#e9ecef;border-radius:999px;overflow:hidden}
.card .bar>div{height:100%;background:#1f6feb;width:0%}
</style>
</head>
<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="left">
      <button id="btnLoad"  class="btn btn-ghost" title="Leer de localStorage">Actualizar</button>
      <button id="btnSave"  class="btn btn-white" title="Guardar en localStorage">Guardar</button>
      <button id="btnReset" class="btn btn-ghost" title="Resetear dataset">Resetear</button>
    </div>
    <div class="brand">🎧 SEGUIMIENTO AUDIO</div>
    <div class="pill" id="stamp">Local · listo</div>
  </div>
</header>

<section class="main">
  <!-- ===== Sidebar ===== -->
  <aside class="sidebar">
    <div class="side" id="boxEX" style="background:var(--ex)">
      <div class="head">📒 CENTROS EXCLUSIVOS
        <div class="act"><button class="btn-mini addEX">＋</button></div>
      </div>
      <div class="list" id="listEX"></div>
    </div>

    <div class="side" id="boxFL" style="background:var(--fl)">
      <div class="head">📒 CENTROS FLOP
        <div class="act"><button class="btn-mini addFL">＋</button></div>
      </div>
      <div class="list" id="listFL"></div>
    </div>

    <div class="side" id="boxVA" style="background:var(--va)">
      <div class="head">📋 VISITAS AUDIO
        <div class="act"><button class="btn-mini addVA">＋</button></div>
      </div>
      <div class="list" id="listVA"></div>
    </div>

    <div class="side" id="boxFM" style="background:var(--fm)">
      <div class="head">🎓 FORMACIONES Y MENTORING
        <div class="act"><button class="btn-mini addFM">＋</button></div>
      </div>
      <div class="list" id="listFM"></div>
    </div>

    <div class="side" id="boxTA" style="background:var(--ta)">
      <div class="head">📡 TELEAUDIOLOGIA
        <div class="act"><button class="btn-mini addTA">＋</button></div>
      </div>
      <div class="list" id="listTA"></div>
    </div>

    <div class="side" id="boxEQ" style="background:var(--eq)">
      <div class="head">🧰 EQUIPOS
        <div class="act"><button class="btn-mini addEQ">＋</button></div>
      </div>
      <div class="list" id="listEQ"></div>
    </div>
  </aside>

  <!-- ===== Detalle ===== -->
  <section class="detail" id="detail">
    <div class="header">
      <h2>Detalle — <span id="hdrName">—</span></h2>
      <span class="badge" id="hdrTag">—</span>
      <button class="save" id="btnSavePanel">💾 Guardar panel</button>
    </div>
    <p id="hint" style="opacity:.7;margin:.04rem 0 .22rem">Selecciona un elemento a la izquierda (doble clic o botón ✏️), o crea uno con ＋.</p>

    <!-- Centros -->
    <div id="detCentro" style="display:none">
      <div class="row">
        <div class="f"><label>Nombre</label><input id="cNombre"></div>
        <div class="f"><label>Delegado</label><input id="cDelegado"></div>
        <div class="f"><label>Audiólogo</label><input id="cAud"></div>
        <div class="f"><label>Franquicia/Sucursal</label><select id="cTipo"><option>Franquicia</option><option>Sucursal</option></select></div>
      </div>

      <h4 style="margin:.34rem 0 .14rem">ACCIONES</h4>
      <div class="xwrap">
        <div class="xscroll"><div class="xinner">
          <div class="grid acc-h"><div>#</div><div>Fecha</div><div>Paquete</div><div>Tipo de acción</div><div>Derivación</div><div>Citas</div><div>Ventas</div><div>Observaciones</div><div></div></div>
          <div id="accRows" class="scroll"></div>
        </div></div>
      </div>
      <div style="font-size:10px;margin-top:.12rem">Paquete: 1 Tráfico · 2 Formación y comercial · 3 Equipo</div>

      <h4 style="margin:.4rem 0 .14rem">FORMACIÓN</h4>
      <div class="xwrap">
        <div class="xscroll"><div class="xinner">
          <div class="grid frm-h"><div>#</div><div>Curso</div><div>Realizado</div><div>Aplica</div><div>Observaciones</div><div></div></div>
          <div id="frmRows" class="scroll"></div>
        </div></div>
      </div>

      <h4 style="margin:.4rem 0 .14rem">PROCESOS</h4>
      <div class="xwrap">
        <div class="xscroll"><div class="xinner">
          <div class="grid proc-h">
            <div>#</div><div>Fecha de visita</div><div>Punt. procesos (%)</div><div>HIT</div><div>Pruebas RT</div><div>% Pruebas</div><div>% Venta</div><div>Colaboraciones</div><div>Observaciones</div><div>Adjunto</div><div></div>
          </div>
          <div id="procRows" class="scroll"></div>
        </div></div>
      </div>
    </div>

    <!-- Visitas -->
    <div id="detVisitas" style="display:none;position:relative">
      <div class="widget">
        <div class="card">
          <div style="font-weight:800;font-size:10.5px;margin-bottom:.18rem">Avance de visitas</div>
          <div id="vaCnt" style="font-size:10.5px;margin-bottom:.14rem">0 registradas</div>
          <div class="bar"><div id="vaBar"></div></div>
        </div>
      </div>

      <div class="row" style="margin-bottom:.18rem">
        <div class="f"><label>Visitador de audio</label><select id="vaRol"><option>Delegado audio</option><option>Responsable AAR</option></select></div>
        <div class="f"><label>Nombre</label><input id="vaResp" placeholder="Nombre"></div>
        <div class="f" style="min-width:190px"><label>Buscar centro</label><input id="vaSearch" placeholder="Filtrar…"></div>
      </div>

      <div class="xwrap">
        <div class="xscroll"><div class="xinner">
          <div class="grid va-h"><div>#</div><div>Centro</div><div>Delegado</div><div>Audiólogo</div><div>Tipo</div><div>Fecha visita</div><div>Puntuación (%)</div><div>HIT</div><div>% Conv. prueba</div><div>% Conv. venta</div></div>
          <div id="vaRows" class="scroll"></div>
        </div></div>
      </div>
    </div>

    <!-- Formaciones global -->
    <div id="detFM" style="display:none">
      <div class="row" style="margin-bottom:.18rem">
        <div class="f"><label>Delegado regional</label><input id="fmDel"></div>
        <div class="f" style="min-width:210px"><label>Buscar</label><input id="fmSearch" placeholder="Filtrar por tema o audiólogo…"></div>
      </div>
      <div class="xwrap">
        <div class="xscroll"><div class="xinner">
          <div class="grid fm-h">
            <div>#</div><div>Fecha</div><div>Tema</div><div>Audiólogo</div><div>Duración (sem.)</div>
            <div>% Prueba ini</div><div>% Venta ini</div><div>% Prueba 3m</div><div>% Venta 3m</div><div>Evo. prueba</div><div>Evo. venta</div>
          </div>
          <div id="fmRows" class="scroll"></div>
        </div></div>
      </div>
    </div>

    <!-- Teleaudiología -->
    <div id="detTA" style="display:none">
      <div class="row" style="margin-bottom:.18rem">
        <div class="f" style="min-width:220px"><label>Buscar</label><input id="taSearch" placeholder="Centro o persona…"></div>
        <div class="f" style="min-width:160px"><label>Persona</label><select id="taPerson"><option value="">Todos</option></select></div>
      </div>
      <div class="xwrap">
        <div class="xscroll"><div class="xinner">
          <div class="grid ta-h">
            <div>#</div><div>Centro</div><div>Delegado</div><div>Rol</div><div>Persona</div>
            <div>Form.</div><div>Prác.</div><div>Cert.</div><div>Pruebas</div><div>Ventas</div><div>Observaciones</div>
          </div>
          <div id="taRows" class="scroll"></div>
        </div></div>
      </div>
    </div>

    <!-- Equipos -->
    <div id="detEQ" style="display:none">
      <div class="row" style="margin-bottom:.18rem">
        <div class="f" style="min-width:220px"><label>Buscar</label><input id="eqSearch" placeholder="Equipo, serie, centro o persona…"></div>
        <div class="f"><label>&nbsp;</label>
          <div style="display:flex;gap:.28rem;flex-wrap:wrap">
            <button class="btn btn-ghost" id="eqAddPar">＋ Añadir par</button>
            <button class="btn btn-ghost" id="eqAddRow">＋ Añadir fila</button>
          </div>
        </div>
      </div>

      <div class="xwrap">
        <div class="xscroll"><div class="xinner">
          <div class="grid eq-h">
            <div>#</div><div>Equipo</div><div>Nº serie</div><div>Persona que envía</div><div>Fecha</div>
            <div>Centro 1</div><div>C1</div><div>S1</div><div>Centro 2</div><div>C2</div><div>S2</div><div>Centro 3</div><div>C3</div><div>S3</div>
          </div>
          <div id="eqRows" class="scroll"></div>
        </div></div>
      </div>
    </div>

  </section>
</section>

<script>
/* ===== Util ===== */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const stamp=t=>$('#stamp').textContent=t;

/* ===== Dataset por defecto ===== */
function sheetVA(n){
  const rows=Array.from({length:300},()=>({centro:'',delegado:'',audiologo:'',tipo:'Sucursal',fecha:'',puntuacion:null,hit:false,conv_prueba:null,conv_venta:null}));
  return {nombre:n,rows};
}
function rowsFM(){return Array.from({length:300},()=>({fecha:'',tema:'',audiologo:'',duracion:1,p_ini:null,v_ini:null,p_3m:null,v_3m:null}));}
function sheetTA(n){const rows=Array.from({length:300},()=>({centro:'',delegado:'',rol:'Audiólogo',persona:'',formacion:false,practicas:false,certificado:false,pruebas:false,ventas:false,obs:''}));return{nombre:n,rows};}
function equiposInit(){const filas=Array.from({length:25},()=>({equipo:'',serie:'',persona:'',fecha:'',pares:[{centro:'',en:false,sede:false},{centro:'',en:false,sede:false},{centro:'',en:false,sede:false}]}));return{columnas:3,filas};}

let data = {
  "CENTROS EXCLUSIVOS":[{nombre:"Reina Mercedes",delegado:"",audiologo:"",tipo:"Franquicia",
    acciones:Array.from({length:12},()=>({fecha:'',paquete:'1',tipo:'Azafata/Buzoneo',derivacion:null,citas:null,venta:null,obs:''})),
    formaciones:Array.from({length:5},()=>({curso:'',realizado:false,aplica:false,obs:''})),
    procesos:Array.from({length:4},()=>({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null}))}],
  "CENTROS FLOP":[{nombre:"(nuevo centro)",delegado:"",audiologo:"",tipo:"Sucursal",
    acciones:Array.from({length:12},()=>({fecha:'',paquete:'1',tipo:'Azafata/Buzoneo',derivacion:null,citas:null,venta:null,obs:''})),
    formaciones:Array.from({length:5},()=>({curso:'',realizado:false,aplica:false,obs:''})),
    procesos:Array.from({length:4},()=>({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null}))}],
  "VISITAS AUDIO":[{rol:"Delegado audio",responsable:"",hojas:[sheetVA("Visita 1")]}],
  "FORMACIONES Y MENTORING":[{delegado:"",filas:rowsFM()}],
  "TELEAUDIOLOGIA":[{hojas:[sheetTA("Tele 1")]}],
  "EQUIPOS":[equiposInit()]
};

/* ===== Persistencia local ===== */
const KEY='AudioSeguimiento.local';
function saveLocal(){ localStorage.setItem(KEY, JSON.stringify(data)); stamp('Guardado local'); }
function loadLocal(){
  try{ const raw=localStorage.getItem(KEY); if(raw){ data=JSON.parse(raw); stamp('Cargado local'); } }
  catch(_){ stamp('Cargado (dataset por defecto)'); }
}

/* ===== Estado UI ===== */
let state={section:null,index:null,vaSheet:0,vaFilter:'',fmFilter:'',taFilter:'',taPerson:'',eqFilter:''};
const SECTIONS=["CENTROS EXCLUSIVOS","CENTROS FLOP","VISITAS AUDIO","FORMACIONES Y MENTORING","TELEAUDIOLOGIA","EQUIPOS"];
const cur=()=> data[state.section]?.[state.index];

/* ===== Sidebar ===== */
function itemDiv(name,i,edit,del){
  const d=document.createElement('div'); d.className='item'; d.dataset.index=i;
  d.innerHTML=`<div><div class="name">${name}</div></div><div class="act">
    <button class="btn-mini edit">✏️</button><button class="btn-mini del">🗑️</button></div>`;
  d.querySelector('.edit').onclick=edit; d.querySelector('.del').onclick=del; return d;
}
function renderLeft(){
  const listEX=$('#listEX'); listEX.innerHTML='';
  data["CENTROS EXCLUSIVOS"].forEach((c,i)=>listEX.appendChild(itemDiv(c.nombre||'(sin nombre)',i,
    ()=>{state={...state,section:"CENTROS EXCLUSIVOS",index:i}; renderDetail();},
    ()=>{ if(confirm('Eliminar?')){data["CENTROS EXCLUSIVOS"].splice(i,1); saveLocal(); renderAll();} })));

  const listFL=$('#listFL'); listFL.innerHTML='';
  data["CENTROS FLOP"].forEach((c,i)=>listFL.appendChild(itemDiv(c.nombre||'(sin nombre)',i,
    ()=>{state={...state,section:"CENTROS FLOP",index:i}; renderDetail();},
    ()=>{ if(confirm('Eliminar?')){data["CENTROS FLOP"].splice(i,1); saveLocal(); renderAll();} })));

  const listVA=$('#listVA'); listVA.innerHTML='';
  data["VISITAS AUDIO"].forEach((v,i)=>listVA.appendChild(itemDiv((v.rol||'-')+' · '+(v.responsable||'—'),i,
    ()=>{state={...state,section:"VISITAS AUDIO",index:i}; renderDetail();},
    ()=>{ if(confirm('Eliminar?')){data["VISITAS AUDIO"].splice(i,1); saveLocal(); renderAll();} })));

  const listFM=$('#listFM'); listFM.innerHTML='';
  data["FORMACIONES Y MENTORING"].forEach((f,i)=>listFM.appendChild(itemDiv(f.delegado||'(Delegado regional)',i,
    ()=>{state={...state,section:"FORMACIONES Y MENTORING",index:i}; renderDetail();},
    ()=>{ if(confirm('Eliminar?')){data["FORMACIONES Y MENTORING"].splice(i,1); saveLocal(); renderAll();} })));

  const listTA=$('#listTA'); listTA.innerHTML='';
  data["TELEAUDIOLOGIA"].forEach((t,i)=>listTA.appendChild(itemDiv('Teleaudiología',i,
    ()=>{state={...state,section:"TELEAUDIOLOGIA",index:i}; renderDetail();},
    ()=>{ if(confirm('Eliminar?')){data["TELEAUDIOLOGIA"].splice(i,1); saveLocal(); renderAll();} })));

  const listEQ=$('#listEQ'); listEQ.innerHTML='';
  data["EQUIPOS"].forEach((e,i)=>listEQ.appendChild(itemDiv('Inventario de equipos',i,
    ()=>{state={...state,section:"EQUIPOS",index:i}; renderDetail();},
    ()=>{ if(confirm('Eliminar?')){data["EQUIPOS"].splice(i,1); saveLocal(); renderAll();} })));

  // Añadir
  $('.addEX').onclick=()=>{data["CENTROS EXCLUSIVOS"].push(structCentro('(nuevo centro)')); saveLocal(); renderAll();};
  $('.addFL').onclick=()=>{data["CENTROS FLOP"].push(structCentro('(nuevo centro)')); saveLocal(); renderAll();};
  $('.addVA').onclick=()=>{data["VISITAS AUDIO"].push({rol:'Delegado audio',responsable:'',hojas:[sheetVA('Visita '+(data["VISITAS AUDIO"].length+1))]}); saveLocal(); renderAll();};
  $('.addFM').onclick=()=>{data["FORMACIONES Y MENTORING"].push({delegado:'(Delegado regional)',filas:rowsFM()}); saveLocal(); renderAll();};
  $('.addTA').onclick=()=>{data["TELEAUDIOLOGIA"].push({hojas:[sheetTA('Tele '+(data["TELEAUDIOLOGIA"].length+1))]}); saveLocal(); renderAll();};
  $('.addEQ').onclick=()=>{data["EQUIPOS"].push(equiposInit()); saveLocal(); renderAll();};
}
function structCentro(nombre){return{nombre,delegado:'',audiologo:'',tipo:'Franquicia',
  acciones:Array.from({length:12},()=>({fecha:'',paquete:'1',tipo:'Azafata/Buzoneo',derivacion:null,citas:null,venta:null,obs:''})),
  formaciones:Array.from({length:5},()=>({curso:'',realizado:false,aplica:false,obs:''})),
  procesos:Array.from({length:4},()=>({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null}))};}

/* ===== Detalle switch ===== */
function clearPanels(){['detCentro','detVisitas','detFM','detTA','detEQ'].forEach(id=>$('#'+id).style.display='none');}
function tone(){ return state.section==="CENTROS EXCLUSIVOS"?'var(--ex)':
  state.section==="CENTROS FLOP"?'var(--fl)':
  state.section==="VISITAS AUDIO"?'var(--va)':
  state.section==="FORMACIONES Y MENTORING"?'var(--fm)':
  state.section==="TELEAUDIOLOGIA"?'var(--ta)':'var(--eq)'; }
function renderDetail(){
  $('#hint').style.display='none';
  const s=state.section, obj=cur(); if(!s||!obj){$('#hint').style.display='block'; return;}
  $('#detail').style.background=tone();
  $('#hdrTag').textContent=s;
  $('#hdrName').textContent= (s.includes('CENTROS') ? (obj.nombre||'—') : '—');

  clearPanels();
  if(s.includes('CENTROS')){ $('#detCentro').style.display='block'; fillCentro(); }
  if(s==='VISITAS AUDIO'){ $('#detVisitas').style.display='block'; fillVA(); }
  if(s==='FORMACIONES Y MENTORING'){ $('#detFM').style.display='block'; fillFM(); }
  if(s==='TELEAUDIOLOGIA'){ $('#detTA').style.display='block'; fillTA(); }
  if(s==='EQUIPOS'){ $('#detEQ').style.display='block'; fillEQ(); }
}
$('#btnSavePanel').onclick=()=>{ saveLocal(); };

/* ===== Centros ===== */
function fillCentro(){
  const it=cur();
  $('#cNombre').value=it.nombre||''; $('#cDelegado').value=it.delegado||''; $('#cAud').value=it.audiologo||''; $('#cTipo').value=it.tipo||'Franquicia';
  $('#cNombre').oninput=e=>{it.nombre=e.target.value; $('#hdrName').textContent=it.nombre||'—';};
  $('#cDelegado').oninput=e=>it.delegado=e.target.value;
  $('#cAud').oninput=e=>it.audiologo=e.target.value;
  $('#cTipo').onchange=e=>it.tipo=e.target.value;

  // Acciones
  const A=$('#accRows'); A.innerHTML='';
  it.acciones.forEach((r,i)=>{
    const d=document.createElement('div'); d.className='grid acc-r';
    d.innerHTML=`<div>${i+1}</div>
    <input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">
    <select data-i="${i}" data-k="paquete"><option ${r.paquete==='1'?'selected':''}>1</option><option ${r.paquete==='2'?'selected':''}>2</option><option ${r.paquete==='3'?'selected':''}>3</option></select>
    <select data-i="${i}" data-k="tipo"><option ${r.tipo==='Azafata/Buzoneo'?'selected':''}>Azafata/Buzoneo</option><option ${r.tipo==='Stand'?'selected':''}>Stand</option><option ${r.tipo==='Mailing/Cashback'?'selected':''}>Mailing/Cashback</option><option ${r.tipo==='Otros'?'selected':''}>Otros</option></select>
    <input type="number" min="0" step="1" data-i="${i}" data-k="derivacion" value="${r.derivacion??''}">
    <input type="number" min="0" step="1" data-i="${i}" data-k="citas" value="${r.citas??''}">
    <input type="number" min="0" step="1" data-i="${i}" data-k="venta" value="${r.venta??''}">
    <input data-i="${i}" data-k="obs" value="${r.obs||''}">
    <button class="btn-mini" data-del="${i}">🗑️</button>`;
    A.appendChild(d);
  });
  A.oninput=e=>{
    const i=+e.target.dataset.i,k=e.target.dataset.k; if(k==null) return;
    if(['derivacion','citas','venta'].includes(k)){ it.acciones[i][k]= e.target.value===''?null:Number(e.target.value); }
    else it.acciones[i][k]= e.target.value;
  };
  A.onclick=e=>{ const i=e.target.dataset.del; if(i!=null){ it.acciones.splice(+i,1); fillCentro(); } };

  // Formación
  const F=$('#frmRows'); F.innerHTML='';
  while(it.formaciones.length<5) it.formaciones.push({curso:'',realizado:false,aplica:false,obs:''});
  it.formaciones.forEach((r,i)=>{
    const d=document.createElement('div'); d.className='grid frm-r';
    d.innerHTML=`<div>${i+1}</div>
    <input data-i="${i}" data-k="curso" value="${r.curso||''}">
    <input type="checkbox" data-i="${i}" data-k="realizado" ${r.realizado?'checked':''}>
    <input type="checkbox" data-i="${i}" data-k="aplica" ${r.aplica?'checked':''}>
    <input data-i="${i}" data-k="obs" value="${r.obs||''}">
    <button class="btn-mini" data-del="${i}">🗑️</button>`;
    F.appendChild(d);
  });
  F.oninput=e=>{
    const i=+e.target.dataset.i,k=e.target.dataset.k; if(k==null) return;
    it.formaciones[i][k]= (e.target.type==='checkbox') ? e.target.checked : e.target.value;
  };
  F.onclick=e=>{ const i=e.target.dataset.del; if(i!=null){ it.formaciones.splice(+i,1); fillCentro(); } };

  // Procesos
  const P=$('#procRows'); P.innerHTML='';
  while(it.procesos.length<4) it.procesos.push({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null});
  const cls95=v=> (Number(v)>=95)?'good':(v==null||v==='')?'':'bad';
  const cls80=v=> (Number(v)>=80)?'good':(v==null||v==='')?'':'bad';
  it.procesos.forEach((r,i)=>{
    const hasAdj = !!(r.adjunto && r.adjunto.name);
    const d=document.createElement('div'); d.className='grid proc-r';
    d.innerHTML=`<div>${i+1}</div>
    <input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">
    <input class="${cls95(r.puntuacion)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="puntuacion" value="${r.puntuacion??''}">
    <div class="hit ${r.hit?'on':''}"><input type="checkbox" data-i="${i}" data-k="hit" ${r.hit?'checked':''}></div>
    <input type="checkbox" data-i="${i}" data-k="rt" ${r.rt?'checked':''}>
    <input class="${cls80(r.pruebas)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="pruebas" value="${r.pruebas??''}">
    <input class="${cls80(r.venta)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="venta" value="${r.venta??''}">
    <input data-i="${i}" data-k="colab" value="${r.colab||''}">
    <input data-i="${i}" data-k="obs" value="${r.obs||''}">
    <span><label class="btn-mini" style="display:inline-block;cursor:pointer">📎<input type="file" data-file="${i}" style="display:none"></label>${hasAdj?'<span class="btn-mini" title="'+r.adjunto.name+'">🔗</span>':''}</span>
    <button class="btn-mini" data-del="${i}">🗑️</button>`;
    P.appendChild(d);
  });
  P.oninput=e=>{
    const i=+e.target.dataset.i,k=e.target.dataset.k; if(k==null) return;
    if(e.target.type==='checkbox'){ it.procesos[i][k]=e.target.checked; if(k==='hit'){ e.target.closest('.hit').classList.toggle('on',e.target.checked); } }
    else if(e.target.type==='number'){ it.procesos[i][k]= e.target.value===''?null:Number(e.target.value); e.target.className=(k==='puntuacion'?cls95:cls80)(it.procesos[i][k]); }
    else it.procesos[i][k]= e.target.value;
  };
  P.onclick=e=>{ const i=e.target.dataset.del; if(i!=null){ it.procesos.splice(+i,1); fillCentro(); } };
  P.addEventListener('change',e=>{
    const i=e.target.dataset.file; if(i==null) return;
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{ it.procesos[+i].adjunto={name:f.name,data:r.result}; fillCentro(); }; r.readAsDataURL(f);
  });
}

/* ===== Visitas ===== */
function fillVA(){
  const it=cur();
  $('#vaRol').value=it.rol||'Delegado audio'; $('#vaResp').value=it.responsable||''; $('#vaSearch').value=state.vaFilter||'';
  $('#vaRol').onchange=e=>it.rol=e.target.value; $('#vaResp').oninput=e=>it.responsable=e.target.value; $('#vaSearch').oninput=e=>{state.vaFilter=e.target.value.toLowerCase(); renderVAbody();};
  renderVAbody();
}
function renderVAbody(){
  const it=cur(); const h=it.hojas[state.vaSheet]||it.hojas[0]; const f=state.vaFilter||''; const C=$('#vaRows'); C.innerHTML='';
  const class85=v=> (Number(v)>=85)?'good':(v==null||v==='')?'':'bad';
  const class80=v=> (Number(v)>=80)?'good':(v==null||v==='')?'':'bad';
  let count=0;
  h.rows.forEach((r,i)=>{
    if(f && !(r.centro||'').toLowerCase().includes(f)) return;
    const d=document.createElement('div'); d.className='grid va-r';
    d.innerHTML=`<div>${i+1}</div>
    <input data-i="${i}" data-k="centro" value="${r.centro||''}">
    <input data-i="${i}" data-k="delegado" value="${r.delegado||''}">
    <input data-i="${i}" data-k="audiologo" value="${r.audiologo||''}">
    <select data-i="${i}" data-k="tipo"><option ${r.tipo==='Sucursal'?'selected':''}>Sucursal</option><option ${r.tipo==='Franquicia'?'selected':''}>Franquicia</option></select>
    <input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">
    <input class="${class85(r.puntuacion)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="puntuacion" value="${r.puntuacion??''}">
    <div class="hit ${r.hit?'on':''}"><input type="checkbox" data-i="${i}" data-k="hit" ${r.hit?'checked':''}></div>
    <input class="${class80(r.conv_prueba)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="conv_prueba" value="${r.conv_prueba??''}">
    <input class="${class80(r.conv_venta)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="conv_venta" value="${r.conv_venta??''}">`;
    C.appendChild(d);
    if((r.fecha||'').trim()) count++;
  });
  $('#vaCnt').textContent = `${count} registradas`;
  const p = Math.min(100, Math.round(count*100/ h.rows.length));
  $('#vaBar').style.width = p+'%';

  C.oninput=e=>{
    const i=+e.target.dataset.i,k=e.target.dataset.k; if(!k) return; const row=cur().hojas[state.vaSheet].rows[i];
    if(e.target.type==='checkbox'){ row[k]=e.target.checked; e.target.closest('.hit')?.classList.toggle('on',e.target.checked); }
    else if(e.target.type==='number'){ row[k]=e.target.value===''?null:Number(e.target.value); }
    else row[k]=e.target.value;
  };
}

/* ===== Formaciones global ===== */
function fillFM(){
  const it=cur();
  $('#fmDel').value=it.delegado||''; $('#fmSearch').value=state.fmFilter||'';
  $('#fmDel').oninput=e=>it.delegado=e.target.value;
  $('#fmSearch').oninput=e=>{state.fmFilter=e.target.value.toLowerCase(); renderFMbody();};
  renderFMbody();
}
function renderFMbody(){
  const it=cur(); const cont=$('#fmRows'); cont.innerHTML=''; const f=state.fmFilter||'';
  it.filas.forEach((r,i)=>{
    if(f && !(r.tema||'').toLowerCase().includes(f) && !(r.audiologo||'').toLowerCase().includes(f)) return;
    const evoP=(Number.isFinite(+r.p_ini)&&Number.isFinite(+r.p_3m))?(Number(r.p_3m)-Number(r.p_ini)):null;
    const evoV=(Number.isFinite(+r.v_ini)&&Number.isFinite(+r.v_3m))?(Number(r.v_3m)-Number(r.v_ini)):null;
    const row=document.createElement('div'); row.className='grid fm-r';
    row.innerHTML=`<div>${i+1}</div>
      <input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">
      <input data-i="${i}" data-k="tema" value="${r.tema||''}">
      <input data-i="${i}" data-k="audiologo" value="${r.audiologo||''}">
      <select data-i="${i}" data-k="duracion">${[1,2,3,4].map(n=>`<option ${Number(r.duracion)===n?'selected':''}>${n}</option>`).join('')}</select>
      <input class="${Number(r.p_ini)>=80?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="p_ini" value="${r.p_ini??''}">
      <input class="${Number(r.v_ini)>=80?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="v_ini" value="${r.v_ini??''}">
      <input class="${Number(r.p_3m)>=80?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="p_3m" value="${r.p_3m??''}">
      <input class="${Number(r.v_3m)>=80?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="v_3m" value="${r.v_3m??''}">
      <div style="text-align:center;font-weight:700">${evoP==null?'—':(evoP>0?'↑ ':'')+(evoP<0?'↓ ':'')+Math.abs(Math.round(evoP))}</div>
      <div style="text-align:center;font-weight:700">${evoV==null?'—':(evoV>0?'↑ ':'')+(evoV<0?'↓ ':'')+Math.abs(Math.round(evoV))}</div>`;
    cont.appendChild(row);
  });
  cont.oninput=e=>{
    const i=+e.target.dataset.i,k=e.target.dataset.k; if(!k) return; const it=cur();
    if(e.target.type==='number') it.filas[i][k]=e.target.value===''?null:Number(e.target.value);
    else if(e.target.tagName==='SELECT') it.filas[i][k]=Number(e.target.value);
    else it.filas[i][k]=e.target.value;
  };
}

/* ===== Teleaudiología ===== */
function fillTA(){
  $('#taSearch').value=state.taFilter||''; populateTAselect(); renderTAbody();
  $('#taSearch').oninput=e=>{state.taFilter=e.target.value.toLowerCase(); renderTAbody();};
  $('#taPerson').onchange=e=>{state.taPerson=e.target.value; renderTAbody();};
}
function populateTAselect(){
  const h=cur().hojas[0]; const names=[...new Set(h.rows.map(r=>(r.persona||'').trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  $('#taPerson').innerHTML='<option value="">Todos</option>'+names.map(n=>`<option>${n}</option>`).join('');
}
function renderTAbody(){
  const h=cur().hojas[0], f=state.taFilter||'', per=state.taPerson||''; const C=$('#taRows'); C.innerHTML='';
  h.rows.forEach((r,i)=>{
    if((f && !(r.centro||'').toLowerCase().includes(f) && !(r.persona||'').toLowerCase().includes(f)) || (per && (r.persona||'')!==per)) return;
    const d=document.createElement('div'); d.className='grid ta-r';
    d.innerHTML=`<div>${i+1}</div>
      <input data-i="${i}" data-k="centro" value="${r.centro||''}">
      <input data-i="${i}" data-k="delegado" value="${r.delegado||''}">
      <select data-i="${i}" data-k="rol"><option ${r.rol!=='Técnico'?'selected':''}>Audiólogo</option><option ${r.rol==='Técnico'?'selected':''}>Técnico</option></select>
      <input data-i="${i}" data-k="persona" value="${r.persona||''}">
      <input type="checkbox" data-i="${i}" data-k="formacion" ${r.formacion?'checked':''}>
      <input type="checkbox" data-i="${i}" data-k="practicas" ${r.practicas?'checked':''}>
      <input type="checkbox" data-i="${i}" data-k="certificado" ${r.certificado?'checked':''}>
      <input type="checkbox" data-i="${i}" data-k="pruebas" ${r.pruebas?'checked':''}>
      <input type="checkbox" data-i="${i}" data-k="ventas" ${r.ventas?'checked':''}>
      <input data-i="${i}" data-k="obs" value="${r.obs||''}">`;
    C.appendChild(d);
  });
  C.oninput=e=>{
    const i=+e.target.dataset.i,k=e.target.dataset.k; if(!k) return; const h=cur().hojas[0];
    h.rows[i][k]= (e.target.type==='checkbox') ? e.target.checked : e.target.value;
  };
}

/* ===== Equipos ===== */
function fillEQ(){
  $('#eqSearch').value=state.eqFilter||''; $('#eqSearch').oninput=e=>{state.eqFilter=e.target.value.toLowerCase(); renderEQbody();};
  $('#eqAddRow').onclick=()=>{ const it=cur(); it.filas.push({equipo:'',serie:'',persona:'',fecha:'',pares:Array.from({length:it.columnas},()=>({centro:'',en:false,sede:false}))}); renderEQbody(); };
  $('#eqAddPar').onclick=()=>{ const it=cur(); it.columnas=(it.columnas||3)+1; it.filas.forEach(r=>r.pares.push({centro:'',en:false,sede:false})); renderEQbody(); };
  renderEQbody();
}
function renderEQbody(){
  const it=cur(); const f=state.eqFilter||''; const C=$('#eqRows'); C.innerHTML='';
  it.filas.forEach((r,i)=>{
    const txt=(r.equipo||'')+' '+(r.serie||'')+' '+(r.persona||' ')+(r.pares||[]).map(p=>(p.centro||'')).join(' ');
    if(f && !txt.toLowerCase().includes(f)) return;
    const P=(idx)=>r.pares?.[idx]||{centro:'',en:false,sede:false};
    const d=document.createElement('div'); d.className='grid eq-r';
    d.innerHTML=`<div>${i+1}</div>
      <input data-i="${i}" data-k="equipo" value="${r.equipo||''}">
      <input data-i="${i}" data-k="serie" value="${r.serie||''}">
      <input data-i="${i}" data-k="persona" value="${r.persona||''}">
      <input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">
      <input data-i="${i}" data-k="centro" data-c="0" value="${P(0).centro}"><input type="checkbox" data-i="${i}" data-k="en" data-c="0" ${P(0).en?'checked':''}><input type="checkbox" data-i="${i}" data-k="sede" data-c="0" ${P(0).sede?'checked':''}>
      <input data-i="${i}" data-k="centro" data-c="1" value="${P(1).centro}"><input type="checkbox" data-i="${i}" data-k="en" data-c="1" ${P(1).en?'checked':''}><input type="checkbox" data-i="${i}" data-k="sede" data-c="1" ${P(1).sede?'checked':''}>
      <input data-i="${i}" data-k="centro" data-c="2" value="${P(2).centro}"><input type="checkbox" data-i="${i}" data-k="en" data-c="2" ${P(2).en?'checked':''}><input type="checkbox" data-i="${i}" data-k="sede" data-c="2" ${P(2).sede?'checked':''}>`;
    C.appendChild(d);
  });
  C.oninput=e=>{
    const i=+e.target.dataset.i,k=e.target.dataset.k; if(!k) return;
    if(['centro','en','sede'].includes(k)){ const c=+e.target.dataset.c; const p=cur().filas[i].pares[c]; if(k==='centro') p.centro=e.target.value; else p[k]=e.target.checked; }
    else cur().filas[i][k]= e.target.value;
  };
}

/* ===== Controles top ===== */
$('#btnSave').onclick=saveLocal;
$('#btnLoad').onclick=()=>{loadLocal(); renderAll();};
$('#btnReset').onclick=()=>{ if(confirm('¿Resetear dataset a valores de ejemplo?')){ localStorage.removeItem(KEY); location.reload(); } };

/* ===== Render master ===== */
function renderAll(){ renderLeft(); if(state.section){ renderDetail(); } else { $('#hint').style.display='block'; } }

/* ===== Init ===== */
loadLocal();
renderAll();
</script>
</body>
</html>
