<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SEGUIMIENTO AUDIO · Local</title>
<meta name="theme-color" content="#c82727"/>
<style>
:root{
  --rojo:#c82727; --rojo2:#a11818; --bg:#f6f7fb; --line:#e6e7ee; --sh:0 6px 18px rgba(0,0,0,.10);
  --col-ex:#fde2e4; --col-fl:#e2f0cb; --col-va:#cde7f0; --col-fm:#f9e5c9; --col-ta:#eadcf8; --col-eq:#e8f1ff; --col-ve:#fde7c4;
  --fs:12px; --fs-sm:11px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#222;font-size:var(--fs);line-height:1.18;overflow-x:auto}

/* Topbar protagonista */
.topbar{position:sticky;top:0;z-index:100;width:100%;background:linear-gradient(180deg,var(--rojo),var(--rojo2));color:#fff;box-shadow:var(--sh)}
.bar{padding:14px 10px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:.6rem}
.left{display:flex;gap:.4rem}
.right{display:flex;gap:.4rem;justify-self:end}
.brand{justify-self:center;display:flex;align-items:center;gap:.6rem}
.brand h1{margin:0;font-weight:1000;letter-spacing:.6px;font-size:30px}
.brand i{font-style:normal;font-size:24px}
.btn{border:0;border-radius:9px;padding:.36rem .7rem;cursor:pointer;box-shadow:var(--sh);font-weight:800;font-size:11px}
.btn-lite{background:#fff;color:#7b0e0e}
.btn-ghost{background:transparent;border:1px solid #ffffff5c;color:#fff}
.pill{display:inline-flex;gap:.3rem;align-items:center;border:1px solid #ffffff2f;background:#ffffff18;padding:.18rem .5rem;border-radius:999px;white-space:nowrap;font-size:11px}

/* Layout */
.main{display:grid;grid-template-columns:220px minmax(0,1fr);gap:8px;padding:8px}
@media (max-width:1100px){.main{grid-template-columns:1fr}}
.sidebar{display:flex;flex-direction:column;gap:8px}
.side-card{border:1px solid var(--line);border-radius:10px;background:#fff;box-shadow:var(--sh);display:flex;flex-direction:column}
.side-head{display:flex;justify-content:space-between;align-items:center;padding:.45rem .5rem;font-weight:900;border-bottom:1px solid var(--line);font-size:12px}
.side-list{padding:.28rem .34rem .4rem;overflow:auto;max-height:180px}
.side-btn{width:26px;height:22px;border-radius:6px;border:1px solid var(--line);background:#fff;cursor:pointer;font-size:12px}
.item{display:flex;justify-content:space-between;gap:.35rem;align-items:center;background:#fff;border:1px solid var(--line);border-radius:8px;padding:.3rem .36rem;margin:.22rem 0}
.item .name{font-weight:800;font-size:12.2px}
.item small{font-size:10.5px;opacity:.82}

/* Detalle */
.detail{padding:.55rem;border-radius:10px;border:1px solid var(--line);background:#fff;min-height:66vh;box-shadow:var(--sh);position:relative}
.header-row{display:flex;align-items:center;gap:.8rem;margin-bottom:.35rem}
.header-row h2{margin:0;font-size:18px;letter-spacing:.2px}
.hdr-name{font-weight:900;font-size:20px}
.badge{padding:.12rem .5rem;border-radius:999px;background:#00000010;font-size:11px}
.save-small{font-size:11px;padding:.36rem .7rem;border-radius:999px;background:#1f6feb;color:#fff;border:0;box-shadow:var(--sh);cursor:pointer}
.row{display:flex;gap:.4rem;flex-wrap:wrap;align-items:flex-end}
.field{display:grid;gap:.12rem;min-width:160px;flex:1;margin:.16rem 0}
.field label{font-weight:700;opacity:.9;font-size:11px}
.field input,.field select,.field textarea{border:1px solid var(--line);border-radius:8px;padding:.18rem .28rem;font-size:var(--fs-sm);background:#fff;outline:none}
.table-wrap{border:1px solid var(--line);border-radius:10px;background:#fff;box-shadow:var(--sh);padding:.2rem;margin-top:.2rem}
.xscroll{overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;padding-bottom:3px}
.table-inner{display:block;width:max-content;min-width:900px}
.table-inner input,.table-inner select{padding:.14rem .22rem;font-size:var(--fs-sm)}
.scroll{max-height:62vh;overflow:auto}
.acc-head,.acc-row,.frm-head,.frm-row,.proc-head,.proc-row,.va-head,.va-row,.fm-head,.fm-row,.ta-head,.ta-row,.eq-head,.eq-row,.ve-head,.ve-row{display:grid;gap:.12rem;align-items:center;margin:.04rem}
.acc-head,.acc-row{grid-template-columns:36px 110px 86px 200px 86px 80px 80px minmax(400px,1fr) 36px}
.frm-head,.frm-row{grid-template-columns:36px 1.2fr .5fr .5fr 2.2fr 36px}
.proc-head,.proc-row{grid-template-columns:36px 130px 130px 60px 90px 100px 100px 200px minmax(300px,1fr) 86px 36px}
.va-cols{grid-template-columns:36px 1fr 120px 120px 120px 120px 100px 56px 120px 120px}
.fm-head,.fm-row{grid-template-columns:36px 90px 180px 120px 100px 100px 100px 110px 110px 120px 120px}
.ta-head,.ta-row{grid-template-columns:36px 1fr 140px 120px 160px 56px 56px 56px 56px 56px minmax(260px,1fr)}
.eq-head,.eq-row{grid-template-columns:36px 140px 120px 160px 120px 140px 48px 48px 140px 48px 48px 140px 48px 48px}
.ve-head,.ve-row{grid-template-columns:36px 120px 1fr 130px minmax(400px,1fr) 36px}

/* Estados / colores */
.pscore{border:2px solid transparent}
.pscore.good{background:#eaf9f0;border-color:#2ecc71aa}
.pscore.bad{background:#ffe8e8;border-color:#e74c3caa}
.conv{border:2px solid transparent}
.conv.good{background:#eaf9f0;border-color:rgba(46,204,113,.6)}
.conv.bad{background:#ffe8e8;border-color:rgba(231,76,60,.6)}
.hitcell{background:#ffe5e5;border:1px solid #f5c2c2;border-radius:6px;display:flex;justify-content:center;align-items:center;padding:.04rem}
.hitcell.on{background:#e6f6ed;border-color:#bfe7cc}

/* Widget visitas */
.va-right{position:fixed;right:12px;top:128px;width:220px;display:flex;flex-direction:column;gap:.26rem;z-index:50}
.va-right .card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--sh);padding:.4rem}
.va-right .bar{height:6px;background:#e9ecef;border-radius:999px;overflow:hidden}
.va-right .bar>div{height:100%;background:#1f6feb;width:0%}

/* KPIs Teleaudiología */
.kpis{display:flex;gap:.4rem;margin:.2rem 0 .3rem}
.kpi{display:flex;align-items:center;gap:.4rem;padding:.25rem .5rem;border-radius:999px;font-weight:800}
.kpi.green{background:#eaf9f0;border:1px solid #bdebd0;color:#1f7a4a}
.kpi.amber{background:#fff5e5;border:1px solid #ffdfad;color:#7a4b00}

/* Botones primarios en equipos */
.btn-primary{background:#1f6feb;color:#fff;border:0;border-radius:10px;padding:.38rem .8rem;box-shadow:var(--sh);font-weight:800}

/* Tonos detalle */
.detail.ve{background:var(--col-ve)}
.detail.ex{background:var(--col-ex)}
.detail.fl{background:var(--col-fl)}
.detail.va{background:var(--col-va)}
.detail.fm{background:var(--col-fm)}
.detail.ta{background:var(--col-ta)}
.detail.eq{background:var(--col-eq)}
</style>
</head>
<body>

<header class="topbar">
  <div class="bar">
    <div class="left">
      <button id="btnLoad" class="btn btn-lite" title="Leer desde localStorage">Actualizar</button>
      <button id="btnSave" class="btn btn-lite" title="Guardar en localStorage">Guardar</button>
      <button id="btnReset" class="btn btn-ghost" title="Descartar cambios y recargar">Resetear</button>
    </div>
    <div class="brand"><i>🎧</i><h1>SEGUIMIENTO AUDIO</h1></div>
    <div class="right">
      <span id="stamp" class="pill">Local · listo</span>
    </div>
  </div>
</header>

<main class="main">
  <!-- ===== SIDEBAR ===== -->
  <aside class="sidebar">
    <div class="side-card" data-section="CIFRA DE VENTA" style="background:var(--col-ve)">
      <div class="side-head"><div>💶 CIFRA DE VENTA</div><div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </div>
    <div class="side-card" data-section="CENTROS EXCLUSIVOS" style="background:var(--col-ex)">
      <div class="side-head"><div>📒 CENTROS EXCLUSIVOS</div><div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </div>
    <div class="side-card" data-section="CENTROS FLOP" style="background:var(--col-fl)">
      <div class="side-head"><div>📒 CENTROS FLOP</div><div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </div>
    <div class="side-card" data-section="VISITAS AUDIO" style="background:var(--col-va)">
      <div class="side-head"><div>📋 VISITAS AUDIO</div><div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </div>
    <div class="side-card" data-section="FORMACIONES Y MENTORING" style="background:var(--col-fm)">
      <div class="side-head"><div>🎓 FORMACIONES Y MENTORING</div><div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </div>
    <div class="side-card" data-section="TELEAUDIOLOGIA" style="background:var(--col-ta)">
      <div class="side-head"><div>📡 TELEAUDIOLOGIA</div><div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </div>
    <div class="side-card" data-section="EQUIPOS" style="background:var(--col-eq)">
      <div class="side-head"><div>🧰 EQUIPOS</div><div><button class="side-btn" data-act="toggle">▾</button><button class="side-btn" data-act="add">＋</button></div></div>
      <div class="side-list"></div>
    </div>
  </aside>

  <!-- ===== DETALLE ===== -->
  <section class="detail" id="detail">
    <div class="header-row">
      <h2>Detalle — <span id="centerNameHdr" class="hdr-name">—</span></h2>
      <span id="detTag" class="badge">—</span>
      <div style="flex:1"></div>
      <button id="savePanel" class="save-small">💾 Guardar panel</button>
    </div>
    <p id="detHint" style="opacity:.75;margin:.1rem 0 .3rem">Selecciona un elemento a la izquierda (doble clic o ✏️), o crea uno con ＋.</p>

    <!-- ===== CIFRA DE VENTA ===== -->
    <div id="detVentas" style="display:none">
      <div class="row">
        <div class="field"><label>Buscar</label><input id="veSearch" placeholder="Centro u observación…"></div>
      </div>
      <div class="table-wrap">
        <div class="xscroll"><div class="table-inner">
          <div class="ve-head"><div>#</div><div>Fecha</div><div>Centro</div><div>Importe (€)</div><div>Observaciones</div><div></div></div>
          <div id="veRows" class="scroll"></div>
        </div></div>
      </div>
    </div>

    <!-- ===== CENTROS ===== -->
    <div id="detCentro" style="display:none">
      <div class="row">
        <div class="field"><label>Nombre</label><input id="cNombre"></div>
        <div class="field"><label>Delegado</label><input id="cDelegado"></div>
        <div class="field"><label>Audiólogo</label><input id="cAudiologo"></div>
        <div class="field"><label>Franquicia o Sucursal</label>
          <select id="cTipo"><option>Franquicia</option><option>Sucursal</option></select>
        </div>
      </div>

      <h3 style="margin:.35rem 0 .14rem;font-size:12px">ACCIONES</h3>
      <div class="table-wrap">
        <div class="xscroll"><div class="table-inner">
          <div class="acc-head">
            <div>#</div><div>Fecha</div><div>Paquete</div><div>Tipo de acción</div><div>Derivación</div><div>Citas</div><div>Ventas</div><div>Observaciones</div><div></div>
          </div>
          <div id="accionesRows" class="scroll"></div>
        </div></div>
      </div>
      <div style="display:flex;gap:.4rem;margin-top:.2rem">
        <button id="accAdd" class="btn btn-lite">＋ Añadir fila</button>
      </div>

      <h3 style="margin:.35rem 0 .14rem;font-size:12px">FORMACIÓN</h3>
      <div class="table-wrap">
        <div class="xscroll"><div class="table-inner">
          <div class="frm-head"><div>#</div><div>Curso</div><div>Realizado</div><div>Aplica</div><div>Observaciones</div><div></div></div>
          <div id="formacionesRows"></div>
        </div></div>
      </div>
      <div style="display:flex;gap:.4rem;margin-top:.2rem">
        <button id="frmAdd" class="btn btn-lite">＋ Añadir fila</button>
      </div>

      <h3 style="margin:.35rem 0 .14rem;font-size:12px">PROCESOS</h3>
      <div class="table-wrap">
        <div class="xscroll"><div class="table-inner">
          <div class="proc-head">
            <div>#</div><div>Fecha de visita</div><div>Puntuación procesos (%)</div><div>HIT</div><div>Pruebas RT</div><div>% Pruebas</div><div>% Venta</div><div>Colaboraciones locales</div><div>Observaciones</div><div>Adjunto</div><div></div>
          </div>
          <div id="procesosRows"></div>
        </div></div>
      </div>
      <div style="display:flex;gap:.4rem;margin-top:.2rem">
        <button id="procAdd" class="btn btn-lite">＋ Añadir fila</button>
      </div>
    </div>

    <!-- ===== VISITAS ===== -->
    <div id="detVisitas" style="display:none">
      <div class="va-right">
        <div class="card">
          <div style="font-weight:800;font-size:11px;margin-bottom:.2rem">Avance de visitas</div>
          <div id="vaRightCount" style="font-size:11px;margin-bottom:.16rem">0 registradas</div>
          <div class="bar"><div id="vaRightBar"></div></div>
        </div>
      </div>
      <div class="row">
        <div class="field"><label>Visitador de audio</label>
          <select id="vaRol"><option>Delegado audio</option><option>Responsable tec Audio</option></select>
        </div>
        <div class="field"><label>Nombre</label><input id="vaResp" placeholder="Nombre"></div>
        <div class="field"><label>Buscar centro</label><input id="vaSearch" placeholder="Filtrar…"></div>
      </div>
      <div id="vaTabs" style="margin:.06rem 0 .2rem"></div>
      <div class="table-wrap">
        <div class="xscroll"><div class="table-inner">
          <div class="va-head va-cols">
            <div>#</div><div>Centro</div><div>Delegado</div><div>Audiólogo</div><div>Sucursal/Franquicia</div><div>Fecha visita</div><div>Puntuación (%)</div><div>HIT</div><div>% Conv. prueba</div><div>% Conv. venta</div>
          </div><div id="vaRows" class="scroll"></div>
        </div></div>
      </div>
    </div>

    <!-- ===== FORMACIONES global ===== -->
    <div id="detFormaciones" style="display:none">
      <div class="row">
        <div class="field"><label>Delegado regional</label><input id="fmDelegado"></div>
        <div class="field"><label>Buscar</label><input id="fmSearch" placeholder="Filtrar…"></div>
      </div>
      <div class="table-wrap">
        <div class="xscroll"><div class="table-inner">
          <div class="fm-head">
            <div>#</div><div>Fecha</div><div>Tema</div><div>Audiólogo</div>
            <div>Duración (sem.)</div><div>% Prueba ini</div><div>% Venta ini</div>
            <div>% Prueba 3m</div><div>% Venta 3m</div><div>Evo. prueba</div><div>Evo. venta</div>
          </div><div id="fmRows" class="scroll"></div>
        </div></div>
      </div>
    </div>

    <!-- ===== TELEAUDIOLOGIA ===== -->
    <div id="detTele" style="display:none">
      <div class="kpis">
        <div class="kpi green">Certificados: <span id="kpiCert">0</span></div>
        <div class="kpi amber">Formación: <span id="kpiForm">0</span></div>
      </div>
      <div class="row">
        <div class="field"><label>Buscar</label><input id="taSearch" placeholder="Centro o persona…"></div>
        <div class="field"><label>Persona</label><select id="taPerson"><option value="">Todos</option></select></div>
      </div>
      <div class="table-wrap">
        <div class="xscroll"><div class="table-inner">
          <div class="ta-head">
            <div>#</div><div>Centro</div><div>Delegado</div><div>Rol</div><div>Persona</div><div>Form.</div><div>Prác.</div><div>Cert.</div><div>Pruebas</div><div>Ventas</div><div>Observaciones</div>
          </div><div id="taRows" class="scroll"></div>
        </div></div>
      </div>
    </div>

    <!-- ===== EQUIPOS ===== -->
    <div id="detEquipos" style="display:none">
      <div class="row">
        <div class="field"><label>Buscar</label><input id="eqSearch" placeholder="Equipo, serie, centro o persona…"></div>
        <div class="field"><label>&nbsp;</label>
          <div style="display:flex;gap:.4rem">
            <button id="btnAddParCols" class="btn-primary" title="Añadir otro par">＋ Añadir par</button>
            <button id="btnAddFila" class="btn-primary" title="Añadir fila">＋ Añadir fila</button>
          </div>
        </div>
      </div>
      <div class="table-wrap">
        <div class="xscroll"><div class="table-inner">
          <div class="eq-head">
            <div>#</div><div>Equipo</div><div>Nº serie</div><div>Persona que envía</div><div>Fecha</div>
            <div>Centro 1</div><div>C1</div><div>S1</div><div>Centro 2</div><div>C2</div><div>S2</div><div>Centro 3</div><div>C3</div><div>S3</div>
          </div><div id="eqBody" class="scroll"></div>
        </div></div>
      </div>
    </div>

  </section>
</main>

<script>
/* ========= util ========= */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const esc=s=>(s??'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const now=()=>new Date().toLocaleString();
function stamp(t){$('#stamp').textContent=t}

/* ========= datos ========= */
function sheetVA(n){const rows=Array.from({length:300},()=>({centro:'',delegado:'',audiologo:'',tipo:'Sucursal',fecha:'',puntuacion:null,hit:false,conv_prueba:null,conv_venta:null}));return{nombre:n,rows};}
function rowsFM(){return Array.from({length:300},()=>({fecha:'',tema:'',audiologo:'',duracion:1,p_ini:null,v_ini:null,p_3m:null,v_3m:null}));}
function sheetTA(n){const rows=Array.from({length:300},()=>({centro:'',delegado:'',rol:'Audiólogo',persona:'',formacion:false,practicas:false,certificado:false,pruebas:false,ventas:false,obs:''}));return{nombre:n,rows};}
function ventasInit(){return {filas:Array.from({length:50},()=>({fecha:'',centro:'',importe:null,obs:''}))};}
function equiposInit(){const filas=Array.from({length:25},()=>({equipo:'',serie:'',persona:'',fecha:'',pares:[{centro:'',en:false,sede:false},{centro:'',en:false,sede:false},{centro:'',en:false,sede:false}]}));return{columnas:3,filas};}

let data = JSON.parse(localStorage.getItem('audioseguimiento_v1')||'null') || {
  "CIFRA DE VENTA":[ventasInit()],
  "CENTROS EXCLUSIVOS":[{nombre:"Reina Mercedes",delegado:"",audiologo:"",tipo:"Franquicia",
    acciones:Array.from({length:12},()=>({fecha:'',paquete:'1',tipo:'Azafata',derivacion:null,citas:null,venta:null,obs:''})),
    formaciones:Array.from({length:5},()=>({curso:'',realizado:false,aplica:false,obs:''})),
    procesos:Array.from({length:4},()=>({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null}))}],
  "CENTROS FLOP":[{nombre:"(nuevo centro)",delegado:"",audiologo:"",tipo:"Sucursal",
    acciones:Array.from({length:12},()=>({fecha:'',paquete:'1',tipo:'Azafata',derivacion:null,citas:null,venta:null,obs:''})),
    formaciones:Array.from({length:5},()=>({curso:'',realizado:false,aplica:false,obs:''})),
    procesos:Array.from({length:4},()=>({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null}))}],
  "VISITAS AUDIO":[{rol:"Delegado audio",responsable:"",hojas:[sheetVA("Visita 1")]}],
  "FORMACIONES Y MENTORING":[{delegado:"",filas:rowsFM()}],
  "TELEAUDIOLOGIA":[{hojas:[sheetTA("Tele 1")]}],
  "EQUIPOS":[equiposInit()]
};

let state={selected:{section:null,index:null},vaSheet:0,vaFilter:'',fmFilter:'',taFilter:'',taPerson:'',eqFilter:'',veFilter:''};

/* ========= persistencia ========= */
function saveLocal(){ localStorage.setItem('audioseguimiento_v1', JSON.stringify(data)); stamp('Guardado local: '+now()); }
function loadLocal(){ const raw=localStorage.getItem('audioseguimiento_v1'); if(raw){ try{ data=JSON.parse(raw);}catch{} } renderAll(); stamp('Cargado local: '+now()); }
$('#btnSave').onclick=saveLocal; $('#btnLoad').onclick=loadLocal; $('#btnReset').onclick=()=>location.reload();
$('#savePanel').onclick=saveLocal;

/* ========= sidebar ========= */
const SECTIONS=["CIFRA DE VENTA","CENTROS EXCLUSIVOS","CENTROS FLOP","VISITAS AUDIO","FORMACIONES Y MENTORING","TELEAUDIOLOGIA","EQUIPOS"];
function renderLeft(){
  SECTIONS.forEach(name=>{
    const box=document.querySelector(`.side-card[data-section="${name}"]`); const list=box.querySelector('.side-list'); list.innerHTML='';
    (data[name]||[]).forEach((it,i)=>{
      const div=document.createElement('div'); div.className='item'; div.dataset.index=i;
      let inner='';
      if(name==="CIFRA DE VENTA"){ inner=`<div><div class="name">Cifra de venta</div><small>Filas: ${(it.filas||[]).length}</small></div>`; }
      else if(name.includes('CENTROS')){
        inner=`<div><div class="name">${esc(it.nombre||'—')}</div><small>Delegado: ${esc(it.delegado||'—')} · Aud.: ${esc(it.audiologo||'—')}</small></div>`;
      }else if(name==="VISITAS AUDIO"){ inner=`<div><div class="name">(${esc(it.rol||'Rol')}) ${esc(it.responsable||'—')}</div><small>Visitas</small></div>`; }
      else if(name==="FORMACIONES Y MENTORING"){ inner=`<div><div class="name">${esc(it.delegado||'(Delegado regional)')}</div></div>`; }
      else if(name==="TELEAUDIOLOGIA"){ inner=`<div><div class="name">Teleaudiología</div></div>`; }
      else{ inner=`<div><div class="name">Inventario de equipos</div></div>`; }
      div.innerHTML=inner+`<div class="acts"><button class="side-btn" data-role="edit" title="Editar">✏️</button><button class="side-btn" data-role="del" title="Eliminar">🗑️</button></div>`;
      div.addEventListener('dblclick',()=>{state.selected={section:name,index:i}; renderDetail();});
      div.querySelector('[data-role="edit"]').onclick=(e)=>{e.stopPropagation();state.selected={section:name,index:i};renderDetail();};
      div.querySelector('[data-role="del"]').onclick=(e)=>{e.stopPropagation(); if(confirm('¿Eliminar este item?')){ data[name].splice(i,1); renderAll(); saveLocal(); }};
      list.appendChild(div);
    });
    box.querySelector('[data-act="toggle"]').onclick=()=>{ list.style.display=list.style.display==='none'?'':'none'; if(list.style.display==='none'&&name.includes('CENTROS')){state.selected={section:null,index:null}; renderDetailBlank();}};
    box.querySelector('[data-act="add"]').onclick=()=>{
      let nuevo;
      if(name==="CIFRA DE VENTA") nuevo=ventasInit();
      else if(name.includes('CENTROS')) nuevo={nombre:'(nuevo centro)',delegado:'',audiologo:'',tipo:'Franquicia',
        acciones:Array.from({length:12},()=>({fecha:'',paquete:'1',tipo:'Azafata',derivacion:null,citas:null,venta:null,obs:''})),
        formaciones:Array.from({length:5},()=>({curso:'',realizado:false,aplica:false,obs:''})),
        procesos:Array.from({length:4},()=>({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null}))};
      else if(name==="VISITAS AUDIO") nuevo={rol:'Delegado audio',responsable:'',hojas:[sheetVA('Visita '+((data[name]?.[0]?.hojas?.length||0)+1))]};
      else if(name==="FORMACIONES Y MENTORING") nuevo={delegado:'(Delegado regional)',filas:rowsFM()};
      else if(name==="TELEAUDIOLOGIA") nuevo={hojas:[sheetTA('Tele 1')]};
      else nuevo=equiposInit();
      data[name].push(nuevo); renderAll(); saveLocal();
    };
  });
}

/* ========= detalle switch ========= */
function renderDetailBlank(){
  $('#detail').className='detail';
  $('#detHint').style.display='block'; $('#detTag').textContent='—'; $('#centerNameHdr').textContent='—';
  ['detVentas','detCentro','detVisitas','detFormaciones','detTele','detEquipos'].forEach(id=>$('#'+id).style.display='none');
}
function tone(s){ const d=$('#detail');
  d.className='detail '+(s==="CIFRA DE VENTA"?'ve': s==="CENTROS EXCLUSIVOS"?'ex': s==="CENTROS FLOP"?'fl': s==="VISITAS AUDIO"?'va': s==="FORMACIONES Y MENTORING"?'fm': s==="TELEAUDIOLOGIA"?'ta':'eq');
}
function cur(){ return data[state.selected.section]?.[state.selected.index]; }
function renderDetail(){
  const s=state.selected.section; if(!s){renderDetailBlank();return;}
  tone(s); $('#detHint').style.display='none'; $('#detTag').textContent=s||'—'; $('#centerNameHdr').textContent=(s.includes('CENTROS')? (cur()?.nombre||'—') : (s));
  ['detVentas','detCentro','detVisitas','detFormaciones','detTele','detEquipos'].forEach(id=>$('#'+id).style.display='none');
  if(s==="CIFRA DE VENTA"){ $('#detVentas').style.display='block'; fillVentas(); }
  if(s.includes('CENTROS')){ $('#detCentro').style.display='block'; fillCentro(); }
  if(s==="VISITAS AUDIO"){ $('#detVisitas').style.display='block'; fillVisitas(); }
  if(s==="FORMACIONES Y MENTORING"){ $('#detFormaciones').style.display='block'; fillFM(); }
  if(s==="TELEAUDIOLOGIA"){ $('#detTele').style.display='block'; fillTA(); }
  if(s==="EQUIPOS"){ $('#detEquipos').style.display='block'; fillEQ(); }
}

/* ========= CIFRA DE VENTA ========= */
function fillVentas(){
  $('#veSearch').value=state.veFilter||''; const cont=$('#veRows'); cont.innerHTML='';
  const it=cur(); const f=(state.veFilter||'').toLowerCase();
  (it.filas||[]).forEach((r,i)=>{
    if(f && !((r.centro||'')+(r.obs||'')).toLowerCase().includes(f)) return;
    const row=document.createElement('div'); row.className='ve-row';
    row.innerHTML=`<div>${i+1}</div><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}"><input data-i="${i}" data-k="centro" value="${esc(r.centro||'')}"><input type="number" step="0.01" data-i="${i}" data-k="importe" value="${r.importe??''}"><input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}"><button class="side-btn" data-del="${i}">🗑️</button>`;
    cont.appendChild(row);
  });
}
$('#veSearch').oninput=e=>{state.veFilter=e.target.value.trim(); fillVentas();}
$('#veRows').addEventListener('input',e=>{
  const i=e.target.dataset.i,k=e.target.dataset.k; if(i==null||!k)return; const r=cur().filas[+i];
  if(e.target.type==='number') r[k]=e.target.value===''?null:Number(e.target.value); else r[k]=e.target.value;
});
$('#veRows').addEventListener('click',e=>{const d=e.target.dataset.del; if(d!=null){cur().filas.splice(+d,1); fillVentas(); saveLocal();}});

/* ========= CENTROS ========= */
function fillCentro(){ const it=cur(); if(!it) return;
  $('#cNombre').value=it.nombre||''; $('#cDelegado').value=it.delegado||''; $('#cAudiologo').value=it.audiologo||''; $('#cTipo').value=it.tipo||'Franquicia';
  renderAcciones(); renderFormacion(); renderProcesos();
}
function saveCentro(){ const it=cur(); if(!it) return;
  it.nombre=$('#cNombre').value.trim(); it.delegado=$('#cDelegado').value.trim(); it.audiologo=$('#cAudiologo').value.trim(); it.tipo=$('#cTipo').value;
  $('#centerNameHdr').textContent = it.nombre || '—';
}
/* Acciones */
const TIPO_ACC=['Azafata','Buzoneo','Mailing','Ruleta','Stand','Cashback','Otros'];
function renderAcciones(){ const it=cur(); const cont=$('#accionesRows'); cont.innerHTML='';
  it.acciones.forEach((r,i)=>{ const row=document.createElement('div'); row.className='acc-row';
    row.innerHTML=`<div>${i+1}</div>
    <input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">
    <select data-i="${i}" data-k="paquete"><option ${r.paquete==='1'?'selected':''}>1</option><option ${r.paquete==='2'?'selected':''}>2</option><option ${r.paquete==='3'?'selected':''}>3</option></select>
    <select data-i="${i}" data-k="tipo">${TIPO_ACC.map(v=>`<option ${r.tipo===v?'selected':''}>${v}</option>`).join('')}</select>
    <input type="number" min="0" step="1" data-i="${i}" data-k="derivacion" value="${r.derivacion??''}">
    <input type="number" min="0" step="1" data-i="${i}" data-k="citas" value="${r.citas??''}">
    <input type="number" min="0" step="1" data-i="${i}" data-k="venta" value="${r.venta??''}">
    <input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}">
    <button class="side-btn" data-acc-del="${i}" title="Eliminar">🗑️</button>`;
    cont.appendChild(row);
  });
}
$('#accAdd').onclick=()=>{cur().acciones.push({fecha:'',paquete:'1',tipo:'Azafata',derivacion:null,citas:null,venta:null,obs:''});renderAcciones();};
$('#accionesRows').addEventListener('click',e=>{const i=e.target.dataset.accDel;if(i!=null){cur().acciones.splice(+i,1);renderAcciones();saveLocal();}});
$('#accionesRows').addEventListener('input',e=>{const i=e.target.dataset.i,k=e.target.dataset.k;if(i==null||!k) return; const r=cur().acciones[+i]; r[k]=e.target.type==='number'? (e.target.value===''?null:Number(e.target.value)):e.target.value;});

/* Formación */
function ensureMin5(a){while(a.length<5) a.push({curso:'',realizado:false,aplica:false,obs:''});}
function renderFormacion(){ const it=cur(); ensureMin5(it.formaciones); const c=$('#formacionesRows'); c.innerHTML='';
  it.formaciones.forEach((r,i)=>{const row=document.createElement('div'); row.className='frm-row';
    row.innerHTML=`<div>${i+1}</div>
      <input data-i="${i}" data-k="curso" value="${esc(r.curso||'')}">
      <input type="checkbox" data-i="${i}" data-k="realizado" ${r.realizado?'checked':''}>
      <input type="checkbox" data-i="${i}" data-k="aplica" ${r.aplica?'checked':''}>
      <input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}">
      <button class="side-btn" data-frm-del="${i}" title="Eliminar">🗑️</button>`;
    c.appendChild(row);
  });
}
$('#frmAdd').onclick=()=>{cur().formaciones.push({curso:'',realizado:false,aplica:false,obs:''});renderFormacion();};
$('#formacionesRows').addEventListener('click',e=>{const i=e.target.dataset.frmDel;if(i!=null){cur().formaciones.splice(+i,1);renderFormacion();saveLocal();}});
$('#formacionesRows').addEventListener('input',e=>{const i=e.target.dataset.i,k=e.target.dataset.k;if(i==null||!k) return; const r=cur().formaciones[+i]; r[k]=e.target.type==='checkbox'?e.target.checked:e.target.value;});

/* Procesos */
function score95(v){const n=Number(v);if(!Number.isFinite(n))return'';return n>=95?'good':'bad';}
function score80(v){const n=Number(v);if(!Number.isFinite(n))return'';return n>=80?'good':'bad';}
function ensureMin4(a){while(a.length<4) a.push({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null});}
function renderProcesos(){ const it=cur(); ensureMin4(it.procesos); const c=$('#procesosRows'); c.innerHTML='';
  it.procesos.forEach((r,i)=>{const row=document.createElement('div'); row.className='proc-row';
    row.innerHTML=`<div>${i+1}</div><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">
    <input class="pscore ${score95(r.puntuacion)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="puntuacion" value="${r.puntuacion??''}">
    <div class="hitcell ${r.hit?'on':''}"><input type="checkbox" data-i="${i}" data-k="hit" ${r.hit?'checked':''}></div>
    <input type="checkbox" data-i="${i}" data-k="rt" ${r.rt?'checked':''}>
    <input class="conv ${score80(r.pruebas)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="pruebas" value="${r.pruebas??''}">
    <input class="conv ${score80(r.venta)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="venta" value="${r.venta??''}">
    <input data-i="${i}" data-k="colab" value="${esc(r.colab||'')}"><input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}">
    <span><button class="side-btn" disabled title="Adjuntos (local)">📎</button></span>
    <button class="side-btn" data-proc-del="${i}" title="Eliminar">🗑️</button>`; c.appendChild(row);
  });
}
$('#procAdd').onclick=()=>{cur().procesos.push({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adjunto:null});renderProcesos();};
$('#procesosRows').addEventListener('click',e=>{const d=e.target.dataset.procDel; if(d!=null){cur().procesos.splice(+d,1);renderProcesos();saveLocal();}});
$('#procesosRows').addEventListener('input',e=>{
  const i=e.target.dataset.i,k=e.target.dataset.k;if(i==null||!k)return; const r=cur().procesos[+i];
  if(e.target.type==='checkbox'){ r[k]=e.target.checked; if(k==='hit'){e.target.closest('.hitcell')?.classList.toggle('on',e.target.checked);} }
  else if(e.target.type==='number'){ r[k]=e.target.value===''?null:Number(e.target.value); if(k==='puntuacion') e.target.className='pscore '+score95(r[k]); if(k==='pruebas'||k==='venta') e.target.className='conv '+score80(r[k]); }
  else r[k]=e.target.value;
});
['#cNombre','#cDelegado','#cAudiologo','#cTipo'].forEach(sel=>$(sel).addEventListener('input',saveCentro));

/* ========= VISITAS ========= */
function fillVisitas(){const it=cur(); if(!it) return; $('#vaRol').value=it.rol||'Delegado audio'; $('#vaResp').value=it.responsable||''; $('#vaSearch').value=state.vaFilter||''; renderVaTabs(); renderVA();}
$('#vaRol').onchange=e=>{cur().rol=e.target.value;};
$('#vaResp').oninput=e=>{cur().responsable=e.target.value;};
$('#vaSearch').oninput=e=>{state.vaFilter=e.target.value.trim(); renderVA();};
function renderVaTabs(){const it=cur(); const tabs=$('#vaTabs'); tabs.innerHTML=''; it.hojas=it.hojas||[sheetVA('Visita 1')];
  it.hojas.forEach((h,idx)=>{const b=document.createElement('button'); b.className='side-btn'; b.textContent=h.nombre||('Visita '+(idx+1)); if(idx===state.vaSheet){b.style.background='#f1f1f1';} b.onclick=()=>{state.vaSheet=idx; renderVA();}; tabs.appendChild(b);});
  const add=document.createElement('button'); add.className='side-btn'; add.textContent='＋'; add.title='Añadir visita'; add.onclick=()=>{it.hojas.push(sheetVA('Visita '+(it.hojas.length+1))); state.vaSheet=it.hojas.length-1; renderVaTabs(); renderVA();}; tabs.appendChild(add);
}
function updateVaSummary(h){ const visited=h.rows.filter(r=>(r.fecha||'').trim()!==''); const p=Math.min(100,Math.round(visited.length*100/h.rows.length));
  $('#vaRightBar').style.width=p+'%'; $('#vaRightCount').textContent=`${visited.length} registradas`;
}
function vClass80(v){const n=Number(v); if(!Number.isFinite(n)) return ''; return n>=80?'good':'bad';}
function vScore85(v){const n=Number(v); if(!Number.isFinite(n)) return ''; return n>=85?'good':'bad';}
function renderVA(){const it=cur(); const h=it.hojas[state.vaSheet]||it.hojas[0]; const f=(state.vaFilter||'').toLowerCase(); const cont=$('#vaRows'); cont.innerHTML=''; updateVaSummary(h);
  h.rows.forEach((r,i)=>{if(f && !(r.centro||'').toLowerCase().includes(f)) return; const row=document.createElement('div'); row.className='va-row va-cols';
    row.innerHTML=`<div>${i+1}</div><input data-i="${i}" data-k="centro" value="${esc(r.centro||'')}"><input data-i="${i}" data-k="delegado" value="${esc(r.delegado||'')}"><input data-i="${i}" data-k="audiologo" value="${esc(r.audiologo||'')}"><select data-i="${i}" data-k="tipo"><option ${r.tipo==='Sucursal'?'selected':''}>Sucursal</option><option ${r.tipo==='Franquicia'?'selected':''}>Franquicia</option></select><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}"><input class="pscore ${vScore85(r.puntuacion)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="puntuacion" value="${r.puntuacion??''}"><div class="hitcell ${r.hit?'on':''}"><input type="checkbox" class="hit" data-i="${i}" data-k="hit" ${r.hit?'checked':''}></div><input class="conv ${vClass80(r.conv_prueba)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="conv_prueba" value="${r.conv_prueba??''}"><input class="conv ${vClass80(r.conv_venta)}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="conv_venta" value="${r.conv_venta??''}">`; cont.appendChild(row);});
}
$('#vaRows').addEventListener('input',e=>{const i=+e.target.dataset.i,k=e.target.dataset.k;if(!k)return; const h=cur().hojas[state.vaSheet];
  if(k==='hit'){h.rows[i][k]=e.target.checked; e.target.closest('.hitcell')?.classList.toggle('on',e.target.checked); return;}
  if(e.target.type==='number') h.rows[i][k]=e.target.value===''?null:Number(e.target.value); else if(e.target.type==='checkbox') h.rows[i][k]=e.target.checked; else h.rows[i][k]=e.target.value;});

/* ========= FORMACIONES (global) ========= */
function fillFM(){const it=cur(); if(!it) return; $('#fmDelegado').value=it.delegado||''; $('#fmSearch').value=state.fmFilter||''; renderFM();}
$('#fmDelegado').oninput=e=>{cur().delegado=e.target.value;};
$('#fmSearch').oninput=e=>{state.fmFilter=e.target.value.trim(); renderFM();};
function renderFM(){const it=cur(); it.filas=it.filas||rowsFM(); const f=(state.fmFilter||'').toLowerCase(); const cont=$('#fmRows'); cont.innerHTML='';
  it.filas.forEach((r,i)=>{if(f && !(r.tema||'').toLowerCase().includes(f) && !(r.audiologo||'').toLowerCase().includes(f)) return;
    const evoP=(Number.isFinite(+r.p_ini)&&Number.isFinite(+r.p_3m))?(Number(r.p_3m)-Number(r.p_ini)):null;
    const evoV=(Number.isFinite(+r.v_ini)&&Number.isFinite(+r.v_3m))?(Number(r.v_3m)-Number(r.v_ini)):null;
    const row=document.createElement('div'); row.className='fm-row';
    row.innerHTML=`<div>${i+1}</div><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}"><input data-i="${i}" data-k="tema" value="${esc(r.tema||'')}"><input data-i="${i}" data-k="audiologo" value="${esc(r.audiologo||'')}"><select data-i="${i}" data-k="duracion">${[1,2,3,4].map(n=>`<option ${Number(r.duracion)===n?'selected':''}>${n}</option>`).join('')}</select><input class="conv ${(Number(r.p_ini)>=80)?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="p_ini" value="${r.p_ini??''}"><input class="conv ${(Number(r.v_ini)>=80)?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="v_ini" value="${r.v_ini??''}"><input class="conv ${(Number(r.p_3m)>=80)?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="p_3m" value="${r.p_3m??''}"><input class="conv ${(Number(r.v_3m)>=80)?'good':'bad'}" type="number" min="0" max="100" step="1" data-i="${i}" data-k="v_3m" value="${r.v_3m??''}"><div style="text-align:center;font-weight:800">${evoP==null?'—':(evoP>0?'↑ ':'')+(evoP<0?'↓ ':'')+Math.abs(Math.round(evoP))}</div><div style="text-align:center;font-weight:800">${evoV==null?'—':(evoV>0?'↑ ':'')+(evoV<0?'↓ ':'')+Math.abs(Math.round(evoV))}</div>`; cont.appendChild(row);
  });
}
$('#fmRows').addEventListener('input',e=>{const i=+e.target.dataset.i,k=e.target.dataset.k;if(!k)return; const it=cur(); if(e.target.type==='number') it.filas[i][k]=e.target.value===''?null:Number(e.target.value); else if(e.target.tagName==='SELECT') it.filas[i][k]=Number(e.target.value); else it.filas[i][k]=e.target.value;});

/* ========= TELEAUDIOLOGIA ========= */
function fillTA(){ $('#taSearch').value=state.taFilter||''; populateTASelect(); renderTA(); }
function populateTASelect(){ const it=cur(); const h=(it.hojas&&it.hojas[0])||sheetTA('Tele 1'); it.hojas=it.hojas||[h];
  const names=[...new Set(h.rows.map(r=>(r.persona||'').trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  $('#taPerson').innerHTML='<option value="">Todos</option>'+names.map(n=>`<option>${esc(n)}</option>`).join('');
}
$('#taSearch').oninput=e=>{state.taFilter=e.target.value.trim(); renderTA();};
$('#taPerson').onchange=e=>{state.taPerson=e.target.value; renderTA();};
function renderTA(){ const it=cur(); const h=it.hojas[0]; const f=(state.taFilter||'').toLowerCase(); const per=state.taPerson||''; const cont=$('#taRows'); cont.innerHTML='';
  let cCert=0,cForm=0;
  h.rows.forEach((r,i)=>{ if((f && !(r.centro||'').toLowerCase().includes(f) && !(r.persona||'').toLowerCase().includes(f)) || (per && (r.persona||'')!==per)) return;
    if(r.certificado) cCert++; if(r.formacion) cForm++;
    const row=document.createElement('div'); row.className='ta-row';
    row.innerHTML=`<div>${i+1}</div><input data-i="${i}" data-k="centro" value="${esc(r.centro||'')}"><input data-i="${i}" data-k="delegado" value="${esc(r.delegado||'')}"><select data-i="${i}" data-k="rol"><option ${r.rol!=='Técnico'?'selected':''}>Audiólogo</option><option ${r.rol==='Técnico'?'selected':''}>Técnico</option></select><input data-i="${i}" data-k="persona" value="${esc(r.persona||'')}" placeholder="Nombre"><input type="checkbox" data-i="${i}" data-k="formacion" ${r.formacion?'checked':''}><input type="checkbox" data-i="${i}" data-k="practicas" ${r.practicas?'checked':''}><input type="checkbox" data-i="${i}" data-k="certificado" ${r.certificado?'checked':''}><input type="checkbox" data-i="${i}" data-k="pruebas" ${r.pruebas?'checked':''}><input type="checkbox" data-i="${i}" data-k="ventas" ${r.ventas?'checked':''}><input data-i="${i}" data-k="obs" value="${esc(r.obs||'')}">`;
    cont.appendChild(row);
  });
  $('#kpiCert').textContent=cCert; $('#kpiForm').textContent=cForm;
}
$('#taRows').addEventListener('input',e=>{const i=+e.target.dataset.i,k=e.target.dataset.k;if(!k)return; const h=cur().hojas[0]; if(e.target.type==='checkbox') h.rows[i][k]=e.target.checked; else h.rows[i][k]=e.target.value;});

/* ========= EQUIPOS ========= */
function fillEQ(){ $('#eqSearch').value=state.eqFilter||''; renderEQ(); }
$('#eqSearch').oninput=e=>{state.eqFilter=e.target.value.trim(); renderEQ();};
$('#btnAddFila').onclick=()=>{ const it=cur(); it.filas.push({equipo:'',serie:'',persona:'',fecha:'',pares:Array.from({length:it.columnas},()=>({centro:'',en:false,sede:false}))}); renderEQ();};
$('#btnAddParCols').onclick=()=>{ const it=cur(); it.columnas=(it.columnas||3)+1; it.filas.forEach(r=>r.pares.push({centro:'',en:false,sede:false})); renderEQ(); };
function renderEQ(){
  const it=cur(); const f=(state.eqFilter||'').toLowerCase(); const body=$('#eqBody'); body.innerHTML='';
  it.filas.forEach((r,i)=>{ const txt=(r.equipo||'')+' '+(r.serie||'')+' '+(r.persona||' ')+(r.pares||[]).map(p=>(p.centro||'')).join(' '); if(f && !txt.toLowerCase().includes(f)) return;
    const row=document.createElement('div'); row.className='eq-row';
    const P=(idx)=>r.pares?.[idx]||{centro:'',en:false,sede:false};
    row.innerHTML=`<div>${i+1}</div><input data-i="${i}" data-k="equipo" value="${esc(r.equipo||'')}"><input data-i="${i}" data-k="serie" value="${esc(r.serie||'')}"><input data-i="${i}" data-k="persona" value="${esc(r.persona||'')}"><input type="date" data-i="${i}" data-k="fecha" value="${r.fecha||''}">
      <input data-i="${i}" data-k="centro" data-c="0" value="${esc(P(0).centro)}"><input type="checkbox" data-i="${i}" data-k="en" data-c="0" ${P(0).en?'checked':''}><input type="checkbox" data-i="${i}" data-k="sede" data-c="0" ${P(0).sede?'checked':''}>
      <input data-i="${i}" data-k="centro" data-c="1" value="${esc(P(1).centro)}"><input type="checkbox" data-i="${i}" data-k="en" data-c="1" ${P(1).en?'checked':''}><input type="checkbox" data-i="${i}" data-k="sede" data-c="1" ${P(1).sede?'checked':''}>
      <input data-i="${i}" data-k="centro" data-c="2" value="${esc(P(2).centro)}"><input type="checkbox" data-i="${i}" data-k="en" data-c="2" ${P(2).en?'checked':''}><input type="checkbox" data-i="${i}" data-k="sede" data-c="2" ${P(2).sede?'checked':''}>`;
    body.appendChild(row);
  });
  body.oninput=(e)=>{ const i=+e.target.dataset.i,k=e.target.dataset.k; if(isNaN(i)||!k) return;
    if(k==='centro'||k==='en'||k==='sede'){ const c=+e.target.dataset.c; const p=cur().filas[i].pares[c]; if(k==='centro') p.centro=e.target.value; else p[k]=e.target.checked; }
    else cur().filas[i][k]= e.target.value;
  };
}

/* ========= render boot ========= */
function renderAll(){ renderLeft(); if(state.selected.section){ renderDetail(); } else { renderDetailBlank(); } }
window.addEventListener('load',()=>{ renderAll(); stamp('Local · listo'); });
</script>
</body>
</html>
