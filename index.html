<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SEGUIMIENTO AUDIO</title>
  <style>
    :root{
      --primary:#d32f2f;         /* rojo principal */
      --primary2:#b71c1c;        /* rojo oscuro */
      --bg:#f7f8fc;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --chip:#ffffff26;
      --ring: rgba(211,47,47,.45);
      color-scheme: light dark;
    }
    *{box-sizing:border-box}
    html,body{margin:0}
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
      background:var(--bg); color:var(--text); line-height:1.35;
    }
    /* ===== Header rojo ===== */
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(90deg,var(--primary2),var(--primary));
      color:#fff; padding:12px 16px;
      box-shadow:0 10px 24px rgba(0,0,0,.28);
    }
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .title{font-weight:900;letter-spacing:.3px;margin-right:8px;font-size:1.15rem}
    .chip{
      display:inline-flex;align-items:center;gap:.45rem;
      background:var(--chip);padding:8px 12px;border-radius:999px;
      font-weight:700;box-shadow:inset 0 0 0 1px #ffffff2b
    }
    .chip input[type="text"]{
      width:140px;border:0;outline:none;font:inherit;background:transparent;color:#fff;
      border-bottom:1px dashed #ffffff85;padding-bottom:2px
    }
    .btn{
      display:inline-flex;align-items:center;gap:.55rem;cursor:pointer;
      border:0;border-radius:999px;padding:9px 14px;font-weight:800;
      background:#fff;color:var(--primary2);box-shadow:0 8px 18px rgba(0,0,0,.28)
    }
    .btn.secondary{background:#f7f7f9;color:#1f2937}
    .sep{opacity:.5;margin:0 .35rem}
    .status{font-weight:800}
    .last{opacity:.92}

    /* ===== Layout ===== */
    main{max-width:1060px;margin:18px auto;padding:0 16px;display:grid;gap:16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{
      grid-column:span 12;background:var(--card);border-radius:16px;padding:16px;
      box-shadow:0 14px 34px rgba(30,41,59,.08)
    }
    .card h2{margin:0 0 10px;font-size:1.05rem}
    label{display:block;font-size:.92rem;color:#111827;opacity:.9;margin-bottom:6px}

    /* ===== Campos con acento rojo ===== */
    input[type="text"],select,textarea,input[type="range"]{
      width:100%;border:1px solid #0000001f;border-radius:12px;padding:10px 12px;font:inherit;background:#fff;
      outline:none;transition:border .15s, box-shadow .15s
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 4px var(--ring)
    }
    textarea{min-height:120px;resize:vertical}
    input[type="checkbox"],input[type="radio"]{accent-color:var(--primary)}
    input[type="range"]{
      accent-color:var(--primary);
      background:linear-gradient(90deg,var(--primary) 0%,var(--primary) var(--val,0%), #d1d5db var(--val,0%), #d1d5db 100%);
      height:6px;border-radius:999px
    }
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
    .muted{opacity:.7;font-size:.9rem}
    pre#preview{background:#eef1f7;border-radius:12px;padding:10px;margin:0;max-height:260px;overflow:auto;font-size:12px}

    /* Estado coloreado */
    .estado--nuevo    {border-color:#2563eb;color:#1e3a8a}
    .estado--en_progreso{border-color:#16a34a;color:#065f46}
    .estado--bloqueado{border-color:#dc2626;color:#7f1d1d}
    .estado--finalizado{border-color:#6b7280;color:#111827}

    /* Dark */
    @media (prefers-color-scheme: dark){
      :root{--bg:#0e1116;--card:#171a21;--text:#e5e7eb;--chip:#ffffff14}
      input,select,textarea{background:#0f1217;color:#e5e7eb;border-color:#ffffff26}
      pre#preview{background:#0f1217;color:#d7dbea}
      .btn{background:#ffe2e2;color:#7f1212}
      .btn.secondary{background:#f0f0f0;color:#1f2937}
    }
  </style>
</head>
<body>
  <!-- CABECERA ROJA -->
  <header>
    <div class="bar">
      <span class="title">SEGUIMIENTO AUDIO</span>

      <!-- LO (identificador) -->
      <span class="chip" title="Identificador del seguimiento (cada LO es un seguimiento separado)">
        üîñ LO: <input id="lo" type="text" placeholder="p.ej. 001" />
      </span>

      <!-- Botones con iconos -->
      <button id="btnSave" class="btn" title="Guardar en la nube">üíæ Guardar</button>
      <button id="btnLoad" class="btn secondary" title="Actualizar desde la nube">üîÑ Actualizar</button>

      <span class="sep">‚Äî</span>
      <label class="chip" title="Guardado autom√°tico"><input id="chkAuto" type="checkbox" /> Auto</label>

      <!-- PIN fijo -->
      <span class="chip" title="PIN">üîë PIN: <strong>&nbsp;AR4321&nbsp;</strong></span>

      <span class="chip status" id="status">‚è≥</span>
      <span class="chip last" id="last">‚Äî</span>
    </div>
  </header>

  <!-- CUERPO -->
  <main class="grid">
    <section class="card">
      <h2>Proyecto</h2>
      <div class="row">
        <div class="col-6">
          <label>T√≠tulo</label>
          <input data-cloud id="titulo" type="text" placeholder="Nombre del proyecto..." />
        </div>
        <div class="col-3">
          <label>Estado</label>
          <select data-cloud id="estado">
            <option value="">‚Äî</option>
            <option value="nuevo">Nuevo</option>
            <option value="en_progreso">En progreso</option>
            <option value="bloqueado">Bloqueado</option>
            <option value="finalizado">Finalizado</option>
          </select>
        </div>
        <div class="col-3">
          <label>Progreso: <span id="lblProgreso" class="muted">0%</span></label>
          <input data-cloud id="progreso" type="range" min="0" max="100" step="1" value="0" />
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Prioridad y opciones</h2>
      <div class="row">
        <div class="col-4">
          <label>Prioridad</label>
          <div>
            <label><input data-cloud name="prioridad" type="radio" value="alta" /> Alta</label>&nbsp;&nbsp;
            <label><input data-cloud name="prioridad" type="radio" value="media" /> Media</label>&nbsp;&nbsp;
            <label><input data-cloud name="prioridad" type="radio" value="baja" /> Baja</label>
          </div>
        </div>
        <div class="col-4">
          <label><input data-cloud id="aviso" type="checkbox" /> Avisarme cuando cambie</label>
        </div>
        <div class="col-4">
          <label>Responsable</label>
          <input data-cloud id="responsable" type="text" placeholder="Nombre..." />
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Checklist</h2>
      <div class="row">
        <div class="col-6"><label><input data-cloud id="tarea1" type="checkbox" /> Brief recibido</label></div>
        <div class="col-6"><label><input data-cloud id="tarea2" type="checkbox" /> Material validado</label></div>
        <div class="col-6"><label><input data-cloud id="tarea3" type="checkbox" /> QA interno</label></div>
        <div class="col-6"><label><input data-cloud id="tarea4" type="checkbox" /> Entregado a cliente</label></div>
      </div>
    </section>

    <section class="card">
      <h2>Notas</h2>
      <textarea data-cloud id="notas" placeholder="Escribe aqu√≠‚Ä¶"></textarea>
      <p class="muted">Todo lo marcado con <code>data-cloud</code> se sincroniza por LO usando el PIN <strong>AR4321</strong>.</p>
    </section>

    <section class="card">
      <h2>Vista previa del estado guardado</h2>
      <pre id="preview">‚Äî</pre>
    </section>
  </main>

  <!-- ===== L√ìGICA (Cloud Sync + UI) ===== -->
  <script type="module">
    /********** Config **********/
    const PIN_BASE = "AR4321"; // PIN fijo
    const ENDPOINT_EMBED = "https://script.google.com/macros/s/AKfycby5vh1Ja0XllWFB98ypWmDcUfUItwEciVimUd5L6Esi1wfPJbcc2dap6G0lciRf51VR/exec";
    const CFG_KEY = "audioseguimiento_endpoint_url";
    const LO_KEY  = "audioseguimiento_lo";
    const BK_KEY  = "audioseguimiento_backup";

    /********** Helpers **********/
    const $ = s => document.querySelector(s);
    const qs = n => new URL(location.href).searchParams.get(n);
    function getEndpoint(){
      const viaQS = qs("endpoint");
      if (viaQS) return viaQS;
      try { return JSON.parse(localStorage.getItem(CFG_KEY) || "null") || ENDPOINT_EMBED; }
      catch { return ENDPOINT_EMBED; }
    }
    function toast(msg){ const t=document.createElement("div"); t.className="toast"; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1800); }

    // Persistir endpoint pasado por URL
    (function persistEndpointQS(){ const ep = qs("endpoint"); if(ep){ try{ new URL(ep); localStorage.setItem(CFG_KEY, JSON.stringify(ep)); }catch{} } })();

    // LO (identificador)
    const loInput = $("#lo");
    (function initLO(){
      const fromQS = qs("lo");
      const stored = localStorage.getItem(LO_KEY) || "";
      loInput.value = (fromQS ?? stored ?? "");
      loInput.addEventListener("change", ()=> localStorage.setItem(LO_KEY, loInput.value.trim()));
    })();
    const effectivePIN = () => {
      const lo = loInput.value.trim();
      return lo ? `${PIN_BASE}:${lo}` : PIN_BASE;
    };

    const status = $("#status"), last = $("#last"), preview = $("#preview");
    const btnSave = $("#btnSave"), btnLoad = $("#btnLoad"), chkAuto = $("#chkAuto");
    const lblProg = $("#lblProgreso"), rngProg = $("#progreso"), estadoSel = $("#estado");

    const setStatus = s => status.textContent = s;
    const setLast   = s => last.textContent = s ? `Actualizado: ${s}` : "‚Äî";

    // Slider color progresivo
    function setRangeBg(){
      const v = (+rngProg.value||0); rngProg.style.setProperty("--val", v+"%");
    }
    rngProg.addEventListener("input", ()=>{ setRangeBg(); lblProg.textContent = `${rngProg.value}%`; });

    // Color din√°mico por estado
    function paintEstado(){
      const v = estadoSel.value || "";
      estadoSel.classList.remove("estado--nuevo","estado--en_progreso","estado--bloqueado","estado--finalizado");
      if (!v) return;
      estadoSel.classList.add(`estado--${v}`);
    }
    estadoSel.addEventListener("change", paintEstado);

    /********** Estado **********/
    function getCloudElements(){ return [...document.querySelectorAll("[data-cloud]")]; }
    function readEl(el){
      if (el.tagName==="INPUT"){
        const t=(el.type||"text").toLowerCase();
        if (t==="checkbox") return !!el.checked;
        if (t==="radio") return el.checked ? el.value : null;
        return el.value;
      }
      if (el.tagName==="TEXTAREA"||el.tagName==="SELECT") return el.value;
      return el.textContent;
    }
    function writeEl(el,val){
      if (el.tagName==="INPUT"){
        const t=(el.type||"text").toLowerCase();
        if (t==="checkbox"){ el.checked=!!val; return; }
        if (t==="radio"){ el.checked=(val===el.value); return; }
        el.value=(val??"");
        el.dispatchEvent(new Event("input",{bubbles:true}));
        el.dispatchEvent(new Event("change",{bubbles:true}));
        return;
      }
      if (el.tagName==="TEXTAREA"||el.tagName==="SELECT"){
        el.value=(val??"");
        el.dispatchEvent(new Event("input",{bubbles:true}));
        el.dispatchEvent(new Event("change",{bubbles:true}));
        return;
      }
      if (typeof val==="string") el.textContent=val;
    }
    function collectState(){
      const s={}; getCloudElements().forEach((el,i)=>{ const k=el.id||el.name||`el_${i}`; const v=readEl(el); if(v!==null&&k) s[k]=v; });
      preview.textContent = JSON.stringify(s,null,2);
      return s;
    }
    function applyState(s){
      if(!s||typeof s!=="object") return;
      Object.keys(s).forEach(k=>{
        const el=document.getElementById(k)||document.querySelector(`[name="${CSS.escape(k)}"]`);
        if(el) writeEl(el,s[k]);
      });
      // Ajustes visuales dependientes
      if (s?.progreso !== undefined){ rngProg.value = s.progreso; setRangeBg(); lblProg.textContent = `${s.progreso}%`; }
      paintEstado();
      preview.textContent = JSON.stringify(s,null,2);
    }

    /********** Copia local **********/
    const saveBackup = (state,pin)=>{ try{ localStorage.setItem(`${BK_KEY}:${pin}`, JSON.stringify({when:Date.now(), state})); }catch{} };
    const loadBackup = (pin)=>{ try{ return JSON.parse(localStorage.getItem(`${BK_KEY}:${pin}`)||"null"); }catch{ return null; } };

    /********** Nube **********/
    async function saveToCloud(){
      try{
        const PIN = effectivePIN();
        setStatus("üíæ Guardando‚Ä¶");
        const ENDPOINT = getEndpoint();
        const state = collectState();
        const res = await fetch(ENDPOINT,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ action:"save", pin: PIN, state })
        });
        const json = await res.json().catch(()=>null);
        if(!res.ok||!json?.ok) throw new Error(json?.error||("HTTP "+res.status));
        setStatus("‚úÖ Guardado"); setLast(json.updatedAt); toast("Guardado en la nube"); saveBackup(state,PIN);
      }catch(e){ console.error(e); setStatus("‚ùå Error al guardar"); toast("Error al guardar"); }
    }
    async function loadFromCloud(){
      try{
        const PIN = effectivePIN();
        setStatus("‚¨áÔ∏è Cargando‚Ä¶");
        const u=new URL(getEndpoint()); u.searchParams.set("action","load"); u.searchParams.set("pin", PIN);
        const res=await fetch(u.toString(),{method:"GET"}); const json=await res.json().catch(()=>null);
        if(!res.ok||!json?.ok) throw new Error(json?.error||("HTTP "+res.status));
        applyState(json.state||{}); setStatus("‚úÖ Actualizado"); setLast(json.updatedAt); toast("Datos cargados");
      }catch(e){
        console.error(e); setStatus("‚ùå Error al cargar");
        const bk=loadBackup(effectivePIN()); if(bk?.state){ applyState(bk.state); toast("Restaurado desde copia local"); }
      }
    }

    /********** Auto-guardado + atajos **********/
    let autosaveTimer=null;
    function autoSaveTick(){ if(!$("#chkAuto").checked) return; clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveToCloud,800); }
    function hookAutosave(){ getCloudElements().forEach(el=>["input","change","keyup","blur"].forEach(evt=>el.addEventListener(evt,autoSaveTick))); }
    document.addEventListener("keydown", e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="s"){ e.preventDefault(); saveToCloud(); } });
    loInput.addEventListener("change", ()=>{ setLast("‚Äî"); loadFromCloud(); });

    /********** Arranque **********/
    hookAutosave(); setRangeBg(); loadFromCloud();
  </script>
</body>
</html>
