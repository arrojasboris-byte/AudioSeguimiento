<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AudioSeguimiento ‚Äì Plataforma (Cloud Sync)</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; background:#f6f7fb; }
    header { position:sticky; top:0; z-index:20; background:linear-gradient(90deg,#5a7bf7,#7a9dff); color:#fff; padding:12px 16px; box-shadow:0 6px 18px rgba(0,0,0,.15); }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn { border:0; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow: 0 6px 16px rgba(0,0,0,.15); }
    .btn.primary { background:#fff; color:#2a45b8; }
    .btn.secondary { background:rgba(255,255,255,.95); color:#1a1c22; }
    .chip { padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.2); font-weight:600; }
    .status { margin-left:6px; opacity:.95 }
    .last { opacity:.9 }
    main { max-width:1060px; margin:18px auto; padding:0 16px; display:grid; gap:16px; }
    .grid { display:grid; grid-template-columns:repeat(12,1fr); gap:16px; }
    .card { grid-column:span 12; background:#fff; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(34,48,92,.08); }
    .card h2 { margin:0 0 10px; font-size:1.05rem; }
    label { display:block; font-size:.92rem; opacity:.85; margin-bottom:6px; }
    input[type="text"], select, textarea, input[type="range"]{ width:100%; border:1px solid rgba(0,0,0,.12); border-radius:12px; padding:10px 12px; font:inherit; background:#fff; }
    textarea{ min-height:140px; resize:vertical; }
    .row{ display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
    .col-6{ grid-column:span 6; } .col-4{ grid-column:span 4; } .col-3{ grid-column:span 3; }
    .muted{ opacity:.7; font-size:.9rem; }
    pre#preview{ background:#f1f3f7; border-radius:12px; padding:10px; margin:0; max-height:280px; overflow:auto; font-size:12px; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:0 14px 30px rgba(0,0,0,.25); z-index:9999; opacity:.97 }
    @media (prefers-color-scheme: dark){
      body{ background:#0e1116; } .card{ background:#171a21; }
      input,select,textarea{ background:#0f1217; color:#eee; border-color:rgba(255,255,255,.12); }
      pre#preview{ background:#0f1217; color:#d7dbea; }
      .btn.primary{ background:#e9edff; color:#1a2f9a; } .btn.secondary{ background:#f1f1f1; color:#1e1e1e; }
    }
  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <button id="btnSave" class="btn primary">Guardar</button>
      <button id="btnLoad" class="btn secondary">Actualizar</button>
      <label class="chip"><input id="chkAuto" type="checkbox" style="transform:translateY(1px)" /> Auto</label>
      <span id="status" class="status chip">‚è≥</span>
      <span id="last" class="last chip">‚Äî</span>
      <span class="chip">PIN: <strong>&nbsp;AR4321&nbsp;</strong></span>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h2>Proyecto</h2>
      <div class="row">
        <div class="col-6">
          <label>T√≠tulo</label>
          <input data-cloud id="titulo" type="text" placeholder="Nombre del proyecto..." />
        </div>
        <div class="col-3">
          <label>Estado</label>
          <select data-cloud id="estado">
            <option value="">‚Äî</option><option value="nuevo">Nuevo</option>
            <option value="en_progreso">En progreso</option><option value="bloqueado">Bloqueado</option>
            <option value="finalizado">Finalizado</option>
          </select>
        </div>
        <div class="col-3">
          <label>Progreso: <span id="lblProgreso" class="muted">0%</span></label>
          <input data-cloud id="progreso" type="range" min="0" max="100" step="1" value="0" />
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Prioridad y opciones</h2>
      <div class="row">
        <div class="col-4">
          <label>Prioridad</label>
          <div>
            <label><input data-cloud name="prioridad" type="radio" value="alta" /> Alta</label>&nbsp;&nbsp;
            <label><input data-cloud name="prioridad" type="radio" value="media" /> Media</label>&nbsp;&nbsp;
            <label><input data-cloud name="prioridad" type="radio" value="baja" /> Baja</label>
          </div>
        </div>
        <div class="col-4"><label><input data-cloud id="aviso" type="checkbox" /> Avisarme cuando cambie</label></div>
        <div class="col-4"><label>Responsable</label><input data-cloud id="responsable" type="text" placeholder="Nombre..." /></div>
      </div>
    </section>

    <section class="card">
      <h2>Notas</h2>
      <textarea data-cloud id="notas" placeholder="Escribe aqu√≠‚Ä¶"></textarea>
      <p class="muted">Todo lo marcado con <code>data-cloud</code> se sincroniza en la nube.</p>
    </section>

    <section class="card">
      <h2>Vista previa del estado guardado</h2>
      <pre id="preview">‚Äî</pre>
    </section>
  </main>

  <script type="module">
    /* ===== Config ===== */
    const PIN = "AR4321";
    const ENDPOINT_EMBED = "https://script.google.com/macros/s/AKfycby5vh1Ja0XllWFB98ypWmDcUfUItwEciVimUd5L6Esi1wfPJbcc2dap6G0lciRf51VR/exec";
    const CFG_KEY = "audioseguimiento_endpoint_url";
    const BK_KEY  = "audioseguimiento_backup";

    /* ===== Helpers ===== */
    const qs = n => new URL(location.href).searchParams.get(n);
    function getEndpoint(){
      const viaQS = qs("endpoint");
      if (viaQS) return viaQS;
      try { return JSON.parse(localStorage.getItem(CFG_KEY) || "null") || ENDPOINT_EMBED; }
      catch { return ENDPOINT_EMBED; }
    }
    (function persistQS(){ const ep = qs("endpoint"); if (ep) { try{ new URL(ep); localStorage.setItem(CFG_KEY, JSON.stringify(ep)); }catch{} } })();

    const $ = s => document.querySelector(s);
    const status = $("#status"), last = $("#last"), preview = $("#preview");
    const btnSave = $("#btnSave"), btnLoad = $("#btnLoad"), chkAuto = $("#chkAuto");
    const lblProg = $("#lblProgreso"), rngProg = $("#progreso");
    rngProg.addEventListener("input", ()=> lblProg.textContent = `${rngProg.value}%`);
    const setStatus = t => status.textContent = t;
    const setLast   = s => last.textContent = s ? `Actualizado: ${s}` : "‚Äî";
    function toast(m){ const t=document.createElement("div"); t.className="toast"; t.textContent=m; document.body.appendChild(t); setTimeout(()=>t.remove(),1800); }

    /* ===== Estado ===== */
    function getCloudElements(){ return [...document.querySelectorAll("[data-cloud]")]; }
    function readEl(el){
      if (el.tagName==="INPUT"){
        const t=(el.type||"text").toLowerCase();
        if (t==="checkbox") return !!el.checked;
        if (t==="radio") return el.checked ? el.value : null;
        return el.value;
      }
      if (el.tagName==="TEXTAREA"||el.tagName==="SELECT") return el.value;
      return el.textContent;
    }
    function writeEl(el,val){
      if (el.tagName==="INPUT"){
        const t=(el.type||"text").toLowerCase();
        if (t==="checkbox"){ el.checked=!!val; return; }
        if (t==="radio"){ el.checked=(val===el.value); return; }
        el.value=(val??"");
        el.dispatchEvent(new Event("input",{bubbles:true}));
        el.dispatchEvent(new Event("change",{bubbles:true}));
        return;
      }
      if (el.tagName==="TEXTAREA"||el.tagName==="SELECT"){
        el.value=(val??"");
        el.dispatchEvent(new Event("input",{bubbles:true}));
        el.dispatchEvent(new Event("change",{bubbles:true}));
        return;
      }
      if (typeof val==="string") el.textContent=val;
    }
    function collectState(){
      const s={}; getCloudElements().forEach((el,i)=>{ const k=el.id||el.name||`el_${i}`; const v=readEl(el); if(v!==null&&k) s[k]=v; });
      preview.textContent = JSON.stringify(s,null,2);
      return s;
    }
    function applyState(s){
      if(!s||typeof s!=="object") return;
      Object.keys(s).forEach(k=>{ const el=document.getElementById(k)||document.querySelector(`[name="${CSS.escape(k)}"]`); if(el) writeEl(el,s[k]); });
      if (s?.progreso !== undefined) lblProg.textContent = `${s.progreso}%`;
      preview.textContent = JSON.stringify(s,null,2);
    }

    /* ===== Copia local ===== */
    const saveBackup = s => { try{ localStorage.setItem(BK_KEY, JSON.stringify({when:Date.now(), state:s})); }catch{} };
    const loadBackup = () => { try{ return JSON.parse(localStorage.getItem(BK_KEY)||"null"); }catch{ return null; } };

    /* ===== Nube ===== */
    async function saveToCloud(){
      try{
        setStatus("üíæ Guardando‚Ä¶");
        const ENDPOINT = getEndpoint();
        const state = collectState();
        const res = await fetch(ENDPOINT,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({action:"save", pin:PIN, state}) });
        const json = await res.json().catch(()=>null);
        if(!res.ok||!json?.ok) throw new Error(json?.error||("HTTP "+res.status));
        setStatus("‚úÖ Guardado"); setLast(json.updatedAt); toast("Guardado en la nube"); saveBackup(state);
      }catch(e){ console.error(e); setStatus("‚ùå Error al guardar"); toast("Error al guardar"); }
    }
    async function loadFromCloud(){
      try{
        setStatus("‚¨áÔ∏è Cargando‚Ä¶");
        const u=new URL(getEndpoint()); u.searchParams.set("action","load"); u.searchParams.set("pin",PIN);
        const res=await fetch(u.toString(),{method:"GET"}); const json=await res.json().catch(()=>null);
        if(!res.ok||!json?.ok) throw new Error(json?.error||("HTTP "+res.status));
        applyState(json.state||{}); setStatus("‚úÖ Actualizado"); setLast(json.updatedAt); toast("Datos cargados");
      }catch(e){ console.error(e); setStatus("‚ùå Error al cargar"); const bk=loadBackup(); if(bk?.state){ applyState(bk.state); toast("Restaurado desde copia local"); } }
    }

    /* ===== Auto-guardado y atajos ===== */
    let autosaveTimer=null;
    function autoSaveTick(){ if(!chkAuto.checked) return; clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveToCloud,800); }
    function hookAutosave(){ getCloudElements().forEach(el=>["input","change","keyup","blur"].forEach(evt=>el.addEventListener(evt,autoSaveTick))); }
    document.addEventListener("keydown",e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="s"){ e.preventDefault(); saveToCloud(); } });

    /* ===== Eventos & arranque ===== */
    btnSave.addEventListener("click", saveToCloud);
    btnLoad.addEventListener("click", loadFromCloud);
    chkAuto.addEventListener("change", ()=>{ if(chkAuto.checked) autoSaveTick(); });
    hookAutosave();
    loadFromCloud();
  </script>
</body>
</html>
