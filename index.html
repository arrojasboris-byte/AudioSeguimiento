<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>AudioSeguimiento ‚Äì Cloud Sync</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif; line-height: 1.35; }
    header { padding: 16px 18px; background: linear-gradient(90deg, #5a7bf7, #7a9dff); color: #fff; }
    header h1 { margin: 0; font-size: 1.2rem; letter-spacing: .3px; }
    main { padding: 18px; display: grid; gap: 16px; max-width: 900px; margin: 0 auto; }
    .card { background: rgba(255,255,255,.75); backdrop-filter: blur(6px); border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.08); padding: 14px; }
    .label { font-size: .9rem; opacity: .85; margin-bottom: 6px; display: block; }
    textarea, input, select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(0,0,0,.15); outline: none; font: inherit; background: rgba(255,255,255,.9); }
    small.helper { opacity: .75; display: block; margin-top: 8px; }
    pre.preview { max-height: 280px; overflow: auto; font-size: 12px; padding: 10px; background: rgba(0,0,0,.05); border-radius: 10px; margin: 0; }
    @media (prefers-color-scheme: dark) {
      .card { background: rgba(25,25,28,.6); }
      textarea, input, select { background: rgba(30,30,35,.9); color: #eee; border-color: rgba(255,255,255,.15); }
      pre.preview { background: rgba(255,255,255,.06); color: #ddd; }
    }
  </style>
</head>
<body>
  <header>
    <h1>AudioSeguimiento ‚Äì Edici√≥n con guardado en la nube</h1>
  </header>

  <main>
    <!-- Marca tus campos reales con data-cloud; #notas se usa como respaldo -->
    <div class="card">
      <label for="notas" class="label">Notas (ejemplo, sincroniza con la nube)</label>
      <textarea id="notas" data-cloud rows="7" placeholder="Escribe aqu√≠..."></textarea>
      <small class="helper">Pon <code>data-cloud</code> en cada campo de tu plataforma que quieras sincronizar.</small>
    </div>

    <div class="card">
      <strong>Vista previa del estado guardado</strong>
      <pre id="estado-previsualizacion" class="preview">‚Äî</pre>
    </div>
  </main>

  <!-- === Cloud Sync SIN TOKENS ‚Äì INTEGRADO === -->
  <script type="module">
    /***** CONFIG *****/
    const PIN = "AR4321";
    // Endpoint integrado (tu Apps Script Web App):
    const ENDPOINT_EMBED = "https://script.google.com/macros/s/AKfycby5vh1Ja0XllWFB98ypWmDcUfUItwEciVimUd5L6Esi1wfPJbcc2dap6G0lciRf51VR/exec";
    const CFG_KEY = "audioseguimiento_endpoint_url";
    const BK_KEY  = "audioseguimiento_backup";

    /***** Utilidades *****/
    function qs(name){ const u = new URL(location.href); return u.searchParams.get(name); }
    function getEndpoint(){
      // Prioridad: ?endpoint=... > guardado en localStorage > embebido
      const ep = qs("endpoint");
      if (ep) return ep;
      try { return JSON.parse(localStorage.getItem(CFG_KEY)||"null") || ENDPOINT_EMBED; } catch { return ENDPOINT_EMBED; }
    }
    function setEndpoint(url){ localStorage.setItem(CFG_KEY, JSON.stringify(url)); }

    // Si lleg√≥ via ?endpoint=..., guardarlo para futuras visitas
    (function captureEndpointFromLink(){
      const ep = qs("endpoint");
      if (ep) { try { const url = new URL(ep); setEndpoint(url.toString()); } catch {} }
    })();

    /***** UI flotante *****/
    const bar = document.createElement("div");
    Object.assign(bar.style,{
      position:"fixed", right:"12px", bottom:"12px", zIndex:2147483647,
      background:"rgba(0,0,0,.82)", color:"#fff", padding:"8px 10px",
      borderRadius:"12px", fontFamily:"system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif",
      boxShadow:"0 6px 18px rgba(0,0,0,.25)", display:"flex", gap:"8px", alignItems:"center", flexWrap:"wrap"
    });
    bar.innerHTML = `
      <strong>Cloud Sync</strong>
      <button id="cloud-save" style="padding:.4rem .6rem;border:0;border-radius:8px;cursor:pointer;">Guardar</button>
      <button id="cloud-load" style="padding:.4rem .6rem;border:0;border-radius:8px;cursor:pointer;">Actualizar</button>
      <label style="display:flex;align-items:center;gap:.35rem;font-size:.9em;opacity:.95;">
        <input id="cloud-autosave" type="checkbox" style="transform:translateY(1px)" />
        Auto
      </label>
      <span id="cloud-status" style="opacity:.95">‚è≥</span>
      <span id="cloud-last" style="opacity:.9">‚Äî</span>
    `;
    document.body.appendChild(bar);
    const btnSave = bar.querySelector("#cloud-save");
    const btnLoad = bar.querySelector("#cloud-load");
    const chkAuto = bar.querySelector("#cloud-autosave");
    const elStatus= bar.querySelector("#cloud-status");
    const elLast  = bar.querySelector("#cloud-last");

    const preview = document.getElementById("estado-previsualizacion");
    const setStatus = (t)=> elStatus.textContent = t;
    const setLast   = (s)=> elLast.textContent = s ? `√öltima actualizaci√≥n: ${s}` : "‚Äî";

    /***** Qu√© sincronizar *****/
    function getCloudElements(){
      const marked = [...document.querySelectorAll("[data-cloud]")];
      if (marked.length) return marked;
      const fb = document.querySelector("#notas");
      return fb ? [fb] : [];
    }
    function readEl(el){
      if (el.tagName==="INPUT"){
        const t=(el.type||"text").toLowerCase();
        if (t==="checkbox") return !!el.checked;
        if (t==="radio")    return el.checked ? el.value : null;
        return el.value;
      }
      if (el.tagName==="TEXTAREA"||el.tagName==="SELECT") return el.value;
      return el.textContent;
    }
    function writeEl(el,val){
      try{
        if (el.tagName==="INPUT"){
          const t=(el.type||"text").toLowerCase();
          if (t==="checkbox"){ el.checked=!!val; return; }
          if (t==="radio"){ el.checked=(val===el.value); return; }
          el.value=(val??"");
          el.dispatchEvent(new Event("input",{bubbles:true}));
          el.dispatchEvent(new Event("change",{bubbles:true}));
          return;
        }
        if (el.tagName==="TEXTAREA"||el.tagName==="SELECT"){
          el.value=(val??"");
          el.dispatchEvent(new Event("input",{bubbles:true}));
          el.dispatchEvent(new Event("change",{bubbles:true}));
          return;
        }
        if (typeof val==="string") el.textContent=val;
      }catch(e){ console.warn("No se pudo aplicar valor", e); }
    }
    function collectState(){
      const els=getCloudElements(); const state={};
      els.forEach((el,i)=>{ const k=el.id||el.name||`el_${i}`; const v=readEl(el); if (v!==null&&k) state[k]=v; });
      if (preview) preview.textContent = JSON.stringify(state, null, 2);
      return state;
    }
    function applyState(state){
      if (!state || typeof state!=="object") return;
      Object.keys(state).forEach(k=>{
        let el=document.getElementById(k)||document.querySelector(`[name="${CSS.escape(k)}"]`);
        if (el) writeEl(el,state[k]);
      });
      if (preview) preview.textContent = JSON.stringify(state, null, 2);
    }

    /***** Backup local (offline) *****/
    function saveBackup(state){ try{ localStorage.setItem(BK_KEY, JSON.stringify({when:Date.now(), state})); }catch{} }
    function loadBackup(){ try{ return JSON.parse(localStorage.getItem(BK_KEY)||"null"); }catch{ return null; } }

    /***** Nube (sin tokens) *****/
    async function saveToCloud(){
      const ENDPOINT = getEndpoint();
      try{
        setStatus("üíæ Guardando‚Ä¶");
        const state = collectState();
        const res = await fetch(ENDPOINT,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({action:"save", pin:PIN, state})
        });
        const json = await res.json().catch(()=>null);
        if(!res.ok || !json?.ok) throw new Error(json?.error || ("HTTP "+res.status));
        setStatus("‚úÖ Guardado"); setLast(json.updatedAt);
        saveBackup(state);
      }catch(e){
        console.error(e);
        setStatus("‚ùå Error al guardar");
        alert("No se pudo guardar. Revisa el endpoint o el backend.");
      }
    }
    async function loadFromCloud(){
      const ENDPOINT = getEndpoint();
      try{
        setStatus("‚¨áÔ∏è Cargando‚Ä¶");
        const u = new URL(ENDPOINT);
        u.searchParams.set("action","load");
        u.searchParams.set("pin", PIN);
        const res = await fetch(u.toString(),{method:"GET"});
        const json = await res.json().catch(()=>null);
        if(!res.ok || !json?.ok) throw new Error(json?.error || ("HTTP "+res.status));
        applyState(json.state || {}); setStatus("‚úÖ Actualizado"); setLast(json.updatedAt);
      }catch(e){
        console.error(e);
        setStatus("‚ùå Error al cargar");
        alert("No se pudo cargar. Revisa el endpoint o el backend.");
        const bk = loadBackup(); if (bk?.state){ applyState(bk.state); setStatus("‚ÑπÔ∏è Restaurado desde copia local"); }
      }
    }

    /***** Auto-guardado opcional *****
     * Activa la casilla ‚ÄúAuto‚Äù y cada cambio en campos data-cloud
     * disparar√° un guardado (con peque√±o debounce).
     */
    let autosaveTimer=null;
    function autoSaveTick(){
      if (!chkAuto.checked) return;
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(saveToCloud, 800);
    }
    function hookAutosave(){
      const els=getCloudElements();
      els.forEach(el=>["input","change","keyup","blur"].forEach(evt=>el.addEventListener(evt, autoSaveTick)));
    }

    /***** Eventos / arranque *****/
    const chkAuto = document.getElementById("cloud-autosave");
    document.getElementById("cloud-save").addEventListener("click", saveToCloud);
    document.getElementById("cloud-load").addEventListener("click", loadFromCloud);
    document.getElementById("cloud-autosave").addEventListener("change", ()=>{ if(chkAuto.checked) autoSaveTick(); });

    hookAutosave();
    loadFromCloud(); // carga inicial autom√°tica usando el endpoint embebido (o el de la URL)
  </script>
</body>
</html>
