<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SEGUIMIENTO AUDIO</title>
<style>
  :root{
    --rojo:#c82727;
    --rojo-osc:#a71f1f;
    --bg:#f6f7fb;
    --card:#ffffff;
    --shadow:0 8px 22px rgba(0,0,0,.08);

    /* Colores pastel por secci√≥n */
    --col-exclusivos:#fde2e4;   /* rosa claro */
    --col-flop:#e2f0cb;         /* verde claro */
    --col-visitas:#cde7f0;      /* azul claro */
    --col-formaciones:#f9e5c9;  /* naranja claro */
    --col-tele:#eadcf8;         /* lila claro */
  }
  html,body{height:100%;}
  body{
    margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;color:#222;
  }

  /* Header */
  .topbar{
    position:sticky;top:0;z-index:3;
    display:flex;align-items:center;gap:.75rem;
    padding:.9rem 1rem;background:linear-gradient(180deg,var(--rojo),var(--rojo-osc));
    color:#fff;box-shadow:var(--shadow);
  }
  .brand{font-weight:800;letter-spacing:.5px;font-size:1.1rem}
  .spacer{flex:1}
  .btn{border:0;border-radius:999px;padding:.55rem .9rem;cursor:pointer;box-shadow:var(--shadow);font-weight:650}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-lite{background:#fff;color:var(--rojo); }
  .btn-save{background:#fff;color:#a31212}
  .pill{display:inline-flex;align-items:center;gap:.45rem;background:#fff1; padding:.45rem .7rem;border-radius:999px;border:1px solid #fff3;font-weight:600}
  .pill.ok{background:#1fcc7b22;border-color:#1fcc7b55}
  .pill.lock{background:#ffd16622;border-color:#ffd16655}
  .ar{min-width:36px;height:36px;border-radius:10px;background:#fff;color:#b30000;font-weight:900;border:0;box-shadow:var(--shadow);cursor:pointer}
  .ts{opacity:.9;font-size:.9rem}

  /* Layout */
  .wrap{display:grid;grid-template-columns:330px 1fr;gap:1.25rem;padding:1.25rem;max-width:1400px;margin:0 auto}
  .col{background:transparent}
  .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);}

  /* Left column */
  .left .title{
    font-weight:900;font-size:1.15rem;padding:1rem 1.1rem;border-bottom:1px solid #eee;
  }
  .section{
    margin:1rem;border-radius:18px;overflow:hidden;border:1px solid #e9e9ef;background:#fff;
  }
  .sec-head{
    display:flex;align-items:center;justify-content:space-between;gap:.5rem;
    padding:.85rem 1rem;font-weight:900
  }
  .sec-head .tools{display:flex;gap:.4rem}
  .sec-btn{display:inline-flex;align-items:center;justify-content:center;width:38px;height:34px;border-radius:10px;border:0;box-shadow:var(--shadow);background:#fff;cursor:pointer}
  .sec-list{padding:.25rem .6rem .8rem .6rem}
  .item{
    display:flex;align-items:center;justify-content:space-between;gap:.6rem;
    background:#fff;border:1px solid #eee;border-radius:12px;padding:.7rem .8rem;margin:.55rem 0;cursor:pointer;
  }
  .item:hover{background:#fafafa}
  .item .name{font-weight:800}
  .item small{display:block;opacity:.65}
  .item .acts{display:flex;gap:.35rem}
  .ico{font-size:18px;opacity:.75}
  .muted{opacity:.65}

  /* Right column (detalle) */
  .detail{padding:1.2rem 1.3rem 2rem 1.3rem;min-height:520px;border-radius:22px;border:1px solid #ececf5;background:#fff}
  .detail h2{margin:.2rem 0 0 0;font-size:1.2rem}
  .detail .hint{opacity:.7;margin:.2rem 0 1rem}
  .field{display:grid;gap:.35rem;margin:.7rem 0}
  .field label{font-weight:700;opacity:.9}
  .field input,.field select,.field textarea{
    border:1px solid #ddd;border-radius:12px;padding:.6rem .7rem;font-size:1rem;background:#fff;outline:none;
  }
  .field textarea{min-height:120px;resize:vertical}
  .bar-right{display:flex;justify-content:flex-end;gap:.6rem}
  .btn-ghost{background:#fff;border:1px solid #ddd;color:#444}
  .badge{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:#00000010;font-size:.85rem}
  .row{display:flex;gap:1rem;align-items:flex-end;flex-wrap:wrap}
  .row .field{flex:1;min-width:220px}

  /* Pastel helpers para ‚Äúpintar‚Äù secciones y detalle */
  .bg-exclusivos{ background:var(--col-exclusivos);}
  .bg-flop{ background:var(--col-flop);}
  .bg-visitas{ background:var(--col-visitas);}
  .bg-formaciones{ background:var(--col-formaciones);}
  .bg-tele{ background:var(--col-tele);}
  .tone{border-color:#00000010}
  .tone .item{border-color:#00000010;background:#ffffffcc}

  /* Tablas tipo Excel */
  .panel{margin:1rem 0 1.2rem;background:#ffffffd0;border:1px solid #e7e7ef;border-radius:14px;box-shadow:var(--shadow)}
  .panel .ph{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;border-bottom:1px solid #eee;font-weight:900}
  .panel .pl{padding:.8rem}
  .grid{display:grid;gap:.5rem}
  .grid .hdr{font-weight:800;opacity:.75}
  .grid input[type="text"], .grid input[type="number"], .grid input[type="date"], .grid textarea, .grid select {
    width:100%;padding:.45rem .55rem;border:1px solid #ddd;border-radius:10px;background:#fff
  }
  .grid .rowx{display:grid;gap:.5rem;align-items:center}
  .rowx .del{justify-self:end}
  .row-tools{margin-top:.6rem;display:flex;gap:.5rem}
  .file-list{display:flex;flex-direction:column;gap:.35rem;margin-top:.5rem}
  .file-pill{display:flex;align-items:center;gap:.5rem;background:#00000008;border:1px solid #00000012;border-radius:999px;padding:.25rem .55rem}

  /* Columnas por panel */
  .grid-acciones{grid-template-columns: 140px 1fr 120px 80px 80px 38px;}
  .grid-forma   {grid-template-columns: 1.2fr .7fr .7fr 1.6fr 38px;}
  .grid-proc    {grid-template-columns: 180px 120px 160px 38px;}

  @media (max-width:1080px){
    .grid-acciones{grid-template-columns: 120px 1fr 110px 70px 70px 38px;}
  }
  @media (max-width:980px){
    .wrap{grid-template-columns:1fr;gap:1rem}
  }
</style>
</head>
<body>
  <!-- TOP BAR -->
  <header class="topbar">
    <button class="ar" title="AR" id="btnAR">AR</button>
    <div class="brand">SEGUIMIENTO AUDIO</div>
    <div class="spacer"></div>

    <button class="btn btn-lite" id="btnEdit">Editar</button>
    <button class="btn btn-lite" id="btnRefresh">Actualizar</button>
    <button class="btn btn-save" id="btnSaveTop">Guardar</button>

    <span class="pill ok" id="pillOk">‚úì Actualizado</span>
    <span class="pill ts" id="stamp">Actualizado: ‚Äî</span>
    <span class="pill lock" id="lock">üîì Editando</span>
  </header>

  <main class="wrap">
    <!-- LEFT -->
    <aside class="col left">
      <div class="card">
        <div class="title">SEGUIMIENTO</div>

        <section class="section bg-exclusivos tone" data-section="CENTROS EXCLUSIVOS" data-tone="exclusivos">
          <div class="sec-head">
            <div>üìí CENTROS EXCLUSIVOS <span class="badge muted">(m√°x. 10)</span></div>
            <div class="tools">
              <button class="sec-btn" data-act="toggle" title="Mostrar/Ocultar">‚ñæ</button>
              <button class="sec-btn" data-act="add" title="A√±adir">Ôºã</button>
            </div>
          </div>
          <div class="sec-list" role="list"></div>
        </section>

        <section class="section bg-flop tone" data-section="CENTROS FLOP" data-tone="flop">
          <div class="sec-head">
            <div>üìí CENTROS FLOP</div>
            <div class="tools">
              <button class="sec-btn" data-act="toggle" title="Mostrar/Ocultar">‚ñæ</button>
              <button class="sec-btn" data-act="add" title="A√±adir">Ôºã</button>
            </div>
          </div>
          <div class="sec-list" role="list"></div>
        </section>

        <section class="section bg-visitas tone" data-section="VISITAS AUDIO" data-tone="visitas">
          <div class="sec-head">
            <div>üìã VISITAS AUDIO</div>
            <div class="tools">
              <button class="sec-btn" data-act="toggle" title="Mostrar/Ocultar">‚ñæ</button>
              <button class="sec-btn" data-act="add" title="A√±adir">Ôºã</button>
            </div>
          </div>
          <div class="sec-list" role="list"></div>
        </section>

        <section class="section bg-formaciones tone" data-section="FORMACIONES Y MENTORING" data-tone="formaciones">
          <div class="sec-head">
            <div>üéì FORMACIONES Y MENTORING</div>
            <div class="tools">
              <button class="sec-btn" data-act="toggle" title="Mostrar/Ocultar">‚ñæ</button>
              <button class="sec-btn" data-act="add" title="A√±adir">Ôºã</button>
            </div>
          </div>
          <div class="sec-list" role="list"></div>
        </section>

        <section class="section bg-tele tone" data-section="TELEAUDIOLOGIA" data-tone="tele">
          <div class="sec-head">
            <div>üì° TELEAUDIOLOGIA</div>
            <div class="tools">
              <button class="sec-btn" data-act="toggle" title="Mostrar/Ocultar">‚ñæ</button>
              <button class="sec-btn" data-act="add" title="A√±adir">Ôºã</button>
            </div>
          </div>
          <div class="sec-list" role="list"></div>
        </section>
      </div>
    </aside>

    <!-- RIGHT -->
    <section class="col">
      <div id="detail" class="detail card">
        <div class="row" style="align-items:center">
          <h2 id="detTitle">Detalle</h2>
          <span id="detTag" class="badge">‚Äî</span>
        </div>
        <div class="hint" id="detHint">Selecciona un item a la izquierda o crea uno con Ôºã.</div>

        <!-- Form gen√©rico (para otras secciones) -->
        <div id="detFormGeneric" style="display:none">
          <div class="field">
            <label for="gNombre">Nombre</label>
            <input id="gNombre" type="text" placeholder="Nombre" />
          </div>
          <div class="row">
            <div class="field"><label for="gFecha">Fecha</label><input id="gFecha" type="date" /></div>
            <div class="field"><label for="gEstado">Estado</label><input id="gEstado" type="text" placeholder="Estado" /></div>
          </div>
          <div class="field">
            <label for="gNotas">Notas</label>
            <textarea id="gNotas" placeholder="Observaciones‚Ä¶"></textarea>
          </div>
          <div class="bar-right">
            <button class="btn btn-ghost" id="btnCancelG">Cancelar</button>
            <button class="btn btn-save" id="btnSaveG">üíæ Guardar cambios</button>
          </div>
        </div>

        <!-- Form espec√≠fico Centro Exclusivo -->
        <div id="detFormExclusivo" style="display:none">
          <div class="row">
            <div class="field"><label>Nombre</label><input id="cNombre" type="text" placeholder="Ej.: Reina Mercedes"></div>
            <div class="field"><label>Delegado</label><input id="cDelegado" type="text" placeholder="Nombre del delegado"></div>
          </div>
          <div class="row">
            <div class="field"><label>Audi√≥logo</label><input id="cAudiologo" type="text" placeholder="Nombre del audi√≥logo"></div>
            <div class="field"><label>Franquicia o Sucursal</label>
              <select id="cTipo">
                <option value="Franquicia">Franquicia</option>
                <option value="Sucursal">Sucursal</option>
              </select>
            </div>
          </div>

          <!-- Panel ACCIONES -->
          <div class="panel" id="pAcciones">
            <div class="ph">ACCIONES
              <div class="row-tools">
                <button class="btn btn-ghost" id="addAccion">Ôºã A√±adir fila</button>
              </div>
            </div>
            <div class="pl">
              <div class="grid grid-acciones hdr">
                <div>Fecha</div><div>Tipo de acci√≥n</div><div>Derivaci√≥n</div><div>Cita</div><div>Venta</div><div></div>
              </div>
              <div id="accionesRows"></div>
            </div>
          </div>

          <!-- Panel FORMACIONES RELEVANTES -->
          <div class="panel" id="pFormaciones">
            <div class="ph">FORMACIONES RELEVANTES
              <div class="row-tools">
                <button class="btn btn-ghost" id="addFormacion">Ôºã A√±adir fila</button>
              </div>
            </div>
            <div class="pl">
              <div class="grid grid-forma hdr">
                <div>Curso</div><div>Realizado</div><div>Aplica</div><div>Observaciones</div><div></div>
              </div>
              <div id="formacionesRows"></div>
            </div>
          </div>

          <!-- Panel CONTROL DE PROCESOS -->
          <div class="panel" id="pProcesos">
            <div class="ph">CONTROL DE PROCESOS
              <div class="row-tools">
                <button class="btn btn-ghost" id="addProceso">Ôºã A√±adir fila</button>
                <input type="file" id="fileExcel" style="display:none" accept=".xlsx,.xls,.csv" multiple />
                <button class="btn btn-ghost" id="btnExcel">Adjuntar Excel</button>
              </div>
            </div>
            <div class="pl">
              <div class="grid grid-proc hdr">
                <div>Puntuaci√≥n checklist (0‚Äì100)</div><div>HIT</div><div>Colaboraciones</div><div></div>
              </div>
              <div id="procesosRows"></div>
              <div class="file-list" id="filesList"></div>
            </div>
          </div>

          <div class="bar-right">
            <button class="btn btn-ghost" id="btnCancelC">Cancelar</button>
            <button class="btn btn-save" id="btnSaveC">üíæ Guardar centro</button>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
/* ======= Estado & Datos ======= */
const STORAGE_KEY = 'audioseguimiento_v3';

const SECTION_ORDER = [
  "CENTROS EXCLUSIVOS",
  "CENTROS FLOP",
  "VISITAS AUDIO",
  "FORMACIONES Y MENTORING",
  "TELEAUDIOLOGIA"
];

const SECTION_TONE = {
  "CENTROS EXCLUSIVOS":"exclusivos",
  "CENTROS FLOP":"flop",
  "VISITAS AUDIO":"visitas",
  "FORMACIONES Y MENTORING":"formaciones",
  "TELEAUDIOLOGIA":"tele"
};

const TONE_BG = {
  exclusivos: 'var(--col-exclusivos)',
  flop: 'var(--col-flop)',
  visitas: 'var(--col-visitas)',
  formaciones: 'var(--col-formaciones)',
  tele: 'var(--col-tele)'
};

let state = {
  editing:true,
  selected:{ section:null, index:null }
};

let data = load() || {
  "CENTROS EXCLUSIVOS":[{
    nombre:"Reina Mercedes",
    delegado:"",
    audiologo:"",
    tipo:"Franquicia",
    acciones:[],
    formaciones:[],
    procesos:[],
    adjuntos:[]
  }],
  "CENTROS FLOP":[],
  "VISITAS AUDIO":[],
  "FORMACIONES Y MENTORING":[],
  "TELEAUDIOLOGIA":[]
};

/* ======= Util ======= */
function q(sel,root=document){ return root.querySelector(sel); }
function qa(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }
function nowISO(){ return new Date().toISOString(); }
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  q('#pillOk').style.display='inline-flex';
  q('#stamp').textContent = 'Actualizado: ' + nowISO();
}
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw? JSON.parse(raw): null;
  }catch(e){ return null; }
}
function setDetailTone(tone){
  const det = q('#detail');
  det.style.background = '#fff';
  det.style.borderColor = '#ececf5';
  if(tone && TONE_BG[tone]){
    det.style.background = TONE_BG[tone];
    det.style.borderColor = '#00000015';
  }
}
function renderAll(){
  // render listas
  SECTION_ORDER.forEach(sec=>{
    const wrap = q(`.section[data-section="${sec}"] .sec-list`);
    wrap.innerHTML='';
    const items = data[sec]||[];
    items.forEach((it,idx)=>{
      const el = document.createElement('div');
      el.className='item';
      el.dataset.section=sec; el.dataset.index=idx;
      if(sec==="CENTROS EXCLUSIVOS"){
        el.innerHTML = `
          <div>
            <div class="name">${it.nombre||'‚Äî'}</div>
            <small>${it.delegado?('Delegado: '+it.delegado):''} ${it.audiologo?(' ¬∑ Audi√≥logo: '+it.audiologo):''}</small>
          </div>
          <div class="acts">
            <span class="ico" title="Editar">‚úèÔ∏è</span>
            <span class="ico" title="Eliminar">üóëÔ∏è</span>
          </div>`;
      }else{
        el.innerHTML = `
          <div class="name">${it.nombre||'‚Äî'}</div>
          <div class="acts"><span class="ico">‚úèÔ∏è</span><span class="ico">üóëÔ∏è</span></div>`;
      }
      wrap.appendChild(el);
    });
  });

  // estado topbar
  q('#lock').textContent = state.editing? 'üîì Editando' : 'üîí Bloqueado';
  q('#btnSaveTop').disabled = !state.editing;
  qa('.sec-btn,[data-act="add"],.item').forEach(el=>{
    if('disabled' in el) el.disabled = !state.editing;
  });

  // detalle
  const sec = state.selected.section;
  if(sec){
    setDetailTone(SECTION_TONE[sec]);
    q('#detHint').style.display='none';
    q('#detTitle').textContent = 'Detalle';
    q('#detTag').textContent = sec;

    if(sec==="CENTROS EXCLUSIVOS"){
      q('#detFormGeneric').style.display='none';
      q('#detFormExclusivo').style.display='block';
      fillCentroForm();
      renderAcciones();
      renderFormaciones();
      renderProcesos();
      renderAdjuntos();
    }else{
      q('#detFormExclusivo').style.display='none';
      q('#detFormGeneric').style.display='block';
      fillGenericForm();
    }
  }else{
    q('#detFormExclusivo').style.display='none';
    q('#detFormGeneric').style.display='none';
    q('#detHint').style.display='block';
    q('#detTitle').textContent = 'Detalle';
    q('#detTag').textContent = '‚Äî';
    setDetailTone(null);
  }
}

/* ======= Rellenar formularios ======= */
function currentItem(){
  const {section,index} = state.selected;
  if(section==null) return null;
  return data[section][index];
}

/* --- Gen√©rico --- */
function fillGenericForm(){
  const it = currentItem(); if(!it) return;
  q('#gNombre').value = it.nombre||'';
  q('#gFecha').value = it.fecha||'';
  q('#gEstado').value = it.estado||'';
  q('#gNotas').value = it.notas||'';
}

/* --- Centro exclusivo --- */
function fillCentroForm(){
  const it = currentItem(); if(!it) return;
  q('#cNombre').value = it.nombre||'';
  q('#cDelegado').value = it.delegado||'';
  q('#cAudiologo').value = it.audiologo||'';
  q('#cTipo').value = it.tipo||'Franquicia';
}

/* ======= Render de paneles ======= */
function renderRows(containerSel, rows, buildRow, gridClass){
  const cont = q(containerSel);
  cont.innerHTML='';
  rows.forEach((r,idx)=>{
    const row = document.createElement('div');
    row.className = 'grid rowx '+gridClass;
    row.dataset.index = idx;
    row.innerHTML = buildRow(r, idx);
    cont.appendChild(row);
  });
}

function renderAcciones(){
  const it = currentItem(); if(!it) return;
  if(!Array.isArray(it.acciones)) it.acciones = [];
  renderRows('#accionesRows', it.acciones, (r,idx)=>`
    <input type="date" data-k="fecha" value="${r.fecha||''}">
    <input type="text" data-k="tipo" placeholder="Tipo (llamada, visita‚Ä¶)" value="${r.tipo||''}">
    <input type="number" min="0" step="1" data-k="derivacion" value="${r.derivacion??''}">
    <input type="checkbox" data-k="cita" ${r.cita?'checked':''}>
    <input type="checkbox" data-k="venta" ${r.venta?'checked':''}>
    <button class="sec-btn del" title="Eliminar">üóëÔ∏è</button>
  `,'grid-acciones');
}

function renderFormaciones(){
  const it = currentItem(); if(!it) return;
  if(!Array.isArray(it.formaciones)) it.formaciones = [];
  renderRows('#formacionesRows', it.formaciones, (r,idx)=>`
    <input type="text" data-k="curso" placeholder="Curso" value="${r.curso||''}">
    <input type="checkbox" data-k="realizado" ${r.realizado?'checked':''}>
    <input type="checkbox" data-k="aplica" ${r.aplica?'checked':''}>
    <input type="text" data-k="obs" placeholder="Observaciones" value="${r.obs||''}">
    <button class="sec-btn del" title="Eliminar">üóëÔ∏è</button>
  `,'grid-forma');
}

function renderProcesos(){
  const it = currentItem(); if(!it) return;
  if(!Array.isArray(it.procesos)) it.procesos = [];
  renderRows('#procesosRows', it.procesos, (r,idx)=>`
    <input type="number" min="0" max="100" step="1" data-k="puntuacion" value="${r.puntuacion??''}">
    <input type="checkbox" data-k="hit" ${r.hit?'checked':''}>
    <input type="checkbox" data-k="colaboraciones" ${r.colaboraciones?'checked':''}>
    <button class="sec-btn del" title="Eliminar">üóëÔ∏è</button>
  `,'grid-proc');
}

function renderAdjuntos(){
  const it = currentItem(); if(!it) return;
  if(!Array.isArray(it.adjuntos)) it.adjuntos = [];
  const list = q('#filesList');
  list.innerHTML='';
  it.adjuntos.forEach((f,idx)=>{
    const node = document.createElement('div');
    node.className='file-pill';
    node.innerHTML = `üìé <span title="${f.name}">${f.name}</span> <small class="muted">(${Math.round((f.size||0)/1024)} KB)</small> <button class="sec-btn" data-delfile="${idx}" title="Quitar">üóëÔ∏è</button>`;
    list.appendChild(node);
  });
}

/* ======= Eventos globales ======= */
q('#btnEdit').addEventListener('click',()=>{
  state.editing = !state.editing;
  renderAll();
});
q('#btnRefresh').addEventListener('click',()=>{
  data = load() || data;
  q('#pillOk').style.display='inline-flex';
  q('#stamp').textContent = 'Actualizado: ' + nowISO();
  renderAll();
});
q('#btnSaveTop').addEventListener('click',()=>{ save(); });

q('#btnAR').addEventListener('click',()=>{
  alert('Atajo AR listo ‚úÖ');
});

/* ======= Delegaci√≥n: secciones (lista izquierda) ======= */
qa('.section').forEach(secEl=>{
  const secName = secEl.dataset.section;

  // Toggle mostrar/ocultar
  q('[data-act="toggle"]',secEl).addEventListener('click',()=>{
    const lst = q('.sec-list',secEl);
    lst.style.display = (lst.style.display==='none') ? '' : 'none';
  });

  // A√±adir
  q('[data-act="add"]',secEl).addEventListener('click',()=>{
    if(secName === 'CENTROS EXCLUSIVOS' && (data[secName]?.length||0) >= 10){
      alert('M√°ximo 10 en CENTROS EXCLUSIVOS');
      return;
    }
    let nuevo;
    if(secName === 'CENTROS EXCLUSIVOS'){
      nuevo = { nombre:'(nuevo centro)', delegado:'', audiologo:'', tipo:'Franquicia', acciones:[], formaciones:[], procesos:[], adjuntos:[] };
    }else{
      nuevo = { nombre:'(nuevo)', fecha:'', estado:'', notas:'' };
    }
    data[secName] = data[secName] || [];
    data[secName].push(nuevo);
    state.selected = { section:secName, index:data[secName].length-1 };
    save(); renderAll();
  });

  // Click en lista (editar/eliminar)
  q('.sec-list',secEl).addEventListener('click',(ev)=>{
    const itemEl = ev.target.closest('.item');
    if(!itemEl) return;
    const idx = +itemEl.dataset.index;

    if(ev.target.textContent.includes('üóëÔ∏è')){
      if(confirm('¬øEliminar este item?')){
        data[secName].splice(idx,1);
        state.selected = {section:null,index:null};
        save(); renderAll();
      }
      return;
    }
    // seleccionar para editar
    state.selected = { section:secName, index:idx };
    renderAll();
  });
});

/* ======= Interacci√≥n: formularios ======= */
/* Gen√©rico */
q('#btnSaveG').addEventListener('click',()=>{
  const it = currentItem(); if(!it) return;
  it.nombre = q('#gNombre').value.trim();
  it.fecha = q('#gFecha').value;
  it.estado = q('#gEstado').value.trim();
  it.notas = q('#gNotas').value.trim();
  save(); renderAll();
});
q('#btnCancelG').addEventListener('click',()=>{ state.selected={section:null,index:null}; renderAll(); });

/* Centro exclusivo: guardar/cancelar */
q('#btnSaveC').addEventListener('click',()=>{
  const it = currentItem(); if(!it) return;
  it.nombre = q('#cNombre').value.trim();
  it.delegado = q('#cDelegado').value.trim();
  it.audiologo = q('#cAudiologo').value.trim();
  it.tipo = q('#cTipo').value;
  save(); renderAll();
});
q('#btnCancelC').addEventListener('click',()=>{ state.selected={section:null,index:null}; renderAll(); });

/* Paneles: a√±adir filas */
q('#addAccion').addEventListener('click',()=>{
  const it = currentItem(); if(!it) return;
  it.acciones.push({fecha:'', tipo:'', derivacion:null, cita:false, venta:false});
  renderAcciones(); save();
});
q('#addFormacion').addEventListener('click',()=>{
  const it = currentItem(); if(!it) return;
  it.formaciones.push({curso:'', realizado:false, aplica:false, obs:''});
  renderFormaciones(); save();
});
q('#addProceso').addEventListener('click',()=>{
  const it = currentItem(); if(!it) return;
  it.procesos.push({puntuacion:null, hit:false, colaboraciones:false});
  renderProcesos(); save();
});

/* Delegaci√≥n de cambios en celdas y borrado de fila */
q('#detail').addEventListener('input',(ev)=>{
  const row = ev.target.closest('.rowx'); if(!row) return;
  const k = ev.target.dataset.k; if(!k) return;
  const idx = +row.dataset.index;
  const it = currentItem(); if(!it) return;

  if(row.parentElement.id==='accionesRows'){
    const obj = it.acciones[idx];
    if(ev.target.type==='checkbox'){ obj[k] = ev.target.checked; }
    else if(ev.target.type==='number'){ obj[k] = ev.target.value===''?null:Number(ev.target.value); }
    else { obj[k] = ev.target.value; }
  }
  if(row.parentElement.id==='formacionesRows'){
    const obj = it.formaciones[idx];
    if(ev.target.type==='checkbox'){ obj[k] = ev.target.checked; }
    else { obj[k] = ev.target.value; }
  }
  if(row.parentElement.id==='procesosRows'){
    const obj = it.procesos[idx];
    if(ev.target.type==='checkbox'){ obj[k] = ev.target.checked; }
    else if(ev.target.type==='number'){ obj[k] = ev.target.value===''?null:Number(ev.target.value); }
    else { obj[k] = ev.target.value; }
  }
  save();
});

q('#detail').addEventListener('click',(ev)=>{
  // borrar fila
  if(ev.target.classList.contains('del')){
    const row = ev.target.closest('.rowx'); if(!row) return;
    const idx = +row.dataset.index;
    const it = currentItem(); if(!it) return;
    if(row.parentElement.id==='accionesRows'){ it.acciones.splice(idx,1); renderAcciones(); }
    if(row.parentElement.id==='formacionesRows'){ it.formaciones.splice(idx,1); renderFormaciones(); }
    if(row.parentElement.id==='procesosRows'){ it.procesos.splice(idx,1); renderProcesos(); }
    save();
  }
  // quitar adjunto
  if(ev.target.dataset.delfile){
    const i = +ev.target.dataset.delfile;
    const it = currentItem(); if(!it) return;
    it.adjuntos.splice(i,1);
    renderAdjuntos(); save();
  }
});

/* Adjuntar Excel (solo metadatos, no contenido) */
q('#btnExcel').addEventListener('click',()=> q('#fileExcel').click());
q('#fileExcel').addEventListener('change',(ev)=>{
  const files = Array.from(ev.target.files||[]);
  const it = currentItem(); if(!it) return;
  it.adjuntos = it.adjuntos || [];
  files.forEach(f=>{
    it.adjuntos.push({name:f.name, size:f.size, lastModified:f.lastModified});
  });
  ev.target.value=''; // reset
  renderAdjuntos(); save();
});

/* ======= Init ======= */
(function init(){
  q('#stamp').textContent = 'Actualizado: ' + nowISO();
  renderAll();
})();
</script>
</body>
</html>
