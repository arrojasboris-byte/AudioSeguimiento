<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AUDIOLOGIA-SEGUIMIENTO</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%23e11' d='M8 10h48v8H8z'/%3E%3Crect x='8' y='18' width='48' height='36' rx='6' fill='%23fff' stroke='%23e11' stroke-width='3'/%3E%3C/svg%3E">
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
<style>
:root{
  --red:#e11d2a; --red-600:#d61e1e; --bg:#edf0f3; --card:#ffffff;
  --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb; --chip:#f3f4f6;
  --radius:14px; --shadow:0 12px 24px rgba(0,0,0,.06);
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#f7f7f8,#eef1f4);}
.container{max-width:1200px;margin:18px auto;padding:0 16px;}
/* header */
.header{background:var(--card); border:1px solid var(--line); border-left:6px solid var(--red); box-shadow:var(--shadow); border-radius:var(--radius);
  padding:14px 16px; display:flex; align-items:center; gap:14px}
.brand{display:flex; align-items:center; gap:16px; flex:1}
.logo{height:54px; width:auto; object-fit:contain}
.titlebox{display:flex; flex-direction:column}
.kicker{font-size:14px; color:var(--muted)}
.h1{font-size:34px; font-weight:900; color:var(--ink); letter-spacing:.5px}
.iconbar{display:flex; gap:10px}
.iconbtn{border:none; background:#222b; color:#fff; width:46px; height:46px; border-radius:12px; display:grid; place-items:center; cursor:pointer}
.iconbtn.red{background:var(--red)}
.iconbtn.blue{background:#1f63ff}
.iconbtn:hover{transform:translateY(-1px)}
/* search */
.searchWrap{margin:16px 0}
.search{width:100%; padding:16px 18px; border:1px solid var(--line); border-radius:12px; background:#fff; box-shadow:var(--shadow); font-size:16px}
/* layout */
.grid{display:grid; grid-template-columns:360px 1fr; gap:18px}
@media(max-width:1000px){.grid{grid-template-columns:1fr}}
.card{background:var(--card); border:1px solid var(--line); border-left:6px solid var(--red); border-radius:16px; box-shadow:var(--shadow)}
.cardHeader{display:flex; align-items:center; justify-content:space-between; padding:18px}
.cardTitle{font-size:22px; font-weight:800; color:var(--ink)}
.linkBtn{color:var(--red-600); font-weight:700; cursor:pointer; user-select:none}
.hr{height:1px; background:var(--line)}
.pad{padding:14px 18px}
/* section list */
.sectionItem{border:1px solid var(--line); background:var(--chip); border-radius:12px; margin:10px 0; overflow:hidden}
.sectionHead{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; cursor:pointer}
.sectionHead h4{margin:0; font-size:16px; font-weight:800; color:var(--ink)}
.badge{font-size:12px; padding:4px 8px; background:#fff; border:1px solid var(--line); border-radius:999px; color:var(--muted)}
.sectionBody{display:none; padding:10px 12px; background:#fff}
.sectionBody.show{display:block}
.row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border:1px dashed var(--line); border-radius:10px; margin:6px 0; background:#fafafa}
.row strong{font-weight:800}
.row .muted{color:var(--muted); font-size:12px}
.rowBtns{display:flex; gap:6px}
.smallbtn{border:none; background:#f1f5f9; color:#111; border-radius:8px; padding:6px 8px; cursor:pointer}
.smallbtn.red{background:#fee2e2; color:#b91c1c}
.smallbtn.green{background:#dcfce7; color:#166534}
.addLine{display:flex; gap:8px; margin-top:8px}
.addLine input, .addLine select{flex:1; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff}
.plus{border:none; background:#111; color:#fff; border-radius:8px; padding:8px 10px; cursor:pointer}
/* procedures */
.procHeader{display:flex; align-items:center; justify-content:space-between; gap:12px}
.procTitle{font-size:22px; font-weight:900}
.procAdd{display:flex; gap:8px}
.chip{background:#f6f6f8; border:1px solid var(--line); color:#333; padding:6px 10px; border-radius:999px; font-size:12px}
.procList{padding:10px 16px 18px}
.procItem{border:1px solid var(--line); border-radius:12px; background:#fff; margin:10px 0; overflow:hidden}
.procHead{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; cursor:pointer; background:#f9fafb}
.procHead h5{margin:0; font-size:16px; font-weight:800}
.procBody{display:none; padding:12px 14px; border-top:1px solid var(--line)}
.procBody.show{display:block}
.flexcol{display:flex; gap:10px; flex-wrap:wrap}
.flexcol input, .flexcol textarea{width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; font-size:14px}
.flexcol .half{flex:1 1 220px}
.actions{display:flex; gap:6px; margin-top:8px}
.hide{display:none !important}
</style>
</head>
<body>
<div class="container">

  <!-- header -->
  <div class="header">
    <div class="brand">
      <img id="logoImg" class="logo" src="https://raw.githubusercontent.com/arrojasboris-byte/plataforma-Afflelou/main/logo-afflelou.png" alt="Logo">
      <div class="titlebox">
        <span class="kicker">Plataforma</span>
        <div class="h1">AUDIOLOGIA-SEGUIMIENTO</div>
      </div>
    </div>
    <div class="iconbar">
      <button class="iconbtn" id="btnLogo" title="Logo"><i class="ri-image-2-line"></i></button>
      <button class="iconbtn" id="btnLock" title="Editar con PIN"><i class="ri-lock-2-line"></i></button>
      <button class="iconbtn red" id="btnCloud" title="Guardar en nube"><i class="ri-cloud-line"></i></button>
      <button class="iconbtn blue" id="btnBackup" title="Backup / Restaurar"><i class="ri-save-3-line"></i></button>
      <button class="iconbtn" id="btnSettings" title="Ajustes"><i class="ri-settings-3-line"></i></button>
    </div>
    <input id="logoFile" type="file" accept="image/*" class="hide">
    <input id="backupFile" type="file" accept="application/json" class="hide">
  </div>

  <!-- search -->
  <div class="searchWrap">
    <input id="search" class="search" placeholder="Buscar en secciones, centros y datos..." />
  </div>

  <!-- layout -->
  <div class="grid">
    <!-- left: sections -->
    <div class="card">
      <div class="cardHeader">
        <div class="cardTitle">Secciones</div>
        <div class="actions">
          <button id="addSection" class="smallbtn"><i class="ri-add-line"></i> Añadir</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="pad" id="sections">

        <!-- Centros exclusivos -->
        <div class="sectionItem" data-sec="exclusivos">
          <div class="sectionHead">
            <h4>Centros exclusivos</h4>
            <div>
              <span class="badge" id="countExclusivos">0</span>
              <span class="linkBtn" data-toggle="#bodyExclusivos">Mostrar</span>
            </div>
          </div>
          <div class="sectionBody" id="bodyExclusivos">
            <div id="listExclusivos"></div>
            <div class="addLine editOnly">
              <input id="newExNombre" placeholder="Nombre centro">
              <input id="newExDelegado" placeholder="Delegado">
              <input id="newExAudio" placeholder="Audiólogo">
              <select id="newExTipo">
                <option value="">Tipo…</option>
                <option value="Franquicia">Franquicia</option>
                <option value="Sucursal">Sucursal</option>
              </select>
              <button id="btnAddEx" class="plus"><i class="ri-add-line"></i></button>
            </div>
          </div>
        </div>

        <!-- Centros flop -->
        <div class="sectionItem" data-sec="flop">
          <div class="sectionHead">
            <h4>Centros flop</h4>
            <div>
              <span class="badge" id="countFlop">0</span>
              <span class="linkBtn" data-toggle="#bodyFlop">Mostrar</span>
            </div>
          </div>
          <div class="sectionBody" id="bodyFlop">
            <div id="listFlop"></div>
            <div class="addLine editOnly">
              <input id="newFlNombre" placeholder="Nombre centro">
              <input id="newFlDelegado" placeholder="Delegado">
              <input id="newFlAudio" placeholder="Audiólogo">
              <select id="newFlTipo">
                <option value="">Tipo…</option>
                <option value="Franquicia">Franquicia</option>
                <option value="Sucursal">Sucursal</option>
              </select>
              <button id="btnAddFl" class="plus"><i class="ri-add-line"></i></button>
            </div>
          </div>
        </div>

        <!-- Formaciones - Mentoring -->
        <div class="sectionItem" data-sec="formMent">
          <div class="sectionHead">
            <h4>Formaciones – Mentoring</h4>
            <div><span class="linkBtn" data-toggle="#bodyFormMent">Mostrar</span></div>
          </div>
          <div class="sectionBody" id="bodyFormMent">
            <div class="row">
              <strong>Cíclicos</strong>
              <span class="muted">Programas recurrentes</span>
              <div class="rowBtns editOnly">
                <button class="smallbtn">Editar</button>
                <button class="smallbtn red">Eliminar</button>
              </div>
            </div>
            <div class="row">
              <strong>Grupo delegado</strong>
              <span class="muted">Plan por delegado</span>
              <div class="rowBtns editOnly">
                <button class="smallbtn">Editar</button>
                <button class="smallbtn red">Eliminar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Visitas a centros -->
        <div class="sectionItem" data-sec="visitas">
          <div class="sectionHead">
            <h4>Visitas a centros</h4>
            <div><span class="linkBtn" data-toggle="#bodyVisitas">Mostrar</span></div>
          </div>
          <div class="sectionBody" id="bodyVisitas">
            <div class="row">
              <strong>Registro de visitas</strong>
              <span class="muted">Próximamente</span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- right: procedures -->
    <div class="card">
      <div class="cardHeader">
        <div class="procHeader">
          <div class="procTitle">Procedimientos — <span id="procCentro">Seleccione un centro</span></div>
          <span class="chip" id="procCount">0 ítems</span>
        </div>
        <div class="procAdd editOnly">
          <button id="btnAddProc" class="smallbtn green"><i class="ri-add-line"></i> Añadir</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="procList" id="procList"></div>
    </div>
  </div>
</div>

<script>
/* ---------- Estado ---------- */
const state = JSON.parse(localStorage.getItem('audiologia_state_v2')||'null') || {
  logo: '',
  edit: false,
  exclusivos: [
    {id:1, nombre:'Reina Mercedes', delegado:'Ana Martínez', audio:'Dr. García', tipo:'Franquicia'},
    {id:2, nombre:'Barcelona Centro', delegado:'Carlos Ruiz', audio:'Dra. López', tipo:'Sucursal'}
  ],
  flop: [],
  selectedCentroId: 1,
  procedimientos: {
    // por centro exclusivo
    "1":[
      {id: 1, titulo:'Chequeo inicial', fecha:'', accion:'', derivacion:0, cita:0, obs:''},
    ],
    "2":[]
  }
};
function save(){ localStorage.setItem('audiologia_state_v2', JSON.stringify(state)); render(); }

/* ---------- Util ---------- */
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);
function uid(){ return Math.floor(Math.random()*1e9); }
function toggleEdit(on){
  state.edit = on ?? !state.edit;
  document.querySelectorAll('.editOnly').forEach(el=> el.classList.toggle('hide', !state.edit));
  $('#btnLock').innerHTML = state.edit ? '<i class="ri-lock-unlock-line"></i>' : '<i class="ri-lock-2-line"></i>';
}

/* ---------- Render secciones ---------- */
function renderCentros(list, mountId, countId, tipo){
  const mount = $(mountId); mount.innerHTML = '';
  list.forEach(c=>{
    const row = document.createElement('div');
    row.className='row';
    row.innerHTML = `
      <div>
        <strong>${c.nombre}</strong>
        <div class="muted">👤 ${c.delegado || '-'} · 🎧 ${c.audio || '-'} · 📍 ${c.tipo || '-'}</div>
      </div>
      <div class="rowBtns">
        ${tipo==='ex' ? `<button class="smallbtn" data-sel="${c.id}"><i class="ri-check-line"></i> Seleccionar</button>`:''}
        <button class="smallbtn editOnly"><i class="ri-pencil-line"></i></button>
        <button class="smallbtn red editOnly"><i class="ri-delete-bin-line"></i></button>
      </div>`;
    // eventos
    if(tipo==='ex') row.querySelector('[data-sel]')?.addEventListener('click',()=>{
      state.selectedCentroId = c.id; save();
    });
    // editar
    row.querySelector('.editOnly:nth-of-type(1)')?.addEventListener('click',()=>{
      const nombre = prompt('Nombre', c.nombre)||c.nombre;
      const del = prompt('Delegado', c.delegado||'')||c.delegado;
      const au = prompt('Audiólogo', c.audio||'')||c.audio;
      const tp = prompt('Tipo (Franquicia/Sucursal)', c.tipo||'')||c.tipo;
      Object.assign(c,{nombre,delegado:del,audio:au,tipo:tp}); save();
    });
    // eliminar
    row.querySelector('.editOnly.red')?.addEventListener('click',()=>{
      if(!confirm('¿Eliminar centro?')) return;
      const arr = (tipo==='ex')? state.exclusivos : state.flop;
      const idx = arr.findIndex(x=>x.id===c.id);
      if(idx>=0) arr.splice(idx,1);
      if(tipo==='ex' && state.selectedCentroId===c.id) state.selectedCentroId = state.exclusivos[0]?.id || null;
      save();
    });
    mount.appendChild(row);
  });
  $(countId).textContent = list.length;
}
function renderProcedimientos(){
  const centro = state.exclusivos.find(c=>c.id===state.selectedCentroId);
  $('#procCentro').textContent = centro? centro.nombre : 'Seleccione un centro';
  const list = centro ? (state.procedimientos[centro.id] || (state.procedimientos[centro.id]=[])) : [];
  $('#procCount').textContent = `${list.length} ítems`;
  const mount = $('#procList'); mount.innerHTML = '';
  list.forEach(p=>{
    const item = document.createElement('div');
    item.className='procItem';
    item.innerHTML = `
      <div class="procHead" data-toggle>
        <h5>${p.titulo || 'Sin título'}</h5>
        <div class="rowBtns">
          <button class="smallbtn editOnly" data-edit><i class="ri-pencil-line"></i></button>
          <button class="smallbtn red editOnly" data-del><i class="ri-delete-bin-line"></i></button>
        </div>
      </div>
      <div class="procBody">
        <div class="flexcol">
          <input class="half" data-k="fecha" placeholder="Fecha" value="${p.fecha||''}">
          <input class="half" data-k="accion" placeholder="Acción" value="${p.accion||''}">
          <div class="half"><input data-k="derivacion" placeholder="Derivación" value="${p.derivacion||0}" type="number"></div>
          <div class="half"><input data-k="cita" placeholder="Cita" value="${p.cita||0}" type="number"></div>
          <textarea rows="3" data-k="obs" placeholder="Observaciones">${p.obs||''}</textarea>
        </div>
      </div>`;
    // plegable
    item.querySelector('[data-toggle]').addEventListener('click',e=>{
      if(e.target.closest('.rowBtns')) return;
      item.querySelector('.procBody').classList.toggle('show');
    });
    // editar (renombrar)
    item.querySelector('[data-edit]').addEventListener('click',()=>{
      const t = prompt('Título', p.titulo||'')||p.titulo; p.titulo=t; save();
    });
    // eliminar
    item.querySelector('[data-del]').addEventListener('click',()=>{
      if(!confirm('¿Eliminar procedimiento?')) return;
      const arr = state.procedimientos[centro.id];
      const idx = arr.findIndex(x=>x.id===p.id); if(idx>=0) arr.splice(idx,1); save();
    });
    // cambios de campos
    item.querySelectorAll('[data-k]').forEach(inp=>{
      inp.addEventListener('input',()=>{
        const k = inp.dataset.k;
        p[k] = (k==='cita'||k==='derivacion') ? Number(inp.value||0) : inp.value;
        save();
      });
    });
    mount.appendChild(item);
  });
}
function render(){
  // logo
  if(state.logo) $('#logoImg').src = state.logo;
  // centros
  renderCentros(state.exclusivos,'#listExclusivos','#countExclusivos','ex');
  renderCentros(state.flop,'#listFlop','#countFlop','fl');
  // procedimientos
  renderProcedimientos();
  // modo edición
  toggleEdit(state.edit);
}
render();

/* ---------- Eventos UI ---------- */
// toggle secciones
$$('.linkBtn').forEach(btn=>{
  const target = btn.getAttribute('data-toggle');
  if(!target) return;
  btn.addEventListener('click',()=>{
    const el = document.querySelector(target);
    el.classList.toggle('show');
    btn.textContent = el.classList.contains('show')? 'Ocultar' : 'Mostrar';
  });
});

// add centro exclusivos
$('#btnAddEx').addEventListener('click',()=>{
  const n = $('#newExNombre').value.trim(); if(!n) return;
  state.exclusivos.push({
    id: uid(),
    nombre:n,
    delegado: $('#newExDelegado').value.trim(),
    audio: $('#newExAudio').value.trim(),
    tipo: $('#newExTipo').value
  });
  $('#newExNombre').value = $('#newExDelegado').value = $('#newExAudio').value = '';
  $('#newExTipo').value = '';
  save();
});
// add centro flop
$('#btnAddFl').addEventListener('click',()=>{
  const n = $('#newFlNombre').value.trim(); if(!n) return;
  state.flop.push({
    id: uid(),
    nombre:n,
    delegado: $('#newFlDelegado').value.trim(),
    audio: $('#newFlAudio').value.trim(),
    tipo: $('#newFlTipo').value
  });
  $('#newFlNombre').value = $('#newFlDelegado').value = $('#newFlAudio').value = '';
  $('#newFlTipo').value = '';
  save();
});

// add procedimiento
$('#btnAddProc').addEventListener('click',()=>{
  const cId = state.selectedCentroId;
  if(!cId){ alert('Selecciona primero un centro exclusivo.'); return; }
  const arr = state.procedimientos[cId] || (state.procedimientos[cId]=[]);
  arr.push({id:uid(), titulo:'Nuevo procedimiento', fecha:'', accion:'', derivacion:0, cita:0, obs:''});
  save();
});

/* logo */
$('#btnLogo').addEventListener('click',()=> $('#logoFile').click());
$('#logoFile').addEventListener('change',(e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ev=>{ state.logo = ev.target.result; save(); };
  r.readAsDataURL(f);
});

/* edición con PIN */
$('#btnLock').addEventListener('click',()=>{
  if(state.edit){ toggleEdit(false); return; }
  const p = prompt('PIN de edición'); if(p==='AR4321'){ toggleEdit(true); } else if(p!==null){ alert('PIN incorrecto'); }
});

/* Backup local */
$('#btnBackup').addEventListener('click',()=>{
  // menú rápido: descargar o cargar archivo
  const op = confirm('Aceptar = Descargar backup\nCancelar = Cargar backup desde archivo');
  if(op){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(state,null,2)],{type:'application/json'}));
    a.download = 'audiologia_backup.json'; a.click();
  }else{
    $('#backupFile').click();
  }
});
$('#backupFile').addEventListener('change',(e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ev=>{
    try{
      const obj = JSON.parse(ev.target.result);
      Object.assign(state, obj);
      save();
    }catch(err){ alert('Archivo inválido'); }
  };
  r.readAsText(f);
});

/* Guardar en nube (placeholder) */
$('#btnCloud').addEventListener('click',()=>{
  alert('“Guardar en nube” preparado. Podemos conectarlo a GitHub Gist o Google Drive cuando me pases el método preferido.');
});

/* Ajustes simples */
$('#btnSettings').addEventListener('click',()=>{
  alert('Ajustes mínimos. Próximamente: integración nube, usuarios, etc.');
});

/* Búsqueda */
$('#search').addEventListener('input',(e)=>{
  const q = e.target.value.toLowerCase().trim();
  // filtra filas de centros
  ['#listExclusivos','#listFlop'].forEach(sel=>{
    $$(sel+' .row').forEach(r=>{
      r.style.display = r.textContent.toLowerCase().includes(q)? '' : 'none';
    });
  });
  // filtra procedimientos (titulo y cuerpo)
  $$('#procList .procItem').forEach(it=>{
    it.style.display = it.textContent.toLowerCase().includes(q)? '' : 'none';
  });
});
</script>
</body>
</html>
