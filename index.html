<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SEGUIMIENTO AUDIO-AR</title>
  <style>
    :root {
      --bg: #f4f4f4;
      --panel: #ffffff;
      --gris: #2f3437;
      --rojo: #b71c1c;
      --blanco: #ffffff;
      --negro: #181818;
      --radius-lg: 18px;
      --shadow-sm: 0 3px 10px rgba(0, 0, 0, 0.08);
      --obj: #ffe6e6;
      --cex: #f6f0ff;
      --cflop: #ffe9d6;
      --form: #e7f7ff;
      --vis: #f9fbe7;
      --ok: #0ba048;
      --bad: #d32f2f;
    }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--negro); height: 100vh; display: flex; flex-direction: column; }
    header {
      background: linear-gradient(120deg, #000000 0%, #b71c1c 80%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 26px;
      gap: 12px;
    }
    header h1 { font-size: 1.1rem; letter-spacing: 0.04rem; display: flex; align-items: center; gap: 10px; }
    header h1 span.logo { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 99px; font-weight: 700; }
    .top-actions { display: flex; gap: 10px; align-items: center; }
    .btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); color: #fff; border-radius: 14px; padding: 6px 12px; font-size: 0.78rem; display: inline-flex; gap: 6px; align-items: center; cursor: pointer; transition: 0.2s ease; }
    .btn:hover { background: rgba(255,255,255,0.2); }
    .btn.secondary { background: rgba(0,0,0,0.3); }
    .pin-box { display: flex; gap: 6px; align-items: center; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 3px 6px 3px 10px; }
    .pin-box input { all: unset; background: rgba(0,0,0,0.3); padding: 3px 6px; border-radius: 8px; font-size: 0.7rem; }
    .status-pill { background: rgba(0,0,0,0.2); padding: 3px 10px; border-radius: 99px; font-size: 0.68rem; }
    main { flex: 1; display: flex; gap: 10px; padding: 12px; overflow: hidden; }
    .left-panel { width: 268px; background: var(--panel); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); padding: 10px; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; }
    .left-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
    .block-btn { display: flex; align-items: center; gap: 10px; background: #f3f3f3; border: 1px solid transparent; border-radius: 14px; padding: 6px 10px; cursor: pointer; transition: 0.15s ease; font-size: 0.78rem; }
    .block-btn .tag { width: 28px; height: 28px; border-radius: 12px; display: grid; place-items: center; font-size: 0.75rem; font-weight: 600; }
    .block-btn small { opacity: 0.5; font-size: 0.65rem; }
    .block-btn.active { border: 1px solid rgba(0,0,0,0.12); background: #fff; box-shadow: 0 3px 12px rgba(0,0,0,0.03); }
    .block-btn[data-type="OBJETIVOS"] { background: var(--obj); }
    .block-btn[data-type="CENTROS EXCLUSIVOS"] { background: var(--cex); }
    .block-btn[data-type="CENTROS FLOP"] { background: var(--cflop); }
    .block-btn[data-type="FORMACIONES Y MENTORING"] { background: var(--form); }
    .block-btn[data-type="VISITAS"] { background: var(--vis); }
    .right-panel { flex: 1; background: var(--panel); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; overflow: hidden; }
    .right-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .right-header .title { display: flex; gap: 8px; align-items: center; }
    .badge-color { width: 18px; height: 18px; border-radius: 6px; }
    .content-area { flex: 1; padding: 16px; overflow-y: auto; background: #f9f9f9; }
    .locked-overlay { background: rgba(255,255,255,0.75); border: 2px dashed rgba(183, 28, 28, 0.3); border-radius: 16px; display: none; align-items: center; justify-content: center; gap: 10px; font-weight: 500; color: #b71c1c; padding: 10px; }
    .content-wrap { position: relative; }
    .content-wrap.locked .locked-overlay { display: flex; position: absolute; inset: 0; backdrop-filter: blur(1px); }
    .list { display: grid; gap: 10px; }
    .item { background: #fff; border: 1px solid rgba(0,0,0,0.04); border-left: 4px solid rgba(183,28,28,0.6); border-radius: 12px; padding: 8px 10px 6px 10px; display: flex; flex-direction: column; gap: 4px; box-shadow: 0 1px 6px rgba(0,0,0,0.02); }
    .item-header { display: flex; justify-content: space-between; align-items: center; gap: 6px; }
    .item-actions { display: flex; gap: 6px; }
    .tiny-btn, .ghost-icon { background: rgba(0,0,0,0.04); padding: 2px 6px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.7rem; display: inline-flex; align-items: center; gap: 2px; }
    .ghost-icon { background: rgba(0,0,0,0.02); }
    .disabled { opacity: 0.6; cursor: not-allowed; }
    /* layout centros */
    .flex-split { display: flex; gap: 14px; align-items: stretch; }
    .centers-list { width: 240px; background: #fff; border-radius: 14px; border: 1px solid rgba(0,0,0,0.03); box-shadow: 0 2px 6px rgba(0,0,0,0.02); padding: 10px; display: flex; flex-direction: column; gap: 10px; }
    .centers-list-header { display:flex; justify-content:space-between; align-items:center; gap:6px; }
    .center-right { flex: 1; display: flex; min-height: 360px; }
    .center-content { flex: 1; display: flex; flex-direction: column; gap: 10px; }
    .center-subnav { width: 100%; display: flex; flex-direction: row; gap: 8px; margin-top: 4px; }
    .center-subnav button { background: #000; color: #fff; border: none; border-radius: 12px; padding: 6px 10px; font-size: 0.72rem; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .center-subnav button.active { background: #b71c1c; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
    .field { display: flex; flex-direction: column; gap: 4px; }
    .field label { font-size: 0.7rem; opacity: 0.8; }
    .field input, .field select { border-radius: 10px; border: 1px solid rgba(0,0,0,0.1); padding: 5px 8px; font-size: 0.78rem; background: #fff; }
    .table-like { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; font-size: 0.74rem; }
    .table-like th, .table-like td { border: 1px solid rgba(0,0,0,0.12); padding: 4px 6px; }
    .table-toolbar { display: flex; gap: 6px; margin-bottom: 4px; align-items: center; justify-content: flex-end; }
    .badge-ok { background: rgba(11,160,72,0.1); color: #0b7a3a; padding: 2px 6px; border-radius: 6px; font-size: 0.65rem; }
    .badge-bad { background: rgba(211,47,47,0.12); color: #b71c1c; padding: 2px 6px; border-radius: 6px; font-size: 0.65rem; }
    .text-red { color: #b71c1c; }
    .text-green { color: #0b7a3a; }
    @media (max-width: 1080px) { .flex-split { flex-direction: column; } .centers-list { width: 100%; } }
    @media (max-width: 960px) { main { flex-direction: column; } .left-panel { width: 100%; flex-direction: row; overflow-x: auto; } .right-panel { height: 60vh; } }
  </style>
</head>
<body>
  <header>
    <h1><span class="logo">SEGUIMIENTO</span> AUDIO-AR <small style="opacity:0.6; font-size:0.65rem;">Panel de seguimiento formaci√≥n & ventas</small></h1>
    <div class="top-actions">
      <div class="pin-box">
        <span>üîê PIN:</span>
        <input id="pinInput" type="password" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <button id="pinBtn" class="btn secondary" style="padding:4px 8px;">OK</button>
      </div>
      <button id="saveCloud" class="btn disabled">‚òÅÔ∏è Guardar en nube</button>
      <button id="loadCloud" class="btn disabled">üîÑ Actualizar de nube</button>
      <button id="saveLocal" class="btn secondary">üíæ Guardar local</button>
      <div class="status-pill" id="editStatus">Solo lectura</div>
    </div>
  </header>
  <main>
    <aside class="left-panel" id="leftPanel">
      <div class="left-header">
        <strong>Bloques</strong>
        <button id="addBlock" class="tiny-btn">+ A√±adir</button>
      </div>
      <button class="block-btn active" data-type="OBJETIVOS" data-color="var(--obj)"><div class="tag" style="background: rgba(183,28,28,0.2);">üéØ</div><div><div>OBJETIVOS</div><small>KPIs, % logro</small></div></button>
      <button class="block-btn" data-type="CENTROS EXCLUSIVOS" data-color="var(--cex)"><div class="tag" style="background: rgba(47,52,55,0.05);">üè¢</div><div><div>CENTROS EXCLUSIVOS</div><small>Seguimiento premium</small></div></button>
      <button class="block-btn" data-type="CENTROS FLOP" data-color="var(--cflop)"><div class="tag" style="background: rgba(183,28,28,0.17);">‚ö†Ô∏è</div><div><div>CENTROS FLOP</div><small>Alarmas & plan</small></div></button>
      <button class="block-btn" data-type="FORMACIONES Y MENTORING" data-color="var(--form)"><div class="tag" style="background: rgba(24,24,24,0.05);">üìö</div><div><div>FORMACIONES Y MENTORING</div><small>Plan de aulas</small></div></button>
      <button class="block-btn" data-type="VISITAS" data-color="var(--vis)"><div class="tag" style="background: rgba(0,0,0,0.04);">üóìÔ∏è</div><div><div>VISITAS</div><small>Agenda & report</small></div></button>
    </aside>
    <section class="right-panel">
      <div class="right-header" id="rightHeader">
        <div class="title">
          <div class="badge-color" id="badgeColor" style="background: var(--obj);"></div>
          <h2 id="sectionTitle" style="font-size:0.95rem;">OBJETIVOS</h2>
        </div>
        <div class="footer-tools">
          <button id="btnHTML" class="btn secondary">‚¨áÔ∏é HTML</button>
          <button id="btnPDF" class="btn secondary">‚¨áÔ∏é PDF</button>
          <button id="btnXLS" class="btn secondary">‚¨áÔ∏é Excel</button>
        </div>
      </div>
      <div class="content-area">
        <div class="content-wrap" id="contentWrap">
          <div class="locked-overlay">üîí Edici√≥n bloqueada. Introduce PIN AR4321.</div>
          <div id="contentHolder"></div>
        </div>
      </div>
    </section>
  </main>
  <script>
    const PIN_MASTER = "AR4321";
    const pinInput = document.getElementById("pinInput");
    const pinBtn = document.getElementById("pinBtn");
    const editStatus = document.getElementById("editStatus");
    const saveLocalBtn = document.getElementById("saveLocal");
    const contentWrap = document.getElementById("contentWrap");
    const contentHolder = document.getElementById("contentHolder");
    const leftPanel = document.getElementById("leftPanel");
    const badgeColor = document.getElementById("badgeColor");
    const sectionTitle = document.getElementById("sectionTitle");
    const addBlock = document.getElementById("addBlock");

    let editable = false;

    /* CARGA DESDE LOCALSTORAGE TU ESTRUCTURA */
    let blocks = JSON.parse(localStorage.getItem("audioar_blocks") || "null") || {
      "OBJETIVOS": {
        color: "var(--obj)",
        items: [
          { titulo: "Ventas Q4", detalle: "Objetivo 140% sobre 2024", fecha: "2025-11-02" }
        ]
      },
      "CENTROS EXCLUSIVOS": {
        color: "var(--cex)",
        selected: 0,
        view: "acciones",
        centers: [
          {
            nombre: "Centro 1",
            delegado: "",
            audiologo: "",
            tipo: "Sucursal",
            acciones: [
              { tipo: "Seguimiento aud√≠fonos", fecha: "2025-11-03", derivaciones: "2", citas: "3", ventas: "1", obs: "Potencial en ORL" }
            ],
            formaciones: [
              { curso: "Teleaudiometr√≠a avanzada", superado: "S√≠", aplicado: "S√≠", mentoring: "No" }
            ],
            visitas: [
              { fecha: "2025-11-02", checklist: "90", convPrueba: "85", convVenta: "80" }
            ],
            servicios: [
              { nombre: "Tinnitus-TRT", activo: "No", ventas: "" },
              { nombre: "Pedi√°trico", activo: "No", ventas: "" },
              { nombre: "AAR", activo: "No", ventas: "" },
              { nombre: "HIT", activo: "No", ventas: "" }
            ]
          }
        ]
      },
      "CENTROS FLOP": {
        color: "var(--cflop)",
        selected: 0,
        view: "acciones",
        centers: [
          {
            nombre: "Centro Tetu√°n",
            delegado: "",
            audiologo: "",
            tipo: "Franquicia",
            acciones: [
              { tipo: "Alerta baja conversi√≥n", fecha: "2025-11-05", derivaciones: "0", citas: "1", ventas: "0", obs: "Revisar argumentario" }
            ],
            formaciones: [
              { curso: "ACE / Rehabilitaci√≥n", superado: "No", aplicado: "No", mentoring: "S√≠" }
            ],
            visitas: [
              { fecha: "2025-11-05", checklist: "70", convPrueba: "60", convVenta: "50" }
            ],
            servicios: [
              { nombre: "Tinnitus-TRT", activo: "No", ventas: "" },
              { nombre: "Pedi√°trico", activo: "No", ventas: "" },
              { nombre: "AAR", activo: "No", ventas: "" },
              { nombre: "HIT", activo: "No", ventas: "" }
            ]
          }
        ]
      },
      "FORMACIONES Y MENTORING": {
        color: "var(--form)",
        selected: 0,
        delegados: [
          {
            nombre: "Delegado 1",
            tabla: [
              { fecha: "2025-11-04", centros: "Centro 1", sucursal: "Sucursal", tema: "Teleaudiometr√≠a", superado: "S√≠", aplicado: "S√≠", obs: "Buena participaci√≥n" }
            ],
            adjunto: ""
          }
        ]
      },
      "VISITAS": {
        color: "var(--vis)",
        selected: 0,
        delegados: [
          {
            nombre: "Delegado 1",
            visitador: "",
            visitas: [
              { fecha: "2025-11-06", centros: "Centro Tetu√°n", sucursal: "Sucursal", audiologo: "", checklist: "82", convPrueba: "75", convVenta: "60", hit: "No", arr: "No", rt: "No", obs: "Reforzar cierre" }
            ],
            adjunto: ""
          }
        ]
      }
    };

    let currentBlock = "OBJETIVOS";

    function persist() {
      localStorage.setItem("audioar_blocks", JSON.stringify(blocks));
    }

    function setEditable(on) {
      editable = on;
      editStatus.textContent = on ? "Edici√≥n activada" : "Solo lectura";
      editStatus.style.background = on ? "rgba(11,160,72,0.1)" : "rgba(0,0,0,0.2)";
      renderCurrentBlock();
    }

    /* --- RENDER OBJETIVOS --- */
    function renderObjectives(data) {
      contentHolder.innerHTML = "";
      const list = document.createElement("div");
      list.className = "list";
      data.items.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="item-header">
            <strong>${item.titulo}</strong>
            ${editable ? `
              <div class="item-actions">
                <button class="ghost-icon" data-act="edit-obj" data-idx="${idx}">‚úè</button>
                <button class="ghost-icon" data-act="add-obj" data-idx="${idx}">Ôºã</button>
                <button class="ghost-icon" data-act="del-obj" data-idx="${idx}">‚àí</button>
              </div>` : ""}
          </div>
          <small>${item.detalle}</small>
          <small>üìÖ ${item.fecha || ""}</small>
        `;
        list.appendChild(div);
      });
      if (editable) {
        const addBtn = document.createElement("button");
        addBtn.textContent = "+ A√±adir objetivo";
        addBtn.className = "tiny-btn";
        addBtn.onclick = () => {
          data.items.push({ titulo: "Nuevo objetivo", detalle: "", fecha: "" });
          persist(); renderCurrentBlock();
        };
        list.appendChild(addBtn);
      }
      contentHolder.appendChild(list);
    }

    /* --- RENDER CENTROS --- */
    const ACCIONES_OPTIONS = ["Azafata","Cashback","Ruleta","Stand","Call center","Mailing","Buzoneo","Bono","Otro"];

    function renderCentersBlock(blockName, data) {
      contentHolder.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.className = "flex-split";

      /* LISTA IZQUIERDA (dentro del bloque) */
      const left = document.createElement("div");
      left.className = "centers-list";
      left.innerHTML = `
        <div class="centers-list-header">
          <strong>${blockName === "CENTROS EXCLUSIVOS" ? "Centros exclusivos" : "Centros flop"}</strong>
          ${editable ? `
          <div style="display:flex;gap:4px;">
            <button class="tiny-btn" data-act="add-center">+</button>
            <button class="tiny-btn" data-act="del-center">‚àí</button>
            <button class="tiny-btn" data-act="rename-center-head">‚úè</button>
            <button class="tiny-btn" data-act="save-centers">Guardar</button>
          </div>` : ""}
        </div>
      `;
      const select = document.createElement("select");
      select.className = "centers-select";
      select.dataset.act = "select-center";
      (data.centers || []).forEach((c, idx) => {
        const opt = document.createElement("option");
        opt.value = idx;
        opt.textContent = c.nombre || `${blockName === "CENTROS EXCLUSIVOS" ? "Exclusivo" : "Flop"} ${idx+1}`;
        if (idx === (data.selected || 0)) opt.selected = true;
        select.appendChild(opt);
      });
      left.appendChild(select);
      wrap.appendChild(left);

      /* CONTENIDO DERECHA */
      const right = document.createElement("div");
      right.className = "center-right";

      const sel = data.selected || 0;
      const center = data.centers[sel] || {
        nombre: "",
        delegado: "",
        audiologo: "",
        tipo: "Sucursal",
        acciones: [],
        formaciones: [],
        visitas: [],
        servicios: [
          { nombre: "Tinnitus-TRT", activo: "No", ventas: "" },
          { nombre: "Pedi√°trico", activo: "No", ventas: "" },
          { nombre: "AAR", activo: "No", ventas: "" },
          { nombre: "HIT", activo: "No", ventas: "" }
        ]
      };
      center.servicios = center.servicios || [
        { nombre: "Tinnitus-TRT", activo: "No", ventas: "" },
        { nombre: "Pedi√°trico", activo: "No", ventas: "" },
        { nombre: "AAR", activo: "No", ventas: "" },
        { nombre: "HIT", activo: "No", ventas: "" }
      ];
      if (!data.view) data.view = "acciones";

      const mainContent = document.createElement("div");
      mainContent.className = "center-content";

      const info = document.createElement("div");
      info.className = "grid-3";
      info.innerHTML = `
        <div class="field">
          <label>Nombre del centro</label>
          <input ${editable?"":"disabled"} data-field="nombre" value="${center.nombre||""}">
        </div>
        <div class="field">
          <label>Delegado</label>
          <input ${editable?"":"disabled"} data-field="delegado" value="${center.delegado||""}">
        </div>
        <div class="field">
          <label>Audi√≥logo</label>
          <input ${editable?"":"disabled"} data-field="audiologo" value="${center.audiologo||""}">
        </div>
        <div class="field">
          <label>Sucursal / Franquicia</label>
          <select ${editable?"":"disabled"} data-field="tipo">
            <option value="Sucursal" ${center.tipo==="Sucursal"?"selected":""}>Sucursal</option>
            <option value="Franquicia" ${center.tipo==="Franquicia"?"selected":""}>Franquicia</option>
          </select>
        </div>
      `;
      mainContent.appendChild(info);

      const subnav = document.createElement("div");
      subnav.className = "center-subnav";
      [
        { id: "acciones", label: "üìã Acciones" },
        { id: "formaciones", label: "üìö Formaciones y refuerzo" },
        { id: "visitas", label: "üóìÔ∏è Visitas" },
        { id: "servicios", label: "üß© Servicios" }
      ].forEach(b => {
        const bb = document.createElement("button");
        bb.dataset.sub = b.id;
        bb.textContent = b.label;
        if (data.view === b.id) bb.classList.add("active");
        subnav.appendChild(bb);
      });
      mainContent.appendChild(subnav);

      /* --- ACCIONES --- */
      if (data.view === "acciones") {
        const box = document.createElement("div");
        box.innerHTML = `
          <div class="table-toolbar" style="justify-content:flex-end;">
            <strong style="margin-right:auto; font-size:0.8rem;">Acciones</strong>
            ${editable ? `<button class="tiny-btn" data-act="add-accion">+ Acci√≥n</button>` : ""}
          </div>
        `;
        const t = document.createElement("table");
        t.className = "table-like";
        t.innerHTML = `
          <thead>
            <tr>
              <th>Tipo de acci√≥n</th>
              <th>Fecha</th>
              <th>Derivaciones</th>
              <th>Citas</th>
              <th>Ventas</th>
              <th>Observaciones</th>
              ${editable?`<th></th>`:""}
            </tr>
          </thead>
          <tbody>
            ${(center.acciones||[]).map((a,i)=>{
              return `
                <tr data-row="${i}" data-table="acciones">
                  <td>
                    ${editable
                      ? `<select data-table="acciones" data-row="${i}" data-field="tipo">
                          ${ACCIONES_OPTIONS.map(op=>`<option value="${op}" ${a.tipo===op?"selected":""}>${op}</option>`).join("")}
                        </select>`
                      : (a.tipo||"")}
                  </td>
                  <td>
                    ${editable
                      ? `<input type="date" data-table="acciones" data-row="${i}" data-field="fecha" value="${a.fecha||""}">`
                      : (a.fecha||"")}
                  </td>
                  <td>${editable?`<input type="number" min="0" data-table="acciones" data-row="${i}" data-field="derivaciones" value="${a.derivaciones||""}" style="width:70px;">`:(a.derivaciones||"")}</td>
                  <td>${editable?`<input type="number" min="0" data-table="acciones" data-row="${i}" data-field="citas" value="${a.citas||""}" style="width:70px;">`:(a.citas||"")}</td>
                  <td>${editable?`<input type="number" min="0" data-table="acciones" data-row="${i}" data-field="ventas" value="${a.ventas||""}" style="width:70px;">`:(a.ventas||"")}</td>
                  <td>${editable?`<input type="text" data-table="acciones" data-row="${i}" data-field="obs" value="${a.obs||""}" style="width:160px;">`:(a.obs||"")}</td>
                  ${editable?`<td><button class="ghost-icon" data-act="del-row">‚àí</button></td>`:""}
                </tr>
              `;
            }).join("")}
          </tbody>
        `;
        box.appendChild(t);
        mainContent.appendChild(box);
      }

      /* --- FORMACIONES --- */
      if (data.view === "formaciones") {
        const box = document.createElement("div");
        box.innerHTML = `
          <div class="table-toolbar" style="justify-content:flex-end;">
            <strong style="margin-right:auto; font-size:0.8rem;">Formaciones y refuerzo</strong>
            ${editable ? `<button class="tiny-btn" data-act="add-forma">+ Formaci√≥n</button>` : ""}
          </div>
        `;
        const t = document.createElement("table");
        t.className = "table-like";
        t.innerHTML = `
          <thead>
            <tr>
              <th>Curso relevante</th>
              <th>Superado</th>
              <th>Aplicado</th>
              <th>Mentoring-Coaching</th>
              ${editable?`<th></th>`:""}
            </tr>
          </thead>
          <tbody>
            ${(center.formaciones||[]).map((f,i)=>`
              <tr data-row="${i}" data-table="formaciones">
                <td>${editable?`<input type="text" data-table="formaciones" data-row="${i}" data-field="curso" value="${f.curso||""}">`:(f.curso||"")}</td>
                <td>${editable?`<select data-table="formaciones" data-row="${i}" data-field="superado"><option value="S√≠" ${f.superado==="S√≠"?"selected":""}>S√≠</option><option value="No" ${f.superado==="No"?"selected":""}>No</option></select>`:(f.superado||"")}</td>
                <td>${editable?`<select data-table="formaciones" data-row="${i}" data-field="aplicado"><option value="S√≠" ${f.aplicado==="S√≠"?"selected":""}>S√≠</option><option value="No" ${f.aplicado==="No"?"selected":""}>No</option></select>`:(f.aplicado||"")}</td>
                <td>${editable?`<select data-table="formaciones" data-row="${i}" data-field="mentoring"><option value="S√≠" ${f.mentoring==="S√≠"?"selected":""}>S√≠</option><option value="No" ${f.mentoring==="No"?"selected":""}>No</option></select>`:(f.mentoring||"")}</td>
                ${editable?`<td><button class="ghost-icon" data-act="del-row">‚àí</button></td>`:""}
              </tr>
            `).join("")}
          </tbody>
        `;
        box.appendChild(t);
        mainContent.appendChild(box);
      }

      /* --- VISITAS DEL CENTRO --- */
      if (data.view === "visitas") {
        const box = document.createElement("div");
        box.innerHTML = `
          <div class="table-toolbar" style="justify-content:flex-end;">
            <strong style="margin-right:auto; font-size:0.8rem;">Visitas</strong>
            ${editable ? `<button class="tiny-btn" data-act="add-visita">+ Visita</button>` : ""}
          </div>
        `;
        const t = document.createElement("table");
        t.className = "table-like";
        t.innerHTML = `
          <thead>
            <tr>
              <th style="width:120px;">Fecha</th>
              <th>Checklist %</th>
              <th>Estado</th>
              <th>Conv. prueba %</th>
              <th>Conv. venta %</th>
              ${editable?`<th></th>`:""}
            </tr>
          </thead>
          <tbody>
            ${(center.visitas||[]).map((v,i)=>{
              const estado = Number(v.checklist||0) < 85 ? '<span class="badge-bad">ROJO</span>' : '<span class="badge-ok">VERDE</span>';
              const clasePrueba = Number(v.convPrueba||0) < 80 ? 'text-red' : 'text-green';
              const claseVenta = Number(v.convVenta||0) < 80 ? 'text-red' : 'text-green';
              return `
                <tr data-row="${i}" data-table="visitas">
                  <td>${editable?`<input type="date" data-table="visitas" data-row="${i}" data-field="fecha" value="${v.fecha||""}">`:(v.fecha||"")}</td>
                  <td>${editable?`<input type="number" min="0" max="100" data-table="visitas" data-row="${i}" data-field="checklist" value="${v.checklist||""}" style="width:70px;">`:(v.checklist||"")}</td>
                  <td>${estado}</td>
                  <td class="${clasePrueba}">${editable?`<input type="number" min="0" max="100" data-table="visitas" data-row="${i}" data-field="convPrueba" value="${v.convPrueba||""}" style="width:80px;">`:(v.convPrueba||"")}</td>
                  <td class="${claseVenta}">${editable?`<input type="number" min="0" max="100" data-table="visitas" data-row="${i}" data-field="convVenta" value="${v.convVenta||""}" style="width:80px;">`:(v.convVenta||"")}</td>
                  ${editable?`<td><button class="ghost-icon" data-act="del-row">‚àí</button></td>`:""}
                </tr>
              `;
            }).join("")}
          </tbody>
        `;
        box.appendChild(t);
        mainContent.appendChild(box);
      }

      /* --- SERVICIOS --- */
      if (data.view === "servicios") {
        const box = document.createElement("div");
        box.innerHTML = `
          <div class="table-toolbar" style="justify-content:flex-end;">
            <strong style="margin-right:auto; font-size:0.8rem;">Servicios</strong>
            ${editable ? `<button class="tiny-btn" data-act="add-servicio">+ Servicio</button>` : ""}
          </div>
        `;
        const t = document.createElement("table");
        t.className = "table-like";
        t.innerHTML = `
          <thead>
            <tr>
              <th>Servicio</th>
              <th>¬øSe ofrece?</th>
              <th>Ventas</th>
              ${editable?`<th></th>`:""}
            </tr>
          </thead>
          <tbody>
            ${(center.servicios||[]).map((s,i)=>`
              <tr data-row="${i}" data-table="servicios">
                <td>${editable?`<input type="text" data-table="servicios" data-row="${i}" data-field="nombre" value="${s.nombre||""}">`:(s.nombre||"")}</td>
                <td>${editable?`<select data-table="servicios" data-row="${i}" data-field="activo"><option value="S√≠" ${s.activo==="S√≠"?"selected":""}>S√≠</option><option value="No" ${s.activo==="No"?"selected":""}>No</option></select>`:(s.activo||"")}</td>
                <td>${editable?`<input type="number" min="0" data-table="servicios" data-row="${i}" data-field="ventas" value="${s.ventas||""}" style="width:90px;">`:(s.ventas||"")}</td>
                ${editable?`<td><button class="ghost-icon" data-act="del-row">‚àí</button></td>`:""}
              </tr>
            `).join("")}
          </tbody>
        `;
        box.appendChild(t);
        mainContent.appendChild(box);
      }

      right.appendChild(mainContent);
      wrap.appendChild(right);
      contentHolder.appendChild(wrap);
    }

    /* --- FORMACIONES BLOCK (con calendario y suc/franq select) --- */
    function renderFormacionesBlock(data) {
      contentHolder.innerHTML = "";
      const sel = data.selected || 0;
      const delegado = data.delegados[sel] || { nombre: "", tabla: [], adjunto: "" };

      const info = document.createElement("div");
      info.className = "grid-3";
      info.innerHTML = `
        <div class="field">
          <label>Delegado</label>
          <input disabled value="${delegado.nombre || ""}">
        </div>
      `;
      contentHolder.appendChild(info);

      const box = document.createElement("div");
      box.innerHTML = `
        <div class="table-toolbar" style="justify-content:flex-end;">
          <strong style="margin-right:auto;">Formaciones</strong>
          ${editable ? `<button class="tiny-btn" data-act="form-add-row">+ Fila</button>` : ``}
          <label style="font-size:0.7rem;cursor:pointer;">
            ${delegado.adjunto ? "üìé " + delegado.adjunto : "üìé Adjuntar Excel"}
            <input type="file" data-act="form-attach" style="display:none;">
          </label>
          ${editable ? `<button class="tiny-btn" data-act="form-save-block">Guardar</button>` : ``}
        </div>
      `;
      const t = document.createElement("table");
      t.className = "table-like";
      t.innerHTML = `
        <thead>
          <tr>
            <th style="width:120px;">Fecha</th>
            <th style="min-width:200px;">Centros</th>
            <th style="width:130px;">Suc./Franq.</th>
            <th>Tema formaci√≥n</th>
            <th style="width:80px;">Superado</th>
            <th style="width:80px;">Aplicado</th>
            <th style="min-width:180px;">Observaciones</th>
            ${editable ? `<th style="width:35px;"></th>` : ``}
          </tr>
        </thead>
        <tbody>
          ${(delegado.tabla || []).map((r,i)=>`
            <tr data-row="${i}">
              <td>${editable?`<input type="date" data-form-row="${i}" data-form-field="fecha" value="${r.fecha||""}">`:(r.fecha||"")}</td>
              <td>${editable?`<input type="text" data-form-row="${i}" data-form-field="centros" value="${r.centros||""}" style="width:100%;">`:(r.centros||"")}</td>
              <td>${editable?`<select data-form-row="${i}" data-form-field="sucursal"><option value="Sucursal" ${r.sucursal==="Sucursal"?"selected":""}>Sucursal</option><option value="Franquicia" ${r.sucursal==="Franquicia"?"selected":""}>Franquicia</option></select>`:(r.sucursal||"")}</td>
              <td>${editable?`<input type="text" data-form-row="${i}" data-form-field="tema" value="${r.tema||""}" style="width:100%;">`:(r.tema||"")}</td>
              <td>${editable?`<select data-form-row="${i}" data-form-field="superado"><option value="S√≠" ${r.superado==="S√≠"?"selected":""}>S√≠</option><option value="No" ${r.superado==="No"?"selected":""}>No</option></select>`:(r.superado||"")}</td>
              <td>${editable?`<select data-form-row="${i}" data-form-field="aplicado"><option value="S√≠" ${r.aplicado==="S√≠"?"selected":""}>S√≠</option><option value="No" ${r.aplicado==="No"?"selected":""}>No</option></select>`:(r.aplicado||"")}</td>
              <td>${editable?`<input type="text" data-form-row="${i}" data-form-field="obs" value="${r.obs||""}" style="width:100%;">`:(r.obs||"")}</td>
              ${editable ? `<td><button class="ghost-icon" data-act="form-del-row" data-row="${i}">‚àí</button></td>` : ``}
            </tr>
          `).join("")}
        </tbody>
      `;
      box.appendChild(t);
      contentHolder.appendChild(box);
    }

    /* --- VISITAS BLOCK (con visitador, calendario, selects) --- */
    function renderVisitasBlock(data) {
      contentHolder.innerHTML = "";
      const sel = data.selected || 0;
      const delegado = data.delegados[sel] || { nombre: "", visitador: "", visitas: [], adjunto: "" };

      const info = document.createElement("div");
      info.className = "grid-3";
      info.innerHTML = `
        <div class="field">
          <label>Delegado</label>
          <input disabled value="${delegado.nombre || ""}">
        </div>
        <div class="field">
          <label>Visitador</label>
          <input ${editable?"":"disabled"} data-vis-meta="visitador" value="${delegado.visitador || ""}">
        </div>
      `;
      contentHolder.appendChild(info);

      const box = document.createElement("div");
      box.innerHTML = `
        <div class="table-toolbar" style="justify-content:flex-end;">
          <strong style="margin-right:auto;">Visitas</strong>
          ${editable ? `<button class="tiny-btn" data-act="vis-add-row">+ Visita</button>` : ``}
          <label style="font-size:0.7rem;cursor:pointer;">
            ${delegado.adjunto ? "üìé " + delegado.adjunto : "üìé Adjuntar Excel"}
            <input type="file" data-act="vis-attach" style="display:none;">
          </label>
          ${editable ? `<button class="tiny-btn" data-act="vis-save-block">Guardar</button>` : ``}
        </div>
      `;
      const t = document.createElement("table");
      t.className = "table-like";
      t.innerHTML = `
        <thead>
          <tr>
            <th style="width:115px;">Fecha</th>
            <th style="min-width:220px;">Centros</th>
            <th style="width:120px;">Suc./Franq.</th>
            <th style="width:110px;">Audi√≥logo</th>
            <th style="width:85px;">Checklist %</th>
            <th style="width:70px;">Estado</th>
            <th style="width:95px;">Conv. prueba %</th>
            <th style="width:95px;">Conv. venta %</th>
            <th style="width:75px;">HIT</th>
            <th style="width:75px;">AAR</th>
            <th style="width:95px;">RT-equipo</th>
            <th style="min-width:220px;">Observaciones</th>
            ${editable ? `<th style="width:35px;"></th>` : ``}
          </tr>
        </thead>
        <tbody>
          ${(delegado.visitas || []).map((v,i)=>{
            const malo = Number(v.checklist || 0) < 85;
            const estado = malo ? '<span class="badge-bad">ROJO</span>' : '<span class="badge-ok">VERDE</span>';
            const pruebaMala = Number(v.convPrueba || 0) < 80;
            const ventaMala = Number(v.convVenta || 0) < 80;
            return `
              <tr data-row="${i}">
                <td>${editable?`<input type="date" data-vis-row="${i}" data-vis-field="fecha" value="${v.fecha||""}">`:(v.fecha||"")}</td>
                <td>${editable?`<input type="text" data-vis-row="${i}" data-vis-field="centros" value="${v.centros||""}" style="width:100%;">`:(v.centros||"")}</td>
                <td>${editable?`<select data-vis-row="${i}" data-vis-field="sucursal"><option value="Sucursal" ${v.sucursal==="Sucursal"?"selected":""}>Sucursal</option><option value="Franquicia" ${v.sucursal==="Franquicia"?"selected":""}>Franquicia</option></select>`:(v.sucursal||"")}</td>
                <td>${editable?`<input type="text" data-vis-row="${i}" data-vis-field="audiologo" value="${v.audiologo||""}" style="width:100%;">`:(v.audiologo||"")}</td>
                <td>${editable?`<input type="number" min="0" max="100" data-vis-row="${i}" data-vis-field="checklist" value="${v.checklist||""}" style="width:70px;">`:(v.checklist||"")}</td>
                <td>${estado}</td>
                <td class="${pruebaMala?"text-red":"text-green"}">${editable?`<input type="number" min="0" max="100" data-vis-row="${i}" data-vis-field="convPrueba" value="${v.convPrueba||""}" style="width:80px;">`:(v.convPrueba||"")}</td>
                <td class="${ventaMala?"text-red":"text-green"}">${editable?`<input type="number" min="0" max="100" data-vis-row="${i}" data-vis-field="convVenta" value="${v.convVenta||""}" style="width:80px;">`:(v.convVenta||"")}</td>
                <td>${editable?`<select data-vis-row="${i}" data-vis-field="hit"><option value="S√≠" ${v.hit==="S√≠"?"selected":""}>S√≠</option><option value="No" ${v.hit==="No"?"selected":""}>No</option></select>`:(v.hit||"")}</td>
                <td>${editable?`<select data-vis-row="${i}" data-vis-field="arr"><option value="S√≠" ${v.arr==="S√≠"?"selected":""}>S√≠</option><option value="No" ${v.arr==="No"?"selected":""}>No</option></select>`:(v.arr||"")}</td>
                <td>${editable?`<select data-vis-row="${i}" data-vis-field="rt"><option value="S√≠" ${v.rt==="S√≠"?"selected":""}>S√≠</option><option value="No" ${v.rt==="No"?"selected":""}>No</option></select>`:(v.rt||"")}</td>
                <td>${editable?`<input type="text" data-vis-row="${i}" data-vis-field="obs" value="${v.obs||""}" style="width:100%;">`:(v.obs||"")}</td>
                ${editable ? `<td><button class="ghost-icon" data-act="vis-del-row" data-row="${i}">‚àí</button></td>` : ``}
              </tr>
            `;
          }).join("")}
        </tbody>
      `;
      box.appendChild(t);
      contentHolder.appendChild(box);
    }

    /* --- RENDER SIMPLE --- */
    function renderSimple(data) {
      contentHolder.innerHTML = "";
      const list = document.createElement("div");
      list.className = "list";
      (data.items || []).forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="item-header">
            <strong ${editable ? `contenteditable="true" data-idx="${idx}" data-field="titulo"` : ""}>${item.titulo}</strong>
            ${editable ? `<div class="item-actions"><button class="tiny-btn" data-act="del-simple" data-idx="${idx}">‚úñ</button></div>` : ""}
          </div>
          <small ${editable ? `contenteditable="true" data-idx="${idx}" data-field="detalle"` : ""}>${item.detalle}</small>
          <small>üìÖ <span ${editable ? `contenteditable="true" data-idx="${idx}" data-field="fecha"` : ""}>${item.fecha || ""}</span></small>
        `;
        list.appendChild(div);
      });
      if (editable) {
        const addBtn = document.createElement("button");
        addBtn.textContent = "+ A√±adir elemento";
        addBtn.className = "tiny-btn";
        addBtn.onclick = () => {
          data.items.push({ titulo: "Nuevo", detalle: "", fecha: "" });
          persist(); renderCurrentBlock();
        };
        list.appendChild(addBtn);
      }
      contentHolder.appendChild(list);
    }

    /* --- RENDER PRINCIPAL --- */
    function renderCurrentBlock() {
      const data = blocks[currentBlock]; if (!data) return;
      badgeColor.style.background = data.color || "#fff";
      sectionTitle.textContent = currentBlock;
      if (!editable) contentWrap.classList.add("locked"); else contentWrap.classList.remove("locked");

      if (currentBlock === "OBJETIVOS") {
        renderObjectives(data);
      } else if (currentBlock === "CENTROS EXCLUSIVOS" || currentBlock === "CENTROS FLOP") {
        renderCentersBlock(currentBlock, data);
      } else if (currentBlock === "FORMACIONES Y MENTORING") {
        renderFormacionesBlock(data);
      } else if (currentBlock === "VISITAS") {
        renderVisitasBlock(data);
      } else {
        renderSimple(data);
      }
    }

    /* --- PIN --- */
    pinBtn.addEventListener("click", () => {
      const v = pinInput.value.trim();
      if (v === PIN_MASTER) setEditable(true);
      else { alert("PIN incorrecto. Usa AR4321"); setEditable(false); }
    });
    pinInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const v = pinInput.value.trim();
        if (v === PIN_MASTER) setEditable(true);
        else { alert("PIN incorrecto. Usa AR4321"); setEditable(false); }
      }
    });

    /* --- CAMBIO DE BLOQUE --- */
    leftPanel.addEventListener("click", (e) => {
      const btn = e.target.closest(".block-btn");
      if (!btn) return;
      document.querySelectorAll(".block-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentBlock = btn.dataset.type;
      renderCurrentBlock();
    });

    /* --- A√ëADIR BLOQUE --- */
    addBlock.addEventListener("click", () => {
      if (!editable) return alert("Primero desbloquea edici√≥n con el PIN AR4321.");
      const name = prompt("Nombre del nuevo bloque:");
      if (!name) return;
      blocks[name] = { color: "#fff5d9", items: [] };
      persist();
      const btn = document.createElement("button");
      btn.className = "block-btn";
      btn.dataset.type = name;
      btn.dataset.color = "#fff5d9";
      btn.innerHTML = `<div class="tag" style="background: rgba(0,0,0,0.04);">üÜï</div><div><div>${name}</div><small>Nuevo bloque</small></div>`;
      leftPanel.appendChild(btn);
    });

    /* --- CLICS DENTRO DEL CONTENIDO --- */
    contentHolder.addEventListener("click", (e) => {
      const t = e.target;

      /* OBJETIVOS */
      if (t.dataset.act === "edit-obj") {
        const idx = +t.dataset.idx;
        const item = blocks["OBJETIVOS"].items[idx];
        const nt = prompt("T√≠tulo del objetivo", item.titulo || "");
        if (nt !== null) item.titulo = nt;
        const nd = prompt("Detalle / KPI", item.detalle || "");
        if (nd !== null) item.detalle = nd;
        const nf = prompt("Fecha", item.fecha || "");
        if (nf !== null) item.fecha = nf;
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "add-obj") {
        blocks["OBJETIVOS"].items.splice(+t.dataset.idx + 1, 0, { titulo: "Nuevo objetivo", detalle: "", fecha: "" });
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "del-obj") {
        blocks["OBJETIVOS"].items.splice(+t.dataset.idx, 1);
        persist(); renderCurrentBlock(); return;
      }

      /* SELECTOR CENTRO DE ESTE BLOQUE */
      if (t.dataset.act === "select-center") {
        const data = blocks[currentBlock];
        data.selected = parseInt(t.value, 10) || 0;
        persist(); renderCurrentBlock(); return;
      }

      /* SUBTABS DE CENTROS */
      if (t.closest(".center-subnav") && (currentBlock === "CENTROS EXCLUSIVOS" || currentBlock === "CENTROS FLOP")) {
        const btn = t.closest("button[data-sub]");
        if (btn) {
          const data = blocks[currentBlock];
          data.view = btn.dataset.sub;
          persist(); renderCurrentBlock();
        }
        return;
      }

      /* A√ëADIR / BORRAR / RENOMBRAR CENTRO */
      if (t.dataset.act === "add-center") {
        const data = blocks[currentBlock];
        data.centers.push({
          nombre: currentBlock === "CENTROS EXCLUSIVOS" ? "Centro exclusivo nuevo" : "Centro flop nuevo",
          delegado: "",
          audiologo: "",
          tipo: "Sucursal",
          acciones: [],
          formaciones: [],
          visitas: [],
          servicios: [
            { nombre: "Tinnitus-TRT", activo: "No", ventas: "" },
            { nombre: "Pedi√°trico", activo: "No", ventas: "" },
            { nombre: "AAR", activo: "No", ventas: "" },
            { nombre: "HIT", activo: "No", ventas: "" }
          ]
        });
        data.selected = data.centers.length - 1;
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "del-center") {
        const data = blocks[currentBlock];
        if (!data.centers || data.centers.length === 0) return;
        const idx = data.selected || 0;
        data.centers.splice(idx, 1);
        if (data.selected > 0) data.selected -= 1;
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "rename-center-head") {
        const data = blocks[currentBlock];
        const idx = data.selected || 0;
        const c = data.centers[idx];
        const nuevo = prompt("Nombre del centro:", c.nombre || "");
        if (nuevo !== null) {
          c.nombre = nuevo.trim();
          persist(); renderCurrentBlock();
        }
        return;
      }
      if (t.dataset.act === "save-centers") {
        persist();
        alert("Centros guardados en este bloque.");
        return;
      }

      /* TABLAS DE CENTROS: A√ëADIR FILAS */
      if (t.dataset.act === "add-accion") {
        const d = blocks[currentBlock];
        const c = d.centers[d.selected || 0];
        c.acciones.push({ tipo: "Azafata", fecha: "", derivaciones: "", citas: "", ventas: "", obs: "" });
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "add-forma") {
        const d = blocks[currentBlock];
        const c = d.centers[d.selected || 0];
        c.formaciones.push({ curso: "", superado: "No", aplicado: "No", mentoring: "No" });
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "add-visita") {
        const d = blocks[currentBlock];
        const c = d.centers[d.selected || 0];
        c.visitas.push({ fecha: "", checklist: "", convPrueba: "", convVenta: "" });
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "add-servicio") {
        const d = blocks[currentBlock];
        const c = d.centers[d.selected || 0];
        c.servicios.push({ nombre: "Servicio nuevo", activo: "No", ventas: "" });
        persist(); renderCurrentBlock(); return;
      }

      /* BORRAR FILA DE TABLA DE CENTRO */
      if (t.dataset.act === "del-row" && (currentBlock === "CENTROS EXCLUSIVOS" || currentBlock === "CENTROS FLOP")) {
        const tr = t.closest("tr");
        const d = blocks[currentBlock];
        const c = d.centers[d.selected || 0];
        const tableName = tr.dataset.table;
        const idx = +tr.dataset.row;
        c[tableName].splice(idx, 1);
        persist(); renderCurrentBlock(); return;
      }

      /* FORMACIONES BLOQUE */
      if (t.dataset.act === "form-add-row") {
        const d = blocks["FORMACIONES Y MENTORING"];
        const del = d.delegados[d.selected || 0];
        del.tabla.push({ fecha:"", centros:"", sucursal:"Sucursal", tema:"", superado:"No", aplicado:"No", obs:"" });
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "form-del-row") {
        const d = blocks["FORMACIONES Y MENTORING"];
        const del = d.delegados[d.selected || 0];
        del.tabla.splice(+t.dataset.row, 1);
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "form-save-block") {
        persist(); alert("Formaciones guardadas."); return;
      }

      /* VISITAS BLOQUE */
      if (t.dataset.act === "vis-add-row") {
        const v = blocks["VISITAS"];
        const del = v.delegados[v.selected || 0];
        del.visitas.push({ fecha:"", centros:"", sucursal:"Sucursal", audiologo:"", checklist:"", convPrueba:"", convVenta:"", hit:"No", arr:"No", rt:"No", obs:"" });
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "vis-del-row") {
        const v = blocks["VISITAS"];
        const del = v.delegados[v.selected || 0];
        del.visitas.splice(+t.dataset.row, 1);
        persist(); renderCurrentBlock(); return;
      }
      if (t.dataset.act === "vis-save-block") {
        persist(); alert("Visitas guardadas."); return;
      }

      /* borrar simple */
      if (t.dataset.act === "del-simple") {
        const data = blocks[currentBlock];
        data.items.splice(+t.dataset.idx, 1);
        persist(); renderCurrentBlock(); return;
      }
    });

    /* --- INPUTS / CAMBIOS --- */
    contentHolder.addEventListener("input", handleChange);
    contentHolder.addEventListener("change", handleChange);

    function handleChange(e) {
      const t = e.target;

      /* CAMPOS DE CENTRO (nombre, delegado, audiologo, tipo) */
      if ((currentBlock === "CENTROS EXCLUSIVOS" || currentBlock === "CENTROS FLOP") && t.dataset.field) {
        const d = blocks[currentBlock];
        const c = d.centers[d.selected || 0];
        c[t.dataset.field] = t.value;
        persist();
        return;
      }

      /* TABLAS DE CENTROS */
      if ((currentBlock === "CENTROS EXCLUSIVOS" || currentBlock === "CENTROS FLOP") && t.dataset.table) {
        const d = blocks[currentBlock];
        const c = d.centers[d.selected || 0];
        const table = t.dataset.table;
        const row = +t.dataset.row;
        if (table === "acciones") {
          const a = c.acciones[row] || {};
          a[t.dataset.field] = t.value;
          c.acciones[row] = a;
        } else if (table === "formaciones") {
          const f = c.formaciones[row] || {};
          f[t.dataset.field] = t.value;
          c.formaciones[row] = f;
        } else if (table === "visitas") {
          const v = c.visitas[row] || {};
          v[t.dataset.field] = t.value;
          c.visitas[row] = v;
        } else if (table === "servicios") {
          const s = c.servicios[row] || {};
          s[t.dataset.field] = t.value;
          c.servicios[row] = s;
        }
        persist();
        if (table === "visitas") renderCurrentBlock();
        return;
      }

      /* FORMACIONES BLOQUE */
      if (currentBlock === "FORMACIONES Y MENTORING" && (t.dataset.formRow !== undefined)) {
        const d = blocks["FORMACIONES Y MENTORING"];
        const del = d.delegados[d.selected || 0];
        const row = +t.dataset.formRow;
        const r = del.tabla[row] || {};
        r[t.dataset.formField] = t.value;
        del.tabla[row] = r;
        persist();
        return;
      }

      /* VISITAS BLOQUE */
      if (currentBlock === "VISITAS" && (t.dataset.visRow !== undefined)) {
        const v = blocks["VISITAS"];
        const del = v.delegados[v.selected || 0];
        const row = +t.dataset.visRow;
        const r = del.visitas[row] || {};
        r[t.dataset.visField] = t.value;
        del.visitas[row] = r;
        persist();
        renderVisitasBlock(v);
        return;
      }

      /* VISITAS: visitador */
      if (currentBlock === "VISITAS" && t.dataset.visMeta === "visitador") {
        const v = blocks["VISITAS"];
        const del = v.delegados[v.selected || 0];
        del.visitador = t.value;
        persist();
        return;
      }

      /* bloques simples */
      if (t.dataset && typeof t.dataset.idx !== "undefined" && t.dataset.field) {
        const data = blocks[currentBlock];
        const idx = +t.dataset.idx;
        data.items[idx][t.dataset.field] = t.textContent.trim();
        persist();
      }
    }

    /* --- DESCARGAS --- */
    document.getElementById("btnHTML").addEventListener("click", () => {
      const blob = new Blob([document.documentElement.outerHTML], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "seguimiento-audio-ar.html"; a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById("btnPDF").addEventListener("click", () => { alert("Exportar a PDF: usa Imprimir > Guardar como PDF."); });
    document.getElementById("btnXLS").addEventListener("click", () => {
      const rows = [["Bloque","Campo1","Campo2","Campo3","Campo4"]];
      Object.keys(blocks).forEach(bn => {
        const b = blocks[bn];
        if (bn === "CENTROS EXCLUSIVOS" || bn === "CENTROS FLOP") {
          (b.centers || []).forEach(c => { rows.push([bn, c.nombre, c.delegado, c.audiologo, c.tipo]); });
        } else {
          (b.items || []).forEach(it => { rows.push([bn, it.titulo, it.detalle, it.fecha || "", ""]); });
        }
      });
      const csv = rows.map(r => r.map(v => `"${(v||"").replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "seguimiento-audio-ar.csv"; a.click();
      URL.revokeObjectURL(url);
    });

    /* --- TEST --- */
    function runSmokeTests() {
      console.log("[TEST] estructura b√°sica cargada");
      console.assert(!!document.getElementById("leftPanel"), "leftPanel no existe");
      console.assert(!!document.getElementById("contentHolder"), "contentHolder no existe");
    }

    renderCurrentBlock();
    runSmokeTests();

    saveLocalBtn.addEventListener("click", () => {
      persist();
      editStatus.textContent = "Guardado local";
      setTimeout(() => {
        editStatus.textContent = editable ? "Edici√≥n activada" : "Solo lectura";
      }, 2000);
    });
  </script>
</body>
</html>
