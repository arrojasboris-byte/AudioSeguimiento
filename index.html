<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>SEGUIMIENTO AUDIO</title>
<meta name="theme-color" content="#c82727"/>
<style>
:root{
  --rojo:#c82727; --rojo2:#a71f1f; --bg:#f6f7fb; --line:#e8e8ee; --sh:0 4px 14px rgba(0,0,0,.06);
  --col-sv:#ffe9cc; --col-ex:#fde2e4; --col-fl:#e2f0cb; --col-va:#cde7f0; --col-fm:#f9e5c9; --col-ta:#eadcf8; --col-eq:#e8f1ff;
  --fs:12px; --fs-sm:11px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#222;font-size:var(--fs);line-height:1.15}

/* Topbar */
.topbar{position:sticky;top:0;z-index:30;width:100%;background:linear-gradient(180deg,var(--rojo),var(--rojo2));box-shadow:var(--sh)}
.topbar .inner{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:.6rem;padding:1rem .9rem}
.brand{justify-self:center;display:flex;align-items:center;gap:.6rem;color:#fff}
.brand i{font-style:normal;font-size:22px}
.brand span{font-weight:900;font-size:24px;letter-spacing:.3px}
.actions{justify-self:start;display:flex;gap:.4rem}
.actions .btn{background:#fff;border:0;border-radius:10px;padding:.46rem .8rem;cursor:pointer;font-weight:800;box-shadow:var(--sh)}
.meta{justify-self:end;color:#fff;font-weight:700;opacity:.9}

/* Layout */
.wrapper{display:grid;grid-template-columns:230px minmax(0,1fr);gap:8px;padding:8px}
.sidebar{display:flex;flex-direction:column;gap:8px}
.side-card{border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--sh);overflow:hidden}
.side-card .head{display:flex;justify-content:space-between;align-items:center;padding:.5rem .6rem;font-weight:900}
.side-card .head .group{display:flex;gap:.35rem}
.side-card .list{padding:.25rem .45rem .5rem;max-height:240px;overflow:auto}
.item{display:flex;justify-content:space-between;align-items:center;gap:.35rem;padding:.32rem .38rem;margin:.22rem 0;border:1px solid var(--line);border-radius:9px;background:#fff}
.item .name{font-weight:750}
.btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:.25rem .5rem;cursor:pointer}
.i28{width:26px;height:22px;border:1px solid var(--line);border-radius:7px;background:#fff;cursor:pointer}

/* Detail */
.detail{border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--sh);min-height:74vh;padding:.6rem}
.hdr{display:flex;gap:.6rem;align-items:center;margin:.2rem 0 .5rem}
.hdr h2{margin:0;font-size:18px}
.badge{padding:.12rem .52rem;border-radius:999px;background:#0001}
.toolsRow{display:flex;gap:.4rem;align-items:center;margin:.3rem 0}
.toolsRow .search{flex:1;display:flex;gap:.35rem}
.search input,.search select{border:1px solid var(--line);border-radius:8px;padding:.28rem .4rem;font-size:var(--fs-sm);width:100%}

/* Tables */
.table{border:1px solid var(--line);border-radius:10px;overflow:auto}
.xscroll{overflow:auto}
.grid{display:grid;gap:1px;background:var(--line)}
.grid>div{background:#fff;padding:.30rem .36rem}
.grid .head{background:#f7f8ff;font-weight:800}
.num,.txt,.date,.sel,textarea{width:100%;border:1px solid var(--line);border-radius:6px;padding:.24rem .34rem;font-size:var(--fs-sm)}
.ok{background:#eaf9f0!important;border:1px solid #bfe3cd}
.bad{background:#ffe9e9!important;border:1px solid #f4c7c7}

/* Sales layout: table + chart */
.sales-2col{display:grid;grid-template-columns:1fr 360px;gap:10px;align-items:start}
.chartCard{border:1px solid var(--line);border-radius:10px;background:#fff;box-shadow:var(--sh);padding:.4rem}
.chartTitle{font-weight:900;margin:.1rem 0 .35rem}
svg{width:100%;height:260px}

/* PIN */
.gate{position:fixed;inset:0;background:#000a;display:flex;align-items:center;justify-content:center;z-index:100}
.card{background:#111;color:#fff;min-width:300px;border-radius:12px;border:1px solid #2a2a2a;padding:16px 14px;box-shadow:var(--sh)}
.card h3{margin:.1rem 0 .6rem}.pin{width:100%;letter-spacing:.35rem;font-size:1rem;text-align:center;background:#000;color:#fff;border:1px solid #444;border-radius:8px;padding:.46rem}
.btnRow{display:flex;gap:.5rem;margin-top:10px}.btnDark{flex:1;background:#fff;border:0;color:#111;font-weight:900;border-radius:10px;padding:.5rem .85rem;cursor:pointer}
.btnGhost{flex:.9;background:transparent;color:#fff;border:1px solid #ffffff55;border-radius:10px;padding:.5rem .85rem;cursor:pointer}
.msg{color:#ff8080;display:none;margin-top:.45rem}
.small{font-size:10px;opacity:.75}
</style>
</head>
<body>
<header class="topbar">
  <div class="inner">
    <div class="actions">
      <button id="btnLoad" class="btn">Actualizar (local)</button>
      <button id="btnSave" class="btn">Guardar (local)</button>
    </div>
    <div class="brand"><i>üéß</i><span>SEGUIMIENTO AUDIO</span></div>
    <div id="stamp" class="meta">Listo</div>
  </div>
</header>

<main class="wrapper">
  <!-- ======= IZQUIERDA (editable) ======= -->
  <aside class="sidebar">
    <!-- Cifra -->
    <div class="side-card" style="background:var(--col-sv)">
      <div class="head">üìä CIFRA
        <div class="group">
          <button class="i28" id="svOpenCompany" title="Compa√±√≠a ‚ûú">‚û°Ô∏è</button>
          <button class="i28" id="svOpenCenters"  title="Centros exclusivos ‚ûú">‚û°Ô∏è</button>
        </div>
      </div>
      <div class="list small">Usa las flechas para abrir el panel a la derecha.</div>
    </div>

    <!-- Centros EX -->
    <div class="side-card" style="background:var(--col-ex)">
      <div class="head">üìí CENTROS EXCLUSIVOS
        <div class="group"><button class="i28" id="ceToggle">‚ñæ</button><button class="i28" id="ceAdd">Ôºã</button></div>
      </div>
      <div class="list" id="ceList"></div>
    </div>

    <!-- Centros FLOP -->
    <div class="side-card" style="background:var(--col-fl)">
      <div class="head">üìí CENTROS FLOP
        <div class="group"><button class="i28" id="flToggle">‚ñæ</button><button class="i28" id="flAdd">Ôºã</button></div>
      </div>
      <div class="list" id="flList"></div>
    </div>

    <!-- Visitas -->
    <div class="side-card" style="background:var(--col-va)">
      <div class="head">üìã VISITAS AUDIO
        <div class="group"><button class="i28" id="vaToggle">‚ñæ</button><button class="i28" id="vaAdd">Ôºã</button></div>
      </div>
      <div class="list" id="vaList"></div>
    </div>

    <!-- Formaciones y mentoring -->
    <div class="side-card" style="background:var(--col-fm)">
      <div class="head">üéì FORMACIONES Y MENTORING
        <div class="group"><button class="i28" id="fmToggle">‚ñæ</button><button class="i28" id="fmAdd">Ôºã</button></div>
      </div>
      <div class="list" id="fmList"></div>
    </div>

    <!-- Teleaudiolog√≠a -->
    <div class="side-card" style="background:var(--col-ta)">
      <div class="head">üì° TELEAUDIOLOGIA
        <div class="group"><button class="i28" id="taToggle">‚ñæ</button><button class="i28" id="taAdd">Ôºã</button></div>
      </div>
      <div class="list" id="taList"></div>
    </div>

    <!-- Equipos -->
    <div class="side-card" style="background:var(--col-eq)">
      <div class="head">üß∞ EQUIPOS
        <div class="group"><button class="i28" id="eqToggle">‚ñæ</button><button class="i28" id="eqAdd">Ôºã</button></div>
      </div>
      <div class="list" id="eqList"></div>
    </div>
  </aside>

  <!-- ======= DERECHA ======= -->
  <section class="detail">
    <div class="hdr">
      <h2 id="detTitle">Detalle</h2>
      <span id="detTag" class="badge">‚Äî</span>
    </div>

    <!-- CIFRA ¬∑ Compa√±√≠a -->
    <div id="panelSalesCompany" style="display:none" class="sales-2col">
      <div>
        <div class="toolsRow">
          <div class="search"><input id="svCoSearch" placeholder="Buscar mes‚Ä¶"></div>
          <button class="btn" id="svCoAdd">Ôºã A√±adir fila</button>
        </div>
        <div class="table xscroll"><div class="grid" id="gridSalesCompany"></div></div>
      </div>
      <div class="chartCard">
        <div class="chartTitle">Objetivos vs Real ‚Äî Compa√±√≠a</div>
        <svg id="chartCompany" viewBox="0 0 360 260" preserveAspectRatio="xMidYMid meet"></svg>
        <div class="small">Verde: CV mes ¬∑ Gris: Previsto</div>
      </div>
    </div>

    <!-- CIFRA ¬∑ Centros exclusivos -->
    <div id="panelSalesCenters" style="display:none" class="sales-2col">
      <div>
        <div class="toolsRow">
          <div class="search"><input id="svCeSearch" placeholder="Buscar centro‚Ä¶"></div>
          <button class="btn" id="svCentersAdd">Ôºã A√±adir fila</button>
        </div>
        <div class="table xscroll"><div class="grid" id="gridSalesCenters"></div></div>
      </div>
      <div class="chartCard">
        <div class="chartTitle">Objetivos vs Real ‚Äî Centros exclusivos</div>
        <svg id="chartCenters" viewBox="0 0 360 260" preserveAspectRatio="xMidYMid meet"></svg>
        <div class="small">Verde: CV mes ¬∑ Gris: Previsto</div>
      </div>
    </div>

    <!-- Detalle Centros (EX/FLOP) -->
    <div id="panelCentro" style="display:none">
      <div class="toolsRow">
        <div class="search" style="opacity:.7"><span class="small">Panel editable del centro seleccionado</span></div>
        <button class="btn" id="accAdd">Ôºã Acciones</button>
        <button class="btn" id="frmAdd">Ôºã Formaci√≥n</button>
        <button class="btn" id="procAdd">Ôºã Procesos</button>
      </div>
      <div class="table xscroll" style="margin:.25rem 0 .5rem"><div class="grid" id="gridCentroInfo"></div></div>

      <h4 style="margin:.4rem 0 .2rem">ACCIONES</h4>
      <div class="table xscroll"><div class="grid" id="gridAcciones"></div></div>

      <h4 style="margin:.6rem 0 .2rem">FORMACI√ìN</h4>
      <div class="table xscroll"><div class="grid" id="gridFormacion"></div></div>

      <h4 style="margin:.6rem 0 .2rem">PROCESOS</h4>
      <div class="table xscroll"><div class="grid" id="gridProcesos"></div></div>
    </div>

    <!-- Visitas -->
    <div id="panelVisitas" style="display:none">
      <div class="toolsRow">
        <div class="search">
          <input id="vaSearch" placeholder="Buscar centro o visitador‚Ä¶">
          <select id="vaRol"><option>Responsable Tec. Audio</option><option>Delegado de Audio</option></select>
          <input id="vaVisitador" placeholder="Nombre del visitador">
        </div>
        <button class="btn" id="vaAddRow">Ôºã A√±adir fila</button>
      </div>
      <div class="table xscroll"><div class="grid" id="gridVisitas"></div></div>
    </div>

    <!-- Formaciones y mentoring -->
    <div id="panelFM" style="display:none">
      <div class="toolsRow">
        <div class="search">
          <select id="fmMode">
            <option value="general">Mentoring general</option>
            <option value="delegados">Mentoring por delegados</option>
            <option value="coaching">Coaching por delegado</option>
          </select>
          <input id="fmSearch" placeholder="Filtrar por tema / persona‚Ä¶">
        </div>
        <button class="btn" id="fmAddRow">Ôºã A√±adir fila</button>
      </div>
      <div class="table xscroll"><div class="grid" id="gridFM"></div></div>
    </div>

    <!-- Teleaudiolog√≠a -->
    <div id="panelTA" style="display:none">
      <div class="toolsRow">
        <div class="search"><input id="taSearch" placeholder="Buscar centro o persona‚Ä¶"></div>
        <button class="btn" id="taAddRow">Ôºã A√±adir fila</button>
      </div>
      <div class="table xscroll"><div class="grid" id="gridTA"></div></div>
    </div>

    <!-- Equipos -->
    <div id="panelEQ" style="display:none">
      <div class="toolsRow">
        <div class="search"><input id="eqSearch" placeholder="Equipo / serie / centro / persona‚Ä¶"></div>
        <button class="btn" id="eqAddRow">Ôºã A√±adir fila</button>
      </div>
      <div class="table xscroll"><div class="grid" id="gridEQ"></div></div>
    </div>

    <div id="panelPlaceholder" style="opacity:.75">Selecciona en la izquierda para editar.</div>
  </section>
</main>

<!-- ===== PIN ===== -->
<div class="gate" id="gate">
  <div class="card">
    <h3>Acceso</h3>
    <p>Introduce el PIN para editar:</p>
    <input id="pin" class="pin" type="password" inputmode="numeric" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
    <div class="btnRow">
      <button class="btnDark" id="btnAcceder">Acceder</button>
      <button class="btnDark" id="enter">Entrar</button>
      <button class="btnDark" id="btnEnter">Enter</button>
      <button class="btnGhost" id="clearPin">Limpiar</button>
    </div>
    <p id="pinMsg" class="msg">PIN incorrecto</p>
  </div>
</div>

<script>
/* ===== Utils ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const money=v=>isFinite(+v)?(+v).toLocaleString('es-ES'):'';
const MONTHS=['Ago-2025','Sep-2025','Oct-2025','Nov-2025','Dic-2025','Ene-2026','Feb-2026','Mar-2026','Abr-2026','May-2026','Jun-2026','Jul-2026'];
const LSKEY='seguimiento_audio_final';
function stamp(t){ $('#stamp').textContent=t+' ¬∑ '+new Date().toLocaleString(); }
function save(){ localStorage.setItem(LSKEY, JSON.stringify(state)); stamp('Guardado local'); }
function load(){ try{ const raw=localStorage.getItem(LSKEY); if(raw) state=JSON.parse(raw);}catch{} stamp('Cargado local'); }

/* ===== Estado ===== */
let state={
  selected:{section:null,index:null,type:null}, // type EX | FLOP
  filters:{svCo:'',svCe:'',va:'',fm:'',ta:'',eq:''},
  sales:{
    company: MONTHS.map(m=>({mes:m,previsto:null,cv:null,adj:null})),
    centers: [] // {centro, previsto, cv, adj}
  },
  centros:{
    ex:[{nombre:'Reina Mercedes',delegado:'',audiologo:'',tipo:'Franquicia',
      acciones:Array.from({length:5},()=>({fecha:'',paquete:'1',tipo:'Azafata',derivacion:null,citas:null,venta:null,obs:'',adj:null})),
      formacion:Array.from({length:4},()=>({curso:'',realizado:false,aplica:false,obs:'',adj:null})),
      procesos:Array.from({length:3},()=>({fecha:'',puntuacion:null,hit:false,rt:false,pruebas:null,venta:null,colab:'',obs:'',adj:null}))
    }],
    flop:[]
  },
  visitas: Array.from({length:250},()=>({centro:'',visitador:'',rol:'Responsable Tec. Audio',fecha:'',puntuacion:null,hit:false,conv_prueba:null,conv_venta:null,adj:null})),
  fm:{
    general:[{fecha:'',tema:'',asistencia:'',obs:'',adj:null}],
    delegados:[{fecha:'',tema:'',asistencia:'',obs:'',adj:null}],
    coaching:[{fecha:'',tema:'',asistencia:'',obs:'',adj:null}],
    mode:'general'
  },
  ta:[{centro:'',delegado:'',rol:'Audi√≥logo',persona:'',formacion:false,practicas:false,certificado:false,pruebas:false,ventas:false,obs:''}],
  eq:[{equipo:'',serie:'',persona:'',fecha:'',centro:'',en:false,sede:false,adj:null}]
};

/* ===== Sidebar (edici√≥n) ===== */
function renderSidebar(){
  // Centros EX
  const ceList=$('#ceList'); ceList.innerHTML='';
  state.centros.ex.forEach((c,i)=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div class="name">${c.nombre||'(nuevo centro)'}</div>
      <div><button class="i28" title="Editar">‚úèÔ∏è</button><button class="i28" title="Borrar">üóëÔ∏è</button></div>`;
    el.querySelectorAll('button')[0].onclick=()=>{ state.selected={section:'CENTROS',index:i,type:'EX'}; openCentro('EX'); };
    el.querySelectorAll('button')[1].onclick=()=>{ if(confirm('¬øEliminar centro?')){ state.centros.ex.splice(i,1); renderSidebar(); showPlaceholder(); save(); } };
    ceList.appendChild(el);
  });
  $('#ceAdd').onclick=()=>{ state.centros.ex.push({nombre:'(nuevo centro)',delegado:'',audiologo:'',tipo:'Franquicia',acciones:[],formacion:[],procesos:[]}); renderSidebar(); save(); };

  // Centros FLOP
  const flList=$('#flList'); flList.innerHTML='';
  state.centros.flop.forEach((c,i)=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div class="name">${c.nombre||'(nuevo flop)'}</div>
      <div><button class="i28" title="Editar">‚úèÔ∏è</button><button class="i28" title="Borrar">üóëÔ∏è</button></div>`;
    el.querySelectorAll('button')[0].onclick=()=>{ state.selected={section:'CENTROS',index:i,type:'FLOP'}; openCentro('FLOP'); };
    el.querySelectorAll('button')[1].onclick=()=>{ if(confirm('¬øEliminar centro?')){ state.centros.flop.splice(i,1); renderSidebar(); showPlaceholder(); save(); } };
    flList.appendChild(el);
  });
  $('#flAdd').onclick=()=>{ state.centros.flop.push({nombre:'(nuevo flop)',delegado:'',audiologo:'',tipo:'Franquicia',acciones:[],formacion:[],procesos:[]}); renderSidebar(); save(); };

  // Visitas (√≠ndice m√≠nimo)
  const vaList=$('#vaList'); vaList.innerHTML='';
  const el=document.createElement('div'); el.className='item';
  el.innerHTML=`<div class="name">Listado de visitas (250)</div><div><button class="i28" title="Abrir">‚û°Ô∏è</button></div>`;
  el.querySelector('button').onclick=()=>openVisitas();
  vaList.appendChild(el);
  $('#vaAdd').onclick=()=>openVisitas();

  // FM: tres criterios
  const fmList=$('#fmList'); fmList.innerHTML='';
  [['üß≠ Mentoring general','general'],['üë• Mentoring por delegados','delegados'],['üéØ Coaching por delegado','coaching']].forEach(([label,mode])=>{
    const it=document.createElement('div'); it.className='item';
    it.innerHTML=`<div class="name">${label}</div><div><button class="i28" title="Abrir">‚û°Ô∏è</button></div>`;
    it.querySelector('button').onclick=()=>{ state.fm.mode=mode; openFM(); };
    fmList.appendChild(it);
  });
  $('#fmAdd').onclick=()=>openFM();

  // Tele y Equipos
  const taList=$('#taList'); taList.innerHTML='';
  const ta=document.createElement('div'); ta.className='item';
  ta.innerHTML=`<div class="name">Listado</div><div><button class="i28" title="Abrir">‚û°Ô∏è</button></div>`;
  ta.querySelector('button').onclick=()=>openTA();
  taList.appendChild(ta);

  const eqList=$('#eqList'); eqList.innerHTML='';
  const eq=document.createElement('div'); eq.className='item';
  eq.innerHTML=`<div class="name">Inventario</div><div><button class="i28" title="Abrir">‚û°Ô∏è</button></div>`;
  eq.querySelector('button').onclick=()=>openEQ();
  eqList.appendChild(eq);
}

function toggleList(btnId, listId){ const btn=$(btnId), list=$(listId); btn.onclick=()=>{ list.style.display = list.style.display==='none' ? '' : 'none'; if(list.style.display==='none') showPlaceholder(); }; }
toggleList('#ceToggle','#ceList'); toggleList('#flToggle','#flList'); toggleList('#vaToggle','#vaList'); toggleList('#fmToggle','#fmList'); toggleList('#taToggle','#taList'); toggleList('#eqToggle','#eqList');

/* ===== Panel switch ===== */
function hideAll(){
  ['panelSalesCompany','panelSalesCenters','panelCentro','panelVisitas','panelFM','panelTA','panelEQ','panelPlaceholder']
    .forEach(id=>$('#'+id).style.display='none');
}
function showPlaceholder(){ hideAll(); $('#panelPlaceholder').style.display='block'; $('#detTitle').textContent='Detalle'; $('#detTag').textContent='‚Äî'; }
function openSalesCompany(){ hideAll(); $('#panelSalesCompany').style.display='grid'; $('#detTitle').textContent='Detalle ‚Äî Cifra (Compa√±√≠a)'; $('#detTag').textContent='CIFRA'; renderSalesCompany(); drawCompanyChart(); }
function openSalesCenters(){ hideAll(); $('#panelSalesCenters').style.display='grid'; $('#detTitle').textContent='Detalle ‚Äî Cifra (Centros exclusivos)'; $('#detTag').textContent='CIFRA'; renderSalesCenters(); drawCentersChart(); }
function openCentro(kind){ hideAll(); $('#panelCentro').style.display='block'; const idx=state.selected.index; const it=(kind==='EX')?state.centros.ex[idx]:state.centros.flop[idx];
  $('#detTitle').textContent=`Detalle ‚Äî ${it?.nombre||'‚Äî'}`; $('#detTag').textContent= kind==='EX'?'CENTROS EXCLUSIVOS':'CENTROS FLOP';
  renderCentroInfo(it); renderAcciones(it); renderFormacion(it); renderProcesos(it);
}
function openVisitas(){ hideAll(); $('#panelVisitas').style.display='block'; $('#detTitle').textContent='Detalle ‚Äî Visitas'; $('#detTag').textContent='VISITAS AUDIO'; renderVisitas(); }
function openFM(){ hideAll(); $('#panelFM').style.display='block'; $('#detTitle').textContent='Detalle ‚Äî '+({'general':'Mentoring general','delegados':'Mentoring por delegados','coaching':'Coaching por delegado'}[state.fm.mode]); $('#detTag').textContent='FORMACIONES Y MENTORING'; renderFM(); }
function openTA(){ hideAll(); $('#panelTA').style.display='block'; $('#detTitle').textContent='Detalle ‚Äî Teleaudiolog√≠a'; $('#detTag').textContent='TELEAUDIOLOGIA'; renderTA(); }
function openEQ(){ hideAll(); $('#panelEQ').style.display='block'; $('#detTitle').textContent='Detalle ‚Äî Equipos'; $('#detTag').textContent='EQUIPOS'; renderEQ(); }

/* ===== Botones de ventas en la izquierda ===== */
$('#svOpenCompany').onclick=openSalesCompany;
$('#svOpenCenters').onclick=openSalesCenters;

/* ===== CIFRA ‚Äî tablas id√©nticas de c√°lculo (formato unificado) ===== */
/* Compa√±√≠a: Mes, Previsto, CV mes, Diferencia, Adjuntar */
function renderSalesCompany(){
  const q=($('#svCoSearch').value||'').toLowerCase(); const g=$('#gridSalesCompany'); g.innerHTML='';
  g.style.gridTemplateColumns='160px 140px 140px 120px 60px 44px';
  ['Mes','Previsto (‚Ç¨)','CV mes (‚Ç¨)','Diferencia','Estado','üìé'].forEach(h=>{const d=document.createElement('div');d.className='head';d.textContent=h;g.appendChild(d);});
  const rows = state.sales.company.filter(r=>!q || (r.mes||'').toLowerCase().includes(q));
  rows.forEach((r,idx)=>{
    const dM=document.createElement('div'); dM.textContent=r.mes; g.appendChild(dM);
    const p=document.createElement('input'); p.type='number'; p.className='num'; p.step='0.01'; p.value=r.previsto??''; p.oninput=()=>{r.previsto=p.value===''?null:+p.value; paint(); save(); drawCompanyChart();}; g.appendChild(p);
    const c=document.createElement('input'); c.type='number'; c.className='num'; c.step='0.01'; c.value=r.cv??''; c.oninput=()=>{r.cv=c.value===''?null:+c.value; paint(); save(); drawCompanyChart();}; g.appendChild(c);
    const d=document.createElement('div'); g.appendChild(d);
    const e=document.createElement('div'); g.appendChild(e);
    const adj=document.createElement('div'); adj.innerHTML=`<button class="btn" title="Adjuntar">üìé</button><input type="file" accept=".xlsx,.xls,.csv,.pdf,image/*" style="display:none">`; g.appendChild(adj);
    const fileBtn=adj.querySelector('button'), fileInp=adj.querySelector('input');
    fileBtn.onclick=()=>fileInp.click();
    fileInp.onchange=()=>{ const f=fileInp.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ r.adj={name:f.name,data:rd.result}; save(); alert('Adjunto listo'); }; rd.readAsDataURL(f); };

    function paint(){ const pv=+r.previsto||0, cv=+r.cv||0; d.textContent=money(cv-pv); e.textContent=cv>=pv?'OK':'Bajo'; c.classList.remove('ok','bad'); if(!isNaN(pv)&&!isNaN(cv)) c.classList.add(cv>=pv?'ok':'bad'); }
    paint();
  });
  // totales
  const totP=rows.reduce((s,x)=>s+(+x.previsto||0),0), totC=rows.reduce((s,x)=>s+(+x.cv||0),0);
  ['TOTAL', money(t
